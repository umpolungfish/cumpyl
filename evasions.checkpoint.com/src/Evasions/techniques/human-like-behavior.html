<!DOCTYPE html>
<html>

  <head>
  <meta charset="utf-8">
  <meta http-equiv="X-UA-Compatible" content="IE=edge">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-194688-3"></script>
  <script>
   window.dataLayer = window.dataLayer || [];
   function gtag(){dataLayer.push(arguments);}
   gtag('js', new Date());
   gtag('config', 'UA-194688-3');
  </script>
  <meta content="Evasion techniques" property="og:site_name">

  <meta content="Evasions: Human-like behavior" property="og:title">


  <meta name="twitter:title" content="Malware Evasion Encyclopedia" />
  <meta name="twitter:image" content="https://research.checkpoint.com/wp-content/uploads/2020/02/evasions.jpg" />


  <meta content="article" property="og:type">


  <meta content="Evasion techniques
" property="og:description">


  <meta content="https://evasions.checkpoint.com/src/Evasions/techniques/human-like-behavior.html" property="og:url">


  <meta content="2024-07-10T07:20:28+00:00" property="article:published_time">
  <meta content="https://evasions.checkpoint.com/about/" property="article:author">


  <meta property="og:image" content="">


  
  <meta content="evasions" property="article:section">
  


  
  <meta content="human-like-behavior" property="article:tag">
  

  <title>Evasions: Human-like behavior</title>
  <meta name="description" content="Contents">
<script src="https://ajax.googleapis.com/ajax/libs/jquery/2.2.2/jquery.min.js"></script>
<script src="https://maxcdn.bootstrapcdn.com/bootstrap/3.3.6/js/bootstrap.min.js" integrity="sha384-0mSbJDEHialfmuBBQP6A4Qrprq5OVfW37PRR3j5ELqxss1yVqOtnepnHVP9aJ7xS" crossorigin="anonymous"></script>
  <link rel="stylesheet" href="https://evasions.checkpoint.com/assets/css/main.css">
<script src="https://maxcdn.bootstrapcdn.com/bootstrap/3.3.6/js/bootstrap.min.js" integrity="sha384-0mSbJDEHialfmuBBQP6A4Qrprq5OVfW37PRR3j5ELqxss1yVqOtnepnHVP9aJ7xS" crossorigin="anonymous"></script>

  <link href='https://fonts.googleapis.com/css?family=PT+Sans' rel='stylesheet' type='text/css'>
  <link href='https://fonts.googleapis.com/css?family=Fira+Mono' rel='stylesheet' type='text/css'>
  <link href='https://fonts.googleapis.com/css?family=Lato:400,700' rel='stylesheet' type='text/css'>
  <link href='https://fonts.googleapis.com/css?family=Source+Code+Pro:400,200,300,500,600,700,900' rel='stylesheet' type='text/css'>
  <link href='https://fonts.googleapis.com/css?family=Gentium+Basic:400,700' rel='stylesheet' type='text/css'>
  <link href='https://fonts.googleapis.com/css?family=Alegreya:400,400italic,700' rel='stylesheet' type='text/css'>
  <link href='https://fonts.googleapis.com/css?family=Lora:400,400italic,700' rel='stylesheet' type='text/css'>
  <link href='https://fonts.googleapis.com/css?family=Fira+Sans:400,300,500,700' rel='stylesheet' type='text/css'>
  <script src="https://ajax.googleapis.com/ajax/libs/jquery/2.2.0/jquery.min.js"></script>
  <link href='https://fonts.googleapis.com/css?family=Open+Sans:400,700' rel='stylesheet' type='text/css'>
  <link href="https://maxcdn.bootstrapcdn.com/bootstrap/3.3.6/css/bootstrap.min.css" rel="stylesheet" integrity="sha384-1q8mTJOASx8j1Au+a5WDVnPi2lkFfwwEAa8hDDdjZlpLegxhjVME1fgjWPGmkzs7" crossorigin="anonymous">
  <link href="https://maxcdn.bootstrapcdn.com/font-awesome/4.6.1/css/font-awesome.min.css" rel="stylesheet" integrity="sha384-hQpvDQiCJaD2H465dQfA717v7lu5qHWtDbWNPvaTJ0ID5xnPUlVXnKzq7b8YUkbN" crossorigin="anonymous">
  <link rel="canonical" href="https://evasions.checkpoint.com/src/Evasions/techniques/human-like-behavior.html">
  <link rel="alternate" type="application/rss+xml" title="Evasion techniques" href="https://evasions.checkpoint.com/feed.xml">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/tinysort/2.3.6/tinysort.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/tinysort/2.3.6/tinysort.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/tinysort/2.3.6/tinysort.charorder.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/tinysort/2.3.6/tinysort.charorder.min.js"></script>
  <script type="text/javascript" async src="//platform.twitter.com/widgets.js"></script>




</head>


  <body>
<section>
<article class="post" itemscope itemtype="http://schema.org/BlogPosting">
  <div class="jumbotron">
    <div class="container">
      <h1 class="post-title-main" itemprop="name headline">Evasions: Human-like behavior</h1>
    </div>
</div>

  <div class="post-content container" itemprop="articleBody">
    <div style="text-align: left">
        <a href="..">Go back</a>
        <br>
        <br>
    </div>
    <h1>Contents</h1>

<p><a href="#human-like-behavior-detection-methods">Human-like behavior detection methods</a>
<br />
  <a href="#general-detection-methods-via-registry">1. General detection methods via registry</a>
<br />
  <a href="#check-number-of-recently-opened-documents">1.1. Check the number of recently opened documents</a>
<br />
  <a href="#check-if-browser-history-contains-at-least-10-urls">1.2. Check if the browser history contains at least 10 URLs</a>
<br />
  <a href="#check-if-certain-software-package-were-installed">1.3. Check if certain software packages were installed</a>
<br />
  <a href="#general-detection-methods-via-registry-countermeasures">1.4. Countermeasures</a>
<br />
  <a href="#check-user-presence-at-the-moment-of-executing">2. Check for user presence at the moment of executing a process</a>
<br />
  <a href="#check-mouse-movement">2.1. Check the mouse movement</a>
<br />
  <a href="#check-via-request-for-user-interaction">2.2. Check via a request for user interaction</a>
<br />
  <a href="#evasion-technique-for-cuckoo-human-interaction-module">2.3. Evasion technique for the Cuckoo human-interaction module</a>
<br />
  <a href="#no-suspicious-actions-until-a-document-is-scrolled-down">2.4. No suspicious actions until a document is scrolled down</a>
<br />
  <a href="#check-user-activity-via-getlastinputinfo">2.5. Check user activity via GetLastInputInfo</a>
<br />
  <a href="#countermeasures">Countermeasures</a>
<br />
  <a href="#signature-recommendations">Signature recommendations</a>
<br />
  <a href="#credits">Credits</a>
<br />
<br /></p>

<hr class="space" />

<h2><a class="a-dummy" name="human-like-behavior-detection-methods">Human-like behavior detection methods</a></h2>
<p>All the techniques described in this group make use of the fact that certain actions are performed differently by a user and by a virtual environment.</p>

<p><br /></p>
<h3><a class="a-dummy" name="general-detection-methods-via-registry">1. General detection methods via registry</a></h3>
<p>The registry is a storage for different pieces of information. For example, recently opened URLs and documents, and software installation notes are stored here. All of these may be used to determine if the machine is operated by a human user and is not a sandbox.</p>

<p><br /></p>
<h4><a class="a-dummy" name="check-number-of-recently-opened-documents">1.1. Check the number of recently opened documents</a></h4>
<p>It’s hard to imagine a typical host system where the user does not open any documents. Therefore, the lack of recently opened documents indicates this is likely a virtual environment.</p>

<hr class="space" />

<p><b>Code sample (VB)</b></p>
<p></p>

<figure class="highlight"><pre><code class="language-vb" data-lang="vb"><span class="k">Public</span> <span class="k">Function</span> <span class="nf">DKTxHE</span><span class="p">()</span> <span class="ow">As</span> <span class="kt">Boolean</span>
<span class="n">DKTxHE</span> <span class="o">=</span> <span class="n">RecentFiles</span><span class="p">.</span><span class="n">Count</span> <span class="o">&lt;</span> <span class="mi">3</span>
<span class="k">End</span> <span class="k">Function</span></code></pre></figure>

<p><i>This code sample was taken from <a href="https://www.sentinelone.com/blog/anti-vm-tricks/">SentinelOne article</a> </i></p>

<p><br /></p>
<h4><a class="a-dummy" name="check-if-browser-history-contains-at-least-10-urls">1.2. Check if the browser history contains at least 10 URLs</a></h4>
<p>It’s hard to imagine a typical host system where the user does not browse the Internet. Therefore, if there are fewer than 10 URLs in the browser history, this is likely a sandbox or VM.</p>

<hr class="space" />

<p><b>Code sample (for Chrome)</b></p>
<p></p>

<!-- Firefox history: http://www.rohitab.com/discuss/topic/40903-clear-browser-history-with-c/ -->
<!-- Firefox passwords: https://github.com/wekillpeople/browser-dumpwd/blob/master/firefox.c -->

<figure class="highlight"><pre><code class="language-c" data-lang="c"><span class="n">bool</span> <span class="nf">chrome_history_evasion</span><span class="p">(</span><span class="kt">int</span> <span class="n">min_websites_visited</span> <span class="o">=</span> <span class="mi">10</span><span class="p">)</span>
<span class="p">{</span>
  <span class="n">sqlite3</span> <span class="o">*</span><span class="n">db</span><span class="p">;</span>
  <span class="kt">int</span> <span class="n">rc</span><span class="p">;</span>
  <span class="n">bool</span> <span class="n">vm_found</span> <span class="o">=</span> <span class="nb">false</span><span class="p">;</span>

  <span class="n">rc</span> <span class="o">=</span> <span class="n">sqlite3_open</span><span class="p">(</span><span class="s">"C:</span><span class="se">\\</span><span class="s">Users</span><span class="se">\\</span><span class="s">&lt;USER_NAME&gt;</span><span class="se">\\</span><span class="s">AppData</span><span class="se">\\</span><span class="s">Local</span><span class="se">\\</span><span class="s">Google</span><span class="se">\\</span><span class="s">Chrome</span><span class="se">\\</span><span class="s">User Data</span><span class="se">\\</span><span class="s">Default</span><span class="se">\\</span><span class="s">History"</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">db</span><span class="p">);</span>
  <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">rc</span><span class="p">)</span>
  <span class="p">{</span>
    <span class="kt">char</span> <span class="o">**</span><span class="n">results</span> <span class="o">=</span> <span class="n">nullptr</span><span class="p">;</span>
    <span class="kt">char</span> <span class="o">*</span><span class="n">error</span> <span class="o">=</span> <span class="n">nullptr</span><span class="p">;</span>
    <span class="kt">int</span> <span class="n">rows</span><span class="p">,</span> <span class="n">columns</span><span class="p">;</span>

    <span class="n">rc</span> <span class="o">=</span> <span class="n">sqlite3_get_table</span><span class="p">(</span><span class="n">db</span><span class="p">,</span> <span class="s">"SELECT DISTINCT title FROM urls;"</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">results</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">rows</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">columns</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">error</span><span class="p">);</span>
    <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">rc</span><span class="p">)</span>
      <span class="n">vm_found</span> <span class="o">=</span> <span class="n">rows</span> <span class="o">&lt;</span> <span class="n">min_websites_visited</span><span class="p">;</span>
    <span class="n">sqlite3_free_table</span><span class="p">(</span><span class="n">results</span><span class="p">);</span>
  <span class="p">}</span>

  <span class="n">sqlite3_close</span><span class="p">(</span><span class="n">db</span><span class="p">);</span>
  <span class="k">return</span> <span class="n">vm_found</span><span class="p">;</span>
<span class="p">}</span></code></pre></figure>

<p><br /></p>
<h4><a class="a-dummy" name="check-if-certain-software-package-were-installed">1.3. Check if certain software packages were installed</a></h4>
<p>If the system is only used for simulation purposes then it is likely to have many fewer installed software packages than a usual user’s work machine. The installed packages may be specific to emulation purposes, not the ones that are usually used by human operators. Therefore, the list of installed packages may be compared to the list of commonly used applications to determine if it’s a sandbox.</p>

<hr class="space" />

<p><b>Code sample (PowerShell)</b></p>
<p></p>

<figure class="highlight"><pre><code class="language-batch" data-lang="batch"><span class="kd">Get</span><span class="na">-ItemProperty </span><span class="kd">HKLM</span>:\Software\Microsoft\Windows\CurrentVersion\Uninstall\<span class="o">*</span> <span class="o">|</span> <span class="kd">Format</span><span class="na">-Table -AutoSize </span><span class="o">|</span> <span class="kd">Measure</span><span class="na">-Object -Line</span></code></pre></figure>

<p><br /></p>
<h4><a class="a-dummy" name="general-detection-methods-via-registry-countermeasures">1.4. Countermeasures</a></h4>
<p>Countermeasures are simple:</p>
<ul>
<li>open few documents to update the recent history</li>
<li>open few internet URLs to create a browsing history</li>
<li>install some lightweight software (like Notepad++)</li>
</ul>

<p><br /></p>
<h3><a class="a-dummy" name="check-user-presence-at-the-moment-of-executing">2. Check for user presence at the moment of executing a process</a></h3>
<p>The following sub-group leverages the differences between a user’s interaction with the machine and the actions of a virtual environment.</p>

<p><br /></p>
<h4><a class="a-dummy" name="check-mouse-movement">2.1. Check the mouse movement</a></h4>
<p>This method relies on the fact that a user frequently moves the mouse during actual work.</p>

<hr class="space" />

<p>Some sandboxes and antivirus virtual machines have a static cursor position because they do not emulate any user activity while automatically running the files.</p>

<hr class="space" />

<p><b>Code sample</b></p>
<p></p>

<figure class="highlight"><pre><code class="language-c" data-lang="c"><span class="kt">int</span> <span class="nf">gensandbox_mouse_act</span><span class="p">()</span> <span class="p">{</span>
    <span class="n">POINT</span> <span class="n">position1</span><span class="p">,</span> <span class="n">position2</span><span class="p">;</span>

    <span class="n">GetCursorPos</span><span class="p">(</span><span class="o">&amp;</span><span class="n">position1</span><span class="p">);</span>
    <span class="n">Sleep</span><span class="p">(</span><span class="mi">2000</span><span class="p">);</span>
    <span class="n">GetCursorPos</span><span class="p">(</span><span class="o">&amp;</span><span class="n">position2</span><span class="p">);</span>

    <span class="k">if</span> <span class="p">((</span><span class="n">position1</span><span class="p">.</span><span class="n">x</span> <span class="o">==</span> <span class="n">position2</span><span class="p">.</span><span class="n">x</span><span class="p">)</span> <span class="o">&amp;&amp;</span> <span class="p">(</span><span class="n">position1</span><span class="p">.</span><span class="n">y</span> <span class="o">==</span> <span class="n">position2</span><span class="p">.</span><span class="n">y</span><span class="p">))</span>
        <span class="c1">// No mouse activity during the sleep.</span>
        <span class="k">return</span> <span class="n">TRUE</span><span class="p">;</span>
    <span class="k">else</span>
        <span class="k">return</span> <span class="n">FALSE</span><span class="p">;</span>
<span class="p">}</span></code></pre></figure>

<p><i>This code sample was taken from <a href="https://github.com/a0rtega/pafish">pafish project</a> </i></p>

<p>Such a short delay of only 2 seconds implies that the user should be active at the moment of infection.</p>

<hr class="space" />

<p>More sophisticated checks rely on detection of not only the mouse movement per se but the pattern of such movement. The following example is taken from the research of <a href="https://outpost24.com/blog/lummac2-anti-sandbox-technique-trigonometry-human-detection/">LummaC2 Stealer</a> conducted by Outpost24.</p>

<p>First, malware captures mouse movements with the delay of 50 msec between them.</p>

<div style="text-align: center; margin: auto">
  <img src="../assets/images/trigonometry_mouse_check_1.webp" /><br />
</div>

<hr class="space" />

<p>Second, the vectors are drawn out of paired captured positions.</p>

<div style="text-align: center; margin: auto">
  <img src="../assets/images/trigonometry_mouse_check_2.webp" /><br />
</div>

<hr class="space" />

<p>Next, the angles are calculated between the corresponding vectors.</p>

<div style="text-align: center; margin: auto">
  <img src="../assets/images/trigonometry_mouse_check_3.webp" /><br />
</div>

<hr class="space" />

<p>Finally, the angles are compared with the 45.0º threshold value, and if any of the angles is bigger than this hardcoded value, malware treats the result as being suspicious and does not execute the malicious code.</p>

<hr class="space" />

<p><b>Countermeasures</b></p>
<p></p>

<p>Implement the module for mouse movement during a sample emulation. Make sure to come up with a more delicate way of interacting with the mouse cursor rather than just random movements all around the screen, so that it resembles the behavior of a human being.</p>

<p><br /></p>
<h4><a class="a-dummy" name="check-via-request-for-user-interaction">2.2. Check via a request for user interaction</a></h4>
<p>Some malware samples contain a GUI installer which requires user interaction. For example, the user must click the “Install” or “Next” buttons. Therefore, the malware may take no action unless the button is clicked. Standard sandboxes like Cuckoo have a module which simulates user activity. It searches for and clicks buttons with the captions mentioned above.</p>

<hr class="space" />

<p>To prevent auto-clicking, a malware sample may create buttons with a class name that differs from “Button” or with a different caption (not “Install” or “Next”). This way the sandbox can’t detect and click the button.</p>

<hr class="space" />

<p><b>Code sample</b></p>
<p></p>

<figure class="highlight"><pre><code class="language-c" data-lang="c">   <span class="c1">// we use extended style flags to make a static look like a button</span>
   <span class="n">HWND</span> <span class="n">hButton</span> <span class="o">=</span> <span class="n">CreateWindowExW</span><span class="p">(</span>
       <span class="n">WS_EX_DLGMODALFRAME</span> <span class="o">|</span> <span class="n">WS_EX_WINDOWEDGE</span><span class="p">,</span>  <span class="c1">// extended style flags</span>
       <span class="n">TEXT</span><span class="p">(</span><span class="s">"static"</span><span class="p">),</span>         <span class="c1">// class "static" instead of "button"</span>
       <span class="n">TEXT</span><span class="p">(</span><span class="s">"Real next"</span><span class="p">),</span>      <span class="c1">// caption different from “Install” or “Next”</span>
       <span class="n">WS_VISIBLE</span> <span class="o">|</span> <span class="n">WS_CHILD</span> <span class="o">|</span> <span class="n">WS_GROUP</span> <span class="o">|</span> <span class="n">SS_CENTER</span><span class="p">,</span>  <span class="c1">// usual style flags</span>
       <span class="mi">10</span><span class="p">,</span> <span class="mi">10</span><span class="p">,</span> <span class="mi">80</span><span class="p">,</span> <span class="mi">25</span><span class="p">,</span>         <span class="c1">// arbitrary position and size, may be any</span>
       <span class="n">hWnd</span><span class="p">,</span>                   <span class="c1">// parent window</span>
       <span class="nb">NULL</span><span class="p">,</span>                   <span class="c1">// no menu</span>
       <span class="nb">NULL</span><span class="p">,</span>                   <span class="c1">// a handle to the instance of the module to be associated with the window</span>
       <span class="nb">NULL</span><span class="p">);</span>                  <span class="c1">// pointer to custom value is not required</span></code></pre></figure>

<hr class="space" />

<p><b>Countermeasures</b></p>
<p></p>

<p>Check for controls other than the buttons and examine their properties. For example, if the “Install” text is linked with the “static” control (not with “button”), this may indicate that the evasion technique is applied. Therefore, such a static control may be clicked.</p>

<p><br /></p>
<h4><a class="a-dummy" name="evasion-technique-for-cuckoo-human-interaction-module">2.3. Evasion technique for the Cuckoo human-interaction module</a></h4>
<p>Suppose that the malware installer window has a button with the “Install” caption or something similar. It can be found by the human-interaction module of a sandbox but it’s invisible to an actual user (one-pixel size, hidden, etc.).</p>

<hr class="space" />

<p>The real installation button has an empty or fake caption and the window class “Static”, so it can’t be detected by the auto-clicking module. In addition, the malware may take some mock action if the invisible button is clicked.</p>

<hr class="space" />

<p><b>Code sample</b></p>
<p></p>

<figure class="highlight"><pre><code class="language-c" data-lang="c">    <span class="n">HWND</span> <span class="n">hWnd</span> <span class="o">=</span> <span class="n">CreateWindow</span><span class="p">(</span>
        <span class="n">TEXT</span><span class="p">(</span><span class="s">"Button"</span><span class="p">),</span>         <span class="c1">// class "button"</span>
        <span class="n">TEXT</span><span class="p">(</span><span class="s">"Next"</span><span class="p">),</span>           <span class="c1">// caption is “Install” or “Next”</span>
        <span class="nb">NULL</span><span class="p">,</span>                   <span class="c1">// style flags are not required, the control is invisible</span>
        <span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span>             <span class="c1">// the control is created of 1x1 pixel size</span>
        <span class="n">hParentWnd</span><span class="p">,</span>             <span class="c1">// parent window</span>
        <span class="nb">NULL</span><span class="p">,</span>                   <span class="c1">// no menu</span>
        <span class="nb">NULL</span><span class="p">,</span>                   <span class="c1">// a handle to the instance of the module to be associated with the window</span>
        <span class="nb">NULL</span><span class="p">);</span>                  <span class="c1">// pointer to custom value is not required</span></code></pre></figure>

<hr class="space" />

<p><b>Countermeasures</b></p>
<p></p>

<p>Check for controls other than buttons and examine their properties. If there is a button of 1x1 pixel size or the button is invisible, this may be an indication of evasion technique applied. Therefore, such a control should not be clicked.</p>

<p><br /></p>
<h4><a class="a-dummy" name="no-suspicious-actions-until-a-document-is-scrolled-down">2.4. No suspicious actions until a document is scrolled down</a></h4>
<p>Malware payloads which reside in Office documents (namely, *.docm *.docx) don’t do anything until the document is scrolled to a certain page (second, third, etc.). A human user usually scrolls through the document while a virtual environment will likely not perform this step.</p>

<hr class="space" />

<p><b>Example from <a href="https://www.fireeye.com/content/dam/fireeye-www/current-threats/pdfs/pf/file/fireeye-hot-knives-through-butter.pdf">FireEye report</a> (p. 6-7):</b></p>
<p></p>

<p>RTF documents consist of normal text, control words, and groups. Microsoft’s RTF specification includes a shape-drawing function, which in turn includes a series of properties using the following syntax:<br />
<tt style="color:green">{\sp{\sn propertyName}{\sv propertyValueInformation}}</tt></p>

<p>In this code, <tt>\sp</tt> is the control word for the drawing property, <tt>\sn</tt> is the property name, and <tt>\sv</tt> contains information about the property value. The code snippet in the image below exploits a <a href="https://cve.mitre.org/cgi-bin/cvename.cgi?name=CVE-2010-3333">CVE-2010-3333 vulnerability</a> that occurs when using an invalid <tt>\sv</tt> value for the pFragments shape property:</p>

<div style="text-align: center; margin: auto">
  <img src="../assets/images/rtf_exploit.png" /><br />
</div>

<p><br />
A closer look at the exploit code, as shown in the next image, reveals a series of paragraph marks (<tt>./par</tt>) that appears before the exploit code:</p>

<div style="text-align: center; margin: auto">
  <img src="../assets/images/rtf_stub.png" /><br />
</div>

<p><br />
The repeated paragraph marks push the exploit code to the second page of the RTF document. Therefore, the malicious code does not execute unless the document scrolls down to bring the exploit code up into the active window — more likely to be a deliberate act by a human user than simulated movement in a virtual machine.<br /></p>

<p>When the RTF is scrolled down to the second page, only then is the exploit code triggered and the payload is downloaded.<br /></p>

<p>In a sandbox, where any mouse activity is random or preprogrammed, the RTF document’s second page never appears. Therefore, the malicious code never executes, and nothing seems amiss in the sandbox analysis.</p>

<hr class="space" />

<p><b>Countermeasures</b></p>
<p></p>
<p>Find a window with the document and send the WM_VSCROLL message there. Alternatively, send the WM_MOUSEWHEEL message as <a href="https://stackoverflow.com/questions/60203135/set-delta-in-a-wm-mousewheel-message-to-send-with-postmessage">described here</a>.</p>

<p><br /></p>
<h4><a class="a-dummy" name="check-user-activity-via-getlastinputinfo">2.5. Check user activity via GetLastInputInfo</a></h4>

<p>User activity can be checked with the call to the <code class="language-plaintext highlighter-rouge">GetLastInputInfo</code> function</p>

<p>Although Agent Tesla v3 performs this check, it does so incorrectly. Compare the code of Agent Tesla v3 with the correct technique implementation below.</p>

<div style="text-align: center; margin: auto">
  <img src="../assets/images/agent_tesla_v3_technique.png" /><br />
</div>
<div style="text-align: center; margin: auto">
  <i>Evasion technique as implemented in Agent Tesla v3. This function is called after a delay of 30 seconds.</i>
</div>

<hr class="space" />

<p>As measured time values are in milliseconds, the difference between them cannot be larger than 30000 (30 seconds). This means that with division by 1000.0, the resulting value cannot be larger than 30. In turn, this indicates that a comparison with 600 always leads to a result in which the sandbox is undetected.</p>

<p>The correct implementation is provided below.</p>

<hr class="space" />

<p><b>Code sample</b></p>
<p></p>

<figure class="highlight"><pre><code class="language-c" data-lang="c">    <span class="n">bool</span> <span class="n">sandbox_detected</span> <span class="o">=</span> <span class="nb">false</span><span class="p">;</span>
    
    <span class="n">Sleep</span><span class="p">(</span><span class="mi">30000</span><span class="p">);</span>

    <span class="n">DWORD</span> <span class="n">ticks</span> <span class="o">=</span> <span class="n">GetTickCount</span><span class="p">();</span>

    <span class="n">LASTINPUTINFO</span> <span class="n">li</span><span class="p">;</span>
    <span class="n">li</span><span class="p">.</span><span class="n">cbSize</span> <span class="o">=</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">LASTINPUTINFO</span><span class="p">);</span>
    <span class="n">BOOL</span> <span class="n">res</span> <span class="o">=</span> <span class="n">GetLastInputInfo</span><span class="p">(</span><span class="o">&amp;</span><span class="n">li</span><span class="p">);</span>

    <span class="k">if</span> <span class="p">(</span><span class="n">ticks</span> <span class="o">-</span> <span class="n">li</span><span class="p">.</span><span class="n">dwTime</span> <span class="o">&gt;</span> <span class="mi">6000</span><span class="p">)</span>
    <span class="p">{</span>
        <span class="n">sandbox_detected</span> <span class="o">=</span> <span class="nb">true</span><span class="p">;</span>
    <span class="p">}</span></code></pre></figure>

<hr class="space" />

<p><b>Countermeasures</b></p>
<p></p>

<p>Implement the module for mouse movement during a sample emulation.</p>

<p><br /></p>
<h3><a class="a-dummy" name="countermeasures"> Countermeasures</a></h3>
<p>Countermeasures for chapter 1 are given in the corresponding <a href="#general-detection-methods-via-registry-countermeasures">section</a>.
Countermeasures for chapter 2 are given in place in the appropriate sections.</p>

<p><br /></p>
<h3><a class="a-dummy" name="signature-recommendations">Signature recommendations</a></h3>
<p><i>Signature recommendations are not provided for this class of techniques as the methods described in this chapter do not imply their usage for evasion purposes. It is hard to differentiate between the code meant for evasion and code designed for non-evasion purposes.</i></p>

<p><br /></p>
<h3><a class="a-dummy" name="credits">Credits</a></h3>

<p>Open-source project from where code samples were taken:</p>
<ul>
<li>pafish project on <a href="https://github.com/a0rtega/pafish">Github</a></li>
</ul>

<p>Companies from where certain examples were taken:</p>
<ul>
<li><a href="https://www.fireeye.com">FireEye</a></li>
<li><a href="https://www.sentinelone.com/">SentinelOne</a></li>
</ul>

    <br>
    <div style="text-align: left">
        <a href="..">Go back</a>
    </div>
    <br>
    <div class="sharebuttons" style="text-align: center">
        <hr />
        <ul>
          <li>
            <p class="sharetitle"> Share this: </p>
          </li>
          <li class="reddit">
            <a href="http://www.reddit.com/submit?url=https://evasions.checkpoint.com/src/Evasions/techniques/human-like-behavior.html&title=Evasions:%20Human-like%20behavior - Evasion Techniques" target="_blank">
                <svg xmlns="http://www.w3.org/2000/svg"
                aria-label="Reddit" role="img"
                viewBox="0 0 512 512"><rect
                width="512" height="512"
                rx="15%"
                fill="#f40"/><g fill="#fff"><ellipse cx="256" cy="307" rx="166" ry="117"/><circle cx="106" cy="256" r="42"/><circle cx="407" cy="256" r="42"/><circle cx="375" cy="114" r="32"/></g><g stroke-linecap="round" stroke-linejoin="round" fill="none"><path d="m256 196 23-101 73 15" stroke="#fff" stroke-width="16"/><path d="m191 359c33 25 97 26 130 0" stroke="#f40" stroke-width="13"/></g><g fill="#f40"><circle cx="191" cy="287" r="31"/><circle cx="321" cy="287" r="31"/></g></svg>
                
            </a>
          </li>
          <li class="hn">
            <a href="http://news.ycombinator.com/submitlink?u=https://evasions.checkpoint.com/src/Evasions/techniques/human-like-behavior.html&t=Evasions:%20Human-like%20behavior - Evasion Techniques" target="_blank">
                <svg xmlns="http://www.w3.org/2000/svg"
                aria-label="Hacker News" role="img"
                viewBox="0 0 512 512"><rect
                width="512" height="512"
                rx="15%"
                fill="#f60"/><path fill="#fff" d="M124 91h51l81 162 81-164h51L276 293v136h-40V293z"/></svg>
            </a>
          </li>
          <li class="twitter">
            <a href="https://twitter.com/intent/tweet?via=_CPResearch_&url=https://evasions.checkpoint.com/src/Evasions/techniques/human-like-behavior.html&text=Evasions:%20Human-like%20behavior - Evasion Techniques" target="_blank">
                <svg viewBox="0 0 1792 1792" xmlns="http://www.w3.org/2000/svg"><path d="M1684 408q-67 98-162 167 1 14 1 42 0 130-38 259.5t-115.5 248.5-184.5 210.5-258 146-323 54.5q-271 0-496-145 35 4 78 4 225 0 401-138-105-2-188-64.5t-114-159.5q33 5 61 5 43 0 85-11-112-23-185.5-111.5t-73.5-205.5v-4q68 38 146 41-66-44-105-115t-39-154q0-88 44-163 121 149 294.5 238.5t371.5 99.5q-8-38-8-74 0-134 94.5-228.5t228.5-94.5q140 0 236 102 109-21 205-78-37 115-142 178 93-10 186-50z"/></svg>
            </a>
          </li>
          <li class="linkedin">
            <a href=https://www.linkedin.com/shareArticle?mini=true&url=https://evasions.checkpoint.com/src/Evasions/techniques/human-like-behavior.html&title=Evasions:%20Human-like%20behavior - Evasion Techniques&source=LinkedIn" target="_blank">
                <svg viewBox="0 0 1792 1792" xmlns="http://www.w3.org/2000/svg"><path d="M477 625v991h-330v-991h330zm21-306q1 73-50.5 122t-135.5 49h-2q-82 0-132-49t-50-122q0-74 51.5-122.5t134.5-48.5 133 48.5 51 122.5zm1166 729v568h-329v-530q0-105-40.5-164.5t-126.5-59.5q-63 0-105.5 34.5t-63.5 85.5q-11 30-11 81v553h-329q2-399 2-647t-1-296l-1-48h329v144h-2q20-32 41-56t56.5-52 87-43.5 114.5-15.5q171 0 275 113.5t104 332.5z"/></svg>
            </a>
          </li>
        </ul>
      </div>
      
</article>


</section>

<nav class="navbar navbar-default navbar-fixed-bottom">
  <div class="container footer-content">

    Made with <font class="a-pink"><i class ="fa fa-heart"></i></font> to serve the community by Check Point Research    |    <a class="a-pink" href="https://research.checkpoint.com">Research blog</a>    |    <a class="a-pink" href="https://research.checkpoint.com/about-us/">About Us</a>    |    <a class="a-pink" href="https://github.com/CheckPointSW"><i class="fa fa-github fa-lg"></i></a> <a class="a-pink" href="https://twitter.com/_CPResearch_"><i class="fa fa-twitter fa-lg"></i></a>
    
    <br>
    
    © 1994-2024 Check Point Software Technologies LTD | All rights reserved | Property of CheckPoint.com


  </div>
</nav>

  </body>

</html>
