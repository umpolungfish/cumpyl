<!DOCTYPE html>
<html>

  <head>
  <meta charset="utf-8">
  <meta http-equiv="X-UA-Compatible" content="IE=edge">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-194688-3"></script>
  <script>
   window.dataLayer = window.dataLayer || [];
   function gtag(){dataLayer.push(arguments);}
   gtag('js', new Date());
   gtag('config', 'UA-194688-3');
  </script>
  <meta content="Evasion techniques" property="og:site_name">

  <meta content="Evasions: WMI" property="og:title">


  <meta name="twitter:title" content="Malware Evasion Encyclopedia" />
  <meta name="twitter:image" content="https://research.checkpoint.com/wp-content/uploads/2020/02/evasions.jpg" />


  <meta content="article" property="og:type">


  <meta content="Evasion techniques
" property="og:description">


  <meta content="https://evasions.checkpoint.com/src/Evasions/techniques/wmi.html" property="og:url">


  <meta content="2024-07-10T07:20:28+00:00" property="article:published_time">
  <meta content="https://evasions.checkpoint.com/about/" property="article:author">


  <meta property="og:image" content="">


  
  <meta content="evasions" property="article:section">
  


  
  <meta content="wmi" property="article:tag">
  

  <title>Evasions: WMI</title>
  <meta name="description" content="Contents">
<script src="https://ajax.googleapis.com/ajax/libs/jquery/2.2.2/jquery.min.js"></script>
<script src="https://maxcdn.bootstrapcdn.com/bootstrap/3.3.6/js/bootstrap.min.js" integrity="sha384-0mSbJDEHialfmuBBQP6A4Qrprq5OVfW37PRR3j5ELqxss1yVqOtnepnHVP9aJ7xS" crossorigin="anonymous"></script>
  <link rel="stylesheet" href="https://evasions.checkpoint.com/assets/css/main.css">
<script src="https://maxcdn.bootstrapcdn.com/bootstrap/3.3.6/js/bootstrap.min.js" integrity="sha384-0mSbJDEHialfmuBBQP6A4Qrprq5OVfW37PRR3j5ELqxss1yVqOtnepnHVP9aJ7xS" crossorigin="anonymous"></script>

  <link href='https://fonts.googleapis.com/css?family=PT+Sans' rel='stylesheet' type='text/css'>
  <link href='https://fonts.googleapis.com/css?family=Fira+Mono' rel='stylesheet' type='text/css'>
  <link href='https://fonts.googleapis.com/css?family=Lato:400,700' rel='stylesheet' type='text/css'>
  <link href='https://fonts.googleapis.com/css?family=Source+Code+Pro:400,200,300,500,600,700,900' rel='stylesheet' type='text/css'>
  <link href='https://fonts.googleapis.com/css?family=Gentium+Basic:400,700' rel='stylesheet' type='text/css'>
  <link href='https://fonts.googleapis.com/css?family=Alegreya:400,400italic,700' rel='stylesheet' type='text/css'>
  <link href='https://fonts.googleapis.com/css?family=Lora:400,400italic,700' rel='stylesheet' type='text/css'>
  <link href='https://fonts.googleapis.com/css?family=Fira+Sans:400,300,500,700' rel='stylesheet' type='text/css'>
  <script src="https://ajax.googleapis.com/ajax/libs/jquery/2.2.0/jquery.min.js"></script>
  <link href='https://fonts.googleapis.com/css?family=Open+Sans:400,700' rel='stylesheet' type='text/css'>
  <link href="https://maxcdn.bootstrapcdn.com/bootstrap/3.3.6/css/bootstrap.min.css" rel="stylesheet" integrity="sha384-1q8mTJOASx8j1Au+a5WDVnPi2lkFfwwEAa8hDDdjZlpLegxhjVME1fgjWPGmkzs7" crossorigin="anonymous">
  <link href="https://maxcdn.bootstrapcdn.com/font-awesome/4.6.1/css/font-awesome.min.css" rel="stylesheet" integrity="sha384-hQpvDQiCJaD2H465dQfA717v7lu5qHWtDbWNPvaTJ0ID5xnPUlVXnKzq7b8YUkbN" crossorigin="anonymous">
  <link rel="canonical" href="https://evasions.checkpoint.com/src/Evasions/techniques/wmi.html">
  <link rel="alternate" type="application/rss+xml" title="Evasion techniques" href="https://evasions.checkpoint.com/feed.xml">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/tinysort/2.3.6/tinysort.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/tinysort/2.3.6/tinysort.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/tinysort/2.3.6/tinysort.charorder.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/tinysort/2.3.6/tinysort.charorder.min.js"></script>
  <script type="text/javascript" async src="//platform.twitter.com/widgets.js"></script>




</head>


  <body>
<section>
<article class="post" itemscope itemtype="http://schema.org/BlogPosting">
  <div class="jumbotron">
    <div class="container">
      <h1 class="post-title-main" itemprop="name headline">Evasions: WMI</h1>
    </div>
</div>

  <div class="post-content container" itemprop="articleBody">
    <div style="text-align: left">
        <a href="..">Go back</a>
        <br>
        <br>
    </div>
    <h1>Contents</h1>

<p><a href="#wmi-detection-methods">WMI detection methods</a>
<br />
<a href="#background">Background</a>
<br />
  <a href="#generic-wmi-queries">1. Generic WMI queries</a>
<br />
  <a href="#escape-from-tracking">2. Escape from tracking using WMI</a>
<br />
  <a href="#wmi-process">2.1. Start process using WMI</a>
<br />
  <a href="#wmi-tsched">2.2. Start process using Task Scheduler via WMI</a>
<br />
  <a href="#check-last-boot-time">3. Check the last boot time</a>
<br />
  <a href="#check-network-adapter-reset-time">4. Check the network adapter last reset time</a>
<br />
  <a href="#signature-recommendations">Signature recommendations</a>
<br />
  <a href="#countermeasures">Countermeasures</a>
<br />
  <a href="#credits">Credits</a>
<br />
<br /></p>

<hr class="space" />

<h2><a class="a-dummy" name="wmi-detection-methods">WMI detection methods</a></h2>
<p>Windows Management Interface (WMI) queries are another way to get OS and hardware information. WMI uses COM interfaces and their methods.</p>

<hr class="space" />

<h2><a class="a-dummy" name="background">Background</a></h2>

<p>Standard COM functions are used to process queries. They are called in the sequence described below and can be split into 6 steps.</p>

<p>1. COM initialization:</p>
<ul>
<li><tt>CoInitialize/CoInitializeEx</tt></li> 
</ul>

<hr class="space" />

<p>2. Create the required interface instance:</p>
<ul>
<li><tt>CoCreateInstance/CoCreateInstanceEx</tt></li> 
</ul>

<hr class="space" />

<p>3. Connect to the particular services via the interface instance with the following function:</p>
<ul>
<li><tt>ConnectServer</tt></li> 
</ul>

<hr class="space" />

<p>4. Get methods of the services and set their arguments with these functions:</p>
<ul>
<li><tt>Method</tt> (to get methods)</li> 
<li><tt>Put</tt> (to set arguments)</li> 
</ul>

<hr class="space" />

<p>5. Retrieve information from the services and execute the methods of the services with the functions below. The functions on the left are proxies for the functions on the right - which are called internally:</p>
<ul>
<li><tt>ExecQuery -&gt; IWbemServices_ExecQuery</tt> (retrieve information)</li>
<li><tt>ExecMethod -&gt; IWbemServices_ExecMethod</tt> (execute method)</li>
<li><tt>ExecMethodAsync -&gt; IWbemServices_ExecMethodAsync</tt> (execute method)</li>
</ul>

<hr class="space" />

<p>6. Examine the result of the query with the following functions:</p>
<ul>
<li><tt>[enumerator]-&gt;Next</tt></li> 
<li><tt>[object]-&gt;Get</tt></li> 
</ul>

<hr class="space" />

<p>To see how the described theory is applied to practice, please check the examples below.</p>

<p><br /></p>
<h3><a class="a-dummy" name="generic-wmi-queries">1. Generic WMI queries</a></h3>
<p>As WMI provides another way to collect system information, it can be used to perform evasion techniques described in other articles, for example:</p>
<ul>
<li><a href="generic-os-queries.html#check-if-number-of-processors">Check if the number of processors is low</a></li>
<li><a href="generic-os-queries.html#check-if-hard-disk">Check if the hard disk size is small</a></li>
<li><a href="network.html#check-if-mac-address-is-specific">Check if the MAC address is specific</a></li>
<li><a href="hardware.html#check-if-cpu-temperature-information-is-available">Check if the CPU temperature information is available</a></li>
</ul>

<p><b>Code sample</b></p>
<p></p>

<figure class="highlight"><pre><code class="language-c" data-lang="c"><span class="cm">/*
Check number of cores using WMI
*/</span>
<span class="n">BOOL</span> <span class="nf">number_cores_wmi</span><span class="p">()</span>
<span class="p">{</span>
  <span class="n">IWbemServices</span> <span class="o">*</span><span class="n">pSvc</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
  <span class="n">IWbemLocator</span> <span class="o">*</span><span class="n">pLoc</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
  <span class="n">IEnumWbemClassObject</span> <span class="o">*</span><span class="n">pEnumerator</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
  <span class="n">BOOL</span> <span class="n">bStatus</span> <span class="o">=</span> <span class="n">FALSE</span><span class="p">;</span>
  <span class="n">HRESULT</span> <span class="n">hRes</span><span class="p">;</span>
  <span class="n">BOOL</span> <span class="n">bFound</span> <span class="o">=</span> <span class="n">FALSE</span><span class="p">;</span>

  <span class="c1">// Init WMI</span>
  <span class="n">bStatus</span> <span class="o">=</span> <span class="n">InitWMI</span><span class="p">(</span><span class="o">&amp;</span><span class="n">pSvc</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">pLoc</span><span class="p">);</span>
  <span class="k">if</span> <span class="p">(</span><span class="n">bStatus</span><span class="p">)</span>
  <span class="p">{</span>
    <span class="c1">// If success, execute the desired query</span>
    <span class="n">bStatus</span> <span class="o">=</span> <span class="n">ExecWMIQuery</span><span class="p">(</span><span class="o">&amp;</span><span class="n">pSvc</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">pLoc</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">pEnumerator</span><span class="p">,</span> <span class="n">_T</span><span class="p">(</span><span class="s">"SELECT * FROM Win32_Processor"</span><span class="p">));</span>
    <span class="k">if</span> <span class="p">(</span><span class="n">bStatus</span><span class="p">)</span>
    <span class="p">{</span>
      <span class="c1">// Get the data from the query</span>
      <span class="n">IWbemClassObject</span> <span class="o">*</span><span class="n">pclsObj</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
      <span class="n">ULONG</span> <span class="n">uReturn</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
      <span class="n">VARIANT</span> <span class="n">vtProp</span><span class="p">;</span>

      <span class="c1">// Iterate over our enumator</span>
      <span class="k">while</span> <span class="p">(</span><span class="n">pEnumerator</span><span class="p">)</span>
      <span class="p">{</span>
        <span class="n">hRes</span> <span class="o">=</span> <span class="n">pEnumerator</span><span class="o">-&gt;</span><span class="n">Next</span><span class="p">(</span><span class="n">WBEM_INFINITE</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">pclsObj</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">uReturn</span><span class="p">);</span>
        <span class="k">if</span> <span class="p">(</span><span class="mi">0</span> <span class="o">==</span> <span class="n">uReturn</span><span class="p">)</span>
          <span class="k">break</span><span class="p">;</span>

        <span class="c1">// Get the value of the Name property</span>
        <span class="n">hRes</span> <span class="o">=</span> <span class="n">pclsObj</span><span class="o">-&gt;</span><span class="n">Get</span><span class="p">(</span><span class="n">_T</span><span class="p">(</span><span class="s">"NumberOfCores"</span><span class="p">),</span> <span class="mi">0</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">vtProp</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
        <span class="k">if</span> <span class="p">(</span><span class="n">V_VT</span><span class="p">(</span><span class="o">&amp;</span><span class="n">vtProp</span><span class="p">)</span> <span class="o">!=</span> <span class="n">VT_NULL</span><span class="p">)</span> <span class="p">{</span>

          <span class="c1">// Do our comparaison</span>
          <span class="k">if</span> <span class="p">(</span><span class="n">vtProp</span><span class="p">.</span><span class="n">uintVal</span> <span class="o">&lt;</span> <span class="mi">2</span><span class="p">)</span> <span class="p">{</span>
            <span class="n">bFound</span> <span class="o">=</span> <span class="n">TRUE</span><span class="p">;</span> <span class="k">break</span><span class="p">;</span>
          <span class="p">}</span>

          <span class="c1">// release the current result object</span>
          <span class="n">VariantClear</span><span class="p">(</span><span class="o">&amp;</span><span class="n">vtProp</span><span class="p">);</span>
          <span class="n">pclsObj</span><span class="o">-&gt;</span><span class="n">Release</span><span class="p">();</span>
        <span class="p">}</span>
      <span class="p">}</span>

      <span class="c1">// Cleanup</span>
      <span class="n">pEnumerator</span><span class="o">-&gt;</span><span class="n">Release</span><span class="p">();</span>
      <span class="n">pSvc</span><span class="o">-&gt;</span><span class="n">Release</span><span class="p">();</span>
      <span class="n">pLoc</span><span class="o">-&gt;</span><span class="n">Release</span><span class="p">();</span>
      <span class="n">CoUninitialize</span><span class="p">();</span>
    <span class="p">}</span>
  <span class="p">}</span>

  <span class="k">return</span> <span class="n">bFound</span><span class="p">;</span>
<span class="p">}</span>


<span class="cm">/*
Check hard disk size using WMI
*/</span>
<span class="n">BOOL</span> <span class="nf">disk_size_wmi</span><span class="p">()</span>
<span class="p">{</span>
  <span class="n">IWbemServices</span> <span class="o">*</span><span class="n">pSvc</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
  <span class="n">IWbemLocator</span> <span class="o">*</span><span class="n">pLoc</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
  <span class="n">IEnumWbemClassObject</span> <span class="o">*</span><span class="n">pEnumerator</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
  <span class="n">BOOL</span> <span class="n">bStatus</span> <span class="o">=</span> <span class="n">FALSE</span><span class="p">;</span>
  <span class="n">HRESULT</span> <span class="n">hRes</span><span class="p">;</span>
  <span class="n">BOOL</span> <span class="n">bFound</span> <span class="o">=</span> <span class="n">FALSE</span><span class="p">;</span>
  <span class="n">INT64</span> <span class="n">minHardDiskSize</span> <span class="o">=</span> <span class="p">(</span><span class="mi">80LL</span> <span class="o">*</span> <span class="p">(</span><span class="mi">1024LL</span> <span class="o">*</span> <span class="p">(</span><span class="mi">1024LL</span> <span class="o">*</span> <span class="p">(</span><span class="mi">1024LL</span><span class="p">))));</span>

  <span class="c1">// Init WMI</span>
  <span class="n">bStatus</span> <span class="o">=</span> <span class="n">InitWMI</span><span class="p">(</span><span class="o">&amp;</span><span class="n">pSvc</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">pLoc</span><span class="p">);</span>
  <span class="k">if</span> <span class="p">(</span><span class="n">bStatus</span><span class="p">)</span>
  <span class="p">{</span>
    <span class="c1">// If success, execute the desired query</span>
    <span class="n">bStatus</span> <span class="o">=</span> <span class="n">ExecWMIQuery</span><span class="p">(</span><span class="o">&amp;</span><span class="n">pSvc</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">pLoc</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">pEnumerator</span><span class="p">,</span> <span class="n">_T</span><span class="p">(</span><span class="s">"SELECT * FROM Win32_LogicalDisk"</span><span class="p">));</span>
    <span class="k">if</span> <span class="p">(</span><span class="n">bStatus</span><span class="p">)</span>
    <span class="p">{</span>
      <span class="c1">// Get the data from the query</span>
      <span class="n">IWbemClassObject</span> <span class="o">*</span><span class="n">pclsObj</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
      <span class="n">ULONG</span> <span class="n">uReturn</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
      <span class="n">VARIANT</span> <span class="n">vtProp</span><span class="p">;</span>

      <span class="c1">// Iterate over our enumator</span>
      <span class="k">while</span> <span class="p">(</span><span class="n">pEnumerator</span><span class="p">)</span>
      <span class="p">{</span>
        <span class="n">hRes</span> <span class="o">=</span> <span class="n">pEnumerator</span><span class="o">-&gt;</span><span class="n">Next</span><span class="p">(</span><span class="n">WBEM_INFINITE</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">pclsObj</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">uReturn</span><span class="p">);</span>
        <span class="k">if</span> <span class="p">(</span><span class="mi">0</span> <span class="o">==</span> <span class="n">uReturn</span><span class="p">)</span>
          <span class="k">break</span><span class="p">;</span>

        <span class="c1">// Get the value of the Name property</span>
        <span class="n">hRes</span> <span class="o">=</span> <span class="n">pclsObj</span><span class="o">-&gt;</span><span class="n">Get</span><span class="p">(</span><span class="n">_T</span><span class="p">(</span><span class="s">"Size"</span><span class="p">),</span> <span class="mi">0</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">vtProp</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
        <span class="k">if</span> <span class="p">(</span><span class="n">V_VT</span><span class="p">(</span><span class="o">&amp;</span><span class="n">vtProp</span><span class="p">)</span> <span class="o">!=</span> <span class="n">VT_NULL</span><span class="p">)</span> <span class="p">{</span>

          <span class="c1">// Do our comparaison</span>
          <span class="k">if</span> <span class="p">(</span><span class="n">vtProp</span><span class="p">.</span><span class="n">llVal</span> <span class="o">&lt;</span> <span class="n">minHardDiskSize</span><span class="p">)</span> <span class="p">{</span> <span class="c1">// Less than 80GB</span>
            <span class="n">bFound</span> <span class="o">=</span> <span class="n">TRUE</span><span class="p">;</span> <span class="k">break</span><span class="p">;</span>
          <span class="p">}</span>

          <span class="c1">// release the current result object</span>
          <span class="n">VariantClear</span><span class="p">(</span><span class="o">&amp;</span><span class="n">vtProp</span><span class="p">);</span>
          <span class="n">pclsObj</span><span class="o">-&gt;</span><span class="n">Release</span><span class="p">();</span>
        <span class="p">}</span>
      <span class="p">}</span>

      <span class="c1">// Cleanup</span>
      <span class="n">pEnumerator</span><span class="o">-&gt;</span><span class="n">Release</span><span class="p">();</span>
      <span class="n">pSvc</span><span class="o">-&gt;</span><span class="n">Release</span><span class="p">();</span>
      <span class="n">pLoc</span><span class="o">-&gt;</span><span class="n">Release</span><span class="p">();</span>
      <span class="n">CoUninitialize</span><span class="p">();</span>
    <span class="p">}</span>
  <span class="p">}</span>

  <span class="k">return</span> <span class="n">bFound</span><span class="p">;</span>
<span class="p">}</span></code></pre></figure>

<p><i>Credits for this code sample: <a href="https://github.com/LordNoteworthy/al-khaser">al-khaser project</a></i></p>

<hr class="space" />

<p><b>Code sample (PowerShell)</b></p>

<figure class="highlight"><pre><code class="language-powershell" data-lang="powershell"><span class="p">(</span><span class="n">Get-CimInstance</span><span class="w"> </span><span class="nt">-ClassName</span><span class="w"> </span><span class="nx">Win32_BIOS</span><span class="w"> </span><span class="nt">-Property</span><span class="w"> </span><span class="nx">SerialNumber</span><span class="p">)</span><span class="o">.</span><span class="nf">SerialNumber</span></code></pre></figure>

<hr class="space" />

<p><b>Signature recommendations</b></p>
<p></p>
<p>If the following function contains a 3rd argument from the table column <font face="Courier New">"Query"</font>:</p>
<p></p>
<ul>
<li><tt>IWbemServices_ExecQuery(..., query, ...)</tt></li> 
</ul>
<p>then it’s an indicator of the application trying to use the evasion technique.</p>

<hr class="space" />

<p><b>Detections table</b></p>

<table>
  <tr>
    <td colspan="5">The following WMI queries may be used to detect virtual environment:</td>
  </tr>
  <tr>
    <th style="text-align:center">Query</th>
    <th style="text-align:center">Field</th>
    <th style="text-align:center">Value</th>
    <th style="text-align:center">Detect</th>
    <th style="text-align:center">Comments</th>
  </tr>
  <tr>
    <td rowspan="2">SELECT * FROM Win32_Processor</td>
    <td>NumberOfCores</td>
    <td>&lt; 2</td>
    <th rowspan="6">[general]</th>
    <td></td>
  </tr>
  <tr>
    <td>ProcessorId</td>
    <td>[empty]</td>
    <td></td>
  </tr>
  <tr>
    <td>SELECT * FROM Win32_LogicalDisk</td>
    <td>Size</td>
    <td>&lt; 60GB</td>
    <td></td>
  </tr>
  <tr>
    <td rowspan="2">SELECT * FROM Win32_BaseBoard</td>
    <td>SerialNumber</td>
    <td>None</td>
    <td></td>
  </tr>
  <tr>
    <td>Version</td>
    <td>None</td>
    <td></td>
  </tr>
  <tr>
    <td>SELECT * FROM MSAcpi_ThermalZoneTemperature</td>
    <td>CurrentTemperature</td>
    <td>"Not supported"</td>
    <td></td>
  </tr>
  <tr>
    <td rowspan="5">SELECT * FROM Win32_PnPEntity</td>
    <td rowspan="5">DeviceId</td>
    <td>PCI\VEN_80EE&amp;DEV_CAFE</td>
    <th rowspan="3">VirtualBox</th>
    <td></td>
  </tr>
  <tr>
    <td>IDE\CDROOMVBOX</td>
    <td></td>
  </tr>
  <tr>
    <td>IDE\DISKVBOX*</td>
    <td></td>
  </tr>
  <tr>
    <td>VEN_VMWARE</td>
    <th rowspan="2">VMware</th>
    <td></td>
  </tr>
  <tr>
    <td>PROD_VMWARE_VIRTUAL</td>
    <td></td>
  </tr>
  <tr>
    <td rowspan="7">SELECT * FROM Win32_NetworkAdapterConfiguration</td>
    <td rowspan="7">MACAddress</td>
    <td>08:00:27</td>
    <th>VirtualBox</th>
    <td>See <a href="network.html#check-if-mac-address-is-specific">"Check if MAC address is specific"</a> section in "Network" chapter</td>
  </tr>
  <tr>
    <td>00:1C:42</td>
    <th>Parallels</th>
    <td></td>
  </tr>
  <tr>
    <td>00:05:69</td>
    <th rowspan="4">VMware</th>
    <td></td>
  </tr>
  <tr>
    <td>00:0C:29</td>
    <td></td>
  </tr>
  <tr>
    <td>00:1C:14</td>
    <td></td>
  </tr>
  <tr>
    <td>00:50:56</td>
    <td></td>
  </tr>
  <tr>
    <td>00:16:E3</td>
    <th>XEN</th>
    <td></td>
  </tr>
  <tr>
    <td rowspan="7">SELECT * FROM Win32_Bios</td>
    <td rowspan="2">Serial Number</td>
    <td>VMware-</td>
    <th>VMware</th>
    <td></td>
  </tr>
  <tr>
    <td>0</td>
    <th>VirtualBox</th>
    <td></td>
  </tr>
  <tr>
    <td rowspan="5">Version</td>
    <td>INTEL - 6040000</td>
    <th>VMware</th>
    <td>See "SystemBiosVersion" in <a href="registry.html#check-if-keys-contain-strings">"Check if particular registry keys contain specified strings"</a> section in "Registry" chapter</td>
  </tr>
  <tr>
    <td>BOCHS</td>
    <th>BOCHS</th>
    <td></td>
  </tr>
  <tr>
    <td>PARALLELS</td>
    <th>Parallels</th>
    <td></td>
  </tr>
  <tr>
    <td>QEMU</td>
    <th>QEMU</th>
    <td></td>
  </tr>
  <tr>
    <td>VBOX</td>
    <th>VirtualBox</th>
    <td></td>
  </tr>
  <tr>
    <td rowspan="4">SELECT * FROM Win32_ComputerSystem</td>
    <td rowspan="2">Model</td>
    <td>VMware</td>
    <th>VMware</th>
    <td></td>
  </tr>
  <tr>
    <td>VirtualBox</td>
    <th>VirtualBox</th>
    <td></td>
  </tr>
  <tr>
    <td rowspan="2">Manufacturer</td>
    <td>VMware</td>
    <th>VMware</th>
    <td></td>
  </tr>
  <tr>
    <td>innotek GmbH</td>
    <th>VirtualBox</th>
    <td></td>
  </tr>
  <tr>
    <td rowspan="8">SELECT * FROM Win32_VideoController</td>
    <td rowspan="2">AdapterCompatibility</td>
    <td>VMware</td>
    <th>VMware</th>
    <td></td>
  </tr>
  <tr>
    <td>Oracle Corporation</td>
    <th>VirtualBox</th>
    <td></td>
  </tr>
  <tr>
    <td rowspan="2">Caption</td>
    <td>VMware</td>
    <th>VMware</th>
    <td></td>
  </tr>
  <tr>
    <td>VirtualBox</td>
    <th>VirtualBox</th>
    <td></td>
  </tr>
  <tr>
    <td rowspan="2">Description</td>
    <td>VMware</td>
    <th>VMware</th>
    <td></td>
  </tr>
  <tr>
    <td>VirtualBox</td>
    <th>VirtualBox</th>
    <td></td>
  </tr>
  <tr>
    <td rowspan="2">Name</td>
    <td>VMware</td>
    <th>VMware</th>
    <td></td>
  </tr>
  <tr>
    <td>VirtualBox</td>
    <th>VirtualBox</th>
    <td></td>
  </tr>
  <tr>
    <td>SELECT * FROM Win32_PointingDevice</td>
    <td>Description</td>
    <td>VMware</td>
    <th>VMware</th>
    <td></td>
  </tr>
</table>

<hr class="space" />

<p><i>Queries listed in the table are not the only ones possible, and are presented to give an idea of how they work and what information can be retrieved with these calls.</i></p>

<p></p>
<p><b>Countermeasures</b></p>
<p></p>
<p>Countermeasures depend on the particular checks implemented via the WMI method and they are the same as for the corresponding methods described in the relevant articles. Additionally, you must restart the “<tt>winmgmt</tt>” service.</p>

<hr class="space" />

<p><br /></p>
<h3><a class="a-dummy" name="escape-from-tracking">2. Escape from tracking using WMI</a></h3>
<p>WMI provides a way to create new processes and to schedule tasks. Sandboxes usually use the <tt>CreateProcessInternalW</tt> function hooking to track child processes. However, when you create the process using WMI the function <tt>CreateProcessInternalW</tt> is not called in the parent process. Therefore, the processes created using WMI may not be tracked by a sandbox and their behavior will not be recorded.
<br /></p>
<h4><a class="a-dummy" name="wmi-process">2.1. Start process using WMI</a></h4>
<p>You can create a new process with WMI using the “<tt>Win32_Process</tt>” class with the method “<tt>Create</tt>”.</p>

<p><b>Code sample</b></p>
<p></p>

<figure class="highlight"><pre><code class="language-c" data-lang="c"><span class="c1">// Initialize COM</span>
<span class="n">CoInitializeEx</span><span class="p">(</span><span class="nb">NULL</span><span class="p">,</span> <span class="n">COINIT_MULTITHREADED</span><span class="p">);</span>

<span class="c1">//  Set general COM security levels</span>
<span class="n">hres</span> <span class="o">=</span> <span class="n">CoInitializeSecurity</span><span class="p">(</span><span class="nb">NULL</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">,</span> <span class="n">RPC_C_AUTHN_LEVEL_DEFAULT</span><span class="p">,</span> <span class="n">RPC_C_IMP_LEVEL_IMPERSONATE</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">);</span>
<span class="k">if</span> <span class="p">(</span><span class="n">FAILED</span><span class="p">(</span><span class="n">hres</span><span class="p">)</span> <span class="o">&amp;&amp;</span> <span class="n">hres</span> <span class="o">!=</span> <span class="n">RPC_E_TOO_LATE</span><span class="p">)</span>
    <span class="k">break</span><span class="p">;</span>

<span class="c1">// create an instance of WbemLocator</span>
<span class="n">CoCreateInstance</span><span class="p">(</span><span class="n">CLSID_WbemLocator</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">,</span> <span class="n">CLSCTX_INPROC_SERVER</span><span class="p">,</span> <span class="n">IID_IWbemLocator</span><span class="p">,</span> <span class="p">(</span><span class="n">LPVOID</span><span class="o">*</span><span class="p">)</span><span class="o">&amp;</span><span class="n">wbemLocator</span><span class="p">);</span>
<span class="n">wbemLocator</span><span class="o">-&gt;</span><span class="n">ConnectServer</span><span class="p">(</span><span class="n">CComBSTR</span><span class="p">(</span><span class="s">"ROOT</span><span class="se">\\</span><span class="s">CIMV2"</span><span class="p">),</span> <span class="nb">NULL</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">wbemServices</span><span class="p">);</span>

<span class="c1">// get Win32_Process object</span>
<span class="n">wbemServices</span><span class="o">-&gt;</span><span class="n">GetObject</span><span class="p">(</span><span class="n">CComBSTR</span><span class="p">(</span><span class="s">"Win32_Process"</span><span class="p">),</span> <span class="mi">0</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">oWin32Process</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">callResult</span><span class="p">);</span>
<span class="n">wbemServices</span><span class="o">-&gt;</span><span class="n">GetObject</span><span class="p">(</span><span class="n">CComBSTR</span><span class="p">(</span><span class="s">"Win32_ProcessStartup"</span><span class="p">),</span> <span class="mi">0</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">oWin32ProcessStartup</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">callResult</span><span class="p">);</span>
<span class="n">oWin32Process</span><span class="o">-&gt;</span><span class="n">GetMethod</span><span class="p">(</span><span class="n">CComBSTR</span><span class="p">(</span><span class="s">"Create"</span><span class="p">),</span> <span class="mi">0</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">oMethCreate</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">oMethCreateSignature</span><span class="p">);</span>
<span class="n">oMethCreate</span><span class="o">-&gt;</span><span class="n">SpawnInstance</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">instWin32Process</span><span class="p">);</span>
<span class="n">oWin32ProcessStartup</span><span class="o">-&gt;</span><span class="n">SpawnInstance</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">instWin32ProcessStartup</span><span class="p">);</span>
<span class="c1">// set startup information for process</span>
<span class="n">instWin32ProcessStartup</span><span class="o">-&gt;</span><span class="n">Put</span><span class="p">(</span><span class="n">CComBSTR</span><span class="p">(</span><span class="s">"CreateFlags"</span><span class="p">),</span> <span class="mi">0</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">varCreateFlags</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
<span class="n">instWin32Process</span><span class="o">-&gt;</span><span class="n">Put</span><span class="p">(</span><span class="n">CComBSTR</span><span class="p">(</span><span class="s">"CommandLine"</span><span class="p">),</span> <span class="mi">0</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">varCmdLine</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
<span class="n">instWin32Process</span><span class="o">-&gt;</span><span class="n">Put</span><span class="p">(</span><span class="n">CComBSTR</span><span class="p">(</span><span class="s">"CurrentDirectory"</span><span class="p">),</span> <span class="mi">0</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">varCurDir</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
<span class="n">CComVariant</span> <span class="nf">varStartupInfo</span><span class="p">(</span><span class="n">instWin32ProcessStartup</span><span class="p">);</span>
<span class="n">instWin32Process</span><span class="o">-&gt;</span><span class="n">Put</span><span class="p">(</span><span class="n">CComBSTR</span><span class="p">(</span><span class="s">"ProcessStartupInformation"</span><span class="p">),</span> <span class="mi">0</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">varStartupInfo</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
<span class="n">wbemServices</span><span class="o">-&gt;</span><span class="n">ExecMethod</span><span class="p">(</span><span class="n">CComBSTR</span><span class="p">(</span><span class="s">"Win32_Process"</span><span class="p">),</span> <span class="n">CComBSTR</span><span class="p">(</span><span class="s">"Create"</span><span class="p">),</span> <span class="mi">0</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">,</span> <span class="n">instWin32Process</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">pOutParams</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">callResult</span><span class="p">);</span></code></pre></figure>

<p><i>Code sample is taken from <a href="https://github.com/CheckPointSW/InviZzzible">InviZzzible tool</a> </i></p>

<hr class="space" />

<p><b>Signature recommendations</b></p>
<p></p>
<p>If one of the following functions is called with the 2nd argument “<tt>Win32_Process</tt>” and the 3rd argument “<tt>Create</tt>”:</p>
<p></p>
<ul>
<li><tt>IWbemServices_ExecMethod(..., BSTR("Win32_Process"), BSTR("Create"), ...)</tt></li>
<li><tt>IWbemServices_ExecMethodAsync(..., BSTR("Win32_Process"), BSTR("Create"), ...)</tt></li> 
</ul>
<p>then it’s an indicator of the application trying to use the evasion technique.</p>
<p></p>
<p><b>Countermeasures</b></p>
<p></p>
<p>If you use a kernel-mode monitor, hook target functions or register callback on the process creation with <tt>PsSetCreateProcessNotifyRoutineEx</tt>.</p>

<hr class="space" />

<h4><a class="a-dummy" name="wmi-tsched">2.2. Start process using Task Scheduler via WMI (Windows 7)</a></h4>
<p>The technique is essentially the same as described in the <a href="timing.html#deferred-execution-using-task-scheduler">“Deferred execution using Task Scheduler”</a> section in the “Timing” chapter. WMI just provides another way to schedule a task.</p>

<p>You can create a new task with WMI using the “<tt>Win32_ScheduledJob</tt>” class with the method “<tt>Create</tt>”.</p>

<p>However, the “<tt>Win32_ScheduledJob</tt>” WMI class was designed to work with the AT command, which is deprecated since Windows 8.</p>

<p>In Windows 8 and higher, you can only create scheduled jobs with WMI if the registry key “<tt>HKEY_LOCAL_MACHINE\SOFTWARE\Microsoft\Windows NT\CurrentVersion\Schedule\Configuration</tt>” has a value “<tt>EnableAt</tt>”=”1” of type <tt>REG_DWORD</tt>. Therefore, this technique is unlikely to be found in the wild.</p>

<p><b>Code sample (VB)</b></p>
<p></p>

<figure class="highlight"><pre><code class="language-vb" data-lang="vb"><span class="n">strComputer</span> <span class="o">=</span> <span class="s">"."</span>
<span class="k">Set</span> <span class="n">objWMIService</span> <span class="o">=</span> <span class="n">GetObject</span><span class="p">(</span><span class="s">"winmgmts:"</span> <span class="o">&amp;</span> <span class="s">"{impersonationLevel=Impersonate}!\\"</span> <span class="o">&amp;</span> <span class="n">strComputer</span> <span class="o">&amp;</span> <span class="s">"\root\cimv2"</span><span class="p">)</span> 
<span class="k">Set</span> <span class="n">objSWbemDateTime</span> <span class="o">=</span> <span class="n">CreateObject</span><span class="p">(</span><span class="s">"WbemScripting.SWbemDateTime"</span><span class="p">)</span>
<span class="n">objSWbemDateTime</span><span class="p">.</span><span class="n">SetVarDate</span><span class="p">(</span><span class="n">DateAdd</span><span class="p">(</span><span class="s">"n"</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="n">Now</span><span class="p">()))</span>
<span class="k">Set</span> <span class="n">objNewJob</span> <span class="o">=</span> <span class="n">objWMIService</span><span class="p">.</span><span class="n">Get</span><span class="p">(</span><span class="s">"Win32_ScheduledJob"</span><span class="p">)</span>
<span class="n">errJobCreate</span> <span class="o">=</span> <span class="n">objNewJob</span><span class="p">.</span><span class="n">Create</span><span class="p">(</span><span class="s">"malware.exe"</span><span class="p">,</span> <span class="n">objSWbemDateTime</span><span class="p">.</span><span class="n">Value</span><span class="p">,</span> <span class="k">False</span><span class="p">,</span> <span class="p">,</span> <span class="p">,</span> <span class="k">True</span><span class="p">,</span> <span class="s">"MaliciousJob"</span><span class="p">)</span> </code></pre></figure>

<hr class="space" />

<p><b>Signature recommendations</b></p>
<p></p>
<p>If one of the following functions is called with the 2nd argument “Win32_ScheduledJob” and the 3rd argument “Create”:</p>
<p></p>
<ul>
<li><tt>IWbemServices_ExecMethod(..., BSTR("Win32_ScheduledJob"), BSTR("Create"), ...)</tt></li>
<li><tt>IWbemServices_ExecMethodAsync(..., BSTR("Win32_ScheduledJob"), BSTR("Create"), ...)</tt></li> 
</ul>
<p>then it’s an indicator of the application trying to use the evasion technique.</p>
<p></p>
<p><b>Countermeasures</b></p>
<p></p>
<p>Use a kernel-mode monitor, and register callback on the process creation with PsSetCreateProcessNotifyRoutineEx.</p>
<p></p>

<hr class="space" />

<p><br /></p>
<h3><a class="a-dummy" name="check-last-boot-time">3. Check the last boot time</a></h3>
<p>If the last boot time is queried immediately after restoring a VM from a snapshot, the WMI database may contain the value saved at the moment the VM snapshot was created. If the snapshot was created a year ago, the calculated system uptime will be a year as well even if a sandbox updates the last boot time.</p>

<p>This fact can be used to detect a virtual machine restored from a snapshot. Also, any anomalies in the last boot time can be used as sandbox indicators:</p>
<ul>
<li>The system uptime is too big (months or even years)</li>
<li>The system uptime is to small (less than several minutes)</li>
<li>The last boot time obtained using <a href="timing.html#get-system-time">other methods</a> differs from the last boot time obtained using WMI</li>
</ul>

<p><b>Code sample (VB)</b></p>
<p></p>

<figure class="highlight"><pre><code class="language-vb" data-lang="vb"><span class="n">strComputer</span> <span class="o">=</span> <span class="s">"."</span>
<span class="k">Set</span> <span class="n">objWMIService</span> <span class="o">=</span> <span class="n">GetObject</span><span class="p">(</span><span class="s">"winmgmts:"</span> <span class="o">&amp;</span> <span class="s">"{impersonationLevel=impersonate}!\\"</span> <span class="o">&amp;</span> <span class="n">strComputer</span> <span class="o">&amp;</span> <span class="s">"\root\cimv2"</span><span class="p">)</span>
<span class="k">Set</span> <span class="n">colOperatingSystems</span> <span class="o">=</span> <span class="n">objWMIService</span><span class="p">.</span><span class="n">ExecQuery</span> <span class="p">(</span><span class="s">"Select * from Win32_OperatingSystem"</span><span class="p">)</span>
 
<span class="k">For</span> <span class="k">Each</span> <span class="n">objOS</span> <span class="n">in</span> <span class="n">colOperatingSystems</span>
    <span class="n">dtmBootup</span> <span class="o">=</span> <span class="n">objOS</span><span class="p">.</span><span class="n">LastBootUpTime</span>
    <span class="n">dtmLastBootUpTime</span> <span class="o">=</span> <span class="n">WMIDateStringToDate</span><span class="p">(</span><span class="n">dtmBootup</span><span class="p">)</span>
    <span class="n">dtmSystemUptime</span> <span class="o">=</span> <span class="n">DateDiff</span><span class="p">(</span><span class="s">"n"</span><span class="p">,</span> <span class="n">dtmLastBootUpTime</span><span class="p">,</span> <span class="n">Now</span><span class="p">)</span>
    <span class="n">Wscript</span><span class="p">.</span><span class="n">Echo</span> <span class="s">"System uptime minutes: "</span> <span class="o">&amp;</span> <span class="n">dtmSystemUptime</span> 
<span class="k">Next</span>
 
<span class="k">Function</span> <span class="nf">WMIDateStringToDate</span><span class="p">(</span><span class="n">dtm</span><span class="p">)</span>
    <span class="n">WMIDateStringToDate</span> <span class="o">=</span>  <span class="k">CDate</span><span class="p">(</span><span class="n">Mid</span><span class="p">(</span><span class="n">dtm</span><span class="p">,</span> <span class="mi">5</span><span class="p">,</span> <span class="mi">2</span><span class="p">)</span> <span class="o">&amp;</span> <span class="s">"/"</span> <span class="o">&amp;</span> <span class="n">_</span>
        <span class="n">Mid</span><span class="p">(</span><span class="n">dtm</span><span class="p">,</span> <span class="mi">7</span><span class="p">,</span> <span class="mi">2</span><span class="p">)</span> <span class="o">&amp;</span> <span class="s">"/"</span> <span class="o">&amp;</span> <span class="n">Left</span><span class="p">(</span><span class="n">dtm</span><span class="p">,</span> <span class="mi">4</span><span class="p">)</span> <span class="o">&amp;</span> <span class="s">" "</span> <span class="o">&amp;</span> <span class="n">Mid</span> <span class="p">(</span><span class="n">dtm</span><span class="p">,</span> <span class="mi">9</span><span class="p">,</span> <span class="mi">2</span><span class="p">)</span> <span class="o">&amp;</span> <span class="s">":"</span> <span class="o">&amp;</span> <span class="n">_</span>
        <span class="n">Mid</span><span class="p">(</span><span class="n">dtm</span><span class="p">,</span> <span class="mi">11</span><span class="p">,</span> <span class="mi">2</span><span class="p">)</span> <span class="o">&amp;</span> <span class="s">":"</span> <span class="o">&amp;</span> <span class="n">Mid</span><span class="p">(</span><span class="n">dtm</span><span class="p">,</span> <span class="mi">13</span><span class="p">,</span> <span class="mi">2</span><span class="p">))</span>
<span class="k">End</span> <span class="k">Function</span></code></pre></figure>

<p><i>Code sample is taken from <a href="https://docs.microsoft.com/en-us/windows/win32/wmisdk/wmi-tasks--desktop-management">Microsoft Docs</a> </i></p>

<hr class="space" />

<p><b>Signature recommendations</b></p>
<p></p>
<p>If the following function is called with the 3rd argument BSTR(“Win32_OperatingSystem”):</p>
<p></p>
<ul>
<li><tt>IWbemServices_ExecQuery(..., BSTR("Win32_OperatingSystem"), ...)</tt></li>
</ul>
<p>then it’s a possible indicator of the application trying to use the evasion technique.</p>

<p></p>
<p><b>Countermeasures</b></p>
<p></p>
<ul>
<li>Adjust the <tt>KeBootTime</tt> value</li>
<li>Reset the WMI repository or restart the "<tt>winmgmt</tt>" service after you adjust the <tt>KeBootTime</tt> value</li>
</ul>

<hr class="space" />

<p><br /></p>
<h3><a class="a-dummy" name="check-network-adapter-reset-time">4. Check the network adapters last reset time</a></h3>
<p>We need to check if there are any adapters that were last reset a long time ago. This may indicate the application is running in a virtual machine restored from a snapshot.</p>

<p><b>Code sample (VB)</b></p>
<p></p>

<figure class="highlight"><pre><code class="language-vb" data-lang="vb"><span class="n">strComputer</span> <span class="o">=</span> <span class="s">"."</span>
<span class="k">Set</span> <span class="n">objWMIService</span> <span class="o">=</span> <span class="n">GetObject</span><span class="p">(</span><span class="s">"winmgmts:"</span> <span class="o">&amp;</span> <span class="s">"{impersonationLevel=impersonate}!\\"</span> <span class="o">&amp;</span> <span class="n">strComputer</span> <span class="o">&amp;</span> <span class="s">"\root\cimv2"</span><span class="p">)</span>
<span class="k">Set</span> <span class="n">colOperatingSystems</span> <span class="o">=</span> <span class="n">objWMIService</span><span class="p">.</span><span class="n">ExecQuery</span> <span class="p">(</span><span class="s">"Select * from Win32_NetworkAdapter"</span><span class="p">)</span>
 
<span class="k">For</span> <span class="k">Each</span> <span class="n">objOS</span> <span class="n">in</span> <span class="n">colNetworkAdapters</span>
    <span class="n">dtmLastReset</span> <span class="o">=</span> <span class="n">objOS</span><span class="p">.</span><span class="n">TimeOfLastReset</span>
    <span class="n">dtmLastResetTime</span> <span class="o">=</span> <span class="n">WMIDateStringToDate</span><span class="p">(</span><span class="n">dtmLastReset</span><span class="p">)</span>  <span class="c1">'WMIDateStringToDate function from the previous example</span>
    <span class="n">dtmAdapterUptime</span> <span class="o">=</span> <span class="n">DateDiff</span><span class="p">(</span><span class="s">"n"</span><span class="p">,</span> <span class="n">dtmLastResetTime</span><span class="p">,</span> <span class="n">Now</span><span class="p">)</span>
    <span class="n">Wscript</span><span class="p">.</span><span class="n">Echo</span> <span class="s">"Adapter uptime minutes: "</span> <span class="o">&amp;</span> <span class="n">dtmAdapterUptime</span> 
<span class="k">Next</span></code></pre></figure>

<p><b>Signature recommendations</b></p>
<p></p>
<p>If the following function is called with the 3rd argument BSTR(“Win32_OperatingSystem”):</p>
<p></p>
<ul>
<li><tt>IWbemServices_ExecQuery(..., BSTR("Win32_NetworkAdapter"), ...)</tt></li>
</ul>
<p>then it’s a possible indicator of the application trying to use the evasion technique.</p>

<p></p>
<p><b>Countermeasures</b></p>
<p></p>
<ul>
<li>Ensure an adequate last reset time for the network adapters</li>
<li>Reset the WMI repository or restart the "<tt>winmgmt</tt>" service </li>
</ul>

<p><br /></p>
<h3><a class="a-dummy" name="countermeasures">Countermeasures</a></h3>
<p>Countermeasures are presented in the appropriate sub-sections above.</p>

<p><br /></p>
<h3><a class="a-dummy" name="credits">Credits</a></h3>

<ul>
<li>al-khaser project on <a href="https://github.com/LordNoteworthy/al-khaser">GitHub</a></li>
<li>Microsoft Docs - <a href="https://docs.microsoft.com/en-us/windows/win32/wmisdk/">WMI Tasks: Desktop Management</a></li>
</ul>

    <br>
    <div style="text-align: left">
        <a href="..">Go back</a>
    </div>
    <br>
    <div class="sharebuttons" style="text-align: center">
        <hr />
        <ul>
          <li>
            <p class="sharetitle"> Share this: </p>
          </li>
          <li class="reddit">
            <a href="http://www.reddit.com/submit?url=https://evasions.checkpoint.com/src/Evasions/techniques/wmi.html&title=Evasions:%20WMI - Evasion Techniques" target="_blank">
                <svg xmlns="http://www.w3.org/2000/svg"
                aria-label="Reddit" role="img"
                viewBox="0 0 512 512"><rect
                width="512" height="512"
                rx="15%"
                fill="#f40"/><g fill="#fff"><ellipse cx="256" cy="307" rx="166" ry="117"/><circle cx="106" cy="256" r="42"/><circle cx="407" cy="256" r="42"/><circle cx="375" cy="114" r="32"/></g><g stroke-linecap="round" stroke-linejoin="round" fill="none"><path d="m256 196 23-101 73 15" stroke="#fff" stroke-width="16"/><path d="m191 359c33 25 97 26 130 0" stroke="#f40" stroke-width="13"/></g><g fill="#f40"><circle cx="191" cy="287" r="31"/><circle cx="321" cy="287" r="31"/></g></svg>
                
            </a>
          </li>
          <li class="hn">
            <a href="http://news.ycombinator.com/submitlink?u=https://evasions.checkpoint.com/src/Evasions/techniques/wmi.html&t=Evasions:%20WMI - Evasion Techniques" target="_blank">
                <svg xmlns="http://www.w3.org/2000/svg"
                aria-label="Hacker News" role="img"
                viewBox="0 0 512 512"><rect
                width="512" height="512"
                rx="15%"
                fill="#f60"/><path fill="#fff" d="M124 91h51l81 162 81-164h51L276 293v136h-40V293z"/></svg>
            </a>
          </li>
          <li class="twitter">
            <a href="https://twitter.com/intent/tweet?via=_CPResearch_&url=https://evasions.checkpoint.com/src/Evasions/techniques/wmi.html&text=Evasions:%20WMI - Evasion Techniques" target="_blank">
                <svg viewBox="0 0 1792 1792" xmlns="http://www.w3.org/2000/svg"><path d="M1684 408q-67 98-162 167 1 14 1 42 0 130-38 259.5t-115.5 248.5-184.5 210.5-258 146-323 54.5q-271 0-496-145 35 4 78 4 225 0 401-138-105-2-188-64.5t-114-159.5q33 5 61 5 43 0 85-11-112-23-185.5-111.5t-73.5-205.5v-4q68 38 146 41-66-44-105-115t-39-154q0-88 44-163 121 149 294.5 238.5t371.5 99.5q-8-38-8-74 0-134 94.5-228.5t228.5-94.5q140 0 236 102 109-21 205-78-37 115-142 178 93-10 186-50z"/></svg>
            </a>
          </li>
          <li class="linkedin">
            <a href=https://www.linkedin.com/shareArticle?mini=true&url=https://evasions.checkpoint.com/src/Evasions/techniques/wmi.html&title=Evasions:%20WMI - Evasion Techniques&source=LinkedIn" target="_blank">
                <svg viewBox="0 0 1792 1792" xmlns="http://www.w3.org/2000/svg"><path d="M477 625v991h-330v-991h330zm21-306q1 73-50.5 122t-135.5 49h-2q-82 0-132-49t-50-122q0-74 51.5-122.5t134.5-48.5 133 48.5 51 122.5zm1166 729v568h-329v-530q0-105-40.5-164.5t-126.5-59.5q-63 0-105.5 34.5t-63.5 85.5q-11 30-11 81v553h-329q2-399 2-647t-1-296l-1-48h329v144h-2q20-32 41-56t56.5-52 87-43.5 114.5-15.5q171 0 275 113.5t104 332.5z"/></svg>
            </a>
          </li>
        </ul>
      </div>
      
</article>


</section>

<nav class="navbar navbar-default navbar-fixed-bottom">
  <div class="container footer-content">

    Made with <font class="a-pink"><i class ="fa fa-heart"></i></font> to serve the community by Check Point Research    |    <a class="a-pink" href="https://research.checkpoint.com">Research blog</a>    |    <a class="a-pink" href="https://research.checkpoint.com/about-us/">About Us</a>    |    <a class="a-pink" href="https://github.com/CheckPointSW"><i class="fa fa-github fa-lg"></i></a> <a class="a-pink" href="https://twitter.com/_CPResearch_"><i class="fa fa-twitter fa-lg"></i></a>
    
    <br>
    
    © 1994-2024 Check Point Software Technologies LTD | All rights reserved | Property of CheckPoint.com


  </div>
</nav>

  </body>

</html>
