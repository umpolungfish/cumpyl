<!DOCTYPE html>
<html>

  <head>
  <meta charset="utf-8">
  <meta http-equiv="X-UA-Compatible" content="IE=edge">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-194688-3"></script>
  <script>
   window.dataLayer = window.dataLayer || [];
   function gtag(){dataLayer.push(arguments);}
   gtag('js', new Date());
   gtag('config', 'UA-194688-3');
  </script>
  <meta content="Evasion techniques" property="og:site_name">

  <meta content="Evasions: Hardware" property="og:title">


  <meta name="twitter:title" content="Malware Evasion Encyclopedia" />
  <meta name="twitter:image" content="https://research.checkpoint.com/wp-content/uploads/2020/02/evasions.jpg" />


  <meta content="article" property="og:type">


  <meta content="Evasion techniques
" property="og:description">


  <meta content="https://evasions.checkpoint.com/src/Evasions/techniques/hardware.html" property="og:url">


  <meta content="2024-07-10T07:20:28+00:00" property="article:published_time">
  <meta content="https://evasions.checkpoint.com/about/" property="article:author">


  <meta property="og:image" content="">


  
  <meta content="evasions" property="article:section">
  


  
  <meta content="hardware" property="article:tag">
  

  <title>Evasions: Hardware</title>
  <meta name="description" content="Contents">
<script src="https://ajax.googleapis.com/ajax/libs/jquery/2.2.2/jquery.min.js"></script>
<script src="https://maxcdn.bootstrapcdn.com/bootstrap/3.3.6/js/bootstrap.min.js" integrity="sha384-0mSbJDEHialfmuBBQP6A4Qrprq5OVfW37PRR3j5ELqxss1yVqOtnepnHVP9aJ7xS" crossorigin="anonymous"></script>
  <link rel="stylesheet" href="https://evasions.checkpoint.com/assets/css/main.css">
<script src="https://maxcdn.bootstrapcdn.com/bootstrap/3.3.6/js/bootstrap.min.js" integrity="sha384-0mSbJDEHialfmuBBQP6A4Qrprq5OVfW37PRR3j5ELqxss1yVqOtnepnHVP9aJ7xS" crossorigin="anonymous"></script>

  <link href='https://fonts.googleapis.com/css?family=PT+Sans' rel='stylesheet' type='text/css'>
  <link href='https://fonts.googleapis.com/css?family=Fira+Mono' rel='stylesheet' type='text/css'>
  <link href='https://fonts.googleapis.com/css?family=Lato:400,700' rel='stylesheet' type='text/css'>
  <link href='https://fonts.googleapis.com/css?family=Source+Code+Pro:400,200,300,500,600,700,900' rel='stylesheet' type='text/css'>
  <link href='https://fonts.googleapis.com/css?family=Gentium+Basic:400,700' rel='stylesheet' type='text/css'>
  <link href='https://fonts.googleapis.com/css?family=Alegreya:400,400italic,700' rel='stylesheet' type='text/css'>
  <link href='https://fonts.googleapis.com/css?family=Lora:400,400italic,700' rel='stylesheet' type='text/css'>
  <link href='https://fonts.googleapis.com/css?family=Fira+Sans:400,300,500,700' rel='stylesheet' type='text/css'>
  <script src="https://ajax.googleapis.com/ajax/libs/jquery/2.2.0/jquery.min.js"></script>
  <link href='https://fonts.googleapis.com/css?family=Open+Sans:400,700' rel='stylesheet' type='text/css'>
  <link href="https://maxcdn.bootstrapcdn.com/bootstrap/3.3.6/css/bootstrap.min.css" rel="stylesheet" integrity="sha384-1q8mTJOASx8j1Au+a5WDVnPi2lkFfwwEAa8hDDdjZlpLegxhjVME1fgjWPGmkzs7" crossorigin="anonymous">
  <link href="https://maxcdn.bootstrapcdn.com/font-awesome/4.6.1/css/font-awesome.min.css" rel="stylesheet" integrity="sha384-hQpvDQiCJaD2H465dQfA717v7lu5qHWtDbWNPvaTJ0ID5xnPUlVXnKzq7b8YUkbN" crossorigin="anonymous">
  <link rel="canonical" href="https://evasions.checkpoint.com/src/Evasions/techniques/hardware.html">
  <link rel="alternate" type="application/rss+xml" title="Evasion techniques" href="https://evasions.checkpoint.com/feed.xml">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/tinysort/2.3.6/tinysort.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/tinysort/2.3.6/tinysort.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/tinysort/2.3.6/tinysort.charorder.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/tinysort/2.3.6/tinysort.charorder.min.js"></script>
  <script type="text/javascript" async src="//platform.twitter.com/widgets.js"></script>




</head>


  <body>
<section>
<article class="post" itemscope itemtype="http://schema.org/BlogPosting">
  <div class="jumbotron">
    <div class="container">
      <h1 class="post-title-main" itemprop="name headline">Evasions: Hardware</h1>
    </div>
</div>

  <div class="post-content container" itemprop="articleBody">
    <div style="text-align: left">
        <a href="..">Go back</a>
        <br>
        <br>
    </div>
    <h1>Contents</h1>

<p><a href="#hardware-detection-methods">Hardware info detection methods</a>
<br />
  <a href="#check-if-hdd-has-specific-name">1. Check if HDD has specific name</a>
<br />
  <a href="#check-if-hdd-vendor-id-has-specific-value">2. Check if HDD Vendor ID has specific value</a>
<br />
  <a href="#check-if-audio-device-is-absent">3. Check if audio device is absent</a>
<br />
  <a href="#check-if-cpu-temperature-information-is-available">4. Check if CPU temperature information if available</a>
<br />
  <a href="#check-directx-adapter">5. Check physical display adapter for IDirect3D9 interface</a>
<br />
  <a href="#signature-recommendations">Signature recommendations</a>
<br />
  <a href="#countermeasures-sandboxie">Countermeasures</a>
<br />
<br /></p>

<hr class="space" />

<h2><a class="a-dummy" name="hardware-detection-methods">Hardware info detection methods</a></h2>
<p>Virtual environments emulate hardware devices and leave specific traces in their descriptions - which may be queried and the conclusion about non-host OS made.</p>

<p><br /></p>
<h3><a class="a-dummy" name="check-if-hdd-has-specific-name">1. Check if HDD has specific name</a></h3>

<p>Functions used:</p>
<ul>
  <li><tt>SetupDiGetClassDevs</tt></li> 
  <li><tt>SetupDiEnumDeviceInfo</tt></li> 
  <li><tt>SetupDiGetDeviceRegistryProperty</tt></li> 
</ul>

<hr class="space" />

<p><b>Code sample</b></p>
<p></p>

<figure class="highlight"><pre><code class="language-c" data-lang="c"><span class="n">hDevs</span> <span class="o">=</span> <span class="n">SetupDiGetClassDevs</span><span class="p">(</span>
    <span class="o">&amp;</span><span class="n">guid</span><span class="p">,</span>  <span class="c1">// GUID_DEVCLASS(DEVINTERFACE)_DISKDRIVE</span>
    <span class="nb">NULL</span><span class="p">,</span>
    <span class="nb">NULL</span><span class="p">,</span>
    <span class="n">DIGCF_PRESENT</span><span class="p">);</span>

<span class="n">SetupDiEnumDeviceInfo</span><span class="p">(</span>
    <span class="n">hDevsInfo</span><span class="p">,</span>
    <span class="mi">0</span><span class="p">,</span>
    <span class="o">&amp;</span><span class="n">devinfo</span><span class="p">);</span>  <span class="c1">// PSP_DEVINFO_DATA</span>

<span class="n">SetupDiGetDeviceRegistryProperty</span><span class="p">(</span>
    <span class="n">hDevs</span><span class="p">,</span>
    <span class="o">&amp;</span><span class="n">devinfo</span><span class="p">,</span>
    <span class="n">SPDRP_FRIENDLYNAME</span><span class="p">,</span>
    <span class="o">&amp;</span><span class="n">dword_1</span><span class="p">,</span>
    <span class="n">szFriendlyName</span><span class="p">,</span>  <span class="c1">// HDD name will be here</span>
    <span class="n">dFriendlyNameSize</span><span class="p">,</span>
    <span class="o">&amp;</span><span class="n">dword_2</span><span class="p">);</span></code></pre></figure>

<hr class="space" />

<p><b>Detections table</b></p>

<table style="width:60%">
  <tr>
    <td colspan="2">Check if hard disk drive has one of the following names:</td>
  </tr>
  <tr>
    <th style="text-align:center">Detect</th>
    <th style="text-align:center">Name</th>
  </tr>
  <tr>
    <th>QEMU</th>
    <td>QEMU</td>
  </tr>
  <tr>
    <th>VirtualBox</th>
    <td>VBOX</td>
  </tr>
  <tr>
    <th>VirtualPC</th>
    <td>VIRTUAL HD</td>
  </tr>
  <tr>
    <th>VMware</th>
    <td>VMware</td>
  </tr>
</table>

<p><br /></p>
<h3><a class="a-dummy" name="check-if-hdd-vendor-id-has-specific-value">2. Check if HDD Vendor ID has specific value</a></h3>

<p>The following function is used:</p>
<ul>
  <li><tt>DeviceIoControl(..., IOCTL_STORAGE_QUERY_PROPERTY, ...)</tt></li> 
</ul>

<hr class="space" />

<p><b>Code sample</b></p>
<p></p>

<figure class="highlight"><pre><code class="language-c" data-lang="c"><span class="n">bool</span> <span class="nf">GetHDDVendorId</span><span class="p">(</span><span class="n">std</span><span class="o">::</span><span class="n">string</span><span class="o">&amp;</span> <span class="n">outVendorId</span><span class="p">)</span> <span class="p">{</span>
    <span class="n">HANDLE</span> <span class="n">hDevice</span> <span class="o">=</span> <span class="n">CreateFileA</span><span class="p">(</span><span class="n">_T</span><span class="p">(</span><span class="s">"</span><span class="se">\\\\</span><span class="s">.</span><span class="se">\\</span><span class="s">PhysicalDrive0"</span><span class="p">),</span> 
                                 <span class="mi">0</span><span class="p">,</span> 
                                 <span class="n">FILE_SHARE_READ</span> <span class="o">|</span> <span class="n">FILE_SHARE_WRITE</span><span class="p">,</span> 
                                 <span class="mi">0</span><span class="p">,</span> 
                                 <span class="n">OPEN_EXISTING</span><span class="p">,</span> 
                                 <span class="mi">0</span><span class="p">,</span> 
                                 <span class="mi">0</span><span class="p">);</span>
    <span class="k">if</span> <span class="p">(</span><span class="n">hDevice</span> <span class="o">==</span> <span class="n">INVALID_HANDLE_VALUE</span><span class="p">)</span>
        <span class="k">return</span> <span class="nb">false</span><span class="p">;</span>
    
    <span class="n">STORAGE_PROPERTY_QUERY</span> <span class="n">storage_property_query</span> <span class="o">=</span> <span class="p">{};</span>
    <span class="n">storage_property_query</span><span class="p">.</span><span class="n">PropertyId</span> <span class="o">=</span> <span class="n">StorageDeviceProperty</span><span class="p">;</span>
    <span class="n">storage_property_query</span><span class="p">.</span><span class="n">QueryType</span> <span class="o">=</span> <span class="n">PropertyStandardQuery</span><span class="p">;</span>
    <span class="n">STORAGE_DESCRIPTOR_HEADER</span> <span class="n">storage_descriptor_header</span> <span class="o">=</span> <span class="p">{};</span>
    <span class="n">DWORD</span> <span class="n">BytesReturned</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
  
    <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">DeviceIoControl</span><span class="p">(</span><span class="n">hDevice</span><span class="p">,</span> <span class="n">IOCTL_STORAGE_QUERY_PROPERTY</span><span class="p">,</span> 
                         <span class="o">&amp;</span><span class="n">storage_property_query</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">storage_property_query</span><span class="p">),</span> 
                         <span class="o">&amp;</span><span class="n">storage_descriptor_header</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">storage_descriptor_header</span><span class="p">),</span> 
                         <span class="o">&amp;</span><span class="n">BytesReturned</span><span class="p">,</span> <span class="p">))</span> <span class="p">{</span>
        <span class="n">printf</span><span class="p">(</span><span class="s">"DeviceIoControl() for size query failed</span><span class="se">\n</span><span class="s">"</span><span class="p">);</span>
        <span class="n">CloseHandle</span><span class="p">(</span><span class="n">hDevice</span><span class="p">);</span>
        <span class="k">return</span> <span class="nb">false</span><span class="p">;</span>
    <span class="p">}</span>
    <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">BytesReturned</span><span class="p">)</span> <span class="p">{</span>
        <span class="n">CloseHandle</span><span class="p">(</span><span class="n">hDevice</span><span class="p">);</span>
        <span class="k">return</span> <span class="nb">false</span><span class="p">;</span>
    <span class="p">}</span>
  
    <span class="n">std</span><span class="o">::</span><span class="n">vector</span><span class="o">&lt;</span><span class="kt">char</span><span class="o">&gt;</span> <span class="n">buff</span><span class="p">(</span><span class="n">storage_descriptor_header</span><span class="p">.</span><span class="n">Size</span><span class="p">);</span> <span class="c1">//_STORAGE_DEVICE_DESCRIPTOR</span>
    <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">DeviceIoControl</span><span class="p">(</span><span class="n">hDevice</span><span class="p">,</span> <span class="n">IOCTL_STORAGE_QUERY_PROPERTY</span><span class="p">,</span> 
                         <span class="o">&amp;</span><span class="n">storage_property_query</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">storage_property_query</span><span class="p">),</span> 
                         <span class="n">buff</span><span class="p">.</span><span class="n">data</span><span class="p">(),</span> <span class="n">buff</span><span class="p">.</span><span class="n">size</span><span class="p">(),</span> <span class="mi">0</span><span class="p">))</span> <span class="p">{</span>
        <span class="n">CloseHandle</span><span class="p">(</span><span class="n">hDevice</span><span class="p">);</span>
        <span class="k">return</span> <span class="nb">false</span><span class="p">;</span>
    <span class="p">}</span>
  
    <span class="n">CloseHandle</span><span class="p">(</span><span class="n">hDevice</span><span class="p">);</span>
  
    <span class="k">if</span> <span class="p">(</span><span class="n">BytesReturned</span><span class="p">)</span> <span class="p">{</span>
        <span class="n">STORAGE_DEVICE_DESCRIPTOR</span><span class="o">*</span> <span class="n">device_descriptor</span> <span class="o">=</span> <span class="p">(</span><span class="n">STORAGE_DEVICE_DESCRIPTOR</span><span class="o">*</span><span class="p">)</span><span class="n">buff</span><span class="p">.</span><span class="n">data</span><span class="p">();</span>
        <span class="k">if</span> <span class="p">(</span><span class="n">device_descriptor</span><span class="o">-&gt;</span><span class="n">VendorIdOffset</span><span class="p">)</span>
            <span class="n">outVendorId</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">buff</span><span class="p">[</span><span class="n">device_descriptor</span><span class="o">-&gt;</span><span class="n">VendorIdOffset</span><span class="p">];</span>
  
        <span class="k">return</span> <span class="nb">true</span><span class="p">;</span>
    <span class="p">}</span>
    
    <span class="k">return</span> <span class="nb">false</span><span class="p">;</span>
<span class="p">}</span></code></pre></figure>

<hr class="space" />

<p><b>Detections table</b></p>

<table style="width:60%">
  <tr>
    <td colspan="2">Check if HDD Vendor ID is one of the following:</td>
  </tr>
  <tr>
    <th style="text-align:center">Detect</th>
    <th style="text-align:center">Name</th>
  </tr>
  <tr>
    <th>VirtualBox</th>
    <td>VBOX</td>
  </tr>
  <tr>
    <th>VMware</th>
    <td>vmware</td>
  </tr>
</table>

<p><br /></p>
<h3><a class="a-dummy" name="check-if-audio-device-is-absent">3. Check if audio device is absent</a></h3>

<p>This technique was extracted from TeslaCrypt malware sample and was described <a href="https://www.joesecurity.org/blog/6933341622592617830">in this Joe Security blog post</a>.</p>

<hr class="space" />

<p><b>Code sample</b></p>
<p></p>

<figure class="highlight"><pre><code class="language-c" data-lang="c"><span class="kt">void</span> <span class="nf">AudioEvasion</span><span class="p">()</span> <span class="p">{</span>
  <span class="n">PCWSTR</span> <span class="n">wszfilterName</span> <span class="o">=</span> <span class="s">L"audio_device_random_name"</span><span class="p">;</span>

  <span class="k">if</span> <span class="p">(</span><span class="n">FAILED</span><span class="p">(</span><span class="n">CoInitialize</span><span class="p">(</span><span class="nb">NULL</span><span class="p">)))</span>
    <span class="k">return</span><span class="p">;</span>

  <span class="n">IGraphBuilder</span> <span class="o">*</span><span class="n">pGraph</span> <span class="o">=</span> <span class="n">nullptr</span><span class="p">;</span>
  <span class="k">if</span> <span class="p">(</span><span class="n">FAILED</span><span class="p">(</span><span class="n">CoCreateInstance</span><span class="p">(</span><span class="n">CLSID_FilterGraph</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">,</span> <span class="n">CLSCTX_INPROC_SERVER</span><span class="p">,</span> <span class="n">IID_IGraphBuilder</span><span class="p">,</span> <span class="p">(</span><span class="kt">void</span><span class="o">**</span><span class="p">)</span><span class="o">&amp;</span><span class="n">pGraph</span><span class="p">)))</span>
    <span class="k">return</span><span class="p">;</span>

  <span class="k">if</span> <span class="p">(</span><span class="n">E_POINTER</span> <span class="o">!=</span> <span class="n">pGraph</span><span class="o">-&gt;</span><span class="n">AddFilter</span><span class="p">(</span><span class="nb">NULL</span><span class="p">,</span> <span class="n">wszfilterName</span><span class="p">))</span>
    <span class="n">ExitProcess</span><span class="p">(</span><span class="o">-</span><span class="mi">1</span><span class="p">);</span>

  <span class="n">IBaseFilter</span> <span class="o">*</span><span class="n">pBaseFilter</span> <span class="o">=</span> <span class="n">nullptr</span><span class="p">;</span>
  <span class="n">CoCreateInstance</span><span class="p">(</span><span class="n">CLSID_AudioRender</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">,</span> <span class="n">CLSCTX_INPROC_SERVER</span><span class="p">,</span> <span class="n">IID_IBaseFilter</span><span class="p">,</span> <span class="p">(</span><span class="kt">void</span><span class="o">**</span><span class="p">)</span><span class="o">&amp;</span><span class="n">pBaseFilter</span><span class="p">);</span>
  
  <span class="n">pGraph</span><span class="o">-&gt;</span><span class="n">AddFilter</span><span class="p">(</span><span class="n">pBaseFilter</span><span class="p">,</span> <span class="n">wszfilterName</span><span class="p">);</span>

  <span class="n">IBaseFilter</span> <span class="o">*</span><span class="n">pBaseFilter2</span> <span class="o">=</span> <span class="n">nullptr</span><span class="p">;</span>
  <span class="n">pGraph</span><span class="o">-&gt;</span><span class="n">FindFilterByName</span><span class="p">(</span><span class="n">wszfilterName</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">pBaseFilter2</span><span class="p">);</span>
  <span class="k">if</span> <span class="p">(</span><span class="n">nullptr</span> <span class="o">==</span> <span class="n">pBaseFilter2</span><span class="p">)</span>
    <span class="n">ExitProcess</span><span class="p">(</span><span class="mi">1</span><span class="p">);</span>

  <span class="n">FILTER_INFO</span> <span class="n">info</span> <span class="o">=</span> <span class="p">{</span> <span class="mi">0</span> <span class="p">};</span>
  <span class="n">pBaseFilter2</span><span class="o">-&gt;</span><span class="n">QueryFilterInfo</span><span class="p">(</span><span class="o">&amp;</span><span class="n">info</span><span class="p">);</span>
  <span class="k">if</span> <span class="p">(</span><span class="mi">0</span> <span class="o">!=</span> <span class="n">wcscmp</span><span class="p">(</span><span class="n">info</span><span class="p">.</span><span class="n">achName</span><span class="p">,</span> <span class="n">wszfilterName</span><span class="p">))</span>
    <span class="k">return</span><span class="p">;</span>

  <span class="n">IReferenceClock</span> <span class="o">*</span><span class="n">pClock</span> <span class="o">=</span> <span class="n">nullptr</span><span class="p">;</span>
  <span class="k">if</span> <span class="p">(</span><span class="mi">0</span> <span class="o">!=</span> <span class="n">pBaseFilter2</span><span class="o">-&gt;</span><span class="n">GetSyncSource</span><span class="p">(</span><span class="o">&amp;</span><span class="n">pClock</span><span class="p">))</span>
    <span class="k">return</span><span class="p">;</span>
  <span class="k">if</span> <span class="p">(</span><span class="mi">0</span> <span class="o">!=</span> <span class="n">pClock</span><span class="p">)</span>
    <span class="k">return</span><span class="p">;</span>

  <span class="n">CLSID</span> <span class="n">clsID</span> <span class="o">=</span> <span class="p">{</span> <span class="mi">0</span> <span class="p">};</span>
  <span class="n">pBaseFilter2</span><span class="o">-&gt;</span><span class="n">GetClassID</span><span class="p">(</span><span class="o">&amp;</span><span class="n">clsID</span><span class="p">);</span>
  <span class="k">if</span> <span class="p">(</span><span class="n">clsID</span><span class="p">.</span><span class="n">Data1</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span>
    <span class="n">ExitProcess</span><span class="p">(</span><span class="mi">1</span><span class="p">);</span>

  <span class="k">if</span> <span class="p">(</span><span class="n">nullptr</span> <span class="o">==</span> <span class="n">pBaseFilter2</span><span class="p">)</span>
    <span class="n">ExitProcess</span><span class="p">(</span><span class="o">-</span><span class="mi">1</span><span class="p">);</span>

  <span class="n">IEnumPins</span> <span class="o">*</span><span class="n">pEnum</span> <span class="o">=</span> <span class="n">nullptr</span><span class="p">;</span>
  <span class="k">if</span> <span class="p">(</span><span class="mi">0</span> <span class="o">!=</span> <span class="n">pBaseFilter2</span><span class="o">-&gt;</span><span class="n">EnumPins</span><span class="p">(</span><span class="o">&amp;</span><span class="n">pEnum</span><span class="p">))</span>
    <span class="n">ExitProcess</span><span class="p">(</span><span class="o">-</span><span class="mi">1</span><span class="p">);</span>

  <span class="k">if</span> <span class="p">(</span><span class="mi">0</span> <span class="o">==</span> <span class="n">pBaseFilter2</span><span class="o">-&gt;</span><span class="n">AddRef</span><span class="p">())</span>
    <span class="n">ExitProcess</span><span class="p">(</span><span class="o">-</span><span class="mi">1</span><span class="p">);</span>
<span class="p">}</span></code></pre></figure>

<p><br /></p>
<h3><a class="a-dummy" name="check-if-cpu-temperature-information-is-available">4. Check if CPU temperature information is available</a></h3>

<p>This technique was extracted from GravityRAT malware and is described <a href="https://blog.talosintelligence.com/2018/04/gravityrat-two-year-evolution-of-apt.html">by this link</a>.</p>

<hr class="space" />

<p><b>Code sample (Windows cmd command)</b></p>
<p></p>

<figure class="highlight"><pre><code class="language-cm" data-lang="cm">wmic /namespace:\\root\WMI path MSAcpi_ThermalZoneTemperature get CurrentTemperature</code></pre></figure>

<p><br /></p>
<h3><a class="a-dummy" name="check-directx-adapter">5. Check physical display adapter for IDirect3D9 interface</a></h3>

<p>This method checks physical display adapters present in the system when the IDirect3D9 interface was instantiated. It works on all Windows versions starting from Windows XP.</p>

<p>Functions used:</p>
<ul>
<li><tt>Direct3DCreate9</tt> - called from <font face="Courier New">`d3d9.dll`</font> library</li>
<li><tt>GetAdapterIdentifier</tt> - called via <font face="Courier New">IDirect3D9</font> interface</li> 
</ul>

<hr class="space" />

<p><b>Code sample</b></p>
<p></p>

<figure class="highlight"><pre><code class="language-c" data-lang="c"><span class="cp">#include</span> <span class="cpf">&lt;d3d9.h&gt;</span><span class="cp">
</span>
<span class="c1">// https://github.com/qt/qtbase/blob/dev/src/plugins/platforms/windows/qwindowsopengltester.cpp#L124</span>

<span class="kt">void</span> <span class="nf">detect</span><span class="p">()</span> <span class="p">{</span>
    <span class="k">typedef</span> <span class="n">IDirect3D9</span><span class="o">*</span> <span class="p">(</span><span class="n">WINAPI</span><span class="o">*</span> <span class="n">PtrDirect3DCreate9</span><span class="p">)(</span><span class="n">UINT</span><span class="p">);</span>

    <span class="n">HMODULE</span> <span class="n">d3d9lib</span> <span class="o">=</span> <span class="o">::</span><span class="n">LoadLibraryA</span><span class="p">(</span><span class="s">"d3d9"</span><span class="p">);</span>
    <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">d3d9lib</span><span class="p">)</span>
        <span class="k">return</span><span class="p">;</span>

    <span class="n">PtrDirect3DCreate9</span> <span class="n">direct3DCreate9</span> <span class="o">=</span> <span class="p">(</span><span class="n">PtrDirect3DCreate9</span><span class="p">)</span><span class="n">GetProcAddress</span><span class="p">(</span><span class="n">d3d9lib</span><span class="p">,</span> <span class="s">"Direct3DCreate9"</span><span class="p">);</span>
    <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">direct3DCreate9</span><span class="p">)</span>
        <span class="k">return</span><span class="p">;</span>

    <span class="n">IDirect3D9</span><span class="o">*</span> <span class="n">direct3D9</span> <span class="o">=</span> <span class="n">direct3DCreate9</span><span class="p">(</span><span class="n">D3D_SDK_VERSION</span><span class="p">);</span>
    <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">direct3D9</span><span class="p">)</span>
        <span class="k">return</span><span class="p">;</span>

    <span class="n">D3DADAPTER_IDENTIFIER9</span> <span class="n">adapterIdentifier</span><span class="p">;</span>
    <span class="k">const</span> <span class="n">HRESULT</span> <span class="n">hr</span> <span class="o">=</span> <span class="n">direct3D9</span><span class="o">-&gt;</span><span class="n">GetAdapterIdentifier</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">adapterIdentifier</span><span class="p">);</span>
    <span class="n">direct3D9</span><span class="o">-&gt;</span><span class="n">Release</span><span class="p">();</span>

    <span class="k">if</span> <span class="p">(</span><span class="n">SUCCEEDED</span><span class="p">(</span><span class="n">hr</span><span class="p">))</span> <span class="p">{</span>
        <span class="n">printf</span><span class="p">(</span><span class="s">"VendorId:    0x%x</span><span class="se">\n</span><span class="s">"</span><span class="p">,</span> <span class="n">adapterIdentifier</span><span class="p">.</span><span class="n">VendorId</span><span class="p">);</span>
        <span class="n">printf</span><span class="p">(</span><span class="s">"DeviceId:    0x%x</span><span class="se">\n</span><span class="s">"</span><span class="p">,</span> <span class="n">adapterIdentifier</span><span class="p">.</span><span class="n">DeviceId</span><span class="p">);</span>
        <span class="n">printf</span><span class="p">(</span><span class="s">"Driver:      %s</span><span class="se">\n</span><span class="s">"</span><span class="p">,</span> <span class="n">adapterIdentifier</span><span class="p">.</span><span class="n">Driver</span><span class="p">);</span>
        <span class="n">printf</span><span class="p">(</span><span class="s">"Description: %s</span><span class="se">\n</span><span class="s">"</span><span class="p">,</span> <span class="n">adapterIdentifier</span><span class="p">.</span><span class="n">Description</span><span class="p">);</span>
    <span class="p">}</span>
<span class="p">}</span></code></pre></figure>

<p><i>Credits for this code sample go to <a href="https://gist.github.com/elsamuko/d3049d52ca235112c99ac3ee30282846">elsamuko</a> who pointed it out</i>.</p>

<hr class="space" />

<p>Example of output on a usual host machine is provided below:</p>

<figure class="highlight"><pre><code class="language-cm" data-lang="cm">VendorId:    0x10de
DeviceId:    0x103c
Driver:      nvldumdx.dll
Description: NVIDIA Quadro K5200</code></pre></figure>

<p>And here is an example of output on a virtual machine (VMware):</p>

<figure class="highlight"><pre><code class="language-cm" data-lang="cm">VendorId:    0x15ad
DeviceId:    0x405
Driver:      vm3dum64_loader.dll
Description: VMware SVGA 3D</code></pre></figure>

<p>Examined fields are named after the corresponding fields of <font face="Courier New">D3DADAPTER_IDENTIFIER9</font> structure. Malware can compare values in these fields to the ones which are known to be present inside the virtual machine and if match is found, then it draws the conclusion that it’s run under virtual machine.</p>

<p><b>Detections table</b></p>

<table style="width:100%">
  <tr>
  	<td colspan="4">Check if the following values are present in the fields of D3DADAPTER_IDENTIFIER9 structure:</td>
  </tr>
  <tr>
  	<th style="text-align:center">Detect</th>
  	<th style="text-align:center">Structure field</th>
    <th style="text-align:center">Value</th>
    <th style="text-align:center">Comment</th>
  </tr>
  <tr>
  	<th rowspan="5">VMware</th>
  	<td>VendorId</td>
    <td>0x15AD</td>
    <td></td>
  </tr>
  <tr>
  	<td>DeviceId</td>
    <td>0x405</td>
    <td>Only when used in combination with VendorId related to VMware (0x15AD)</td>
  </tr>
  <tr>
  	<td>Driver</td>
    <td>vm3dum.dll</td>
    <td></td>
  </tr>
  <tr>
    <td>Driver</td>
  	<td>vm3dum64_loader.dll</td>
    <td></td>
  </tr>
  <tr>
    <td>Description</td>
  	<td>VMware SVGA 3D</td>
    <td></td>
  </tr>
</table>

<p><br /></p>
<h3><a class="a-dummy" name="signature-recommendations">Signature recommendations</a></h3>

<p><i>Signature recommendations are general for each technique: hook the function used and track if it is called. It’s pretty hard to tell why application wants to get HDD name, for example. It doesn’t necessarily mean applying evasion technique. So the best what can be done in this situation is intercepting target functions and tracking their calls.</i></p>

<p><br /></p>
<h3><a class="a-dummy" name="countermeasures-sandboxie">Countermeasures</a></h3>

<ul>
<li><tt>versus HDD checks:</tt> rename HDD so that it's not detected by specific strings;</li> 
<li><tt>versus audio device check:</tt> add audio device;</li> 
<li><tt>versus CPU temperature check:</tt> add stub to hypervisor to output some meaningful information;</li>
<li><tt>versus physical display adapter check:</tt> set up hook on a function <font face="Courier New">GetAdapterIdentifier</font> from <font face="Courier New">d3d9.dll</font>, check if the queried adapter is related to DirectX and replace return values.</li> 
</ul>


    <br>
    <div style="text-align: left">
        <a href="..">Go back</a>
    </div>
    <br>
    <div class="sharebuttons" style="text-align: center">
        <hr />
        <ul>
          <li>
            <p class="sharetitle"> Share this: </p>
          </li>
          <li class="reddit">
            <a href="http://www.reddit.com/submit?url=https://evasions.checkpoint.com/src/Evasions/techniques/hardware.html&title=Evasions:%20Hardware - Evasion Techniques" target="_blank">
                <svg xmlns="http://www.w3.org/2000/svg"
                aria-label="Reddit" role="img"
                viewBox="0 0 512 512"><rect
                width="512" height="512"
                rx="15%"
                fill="#f40"/><g fill="#fff"><ellipse cx="256" cy="307" rx="166" ry="117"/><circle cx="106" cy="256" r="42"/><circle cx="407" cy="256" r="42"/><circle cx="375" cy="114" r="32"/></g><g stroke-linecap="round" stroke-linejoin="round" fill="none"><path d="m256 196 23-101 73 15" stroke="#fff" stroke-width="16"/><path d="m191 359c33 25 97 26 130 0" stroke="#f40" stroke-width="13"/></g><g fill="#f40"><circle cx="191" cy="287" r="31"/><circle cx="321" cy="287" r="31"/></g></svg>
                
            </a>
          </li>
          <li class="hn">
            <a href="http://news.ycombinator.com/submitlink?u=https://evasions.checkpoint.com/src/Evasions/techniques/hardware.html&t=Evasions:%20Hardware - Evasion Techniques" target="_blank">
                <svg xmlns="http://www.w3.org/2000/svg"
                aria-label="Hacker News" role="img"
                viewBox="0 0 512 512"><rect
                width="512" height="512"
                rx="15%"
                fill="#f60"/><path fill="#fff" d="M124 91h51l81 162 81-164h51L276 293v136h-40V293z"/></svg>
            </a>
          </li>
          <li class="twitter">
            <a href="https://twitter.com/intent/tweet?via=_CPResearch_&url=https://evasions.checkpoint.com/src/Evasions/techniques/hardware.html&text=Evasions:%20Hardware - Evasion Techniques" target="_blank">
                <svg viewBox="0 0 1792 1792" xmlns="http://www.w3.org/2000/svg"><path d="M1684 408q-67 98-162 167 1 14 1 42 0 130-38 259.5t-115.5 248.5-184.5 210.5-258 146-323 54.5q-271 0-496-145 35 4 78 4 225 0 401-138-105-2-188-64.5t-114-159.5q33 5 61 5 43 0 85-11-112-23-185.5-111.5t-73.5-205.5v-4q68 38 146 41-66-44-105-115t-39-154q0-88 44-163 121 149 294.5 238.5t371.5 99.5q-8-38-8-74 0-134 94.5-228.5t228.5-94.5q140 0 236 102 109-21 205-78-37 115-142 178 93-10 186-50z"/></svg>
            </a>
          </li>
          <li class="linkedin">
            <a href=https://www.linkedin.com/shareArticle?mini=true&url=https://evasions.checkpoint.com/src/Evasions/techniques/hardware.html&title=Evasions:%20Hardware - Evasion Techniques&source=LinkedIn" target="_blank">
                <svg viewBox="0 0 1792 1792" xmlns="http://www.w3.org/2000/svg"><path d="M477 625v991h-330v-991h330zm21-306q1 73-50.5 122t-135.5 49h-2q-82 0-132-49t-50-122q0-74 51.5-122.5t134.5-48.5 133 48.5 51 122.5zm1166 729v568h-329v-530q0-105-40.5-164.5t-126.5-59.5q-63 0-105.5 34.5t-63.5 85.5q-11 30-11 81v553h-329q2-399 2-647t-1-296l-1-48h329v144h-2q20-32 41-56t56.5-52 87-43.5 114.5-15.5q171 0 275 113.5t104 332.5z"/></svg>
            </a>
          </li>
        </ul>
      </div>
      
</article>


</section>

<nav class="navbar navbar-default navbar-fixed-bottom">
  <div class="container footer-content">

    Made with <font class="a-pink"><i class ="fa fa-heart"></i></font> to serve the community by Check Point Research    |    <a class="a-pink" href="https://research.checkpoint.com">Research blog</a>    |    <a class="a-pink" href="https://research.checkpoint.com/about-us/">About Us</a>    |    <a class="a-pink" href="https://github.com/CheckPointSW"><i class="fa fa-github fa-lg"></i></a> <a class="a-pink" href="https://twitter.com/_CPResearch_"><i class="fa fa-twitter fa-lg"></i></a>
    
    <br>
    
    © 1994-2024 Check Point Software Technologies LTD | All rights reserved | Property of CheckPoint.com


  </div>
</nav>

  </body>

</html>
