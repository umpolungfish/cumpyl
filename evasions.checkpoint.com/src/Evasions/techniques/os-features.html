<!DOCTYPE html>
<html>

  <head>
  <meta charset="utf-8">
  <meta http-equiv="X-UA-Compatible" content="IE=edge">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-194688-3"></script>
  <script>
   window.dataLayer = window.dataLayer || [];
   function gtag(){dataLayer.push(arguments);}
   gtag('js', new Date());
   gtag('config', 'UA-194688-3');
  </script>
  <meta content="Evasion techniques" property="og:site_name">

  <meta content="Evasions: OS features" property="og:title">


  <meta name="twitter:title" content="Malware Evasion Encyclopedia" />
  <meta name="twitter:image" content="https://research.checkpoint.com/wp-content/uploads/2020/02/evasions.jpg" />


  <meta content="article" property="og:type">


  <meta content="Evasion techniques
" property="og:description">


  <meta content="https://evasions.checkpoint.com/src/Evasions/techniques/os-features.html" property="og:url">


  <meta content="2024-07-10T07:20:28+00:00" property="article:published_time">
  <meta content="https://evasions.checkpoint.com/about/" property="article:author">


  <meta property="og:image" content="">


  
  <meta content="evasions" property="article:section">
  


  
  <meta content="os-features" property="article:tag">
  

  <title>Evasions: OS features</title>
  <meta name="description" content="Contents">
<script src="https://ajax.googleapis.com/ajax/libs/jquery/2.2.2/jquery.min.js"></script>
<script src="https://maxcdn.bootstrapcdn.com/bootstrap/3.3.6/js/bootstrap.min.js" integrity="sha384-0mSbJDEHialfmuBBQP6A4Qrprq5OVfW37PRR3j5ELqxss1yVqOtnepnHVP9aJ7xS" crossorigin="anonymous"></script>
  <link rel="stylesheet" href="https://evasions.checkpoint.com/assets/css/main.css">
<script src="https://maxcdn.bootstrapcdn.com/bootstrap/3.3.6/js/bootstrap.min.js" integrity="sha384-0mSbJDEHialfmuBBQP6A4Qrprq5OVfW37PRR3j5ELqxss1yVqOtnepnHVP9aJ7xS" crossorigin="anonymous"></script>

  <link href='https://fonts.googleapis.com/css?family=PT+Sans' rel='stylesheet' type='text/css'>
  <link href='https://fonts.googleapis.com/css?family=Fira+Mono' rel='stylesheet' type='text/css'>
  <link href='https://fonts.googleapis.com/css?family=Lato:400,700' rel='stylesheet' type='text/css'>
  <link href='https://fonts.googleapis.com/css?family=Source+Code+Pro:400,200,300,500,600,700,900' rel='stylesheet' type='text/css'>
  <link href='https://fonts.googleapis.com/css?family=Gentium+Basic:400,700' rel='stylesheet' type='text/css'>
  <link href='https://fonts.googleapis.com/css?family=Alegreya:400,400italic,700' rel='stylesheet' type='text/css'>
  <link href='https://fonts.googleapis.com/css?family=Lora:400,400italic,700' rel='stylesheet' type='text/css'>
  <link href='https://fonts.googleapis.com/css?family=Fira+Sans:400,300,500,700' rel='stylesheet' type='text/css'>
  <script src="https://ajax.googleapis.com/ajax/libs/jquery/2.2.0/jquery.min.js"></script>
  <link href='https://fonts.googleapis.com/css?family=Open+Sans:400,700' rel='stylesheet' type='text/css'>
  <link href="https://maxcdn.bootstrapcdn.com/bootstrap/3.3.6/css/bootstrap.min.css" rel="stylesheet" integrity="sha384-1q8mTJOASx8j1Au+a5WDVnPi2lkFfwwEAa8hDDdjZlpLegxhjVME1fgjWPGmkzs7" crossorigin="anonymous">
  <link href="https://maxcdn.bootstrapcdn.com/font-awesome/4.6.1/css/font-awesome.min.css" rel="stylesheet" integrity="sha384-hQpvDQiCJaD2H465dQfA717v7lu5qHWtDbWNPvaTJ0ID5xnPUlVXnKzq7b8YUkbN" crossorigin="anonymous">
  <link rel="canonical" href="https://evasions.checkpoint.com/src/Evasions/techniques/os-features.html">
  <link rel="alternate" type="application/rss+xml" title="Evasion techniques" href="https://evasions.checkpoint.com/feed.xml">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/tinysort/2.3.6/tinysort.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/tinysort/2.3.6/tinysort.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/tinysort/2.3.6/tinysort.charorder.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/tinysort/2.3.6/tinysort.charorder.min.js"></script>
  <script type="text/javascript" async src="//platform.twitter.com/widgets.js"></script>




</head>


  <body>
<section>
<article class="post" itemscope itemtype="http://schema.org/BlogPosting">
  <div class="jumbotron">
    <div class="container">
      <h1 class="post-title-main" itemprop="name headline">Evasions: OS features</h1>
    </div>
</div>

  <div class="post-content container" itemprop="articleBody">
    <div style="text-align: left">
        <a href="..">Go back</a>
        <br>
        <br>
    </div>
    <h1>Contents</h1>

<p><a href="#os-features-detection-methods">OS features detection methods</a>
<br />
  <a href="#checking-debug-privileges">1. Checking debug privileges</a>
<br />
  <a href="#using-unbalanced-stack">2. Using unbalanced stack</a>
<br />
  <a href="#detect-wine">3. Detect Wine</a>
<br />
  <a href="#countermeasures">Countermeasures</a>
<br />
  <a href="#credits">Credits</a>
<br />
<br /></p>

<hr class="space" />

<h2><a class="a-dummy" name="os-features-detection-methods">OS features detection methods</a></h2>
<p>Evasions in this group use peculiarities of how OS work.</p>

<p><br /></p>
<h3><a class="a-dummy" name="checking-debug-privileges">1. Checking debug privileges</a></h3>
<p>If the malware is running under debugger or in a sandbox like Cuckoo its process token will have a debug privilege in the enabled state. It happens because this privilege is enabled in the parent process and inherited by the malware process.</p>

<hr class="space" />

<p>The malware tries to open crucial system processes like <tt>csrss.exe</tt>, <tt>smss.exe</tt>, <tt>lsass.exe</tt> with <tt>PROCESS_ALL_ACCESS</tt> access right and then tries to terminate them. This will fail in a normal case when the malware is executed from the explorer or command line because even an Administrator user can’t terminate those processes. But this will succeed if the process token has the debug privilege in the enabled state. Termination of crucial system process leads OS to crash into BSOD with an error <tt>0x000000F4</tt> so the emulation process will be aborted.</p>

<hr class="space" />

<p>Functions to get snapshot of running processes:</p>
<ul>
  <li><tt>CreateToolhelp32Snapshot</tt></li> 
  <li><tt>psapi.EnumProcesses (WinXP, Vista)</tt></li> 
  <li><tt>kernel32.EnumProcesses (Win7+)</tt></li> 
</ul>

<hr class="space" />

<p>Function used to open the process:</p>
<ul>
  <li><tt>OpenProcess(PROCESS_ALL_ACCESS, ..., pid)  // track for PIDs of 'csrss.exe', 'smss.exe', 'lsass.exe'</tt></li> 
</ul>

<hr class="space" />

<p><b>Code sample</b></p>
<p></p>

<figure class="highlight"><pre><code class="language-c" data-lang="c"><span class="cm">/*
If we're being debugged and the process has SeDebugPrivileges 
privileges then OpenProcess call will be successful.
This requires administrator privilege!
In Windows XP, Vista and 7, calling OpenProcess with 
PROCESS_ALL_ACCESS will fait even with SeDebugPrivilege enabled,
That's why I used PROCESS_QUERY_LIMITED_INFORMATION
*/</span>

<span class="n">DWORD</span> <span class="nf">GetCsrssProcessId</span><span class="p">()</span>
<span class="p">{</span>
  <span class="k">if</span> <span class="p">(</span><span class="n">API</span><span class="o">::</span><span class="n">IsAvailable</span><span class="p">(</span><span class="n">API_IDENTIFIER</span><span class="o">::</span><span class="n">API_CsrGetProcessId</span><span class="p">))</span>
  <span class="p">{</span>
    <span class="k">auto</span> <span class="n">CsrGetProcessId</span> <span class="o">=</span> <span class="n">static_cast</span><span class="o">&lt;</span><span class="n">pCsrGetId</span><span class="o">&gt;</span><span class="p">(</span><span class="n">API</span><span class="o">::</span><span class="n">GetAPI</span><span class="p">(</span><span class="n">API_IDENTIFIER</span><span class="o">::</span><span class="n">API_CsrGetProcessId</span><span class="p">));</span>

    <span class="k">return</span> <span class="n">CsrGetProcessId</span><span class="p">();</span>
  <span class="p">}</span>
  <span class="k">else</span>
    <span class="k">return</span> <span class="n">GetProcessIdFromName</span><span class="p">(</span><span class="n">_T</span><span class="p">(</span><span class="s">"csrss.exe"</span><span class="p">));</span>
<span class="p">}</span>


<span class="n">BOOL</span> <span class="nf">CanOpenCsrss</span><span class="p">()</span>
<span class="p">{</span>
   <span class="n">HANDLE</span> <span class="n">hCsrss</span> <span class="o">=</span> <span class="n">OpenProcess</span><span class="p">(</span><span class="n">PROCESS_QUERY_LIMITED_INFORMATION</span><span class="p">,</span> <span class="n">FALSE</span><span class="p">,</span> <span class="n">GetCsrssProcessId</span><span class="p">());</span>
   <span class="k">if</span> <span class="p">(</span><span class="n">hCsrss</span> <span class="o">!=</span> <span class="nb">NULL</span><span class="p">)</span>
  <span class="p">{</span>
    <span class="n">CloseHandle</span><span class="p">(</span><span class="n">hCsrss</span><span class="p">);</span>
    <span class="k">return</span> <span class="n">TRUE</span><span class="p">;</span>
  <span class="p">}</span>
  <span class="k">else</span>
    <span class="k">return</span> <span class="n">FALSE</span><span class="p">;</span>
<span class="p">}</span></code></pre></figure>

<p><i>Credits for this code sample: <a href="https://github.com/LordNoteworthy/al-khaser">al-khaser project</a></i></p>

<hr class="space" />

<p><b>Signature recommendations</b></p>
<p></p>
<p>If <tt>OpenProcess</tt> requests all the possible rights when opening one of the critical system processes — it’s a strong indicator of malware trying to apply this evasion technique.</p>

<p><br /></p>
<h3><a class="a-dummy" name="using-unbalanced-stack">2. Using unbalanced stack</a></h3>
<p>This technique was presented at Virus Bulletin 2016 by Check Point Malware Reverse Engineering Team. It is described <a href="https://www.virusbulletin.com/uploads/pdf/magazine/2016/VB2016-Chailytko-Skuratovich.pdf">by this link</a>.</p>

<hr class="space" />

<p>To track process behaviour, the CuckooMon/Cuckoo Monitor module hooks relevant functions. In this type of architecture, the hook is called before the original function. A hooked function may use some space on the stack in addition to that used by the original function. Therefore, the total space on the stack used by the hooked function may be larger than the space used only by the original function.</p>

<hr class="space" />

<p><b>Problem:</b> The malware has information about how much space the called function uses on the stack. It can therefore move the stack pointer towards lower addresses at an offset that is sufficient to store the function arguments, local variables and return address to reserve space for them. The malware fills the space below the stack pointer with some relevant data. It then moves the stack pointer to the original location and calls the library function. If the function is not hooked, the malware fills in the reserved space before the relevant data (see Figure 1). If the function is hooked, the malware overlaps relevant data, because the space that was reserved for the original function’s local variables is smaller than the space occupied by the hook and the original function’s local variables combined. The relevant data is therefore corrupted (see Figure 2). If it stores pointers to some functions that are used later during the execution process, the malware jumps to arbitrary code, occasionally crashing the application.</p>

<hr class="space" />

<div style="text-align: center; margin: auto">
  <img src="../assets/images/unbalanced_stack_unhook.png" height="300px" />
  <img src="../assets/images/unbalanced_stack_hook.png" height="300px" /><br />
  <i>Stack on non-hooked and on hooked function call.</i>
</div>

<hr class="space" />

<p><b>Solution:</b> To avoid this behaviour, the Cuckoo Monitor/CuckooMon module can use a two-stage hooking process. In the fi rst stage, instead of the hook’s code execution, it can move the stack pointer towards lower addresses of a specifi c size that will be enough for the malware’s relevant data. Then, the function’s arguments are copied under the new stack pointer. Only after these preparatory operations have been completed is the second stage hook (which performs the real hooking) called. Relevant data fi lled in by the malware resides on upper stack addresses, thus it is not affected in any way by the called function.</p>

<hr class="space" />

<p><b>Code sample</b></p>
<p></p>

<figure class="highlight"><pre><code class="language-c" data-lang="c"><span class="n">bool</span> <span class="n">Cuckoo</span><span class="o">::</span><span class="n">CheckUnbalancedStack</span><span class="p">()</span> <span class="k">const</span> <span class="p">{</span>
  <span class="n">usf_t</span> <span class="n">f</span> <span class="o">=</span> <span class="p">{</span>
    <span class="p">{</span> <span class="n">lib_name_t</span><span class="p">(</span><span class="s">L"ntdll"</span><span class="p">),</span> <span class="p">{</span> 
      <span class="p">{</span><span class="k">sizeof</span><span class="p">(</span><span class="kt">void</span> <span class="o">*</span><span class="p">),</span> <span class="nb">NULL</span><span class="p">,</span> <span class="s">"ZwDelayExecution"</span><span class="p">,</span> <span class="n">ARG_ITEM</span><span class="p">(</span><span class="n">kZwDelayExecutionArgs</span><span class="p">)</span> <span class="p">}</span>
    <span class="p">}</span> <span class="p">}</span>
  <span class="p">};</span>
  <span class="k">const</span> <span class="kt">uint8_t</span> <span class="n">canary</span><span class="p">[</span><span class="mi">8</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span> <span class="mh">0xDE</span><span class="p">,</span> <span class="mh">0xAD</span><span class="p">,</span> <span class="mh">0xBE</span><span class="p">,</span> <span class="mh">0xEF</span><span class="p">,</span> <span class="mh">0xDE</span><span class="p">,</span> <span class="mh">0xAD</span><span class="p">,</span> <span class="mh">0xBE</span><span class="p">,</span> <span class="mh">0xEF</span> <span class="p">};</span>

  <span class="kt">uint32_t</span> <span class="n">args_size</span><span class="p">;</span>
  <span class="k">const</span> <span class="kt">void</span> <span class="o">*</span><span class="n">args_buff</span><span class="p">;</span>
  <span class="kt">uint32_t</span> <span class="n">reserved_size</span><span class="p">;</span>
  <span class="kt">uint32_t</span> <span class="n">reserved_size_after_call</span><span class="p">;</span>
  <span class="kt">uint32_t</span> <span class="n">canary_size</span><span class="p">;</span>
  <span class="n">FARPROC</span> <span class="n">func</span><span class="p">;</span>
  <span class="n">bool</span> <span class="n">us_detected</span><span class="p">;</span>
  <span class="kt">void</span> <span class="o">*</span><span class="n">canary_addr</span> <span class="o">=</span> <span class="p">(</span><span class="kt">void</span> <span class="o">*</span><span class="p">)</span><span class="o">&amp;</span><span class="n">canary</span><span class="p">[</span><span class="mi">0</span><span class="p">];</span>
  
  <span class="n">static_assert</span><span class="p">((</span><span class="k">sizeof</span><span class="p">(</span><span class="n">canary</span><span class="p">)</span> <span class="o">%</span> <span class="k">sizeof</span><span class="p">(</span><span class="kt">void</span> <span class="o">*</span><span class="p">))</span> <span class="o">==</span> <span class="mi">0</span><span class="p">,</span> <span class="s">"Invalid canary alignement"</span><span class="p">);</span>
  
  <span class="k">for</span> <span class="p">(</span><span class="k">auto</span> <span class="n">it</span> <span class="o">=</span> <span class="n">f</span><span class="p">.</span><span class="n">begin</span><span class="p">(),</span> <span class="n">end</span> <span class="o">=</span> <span class="n">f</span><span class="p">.</span><span class="n">end</span><span class="p">();</span> <span class="n">it</span> <span class="o">!=</span> <span class="n">end</span><span class="p">;</span> <span class="o">++</span><span class="n">it</span><span class="p">)</span> <span class="p">{</span>
    <span class="k">for</span> <span class="p">(</span><span class="k">auto</span> <span class="o">&amp;</span><span class="n">vi</span> <span class="o">:</span> <span class="n">it</span><span class="o">-&gt;</span><span class="n">second</span><span class="p">)</span> <span class="p">{</span>
      <span class="n">vi</span><span class="p">.</span><span class="n">func_addr</span> <span class="o">=</span> <span class="n">GetProcAddress</span><span class="p">(</span><span class="n">GetModuleHandleW</span><span class="p">(</span><span class="n">it</span><span class="o">-&gt;</span><span class="n">first</span><span class="p">.</span><span class="n">c_str</span><span class="p">()),</span> <span class="n">vi</span><span class="p">.</span><span class="n">func_name</span><span class="p">.</span><span class="n">c_str</span><span class="p">());</span>

      <span class="c1">// call to Unbalanced Stack</span>
      <span class="n">args_size</span> <span class="o">=</span> <span class="n">vi</span><span class="p">.</span><span class="n">args_size</span><span class="p">;</span>
      <span class="n">args_buff</span> <span class="o">=</span> <span class="n">vi</span><span class="p">.</span><span class="n">args_buff</span><span class="p">;</span>
      <span class="n">canary_size</span> <span class="o">=</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">canary</span><span class="p">);</span>
      <span class="n">reserved_size</span> <span class="o">=</span> <span class="k">sizeof</span><span class="p">(</span><span class="kt">void</span> <span class="o">*</span><span class="p">)</span> <span class="o">+</span> <span class="n">vi</span><span class="p">.</span><span class="n">local_vars_size</span> <span class="o">+</span> <span class="n">canary_size</span><span class="p">;</span>
      <span class="n">reserved_size_after_call</span> <span class="o">=</span> <span class="n">reserved_size</span> <span class="o">+</span> <span class="n">args_size</span><span class="p">;</span>
      <span class="n">func</span> <span class="o">=</span> <span class="n">vi</span><span class="p">.</span><span class="n">func_addr</span><span class="p">;</span>
      <span class="n">us_detected</span> <span class="o">=</span> <span class="nb">false</span><span class="p">;</span>

      <span class="kr">__asm</span> <span class="p">{</span>
        <span class="n">pusha</span>
        <span class="n">mov</span> <span class="n">ecx</span><span class="p">,</span> <span class="n">args_size</span>
        <span class="n">sub</span> <span class="n">esp</span><span class="p">,</span> <span class="n">ecx</span>
        <span class="n">mov</span> <span class="n">esi</span><span class="p">,</span> <span class="n">args_buff</span>
        <span class="n">mov</span> <span class="n">edi</span><span class="p">,</span> <span class="n">esp</span>
        <span class="n">cld</span>
        <span class="n">rep</span> <span class="n">movsb</span>
        <span class="n">sub</span> <span class="n">esp</span><span class="p">,</span> <span class="n">reserved_size</span>
        <span class="n">mov</span> <span class="n">ecx</span><span class="p">,</span> <span class="n">canary_size</span>
        <span class="n">mov</span> <span class="n">esi</span><span class="p">,</span> <span class="n">canary_addr</span>
        <span class="n">mov</span> <span class="n">edi</span><span class="p">,</span> <span class="n">esp</span>
        <span class="n">rep</span> <span class="n">movsb</span>
        <span class="n">add</span> <span class="n">esp</span><span class="p">,</span> <span class="n">reserved_size</span>
        <span class="n">mov</span> <span class="n">eax</span><span class="p">,</span> <span class="n">func</span>
        <span class="n">call</span> <span class="n">eax</span>
        <span class="n">sub</span> <span class="n">esp</span><span class="p">,</span> <span class="n">reserved_size_after_call</span>
        <span class="n">mov</span> <span class="n">ecx</span><span class="p">,</span> <span class="n">canary_size</span>
        <span class="n">mov</span> <span class="n">esi</span><span class="p">,</span> <span class="n">canary_addr</span>
        <span class="n">mov</span> <span class="n">edi</span><span class="p">,</span> <span class="n">esp</span>
        <span class="n">repz</span> <span class="n">cmpsb</span>
        <span class="n">cmp</span> <span class="n">ecx</span><span class="p">,</span> <span class="mi">0</span>
        <span class="n">setnz</span> <span class="n">us_detected</span>
        <span class="n">add</span> <span class="n">esp</span><span class="p">,</span> <span class="n">reserved_size_after_call</span>
        <span class="n">popa</span>
      <span class="p">}</span>

      <span class="k">if</span> <span class="p">(</span><span class="n">us_detected</span><span class="p">)</span>
        <span class="k">return</span> <span class="nb">true</span><span class="p">;</span>
    <span class="p">}</span>
  <span class="p">}</span>

  <span class="k">return</span> <span class="nb">false</span><span class="p">;</span>  
<span class="p">}</span></code></pre></figure>

<hr class="space" />

<p><b>Signature recommendations</b></p>
<p></p>
<p>Signature recommendations are not provided as it’s pretty tricky to track such a behavior on malware side.</p>

<p><br /></p>

<h3><a class="a-dummy" name="detect-wine">3. Detect Wine</a></h3>

<hr class="space" />

<p>The <tt>MulDiv</tt> <a href="https://learn.microsoft.com/en-us/windows/win32/api/winbase/nf-winbase-muldiv">API</a> is being called with specific arguments (<tt><code class="language-plaintext highlighter-rouge">MulDiv(1, 0x80000000, 0x80000000)</code></tt>) which should logically return 1 - however, due to a bug with the ancient implementation on Windows, it returns 2.</p>

<p>There are more known evasion methods to detect Wine like the good old check of searching for the existence of one of Wine’s exclusive APIs such as <tt><code class="language-plaintext highlighter-rouge">kernel32.dll!wine_get_unix_file_name</code></tt> or <tt><code class="language-plaintext highlighter-rouge">ntdll.dll!wine_get_host_version</code></tt>) as also mentioned in <a href="https://evasions.checkpoint.com/src/Evasions/techniques/processes.html#check-if-specific-functions-are-present-in-specific-libraries ">Processes evasion techniques</a>.</p>

<p><b>Code sample</b></p>
<p></p>

<hr class="space" />

<figure class="highlight"><pre><code class="language-c" data-lang="c"><span class="kt">int</span> <span class="nf">Check_MulDiv_1</span><span class="p">()</span> <span class="p">{</span>
    <span class="c1">// Call MulDiv with specific arguments</span>
    <span class="kt">int</span> <span class="n">result</span> <span class="o">=</span> <span class="n">MulDiv</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="mh">0x80000000</span><span class="p">,</span> <span class="mh">0x80000000</span><span class="p">);</span>

    <span class="c1">// Check if the result matches the expected value</span>
    <span class="k">if</span> <span class="p">(</span><span class="n">result</span> <span class="o">!=</span> <span class="mi">2</span><span class="p">)</span> <span class="p">{</span>
        <span class="n">std</span><span class="o">::</span><span class="n">cout</span> <span class="o">&lt;&lt;</span> <span class="s">"MulDiv evasion method detected: Wine environment."</span> <span class="o">&lt;&lt;</span> <span class="n">std</span><span class="o">::</span><span class="n">endl</span><span class="p">;</span>
    <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
        <span class="n">std</span><span class="o">::</span><span class="n">cout</span> <span class="o">&lt;&lt;</span> <span class="s">"MulDiv evasion method not detected."</span> <span class="o">&lt;&lt;</span> <span class="n">std</span><span class="o">::</span><span class="n">endl</span><span class="p">;</span>
    <span class="p">}</span>
	
    <span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="kt">int</span> <span class="nf">Check_MulDiv_2</span><span class="p">()</span> <span class="p">{</span>
    <span class="c1">// Check for the existence of Wine's exclusive APIs</span>
    <span class="n">HMODULE</span> <span class="n">hKernel32</span> <span class="o">=</span> <span class="n">GetModuleHandle</span><span class="p">(</span><span class="s">"kernel32.dll"</span><span class="p">);</span>
    <span class="n">FARPROC</span> <span class="n">wineGetUnixFileName</span> <span class="o">=</span> <span class="n">GetProcAddress</span><span class="p">(</span><span class="n">hKernel32</span><span class="p">,</span> <span class="s">"wine_get_unix_file_name"</span><span class="p">);</span>
    <span class="n">HMODULE</span> <span class="n">hNtdll</span> <span class="o">=</span> <span class="n">GetModuleHandle</span><span class="p">(</span><span class="s">"ntdll.dll"</span><span class="p">);</span>
    <span class="n">FARPROC</span> <span class="n">wineGetHostVersion</span> <span class="o">=</span> <span class="n">GetProcAddress</span><span class="p">(</span><span class="n">hNtdll</span><span class="p">,</span> <span class="s">"wine_get_host_version"</span><span class="p">);</span>

    <span class="k">if</span> <span class="p">(</span><span class="n">wineGetUnixFileName</span> <span class="o">||</span> <span class="n">wineGetHostVersion</span><span class="p">)</span> <span class="p">{</span>
        <span class="n">std</span><span class="o">::</span><span class="n">cout</span> <span class="o">&lt;&lt;</span> <span class="s">"Wine's exclusive APIs detected: Wine environment."</span> <span class="o">&lt;&lt;</span> <span class="n">std</span><span class="o">::</span><span class="n">endl</span><span class="p">;</span>
    <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
        <span class="n">std</span><span class="o">::</span><span class="n">cout</span> <span class="o">&lt;&lt;</span> <span class="s">"Wine's exclusive APIs not detected."</span> <span class="o">&lt;&lt;</span> <span class="n">std</span><span class="o">::</span><span class="n">endl</span><span class="p">;</span>
    <span class="p">}</span>

    <span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span></code></pre></figure>

<hr class="space" />

<p><b>Signature recommendations</b></p>
<p></p>
<p>Check if <tt><code class="language-plaintext highlighter-rouge">MulDiv(1, 0x80000000, 0x80000000)</code></tt> is being called.</p>

<p><br /></p>
<h3><a class="a-dummy" name="countermeasures">Countermeasures</a></h3>

<ul>
<li><tt>versus checking debug privileges:</tt> hook <tt>OpenProcess</tt> and track for critical system processes PIDs — then return an error.</li> 
<li><tt>versus using unbalanced stack:</tt> 1) stack adjusting before function call; 2) kernel-mode hooking.</li> 
<li><tt>versus Detect Wine:</tt> If Using Wine, hook MulDiv to return 2 or modify the implementation as it works in Windows. </li> 
</ul>

<p><br /></p>
<h3><a class="a-dummy" name="credits">Credits</a></h3>

<p>Credits go to open-source project from where code samples were taken:</p>
<ul>
<li>al-khaser project on <a href="https://github.com/LordNoteworthy/al-khaser">github</a></li>
</ul>

<p>Though Check Point tool InviZzzible has them all implemented, due to modular structure of the code it would require more space to show a code sample from this tool for the same purposes. That’s why we’ve decided to use other great open-source projects for examples throughout the encyclopedia.</p>

    <br>
    <div style="text-align: left">
        <a href="..">Go back</a>
    </div>
    <br>
    <div class="sharebuttons" style="text-align: center">
        <hr />
        <ul>
          <li>
            <p class="sharetitle"> Share this: </p>
          </li>
          <li class="reddit">
            <a href="http://www.reddit.com/submit?url=https://evasions.checkpoint.com/src/Evasions/techniques/os-features.html&title=Evasions:%20OS%20features - Evasion Techniques" target="_blank">
                <svg xmlns="http://www.w3.org/2000/svg"
                aria-label="Reddit" role="img"
                viewBox="0 0 512 512"><rect
                width="512" height="512"
                rx="15%"
                fill="#f40"/><g fill="#fff"><ellipse cx="256" cy="307" rx="166" ry="117"/><circle cx="106" cy="256" r="42"/><circle cx="407" cy="256" r="42"/><circle cx="375" cy="114" r="32"/></g><g stroke-linecap="round" stroke-linejoin="round" fill="none"><path d="m256 196 23-101 73 15" stroke="#fff" stroke-width="16"/><path d="m191 359c33 25 97 26 130 0" stroke="#f40" stroke-width="13"/></g><g fill="#f40"><circle cx="191" cy="287" r="31"/><circle cx="321" cy="287" r="31"/></g></svg>
                
            </a>
          </li>
          <li class="hn">
            <a href="http://news.ycombinator.com/submitlink?u=https://evasions.checkpoint.com/src/Evasions/techniques/os-features.html&t=Evasions:%20OS%20features - Evasion Techniques" target="_blank">
                <svg xmlns="http://www.w3.org/2000/svg"
                aria-label="Hacker News" role="img"
                viewBox="0 0 512 512"><rect
                width="512" height="512"
                rx="15%"
                fill="#f60"/><path fill="#fff" d="M124 91h51l81 162 81-164h51L276 293v136h-40V293z"/></svg>
            </a>
          </li>
          <li class="twitter">
            <a href="https://twitter.com/intent/tweet?via=_CPResearch_&url=https://evasions.checkpoint.com/src/Evasions/techniques/os-features.html&text=Evasions:%20OS%20features - Evasion Techniques" target="_blank">
                <svg viewBox="0 0 1792 1792" xmlns="http://www.w3.org/2000/svg"><path d="M1684 408q-67 98-162 167 1 14 1 42 0 130-38 259.5t-115.5 248.5-184.5 210.5-258 146-323 54.5q-271 0-496-145 35 4 78 4 225 0 401-138-105-2-188-64.5t-114-159.5q33 5 61 5 43 0 85-11-112-23-185.5-111.5t-73.5-205.5v-4q68 38 146 41-66-44-105-115t-39-154q0-88 44-163 121 149 294.5 238.5t371.5 99.5q-8-38-8-74 0-134 94.5-228.5t228.5-94.5q140 0 236 102 109-21 205-78-37 115-142 178 93-10 186-50z"/></svg>
            </a>
          </li>
          <li class="linkedin">
            <a href=https://www.linkedin.com/shareArticle?mini=true&url=https://evasions.checkpoint.com/src/Evasions/techniques/os-features.html&title=Evasions:%20OS%20features - Evasion Techniques&source=LinkedIn" target="_blank">
                <svg viewBox="0 0 1792 1792" xmlns="http://www.w3.org/2000/svg"><path d="M477 625v991h-330v-991h330zm21-306q1 73-50.5 122t-135.5 49h-2q-82 0-132-49t-50-122q0-74 51.5-122.5t134.5-48.5 133 48.5 51 122.5zm1166 729v568h-329v-530q0-105-40.5-164.5t-126.5-59.5q-63 0-105.5 34.5t-63.5 85.5q-11 30-11 81v553h-329q2-399 2-647t-1-296l-1-48h329v144h-2q20-32 41-56t56.5-52 87-43.5 114.5-15.5q171 0 275 113.5t104 332.5z"/></svg>
            </a>
          </li>
        </ul>
      </div>
      
</article>


</section>

<nav class="navbar navbar-default navbar-fixed-bottom">
  <div class="container footer-content">

    Made with <font class="a-pink"><i class ="fa fa-heart"></i></font> to serve the community by Check Point Research    |    <a class="a-pink" href="https://research.checkpoint.com">Research blog</a>    |    <a class="a-pink" href="https://research.checkpoint.com/about-us/">About Us</a>    |    <a class="a-pink" href="https://github.com/CheckPointSW"><i class="fa fa-github fa-lg"></i></a> <a class="a-pink" href="https://twitter.com/_CPResearch_"><i class="fa fa-twitter fa-lg"></i></a>
    
    <br>
    
    © 1994-2024 Check Point Software Technologies LTD | All rights reserved | Property of CheckPoint.com


  </div>
</nav>

  </body>

</html>
