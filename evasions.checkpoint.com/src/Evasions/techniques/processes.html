<!DOCTYPE html>
<html>

  <head>
  <meta charset="utf-8">
  <meta http-equiv="X-UA-Compatible" content="IE=edge">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-194688-3"></script>
  <script>
   window.dataLayer = window.dataLayer || [];
   function gtag(){dataLayer.push(arguments);}
   gtag('js', new Date());
   gtag('config', 'UA-194688-3');
  </script>
  <meta content="Evasion techniques" property="og:site_name">

  <meta content="Evasions: Processes" property="og:title">


  <meta name="twitter:title" content="Malware Evasion Encyclopedia" />
  <meta name="twitter:image" content="https://research.checkpoint.com/wp-content/uploads/2020/02/evasions.jpg" />


  <meta content="article" property="og:type">


  <meta content="Evasion techniques
" property="og:description">


  <meta content="https://evasions.checkpoint.com/src/Evasions/techniques/processes.html" property="og:url">


  <meta content="2024-07-10T07:20:28+00:00" property="article:published_time">
  <meta content="https://evasions.checkpoint.com/about/" property="article:author">


  <meta property="og:image" content="">


  
  <meta content="evasions" property="article:section">
  


  
  <meta content="processes" property="article:tag">
  

  <title>Evasions: Processes</title>
  <meta name="description" content="Contents">
<script src="https://ajax.googleapis.com/ajax/libs/jquery/2.2.2/jquery.min.js"></script>
<script src="https://maxcdn.bootstrapcdn.com/bootstrap/3.3.6/js/bootstrap.min.js" integrity="sha384-0mSbJDEHialfmuBBQP6A4Qrprq5OVfW37PRR3j5ELqxss1yVqOtnepnHVP9aJ7xS" crossorigin="anonymous"></script>
  <link rel="stylesheet" href="https://evasions.checkpoint.com/assets/css/main.css">
<script src="https://maxcdn.bootstrapcdn.com/bootstrap/3.3.6/js/bootstrap.min.js" integrity="sha384-0mSbJDEHialfmuBBQP6A4Qrprq5OVfW37PRR3j5ELqxss1yVqOtnepnHVP9aJ7xS" crossorigin="anonymous"></script>

  <link href='https://fonts.googleapis.com/css?family=PT+Sans' rel='stylesheet' type='text/css'>
  <link href='https://fonts.googleapis.com/css?family=Fira+Mono' rel='stylesheet' type='text/css'>
  <link href='https://fonts.googleapis.com/css?family=Lato:400,700' rel='stylesheet' type='text/css'>
  <link href='https://fonts.googleapis.com/css?family=Source+Code+Pro:400,200,300,500,600,700,900' rel='stylesheet' type='text/css'>
  <link href='https://fonts.googleapis.com/css?family=Gentium+Basic:400,700' rel='stylesheet' type='text/css'>
  <link href='https://fonts.googleapis.com/css?family=Alegreya:400,400italic,700' rel='stylesheet' type='text/css'>
  <link href='https://fonts.googleapis.com/css?family=Lora:400,400italic,700' rel='stylesheet' type='text/css'>
  <link href='https://fonts.googleapis.com/css?family=Fira+Sans:400,300,500,700' rel='stylesheet' type='text/css'>
  <script src="https://ajax.googleapis.com/ajax/libs/jquery/2.2.0/jquery.min.js"></script>
  <link href='https://fonts.googleapis.com/css?family=Open+Sans:400,700' rel='stylesheet' type='text/css'>
  <link href="https://maxcdn.bootstrapcdn.com/bootstrap/3.3.6/css/bootstrap.min.css" rel="stylesheet" integrity="sha384-1q8mTJOASx8j1Au+a5WDVnPi2lkFfwwEAa8hDDdjZlpLegxhjVME1fgjWPGmkzs7" crossorigin="anonymous">
  <link href="https://maxcdn.bootstrapcdn.com/font-awesome/4.6.1/css/font-awesome.min.css" rel="stylesheet" integrity="sha384-hQpvDQiCJaD2H465dQfA717v7lu5qHWtDbWNPvaTJ0ID5xnPUlVXnKzq7b8YUkbN" crossorigin="anonymous">
  <link rel="canonical" href="https://evasions.checkpoint.com/src/Evasions/techniques/processes.html">
  <link rel="alternate" type="application/rss+xml" title="Evasion techniques" href="https://evasions.checkpoint.com/feed.xml">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/tinysort/2.3.6/tinysort.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/tinysort/2.3.6/tinysort.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/tinysort/2.3.6/tinysort.charorder.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/tinysort/2.3.6/tinysort.charorder.min.js"></script>
  <script type="text/javascript" async src="//platform.twitter.com/widgets.js"></script>




</head>


  <body>
<section>
<article class="post" itemscope itemtype="http://schema.org/BlogPosting">
  <div class="jumbotron">
    <div class="container">
      <h1 class="post-title-main" itemprop="name headline">Evasions: Processes</h1>
    </div>
</div>

  <div class="post-content container" itemprop="articleBody">
    <div style="text-align: left">
        <a href="..">Go back</a>
        <br>
        <br>
    </div>
    <h1>Contents</h1>

<p><a href="#process-detection-methods">Processes and libraries detection methods</a>
<br />
  <a href="#check-specific-running-processes-and-loaded-libraries">1. Check specific running processes and loaded libraries</a>
<br />
  <a href="#check-if-specific-processes-are-running">1.1. Check if specific processes are running</a>
<br />
  <a href="#check-if-specific-libraries-are-loaded">1.2. Check if specific libraries are loaded in the process address space</a>
<br />
  <a href="#check-if-specific-functions-are-present-in-specific-libraries">1.3. Check if specific functions are present in specific libraries</a>
<br />
  <a href="#check-if-certain-libraries-can-be-loaded-and-others-not">1.4. Check if certain libraries can be loaded and others not</a>
<br />
  <a href="#countermeasures">1.5. Countermeasures</a>
<br />
  <a href="#check-if-specific-artifacts-are-present-in-process">2. Check if specific artifacts are present in process address space (Sandboxie only)</a>
<br />
  <a href="#countermeasures-sandboxie">2.1. Countermeasures</a>
<br />
  <a href="#credits">Credits</a>
<br />
<br /></p>

<h2><a class="a-dummy" name="process-detection-methods">Processes and libraries detection methods</a></h2>
<p>Virtual environment launches some specific helper processes which are not being executed in usual host OS. There are also some specific modules which are loaded into processes address spaces.</p>

<p><br /></p>
<h3><a class="a-dummy" name="check-specific-running-processes-and-loaded-libraries">1. Check specific running processes and loaded libraries</a></h3>

<p><br /></p>
<h4><a class="a-dummy" name="check-if-specific-processes-are-running">1.1. Check if specific processes are running</a></h4>

<p>Functions used:</p>
<ul>
  <li><tt>CreateToolhelp32Snapshot</tt></li> 
  <li><tt>psapi.EnumProcesses <i>(WinXP, Vista)</i></tt></li> 
  <li><tt>kernel32.EnumProcesses <i>(Win7+)</i></tt></li> 
</ul>

<hr class="space" />

<p><b>Code sample</b></p>
<p></p>

<figure class="highlight"><pre><code class="language-c" data-lang="c"><span class="n">check_process_is_running</span><span class="p">(</span><span class="s">"vmtoolsd.exe"</span><span class="p">);</span>  <span class="c1">// sample value from the table</span>

<span class="n">bool</span> <span class="nf">check_process_is_running</span><span class="p">(</span><span class="k">const</span> <span class="n">std</span><span class="o">::</span><span class="n">string</span> <span class="o">&amp;</span><span class="n">proc_name</span><span class="p">)</span> <span class="p">{</span>
    <span class="n">HANDLE</span> <span class="n">hSnapshot</span><span class="p">;</span>
    <span class="n">PROCESSENTRY32</span> <span class="n">pe</span> <span class="o">=</span> <span class="p">{};</span>

    <span class="n">pe</span><span class="p">.</span><span class="n">dwSize</span> <span class="o">=</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">pe</span><span class="p">);</span>
    <span class="n">bool</span> <span class="n">present</span> <span class="o">=</span> <span class="nb">false</span><span class="p">;</span>
    <span class="n">hSnapshot</span> <span class="o">=</span> <span class="n">CreateToolhelp32Snapshot</span><span class="p">(</span><span class="n">TH32CS_SNAPPROCESS</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>

    <span class="k">if</span> <span class="p">(</span><span class="n">hSnapshot</span> <span class="o">==</span> <span class="n">INVALID_HANDLE_VALUE</span><span class="p">)</span>
        <span class="k">return</span> <span class="nb">false</span><span class="p">;</span>

    <span class="k">if</span> <span class="p">(</span><span class="n">Process32First</span><span class="p">(</span><span class="n">hSnapshot</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">pe</span><span class="p">))</span> <span class="p">{</span>
        <span class="k">do</span> <span class="p">{</span>
            <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">StrCmpI</span><span class="p">(</span><span class="n">pe</span><span class="p">.</span><span class="n">szExeFile</span><span class="p">,</span> <span class="n">proc_name</span><span class="p">.</span><span class="n">c_str</span><span class="p">()))</span> <span class="p">{</span>
                <span class="n">present</span> <span class="o">=</span> <span class="nb">true</span><span class="p">;</span>
                <span class="k">break</span><span class="p">;</span>
            <span class="p">}</span>
        <span class="p">}</span> <span class="k">while</span> <span class="p">(</span><span class="n">Process32Next</span><span class="p">(</span><span class="n">hSnapshot</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">pe</span><span class="p">));</span>
    <span class="p">}</span>
    <span class="n">CloseHandle</span><span class="p">(</span><span class="n">hSnapshot</span><span class="p">);</span>

    <span class="k">return</span> <span class="n">present</span><span class="p">;</span>
<span class="p">}</span></code></pre></figure>

<hr class="space" />

<p><b>Signature recommendations</b></p>
<p></p>
<p><i>Signature recommendations are not provided as it’s hard to say what exactly is queried in the processes’ snapshot.</i></p>

<hr class="space" />

<p><b>Detections table</b></p>

<table style="width:60%">
  <tr>
    <td colspan="2">Check if the following processes are running:</td>
  </tr>
  <tr>
    <th style="text-align:center">Detect</th>
    <th style="text-align:center">Process</th>
  </tr>
  <tr>
    <th rowspan="2">JoeBox</th>
    <td>joeboxserver.exe</td>
  </tr>
  <tr>
    <td>joeboxcontrol.exe</td>
  </tr>
  <tr>
    <th rowspan="2">Parallels</th>
    <td>prl_cc.exe</td>
  </tr>
  <tr>
    <td>prl_tools.exe</td>
  </tr>
  <tr>
    <th rowspan="2">VirtualBox</th>
    <td>vboxservice.exe</td>
  </tr>
  <tr>
    <td>vboxtray.exe</td>
  </tr>
  <tr>
    <th rowspan="2">VirtualPC</th>
    <td>vmsrvc.exe</td>
  </tr>
  <tr>
    <td>vmusrvc.exe</td>
  </tr>
  <tr>
    <th rowspan="7">VMware</th>
    <td>vmtoolsd.exe</td>
  </tr>
  <tr>
    <td>vmacthlp.exe</td>
  </tr>
  <tr>
    <td>vmwaretray.exe</td>
  </tr>
  <tr>
    <td>vmwareuser.exe</td>
  </tr>
  <tr>
    <td>vmware.exe</td>
  </tr>
  <tr>
    <td>vmount2.exe</td>
  </tr>
  <tr>
    <td>vmwareservice.exe</td>
  </tr>
  <tr>
    <th rowspan="2">Xen</th>
    <td>xenservice.exe</td>
  </tr>
  <tr>
    <td>xsvc_depriv.exe</td>
  </tr>
  <tr>
    <th>QEMU</th>
    <td>qemu-ga.exe</td>
  </tr>
  <tr>
    <th>WPE Pro</th>
    <td>WPE Pro.exe</td>
  </tr>
  <tr>
    <th>KsDumper</th>
    <td>ksdumperclient.exe</td>
  </tr>
</table>

<p><br />
<i>Notes:</i></p>
<ul>
  <li><tt><i>WPE Pro is a sniffer, not a VM or a sandbox, however it is used along with VM detects.</i></tt></li>
  <li><tt><i>KsDumper is a kernel-mode process dumper, not a VM or a sandbox, however it is used along with VM detects in Styx Stealer.</i></tt></li>
</ul>

<p><br /></p>
<h4><a class="a-dummy" name="check-if-specific-libraries-are-loaded">1.2. Check if specific libraries are loaded in the process address space</a></h4>

<p>Functions used:</p>
<ul>
  <li><tt>GetModuleHandle</tt></li> 
</ul>

<hr class="space" />

<p><b>Code sample</b></p>
<p></p>

<figure class="highlight"><pre><code class="language-c" data-lang="c"><span class="n">VOID</span> <span class="nf">loaded_dlls</span><span class="p">()</span>
<span class="p">{</span>
    <span class="cm">/* Some vars */</span>
    <span class="n">HMODULE</span> <span class="n">hDll</span><span class="p">;</span>

    <span class="cm">/* Array of strings of blacklisted dlls */</span>
    <span class="n">TCHAR</span><span class="o">*</span> <span class="n">szDlls</span><span class="p">[]</span> <span class="o">=</span> <span class="p">{</span>
        <span class="n">_T</span><span class="p">(</span><span class="s">"sbiedll.dll"</span><span class="p">),</span>
        <span class="n">_T</span><span class="p">(</span><span class="s">"dbghelp.dll"</span><span class="p">),</span>
        <span class="n">_T</span><span class="p">(</span><span class="s">"api_log.dll"</span><span class="p">),</span>
        <span class="n">_T</span><span class="p">(</span><span class="s">"dir_watch.dll"</span><span class="p">),</span>
        <span class="n">_T</span><span class="p">(</span><span class="s">"pstorec.dll"</span><span class="p">),</span>
        <span class="n">_T</span><span class="p">(</span><span class="s">"vmcheck.dll"</span><span class="p">),</span>
        <span class="n">_T</span><span class="p">(</span><span class="s">"wpespy.dll"</span><span class="p">),</span>
    <span class="p">};</span>

    <span class="n">WORD</span> <span class="n">dwlength</span> <span class="o">=</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">szDlls</span><span class="p">)</span> <span class="o">/</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">szDlls</span><span class="p">[</span><span class="mi">0</span><span class="p">]);</span>
    <span class="k">for</span> <span class="p">(</span><span class="kt">int</span> <span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">dwlength</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span>
    <span class="p">{</span>
        <span class="n">TCHAR</span> <span class="n">msg</span><span class="p">[</span><span class="mi">256</span><span class="p">]</span> <span class="o">=</span> <span class="n">_T</span><span class="p">(</span><span class="s">""</span><span class="p">);</span>
        <span class="n">_stprintf_s</span><span class="p">(</span><span class="n">msg</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">msg</span><span class="p">)</span> <span class="o">/</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">TCHAR</span><span class="p">),</span> <span class="n">_T</span><span class="p">(</span><span class="s">"Checking if process loaded modules contains: %s "</span><span class="p">),</span> 
                    <span class="n">szDlls</span><span class="p">[</span><span class="n">i</span><span class="p">]);</span>

        <span class="cm">/* Check if process loaded modules contains the blacklisted dll */</span>
        <span class="n">hDll</span> <span class="o">=</span> <span class="n">GetModuleHandle</span><span class="p">(</span><span class="n">szDlls</span><span class="p">[</span><span class="n">i</span><span class="p">]);</span>
        <span class="k">if</span> <span class="p">(</span><span class="n">hDll</span> <span class="o">==</span> <span class="nb">NULL</span><span class="p">)</span>
            <span class="n">print_results</span><span class="p">(</span><span class="n">FALSE</span><span class="p">,</span> <span class="n">msg</span><span class="p">);</span>
        <span class="k">else</span>
            <span class="n">print_results</span><span class="p">(</span><span class="n">TRUE</span><span class="p">,</span> <span class="n">msg</span><span class="p">);</span>
    <span class="p">}</span>
<span class="p">}</span></code></pre></figure>

<p><i>Credits for this code sample: <a href="https://github.com/LordNoteworthy/al-khaser">al-khaser project</a></i></p>

<hr class="space" />

<p><b>Signature recommendations</b></p>
<p></p>
<p>If the following function contains its only argument from the table column <font face="Courier New">`Library`</font>:</p>
<p></p>
<ul>
<li><tt>GetModuleHandle(module_name)</tt></li> 
</ul>
<p>then it’s an indication of application trying to use this evasion technique.</p>

<hr class="space" />

<p><b>Detections table</b></p>

<table style="width:60%">
  <tr>
    <td colspan="2">Check if the following libraries are loaded in the process address space:</td>
  </tr>
  <tr>
    <th style="text-align:center">Detect</th>
    <th style="text-align:center">Library</th>
  </tr>
  <tr>
    <th rowspan="3">CWSandbox</th>
    <td>api_log.dll</td>
  </tr>
  <tr>
    <td>dir_watch.dll</td>
  </tr>
  <tr>
    <td>pstorec.dll</td>
  </tr>
  <tr>
    <th>Sandboxie</th>
    <td>sbiedll.dll</td>
  </tr>
  <tr>
    <th>ThreatExpert</th>
    <td>dbghelp.dll</td>
  </tr>
  <tr>
    <th>VirtualPC</th>
    <td>vmcheck.dll</td>
  </tr>
  <tr>
    <th>WPE Pro</th>
    <td>wpespy.dll</td>
  </tr>
</table>

<p><br />
<i>Note: WPE Pro is a sniffer, not VM, however it is used along with VM detects.</i></p>

<p><br /></p>
<h4><a class="a-dummy" name="check-if-specific-functions-are-present-in-specific-libraries">1.3. Check if specific functions are present in specific libraries</a></h4>

<p>Functions used (see note about native functions):</p>
<ul>
  <li><tt>kernel32.GetProcAddress</tt></li> 
  <li><tt>kernel32.LdrGetProcedureAddress <i>(called internally)</i></tt></li> 
  <li><tt>ntdll.LdrGetProcedureAddress</tt></li> 
  <li><tt>ntdll.LdrpGetProcedureAddress <i>(called internally)</i></tt></li> 
</ul>

<hr class="space" />

<p><b>Code sample</b></p>
<p></p>

<figure class="highlight"><pre><code class="language-c" data-lang="c"><span class="n">BOOL</span> <span class="nf">wine_exports</span><span class="p">()</span>
<span class="p">{</span>
    <span class="cm">/* Some vars */</span>
    <span class="n">HMODULE</span> <span class="n">hKernel32</span><span class="p">;</span>

    <span class="cm">/* Get kernel32 module handle */</span>
    <span class="n">hKernel32</span> <span class="o">=</span> <span class="n">GetModuleHandle</span><span class="p">(</span><span class="n">_T</span><span class="p">(</span><span class="s">"kernel32.dll"</span><span class="p">));</span>
    <span class="k">if</span> <span class="p">(</span><span class="n">hKernel32</span> <span class="o">==</span> <span class="nb">NULL</span><span class="p">)</span> <span class="p">{</span>
        <span class="n">print_last_error</span><span class="p">(</span><span class="n">_T</span><span class="p">(</span><span class="s">"GetModuleHandle"</span><span class="p">));</span>
        <span class="k">return</span> <span class="n">FALSE</span><span class="p">;</span>
    <span class="p">}</span>

    <span class="cm">/* Check if wine_get_unix_file_name is exported by this dll */</span>
    <span class="k">if</span> <span class="p">(</span><span class="n">GetProcAddress</span><span class="p">(</span><span class="n">hKernel32</span><span class="p">,</span> <span class="s">"wine_get_unix_file_name"</span><span class="p">)</span> <span class="o">==</span> <span class="nb">NULL</span><span class="p">)</span>  <span class="c1">// sample value from the table</span>
        <span class="k">return</span> <span class="n">FALSE</span><span class="p">;</span>
    <span class="k">else</span>
        <span class="k">return</span> <span class="n">TRUE</span><span class="p">;</span>
<span class="p">}</span></code></pre></figure>

<p><i>Credits for this code sample: <a href="https://github.com/LordNoteworthy/al-khaser">al-khaser project</a></i></p>

<hr class="space" />

<p><b>Signature recommendations</b></p>
<p></p>
<p>If the following functions contain 2nd argument from the table column “Function” and the 1st argument is the 
address of matching “Library” name from the table:</p>
<p></p>
<ul>
<li><tt>kernel32.GetProcAddress(lib_handle, func_name)</tt></li> 
<li><tt>kernel32.LdrGetProcedureAddress(lib_handle, func_name)</tt></li> 
<li><tt>ntdll.LdrGetProcedureAddress(lib_handle, func_name)</tt></li> 
<li><tt>ntdll.LdrpGetProcedureAddress(lib_handle, func_name)</tt></li> 
</ul>
<p>then it’s an indication of application trying to use this evasion technique.</p>

<hr class="space" />

<p><b>Detections table</b></p>

<table style="width:60%">
  <tr>
    <td colspan="3">Check if the following functions are present in the following libraries:</td>
  </tr>
  <tr>
    <th style="text-align:center">Detect</th>
    <th style="text-align:center">Library</th>
    <th style="text-align:center">Function</th>
  </tr>
  <tr>
    <th rowspan="3">Wine</th>
    <td>kernel32.dll</td>
    <td>wine_get_unix_file_name</td>
  </tr>
  <tr>
    <td rowspan="2">ntdll.dll</td>
    <td>wine_get_version</td>
  </tr>
  <tr>
    <td>wine_get_host_version</td>
  </tr>
</table>

<p><br /></p>
<h4><a class="a-dummy" name="check-if-certain-libraries-can-be-loaded-and-others-not">1.4. Check if certain libraries can be loaded and others</a></h4>

<p>Function used:</p>
<ul>
  <li><tt>LoadLibraryA/W</tt></li> 
</ul>

<hr class="space" />

<p>This technique relies on the assumption that there are some common system libraries in the usual system that can be loaded – and there are also some fake ones, that should not be really present in a usual system. However, in a sandbox, when trying to load some fake libraries, they may be reported as loaded - which is different from how it should be on a usual host.</p>

<p>In other words, if a system library that is usually present (but not so widely used) in non-emulated machines is not loaded, then the application is likely in a sandbox. And if a fake DLL is reported to be loaded, then it is likely a sandbox, as such DLL will not be loaded in a usual machine.</p>

<p><b>Code sample</b></p>
<p></p>

<figure class="highlight"><pre><code class="language-c" data-lang="c"><span class="n">bool</span> <span class="n">Generic</span><span class="o">::</span><span class="n">CheckLoadedDLLs</span><span class="p">()</span> <span class="k">const</span> <span class="p">{</span>
    <span class="n">std</span><span class="o">::</span><span class="n">vector</span><span class="o">&lt;</span><span class="n">std</span><span class="o">::</span><span class="n">string</span><span class="o">&gt;</span> <span class="n">real_dlls</span> <span class="o">=</span> <span class="p">{</span>
        <span class="s">"kernel32.dll"</span><span class="p">,</span>
        <span class="s">"networkexplorer.dll"</span><span class="p">,</span>
        <span class="s">"NlsData0000.dll"</span>
    <span class="p">};</span>
    <span class="n">std</span><span class="o">::</span><span class="n">vector</span><span class="o">&lt;</span><span class="n">std</span><span class="o">::</span><span class="n">string</span><span class="o">&gt;</span> <span class="n">false_dlls</span> <span class="o">=</span> <span class="p">{</span>
        <span class="s">"NetProjW.dll"</span><span class="p">,</span>
        <span class="s">"Ghofr.dll"</span><span class="p">,</span>
        <span class="s">"fg122.dll"</span>
    <span class="p">};</span>
    <span class="n">HMODULE</span> <span class="n">lib_inst</span><span class="p">;</span>

    <span class="k">for</span> <span class="p">(</span><span class="k">auto</span> <span class="o">&amp;</span><span class="n">dll</span> <span class="o">:</span> <span class="n">real_dlls</span><span class="p">)</span> <span class="p">{</span>
        <span class="n">lib_inst</span> <span class="o">=</span> <span class="n">LoadLibraryA</span><span class="p">(</span><span class="n">dll</span><span class="p">.</span><span class="n">c_str</span><span class="p">());</span>
        <span class="k">if</span> <span class="p">(</span><span class="n">lib_inst</span> <span class="o">==</span> <span class="n">nullptr</span><span class="p">)</span> <span class="p">{</span>
            <span class="k">return</span> <span class="nb">true</span><span class="p">;</span>
        <span class="p">}</span>
        <span class="n">FreeLibrary</span><span class="p">(</span><span class="n">lib_inst</span><span class="p">);</span>
    <span class="p">}</span>

    <span class="k">for</span> <span class="p">(</span><span class="k">auto</span> <span class="o">&amp;</span><span class="n">dll</span> <span class="o">:</span> <span class="n">false_dlls</span><span class="p">)</span> <span class="p">{</span>
        <span class="n">lib_inst</span> <span class="o">=</span> <span class="n">LoadLibraryA</span><span class="p">(</span><span class="n">dll</span><span class="p">.</span><span class="n">c_str</span><span class="p">());</span>
        <span class="k">if</span> <span class="p">(</span><span class="n">lib_inst</span> <span class="o">!=</span> <span class="n">nullptr</span><span class="p">)</span> <span class="p">{</span>
            <span class="k">return</span> <span class="nb">true</span><span class="p">;</span>
        <span class="p">}</span>
    <span class="p">}</span>

    <span class="k">return</span> <span class="nb">false</span><span class="p">;</span>
<span class="p">}</span></code></pre></figure>

<hr class="space" />

<p><b>Signature recommendations</b></p>
<p></p>
<p><i>Signature recommendations are not provided as it’s hard to say that evasion tehnique is being applied when libraries are just loaded.</i></p>

<hr class="space" />

<p><br /></p>
<h4><a class="a-dummy" name="countermeasures">1.5. Countermeasures</a></h4>

<ul>
<li><tt>for processes:</tt> exclude target processes from enumeration or terminate them;</li> 
<li><tt>for libraries:</tt> exclude them from <a href="http://www.codereversing.com/blog/archives/265">enumeration lists in PEB</a>;</li> 
<li><tt>for functions in libraries:</tt> hook appropriate functions and compare their arguments against target ones;</li>
<li><tt>for libraries that must and must not be loaded:</tt> store a list of exclusions for libraries that should not be reported as loaded.</li> 
</ul>

<hr class="space" />

<p><br /></p>
<h3><a class="a-dummy" name="check-if-specific-artifacts-are-present-in-process">2. Check if specific artifacts are present in process address space (Sandboxie only)</a></h3>

<p>Functions used:</p>
<ul>
  <li><tt>NtQueryVirtualMemory</tt></li> 
</ul>

<hr class="space" />

<p><b>Code sample</b></p>
<p></p>

<figure class="highlight"><pre><code class="language-c" data-lang="c"><span class="n">BOOL</span> <span class="nf">AmISandboxied</span><span class="p">(</span><span class="n">LPVOID</span> <span class="n">lpMinimumApplicationAddress</span><span class="p">,</span> <span class="n">LPVOID</span> <span class="n">lpMaximumApplicationAddress</span><span class="p">)</span>
<span class="p">{</span>
  <span class="n">BOOL</span> <span class="n">IsSB</span> <span class="o">=</span> <span class="n">FALSE</span><span class="p">;</span>
  <span class="n">MEMORY_BASIC_INFORMATION</span> <span class="n">RegionInfo</span><span class="p">;</span>
  <span class="n">ULONG_PTR</span> <span class="n">i</span><span class="p">,</span> <span class="n">k</span><span class="p">;</span>
  <span class="n">SIZE_T</span> <span class="n">Length</span> <span class="o">=</span> <span class="mi">0L</span><span class="p">;</span>

  <span class="n">i</span> <span class="o">=</span> <span class="p">(</span><span class="n">ULONG_PTR</span><span class="p">)</span><span class="n">lpMinimumApplicationAddress</span><span class="p">;</span>
  <span class="k">do</span> <span class="p">{</span>

    <span class="n">NTSTATUS</span> <span class="n">Status</span> <span class="o">=</span> <span class="n">NtQueryVirtualMemory</span><span class="p">(</span><span class="n">GetCurrentProcess</span><span class="p">(),</span> 
                                           <span class="p">(</span><span class="n">PVOID</span><span class="p">)</span><span class="n">i</span><span class="p">,</span> 
                                           <span class="n">MemoryBasicInformation</span><span class="p">,</span>
                                           <span class="o">&amp;</span><span class="n">RegionInfo</span><span class="p">,</span> 
                                           <span class="k">sizeof</span><span class="p">(</span><span class="n">MEMORY_BASIC_INFORMATION</span><span class="p">),</span> 
                                           <span class="o">&amp;</span><span class="n">Length</span><span class="p">);</span>
    <span class="k">if</span> <span class="p">(</span><span class="n">NT_SUCCESS</span><span class="p">(</span><span class="n">Status</span><span class="p">))</span> <span class="p">{</span>

      <span class="c1">// Check if executable code</span>
      <span class="k">if</span> <span class="p">(((</span><span class="n">RegionInfo</span><span class="p">.</span><span class="n">AllocationProtect</span> <span class="o">&amp;</span> <span class="n">PAGE_EXECUTE_READWRITE</span><span class="p">)</span> <span class="o">==</span> <span class="n">PAGE_EXECUTE_READWRITE</span><span class="p">)</span> <span class="o">&amp;&amp;</span>
          <span class="p">((</span><span class="n">RegionInfo</span><span class="p">.</span><span class="n">State</span> <span class="o">&amp;</span> <span class="n">MEM_COMMIT</span><span class="p">)</span> <span class="o">==</span> <span class="n">MEM_COMMIT</span><span class="p">))</span> <span class="p">{</span>

        <span class="k">for</span> <span class="p">(</span><span class="n">k</span> <span class="o">=</span> <span class="n">i</span><span class="p">;</span> <span class="n">k</span> <span class="o">&lt;</span> <span class="n">i</span> <span class="o">+</span> <span class="n">RegionInfo</span><span class="p">.</span><span class="n">RegionSize</span><span class="p">;</span> <span class="n">k</span> <span class="o">+=</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">DWORD</span><span class="p">))</span> <span class="p">{</span>
          <span class="k">if</span> <span class="p">(</span>
            <span class="p">(</span><span class="o">*</span><span class="p">(</span><span class="n">PDWORD</span><span class="p">)</span><span class="n">k</span> <span class="o">==</span> <span class="err">'</span><span class="n">kuzt</span><span class="err">'</span><span class="p">)</span> <span class="o">||</span>
            <span class="p">(</span><span class="o">*</span><span class="p">(</span><span class="n">PDWORD</span><span class="p">)</span><span class="n">k</span> <span class="o">==</span> <span class="err">'</span><span class="n">xobs</span><span class="err">'</span><span class="p">)</span>
            <span class="p">)</span>
          <span class="p">{</span>
            <span class="n">IsSB</span> <span class="o">=</span> <span class="n">TRUE</span><span class="p">;</span>
            <span class="k">break</span><span class="p">;</span>
          <span class="p">}</span>
        <span class="p">}</span>
      <span class="p">}</span>
      <span class="n">i</span> <span class="o">+=</span> <span class="n">RegionInfo</span><span class="p">.</span><span class="n">RegionSize</span><span class="p">;</span>
    <span class="p">}</span>
    <span class="k">else</span> <span class="p">{</span>
      <span class="n">i</span> <span class="o">+=</span> <span class="mh">0x1000</span><span class="p">;</span>
    <span class="p">}</span>
  <span class="p">}</span> <span class="k">while</span> <span class="p">(</span><span class="n">i</span> <span class="o">&lt;</span> <span class="p">(</span><span class="n">ULONG_PTR</span><span class="p">)</span><span class="n">lpMaximumApplicationAddress</span><span class="p">);</span>

  <span class="k">return</span> <span class="n">IsSB</span><span class="p">;</span>
<span class="p">}</span></code></pre></figure>

<p><i>Take a look at <a href="https://github.com/hfiref0x/VMDE/blob/c1f439fbe58eaa83a09aa5804c4dd45de967337e/src/vmde/detect.c#L676">VMDE project sources</a>.</i></p>

<hr class="space" />

<p><b>Signature recommendations</b></p>
<p></p>
<p><i>Signature recommendations are not provided as it’s hard to say what exactly is queried when memory buffer is being examined.</i></p>

<p><br /></p>
<h4><a class="a-dummy" name="countermeasures-sandboxie">2.1. Countermeasures</a></h4>

<p>Erase present artifacts from memory.</p>

<p><br /></p>
<h3><a class="a-dummy" name="credits">Credits</a></h3>

<p>Credits go to open-source project from where code samples were taken:</p>
<ul>
<li>al-khaser project on <a href="https://github.com/LordNoteworthy/al-khaser">github</a></li>
<li>VMDE project on <a href="https://github.com/hfiref0x/VMDE">github</a></li>
</ul>

<p>Though Check Point tool InviZzzible has them all implemented, due to modular structure of the code it would require more space to show a code sample from this tool for the same purposes. That’s why we’ve decided to use other great open-source projects for examples throughout the encyclopedia.</p>


    <br>
    <div style="text-align: left">
        <a href="..">Go back</a>
    </div>
    <br>
    <div class="sharebuttons" style="text-align: center">
        <hr />
        <ul>
          <li>
            <p class="sharetitle"> Share this: </p>
          </li>
          <li class="reddit">
            <a href="http://www.reddit.com/submit?url=https://evasions.checkpoint.com/src/Evasions/techniques/processes.html&title=Evasions:%20Processes - Evasion Techniques" target="_blank">
                <svg xmlns="http://www.w3.org/2000/svg"
                aria-label="Reddit" role="img"
                viewBox="0 0 512 512"><rect
                width="512" height="512"
                rx="15%"
                fill="#f40"/><g fill="#fff"><ellipse cx="256" cy="307" rx="166" ry="117"/><circle cx="106" cy="256" r="42"/><circle cx="407" cy="256" r="42"/><circle cx="375" cy="114" r="32"/></g><g stroke-linecap="round" stroke-linejoin="round" fill="none"><path d="m256 196 23-101 73 15" stroke="#fff" stroke-width="16"/><path d="m191 359c33 25 97 26 130 0" stroke="#f40" stroke-width="13"/></g><g fill="#f40"><circle cx="191" cy="287" r="31"/><circle cx="321" cy="287" r="31"/></g></svg>
                
            </a>
          </li>
          <li class="hn">
            <a href="http://news.ycombinator.com/submitlink?u=https://evasions.checkpoint.com/src/Evasions/techniques/processes.html&t=Evasions:%20Processes - Evasion Techniques" target="_blank">
                <svg xmlns="http://www.w3.org/2000/svg"
                aria-label="Hacker News" role="img"
                viewBox="0 0 512 512"><rect
                width="512" height="512"
                rx="15%"
                fill="#f60"/><path fill="#fff" d="M124 91h51l81 162 81-164h51L276 293v136h-40V293z"/></svg>
            </a>
          </li>
          <li class="twitter">
            <a href="https://twitter.com/intent/tweet?via=_CPResearch_&url=https://evasions.checkpoint.com/src/Evasions/techniques/processes.html&text=Evasions:%20Processes - Evasion Techniques" target="_blank">
                <svg viewBox="0 0 1792 1792" xmlns="http://www.w3.org/2000/svg"><path d="M1684 408q-67 98-162 167 1 14 1 42 0 130-38 259.5t-115.5 248.5-184.5 210.5-258 146-323 54.5q-271 0-496-145 35 4 78 4 225 0 401-138-105-2-188-64.5t-114-159.5q33 5 61 5 43 0 85-11-112-23-185.5-111.5t-73.5-205.5v-4q68 38 146 41-66-44-105-115t-39-154q0-88 44-163 121 149 294.5 238.5t371.5 99.5q-8-38-8-74 0-134 94.5-228.5t228.5-94.5q140 0 236 102 109-21 205-78-37 115-142 178 93-10 186-50z"/></svg>
            </a>
          </li>
          <li class="linkedin">
            <a href=https://www.linkedin.com/shareArticle?mini=true&url=https://evasions.checkpoint.com/src/Evasions/techniques/processes.html&title=Evasions:%20Processes - Evasion Techniques&source=LinkedIn" target="_blank">
                <svg viewBox="0 0 1792 1792" xmlns="http://www.w3.org/2000/svg"><path d="M477 625v991h-330v-991h330zm21-306q1 73-50.5 122t-135.5 49h-2q-82 0-132-49t-50-122q0-74 51.5-122.5t134.5-48.5 133 48.5 51 122.5zm1166 729v568h-329v-530q0-105-40.5-164.5t-126.5-59.5q-63 0-105.5 34.5t-63.5 85.5q-11 30-11 81v553h-329q2-399 2-647t-1-296l-1-48h329v144h-2q20-32 41-56t56.5-52 87-43.5 114.5-15.5q171 0 275 113.5t104 332.5z"/></svg>
            </a>
          </li>
        </ul>
      </div>
      
</article>


</section>

<nav class="navbar navbar-default navbar-fixed-bottom">
  <div class="container footer-content">

    Made with <font class="a-pink"><i class ="fa fa-heart"></i></font> to serve the community by Check Point Research    |    <a class="a-pink" href="https://research.checkpoint.com">Research blog</a>    |    <a class="a-pink" href="https://research.checkpoint.com/about-us/">About Us</a>    |    <a class="a-pink" href="https://github.com/CheckPointSW"><i class="fa fa-github fa-lg"></i></a> <a class="a-pink" href="https://twitter.com/_CPResearch_"><i class="fa fa-twitter fa-lg"></i></a>
    
    <br>
    
    © 1994-2024 Check Point Software Technologies LTD | All rights reserved | Property of CheckPoint.com


  </div>
</nav>

  </body>

</html>
