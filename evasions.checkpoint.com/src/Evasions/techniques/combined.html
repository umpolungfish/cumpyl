<!DOCTYPE html>
<html>

  <head>
  <meta charset="utf-8">
  <meta http-equiv="X-UA-Compatible" content="IE=edge">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-194688-3"></script>
  <script>
   window.dataLayer = window.dataLayer || [];
   function gtag(){dataLayer.push(arguments);}
   gtag('js', new Date());
   gtag('config', 'UA-194688-3');
  </script>
  <meta content="Evasion techniques" property="og:site_name">

  <meta content="Evasions: CPU" property="og:title">


  <meta name="twitter:title" content="Malware Evasion Encyclopedia" />
  <meta name="twitter:image" content="https://research.checkpoint.com/wp-content/uploads/2020/02/evasions.jpg" />


  <meta content="article" property="og:type">


  <meta content="Evasion techniques
" property="og:description">


  <meta content="https://evasions.checkpoint.com/src/Evasions/techniques/cpu.html" property="og:url">


  <meta content="2024-07-10T07:20:28+00:00" property="article:published_time">
  <meta content="https://evasions.checkpoint.com/about/" property="article:author">


  <meta property="og:image" content="">


  
  <meta content="evasions" property="article:section">
  


  
  <meta content="cpu" property="article:tag">
  

  <title>Evasions: CPU</title>
  <meta name="description" content="Contents">
<script src="https://ajax.googleapis.com/ajax/libs/jquery/2.2.2/jquery.min.js"></script>
<script src="https://maxcdn.bootstrapcdn.com/bootstrap/3.3.6/js/bootstrap.min.js" integrity="sha384-0mSbJDEHialfmuBBQP6A4Qrprq5OVfW37PRR3j5ELqxss1yVqOtnepnHVP9aJ7xS" crossorigin="anonymous"></script>
  <link rel="stylesheet" href="https://evasions.checkpoint.com/assets/css/main.css">
<script src="https://maxcdn.bootstrapcdn.com/bootstrap/3.3.6/js/bootstrap.min.js" integrity="sha384-0mSbJDEHialfmuBBQP6A4Qrprq5OVfW37PRR3j5ELqxss1yVqOtnepnHVP9aJ7xS" crossorigin="anonymous"></script>

  <link href='https://fonts.googleapis.com/css?family=PT+Sans' rel='stylesheet' type='text/css'>
  <link href='https://fonts.googleapis.com/css?family=Fira+Mono' rel='stylesheet' type='text/css'>
  <link href='https://fonts.googleapis.com/css?family=Lato:400,700' rel='stylesheet' type='text/css'>
  <link href='https://fonts.googleapis.com/css?family=Source+Code+Pro:400,200,300,500,600,700,900' rel='stylesheet' type='text/css'>
  <link href='https://fonts.googleapis.com/css?family=Gentium+Basic:400,700' rel='stylesheet' type='text/css'>
  <link href='https://fonts.googleapis.com/css?family=Alegreya:400,400italic,700' rel='stylesheet' type='text/css'>
  <link href='https://fonts.googleapis.com/css?family=Lora:400,400italic,700' rel='stylesheet' type='text/css'>
  <link href='https://fonts.googleapis.com/css?family=Fira+Sans:400,300,500,700' rel='stylesheet' type='text/css'>
  <script src="https://ajax.googleapis.com/ajax/libs/jquery/2.2.0/jquery.min.js"></script>
  <link href='https://fonts.googleapis.com/css?family=Open+Sans:400,700' rel='stylesheet' type='text/css'>
  <link href="https://maxcdn.bootstrapcdn.com/bootstrap/3.3.6/css/bootstrap.min.css" rel="stylesheet" integrity="sha384-1q8mTJOASx8j1Au+a5WDVnPi2lkFfwwEAa8hDDdjZlpLegxhjVME1fgjWPGmkzs7" crossorigin="anonymous">
  <link href="https://maxcdn.bootstrapcdn.com/font-awesome/4.6.1/css/font-awesome.min.css" rel="stylesheet" integrity="sha384-hQpvDQiCJaD2H465dQfA717v7lu5qHWtDbWNPvaTJ0ID5xnPUlVXnKzq7b8YUkbN" crossorigin="anonymous">
  <link rel="canonical" href="https://evasions.checkpoint.com/src/Evasions/techniques/cpu.html">
  <link rel="alternate" type="application/rss+xml" title="Evasion techniques" href="https://evasions.checkpoint.com/feed.xml">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/tinysort/2.3.6/tinysort.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/tinysort/2.3.6/tinysort.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/tinysort/2.3.6/tinysort.charorder.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/tinysort/2.3.6/tinysort.charorder.min.js"></script>
  <script type="text/javascript" async src="//platform.twitter.com/widgets.js"></script>




</head>


  <body>
<section>
<article class="post" itemscope itemtype="http://schema.org/BlogPosting">
  <div class="jumbotron">
    <div class="container">
      <h1 class="post-title-main" itemprop="name headline">Evasions: CPU</h1>
    </div>
</div>

  <div class="post-content container" itemprop="articleBody">
    <div style="text-align: left">
        <a href="..">Go back</a>
        <br>
        <br>
    </div>
    <h1>Contents</h1>

<p><a href="#cpu-detection-methods">CPU detection methods used</a>
<br />
  <a href="#check-vendor-id-via-cpuid">1. Check vendor ID string via CPUID instruction</a>
<br />
  <a href="#check-if-being-run-in-Hypervisor-via-cpuid">2. Check if being run in Hypervisor via CPUID instruction</a>
<br />
  <a href="#check-for-global-tables-location">3. Check for global tables location: IDT/GDT/LDT</a>
<br />
  <a href="#using-exotic-instructions-to-fool-virtual-emulators">4. Using exotic instructions to fool virtual emulators</a>
<br />
  <a href="#detecting-environment-via-illegal-instructions-virtualpc">5. Detecting environment via execution of illegal instructions (VirtualPC only)</a>
<br />
  <a href="#detecting-environment-via-in-backdoor-port-vmware">6. Detecting environment via IN instruction - backdoor port (VMware only)</a>
<br />
  <a href="#signature-recommendations">Signature recommendations</a>
<br />
  <a href="#countermeasures-sandboxie">Countermeasures</a>
<br />
  <a href="#credits">Credits</a>
<br />
<br /></p>

<hr class="space" />

<h2><a class="a-dummy" name="cpu-detection-methods">CPU detection methods used</a></h2>
<p>Techniques in this group use specific processor instructions to either get particular information about CPU — or execute predefined instruction sequence which behaves differently in usual host OS and in virtual environment.</p>

<p><br /></p>
<h3><a class="a-dummy" name="check-vendor-id-via-cpuid">1. Check vendor ID string via CPUID instruction</a></h3>
<p>The <a href="https://x86.renejeschke.de/html/file_module_x86_id_45.html">CPUID</a> instruction is an instruction that returns processor identification and feature information to <tt>EBX, ECX, EDX</tt>. The information received to these registers can be used to identify a vendor.</p>

<hr class="space" />

<p><b>Code sample</b></p>
<p></p>

<figure class="highlight"><pre><code class="language-c" data-lang="c"><span class="kr">__declspec</span><span class="p">(</span><span class="kr">naked</span><span class="p">)</span> <span class="kt">void</span> <span class="nf">get_cpuid_vendor</span><span class="p">(</span><span class="kt">char</span> <span class="o">*</span><span class="n">vendor_id</span><span class="p">)</span> <span class="p">{</span>
  <span class="kr">__asm</span> <span class="p">{</span>        
    <span class="p">;</span> <span class="n">save</span> <span class="n">non</span><span class="o">-</span><span class="k">volatile</span> <span class="k">register</span>
    <span class="n">push</span> <span class="n">ebx</span>
    
    <span class="p">;</span> <span class="n">nullify</span> <span class="n">output</span> <span class="n">registers</span>
    <span class="n">xor</span> <span class="n">ebx</span><span class="p">,</span> <span class="n">ebx</span>
    <span class="n">xor</span> <span class="n">ecx</span><span class="p">,</span> <span class="n">ecx</span>
    <span class="n">xor</span> <span class="n">edx</span><span class="p">,</span> <span class="n">edx</span>
    
    <span class="p">;</span> <span class="n">call</span> <span class="n">cpuid</span> <span class="n">with</span> <span class="n">argument</span> <span class="n">in</span> <span class="n">EAX</span>
    <span class="n">mov</span> <span class="n">eax</span><span class="p">,</span> <span class="mh">0x40000000</span>
    <span class="n">cpuid</span>
    
    <span class="p">;</span> <span class="n">store</span> <span class="n">vendor_id</span> <span class="n">ptr</span> <span class="n">to</span> <span class="n">destination</span>
    <span class="n">mov</span> <span class="n">edi</span><span class="p">,</span> <span class="n">vendor_id</span>
    
    <span class="p">;</span> <span class="n">move</span> <span class="n">string</span> <span class="n">parts</span> <span class="n">to</span> <span class="n">destination</span>
    <span class="n">mov</span> <span class="n">eax</span><span class="p">,</span> <span class="n">ebx</span>  <span class="p">;</span> <span class="n">part</span> <span class="mi">1</span> <span class="n">of</span> <span class="mi">3</span> <span class="n">from</span> <span class="n">EBX</span>
    <span class="n">stosd</span>
    <span class="n">mov</span> <span class="n">eax</span><span class="p">,</span> <span class="n">ecx</span>  <span class="p">;</span> <span class="n">part</span> <span class="mi">2</span> <span class="n">of</span> <span class="mi">3</span> <span class="n">from</span> <span class="n">ECX</span>
    <span class="n">stosd</span>
    <span class="n">mov</span> <span class="n">eax</span><span class="p">,</span> <span class="n">edx</span>  <span class="p">;</span> <span class="n">part</span> <span class="mi">3</span> <span class="n">of</span> <span class="mi">3</span> <span class="n">from</span> <span class="n">EDX</span>
    <span class="n">stosd</span>
    
    <span class="p">;</span> <span class="n">restore</span> <span class="n">saved</span> <span class="n">non</span><span class="o">-</span><span class="k">volatile</span> <span class="k">register</span>
    <span class="n">pop</span> <span class="n">ebx</span> 
    
    <span class="p">;</span> <span class="k">return</span> <span class="n">from</span> <span class="n">function</span>
    <span class="n">retn</span>
  <span class="p">}</span>
<span class="p">}</span></code></pre></figure>

<hr class="space" />

<p><b>Detections table</b></p>

<table style="width:70%">
  <tr>
    <td colspan="3">Check vendor ID string via CPUID instruction - returned in parts in EBX, ECX, EDX:</td>
  </tr>
  <tr>
    <th style="text-align:center">Detect</th>
    <th style="text-align:center">EAX as argument to CPUID</th>
    <th style="text-align:center">String</th>
  </tr>
  <tr>
    <th>FreeBSD HV</th>
    <td>0x40000000</td>
    <td>bhyve bhyve</td>
  </tr>
  <tr>
    <th>Hyper-V</th>
    <td>0x40000000</td>
    <td>Microsoft Hv</td>
  </tr>
  <tr>
    <th>KVM</th>
    <td>0x40000000</td>
    <td>KVMKVMKVM</td>
  </tr>
  <tr>
    <th>Parallels</th>
    <td>0x40000000</td>
    <td>prl hyperv</td>
  </tr>
  <tr>
    <th>VirtualBox</th>
    <td>0x40000000</td>
    <td>VBoxVBoxVBox</td>
  </tr>
  <tr>
    <th>VirtualPC</th>
    <td>0x40000000</td>
    <td>Microsoft Hv</td>
  </tr>
  <tr>
    <th>VMware</th>
    <td>0x40000000</td>
    <td>VMwareVMware</td>
  </tr>
  <tr>
    <th>Xen</th>
    <td>0x40000000</td>
    <td>XenVMMXenVMM</td>
  </tr>
</table>

<p><br /></p>
<h3><a class="a-dummy" name="check-if-being-run-in-Hypervisor-via-cpuid">2. Check if being run in Hypervisor via CPUID instruction</a></h3>

<p>An other way to detect if the program is being run in hypervisor is using the <tt>CPUID</tt> instruction in an other way.
<br />
<br />
Instead of setting <tt>EAX</tt> (the argument to <tt>CPUID</tt>) to be <tt>0x40000000</tt>, <tt>EAX</tt> is set to 1. 
<br />
<br />
When <tt>EAX</tt> is set to 1, the 31st bit in <tt>ECX</tt> (<tt>CPUID</tt>’s returned value) is set, it indicates that the program is being run in Hypervisor.</p>

<hr class="space" />

<p><b>Code sample (function <tt>GetAdaptersAddresses</tt>)</b></p>
<p></p>

<figure class="highlight"><pre><code class="language-c" data-lang="c"><span class="kr">__declspec</span><span class="p">(</span><span class="kr">naked</span><span class="p">)</span> <span class="n">bool</span> <span class="nf">is_run_in_hypervisor</span><span class="p">()</span> <span class="p">{</span>
  <span class="kr">__asm</span> <span class="p">{</span>
    <span class="p">;</span> <span class="n">nullify</span> <span class="n">output</span> <span class="k">register</span>
    <span class="n">xor</span> <span class="n">ecx</span><span class="p">,</span> <span class="n">ecx</span>
    
    <span class="p">;</span> <span class="n">call</span> <span class="n">cpuid</span> <span class="n">with</span> <span class="n">argument</span> <span class="n">in</span> <span class="n">EAX</span>
    <span class="n">mov</span> <span class="n">eax</span><span class="p">,</span> <span class="mi">1</span>
    <span class="n">cpuid</span>
    
    <span class="p">;</span> <span class="n">set</span> <span class="n">CF</span> <span class="n">equal</span> <span class="n">to</span> <span class="mi">31</span><span class="n">st</span> <span class="n">bit</span> <span class="n">in</span> <span class="n">ECX</span>
    <span class="n">bt</span> <span class="n">ecx</span><span class="p">,</span> <span class="mi">31</span>
    
    <span class="p">;</span> <span class="n">set</span> <span class="n">AL</span> <span class="n">to</span> <span class="n">the</span> <span class="n">value</span> <span class="n">of</span> <span class="n">CF</span>
    <span class="n">setc</span> <span class="n">al</span>
    
    <span class="p">;</span> <span class="k">return</span> <span class="n">from</span> <span class="n">function</span>
    <span class="n">retn</span>
  <span class="p">}</span>
<span class="p">}</span></code></pre></figure>

<hr class="space" />

<p><b>Detections table</b></p>

<table style="width:70%">
  <tr>
    <td colspan="3">Check if being run in Hypervisor (via CPUID)</td>
  </tr>
  <tr>
    <th style="text-align:center">Detect</th>
    <th style="text-align:center">EAX as argument to CPUID</th>
    <th style="text-align:center">Check of return value</th>
  </tr>
  <tr>
    <th>Hypervisor</th>
    <td>1</td>
    <td>31st bit in ECX - set if run in Hypervisor</td>
  </tr>
</table>

<p><br /></p>
<h3><a class="a-dummy" name="check-for-global-tables-location">3. Check for global tables location: IDT/GDT/LDT</a></h3>

<p><i>
This technique doesn’t work on latest VMware releases (all Windows releases affected). However, it is described here for the sake of completeness.
</i>
<br />
<br /></p>

<p>This trick involves looking at  the pointers to critical operating system tables that are typically relocated on a virtual machine. It’s what called “Red Pill” and was <a href="http://web.archive.org/web/20070325211649/http://www.invisiblethings.org/papers/redpill.html">first introduced</a> by Joanna Rutkowska.
<br />
<br />
There is one Local Descriptor Table Register (LDTR), one Global Descriptor Table Register (GDTR), and one Interrupt Descriptor Table Register (IDTR) per CPU. They have to be moved to a different location when a guest operating system is running to avoid conflicts with the host.
<br />
<br />
On real machines the IDT, for example, is located lower in memory than it is on guest (i.e., virtual) machines.
<br /></p>

<hr class="space" />

<p><b>Code sample</b></p>
<p></p>

<figure class="highlight"><pre><code class="language-c" data-lang="c"><span class="n">idt_vm_detect</span> <span class="o">=</span> <span class="p">((</span><span class="n">get_idt_base</span><span class="p">()</span> <span class="o">&gt;&gt;</span> <span class="mi">24</span><span class="p">)</span> <span class="o">==</span> <span class="mh">0xff</span><span class="p">);</span>
<span class="n">ldt_vm_detect</span> <span class="o">=</span> <span class="p">(</span><span class="n">get_ldt_base</span><span class="p">()</span> <span class="o">==</span> <span class="mh">0xdead0000</span><span class="p">);</span>
<span class="n">gdt_vm_detect</span> <span class="o">=</span> <span class="p">((</span><span class="n">get_gdt_base</span> <span class="o">&gt;&gt;</span> <span class="mi">24</span><span class="p">)</span> <span class="o">==</span> <span class="mh">0xff</span><span class="p">);</span>

<span class="c1">// sidt instruction stores the contents of the IDT Register </span>
<span class="c1">// (the IDTR which points to the IDT) in a processor register.</span>
<span class="n">ULONG</span> <span class="nf">get_idt_base</span><span class="p">()</span> <span class="p">{</span>    
    <span class="n">UCHAR</span> <span class="n">idtr</span><span class="p">[</span><span class="mi">6</span><span class="p">];</span>
<span class="cp">#if defined (ENV32BIT)
</span>    <span class="n">_asm</span> <span class="n">sidt</span> <span class="n">idtr</span>
<span class="cp">#endif
</span>    <span class="k">return</span> <span class="o">*</span><span class="p">((</span><span class="kt">unsigned</span> <span class="kt">long</span> <span class="o">*</span><span class="p">)</span><span class="o">&amp;</span><span class="n">idtr</span><span class="p">[</span><span class="mi">2</span><span class="p">]);</span>
<span class="p">}</span>

<span class="c1">// sldt instruction stores the contents of the LDT Register </span>
<span class="c1">// (the LDTR which points to the LDT) in a processor register.</span>
<span class="n">ULONG</span> <span class="nf">get_ldt_base</span><span class="p">()</span> <span class="p">{</span>
    <span class="n">UCHAR</span> <span class="n">ldtr</span><span class="p">[</span><span class="mi">5</span><span class="p">]</span> <span class="o">=</span> <span class="s">"</span><span class="se">\xef\xbe\xad\xde</span><span class="s">"</span><span class="p">;</span>
<span class="cp">#if defined (ENV32BIT)
</span>    <span class="n">_asm</span> <span class="n">sldt</span> <span class="n">ldtr</span>
<span class="cp">#endif
</span>    <span class="k">return</span> <span class="o">*</span><span class="p">((</span><span class="kt">unsigned</span> <span class="kt">long</span> <span class="o">*</span><span class="p">)</span><span class="o">&amp;</span><span class="n">ldtr</span><span class="p">[</span><span class="mi">0</span><span class="p">]);</span>
<span class="p">}</span>

<span class="c1">// sgdt instruction stores the contents of the GDT Register </span>
<span class="c1">// (the GDTR which points to the GDT) in a processor register.</span>
<span class="n">ULONG</span> <span class="nf">get_gdt_base</span><span class="p">()</span> <span class="p">{</span>
    <span class="n">UCHAR</span> <span class="n">gdtr</span><span class="p">[</span><span class="mi">6</span><span class="p">];</span>
<span class="cp">#if defined (ENV32BIT)
</span>    <span class="n">_asm</span> <span class="n">sgdt</span> <span class="n">gdtr</span>
<span class="cp">#endif
</span>    <span class="k">return</span> <span class="n">gdt</span> <span class="o">=</span> <span class="o">*</span><span class="p">((</span><span class="kt">unsigned</span> <span class="kt">long</span> <span class="o">*</span><span class="p">)</span><span class="o">&amp;</span><span class="n">gdtr</span><span class="p">[</span><span class="mi">2</span><span class="p">]);</span>
<span class="p">}</span></code></pre></figure>

<p><i>Credits for this code sample: <a href="https://github.com/LordNoteworthy/al-khaser">al-khaser project</a></i></p>

<p><br /></p>
<h3><a class="a-dummy" name="using-exotic-instructions-to-fool-virtual-emulators">4. Using exotic instructions to fool virtual emulators</a></h3>

<p>This technique is described <a href="https://www.slideshare.net/Cyphort/mmw-antisandbox-techniques">by this link</a> (slide #37).
<br />
<br />
MMX instructions may be used as random instructions by malware. Sometimes such subsets of CPU instruction are not supported by emulators and thus exception is thrown instead of performing analysis.</p>

<hr class="space" />

<p><b>Example:</b></p>
<p></p>

<div style="text-align: center">
  <img src="../assets/images/mmx_anti_sb.png" />
</div>

<p><br /></p>
<h3><a class="a-dummy" name="detecting-environment-via-illegal-instructions-virtualpc">5. Detecting environment via execution of illegal instructions (VirtualPC only)</a></h3>

<p>The malware executes illegal instructions, which should generate exception on the real CPU but are executed normally - or in some different way - in virtual environment.
<br />
<br />
Information about CPU exceptions is provided <a href="https://wiki.osdev.org/Exceptions#Invalid_Opcode">by this link</a>.</p>

<hr class="space" />

<p><b>Code sample (variant 1, generating #ud exception)</b></p>
<p></p>

<figure class="highlight"><pre><code class="language-asm" data-lang="asm">push ebx
xor ebx, ebx
mov eax, 1
; the following 4 bytes below generate #ud exception
db 0x0F
db 0x3F
db 0x0D
db 0x00
test ebx, ebx
setz al
pop ebx</code></pre></figure>

<hr class="space" />

<p>It should be emphasized that there are more than 1,000 combinations of</p>

<figure class="highlight"><pre><code class="language-asm" data-lang="asm">0x0F
0x3F
0xXX
0xYY</code></pre></figure>

<p>bytes that may be used by malware in order to detect VirtualPC enviroment.</p>

<hr class="space" />

<p><b>Code sample (variant 2, executing illegal STI instruction)</b></p>
<p></p>

<figure class="highlight"><pre><code class="language-c" data-lang="c"><span class="c1">// Taken here: https://pastebin.com/Nsv5B1yk</span>
<span class="c1">// http://waleedassar.blogspot.com</span>
<span class="c1">// http://www.twitter.com/waleedassar</span>
<span class="c1">// Use this code to detect if Windows XP is running inside Virtual PC 2007</span>
<span class="cp">#include</span> <span class="cpf">"stdafx.h"</span><span class="cp">
#include</span> <span class="cpf">"windows.h"</span><span class="cp">
#include</span> <span class="cpf">"stdio.h"</span><span class="cp">
</span> 
<span class="cp">#define CONTEXT_ALL 0x1003F
</span> 
<span class="kt">int</span> <span class="nf">dummy</span><span class="p">(</span><span class="kt">int</span><span class="p">);</span>
<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">gf</span><span class="o">=</span><span class="mi">0</span><span class="p">;</span>

<span class="kt">int</span> <span class="kr">__cdecl</span> <span class="nf">Handler</span><span class="p">(</span><span class="n">EXCEPTION_RECORD</span><span class="o">*</span> <span class="n">pRec</span><span class="p">,</span><span class="kt">void</span><span class="o">*</span> <span class="n">est</span><span class="p">,</span><span class="kt">unsigned</span> <span class="kt">char</span><span class="o">*</span> <span class="n">pContext</span><span class="p">,</span><span class="kt">void</span><span class="o">*</span> <span class="n">disp</span><span class="p">)</span>
<span class="p">{</span>
    <span class="k">if</span><span class="p">(</span><span class="n">pRec</span><span class="o">-&gt;</span><span class="n">ExceptionCode</span><span class="o">==</span><span class="mh">0xC0000096</span><span class="p">)</span>  <span class="c1">//Privileged instruction</span>
    <span class="p">{</span>
        <span class="c1">//---------------------Installing the trick--------------------------------------</span>
        <span class="o">*</span><span class="p">(</span><span class="kt">unsigned</span> <span class="kt">long</span><span class="o">*</span><span class="p">)(</span><span class="n">pContext</span><span class="p">)</span><span class="o">=</span><span class="n">CONTEXT_ALL</span><span class="p">;</span><span class="cm">/*CONTEXT_DEBUG_REGISTERS|CONTEXT_FULL*/</span>
        <span class="o">*</span><span class="p">(</span><span class="kt">unsigned</span> <span class="kt">long</span><span class="o">*</span><span class="p">)(</span><span class="n">pContext</span><span class="o">+</span><span class="mh">0x4</span><span class="p">)</span><span class="o">=</span><span class="p">(</span><span class="kt">unsigned</span> <span class="kt">long</span><span class="p">)(</span><span class="o">&amp;</span><span class="n">dummy</span><span class="p">);</span>
        <span class="o">*</span><span class="p">(</span><span class="kt">unsigned</span> <span class="kt">long</span><span class="o">*</span><span class="p">)(</span><span class="n">pContext</span><span class="o">+</span><span class="mh">0x8</span><span class="p">)</span><span class="o">=</span><span class="p">(</span><span class="kt">unsigned</span> <span class="kt">long</span><span class="p">)(</span><span class="o">&amp;</span><span class="n">dummy</span><span class="p">);</span>
        <span class="o">*</span><span class="p">(</span><span class="kt">unsigned</span> <span class="kt">long</span><span class="o">*</span><span class="p">)(</span><span class="n">pContext</span><span class="o">+</span><span class="mh">0xC</span><span class="p">)</span><span class="o">=</span><span class="p">(</span><span class="kt">unsigned</span> <span class="kt">long</span><span class="p">)(</span><span class="o">&amp;</span><span class="n">dummy</span><span class="p">);</span>
        <span class="o">*</span><span class="p">(</span><span class="kt">unsigned</span> <span class="kt">long</span><span class="o">*</span><span class="p">)(</span><span class="n">pContext</span><span class="o">+</span><span class="mh">0x10</span><span class="p">)</span><span class="o">=</span><span class="p">(</span><span class="kt">unsigned</span> <span class="kt">long</span><span class="p">)(</span><span class="o">&amp;</span><span class="n">dummy</span><span class="p">);</span>
        <span class="o">*</span><span class="p">(</span><span class="kt">unsigned</span> <span class="kt">long</span><span class="o">*</span><span class="p">)(</span><span class="n">pContext</span><span class="o">+</span><span class="mh">0x14</span><span class="p">)</span><span class="o">=</span><span class="mi">0</span><span class="p">;</span>
        <span class="o">*</span><span class="p">(</span><span class="kt">unsigned</span> <span class="kt">long</span><span class="o">*</span><span class="p">)(</span><span class="n">pContext</span><span class="o">+</span><span class="mh">0x18</span><span class="p">)</span><span class="o">=</span><span class="mh">0x155</span><span class="p">;</span> <span class="c1">//Enable the four DRx On-Execute</span>
        <span class="c1">//---------------------------------------------------------------------------------</span>
        <span class="p">(</span><span class="o">*</span><span class="p">(</span><span class="kt">unsigned</span> <span class="kt">long</span><span class="o">*</span><span class="p">)(</span><span class="n">pContext</span><span class="o">+</span><span class="mh">0xB8</span><span class="p">))</span><span class="o">++</span><span class="p">;</span>
        <span class="k">return</span> <span class="n">ExceptionContinueExecution</span><span class="p">;</span>
    <span class="p">}</span>
    <span class="k">else</span> <span class="k">if</span><span class="p">(</span><span class="n">pRec</span><span class="o">-&gt;</span><span class="n">ExceptionCode</span><span class="o">==</span><span class="n">EXCEPTION_SINGLE_STEP</span><span class="p">)</span>
    <span class="p">{</span>
        <span class="k">if</span><span class="p">(</span><span class="n">gf</span><span class="o">==</span><span class="mi">1</span><span class="p">)</span>
        <span class="p">{</span>
            <span class="n">MessageBox</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span><span class="s">"Expected behavior (XP)"</span><span class="p">,</span><span class="s">"waliedassar"</span><span class="p">,</span><span class="mi">0</span><span class="p">);</span>
            <span class="n">ExitProcess</span><span class="p">(</span><span class="mi">0</span><span class="p">);</span>
        <span class="p">}</span>
        <span class="n">gf</span><span class="o">++</span><span class="p">;</span>
        <span class="p">(</span><span class="o">*</span><span class="p">(</span><span class="kt">unsigned</span> <span class="kt">long</span><span class="o">*</span><span class="p">)(</span><span class="n">pContext</span><span class="o">+</span><span class="mh">0xC0</span><span class="p">))</span><span class="o">|=</span><span class="mh">0x00010000</span><span class="p">;</span> <span class="c1">//Set the RF (Resume Flag)</span>
        <span class="k">return</span> <span class="n">ExceptionContinueExecution</span><span class="p">;</span>
    <span class="p">}</span>
    <span class="k">return</span> <span class="n">ExceptionContinueSearch</span><span class="p">;</span>
<span class="p">}</span>
 
<span class="kt">int</span> <span class="nf">dummy</span><span class="p">(</span><span class="kt">int</span> <span class="n">x</span><span class="p">)</span>
<span class="p">{</span>
    <span class="n">x</span><span class="o">+=</span><span class="mh">0x100</span><span class="p">;</span>
    <span class="k">return</span> <span class="n">x</span><span class="p">;</span>
<span class="p">}</span>
 
<span class="kt">int</span> <span class="nf">main</span><span class="p">(</span><span class="kt">int</span> <span class="n">shitArg</span><span class="p">)</span>
<span class="p">{</span>
    <span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">ver_</span><span class="o">=</span><span class="n">GetVersion</span><span class="p">();</span>
    <span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">major</span><span class="o">=</span><span class="n">ver_</span><span class="o">&amp;</span><span class="mh">0xFF</span><span class="p">;</span>
    <span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">minor</span><span class="o">=</span><span class="p">(</span><span class="n">ver_</span><span class="o">&gt;&gt;</span><span class="mh">0x8</span><span class="p">)</span><span class="o">&amp;</span><span class="mh">0xFF</span><span class="p">;</span>
    <span class="k">if</span><span class="p">(</span><span class="n">major</span><span class="o">==</span><span class="mh">0x05</span> <span class="o">&amp;</span> <span class="n">minor</span><span class="o">==</span><span class="mh">0x01</span><span class="p">)</span> <span class="c1">//Windows XP</span>
    <span class="p">{</span>
        <span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">x</span><span class="o">=</span><span class="mi">0</span><span class="p">;</span>
        <span class="kr">__asm</span>
        <span class="p">{</span>
            <span class="n">push</span> <span class="n">offset</span> <span class="n">Handler</span>
            <span class="n">push</span> <span class="n">dword</span> <span class="n">ptr</span> <span class="n">fs</span><span class="o">:</span><span class="p">[</span><span class="mh">0x0</span><span class="p">]</span>
            <span class="n">mov</span> <span class="n">dword</span> <span class="n">ptr</span> <span class="n">fs</span><span class="o">:</span><span class="p">[</span><span class="mh">0x0</span><span class="p">],</span><span class="n">esp</span>
            <span class="n">STI</span><span class="p">;</span> <span class="n">Triggers</span> <span class="n">an</span> <span class="n">exception</span><span class="p">(</span><span class="n">privileged</span> <span class="n">instruction</span><span class="p">)</span>
        <span class="p">}</span>
        <span class="n">dummy</span><span class="p">(</span><span class="mh">0xFF</span><span class="p">);</span>
        <span class="kr">__asm</span>
        <span class="p">{</span>
            <span class="n">pop</span> <span class="n">dword</span> <span class="n">ptr</span> <span class="n">fs</span><span class="o">:</span><span class="p">[</span><span class="mh">0x0</span><span class="p">]</span>
            <span class="n">pop</span> <span class="n">ebx</span>
        <span class="p">}</span>
        <span class="n">MessageBox</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span><span class="s">"Virtual PC 2007 detected (XP)"</span><span class="p">,</span><span class="s">"waliedassar"</span><span class="p">,</span><span class="mi">0</span><span class="p">);</span>
    <span class="p">}</span>
    <span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span></code></pre></figure>

<hr class="space" />

<p><b>Code sample (variant 3, resetting VirtualPC)</b></p>
<p></p>

<figure class="highlight"><pre><code class="language-c" data-lang="c"><span class="c1">// Taken here: https://pastebin.com/exAK5XQx</span>
<span class="c1">// http://waleedassar.blogspot.com (@waleedassar)</span>
<span class="c1">// Executing "\x0F\xC7\xC8\x05\x00" in VirtualPC 2007 triggers a reset error.</span>
<span class="cp">#include</span> <span class="cpf">"stdafx.h"</span><span class="cp">
#include</span> <span class="cpf">"windows.h"</span><span class="cp">
#include</span> <span class="cpf">"stdio.h"</span><span class="cp">
</span> 
<span class="n">bool</span> <span class="n">flag</span><span class="o">=</span><span class="nb">false</span><span class="p">;</span>
 
<span class="kt">int</span> <span class="kr">__cdecl</span> <span class="nf">Handler</span><span class="p">(</span><span class="n">EXCEPTION_RECORD</span><span class="o">*</span> <span class="n">pRec</span><span class="p">,</span><span class="kt">void</span><span class="o">*</span> <span class="n">est</span><span class="p">,</span><span class="kt">unsigned</span> <span class="kt">char</span><span class="o">*</span> <span class="n">pContext</span><span class="p">,</span><span class="kt">void</span><span class="o">*</span> <span class="n">disp</span><span class="p">)</span>
<span class="p">{</span>
    <span class="k">if</span><span class="p">(</span><span class="n">pRec</span><span class="o">-&gt;</span><span class="n">ExceptionCode</span><span class="o">==</span><span class="mh">0xC000001D</span>  <span class="o">||</span> <span class="n">pRec</span><span class="o">-&gt;</span><span class="n">ExceptionCode</span><span class="o">==</span><span class="mh">0xC000001E</span> <span class="o">||</span> <span class="n">pRec</span><span class="o">-&gt;</span><span class="n">ExceptionCode</span><span class="o">==</span><span class="mh">0xC0000005</span><span class="p">)</span>
    <span class="p">{</span>
        <span class="n">flag</span><span class="o">=</span><span class="nb">true</span><span class="p">;</span>
        <span class="p">(</span><span class="o">*</span><span class="p">(</span><span class="kt">unsigned</span> <span class="kt">long</span><span class="o">*</span><span class="p">)(</span><span class="n">pContext</span><span class="o">+</span><span class="mh">0xB8</span><span class="p">))</span><span class="o">+=</span><span class="mi">5</span><span class="p">;</span>
        <span class="k">return</span> <span class="n">ExceptionContinueExecution</span><span class="p">;</span>
    <span class="p">}</span>
    <span class="k">return</span> <span class="n">ExceptionContinueSearch</span><span class="p">;</span>
<span class="p">}</span>
 
<span class="kt">int</span> <span class="nf">main</span><span class="p">(</span><span class="kt">int</span> <span class="n">argc</span><span class="p">,</span> <span class="kt">char</span><span class="o">*</span> <span class="n">argv</span><span class="p">[])</span>
<span class="p">{</span>
    <span class="kr">__asm</span>
    <span class="p">{</span>
        <span class="n">push</span> <span class="n">offset</span> <span class="n">Handler</span>
        <span class="n">push</span> <span class="n">dword</span> <span class="n">ptr</span> <span class="n">fs</span><span class="o">:</span><span class="p">[</span><span class="mh">0x0</span><span class="p">]</span>
        <span class="n">mov</span> <span class="n">dword</span> <span class="n">ptr</span> <span class="n">fs</span><span class="o">:</span><span class="p">[</span><span class="mh">0x0</span><span class="p">],</span><span class="n">esp</span>
    <span class="p">}</span>
    <span class="n">flag</span><span class="o">=</span><span class="nb">false</span><span class="p">;</span>
    <span class="kr">__asm</span>
    <span class="p">{</span>
        <span class="n">__emit</span> <span class="mh">0x0F</span>
        <span class="n">__emit</span> <span class="mh">0xC7</span>
        <span class="n">__emit</span> <span class="mh">0xC8</span>
        <span class="n">__emit</span> <span class="mh">0x05</span>
        <span class="n">__emit</span> <span class="mh">0x00</span>
    <span class="p">}</span>
    <span class="k">if</span><span class="p">(</span><span class="n">flag</span><span class="o">==</span><span class="nb">false</span><span class="p">)</span>
    <span class="p">{</span>
        <span class="n">MessageBox</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span><span class="s">"VirtualPC detected"</span><span class="p">,</span><span class="s">"waliedassar"</span><span class="p">,</span><span class="mi">0</span><span class="p">);</span>
    <span class="p">}</span>
    <span class="kr">__asm</span>
    <span class="p">{</span>
        <span class="n">pop</span> <span class="n">dword</span> <span class="n">ptr</span> <span class="n">fs</span><span class="o">:</span><span class="p">[</span><span class="mh">0x0</span><span class="p">]</span>
        <span class="n">pop</span> <span class="n">eax</span>
    <span class="p">}</span>
    <span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span></code></pre></figure>

<p><br /></p>
<h3><a class="a-dummy" name="detecting-environment-via-in-backdoor-port-vmware">6. Detecting environment via IN instruction - backdoor port (VMware only)</a></h3>

<p><a href="https://sites.google.com/site/chitchatvmback/backdoor">This article</a> explains why backdoor port communication is used in VMware in the first place.</p>

<hr class="space" />

<p><b>Code sample (variant 1)</b></p>
<p></p>

<figure class="highlight"><pre><code class="language-c" data-lang="c"><span class="n">bool</span> <span class="n">VMWare</span><span class="o">::</span><span class="n">CheckHypervisorPort</span><span class="p">()</span> <span class="k">const</span> <span class="p">{</span>
    <span class="n">bool</span> <span class="n">is_vm</span> <span class="o">=</span> <span class="nb">false</span><span class="p">;</span>
    <span class="kr">__try</span> <span class="p">{</span>
        <span class="kr">__asm</span> <span class="p">{</span>
            <span class="n">push</span> <span class="n">edx</span>
            <span class="n">push</span> <span class="n">ecx</span>
            <span class="n">push</span> <span class="n">ebx</span>
            <span class="n">mov</span> <span class="n">eax</span><span class="p">,</span> <span class="err">'</span><span class="n">VMXh</span><span class="err">'</span>
            <span class="n">mov</span> <span class="n">ebx</span><span class="p">,</span> <span class="mi">0</span>
            <span class="n">mov</span> <span class="n">ecx</span><span class="p">,</span> <span class="mi">10</span>
            <span class="n">mov</span> <span class="n">edx</span><span class="p">,</span> <span class="err">'</span><span class="n">VX</span><span class="err">'</span>
            <span class="n">in</span> <span class="n">eax</span><span class="p">,</span> <span class="n">dx</span>      <span class="c1">// &lt;- key point is here</span>
            <span class="n">cmp</span> <span class="n">ebx</span><span class="p">,</span> <span class="err">'</span><span class="n">VMXh</span><span class="err">'</span>
            <span class="n">setz</span><span class="p">[</span><span class="n">is_vm</span><span class="p">]</span>
            <span class="n">pop</span> <span class="n">ebx</span>
            <span class="n">pop</span> <span class="n">ecx</span>
            <span class="n">pop</span> <span class="n">edx</span>
        <span class="p">}</span>
    <span class="p">}</span> 
    <span class="kr">__except</span> <span class="p">(</span><span class="n">EXCEPTION_EXECUTE_HANDLER</span><span class="p">)</span> <span class="p">{</span>
        <span class="n">is_vm</span> <span class="o">=</span> <span class="nb">false</span><span class="p">;</span>
    <span class="p">}</span>
    <span class="k">return</span> <span class="n">is_vm</span><span class="p">;</span>
<span class="p">}</span></code></pre></figure>

<hr class="space" />

<p><b>Code sample (variant 2)</b></p>
<p></p>

<figure class="highlight"><pre><code class="language-c" data-lang="c"><span class="n">bool</span> <span class="n">VMWare</span><span class="o">::</span><span class="n">CheckHypervisorPortEnum</span><span class="p">()</span> <span class="k">const</span> <span class="p">{</span>
    <span class="n">bool</span> <span class="n">is_vm</span> <span class="o">=</span> <span class="nb">false</span><span class="p">;</span>
    <span class="kt">short</span> <span class="n">ioports</span><span class="p">[]</span> <span class="o">=</span> <span class="p">{</span> <span class="err">'</span><span class="n">VX</span><span class="err">'</span> <span class="p">,</span> <span class="err">'</span><span class="n">VY</span><span class="err">'</span> <span class="p">};</span>
    <span class="kt">short</span> <span class="n">ioport</span><span class="p">;</span>
    <span class="k">for</span> <span class="p">(</span><span class="kt">short</span> <span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">_countof</span><span class="p">(</span><span class="n">ioports</span><span class="p">);</span> <span class="o">++</span><span class="n">i</span><span class="p">)</span> <span class="p">{</span>
        <span class="n">ioport</span> <span class="o">=</span> <span class="n">ioports</span><span class="p">[</span><span class="n">i</span><span class="p">];</span>
        <span class="k">for</span> <span class="p">(</span><span class="kt">unsigned</span> <span class="kt">char</span> <span class="n">cmd</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">cmd</span> <span class="o">&lt;</span> <span class="mh">0x2c</span><span class="p">;</span> <span class="o">++</span><span class="n">cmd</span><span class="p">)</span> <span class="p">{</span>
            <span class="kr">__try</span> <span class="p">{</span>
                <span class="kr">__asm</span> <span class="p">{</span>
                    <span class="n">push</span> <span class="n">eax</span>
                    <span class="n">push</span> <span class="n">ebx</span>
                    <span class="n">push</span> <span class="n">ecx</span>
                    <span class="n">push</span> <span class="n">edx</span>
                    <span class="n">mov</span> <span class="n">eax</span><span class="p">,</span> <span class="err">'</span><span class="n">VMXh</span><span class="err">'</span>
                    <span class="n">movzx</span> <span class="n">ecx</span><span class="p">,</span> <span class="n">cmd</span>
                    <span class="n">mov</span> <span class="n">dx</span><span class="p">,</span> <span class="n">ioport</span>
                    <span class="n">in</span> <span class="n">eax</span><span class="p">,</span> <span class="n">dx</span>      <span class="c1">// &lt;- key point is here</span>
                    <span class="n">pop</span> <span class="n">edx</span>
                    <span class="n">pop</span> <span class="n">ecx</span>
                    <span class="n">pop</span> <span class="n">ebx</span>
                    <span class="n">pop</span> <span class="n">eax</span>
                <span class="p">}</span>
                <span class="n">is_vm</span> <span class="o">=</span> <span class="nb">true</span><span class="p">;</span>
                <span class="k">break</span><span class="p">;</span>
            <span class="p">}</span>
            <span class="kr">__except</span> <span class="p">(</span><span class="n">EXCEPTION_EXECUTE_HANDLER</span><span class="p">)</span> <span class="p">{}</span>
        <span class="p">}</span>
        <span class="k">if</span> <span class="p">(</span><span class="n">is_vm</span><span class="p">)</span>
            <span class="k">break</span><span class="p">;</span>
    <span class="p">}</span>
    <span class="k">return</span> <span class="n">is_vm</span><span class="p">;</span>
<span class="p">}</span></code></pre></figure>

<hr class="space" />

<p><br /></p>
<h3><a class="a-dummy" name="signature-recommendations">Signature recommendations</a></h3>

<p><i>No signature recommendations are provided for this evasion group as it’s hard to track such a code being executed.</i></p>

<p><br /></p>
<h3><a class="a-dummy" name="countermeasures-sandboxie">Countermeasures</a></h3>

<p>Patch hypervisor. If it proves impossible — due to license issues or something else — patch VM config. Usually undocumented options help.</p>

<ul>
<li>vs <tt>CPUID</tt> instruction: refer to <a href="http://vknowledge.net/2014/04/17/how-to-fake-a-vms-guest-os-cpuid/">this article</a> for the example of such a patch</li> 
<li>vs <tt>IN</tt> instruction (VMware backdoor): take a look at these <a href="https://wasm.in/threads/izmenenie-raboty-backdoor-interfejsa-v-vmware.24564/#post-291532">config changes</a></li> 
</ul>

<p><br /></p>
<h3><a class="a-dummy" name="credits">Credits</a></h3>

<p>Credits go to open-source project from where code samples were taken and to independent researcher who shared his findings:</p>
<ul>
<li>al-khaser project on <a href="https://github.com/LordNoteworthy/al-khaser">github</a></li>
<li><a href="https://twitter.com/waleedassar">@waleedassar</a></li>
</ul>

<p>Though Check Point tool InviZzzible has them all implemented, due to modular structure of the code it would require more space to show a code sample from this tool for the same purposes. That’s why we’ve decided to use other great open-source projects for examples throughout the encyclopedia.</p>

    <br>
    <div style="text-align: left">
        <a href="..">Go back</a>
    </div>
    <br>
    <div class="sharebuttons" style="text-align: center">
        <hr />
        <ul>
          <li>
            <p class="sharetitle"> Share this: </p>
          </li>
          <li class="reddit">
            <a href="http://www.reddit.com/submit?url=https://evasions.checkpoint.com/src/Evasions/techniques/cpu.html&title=Evasions:%20CPU - Evasion Techniques" target="_blank">
                <svg xmlns="http://www.w3.org/2000/svg"
                aria-label="Reddit" role="img"
                viewBox="0 0 512 512"><rect
                width="512" height="512"
                rx="15%"
                fill="#f40"/><g fill="#fff"><ellipse cx="256" cy="307" rx="166" ry="117"/><circle cx="106" cy="256" r="42"/><circle cx="407" cy="256" r="42"/><circle cx="375" cy="114" r="32"/></g><g stroke-linecap="round" stroke-linejoin="round" fill="none"><path d="m256 196 23-101 73 15" stroke="#fff" stroke-width="16"/><path d="m191 359c33 25 97 26 130 0" stroke="#f40" stroke-width="13"/></g><g fill="#f40"><circle cx="191" cy="287" r="31"/><circle cx="321" cy="287" r="31"/></g></svg>
                
            </a>
          </li>
          <li class="hn">
            <a href="http://news.ycombinator.com/submitlink?u=https://evasions.checkpoint.com/src/Evasions/techniques/cpu.html&t=Evasions:%20CPU - Evasion Techniques" target="_blank">
                <svg xmlns="http://www.w3.org/2000/svg"
                aria-label="Hacker News" role="img"
                viewBox="0 0 512 512"><rect
                width="512" height="512"
                rx="15%"
                fill="#f60"/><path fill="#fff" d="M124 91h51l81 162 81-164h51L276 293v136h-40V293z"/></svg>
            </a>
          </li>
          <li class="twitter">
            <a href="https://twitter.com/intent/tweet?via=_CPResearch_&url=https://evasions.checkpoint.com/src/Evasions/techniques/cpu.html&text=Evasions:%20CPU - Evasion Techniques" target="_blank">
                <svg viewBox="0 0 1792 1792" xmlns="http://www.w3.org/2000/svg"><path d="M1684 408q-67 98-162 167 1 14 1 42 0 130-38 259.5t-115.5 248.5-184.5 210.5-258 146-323 54.5q-271 0-496-145 35 4 78 4 225 0 401-138-105-2-188-64.5t-114-159.5q33 5 61 5 43 0 85-11-112-23-185.5-111.5t-73.5-205.5v-4q68 38 146 41-66-44-105-115t-39-154q0-88 44-163 121 149 294.5 238.5t371.5 99.5q-8-38-8-74 0-134 94.5-228.5t228.5-94.5q140 0 236 102 109-21 205-78-37 115-142 178 93-10 186-50z"/></svg>
            </a>
          </li>
          <li class="linkedin">
            <a href=https://www.linkedin.com/shareArticle?mini=true&url=https://evasions.checkpoint.com/src/Evasions/techniques/cpu.html&title=Evasions:%20CPU - Evasion Techniques&source=LinkedIn" target="_blank">
                <svg viewBox="0 0 1792 1792" xmlns="http://www.w3.org/2000/svg"><path d="M477 625v991h-330v-991h330zm21-306q1 73-50.5 122t-135.5 49h-2q-82 0-132-49t-50-122q0-74 51.5-122.5t134.5-48.5 133 48.5 51 122.5zm1166 729v568h-329v-530q0-105-40.5-164.5t-126.5-59.5q-63 0-105.5 34.5t-63.5 85.5q-11 30-11 81v553h-329q2-399 2-647t-1-296l-1-48h329v144h-2q20-32 41-56t56.5-52 87-43.5 114.5-15.5q171 0 275 113.5t104 332.5z"/></svg>
            </a>
          </li>
        </ul>
      </div>
      
</article>


</section>

<nav class="navbar navbar-default navbar-fixed-bottom">
  <div class="container footer-content">

    Made with <font class="a-pink"><i class ="fa fa-heart"></i></font> to serve the community by Check Point Research    |    <a class="a-pink" href="https://research.checkpoint.com">Research blog</a>    |    <a class="a-pink" href="https://research.checkpoint.com/about-us/">About Us</a>    |    <a class="a-pink" href="https://github.com/CheckPointSW"><i class="fa fa-github fa-lg"></i></a> <a class="a-pink" href="https://twitter.com/_CPResearch_"><i class="fa fa-twitter fa-lg"></i></a>
    
    <br>
    
    © 1994-2024 Check Point Software Technologies LTD | All rights reserved | Property of CheckPoint.com


  </div>
</nav>

  </body>

</html>
<!DOCTYPE html>
<html>

  <head>
  <meta charset="utf-8">
  <meta http-equiv="X-UA-Compatible" content="IE=edge">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-194688-3"></script>
  <script>
   window.dataLayer = window.dataLayer || [];
   function gtag(){dataLayer.push(arguments);}
   gtag('js', new Date());
   gtag('config', 'UA-194688-3');
  </script>
  <meta content="Evasion techniques" property="og:site_name">

  <meta content="Evasions: Filesystem" property="og:title">


  <meta name="twitter:title" content="Malware Evasion Encyclopedia" />
  <meta name="twitter:image" content="https://research.checkpoint.com/wp-content/uploads/2020/02/evasions.jpg" />


  <meta content="article" property="og:type">


  <meta content="Evasion techniques
" property="og:description">


  <meta content="https://evasions.checkpoint.com/src/Evasions/techniques/filesystem.html" property="og:url">


  <meta content="2024-07-10T07:20:28+00:00" property="article:published_time">
  <meta content="https://evasions.checkpoint.com/about/" property="article:author">


  <meta property="og:image" content="">


  
  <meta content="evasions" property="article:section">
  


  
  <meta content="filesystem" property="article:tag">
  

  <title>Evasions: Filesystem</title>
  <meta name="description" content="Contents">
<script src="https://ajax.googleapis.com/ajax/libs/jquery/2.2.2/jquery.min.js"></script>
<script src="https://maxcdn.bootstrapcdn.com/bootstrap/3.3.6/js/bootstrap.min.js" integrity="sha384-0mSbJDEHialfmuBBQP6A4Qrprq5OVfW37PRR3j5ELqxss1yVqOtnepnHVP9aJ7xS" crossorigin="anonymous"></script>
  <link rel="stylesheet" href="https://evasions.checkpoint.com/assets/css/main.css">
<script src="https://maxcdn.bootstrapcdn.com/bootstrap/3.3.6/js/bootstrap.min.js" integrity="sha384-0mSbJDEHialfmuBBQP6A4Qrprq5OVfW37PRR3j5ELqxss1yVqOtnepnHVP9aJ7xS" crossorigin="anonymous"></script>

  <link href='https://fonts.googleapis.com/css?family=PT+Sans' rel='stylesheet' type='text/css'>
  <link href='https://fonts.googleapis.com/css?family=Fira+Mono' rel='stylesheet' type='text/css'>
  <link href='https://fonts.googleapis.com/css?family=Lato:400,700' rel='stylesheet' type='text/css'>
  <link href='https://fonts.googleapis.com/css?family=Source+Code+Pro:400,200,300,500,600,700,900' rel='stylesheet' type='text/css'>
  <link href='https://fonts.googleapis.com/css?family=Gentium+Basic:400,700' rel='stylesheet' type='text/css'>
  <link href='https://fonts.googleapis.com/css?family=Alegreya:400,400italic,700' rel='stylesheet' type='text/css'>
  <link href='https://fonts.googleapis.com/css?family=Lora:400,400italic,700' rel='stylesheet' type='text/css'>
  <link href='https://fonts.googleapis.com/css?family=Fira+Sans:400,300,500,700' rel='stylesheet' type='text/css'>
  <script src="https://ajax.googleapis.com/ajax/libs/jquery/2.2.0/jquery.min.js"></script>
  <link href='https://fonts.googleapis.com/css?family=Open+Sans:400,700' rel='stylesheet' type='text/css'>
  <link href="https://maxcdn.bootstrapcdn.com/bootstrap/3.3.6/css/bootstrap.min.css" rel="stylesheet" integrity="sha384-1q8mTJOASx8j1Au+a5WDVnPi2lkFfwwEAa8hDDdjZlpLegxhjVME1fgjWPGmkzs7" crossorigin="anonymous">
  <link href="https://maxcdn.bootstrapcdn.com/font-awesome/4.6.1/css/font-awesome.min.css" rel="stylesheet" integrity="sha384-hQpvDQiCJaD2H465dQfA717v7lu5qHWtDbWNPvaTJ0ID5xnPUlVXnKzq7b8YUkbN" crossorigin="anonymous">
  <link rel="canonical" href="https://evasions.checkpoint.com/src/Evasions/techniques/filesystem.html">
  <link rel="alternate" type="application/rss+xml" title="Evasion techniques" href="https://evasions.checkpoint.com/feed.xml">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/tinysort/2.3.6/tinysort.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/tinysort/2.3.6/tinysort.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/tinysort/2.3.6/tinysort.charorder.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/tinysort/2.3.6/tinysort.charorder.min.js"></script>
  <script type="text/javascript" async src="//platform.twitter.com/widgets.js"></script>




</head>


  <body>
<section>
<article class="post" itemscope itemtype="http://schema.org/BlogPosting">
  <div class="jumbotron">
    <div class="container">
      <h1 class="post-title-main" itemprop="name headline">Evasions: Filesystem</h1>
    </div>
</div>

  <div class="post-content container" itemprop="articleBody">
    <div style="text-align: left">
        <a href="..">Go back</a>
        <br>
        <br>
    </div>
    <h1>Contents</h1>

<p><a href="#filesystem-detection-methods">Filesystem detection methods</a>
<br />
  <a href="#check-if-specific-files-exist">1. Check if specific files exist</a>
<br />
  <a href="#check-if-specific-directories-present">2. Check if specific directories are present</a>
<br />
  <a href="#check-if-full-path-exec">3. Check if full path to the executable contains one of specific strings</a>
<br />
  <a href="#check-if-exec-is-run">4. Check if the executable is run from specific directory</a>
<br />
  <a href="#check-if-exec-files-with-specific-names">5. Check if the executable files with specific names are present in physical disk drives root</a>
<br />
<a href="#countermeasures">Countermeasures</a>
<br />
<a href="#credits">Credits</a>
<br />
<br /></p>

<h2><a class="a-dummy" name="filesystem-detection-methods">Filesystem detection methods</a></h2>
<p>The principle of all the filesystem detection methods is the following: there are no such files and directories in usual host; however they exist in particular virtual environments and sandboxes. Virtual environment may be detected if such an artifact is present.</p>

<p><br /></p>
<h3><a class="a-dummy" name="check-if-specific-files-exist">1. Check if specific files exist</a></h3>

<p>This method uses the difference in files which are present in usual host system and virtual environments. There are quite a few file artifacts present in virtual environments which are specific for such kinds of systems. These files are not present on usual host systems where no virtual environment is installed.</p>

<p>Function used:</p>
<ul>
<li><tt>GetFileAttributes  // if attributes are invalid then no file exists</tt></li> 
</ul>

<hr class="space" />

<p><b>Code sample</b></p>
<p></p>

<figure class="highlight"><pre><code class="language-c" data-lang="c"><span class="n">BOOL</span> <span class="nf">is_FileExists</span><span class="p">(</span><span class="n">TCHAR</span><span class="o">*</span> <span class="n">szPath</span><span class="p">)</span>
<span class="p">{</span>
    <span class="n">DWORD</span> <span class="n">dwAttrib</span> <span class="o">=</span> <span class="n">GetFileAttributes</span><span class="p">(</span><span class="n">szPath</span><span class="p">);</span>
    <span class="k">return</span> <span class="p">(</span><span class="n">dwAttrib</span> <span class="o">!=</span> <span class="n">INVALID_FILE_ATTRIBUTES</span><span class="p">)</span> <span class="o">&amp;&amp;</span> <span class="o">!</span><span class="p">(</span><span class="n">dwAttrib</span> <span class="o">&amp;</span> <span class="n">FILE_ATTRIBUTE_DIRECTORY</span><span class="p">);</span>
<span class="p">}</span>

<span class="cm">/*
Check against some of VMware blacklisted files
*/</span>
<span class="n">VOID</span> <span class="nf">vmware_files</span><span class="p">()</span>
<span class="p">{</span>
    <span class="cm">/* Array of strings of blacklisted paths */</span>
    <span class="n">TCHAR</span><span class="o">*</span> <span class="n">szPaths</span><span class="p">[]</span> <span class="o">=</span> <span class="p">{</span>
        <span class="n">_T</span><span class="p">(</span><span class="s">"system32</span><span class="se">\\</span><span class="s">drivers</span><span class="se">\\</span><span class="s">vmmouse.sys"</span><span class="p">),</span>
        <span class="n">_T</span><span class="p">(</span><span class="s">"system32</span><span class="se">\\</span><span class="s">drivers</span><span class="se">\\</span><span class="s">vmhgfs.sys"</span><span class="p">),</span>
    <span class="p">};</span>
    
    <span class="cm">/* Getting Windows Directory */</span>
    <span class="n">WORD</span> <span class="n">dwlength</span> <span class="o">=</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">szPaths</span><span class="p">)</span> <span class="o">/</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">szPaths</span><span class="p">[</span><span class="mi">0</span><span class="p">]);</span>
    <span class="n">TCHAR</span> <span class="n">szWinDir</span><span class="p">[</span><span class="n">MAX_PATH</span><span class="p">]</span> <span class="o">=</span> <span class="n">_T</span><span class="p">(</span><span class="s">""</span><span class="p">);</span>
    <span class="n">TCHAR</span> <span class="n">szPath</span><span class="p">[</span><span class="n">MAX_PATH</span><span class="p">]</span> <span class="o">=</span> <span class="n">_T</span><span class="p">(</span><span class="s">""</span><span class="p">);</span>
    <span class="n">GetWindowsDirectory</span><span class="p">(</span><span class="n">szWinDir</span><span class="p">,</span> <span class="n">MAX_PATH</span><span class="p">);</span>
    
    <span class="cm">/* Check one by one */</span>
    <span class="k">for</span> <span class="p">(</span><span class="kt">int</span> <span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">dwlength</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span>
    <span class="p">{</span>
        <span class="n">PathCombine</span><span class="p">(</span><span class="n">szPath</span><span class="p">,</span> <span class="n">szWinDir</span><span class="p">,</span> <span class="n">szPaths</span><span class="p">[</span><span class="n">i</span><span class="p">]);</span>
        <span class="n">TCHAR</span> <span class="n">msg</span><span class="p">[</span><span class="mi">256</span><span class="p">]</span> <span class="o">=</span> <span class="n">_T</span><span class="p">(</span><span class="s">""</span><span class="p">);</span>
        <span class="n">_stprintf_s</span><span class="p">(</span><span class="n">msg</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">msg</span><span class="p">)</span> <span class="o">/</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">TCHAR</span><span class="p">),</span> <span class="n">_T</span><span class="p">(</span><span class="s">"Checking file %s: "</span><span class="p">),</span> <span class="n">szPath</span><span class="p">);</span>
        <span class="k">if</span> <span class="p">(</span><span class="n">is_FileExists</span><span class="p">(</span><span class="n">szPath</span><span class="p">))</span>
            <span class="n">print_results</span><span class="p">(</span><span class="n">TRUE</span><span class="p">,</span> <span class="n">msg</span><span class="p">);</span>
        <span class="k">else</span>
            <span class="n">print_results</span><span class="p">(</span><span class="n">FALSE</span><span class="p">,</span> <span class="n">msg</span><span class="p">);</span>
    <span class="p">}</span>
<span class="p">}</span></code></pre></figure>

<p><i>Credits for this code sample: <a href="https://github.com/LordNoteworthy/al-khaser">al-khaser project</a></i></p>

<hr class="space" />

<p><b>Signature recommendations</b></p>
<p></p>
<p>If the following function contains its only argument from the table column <font face="Courier New">`Path`</font>:</p>
<p></p>
<ul>
<li><tt>GetFileAttributes(path)</tt></li> 
</ul>
<p>then it’s an indication of application trying to use the evasion technique.</p>

<hr class="space" />

<p><b>Detections table</b></p>

<table style="width:100%">
  <tr>
  	<td colspan="3">Check if the following files exist:</td>
  </tr>
  <tr>
  	<th style="text-align:center">Detect</th>
  	<th style="text-align:center">Path</th>
  	<th style="text-align:center">Details (if any)</th>
  </tr>
  <tr>
  	<th rowspan="11">[general]</th>
  	<td>c:\[60 random hex symbols]</td>
  	<td>file unique to the PC used for encoding</td>
  </tr>
  <tr>
  	<td>c:\take_screenshot.ps1</td>
  	<td />
  </tr>
  <tr>
  	<td>c:\loaddll.exe</td>
  	<td />
  </tr>
  <tr>
  	<td>c:\email.doc</td>
  	<td />
  </tr>
  <tr>
  	<td>c:\email.htm</td>
  	<td />
  </tr>
  <tr>
  	<td>c:\123\email.doc</td>
  	<td />
  </tr>
  <tr>
  	<td>c:\123\email.docx</td>
  	<td />
  </tr>
  <tr>
  	<td>c:\a\foobar.bmp</td>
  	<td />
  </tr>
  <tr>
  	<td>c:\a\foobar.doc</td>
  	<td />
  </tr>
  <tr>
  	<td>c:\a\foobar.gif</td>
  	<td />
  </tr>
  <tr>
  	<td>c:\symbols\aagmmc.pdb</td>
  	<td />
  </tr>
  <tr>
  	<th rowspan="7">Parallels</th>
  	<td>c:\windows\system32\drivers\prleth.sys</td>
  	<td>Network Adapter</td>
  </tr>
  <tr>
  	<td>c:\windows\system32\drivers\prlfs.sys</td>
  	<td />
  </tr>
  <tr>
  	<td>c:\windows\system32\drivers\prlmouse.sys</td>
  	<td>Mouse Synchronization Tool</td>
  </tr>
  <tr>
  	<td>c:\windows\system32\drivers\prlvideo.sys</td>
  	<td />
  </tr>
  <tr>
  	<td>c:\windows\system32\drivers\prltime.sys</td>
  	<td>Time Synchronization Driver</td>
  </tr>
  <tr>
  	<td>c:\windows\system32\drivers\prl_pv32.sys</td>
  	<td>Paravirtualization Driver</td>
  </tr>
  <tr>
  	<td>c:\windows\system32\drivers\prl_paravirt_32.sys</td>
  	<td>Paravirtualization Driver</td>
  </tr>
  <tr>
  	<th rowspan="17">VirtualBox</th>
  	<td>c:\windows\system32\drivers\VBoxMouse.sys</td>
  	<td />
  </tr>
  <tr>
  	<td>c:\windows\system32\drivers\VBoxGuest.sys</td>
  	<td />
  </tr>
  <tr>
  	<td>c:\windows\system32\drivers\VBoxSF.sys</td>
  	<td />
  </tr>
  <tr>
  	<td>c:\windows\system32\drivers\VBoxVideo.sys</td>
  	<td />
  </tr>
  <tr>
  	<td>c:\windows\system32\vboxdisp.dll</td>
  	<td />
  </tr>
  <tr>
  	<td>c:\windows\system32\vboxhook.dll</td>
  	<td />
  </tr>
  <tr>
  	<td>c:\windows\system32\vboxmrxnp.dll</td>
  	<td />
  </tr>
  <tr>
  	<td>c:\windows\system32\vboxogl.dll</td>
  	<td />
  </tr>
  <tr>
  	<td>c:\windows\system32\vboxoglarrayspu.dll</td>
  	<td />
  </tr>
  <tr>
  	<td>c:\windows\system32\vboxoglcrutil.dll</td>
  	<td />
  </tr>
  <tr>
  	<td>c:\windows\system32\vboxoglerrorspu.dll</td>
  	<td />
  </tr>
  <tr>
  	<td>c:\windows\system32\vboxoglfeedbackspu.dll</td>
  	<td />
  </tr>
  <tr>
  	<td>c:\windows\system32\vboxoglpackspu.dll</td>
  	<td />
  </tr>
  <tr>
  	<td>c:\windows\system32\vboxoglpassthroughspu.dll</td>
  	<td />
  </tr>
  <tr>
  	<td>c:\windows\system32\vboxservice.exe</td>
  	<td />
  </tr>
  <tr>
  	<td>c:\windows\system32\vboxtray.exe</td>
  	<td />
  </tr>
  <tr>
  	<td>c:\windows\system32\VBoxControl.exe</td>
  	<td />
  </tr>
  <tr>
  	<th rowspan="2">VirtualPC</th>
  	<td>c:\windows\system32\drivers\vmsrvc.sys</td>
  	<td></td>
  </tr>
  <tr>
  	<td>c:\windows\system32\drivers\vpc-s3.sys</td>
  	<td></td>
  </tr>
  <tr>
  	<th rowspan="6">VMware</th>
  	<td>c:\windows\system32\drivers\vmmouse.sys</td>
  	<td>Pointing PS/2 Device Driver</td>
  </tr>
  <tr>
  	<td>c:\windows\system32\drivers\vmnet.sys</td>
  	<td></td>
  </tr>
  <tr>
  	<td>c:\windows\system32\drivers\vmxnet.sys</td>
  	<td>PCI Ethernet Adapter</td>
  </tr>
  <tr>
  	<td>c:\windows\system32\drivers\vmhgfs.sys</td>
  	<td>HGFS Filesystem Driver</td>
  </tr>
  <tr>
  	<td>c:\windows\system32\drivers\vmx86.sys</td>
  	<td></td>
  </tr>
  <tr>
  	<td>c:\windows\system32\drivers\hgfs.sys</td>
  	<td></td>
  </tr>
</table>

<p><br /></p>
<h3><a class="a-dummy" name="check-if-specific-directories-present">2. Check if specific directories are present</a></h3>

<p>This method uses the difference in directories which are present in usual host system and virtual environments. There are quite a few directory artifacts present in virtual environments which are specific for such kinds of systems. These directories are not present on usual host systems where no virtual environment is installed.</p>

<p>Function used:</p>
<ul>
<li><tt>GetFileAttributes  // if attributes are invalid then no file exists</tt></li> 
</ul>

<hr class="space" />

<p><b>Code sample</b></p>
<p></p>

<figure class="highlight"><pre><code class="language-c" data-lang="c"><span class="n">BOOL</span> <span class="nf">is_DirectoryExists</span><span class="p">(</span><span class="n">TCHAR</span><span class="o">*</span> <span class="n">szPath</span><span class="p">)</span>
<span class="p">{</span>
    <span class="n">DWORD</span> <span class="n">dwAttrib</span> <span class="o">=</span> <span class="n">GetFileAttributes</span><span class="p">(</span><span class="n">szPath</span><span class="p">);</span>
    <span class="k">return</span> <span class="p">(</span><span class="n">dwAttrib</span> <span class="o">!=</span> <span class="n">INVALID_FILE_ATTRIBUTES</span><span class="p">)</span> <span class="o">&amp;&amp;</span> <span class="p">(</span><span class="n">dwAttrib</span> <span class="o">&amp;</span> <span class="n">FILE_ATTRIBUTE_DIRECTORY</span><span class="p">);</span>
<span class="p">}</span>

<span class="cm">/*
Check against VMware blacklisted directory
*/</span>
<span class="n">BOOL</span> <span class="nf">vmware_dir</span><span class="p">()</span>
<span class="p">{</span>
    <span class="n">TCHAR</span> <span class="n">szProgramFile</span><span class="p">[</span><span class="n">MAX_PATH</span><span class="p">];</span>
    <span class="n">TCHAR</span> <span class="n">szPath</span><span class="p">[</span><span class="n">MAX_PATH</span><span class="p">]</span> <span class="o">=</span> <span class="n">_T</span><span class="p">(</span><span class="s">""</span><span class="p">);</span>
    <span class="n">TCHAR</span> <span class="n">szTarget</span><span class="p">[</span><span class="n">MAX_PATH</span><span class="p">]</span> <span class="o">=</span> <span class="n">_T</span><span class="p">(</span><span class="s">"VMware</span><span class="se">\\</span><span class="s">"</span><span class="p">);</span>
    <span class="k">if</span> <span class="p">(</span><span class="n">IsWoW64</span><span class="p">())</span>
        <span class="n">ExpandEnvironmentStrings</span><span class="p">(</span><span class="n">_T</span><span class="p">(</span><span class="s">"%ProgramW6432%"</span><span class="p">),</span> <span class="n">szProgramFile</span><span class="p">,</span> <span class="n">ARRAYSIZE</span><span class="p">(</span><span class="n">szProgramFile</span><span class="p">));</span>
    <span class="k">else</span>
        <span class="n">SHGetSpecialFolderPath</span><span class="p">(</span><span class="nb">NULL</span><span class="p">,</span> <span class="n">szProgramFile</span><span class="p">,</span> <span class="n">CSIDL_PROGRAM_FILES</span><span class="p">,</span> <span class="n">FALSE</span><span class="p">);</span>
    <span class="n">PathCombine</span><span class="p">(</span><span class="n">szPath</span><span class="p">,</span> <span class="n">szProgramFile</span><span class="p">,</span> <span class="n">szTarget</span><span class="p">);</span>
    <span class="k">return</span> <span class="n">is_DirectoryExists</span><span class="p">(</span><span class="n">szPath</span><span class="p">);</span>
<span class="p">}</span></code></pre></figure>

<p><i>Credits for this code sample: <a href="https://github.com/LordNoteworthy/al-khaser">al-khaser project</a> </i></p>

<hr class="space" />

<p><b>Signature recommendations</b></p>
<p></p>
<p>If the following function contains its only argument from the table column <font face="Courier New">`Path`</font>:</p>
<p></p>
<ul>
<li><tt>GetFileAttributes(path)</tt></li> 
</ul>
<p>then it’s an indication of application trying to use the evasion technique.</p>

<hr class="space" />

<p><b>Detections table</b></p>

<table style="width:62%">
  <tr>
  	<td colspan="3">Check if the following files exist:</td>
  </tr>
  <tr>
  	<th style="text-align:center">Detect</th>
  	<th style="text-align:center">Path</th>
  </tr>
  <tr>
  	<th>CWSandbox</th>
  	<td>c:\analysis</td>
  </tr>
  <tr>
  	<th>VirtualBox</th>
  	<td>%PROGRAMFILES%\oracle\virtualbox guest additions\</td>
  </tr>
  <tr>
  	<th>VMware</th>
  	<td>%PROGRAMFILES%\VMware\</td>
  </tr>
</table>

<p><br /></p>
<h3><a class="a-dummy" name="check-if-full-path-exec">3. Check if full path to the executable contains one of the specific strings</a></h3>

<p>This method relies on peculiarities of launching executables inside virtual environments. Some environments launch executables from specific paths - and malware samples check these paths.</p>

<p>Functions used to get executable path:</p>
<ul>
<li><tt>GetModuleFileName</tt></li>
<li><tt>GetProcessImageFileNameA/W</tt></li>
<li><tt>QueryFullProcessImageName</tt></li>
</ul>

<hr class="space" />

<p><b>Code sample (function GetModuleFileName)</b></p>
<p></p>

<figure class="highlight"><pre><code class="language-c" data-lang="c"><span class="kt">int</span> <span class="nf">gensandbox_path</span><span class="p">()</span> <span class="p">{</span>
    <span class="kt">char</span> <span class="n">path</span><span class="p">[</span><span class="mi">500</span><span class="p">];</span>
    <span class="kt">size_t</span> <span class="n">i</span><span class="p">;</span>
    <span class="n">DWORD</span> <span class="n">pathsize</span> <span class="o">=</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">path</span><span class="p">);</span>

    <span class="n">GetModuleFileName</span><span class="p">(</span><span class="nb">NULL</span><span class="p">,</span> <span class="n">path</span><span class="p">,</span> <span class="n">pathsize</span><span class="p">);</span>

    <span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">strlen</span><span class="p">(</span><span class="n">path</span><span class="p">);</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span> <span class="cm">/* case-insensitive */</span>
        <span class="n">path</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="n">toupper</span><span class="p">(</span><span class="n">path</span><span class="p">[</span><span class="n">i</span><span class="p">]);</span>
    <span class="p">}</span>

    <span class="c1">// some sample values from the table</span>
    <span class="k">if</span> <span class="p">(</span><span class="n">strstr</span><span class="p">(</span><span class="n">path</span><span class="p">,</span> <span class="s">"</span><span class="se">\\</span><span class="s">SAMPLE"</span><span class="p">)</span> <span class="o">!=</span> <span class="nb">NULL</span><span class="p">)</span> <span class="p">{</span>
        <span class="k">return</span> <span class="n">TRUE</span><span class="p">;</span>
    <span class="p">}</span>
    <span class="k">if</span> <span class="p">(</span><span class="n">strstr</span><span class="p">(</span><span class="n">path</span><span class="p">,</span> <span class="s">"</span><span class="se">\\</span><span class="s">VIRUS"</span><span class="p">)</span> <span class="o">!=</span> <span class="nb">NULL</span><span class="p">)</span> <span class="p">{</span>
        <span class="k">return</span> <span class="n">TRUE</span><span class="p">;</span>
    <span class="p">}</span>
    <span class="k">if</span> <span class="p">(</span><span class="n">strstr</span><span class="p">(</span><span class="n">path</span><span class="p">,</span> <span class="s">"SANDBOX"</span><span class="p">)</span> <span class="o">!=</span> <span class="nb">NULL</span><span class="p">)</span> <span class="p">{</span>
        <span class="k">return</span> <span class="n">TRUE</span><span class="p">;</span>
    <span class="p">}</span>

    <span class="k">return</span> <span class="n">FALSE</span><span class="p">;</span>
<span class="p">}</span></code></pre></figure>

<p><i>Credits for this code sample: <a href="https://github.com/a0rtega/pafish">pafish project</a> </i></p>

<hr class="space" />

<p><b>Code sample (function QueryFullProcessImageName)</b></p>
<p></p>

<figure class="highlight"><pre><code class="language-c" data-lang="c"><span class="n">DWORD</span> <span class="n">PID</span> <span class="o">=</span> <span class="mi">1337</span><span class="p">;</span> <span class="c1">// process ID of the target process</span>
<span class="n">HANDLE</span> <span class="n">hProcess</span> <span class="o">=</span> <span class="n">OpenProcess</span><span class="p">(</span><span class="n">PROCESS_QUERY_INFORMATION</span><span class="p">,</span> <span class="nb">false</span><span class="p">,</span> <span class="n">PID</span><span class="p">);</span>
<span class="n">DWORD</span> <span class="n">value</span> <span class="o">=</span> <span class="n">MAX_PATH</span><span class="p">;</span>
<span class="kt">char</span> <span class="n">buffer</span><span class="p">[</span><span class="n">MAX_PATH</span><span class="p">];</span>
<span class="n">QueryFullProcessImageName</span><span class="p">(</span><span class="n">hProcess</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="n">buffer</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">value</span><span class="p">);</span>
<span class="n">printf</span><span class="p">(</span><span class="s">"EXE Path: %s</span><span class="se">\n</span><span class="s">"</span><span class="p">,</span> <span class="n">buffer</span><span class="p">);</span></code></pre></figure>

<hr class="space" />

<p><b>No signature recommendations</b></p>
<p></p>
<p>Signature recommendations are not provided as it’s hard to say why exactly application wants to get its full path. Function calls may be hooked - and that’s it, just general recommendation.</p>

<hr class="space" />

<p><b>Detections table</b></p>

<table style="width:62%">
  <tr>
  	<td colspan="3">Check if full path to the executable contains one of the following strings:</td>
  </tr>
  <tr>
  	<th style="text-align:center">Detect</th>
  	<th style="text-align:center">String</th>
  </tr>
  <tr>
  	<th rowspan="3">[general]</th>
  	<td>\sample</td>
  </tr>
  <tr>
  	<td>\virus</td>
  </tr>
  <tr>
  	<td>sandbox</td>
  </tr>
</table>

<p><br /></p>
<h3><a class="a-dummy" name="check-if-exec-is-run">4. Check if the executable is run from specific directory</a></h3>

<p>This method relies on peculiarities of launching executables inside virtual environments. Some environments launch executables from specific directories - and malware samples check these directories.</p>

<p>It’s just a particular case of checking presence of specific strings in full application path, please refer to the <a href="#check-if-full-path-exec">section above</a> for code sample and signature recommendations.</p>

<p>As this very method is pretty old and is not commonly used, the links to external sources are provided for the reference on this method:</p>
<ul>
<li>VB <a href="https://www.opensc.io/showthread.php?t=2343">code sample</a></li> 
<li>python <a href="https://github.com/brad-accuvant/community-modified/blob/master/modules/signatures/antisandbox_joe_anubis_files.py">code sample</a></li> 
<li>anti-emulation <a href="http://web.archive.org/web/20181222042516/www.woodmann.com/forum/showthread.php?12545-Anti-Emulation-Tricks">tricks</a></li> 
<li>stub for <a href="http://web.archive.org/web/20101026233743/http://evilcry.netsons.org/OC0/code/EmulationAwareness.c">C code</a></li> 
</ul>

<hr class="space" />

<p><b>Detections table</b></p>

<table style="width:62%">
  <tr>
  	<td colspan="3">Check if the executable is run from the following directories:</td>
  </tr>
  <tr>
  	<th style="text-align:center">Detect</th>
  	<th style="text-align:center">Path</th>
  </tr>
  <tr>
  	<th>Anubis</th>
  	<td>c:\insidetm</td>
  </tr>
</table>

<p><br /></p>
<h3><a class="a-dummy" name="check-if-exec-files-with-specific-names">5. Check if the executable files with specific names are present in physical disk drives' root</a></h3>

<p>This method relies on peculiarities of virtual environments, in this case it’s presence of specific files in disk root root directories.</p>

<p>Function used:</p>
<ul>
<li><tt>GetFileAttributes  // if attributes are invalid then no file exists</tt></li> 
</ul>

<hr class="space" />

<p><b>Code sample (function GetModuleFileName)<b></b></b></p>
<p></p>

<figure class="highlight"><pre><code class="language-c" data-lang="c"><span class="kt">int</span> <span class="nf">pafish_exists_file</span><span class="p">(</span><span class="kt">char</span> <span class="o">*</span> <span class="n">filename</span><span class="p">)</span> <span class="p">{</span>
    <span class="n">DWORD</span> <span class="n">res</span> <span class="o">=</span> <span class="n">INVALID_FILE_ATTRIBUTES</span><span class="p">;</span>
    <span class="k">if</span> <span class="p">(</span><span class="n">pafish_iswow64</span><span class="p">()</span> <span class="o">==</span> <span class="n">TRUE</span><span class="p">)</span> <span class="p">{</span>
        <span class="kt">void</span> <span class="o">*</span><span class="n">old</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
        <span class="c1">// Disable redirection immediately prior to calling GetFileAttributes.</span>
        <span class="k">if</span> <span class="p">(</span><span class="n">pafish_disable_wow64_fs_redirection</span><span class="p">(</span><span class="o">&amp;</span><span class="n">old</span><span class="p">)</span> <span class="p">)</span> <span class="p">{</span>
            <span class="n">res</span> <span class="o">=</span> <span class="n">GetFileAttributes</span><span class="p">(</span><span class="n">filename</span><span class="p">);</span>
            <span class="c1">// Ignoring MSDN recommendation of exiting if this call fails.</span>
            <span class="n">pafish_revert_wow64_fs_redirection</span><span class="p">(</span><span class="n">old</span><span class="p">);</span>
        <span class="p">}</span>
    <span class="p">}</span>
    <span class="k">else</span> <span class="p">{</span>
        <span class="n">res</span> <span class="o">=</span> <span class="n">GetFileAttributes</span><span class="p">(</span><span class="n">filename</span><span class="p">);</span>
    <span class="p">}</span>
    <span class="k">return</span> <span class="p">(</span><span class="n">res</span> <span class="o">!=</span> <span class="n">INVALID_FILE_ATTRIBUTES</span><span class="p">)</span> <span class="o">?</span> <span class="n">TRUE</span> <span class="o">:</span> <span class="n">FALSE</span><span class="p">;</span>
<span class="p">}</span>

<span class="kt">int</span> <span class="nf">gensandbox_common_names</span><span class="p">()</span> <span class="p">{</span>
    <span class="n">DWORD</span> <span class="n">dwSize</span> <span class="o">=</span> <span class="n">MAX_PATH</span><span class="p">;</span>
    <span class="kt">char</span> <span class="n">szLogicalDrives</span><span class="p">[</span><span class="n">MAX_PATH</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span><span class="mi">0</span><span class="p">};</span>
    <span class="n">DWORD</span> <span class="n">dwResult</span> <span class="o">=</span> <span class="n">GetLogicalDriveStrings</span><span class="p">(</span><span class="n">dwSize</span><span class="p">,</span><span class="n">szLogicalDrives</span><span class="p">);</span>
    <span class="n">BOOL</span> <span class="n">exists</span><span class="p">;</span>

    <span class="k">if</span> <span class="p">(</span><span class="n">dwResult</span> <span class="o">&gt;</span> <span class="mi">0</span> <span class="o">&amp;&amp;</span> <span class="n">dwResult</span> <span class="o">&lt;=</span> <span class="n">MAX_PATH</span><span class="p">)</span>
    <span class="p">{</span>
        <span class="kt">char</span><span class="o">*</span> <span class="n">szSingleDrive</span> <span class="o">=</span> <span class="n">szLogicalDrives</span><span class="p">;</span>
        <span class="kt">char</span> <span class="n">filename</span><span class="p">[</span><span class="n">MAX_PATH</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span><span class="mi">0</span><span class="p">};</span>
        <span class="k">while</span><span class="p">(</span><span class="o">*</span><span class="n">szSingleDrive</span><span class="p">)</span>
        <span class="p">{</span>
            <span class="k">if</span> <span class="p">(</span><span class="n">GetDriveType</span><span class="p">(</span><span class="n">szSingleDrive</span><span class="p">)</span> <span class="o">!=</span> <span class="n">DRIVE_REMOVABLE</span> <span class="p">)</span> <span class="p">{</span>
                <span class="n">snprintf</span><span class="p">(</span><span class="n">filename</span><span class="p">,</span> <span class="n">MAX_PATH</span><span class="p">,</span> <span class="s">"%ssample.exe"</span><span class="p">,</span><span class="n">szSingleDrive</span><span class="p">);</span>
                <span class="n">exists</span> <span class="o">=</span> <span class="n">pafish_exists_file</span><span class="p">(</span><span class="n">filename</span><span class="p">);</span>
                <span class="k">if</span> <span class="p">(</span><span class="n">exists</span><span class="p">)</span> <span class="k">return</span> <span class="n">TRUE</span><span class="p">;</span>
                
                <span class="n">snprintf</span><span class="p">(</span><span class="n">filename</span><span class="p">,</span> <span class="n">MAX_PATH</span><span class="p">,</span> <span class="s">"%smalware.exe"</span><span class="p">,</span><span class="n">szSingleDrive</span><span class="p">);</span>
                <span class="n">exists</span> <span class="o">=</span> <span class="n">pafish_exists_file</span><span class="p">(</span><span class="n">filename</span><span class="p">);</span>
                <span class="k">if</span> <span class="p">(</span><span class="n">exists</span><span class="p">)</span> <span class="k">return</span> <span class="n">TRUE</span><span class="p">;</span>
            <span class="p">}</span>

            <span class="n">szSingleDrive</span> <span class="o">+=</span> <span class="n">strlen</span><span class="p">(</span><span class="n">szSingleDrive</span><span class="p">)</span> <span class="o">+</span> <span class="mi">1</span><span class="p">;</span>
        <span class="p">}</span>
    <span class="p">}</span>

    <span class="k">return</span> <span class="n">FALSE</span><span class="p">;</span>
<span class="p">}</span></code></pre></figure>

<p><i>Credits for this code sample: <a href="https://github.com/a0rtega/pafish">pafish project</a></i></p>

<hr class="space" />

<p><b>Signature recommendations</b></p>
<p></p>
<p>If the following function contains its only argument from the table column <font face="Courier New">`Path`</font>:</p>
<p></p>
<ul>
<li><tt>GetFileAttributes(path)</tt></li> 
</ul>
<p>then it’s an indication of application trying to use the evasion technique.</p>

<hr class="space" />

<p><b>Detections table</b></p>

<table style="width:62%">
  <tr>
  	<td colspan="2">Check if the executables with particular names are present in disk root:</td>
  </tr>
  <tr>
  	<th style="text-align:center">Detect</th>
  	<th style="text-align:center">Path</th>
  </tr>
  <tr>
  	<th rowspan="2">[general]</th>
  	<td>malware.exe</td>
  </tr>
  <tr>
  	<td>sample.exe</td>
  </tr>
</table>

<p><br /></p>
<h3><a class="a-dummy" name="countermeasures">Countermeasures</a></h3>

<p>Hook target functions and return appropriate results if indicators (files from tables) are checked.</p>

<p><br /></p>
<h3><a class="a-dummy" name="credits">Credits</a></h3>

<p>Credits go to open-source projects from where code samples were taken:</p>
<ul>
<li>al-khaser project on <a href="https://github.com/LordNoteworthy/al-khaser">github</a></li>
<li>pafish project on <a href="https://github.com/a0rtega/pafish">github</a></li>
</ul>

<p>Though Check Point tool InviZzzible has them all implemented, due to modular structure of the code it would require more space to show a code sample from this tool for the same purposes. That’s why we’ve decided to use other great open-source projects for examples throughout the encyclopedia.</p>


    <br>
    <div style="text-align: left">
        <a href="..">Go back</a>
    </div>
    <br>
    <div class="sharebuttons" style="text-align: center">
        <hr />
        <ul>
          <li>
            <p class="sharetitle"> Share this: </p>
          </li>
          <li class="reddit">
            <a href="http://www.reddit.com/submit?url=https://evasions.checkpoint.com/src/Evasions/techniques/filesystem.html&title=Evasions:%20Filesystem - Evasion Techniques" target="_blank">
                <svg xmlns="http://www.w3.org/2000/svg"
                aria-label="Reddit" role="img"
                viewBox="0 0 512 512"><rect
                width="512" height="512"
                rx="15%"
                fill="#f40"/><g fill="#fff"><ellipse cx="256" cy="307" rx="166" ry="117"/><circle cx="106" cy="256" r="42"/><circle cx="407" cy="256" r="42"/><circle cx="375" cy="114" r="32"/></g><g stroke-linecap="round" stroke-linejoin="round" fill="none"><path d="m256 196 23-101 73 15" stroke="#fff" stroke-width="16"/><path d="m191 359c33 25 97 26 130 0" stroke="#f40" stroke-width="13"/></g><g fill="#f40"><circle cx="191" cy="287" r="31"/><circle cx="321" cy="287" r="31"/></g></svg>
                
            </a>
          </li>
          <li class="hn">
            <a href="http://news.ycombinator.com/submitlink?u=https://evasions.checkpoint.com/src/Evasions/techniques/filesystem.html&t=Evasions:%20Filesystem - Evasion Techniques" target="_blank">
                <svg xmlns="http://www.w3.org/2000/svg"
                aria-label="Hacker News" role="img"
                viewBox="0 0 512 512"><rect
                width="512" height="512"
                rx="15%"
                fill="#f60"/><path fill="#fff" d="M124 91h51l81 162 81-164h51L276 293v136h-40V293z"/></svg>
            </a>
          </li>
          <li class="twitter">
            <a href="https://twitter.com/intent/tweet?via=_CPResearch_&url=https://evasions.checkpoint.com/src/Evasions/techniques/filesystem.html&text=Evasions:%20Filesystem - Evasion Techniques" target="_blank">
                <svg viewBox="0 0 1792 1792" xmlns="http://www.w3.org/2000/svg"><path d="M1684 408q-67 98-162 167 1 14 1 42 0 130-38 259.5t-115.5 248.5-184.5 210.5-258 146-323 54.5q-271 0-496-145 35 4 78 4 225 0 401-138-105-2-188-64.5t-114-159.5q33 5 61 5 43 0 85-11-112-23-185.5-111.5t-73.5-205.5v-4q68 38 146 41-66-44-105-115t-39-154q0-88 44-163 121 149 294.5 238.5t371.5 99.5q-8-38-8-74 0-134 94.5-228.5t228.5-94.5q140 0 236 102 109-21 205-78-37 115-142 178 93-10 186-50z"/></svg>
            </a>
          </li>
          <li class="linkedin">
            <a href=https://www.linkedin.com/shareArticle?mini=true&url=https://evasions.checkpoint.com/src/Evasions/techniques/filesystem.html&title=Evasions:%20Filesystem - Evasion Techniques&source=LinkedIn" target="_blank">
                <svg viewBox="0 0 1792 1792" xmlns="http://www.w3.org/2000/svg"><path d="M477 625v991h-330v-991h330zm21-306q1 73-50.5 122t-135.5 49h-2q-82 0-132-49t-50-122q0-74 51.5-122.5t134.5-48.5 133 48.5 51 122.5zm1166 729v568h-329v-530q0-105-40.5-164.5t-126.5-59.5q-63 0-105.5 34.5t-63.5 85.5q-11 30-11 81v553h-329q2-399 2-647t-1-296l-1-48h329v144h-2q20-32 41-56t56.5-52 87-43.5 114.5-15.5q171 0 275 113.5t104 332.5z"/></svg>
            </a>
          </li>
        </ul>
      </div>
      
</article>


</section>

<nav class="navbar navbar-default navbar-fixed-bottom">
  <div class="container footer-content">

    Made with <font class="a-pink"><i class ="fa fa-heart"></i></font> to serve the community by Check Point Research    |    <a class="a-pink" href="https://research.checkpoint.com">Research blog</a>    |    <a class="a-pink" href="https://research.checkpoint.com/about-us/">About Us</a>    |    <a class="a-pink" href="https://github.com/CheckPointSW"><i class="fa fa-github fa-lg"></i></a> <a class="a-pink" href="https://twitter.com/_CPResearch_"><i class="fa fa-twitter fa-lg"></i></a>
    
    <br>
    
    © 1994-2024 Check Point Software Technologies LTD | All rights reserved | Property of CheckPoint.com


  </div>
</nav>

  </body>

</html>
<!DOCTYPE html>
<html>

  <head>
  <meta charset="utf-8">
  <meta http-equiv="X-UA-Compatible" content="IE=edge">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-194688-3"></script>
  <script>
   window.dataLayer = window.dataLayer || [];
   function gtag(){dataLayer.push(arguments);}
   gtag('js', new Date());
   gtag('config', 'UA-194688-3');
  </script>
  <meta content="Evasion techniques" property="og:site_name">

  <meta content="Evasions: Firmware tables" property="og:title">


  <meta name="twitter:title" content="Malware Evasion Encyclopedia" />
  <meta name="twitter:image" content="https://research.checkpoint.com/wp-content/uploads/2020/02/evasions.jpg" />


  <meta content="article" property="og:type">


  <meta content="Evasion techniques
" property="og:description">


  <meta content="https://evasions.checkpoint.com/src/Evasions/techniques/firmware-tables.html" property="og:url">


  <meta content="2024-07-10T07:20:28+00:00" property="article:published_time">
  <meta content="https://evasions.checkpoint.com/about/" property="article:author">


  <meta property="og:image" content="">


  
  <meta content="evasions" property="article:section">
  


  
  <meta content="firmware-tables" property="article:tag">
  

  <title>Evasions: Firmware tables</title>
  <meta name="description" content="Contents">
<script src="https://ajax.googleapis.com/ajax/libs/jquery/2.2.2/jquery.min.js"></script>
<script src="https://maxcdn.bootstrapcdn.com/bootstrap/3.3.6/js/bootstrap.min.js" integrity="sha384-0mSbJDEHialfmuBBQP6A4Qrprq5OVfW37PRR3j5ELqxss1yVqOtnepnHVP9aJ7xS" crossorigin="anonymous"></script>
  <link rel="stylesheet" href="https://evasions.checkpoint.com/assets/css/main.css">
<script src="https://maxcdn.bootstrapcdn.com/bootstrap/3.3.6/js/bootstrap.min.js" integrity="sha384-0mSbJDEHialfmuBBQP6A4Qrprq5OVfW37PRR3j5ELqxss1yVqOtnepnHVP9aJ7xS" crossorigin="anonymous"></script>

  <link href='https://fonts.googleapis.com/css?family=PT+Sans' rel='stylesheet' type='text/css'>
  <link href='https://fonts.googleapis.com/css?family=Fira+Mono' rel='stylesheet' type='text/css'>
  <link href='https://fonts.googleapis.com/css?family=Lato:400,700' rel='stylesheet' type='text/css'>
  <link href='https://fonts.googleapis.com/css?family=Source+Code+Pro:400,200,300,500,600,700,900' rel='stylesheet' type='text/css'>
  <link href='https://fonts.googleapis.com/css?family=Gentium+Basic:400,700' rel='stylesheet' type='text/css'>
  <link href='https://fonts.googleapis.com/css?family=Alegreya:400,400italic,700' rel='stylesheet' type='text/css'>
  <link href='https://fonts.googleapis.com/css?family=Lora:400,400italic,700' rel='stylesheet' type='text/css'>
  <link href='https://fonts.googleapis.com/css?family=Fira+Sans:400,300,500,700' rel='stylesheet' type='text/css'>
  <script src="https://ajax.googleapis.com/ajax/libs/jquery/2.2.0/jquery.min.js"></script>
  <link href='https://fonts.googleapis.com/css?family=Open+Sans:400,700' rel='stylesheet' type='text/css'>
  <link href="https://maxcdn.bootstrapcdn.com/bootstrap/3.3.6/css/bootstrap.min.css" rel="stylesheet" integrity="sha384-1q8mTJOASx8j1Au+a5WDVnPi2lkFfwwEAa8hDDdjZlpLegxhjVME1fgjWPGmkzs7" crossorigin="anonymous">
  <link href="https://maxcdn.bootstrapcdn.com/font-awesome/4.6.1/css/font-awesome.min.css" rel="stylesheet" integrity="sha384-hQpvDQiCJaD2H465dQfA717v7lu5qHWtDbWNPvaTJ0ID5xnPUlVXnKzq7b8YUkbN" crossorigin="anonymous">
  <link rel="canonical" href="https://evasions.checkpoint.com/src/Evasions/techniques/firmware-tables.html">
  <link rel="alternate" type="application/rss+xml" title="Evasion techniques" href="https://evasions.checkpoint.com/feed.xml">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/tinysort/2.3.6/tinysort.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/tinysort/2.3.6/tinysort.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/tinysort/2.3.6/tinysort.charorder.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/tinysort/2.3.6/tinysort.charorder.min.js"></script>
  <script type="text/javascript" async src="//platform.twitter.com/widgets.js"></script>




</head>


  <body>
<section>
<article class="post" itemscope itemtype="http://schema.org/BlogPosting">
  <div class="jumbotron">
    <div class="container">
      <h1 class="post-title-main" itemprop="name headline">Evasions: Firmware tables</h1>
    </div>
</div>

  <div class="post-content container" itemprop="articleBody">
    <div style="text-align: left">
        <a href="..">Go back</a>
        <br>
        <br>
    </div>
    <h1>Contents</h1>

<p><a href="#firmware-tables-detection-methods">Firmware tables detection methods</a>
<br />
  <a href="#check-specific-strings-in-raw-firmware-table">1. Check if specific strings are present in Raw Firmware Table</a>
<br />
  <a href="#check-specific-strings-in-raw-firmware-table-vista">1.1. Windows Vista+</a>
<br />
  <a href="#check-specific-strings-in-raw-firmware-table-xp">1.2. Windows XP</a>
<br />
  <a href="#check-specific-strings-in-raw-smbios-firmware-table">2. Check if specific strings are present in Raw SMBIOS Firmware Table</a>
<br />
  <a href="#check-specific-strings-in-raw-smbios-firmware-table-vista">2.1. Windows Vista+</a>
<br />
  <a href="#check-specific-strings-in-raw-smbios-firmware-table-xp">2.2. Windows XP</a>
<br />
  <a href="#countermeasures">Countermeasures</a>
<br />
  <a href="#credits">Credits</a>
<br />
<br /></p>

<hr class="space" />

<h2><a class="a-dummy" name="firmware-tables-detection-methods">Firmware tables detection methods</a></h2>
<p>There are special memory areas used by OS which contain specific artifacts if OS is run under virtual environment. These memory areas may be dumped using different methods depending on the OS version.</p>

<hr class="space" />

<p>Firmware tables are retrieved via <tt>SYSTEM_FIRMWARE_TABLE_INFORMATION</tt> object. It’s defined the following way:</p>
<p></p>

<figure class="highlight"><pre><code class="language-c" data-lang="c"><span class="k">typedef</span> <span class="k">struct</span> <span class="n">_SYSTEM_FIRMWARE_TABLE_INFORMATION</span> <span class="p">{</span>
    <span class="n">ULONG</span> <span class="n">ProviderSignature</span><span class="p">;</span>
    <span class="n">SYSTEM_FIRMWARE_TABLE_ACTION</span> <span class="n">Action</span><span class="p">;</span>
    <span class="n">ULONG</span> <span class="n">TableID</span><span class="p">;</span>
    <span class="n">ULONG</span> <span class="n">TableBufferLength</span><span class="p">;</span>
    <span class="n">UCHAR</span> <span class="n">TableBuffer</span><span class="p">[</span><span class="n">ANYSIZE_ARRAY</span><span class="p">];</span>  <span class="c1">// &lt;- the result will reside in this field</span>
<span class="p">}</span> <span class="n">SYSTEM_FIRMWARE_TABLE_INFORMATION</span><span class="p">,</span> <span class="o">*</span><span class="n">PSYSTEM_FIRMWARE_TABLE_INFORMATION</span><span class="p">;</span>

<span class="c1">// helper enum</span>
<span class="k">typedef</span> <span class="k">enum</span> <span class="n">_SYSTEM_FIRMWARE_TABLE_ACTION</span>
<span class="p">{</span>
    <span class="n">SystemFirmwareTable_Enumerate</span><span class="p">,</span>
    <span class="n">SystemFirmwareTable_Get</span>
<span class="p">}</span> <span class="n">SYSTEM_FIRMWARE_TABLE_ACTION</span><span class="p">,</span> <span class="o">*</span><span class="n">PSYSTEM_FIRMWARE_TABLE_ACTION</span><span class="p">;</span></code></pre></figure>

<p><br /></p>
<h3><a class="a-dummy" name="check-specific-strings-in-raw-firmware-table">1. Check if specific strings are present in Raw Firmware Table</a></h3>
<p>Retrieved firmware table is scanned for the presence of particular strings.</p>

<hr class="space" />

<p><i>Depending on Windows version different functions are used for this check. See code samples below.</i></p>

<p><br /></p>
<h4><a class="a-dummy" name="check-specific-strings-in-raw-firmware-table-vista">1.1. Windows Vista+</a></h4>

<p><b>Code sample</b></p>
<p></p>

<figure class="highlight"><pre><code class="language-c" data-lang="c"><span class="c1">// First, SYSTEM_FIRMWARE_TABLE_INFORMATION object is initialized in the following way:</span>
<span class="n">SYSTEM_FIRMWARE_TABLE_INFORMATION</span> <span class="o">*</span><span class="n">sfti</span> <span class="o">=</span> 
    <span class="p">(</span><span class="n">PSYSTEM_FIRMWARE_TABLE_INFORMATION</span><span class="p">)</span><span class="n">HeapAlloc</span><span class="p">(</span><span class="n">GetProcessHeap</span><span class="p">(),</span> <span class="n">HEAP_ZERO_MEMORY</span><span class="p">,</span> <span class="n">Length</span><span class="p">);</span>
<span class="n">sfti</span><span class="o">-&gt;</span><span class="n">Action</span> <span class="o">=</span> <span class="n">SystemFirmwareTable_Get</span><span class="p">;</span>  <span class="c1">// 1</span>
<span class="n">sfti</span><span class="o">-&gt;</span><span class="n">ProviderSignature</span> <span class="o">=</span> <span class="err">'</span><span class="n">FIRM</span><span class="err">'</span><span class="p">;</span>
<span class="n">sfti</span><span class="o">-&gt;</span><span class="n">TableID</span> <span class="o">=</span> <span class="mh">0xC0000</span><span class="p">;</span>
<span class="n">sfti</span><span class="o">-&gt;</span><span class="n">TableBufferLength</span> <span class="o">=</span> <span class="n">Length</span><span class="p">;</span>

<span class="c1">// Then initialized SYSTEM_FIRMWARE_TABLE_INFORMATION object is used as an argument for</span>
<span class="c1">// the system information call in the following way in order to dump raw firmware table:</span>
<span class="n">NtQuerySystemInformation</span><span class="p">(</span>
    <span class="n">SystemFirmwareTableInformation</span><span class="p">,</span>  <span class="c1">// 76 </span>
    <span class="n">sfti</span><span class="p">,</span>
    <span class="n">Length</span><span class="p">,</span>
    <span class="o">&amp;</span><span class="n">Length</span><span class="p">);</span></code></pre></figure>

<p><i>Credits for this code sample: <a href="https://github.com/hfiref0x/VMDE">VMDE project</a> </i></p>

<hr class="space" />

<p><b>Signature recommendations</b></p>
<p></p>
<p>If the function</p>
<ul>
<li><tt>NtQuerySystemInformation</tt></li>
</ul>
<p>contains:</p>
<ul>
<li>1st argument equal to 76 (SystemFirmwareTableInformation)</li> 
<li>2nd argument has <tt>sfti-&gt;ProviderSignature</tt> field initialized to 'FIRM' and <tt>sfti-&gt;Action</tt> field initialized to 1</li> 
</ul>
<p>then it’s an indication of application trying to use this evasion technique.</p>

<hr class="space" />

<p><br /></p>
<h4><a class="a-dummy" name="check-specific-strings-in-raw-firmware-table-xp">1.2. Windows XP</a></h4>

<p><b>Code sample</b></p>
<p></p>

<figure class="highlight"><pre><code class="language-c" data-lang="c"><span class="c1">// In case if OS version is Vista+ csrss.exe memory space is read in order to dump raw firmware table:</span>
<span class="n">hCSRSS</span> <span class="o">=</span> <span class="n">OpenProcess</span><span class="p">(</span><span class="n">PROCESS_QUERY_INFORMATION</span> <span class="o">|</span> <span class="n">PROCESS_VM_READ</span><span class="p">,</span> <span class="n">FALSE</span><span class="p">,</span> <span class="n">csrss_pid</span><span class="p">);</span>

<span class="n">NtReadVirtualMemory</span><span class="p">(</span> 
     <span class="n">hCSRSS</span><span class="p">,</span> 
     <span class="mh">0xC0000</span><span class="p">,</span>
     <span class="n">sfti</span><span class="p">,</span> 
     <span class="n">RegionSize</span><span class="p">,</span> 
     <span class="o">&amp;</span><span class="n">memIO</span><span class="p">);</span></code></pre></figure>

<hr class="space" />

<p><b>Signature recommendations</b></p>
<p></p>
<p>If the following function contains PID of <tt>csrss.exe</tt> process as its 3rd argument:</p>
<ul>
<li><tt>HANDLE hCSRSS = OpenProcess(..., csrss_pid)</tt></li>
</ul>
<p>and is followed by the call to the following function:</p>
<ul>
<li><tt>NtReadVirtualMemory(hCSRSS, 0xC0000, ...)</tt></li>
</ul>
<p>which contains:</p>
<ul>
<li>1st argument equal to <tt>csrss.exe</tt> handle</li> 
<li>2nd argument equal to <tt>0xC0000</tt></li> 
</ul>
<p>then it’s an indication of application trying to use this evasion technique.</p>

<hr class="space" />

<h3>Detections table</h3>

<table style="width:60%">
  <tr>
    <td colspan="2">Check if the following strings are present in Raw Firmware Table:</td>
  </tr>
  <tr>
    <th style="text-align:center">Detect</th>
    <th style="text-align:center">String</th>
  </tr>
  <tr>
    <th>Parallels</th>
    <td>Parallels(R)</td>
  </tr>
  <tr>
  	<th rowspan="3">VirtualBox</th>
    <td>Innotek</td>
  </tr>
  <tr>
    <td>Oracle</td>
  </tr>
  <tr>
    <td>VirtualBox</td>
  </tr>
  <tr>
    <th>VirtualPC</th>
    <td>S3 Corp.</td>
  </tr>
  <tr>
    <th>VMware</th>
    <td>VMware</td>
  </tr>
</table>

<p><br /></p>
<h3><a class="a-dummy" name="check-specific-strings-in-raw-smbios-firmware-table">2. Check if specific strings are present in Raw SMBIOS Firmware Table</a></h3>
<p>Retrieved firmware table is scanned for the presence of particular strings.</p>

<hr class="space" />

<p><i>Depending on Windows version different functions are used for this check. See code samples below.</i></p>

<p><br /></p>
<h4><a class="a-dummy" name="check-specific-strings-in-raw-smbios-firmware-table-vista">2.1. Windows Vista+</a></h4>

<p><b>Code sample</b></p>
<p></p>

<figure class="highlight"><pre><code class="language-c" data-lang="c"><span class="c1">// SYSTEM_FIRMWARE_TABLE_INFORMATION object is initialized in the following way:</span>
<span class="n">SYSTEM_FIRMWARE_TABLE_INFORMATION</span> <span class="o">*</span><span class="n">sfti</span> <span class="o">=</span> 
    <span class="p">(</span><span class="n">PSYSTEM_FIRMWARE_TABLE_INFORMATION</span><span class="p">)</span><span class="n">HeapAlloc</span><span class="p">(</span><span class="n">GetProcessHeap</span><span class="p">(),</span> <span class="n">HEAP_ZERO_MEMORY</span><span class="p">,</span> <span class="n">Length</span><span class="p">);</span>
<span class="n">sfti</span><span class="o">-&gt;</span><span class="n">Action</span> <span class="o">=</span> <span class="n">SystemFirmwareTable_Get</span><span class="p">;</span> <span class="c1">// 1</span>
<span class="n">sfti</span><span class="o">-&gt;</span><span class="n">ProviderSignature</span> <span class="o">=</span> <span class="err">'</span><span class="n">RSMB</span><span class="err">'</span><span class="p">;</span>
<span class="n">sfti</span><span class="o">-&gt;</span><span class="n">TableID</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
<span class="n">sfti</span><span class="o">-&gt;</span><span class="n">TableBufferLength</span> <span class="o">=</span> <span class="n">Length</span><span class="p">;</span>

<span class="c1">// Then initialized SYSTEM_FIRMWARE_TABLE_INFORMATION object is used as an argument for</span>
<span class="c1">// the system information call in the following way in order to dump raw firmware table:</span>
<span class="n">NtQuerySystemInformation</span><span class="p">(</span>
    <span class="n">SystemFirmwareTableInformation</span><span class="p">,</span>  <span class="c1">// 76 </span>
    <span class="n">sfti</span><span class="p">,</span>
    <span class="n">Length</span><span class="p">,</span>
    <span class="o">&amp;</span><span class="n">Length</span><span class="p">);</span></code></pre></figure>

<p><i>Credits for this code sample: <a href="https://github.com/hfiref0x/VMDE">VMDE project</a> </i></p>

<hr class="space" />

<p><b>Signature recommendations</b></p>
<p></p>
<p>If the following function:</p>
<ul>
<li><tt>NtQuerySystemInformation</tt></li>
</ul>
<p>contains:</p>
<ul>
<li>1st argument equal to 76 (SystemFirmwareTableInformation)</li>
<li>2nd argument has <tt>sfti-&gt;ProviderSignature</tt> field initialized to 'RSMB' and <tt>sfti-&gt;Action</tt> field initialized to 1</li>
</ul>
<p>then it’s an indication of application trying to use this evasion technique.</p>

<hr class="space" />

<p><br /></p>
<h4><a class="a-dummy" name="check-specific-strings-in-raw-smbios-firmware-table-xp">2.2. Windows XP</a></h4>

<p><b>Code sample</b></p>
<p></p>

<figure class="highlight"><pre><code class="language-c" data-lang="c"><span class="c1">// In case if OS version is Vista+ csrss.exe memory space is read in order to dump raw firmware table:</span>
<span class="n">hCSRSS</span> <span class="o">=</span> <span class="n">OpenProcess</span><span class="p">(</span><span class="n">PROCESS_QUERY_INFORMATION</span> <span class="o">|</span> <span class="n">PROCESS_VM_READ</span><span class="p">,</span> <span class="n">FALSE</span><span class="p">,</span> <span class="n">csrss_pid</span><span class="p">);</span>

<span class="n">NtReadVirtualMemory</span><span class="p">(</span> 
     <span class="n">hCSRSS</span><span class="p">,</span> 
     <span class="mh">0xE0000</span><span class="p">,</span>
     <span class="n">sfti</span><span class="p">,</span> 
     <span class="n">RegionSize</span><span class="p">,</span> 
     <span class="o">&amp;</span><span class="n">memIO</span><span class="p">);</span></code></pre></figure>

<hr class="space" />

<p><b>Signature recommendations</b></p>
<p></p>
<p>If the following function contains PID of <tt>csrss.exe</tt> process as its 3rd argument:</p>
<ul>
<li><tt>HANDLE hCSRSS = OpenProcess(..., csrss_pid)</tt></li>
</ul>
<p>and is followed by the call to the following function:</p>
<ul>
<li><tt>NtReadVirtualMemory(hCSRSS, 0xE0000, ...)</tt></li>
</ul>
<p>which contains:</p>
<ul>
<li>1st argument equal to <tt>csrss.exe</tt> handle</li> 
<li>2nd argument equal to <tt>0xE0000</tt></li> 
</ul>
<p>then it’s an indication of application trying to use this evasion technique.</p>

<hr class="space" />

<h3>Detections table</h3>

<table style="width:60%">
  <tr>
    <td colspan="2">Check if the following strings are present in Raw SMBIOS Firmware Table:</td>
  </tr>
  <tr>
    <th style="text-align:center">Detect</th>
    <th style="text-align:center">String</th>
  </tr>
  <tr>
    <th>Parallels</th>
    <td>Parallels Software International</td>
  </tr>
  <tr>
  	<th rowspan="3">VirtualBox</th>
    <td>Innotek</td>
  </tr>
  <tr>
    <td>Oracle</td>
  </tr>
  <tr>
    <td>VirtualBox</td>
  </tr>
  <tr>
    <th>VirtualPC</th>
    <td>VS2005R2</td>
  </tr>
  <tr>
    <th rowspan="2">VMware</th>
    <td>VMware, Inc.</td>
  </tr>
  <tr>
    <td>VMware</td>
  </tr>
</table>

<p><br /></p>
<h3><a class="a-dummy" name="countermeasures">Countermeasures</a></h3>

<ul>
<li>On systems older than Vista change memory content of <tt>csrss.exe</tt> at given addresses.</li> 
<li>On Vista+ OS hook <tt>NtQuerySystemInformation</tt> for retrieving <tt>SystemFirmwareTableInformation</tt> class and parse <tt>SFTI</tt> structure for provided field values.</li> 
</ul>

<p><br /></p>
<h3><a class="a-dummy" name="credits">Credits</a></h3>

<p>Credits go to open-source project from where code samples were taken:</p>
<ul>
<li>VMDE project on <a href="https://github.com/hfiref0x/VMDE">github</a></li>
</ul>

<p>Though Check Point tool InviZzzible has them all implemented, due to modular structure of the code it would require more space to show a code sample from this tool for the same purposes. That’s why we’ve decided to use other great open-source projects for examples throughout the encyclopedia.</p>

    <br>
    <div style="text-align: left">
        <a href="..">Go back</a>
    </div>
    <br>
    <div class="sharebuttons" style="text-align: center">
        <hr />
        <ul>
          <li>
            <p class="sharetitle"> Share this: </p>
          </li>
          <li class="reddit">
            <a href="http://www.reddit.com/submit?url=https://evasions.checkpoint.com/src/Evasions/techniques/firmware-tables.html&title=Evasions:%20Firmware%20tables - Evasion Techniques" target="_blank">
                <svg xmlns="http://www.w3.org/2000/svg"
                aria-label="Reddit" role="img"
                viewBox="0 0 512 512"><rect
                width="512" height="512"
                rx="15%"
                fill="#f40"/><g fill="#fff"><ellipse cx="256" cy="307" rx="166" ry="117"/><circle cx="106" cy="256" r="42"/><circle cx="407" cy="256" r="42"/><circle cx="375" cy="114" r="32"/></g><g stroke-linecap="round" stroke-linejoin="round" fill="none"><path d="m256 196 23-101 73 15" stroke="#fff" stroke-width="16"/><path d="m191 359c33 25 97 26 130 0" stroke="#f40" stroke-width="13"/></g><g fill="#f40"><circle cx="191" cy="287" r="31"/><circle cx="321" cy="287" r="31"/></g></svg>
                
            </a>
          </li>
          <li class="hn">
            <a href="http://news.ycombinator.com/submitlink?u=https://evasions.checkpoint.com/src/Evasions/techniques/firmware-tables.html&t=Evasions:%20Firmware%20tables - Evasion Techniques" target="_blank">
                <svg xmlns="http://www.w3.org/2000/svg"
                aria-label="Hacker News" role="img"
                viewBox="0 0 512 512"><rect
                width="512" height="512"
                rx="15%"
                fill="#f60"/><path fill="#fff" d="M124 91h51l81 162 81-164h51L276 293v136h-40V293z"/></svg>
            </a>
          </li>
          <li class="twitter">
            <a href="https://twitter.com/intent/tweet?via=_CPResearch_&url=https://evasions.checkpoint.com/src/Evasions/techniques/firmware-tables.html&text=Evasions:%20Firmware%20tables - Evasion Techniques" target="_blank">
                <svg viewBox="0 0 1792 1792" xmlns="http://www.w3.org/2000/svg"><path d="M1684 408q-67 98-162 167 1 14 1 42 0 130-38 259.5t-115.5 248.5-184.5 210.5-258 146-323 54.5q-271 0-496-145 35 4 78 4 225 0 401-138-105-2-188-64.5t-114-159.5q33 5 61 5 43 0 85-11-112-23-185.5-111.5t-73.5-205.5v-4q68 38 146 41-66-44-105-115t-39-154q0-88 44-163 121 149 294.5 238.5t371.5 99.5q-8-38-8-74 0-134 94.5-228.5t228.5-94.5q140 0 236 102 109-21 205-78-37 115-142 178 93-10 186-50z"/></svg>
            </a>
          </li>
          <li class="linkedin">
            <a href=https://www.linkedin.com/shareArticle?mini=true&url=https://evasions.checkpoint.com/src/Evasions/techniques/firmware-tables.html&title=Evasions:%20Firmware%20tables - Evasion Techniques&source=LinkedIn" target="_blank">
                <svg viewBox="0 0 1792 1792" xmlns="http://www.w3.org/2000/svg"><path d="M477 625v991h-330v-991h330zm21-306q1 73-50.5 122t-135.5 49h-2q-82 0-132-49t-50-122q0-74 51.5-122.5t134.5-48.5 133 48.5 51 122.5zm1166 729v568h-329v-530q0-105-40.5-164.5t-126.5-59.5q-63 0-105.5 34.5t-63.5 85.5q-11 30-11 81v553h-329q2-399 2-647t-1-296l-1-48h329v144h-2q20-32 41-56t56.5-52 87-43.5 114.5-15.5q171 0 275 113.5t104 332.5z"/></svg>
            </a>
          </li>
        </ul>
      </div>
      
</article>


</section>

<nav class="navbar navbar-default navbar-fixed-bottom">
  <div class="container footer-content">

    Made with <font class="a-pink"><i class ="fa fa-heart"></i></font> to serve the community by Check Point Research    |    <a class="a-pink" href="https://research.checkpoint.com">Research blog</a>    |    <a class="a-pink" href="https://research.checkpoint.com/about-us/">About Us</a>    |    <a class="a-pink" href="https://github.com/CheckPointSW"><i class="fa fa-github fa-lg"></i></a> <a class="a-pink" href="https://twitter.com/_CPResearch_"><i class="fa fa-twitter fa-lg"></i></a>
    
    <br>
    
    © 1994-2024 Check Point Software Technologies LTD | All rights reserved | Property of CheckPoint.com


  </div>
</nav>

  </body>

</html>
<!DOCTYPE html>
<html>

  <head>
  <meta charset="utf-8">
  <meta http-equiv="X-UA-Compatible" content="IE=edge">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-194688-3"></script>
  <script>
   window.dataLayer = window.dataLayer || [];
   function gtag(){dataLayer.push(arguments);}
   gtag('js', new Date());
   gtag('config', 'UA-194688-3');
  </script>
  <meta content="Evasion techniques" property="og:site_name">

  <meta content="Evasions: Generic OS queries" property="og:title">


  <meta name="twitter:title" content="Malware Evasion Encyclopedia" />
  <meta name="twitter:image" content="https://research.checkpoint.com/wp-content/uploads/2020/02/evasions.jpg" />


  <meta content="article" property="og:type">


  <meta content="Evasion techniques
" property="og:description">


  <meta content="https://evasions.checkpoint.com/src/Evasions/techniques/generic-os-queries.html" property="og:url">


  <meta content="2024-07-10T07:20:28+00:00" property="article:published_time">
  <meta content="https://evasions.checkpoint.com/about/" property="article:author">


  <meta property="og:image" content="">


  
  <meta content="evasions" property="article:section">
  


  
  <meta content="generic-os-queries" property="article:tag">
  

  <title>Evasions: Generic OS queries</title>
  <meta name="description" content="Contents">
<script src="https://ajax.googleapis.com/ajax/libs/jquery/2.2.2/jquery.min.js"></script>
<script src="https://maxcdn.bootstrapcdn.com/bootstrap/3.3.6/js/bootstrap.min.js" integrity="sha384-0mSbJDEHialfmuBBQP6A4Qrprq5OVfW37PRR3j5ELqxss1yVqOtnepnHVP9aJ7xS" crossorigin="anonymous"></script>
  <link rel="stylesheet" href="https://evasions.checkpoint.com/assets/css/main.css">
<script src="https://maxcdn.bootstrapcdn.com/bootstrap/3.3.6/js/bootstrap.min.js" integrity="sha384-0mSbJDEHialfmuBBQP6A4Qrprq5OVfW37PRR3j5ELqxss1yVqOtnepnHVP9aJ7xS" crossorigin="anonymous"></script>

  <link href='https://fonts.googleapis.com/css?family=PT+Sans' rel='stylesheet' type='text/css'>
  <link href='https://fonts.googleapis.com/css?family=Fira+Mono' rel='stylesheet' type='text/css'>
  <link href='https://fonts.googleapis.com/css?family=Lato:400,700' rel='stylesheet' type='text/css'>
  <link href='https://fonts.googleapis.com/css?family=Source+Code+Pro:400,200,300,500,600,700,900' rel='stylesheet' type='text/css'>
  <link href='https://fonts.googleapis.com/css?family=Gentium+Basic:400,700' rel='stylesheet' type='text/css'>
  <link href='https://fonts.googleapis.com/css?family=Alegreya:400,400italic,700' rel='stylesheet' type='text/css'>
  <link href='https://fonts.googleapis.com/css?family=Lora:400,400italic,700' rel='stylesheet' type='text/css'>
  <link href='https://fonts.googleapis.com/css?family=Fira+Sans:400,300,500,700' rel='stylesheet' type='text/css'>
  <script src="https://ajax.googleapis.com/ajax/libs/jquery/2.2.0/jquery.min.js"></script>
  <link href='https://fonts.googleapis.com/css?family=Open+Sans:400,700' rel='stylesheet' type='text/css'>
  <link href="https://maxcdn.bootstrapcdn.com/bootstrap/3.3.6/css/bootstrap.min.css" rel="stylesheet" integrity="sha384-1q8mTJOASx8j1Au+a5WDVnPi2lkFfwwEAa8hDDdjZlpLegxhjVME1fgjWPGmkzs7" crossorigin="anonymous">
  <link href="https://maxcdn.bootstrapcdn.com/font-awesome/4.6.1/css/font-awesome.min.css" rel="stylesheet" integrity="sha384-hQpvDQiCJaD2H465dQfA717v7lu5qHWtDbWNPvaTJ0ID5xnPUlVXnKzq7b8YUkbN" crossorigin="anonymous">
  <link rel="canonical" href="https://evasions.checkpoint.com/src/Evasions/techniques/generic-os-queries.html">
  <link rel="alternate" type="application/rss+xml" title="Evasion techniques" href="https://evasions.checkpoint.com/feed.xml">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/tinysort/2.3.6/tinysort.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/tinysort/2.3.6/tinysort.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/tinysort/2.3.6/tinysort.charorder.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/tinysort/2.3.6/tinysort.charorder.min.js"></script>
  <script type="text/javascript" async src="//platform.twitter.com/widgets.js"></script>




</head>


  <body>
<section>
<article class="post" itemscope itemtype="http://schema.org/BlogPosting">
  <div class="jumbotron">
    <div class="container">
      <h1 class="post-title-main" itemprop="name headline">Evasions: Generic OS queries</h1>
    </div>
</div>

  <div class="post-content container" itemprop="articleBody">
    <div style="text-align: left">
        <a href="..">Go back</a>
        <br>
        <br>
    </div>
    <h1>Contents</h1>

<p><a href="#generic-os-queries">Generic OS queries</a>
<br />
  <a href="#check-if-username-is-specific">1. Check if the username is specific</a>
<br />
  <a href="#check-if-computer-name-is-specific">2. Check if the computer name is specific</a>
<br />
  <a href="#check-if-host-name-is-specific">3. Check if the host name is specific</a>
<br />
  <a href="#check-if-total-ram-is-low">4. Check if the total RAM is low</a>
<br />
  <a href="#check-if-screen-res">5. Check if the screen resolution is non-usual for host OS</a>
<br />
  <a href="#check-if-number-of-processors">6. Check if the number of processors is low</a>
<br />
  <a href="#check-if-quantity-of-monitors">7. Check if the quantity of monitors is small</a>
<br />
  <a href="#check-if-hard-disk">8. Check if the hard disk drive size and free space are small</a>
<br />
  <a href="#check-if-system-uptime">9. Check if the system uptime is small</a>
<br />
  <a href="#check-if-os-was-boot-from-virtual-disk">10. Check if the OS was boot from virtual hard disk (Win8+)</a>
<br />
<a href="#countermeasures">Countermeasures</a>
<br />
<a href="#credits">Credits</a>
<br />
<br /></p>

<h3>Signature recommendations are general</h3>
<p>Signature recommendations are general for each technique: hook the function used and track if it is called. It’s pretty hard to tell why application wants to get user name, for example. It doesn’t necessarily mean applying evasion technique. So the best what can be done in this situation is intercepting target functions and tracking their calls.</p>

<p><br /></p>
<h2><a class="a-dummy" name="generic-os-queries">Detection via generic OS checks</a></h2>

<p>Usual hosts have meaningful and non-standard usernames/computer names. Particular virtual environments assign some predefined names to default users as well as computer names.
Other differences between host OS and VMs include RAM size, HDD size, quantity of monitors - and so on.
While these may be not the most reliable ways to detect virtual environments, they are still commonly used in malware samples.</p>

<p><br /></p>
<h3><a class="a-dummy" name="check-if-username-is-specific">1. Check if the username is specific</a></h3>

<p>Please note that checks are not case-sensitive.</p>

<p>Function used:</p>
<ul>
<li><tt>GetUserNameA/W</tt></li> 
</ul>

<hr class="space" />

<p><b>Code sample</b></p>
<p></p>

<figure class="highlight"><pre><code class="language-c" data-lang="c"><span class="n">bool</span> <span class="nf">is_user_name_match</span><span class="p">(</span><span class="k">const</span> <span class="n">std</span><span class="o">::</span><span class="n">string</span> <span class="o">&amp;</span><span class="n">s</span><span class="p">)</span> <span class="p">{</span>
    <span class="k">auto</span> <span class="n">out_length</span> <span class="o">=</span> <span class="n">MAX_PATH</span><span class="p">;</span>
    <span class="n">std</span><span class="o">::</span><span class="n">vector</span><span class="o">&lt;</span><span class="kt">uint8_t</span><span class="o">&gt;</span> <span class="n">user_name</span><span class="p">(</span><span class="n">out_length</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
    <span class="o">::</span><span class="n">GetUserNameA</span><span class="p">((</span><span class="n">LPSTR</span><span class="p">)</span><span class="n">user_name</span><span class="p">.</span><span class="n">data</span><span class="p">(),</span> <span class="p">(</span><span class="n">LPDWORD</span><span class="p">)</span><span class="o">&amp;</span><span class="n">out_length</span><span class="p">);</span>

    <span class="k">return</span> <span class="p">(</span><span class="o">!</span><span class="n">lstrcmpiA</span><span class="p">((</span><span class="n">LPCSTR</span><span class="p">)</span><span class="n">user_name</span><span class="p">.</span><span class="n">data</span><span class="p">(),</span> <span class="n">s</span><span class="p">.</span><span class="n">c_str</span><span class="p">()));</span>
<span class="p">}</span></code></pre></figure>

<p><i>Code sample is taken from <a href="https://github.com/CheckPointSW/InviZzzible">InviZzzible tool</a> </i></p>

<hr class="space" />

<p><b>Countermeasures</b></p>
<p></p>
<p>Change user name to non-suspicious one.</p>
<p></p>

<hr class="space" />

<p><b>Detections table</b></p>

<table style="width:62%">
  <tr>
  	<td colspan="2">Check if username is one of the following:</td>
  </tr>
  <tr>
  	<th style="text-align:center">Detect</th>
  	<th style="text-align:center">String</th>
  </tr>
  <tr>
  	<th rowspan="16">[general]</th>
  	<td>admin</td>
  </tr>
  <tr>
  	<td>andy</td>
  </tr>
  <tr>
  	<td>honey</td>
  </tr>
  <tr>
  	<td>john</td>
  </tr>
  <tr>
  	<td>john doe</td>
  </tr>
  <tr>
  	<td>malnetvm</td>
  </tr>
  <tr>
  	<td>maltest</td>
  </tr>
  <tr>
  	<td>malware</td>
  </tr>
  <tr>
  	<td>roo</td>
  </tr>
  <tr>
  	<td>sandbox</td>
  </tr>
  <tr>
  	<td>snort</td>
  </tr>
  <tr>
  	<td>tequilaboomboom</td>
  </tr>
  <tr>
  	<td>test</td>
  </tr>
  <tr>
  	<td>virus</td>
  </tr>
  <tr>
  	<td>virusclone</td>
  </tr>
  <tr>
  	<td>wilbert</td>
  </tr>
  <tr>
  	<th rowspan="1">Nepenthes</th>
  	<td>nepenthes</td>
  </tr>
  <tr>
  	<th rowspan="1">Norman</th>
  	<td>currentuser</td>
  </tr>
  <tr>
  	<th rowspan="1">ThreatExpert</th>
  	<td>username</td>
  </tr>
  <tr>
  	<th rowspan="1">Sandboxie</th>
  	<td>user</td>
  </tr>
  <tr>
  	<th rowspan="1">VMware</th>
  	<td>vmware</td>
  </tr>
</table>

<p><br /></p>
<h3><a class="a-dummy" name="check-if-computer-name-is-specific">2. Check if the computer name is specific</a></h3>

<p>Please note that checks are not case-sensitive.</p>

<p>Function used:</p>
<ul>
<li><tt>GetComputerNameA/W</tt></li>
</ul>

<hr class="space" />

<p><b>Code sample</b></p>
<p></p>

<figure class="highlight"><pre><code class="language-c" data-lang="c"><span class="n">bool</span> <span class="nf">is_computer_name_match</span><span class="p">(</span><span class="k">const</span> <span class="n">std</span><span class="o">::</span><span class="n">string</span> <span class="o">&amp;</span><span class="n">s</span><span class="p">)</span> <span class="p">{</span>
    <span class="k">auto</span> <span class="n">out_length</span> <span class="o">=</span> <span class="n">MAX_PATH</span><span class="p">;</span>
    <span class="n">std</span><span class="o">::</span><span class="n">vector</span><span class="o">&lt;</span><span class="kt">uint8_t</span><span class="o">&gt;</span> <span class="n">comp_name</span><span class="p">(</span><span class="n">out_length</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
    <span class="o">::</span><span class="n">GetComputerNameA</span><span class="p">((</span><span class="n">LPSTR</span><span class="p">)</span><span class="n">comp_name</span><span class="p">.</span><span class="n">data</span><span class="p">(),</span> <span class="p">(</span><span class="n">LPDWORD</span><span class="p">)</span><span class="o">&amp;</span><span class="n">out_length</span><span class="p">);</span>

    <span class="k">return</span> <span class="p">(</span><span class="o">!</span><span class="n">lstrcmpiA</span><span class="p">((</span><span class="n">LPCSTR</span><span class="p">)</span><span class="n">comp_name</span><span class="p">.</span><span class="n">data</span><span class="p">(),</span> <span class="n">s</span><span class="p">.</span><span class="n">c_str</span><span class="p">()));</span>
<span class="p">}</span></code></pre></figure>

<p><i>Code sample is taken from <a href="https://github.com/CheckPointSW/InviZzzible">InviZzzible tool</a> </i></p>

<hr class="space" />

<p><b>Countermeasures</b></p>
<p></p>
<p>Change computer name to non-suspicious one.</p>
<p></p>

<hr class="space" />

<p><b>Detections table</b></p>

<table style="width:62%">
  <tr>
  	<td colspan="2">Check if computer name is one of the following:</td>
  </tr>
  <tr>
  	<th style="text-align:center">Detect</th>
  	<th style="text-align:center">String</th>
  </tr>
  <tr>
  	<th rowspan="2">[generic]</th>
  	<td>klone_x64-pc</td>
  </tr>
  <tr>
  	<td>tequilaboomboom</td>
  </tr>

  <tr>
  	<th rowspan="2">Anubis</th>
  	<td>TU-4NH09SMCG1HC</td>
  </tr>
  <tr>
  	<td>InsideTm</td>
  </tr>
</table>

<p><br /></p>
<h3><a class="a-dummy" name="check-if-host-name-is-specific">3. Check if the host name is specific</a></h3>

<p>Please note that checks are not case-sensitive.</p>

<p>Function used:</p>
<ul>
<li><tt>GetComputerNameExA/W</tt></li> 
</ul>

<hr class="space" />

<p><b>Code sample</b></p>
<p></p>

<figure class="highlight"><pre><code class="language-c" data-lang="c"><span class="n">bool</span> <span class="nf">is_host_name_match</span><span class="p">(</span><span class="k">const</span> <span class="n">std</span><span class="o">::</span><span class="n">string</span> <span class="o">&amp;</span><span class="n">s</span><span class="p">)</span> <span class="p">{</span>
    <span class="k">auto</span> <span class="n">out_length</span> <span class="o">=</span> <span class="n">MAX_PATH</span><span class="p">;</span>
    <span class="n">std</span><span class="o">::</span><span class="n">vector</span><span class="o">&lt;</span><span class="kt">uint8_t</span><span class="o">&gt;</span> <span class="n">dns_host_name</span><span class="p">(</span><span class="n">out_length</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
    <span class="o">::</span><span class="n">GetComputerNameExA</span><span class="p">(</span><span class="n">ComputerNameDnsHostname</span><span class="p">,</span> <span class="p">(</span><span class="n">LPSTR</span><span class="p">)</span><span class="n">dns_host_name</span><span class="p">.</span><span class="n">data</span><span class="p">(),</span> <span class="p">(</span><span class="n">LPDWORD</span><span class="p">)</span><span class="o">&amp;</span><span class="n">out_length</span><span class="p">);</span>

    <span class="k">return</span> <span class="p">(</span><span class="o">!</span><span class="n">lstrcmpiA</span><span class="p">((</span><span class="n">LPCSTR</span><span class="p">)</span><span class="n">dns_host_name</span><span class="p">.</span><span class="n">data</span><span class="p">(),</span> <span class="n">s</span><span class="p">.</span><span class="n">c_str</span><span class="p">()));</span>
<span class="p">}</span></code></pre></figure>

<p><i>Code sample is taken from <a href="https://github.com/CheckPointSW/InviZzzible">InviZzzible tool</a> </i></p>

<hr class="space" />

<p><b>Countermeasures</b></p>
<p></p>
<p>Change host name to non-suspicious one.</p>
<p></p>

<hr class="space" />

<p><b>Detections table</b></p>

<table style="width:62%">
  <tr>
  	<td colspan="2">Check if host name is one of the following:</td>
  </tr>
  <tr>
  	<th style="text-align:center">Detect</th>
  	<th style="text-align:center">String</th>
  </tr>
  <tr>
  	<th rowspan="1">[generic]</th>
  	<td>SystemIT</td>
  </tr>
</table>

<p><br /></p>
<h3><a class="a-dummy" name="check-if-total-ram-is-low">4. Check if the total RAM is low</a></h3>

<p>Functions used to get executable path:</p>
<ul>
<li><tt>GetMemoryStatusEx</tt></li>
</ul>

<hr class="space" />

<p><b>Code sample</b></p>
<p></p>

<figure class="highlight"><pre><code class="language-c" data-lang="c"><span class="n">BOOL</span> <span class="nf">memory_space</span><span class="p">()</span>
<span class="p">{</span>
    <span class="n">DWORDLONG</span> <span class="n">ullMinRam</span> <span class="o">=</span> <span class="p">(</span><span class="mi">1024LL</span> <span class="o">*</span> <span class="p">(</span><span class="mi">1024LL</span> <span class="o">*</span> <span class="p">(</span><span class="mi">1024LL</span> <span class="o">*</span> <span class="mi">1LL</span><span class="p">)));</span> <span class="c1">// 1GB</span>
    
    <span class="n">MEMORYSTATUSEX</span> <span class="n">statex</span> <span class="o">=</span> <span class="p">{</span><span class="mi">0</span><span class="p">};</span>
    <span class="n">statex</span><span class="p">.</span><span class="n">dwLength</span> <span class="o">=</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">statex</span><span class="p">);</span>
    <span class="n">GlobalMemoryStatusEx</span><span class="p">(</span><span class="o">&amp;</span><span class="n">statex</span><span class="p">);</span> <span class="c1">// calls NtQuerySystemInformation</span>
    
    <span class="k">return</span> <span class="p">(</span><span class="n">statex</span><span class="p">.</span><span class="n">ullTotalPhys</span> <span class="o">&lt;</span> <span class="n">ullMinRam</span><span class="p">)</span> <span class="o">?</span> <span class="n">TRUE</span> <span class="o">:</span> <span class="n">FALSE</span><span class="p">;</span>
<span class="p">}</span></code></pre></figure>

<p><i>Credits for this code sample: <a href="https://github.com/LordNoteworthy/al-khaser">al-khaser project</a> </i></p>

<hr class="space" />

<p><b>Countermeasures</b></p>
<p></p>
<p>Patch/hook <font face="Courier New">NtQuerySystemInformation</font> to return new number of <font face="Courier New">PhysicalPages</font> in <font face="Courier New">SystemBasicInformation</font>.</p>

<p></p>
<p>Tip: in this case its 1st argument is equal to 2 - SystemPerformanceInformation enum value.</p>

<p></p>
<p>Alternatively, patch <font face="Courier New">NumberOfPhysicalPages</font> in <font face="Courier New">KUSER_SHARED_DATA</font>.</p>
<p></p>

<p><br /></p>
<h3><a class="a-dummy" name="check-if-screen-res">5. Check if the screen resolution is non-usual for host OS</a></h3>

<p>The following set of functions is used:</p>
<ul>
<li><tt>GetDesktopWindow</tt></li>
<li><tt>GetWindowRect</tt></li> 
</ul>

<p>Alternatively:</p>
<ul>
<li><tt>GetSystemMetrics</tt></li>
<li><tt>SystemParametersInfo</tt></li> 
<li><tt>GetMonitorInfo</tt></li> 
</ul>

<hr class="space" />

<p><b>Code sample</b></p>
<p></p>

<p>Take a look at this <a href="https://stackoverflow.com/questions/4631292/how-detect-current-screen-resolution">StackOverflow thread</a>.</p>

<hr class="space" />

<p><b>Countermeasures</b></p>
<p></p>

<p>Change screen resolution for it to match the resolution of usual host (1600x900, for example).</p>

<p><br /></p>
<h3><a class="a-dummy" name="check-if-number-of-processors">6. Check if the number of processors is low</a></h3>

<p>Function used:</p>
<ul>
<li><tt>GetSystemInfo</tt></li>
</ul>

<p>Besides this function numbers of processors can be obtained from PEB, via either asm inline or intrinsic function, see code samples below.
It can be also obtained (ActiveProcessorCount flag) from the KUSER_SHARED_DATA structure.</p>

<hr class="space" />

<p><b>Code sample (variant 1, al-khaser project)</b></p>
<p></p>

<figure class="highlight"><pre><code class="language-c" data-lang="c"><span class="n">BOOL</span> <span class="nf">NumberOfProcessors</span><span class="p">()</span>
<span class="p">{</span>
<span class="cp">#if defined (ENV64BIT)
</span>	<span class="n">PULONG</span> <span class="n">ulNumberProcessors</span> <span class="o">=</span> <span class="p">(</span><span class="n">PULONG</span><span class="p">)(</span><span class="n">__readgsqword</span><span class="p">(</span><span class="mh">0x30</span><span class="p">)</span> <span class="o">+</span> <span class="mh">0xB8</span><span class="p">);</span>
<span class="cp">#elif defined(ENV32BIT)
</span>	<span class="n">PULONG</span> <span class="n">ulNumberProcessors</span> <span class="o">=</span> <span class="p">(</span><span class="n">PULONG</span><span class="p">)(</span><span class="n">__readfsdword</span><span class="p">(</span><span class="mh">0x30</span><span class="p">)</span> <span class="o">+</span> <span class="mh">0x64</span><span class="p">);</span>
<span class="cp">#endif
</span>
    <span class="k">if</span> <span class="p">(</span><span class="o">*</span><span class="n">ulNumberProcessors</span> <span class="o">&lt;</span> <span class="mi">2</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">TRUE</span><span class="p">;</span>
    <span class="k">else</span>
        <span class="k">return</span> <span class="n">FALSE</span><span class="p">;</span>
<span class="p">}</span></code></pre></figure>

<p><i>Credits for this code sample: <a href="https://github.com/LordNoteworthy/al-khaser">al-khaser project</a> </i></p>

<hr class="space" />

<p><b>Code sample (variant 2, al-khaser project, asm inline)</b></p>
<p></p>

<figure class="highlight"><pre><code class="language-c" data-lang="c"><span class="kr">__declspec</span><span class="p">(</span><span class="kr">naked</span><span class="p">)</span>
<span class="n">DWORD</span> <span class="nf">get_number_of_processors</span><span class="p">()</span> <span class="p">{</span>
    <span class="kr">__asm</span> <span class="p">{</span>
        <span class="p">;</span> <span class="n">get</span> <span class="n">pointer</span> <span class="n">to</span> <span class="n">Process</span> <span class="n">Environment</span> <span class="n">Block</span> <span class="p">(</span><span class="n">PEB</span><span class="p">)</span>
        <span class="n">mov</span> <span class="n">eax</span><span class="p">,</span> <span class="n">fs</span><span class="o">:</span><span class="mh">0x30</span>

        <span class="p">;</span> <span class="n">read</span> <span class="n">the</span> <span class="n">field</span> <span class="n">containing</span> <span class="n">target</span> <span class="n">number</span>
        <span class="n">mov</span> <span class="n">eax</span><span class="p">,</span> <span class="p">[</span><span class="n">eax</span> <span class="o">+</span> <span class="mh">0x64</span><span class="p">]</span>

        <span class="p">;</span> <span class="k">return</span> <span class="n">from</span> <span class="n">function</span>
        <span class="n">retn</span>
    <span class="p">}</span>
<span class="p">}</span></code></pre></figure>

<p><i>Credits for this code sample: <a href="https://github.com/LordNoteworthy/al-khaser">al-khaser project</a> </i></p>

<hr class="space" />

<p><b>Code sample (variant 3, pafish project)</b></p>
<p></p>

<figure class="highlight"><pre><code class="language-c" data-lang="c"><span class="kt">int</span> <span class="nf">gensandbox_one_cpu_GetSystemInfo</span><span class="p">()</span> <span class="p">{</span>
    <span class="n">SYSTEM_INFO</span> <span class="n">si</span><span class="p">;</span>
    <span class="n">GetSystemInfo</span><span class="p">(</span><span class="o">&amp;</span><span class="n">si</span><span class="p">);</span>
    <span class="k">return</span> <span class="n">si</span><span class="p">.</span><span class="n">dwNumberOfProcessors</span> <span class="o">&lt;</span> <span class="mi">2</span> <span class="o">?</span> <span class="n">TRUE</span> <span class="o">:</span> <span class="n">FALSE</span><span class="p">;</span>
<span class="p">}</span></code></pre></figure>

<p><i>Credits for this code sample: <a href="https://github.com/a0rtega/pafish">pafish project</a> </i></p>

<hr class="space" />

<p><b>Code sample (variant 4)</b></p>
<p></p>

<figure class="highlight"><pre><code class="language-c" data-lang="c"><span class="kr">__declspec</span><span class="p">(</span><span class="kr">naked</span><span class="p">)</span>
    <span class="n">DWORD</span> <span class="nf">get_number_of_active_processors</span><span class="p">()</span> <span class="p">{</span>
    <span class="kr">__asm</span> <span class="p">{</span>
        <span class="n">mov</span> <span class="n">eax</span><span class="p">,</span> <span class="mh">0x7ffe0000</span>  <span class="p">;</span> <span class="n">KUSER_SHARED_DATA</span> <span class="n">structure</span> <span class="n">fixed</span> <span class="n">address</span>
        <span class="n">mov</span> <span class="n">eax</span><span class="p">,</span> <span class="n">byte</span> <span class="n">ptr</span> <span class="p">[</span><span class="n">eax</span><span class="o">+</span><span class="mh">0x3c0</span><span class="p">]</span> <span class="p">;</span> <span class="n">checking</span> <span class="n">ActiveProcessorCount</span>
        <span class="n">retn</span>  <span class="p">;</span> <span class="k">return</span> <span class="n">from</span> <span class="n">function</span>
    <span class="p">}</span>
<span class="p">}</span></code></pre></figure>

<hr class="space" />

<p><b>Countermeasures</b></p>
<p></p>

<p>Assign two or more cores for Virtual Machine.</p>
<p></p>
<p>As an alternative solution, patch/hook <font face="Courier New">NtCreateThread</font> to assign specific core for each new thread.</p>

<p><br /></p>
<h3><a class="a-dummy" name="check-if-quantity-of-monitors">7. Check if the quantity of monitors is small</a></h3>

<p>Functions used:</p>
<ul>
<li><tt>EnumDisplayMonitors</tt></li>
<li><tt>GetSystemMetrics (SM_MONITOR)</tt></li> 
</ul>

<hr class="space" />

<p><b>Code sample</b></p>
<p></p>

<figure class="highlight"><pre><code class="language-c" data-lang="c"><span class="n">BOOL</span> <span class="n">CALLBACK</span> <span class="nf">MonitorEnumProc</span><span class="p">(</span><span class="n">HMONITOR</span> <span class="n">hMonitor</span><span class="p">,</span> <span class="n">HDC</span> <span class="n">hdcMonitor</span><span class="p">,</span> <span class="n">LPRECT</span> <span class="n">lprcMonitor</span><span class="p">,</span> <span class="n">LPARAM</span> <span class="n">dwData</span><span class="p">)</span>
<span class="p">{</span>
    <span class="kt">int</span> <span class="o">*</span><span class="n">Count</span> <span class="o">=</span> <span class="p">(</span><span class="kt">int</span><span class="o">*</span><span class="p">)</span><span class="n">dwData</span><span class="p">;</span>
    <span class="p">(</span><span class="o">*</span><span class="n">Count</span><span class="p">)</span><span class="o">++</span><span class="p">;</span>
    <span class="k">return</span> <span class="n">TRUE</span><span class="p">;</span>
<span class="p">}</span>

<span class="kt">int</span> <span class="nf">MonitorCount</span><span class="p">()</span>
<span class="p">{</span>
    <span class="kt">int</span> <span class="n">Count</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
    <span class="k">if</span> <span class="p">(</span><span class="n">EnumDisplayMonitors</span><span class="p">(</span><span class="nb">NULL</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">,</span> <span class="n">MonitorEnumProc</span><span class="p">,</span> <span class="p">(</span><span class="n">LPARAM</span><span class="p">)</span><span class="o">&amp;</span><span class="n">Count</span><span class="p">))</span>
        <span class="k">return</span> <span class="n">Count</span><span class="p">;</span>
    <span class="k">return</span> <span class="o">-</span><span class="mi">1</span><span class="p">;</span> <span class="c1">// signals an error</span>
<span class="p">}</span></code></pre></figure>

<p><i>Credits for this code sample: <a href="https://stackoverflow.com/questions/7767036/how-do-i-get-the-number-of-displays-in-windows">StackOverflow forum</a> </i></p>

<hr class="space" />

<p><b>Countermeasures</b></p>
<p></p>

<p>Add at least one monitor to virtual environment.</p>

<p><br /></p>
<h3><a class="a-dummy" name="check-if-hard-disk">8. Check if the hard disk drive size and free space are small</a></h3>

<p>Functions used:</p>
<ul>
<li><tt>DeviceIoControl(..., IOCTL_DISK_GET_LENGTH_INFO, ...)</tt></li>
<li><tt>GetDiskFreeSpaceExA/W</tt></li>
</ul>

<hr class="space" />

<p><b>Code sample (checking drive total size)</b></p>
<p></p>

<figure class="highlight"><pre><code class="language-c" data-lang="c"><span class="kt">int</span> <span class="nf">gensandbox_drive_size</span><span class="p">()</span> <span class="p">{</span>
    <span class="n">GET_LENGTH_INFORMATION</span> <span class="n">size</span><span class="p">;</span>
    <span class="n">DWORD</span> <span class="n">lpBytesReturned</span><span class="p">;</span>

    <span class="n">HANDLE</span> <span class="n">drive</span> <span class="o">=</span> <span class="n">CreateFile</span><span class="p">(</span><span class="s">"</span><span class="se">\\\\</span><span class="s">.</span><span class="se">\\</span><span class="s">PhysicalDrive0"</span><span class="p">,</span> <span class="n">GENERIC_READ</span><span class="p">,</span> <span class="n">FILE_SHARE_READ</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">,</span> <span class="n">OPEN_EXISTING</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">);</span>
    <span class="k">if</span> <span class="p">(</span><span class="n">drive</span> <span class="o">==</span> <span class="n">INVALID_HANDLE_VALUE</span><span class="p">)</span> <span class="p">{</span>
        <span class="c1">// Someone is playing tricks. Or not enough privileges.</span>
        <span class="n">CloseHandle</span><span class="p">(</span><span class="n">drive</span><span class="p">);</span>
        <span class="k">return</span> <span class="n">FALSE</span><span class="p">;</span>
    <span class="p">}</span>
    <span class="n">BOOL</span> <span class="n">result</span> <span class="o">=</span> <span class="n">DeviceIoControl</span><span class="p">(</span><span class="n">drive</span><span class="p">,</span> <span class="n">IOCTL_DISK_GET_LENGTH_INFO</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">size</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">GET_LENGTH_INFORMATION</span><span class="p">),</span> <span class="o">&amp;</span><span class="n">lpBytesReturned</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">);</span>
    <span class="n">CloseHandle</span><span class="p">(</span><span class="n">drive</span><span class="p">);</span>

    <span class="k">if</span> <span class="p">(</span><span class="n">result</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
        <span class="k">if</span> <span class="p">(</span><span class="n">size</span><span class="p">.</span><span class="n">Length</span><span class="p">.</span><span class="n">QuadPart</span> <span class="o">/</span> <span class="mi">1073741824</span> <span class="o">&lt;=</span> <span class="mi">60</span><span class="p">)</span> <span class="cm">/* &lt;= 60 GB */</span>
        <span class="k">return</span> <span class="n">TRUE</span><span class="p">;</span>
    <span class="p">}</span>

    <span class="k">return</span> <span class="n">FALSE</span><span class="p">;</span>
<span class="p">}</span></code></pre></figure>

<p><i>Credits for this code sample: <a href="https://github.com/LordNoteworthy/al-khaser">al-khaser project</a> </i></p>

<hr class="space" />

<p><b>Code sample (checking drive free space)</b></p>
<p></p>

<figure class="highlight"><pre><code class="language-c" data-lang="c"><span class="kt">int</span> <span class="nf">gensandbox_drive_size2</span><span class="p">()</span> <span class="p">{</span>
    <span class="n">ULARGE_INTEGER</span> <span class="n">total_bytes</span><span class="p">;</span>

    <span class="k">if</span> <span class="p">(</span><span class="n">GetDiskFreeSpaceExA</span><span class="p">(</span><span class="s">"C:</span><span class="se">\\</span><span class="s">"</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">total_bytes</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">))</span>
    <span class="p">{</span>
        <span class="k">if</span> <span class="p">(</span><span class="n">total_bytes</span><span class="p">.</span><span class="n">QuadPart</span> <span class="o">/</span> <span class="mi">1073741824</span> <span class="o">&lt;=</span> <span class="mi">60</span><span class="p">)</span> <span class="cm">/* &lt;= 60 GB */</span>
        <span class="k">return</span> <span class="n">TRUE</span><span class="p">;</span>
    <span class="p">}</span>

    <span class="k">return</span> <span class="n">FALSE</span><span class="p">;</span>
<span class="p">}</span></code></pre></figure>

<p><i>Credits for this code sample: <a href="https://github.com/LordNoteworthy/al-khaser">al-khaser project</a> </i></p>

<hr class="space" />

<p><b>Countermeasures</b></p>
<p></p>

<p><i>Against checking disk size:</i> filter <font face="Courier New">IRP</font> device control requests to <font face="Courier New"> \\Device\\HarddiskN</font> with specific CTL-codes:</p>
<ul>
<li><tt>DRIVE_GEOMETRY_EX</tt></li>
<li><tt>DRIVE_LAYOUT_EX</tt></li>
<li><tt>PARTITION_INFO_EX</tt></li>
</ul>

<p><i>Against checking free space:</i> patch/hook <font face="Courier New">NtQueryVolumeInformationFile</font> to process these classes:</p>
<ul>
<li><tt>FileFsSizeInformation</tt></li>
<li><tt>FileFsFullSizeInformation</tt></li>
</ul>
<p>in case if handle points to <font face="Courier New">\\Device\\HarddiskVolumeN</font>.</p>

<p><br /></p>
<h3><a class="a-dummy" name="check-if-system-uptime">9. Check if the system uptime is small</a></h3>

<p>Function used:</p>
<ul>
<li><tt>GetTickCount</tt></li>
<li><tt>GetTickCount64</tt></li>
<li><tt>NtQuerySystemInformation</tt></li>
</ul>

<p><b>Code sample</b></p>
<p></p>

<figure class="highlight"><pre><code class="language-c" data-lang="c"><span class="n">bool</span> <span class="n">Generic</span><span class="o">::</span><span class="n">CheckSystemUptime</span><span class="p">()</span> <span class="k">const</span> <span class="p">{</span>
    <span class="k">const</span> <span class="n">DWORD</span> <span class="n">uptime</span> <span class="o">=</span> <span class="mi">1000</span> <span class="o">*</span> <span class="mi">60</span> <span class="o">*</span> <span class="mi">12</span><span class="p">;</span> <span class="c1">// 12 minutes</span>
    <span class="k">return</span> <span class="n">GetTickCount</span><span class="p">()</span> <span class="o">&lt;</span> <span class="n">uptime</span><span class="p">;</span>
<span class="p">}</span></code></pre></figure>

<p><i>Code sample is taken from <a href="https://github.com/CheckPointSW/InviZzzible">InviZzzible tool</a></i></p>

<p><b>Code sample</b></p>

<figure class="highlight"><pre><code class="language-c" data-lang="c"><span class="cp">#define MIN_UPTIME_MINUTES 12
</span><span class="n">BOOL</span> <span class="nf">uptime_check</span><span class="p">()</span>
<span class="p">{</span>
    <span class="n">ULONGLONG</span> <span class="n">uptime_minutes</span> <span class="o">=</span> <span class="n">GetTickCount64</span><span class="p">()</span> <span class="o">/</span> <span class="p">(</span><span class="mi">60</span> <span class="o">*</span> <span class="mi">1000</span><span class="p">);</span>
    <span class="k">return</span> <span class="n">uptime_minutes</span> <span class="o">&lt;</span> <span class="n">MIN_UPTIME_MINUTES</span><span class="p">;</span>
<span class="p">}</span></code></pre></figure>

<p><br />
<b>Code sample</b></p>

<figure class="highlight"><pre><code class="language-c" data-lang="c"><span class="n">BOOL</span> <span class="nf">uptime_check2</span><span class="p">()</span>
<span class="p">{</span>
    <span class="n">SYSTEM_TIME_OF_DAY_INFORMATION</span>  <span class="n">SysTimeInfo</span><span class="p">;</span>
    <span class="n">ULONGLONG</span> <span class="n">uptime_minutes</span><span class="p">;</span>
    <span class="n">NtQuerySystemInformation</span><span class="p">(</span><span class="n">SystemTimeOfDayInformation</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">SysTimeInfo</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">SysTimeInfo</span><span class="p">),</span> <span class="mi">0</span><span class="p">);</span>
    <span class="n">uptime_minutes</span> <span class="o">=</span> <span class="p">(</span><span class="n">SysTimeInfo</span><span class="p">.</span><span class="n">CurrentTime</span><span class="p">.</span><span class="n">QuadPart</span> <span class="o">-</span> <span class="n">SysTimeInfo</span><span class="p">.</span><span class="n">BootTime</span><span class="p">.</span><span class="n">QuadPart</span><span class="p">)</span> <span class="o">/</span> <span class="p">(</span><span class="mi">60</span> <span class="o">*</span> <span class="mi">1000</span> <span class="o">*</span> <span class="mi">10000</span><span class="p">);</span>
    <span class="k">return</span> <span class="n">uptime_minutes</span> <span class="o">&lt;</span> <span class="n">MIN_UPTIME_MINUTES</span><span class="p">;</span>
<span class="p">}</span></code></pre></figure>

<hr class="space" />

<p><b>Countermeasures</b></p>
<p></p>

<ul>
<li>Adjust <tt>KeBootTime</tt> value</li>
<li>Adjust <tt>SharedUserData-&gt;TickCount</tt>, <tt>SharedUserData-&gt;TickCoundLowDeprecated</tt> values</li>
</ul>

<p><br /></p>
<h3><a class="a-dummy" name="check-if-os-was-boot-from-virtual-disk">10. Check if the OS was boot from virtual hard disk (Win8+)</a></h3>

<p>Function used:</p>
<ul>
<li><tt>IsNativeVhdBoot  // false on host OS, true within VM</tt></li>
</ul>

<p><b>Code sample (excerpt from malware)</b></p>
<p></p>

<p>Take a look at the excerpt from malware <a href="https://github.com/a0rtega/pafish/issues/46">here</a>.</p>

<hr class="space" />

<p><b>Code sample (pafish project)</b></p>
<p></p>

<figure class="highlight"><pre><code class="language-c" data-lang="c"><span class="kt">int</span> <span class="nf">gensandbox_IsNativeVhdBoot</span><span class="p">()</span> <span class="p">{</span>
    <span class="n">BOOL</span> <span class="n">isnative</span> <span class="o">=</span> <span class="n">FALSE</span><span class="p">;</span>

    <span class="n">IsNativeVhdBoot</span> <span class="n">fnnative</span> <span class="o">=</span> <span class="p">(</span><span class="n">IsNativeVhdBoot</span><span class="p">)</span> <span class="n">GetProcAddress</span><span class="p">(</span>
        <span class="n">GetModuleHandleA</span><span class="p">(</span><span class="s">"kernel32"</span><span class="p">),</span> <span class="s">"IsNativeVhdBoot"</span><span class="p">);</span>

    <span class="cm">/* IsNativeVhdBoot always returns 1 on query success */</span>
    <span class="k">if</span> <span class="p">(</span><span class="n">fnnative</span><span class="p">)</span>
        <span class="n">fnnative</span><span class="p">(</span><span class="o">&amp;</span><span class="n">isnative</span><span class="p">);</span>
		
    <span class="k">return</span> <span class="p">(</span><span class="n">isnative</span><span class="p">)</span> <span class="o">?</span> <span class="n">TRUE</span> <span class="o">:</span> <span class="n">FALSE</span><span class="p">;</span>
<span class="p">}</span></code></pre></figure>

<p><i>Credits for this code sample: <a href="https://github.com/a0rtega/pafish">pafish project</a> </i></p>

<hr class="space" />

<p><b>Countermeasures</b></p>
<p></p>

<p>Hook <font face="Courier New">IsNativeVhdBoot</font> and change its result to the one required.</p>

<p><br /></p>
<h3><a class="a-dummy" name="countermeasures">Countermeasures</a></h3>

<p>Countermeasures are present in appropriate sub-sections, see above.</p>

<p><br /></p>
<h3><a class="a-dummy" name="credits">Credits</a></h3>

<p>Credits go to open-source projects from where code samples were taken:</p>
<ul>
<li>al-khaser project on <a href="https://github.com/LordNoteworthy/al-khaser">github</a></li>
<li>pafish project on <a href="https://github.com/a0rtega/pafish">github</a></li>
</ul>

<p>Though Check Point tool InviZzzible has them all implemented, due to modular structure of the code it would require more space to show a code sample from this tool for the same purposes. That’s why we’ve decided to use other great open-source projects for examples throughout the encyclopedia.</p>


    <br>
    <div style="text-align: left">
        <a href="..">Go back</a>
    </div>
    <br>
    <div class="sharebuttons" style="text-align: center">
        <hr />
        <ul>
          <li>
            <p class="sharetitle"> Share this: </p>
          </li>
          <li class="reddit">
            <a href="http://www.reddit.com/submit?url=https://evasions.checkpoint.com/src/Evasions/techniques/generic-os-queries.html&title=Evasions:%20Generic%20OS%20queries - Evasion Techniques" target="_blank">
                <svg xmlns="http://www.w3.org/2000/svg"
                aria-label="Reddit" role="img"
                viewBox="0 0 512 512"><rect
                width="512" height="512"
                rx="15%"
                fill="#f40"/><g fill="#fff"><ellipse cx="256" cy="307" rx="166" ry="117"/><circle cx="106" cy="256" r="42"/><circle cx="407" cy="256" r="42"/><circle cx="375" cy="114" r="32"/></g><g stroke-linecap="round" stroke-linejoin="round" fill="none"><path d="m256 196 23-101 73 15" stroke="#fff" stroke-width="16"/><path d="m191 359c33 25 97 26 130 0" stroke="#f40" stroke-width="13"/></g><g fill="#f40"><circle cx="191" cy="287" r="31"/><circle cx="321" cy="287" r="31"/></g></svg>
                
            </a>
          </li>
          <li class="hn">
            <a href="http://news.ycombinator.com/submitlink?u=https://evasions.checkpoint.com/src/Evasions/techniques/generic-os-queries.html&t=Evasions:%20Generic%20OS%20queries - Evasion Techniques" target="_blank">
                <svg xmlns="http://www.w3.org/2000/svg"
                aria-label="Hacker News" role="img"
                viewBox="0 0 512 512"><rect
                width="512" height="512"
                rx="15%"
                fill="#f60"/><path fill="#fff" d="M124 91h51l81 162 81-164h51L276 293v136h-40V293z"/></svg>
            </a>
          </li>
          <li class="twitter">
            <a href="https://twitter.com/intent/tweet?via=_CPResearch_&url=https://evasions.checkpoint.com/src/Evasions/techniques/generic-os-queries.html&text=Evasions:%20Generic%20OS%20queries - Evasion Techniques" target="_blank">
                <svg viewBox="0 0 1792 1792" xmlns="http://www.w3.org/2000/svg"><path d="M1684 408q-67 98-162 167 1 14 1 42 0 130-38 259.5t-115.5 248.5-184.5 210.5-258 146-323 54.5q-271 0-496-145 35 4 78 4 225 0 401-138-105-2-188-64.5t-114-159.5q33 5 61 5 43 0 85-11-112-23-185.5-111.5t-73.5-205.5v-4q68 38 146 41-66-44-105-115t-39-154q0-88 44-163 121 149 294.5 238.5t371.5 99.5q-8-38-8-74 0-134 94.5-228.5t228.5-94.5q140 0 236 102 109-21 205-78-37 115-142 178 93-10 186-50z"/></svg>
            </a>
          </li>
          <li class="linkedin">
            <a href=https://www.linkedin.com/shareArticle?mini=true&url=https://evasions.checkpoint.com/src/Evasions/techniques/generic-os-queries.html&title=Evasions:%20Generic%20OS%20queries - Evasion Techniques&source=LinkedIn" target="_blank">
                <svg viewBox="0 0 1792 1792" xmlns="http://www.w3.org/2000/svg"><path d="M477 625v991h-330v-991h330zm21-306q1 73-50.5 122t-135.5 49h-2q-82 0-132-49t-50-122q0-74 51.5-122.5t134.5-48.5 133 48.5 51 122.5zm1166 729v568h-329v-530q0-105-40.5-164.5t-126.5-59.5q-63 0-105.5 34.5t-63.5 85.5q-11 30-11 81v553h-329q2-399 2-647t-1-296l-1-48h329v144h-2q20-32 41-56t56.5-52 87-43.5 114.5-15.5q171 0 275 113.5t104 332.5z"/></svg>
            </a>
          </li>
        </ul>
      </div>
      
</article>


</section>

<nav class="navbar navbar-default navbar-fixed-bottom">
  <div class="container footer-content">

    Made with <font class="a-pink"><i class ="fa fa-heart"></i></font> to serve the community by Check Point Research    |    <a class="a-pink" href="https://research.checkpoint.com">Research blog</a>    |    <a class="a-pink" href="https://research.checkpoint.com/about-us/">About Us</a>    |    <a class="a-pink" href="https://github.com/CheckPointSW"><i class="fa fa-github fa-lg"></i></a> <a class="a-pink" href="https://twitter.com/_CPResearch_"><i class="fa fa-twitter fa-lg"></i></a>
    
    <br>
    
    © 1994-2024 Check Point Software Technologies LTD | All rights reserved | Property of CheckPoint.com


  </div>
</nav>

  </body>

</html>
<!DOCTYPE html>
<html>

  <head>
  <meta charset="utf-8">
  <meta http-equiv="X-UA-Compatible" content="IE=edge">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-194688-3"></script>
  <script>
   window.dataLayer = window.dataLayer || [];
   function gtag(){dataLayer.push(arguments);}
   gtag('js', new Date());
   gtag('config', 'UA-194688-3');
  </script>
  <meta content="Evasion techniques" property="og:site_name">

  <meta content="Evasions: Global OS Objects" property="og:title">


  <meta name="twitter:title" content="Malware Evasion Encyclopedia" />
  <meta name="twitter:image" content="https://research.checkpoint.com/wp-content/uploads/2020/02/evasions.jpg" />


  <meta content="article" property="og:type">


  <meta content="Evasion techniques
" property="og:description">


  <meta content="https://evasions.checkpoint.com/src/Evasions/techniques/global-os-objects.html" property="og:url">


  <meta content="2024-07-10T07:20:28+00:00" property="article:published_time">
  <meta content="https://evasions.checkpoint.com/about/" property="article:author">


  <meta property="og:image" content="">


  
  <meta content="evasions" property="article:section">
  


  
  <meta content="filesystem" property="article:tag">
  
  <meta content="vmware" property="article:tag">
  
  <meta content="virtualbox" property="article:tag">
  

  <title>Evasions: Global OS Objects</title>
  <meta name="description" content="Contents">
<script src="https://ajax.googleapis.com/ajax/libs/jquery/2.2.2/jquery.min.js"></script>
<script src="https://maxcdn.bootstrapcdn.com/bootstrap/3.3.6/js/bootstrap.min.js" integrity="sha384-0mSbJDEHialfmuBBQP6A4Qrprq5OVfW37PRR3j5ELqxss1yVqOtnepnHVP9aJ7xS" crossorigin="anonymous"></script>
  <link rel="stylesheet" href="https://evasions.checkpoint.com/assets/css/main.css">
<script src="https://maxcdn.bootstrapcdn.com/bootstrap/3.3.6/js/bootstrap.min.js" integrity="sha384-0mSbJDEHialfmuBBQP6A4Qrprq5OVfW37PRR3j5ELqxss1yVqOtnepnHVP9aJ7xS" crossorigin="anonymous"></script>

  <link href='https://fonts.googleapis.com/css?family=PT+Sans' rel='stylesheet' type='text/css'>
  <link href='https://fonts.googleapis.com/css?family=Fira+Mono' rel='stylesheet' type='text/css'>
  <link href='https://fonts.googleapis.com/css?family=Lato:400,700' rel='stylesheet' type='text/css'>
  <link href='https://fonts.googleapis.com/css?family=Source+Code+Pro:400,200,300,500,600,700,900' rel='stylesheet' type='text/css'>
  <link href='https://fonts.googleapis.com/css?family=Gentium+Basic:400,700' rel='stylesheet' type='text/css'>
  <link href='https://fonts.googleapis.com/css?family=Alegreya:400,400italic,700' rel='stylesheet' type='text/css'>
  <link href='https://fonts.googleapis.com/css?family=Lora:400,400italic,700' rel='stylesheet' type='text/css'>
  <link href='https://fonts.googleapis.com/css?family=Fira+Sans:400,300,500,700' rel='stylesheet' type='text/css'>
  <script src="https://ajax.googleapis.com/ajax/libs/jquery/2.2.0/jquery.min.js"></script>
  <link href='https://fonts.googleapis.com/css?family=Open+Sans:400,700' rel='stylesheet' type='text/css'>
  <link href="https://maxcdn.bootstrapcdn.com/bootstrap/3.3.6/css/bootstrap.min.css" rel="stylesheet" integrity="sha384-1q8mTJOASx8j1Au+a5WDVnPi2lkFfwwEAa8hDDdjZlpLegxhjVME1fgjWPGmkzs7" crossorigin="anonymous">
  <link href="https://maxcdn.bootstrapcdn.com/font-awesome/4.6.1/css/font-awesome.min.css" rel="stylesheet" integrity="sha384-hQpvDQiCJaD2H465dQfA717v7lu5qHWtDbWNPvaTJ0ID5xnPUlVXnKzq7b8YUkbN" crossorigin="anonymous">
  <link rel="canonical" href="https://evasions.checkpoint.com/src/Evasions/techniques/global-os-objects.html">
  <link rel="alternate" type="application/rss+xml" title="Evasion techniques" href="https://evasions.checkpoint.com/feed.xml">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/tinysort/2.3.6/tinysort.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/tinysort/2.3.6/tinysort.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/tinysort/2.3.6/tinysort.charorder.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/tinysort/2.3.6/tinysort.charorder.min.js"></script>
  <script type="text/javascript" async src="//platform.twitter.com/widgets.js"></script>




</head>


  <body>
<section>
<article class="post" itemscope itemtype="http://schema.org/BlogPosting">
  <div class="jumbotron">
    <div class="container">
      <h1 class="post-title-main" itemprop="name headline">Evasions: Global OS Objects</h1>
    </div>
</div>

  <div class="post-content container" itemprop="articleBody">
    <div style="text-align: left">
        <a href="..">Go back</a>
        <br>
        <br>
    </div>
    <h1>Contents</h1>

<p><a href="#global-objects-detection-methods">Global objects detection methods</a>
<br />
  <a href="#check-if-specific-mutexes-present">1. Check for specific global mutexes</a>
<br />
  <a href="#check-if-specific-virtual-devices-present">2. Check for specific virtual devices</a>
<br />
  <a href="#check-if-pipes-present">3. Check for specific global pipes</a>
<br />
  <a href="#check-if-objects-present">4. Check for specific global objects</a>
<br />
  <a href="#check-if-object-directory-present">5. Check for specific object directory (Sandboxie only)</a>
<br />
  <a href="#check-if-virtual-registry-present">6. Check if virtual registry is present in system (Sandboxie only)</a>
<br />
<a href="#countermeasures">Countermeasures</a>
<br />
<a href="#credits">Credits</a>
<br />
<br /></p>

<h2><a class="a-dummy" name="global-objects-detection-methods">Global objects detection methods</a></h2>
<p>The principle of all the global objects detection methods is the following: there are no such objects in usual host; however they exist in particular virtual environments and sandboxes. Virtual environment may be detected if such an artifact is present.</p>

<p><br /></p>
<h3><a class="a-dummy" name="check-if-specific-mutexes-present">1. Check for specific global mutexes</a></h3>

<p>This method checks for particular mutexes which are present in virtual environments but not in usual host systems.</p>

<p>Functions used:</p>
<ul>
<li><tt>CreateMutexA/W</tt></li> 
<li><tt>OpenMutexA/W</tt></li> 
</ul>

<hr class="space" />

<p><b>Code sample</b></p>
<p></p>

<figure class="highlight"><pre><code class="language-c" data-lang="c"><span class="c1">// usage sample:</span>
<span class="n">supMutexExist</span><span class="p">(</span><span class="s">L"Sandboxie_SingleInstanceMutex_Control"</span><span class="p">);</span> <span class="c1">// sample value from the table below</span>


<span class="n">BOOL</span> <span class="nf">supMutexExist</span><span class="p">(</span><span class="n">_In_</span> <span class="n">LPWSTR</span> <span class="n">lpMutexName</span><span class="p">)</span>
<span class="p">{</span>
    <span class="n">DWORD</span> <span class="n">dwError</span><span class="p">;</span>
    <span class="n">HANDLE</span> <span class="n">hObject</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
    <span class="k">if</span> <span class="p">(</span><span class="n">lpMutexName</span> <span class="o">==</span> <span class="nb">NULL</span><span class="p">)</span> <span class="p">{</span>
        <span class="k">return</span> <span class="n">FALSE</span><span class="p">;</span>
    <span class="p">}</span>

    <span class="n">SetLastError</span><span class="p">(</span><span class="mi">0</span><span class="p">);</span>
    <span class="n">hObject</span> <span class="o">=</span> <span class="n">CreateMutex</span><span class="p">(</span><span class="nb">NULL</span><span class="p">,</span> <span class="n">FALSE</span><span class="p">,</span> <span class="n">lpMutexName</span><span class="p">);</span> <span class="c1">// define around A or W function version</span>
    <span class="n">dwError</span> <span class="o">=</span> <span class="n">GetLastError</span><span class="p">();</span>

    <span class="k">if</span> <span class="p">(</span><span class="n">hObject</span><span class="p">)</span> <span class="p">{</span>
        <span class="n">CloseHandle</span><span class="p">(</span><span class="n">hObject</span><span class="p">);</span>
    <span class="p">}</span>

    <span class="k">return</span> <span class="p">(</span><span class="n">dwError</span> <span class="o">==</span> <span class="n">ERROR_ALREADY_EXISTS</span><span class="p">);</span>
<span class="p">}</span></code></pre></figure>

<p><i>Credits for this code sample: <a href="https://github.com/hfiref0x/VMDE">VMDE project</a> </i></p>

<hr class="space" />

<p><b>Signature recommendations</b></p>
<p></p>
<p>If the following function contains 3rd argument from the table column <font face="Courier New">`Name`</font>:</p>
<p></p>
<ul>
<li><tt>CreateMutexA/W(..., ..., registry_path)</tt></li> 
<li><tt>OpenMutexA/W(..., ..., registry_path)</tt></li> 
</ul>
<p>then it’s an indication of application trying to use the evasion technique.</p>

<hr class="space" />

<p><b>Detections table</b></p>

<table style="width:62%">
  <tr>
  	<td colspan="2">Check if the following global mutexes exist:</td>
  </tr>
  <tr>
  	<th style="text-align:center">Detect</th>
  	<th style="text-align:center">Name</th>
  </tr>
  <tr>
  	<th rowspan="1">DeepFreeze</th>
  	<td>Frz_State</td>
  </tr>
  <tr>
  	<th rowspan="2">Sandboxie</th>
  	<td>Sandboxie_SingleInstanceMutex_Control</td>
  </tr>
  <tr>
  	<td>SBIE_BOXED_ServiceInitComplete_Mutex1</td>
  </tr>
  <tr>
  	<th rowspan="1">VirtualPC</th>
  	<td>MicrosoftVirtualPC7UserServiceMakeSureWe'reTheOnlyOneMutex</td>
  </tr>
</table>

<p><br />
Note: DeepFreeze is an application restoring the system on each reboot.</p>

<p><br /></p>
<h3><a class="a-dummy" name="check-if-specific-virtual-devices-present">2. Check for specific virtual devices</a></h3>

<p>This method checks for particular virtual devices which are present in virtual environments but not in usual host systems.</p>

<p>Function used:</p>
<ul>
<li><tt>NtCreateFile</tt></li> 
</ul>

<hr class="space" />

<p><b>Code sample</b></p>
<p></p>

<figure class="highlight"><pre><code class="language-c" data-lang="c"><span class="c1">// usage sample:</span>
<span class="n">HANDLE</span> <span class="n">hDummy</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
<span class="n">supOpenDevice</span><span class="p">(</span><span class="s">L"</span><span class="se">\\</span><span class="s">Device</span><span class="se">\\</span><span class="s">Null"</span><span class="p">,</span> <span class="n">GENERIC_READ</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">hDummy</span><span class="p">);</span> <span class="c1">// sample values from the table below</span>


<span class="n">BOOL</span> <span class="nf">supOpenDevice</span><span class="p">(</span>
    <span class="n">_In_</span> <span class="n">LPWSTR</span> <span class="n">lpDeviceName</span><span class="p">,</span>
    <span class="n">_In_</span> <span class="n">ACCESS_MASK</span> <span class="n">DesiredAccess</span><span class="p">,</span>
    <span class="n">_Out_opt_</span> <span class="n">PHANDLE</span> <span class="n">phDevice</span><span class="p">)</span>
<span class="p">{</span>
    <span class="n">OBJECT_ATTRIBUTES</span> <span class="n">attr</span><span class="p">;</span>
    <span class="n">IO_STATUS_BLOCK</span> <span class="n">iost</span><span class="p">;</span>
    <span class="n">UNICODE_STRING</span> <span class="n">uDevName</span><span class="p">;</span>
    <span class="n">HANDLE</span> <span class="n">hDevice</span><span class="p">;</span>
    <span class="n">NTSTATUS</span> <span class="n">Status</span><span class="p">;</span>

    <span class="k">if</span> <span class="p">(</span><span class="n">phDevice</span><span class="p">)</span> <span class="p">{</span>
        <span class="o">*</span><span class="n">phDevice</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
    <span class="p">}</span>
    <span class="k">if</span> <span class="p">(</span><span class="n">lpDeviceName</span> <span class="o">==</span> <span class="nb">NULL</span><span class="p">)</span> <span class="p">{</span>
        <span class="k">return</span> <span class="n">FALSE</span><span class="p">;</span>
    <span class="p">}</span>

    <span class="n">hDevice</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
    <span class="n">RtlSecureZeroMemory</span><span class="p">(</span><span class="o">&amp;</span><span class="n">uDevName</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">uDevName</span><span class="p">));</span>
    <span class="n">RtlInitUnicodeString</span><span class="p">(</span><span class="o">&amp;</span><span class="n">uDevName</span><span class="p">,</span> <span class="n">lpDeviceName</span><span class="p">);</span>
    <span class="n">InitializeObjectAttributes</span><span class="p">(</span><span class="o">&amp;</span><span class="n">attr</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">uDevName</span><span class="p">,</span> <span class="n">OBJ_CASE_INSENSITIVE</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">);</span>

    <span class="n">Status</span> <span class="o">=</span> <span class="n">NtCreateFile</span><span class="p">(</span><span class="o">&amp;</span><span class="n">hDevice</span><span class="p">,</span> <span class="n">DesiredAccess</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">attr</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">iost</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span>
        <span class="mi">0</span><span class="p">,</span> <span class="n">FILE_OPEN</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
    <span class="k">if</span> <span class="p">(</span><span class="n">NT_SUCCESS</span><span class="p">(</span><span class="n">Status</span><span class="p">))</span> <span class="p">{</span>
        <span class="k">if</span> <span class="p">(</span><span class="n">phDevice</span> <span class="o">!=</span> <span class="nb">NULL</span><span class="p">)</span> <span class="p">{</span>
            <span class="o">*</span><span class="n">phDevice</span> <span class="o">=</span> <span class="n">hDevice</span><span class="p">;</span>
        <span class="p">}</span>
    <span class="p">}</span>

    <span class="k">return</span> <span class="n">NT_SUCCESS</span><span class="p">(</span><span class="n">Status</span><span class="p">);</span>
<span class="p">}</span></code></pre></figure>

<p><i>Credits for this code sample: <a href="https://github.com/hfiref0x/VMDE">VMDE project</a> </i></p>

<hr class="space" />

<p><b>Signature recommendations</b></p>
<p></p>
<p>If the following function contains 3rd argument with its field <font face="Courier New">`ObjectName-&gt;Buffer`</font> from the table column <font face="Courier New">`Name`</font>:</p>
<p></p>
<ul>
<li><tt>NtCreateFile(..., ..., attr, ...)</tt></li>
</ul>
<p>then it’s an indication of application trying to use the evasion technique.</p>

<p><br />
3rd argument is of the following type:</p>

<figure class="highlight"><pre><code class="language-c" data-lang="c"><span class="k">typedef</span> <span class="k">struct</span> <span class="n">_OBJECT_ATTRIBUTES</span> <span class="p">{</span>
    <span class="n">ULONG</span> <span class="n">Length</span><span class="p">;</span>
    <span class="n">HANDLE</span> <span class="n">RootDirectory</span><span class="p">;</span>
    <span class="n">PUNICODE_STRING</span> <span class="n">ObjectName</span><span class="p">;</span>
    <span class="n">ULONG</span> <span class="n">Attributes</span><span class="p">;</span>
    <span class="n">PVOID</span> <span class="n">SecurityDescriptor</span><span class="p">;</span>
    <span class="n">PVOID</span> <span class="n">SecurityQualityOfService</span><span class="p">;</span>
<span class="p">}</span> <span class="n">OBJECT_ATTRIBUTES</span><span class="p">;</span></code></pre></figure>

<hr class="space" />

<p><b>Detections table</b></p>

<table style="width:62%">
  <tr>
  	<td colspan="3">Check if the following virtual devices exist:</td>
  </tr>
  <tr>
  	<th style="text-align:center">Detect</th>
  	<th style="text-align:center">Path</th>
  </tr>
  <tr>
  	<th rowspan="6">VirtualBox</th>
  	<td>\\.\VBoxMiniRdDN</td>
  </tr>
  <tr>
  	<td>\\.\VBoxMiniRdrDN</td>
  </tr>
  <tr>
  	<td>\\.\VBoxGuest</td>
  </tr>
  <tr>
  	<td>\\.\VBoxTrayIPC</td>
  </tr>
  <tr>
  	<td>\\.\VBoxMouse</td>
  </tr>
  <tr>
  	<td>\\.\VBoxVideo</td>
  </tr>
  <tr>
  	<th rowspan="2">VMware</th>
  	<td>\\.\HGFS</td>
  </tr>
  <tr>
  	<td>\\.\vmci</td>
  </tr>
</table>

<p><br /></p>
<h3><a class="a-dummy" name="check-if-pipes-present">3. Check for specific global pipes</a></h3>

<p>Pipes are just a particular case of virtual devices, please refer to the <a href="#check-if-specific-virtual-devices-present">previous section</a> for code sample and signature recommendations.</p>

<hr class="space" />

<p><b>Detections table</b></p>

<table style="width:62%">
  <tr>
  	<td colspan="2">Check if the following global pipes exist:</td>
  </tr>
  <tr>
  	<th style="text-align:center">Detect</th>
  	<th style="text-align:center">String</th>
  </tr>
  <tr>
  	<th rowspan="2">VirtualBox</th>
  	<td>\\.\pipe\VBoxMiniRdDN</td>
  </tr>
  <tr>
  	<td>\\.\pipe\VBoxTrayIPC</td>
  </tr>
</table>

<p><br /></p>
<h3><a class="a-dummy" name="check-if-objects-present">4. Check for global objects</a></h3>

<p>This method checks for particular global objects which are present in virtual environments but not in usual host systems.</p>

<p>Functions used:</p>
<ul>
<li><tt>NtOpenDirectoryObject</tt></li> 
<li><tt>NtQueryDirectoryObject</tt></li> 
</ul>

<hr class="space" />

<p><b>Code sample</b></p>
<p></p>

<figure class="highlight"><pre><code class="language-c" data-lang="c"><span class="c1">// usage sample:</span>
<span class="n">supIsObjectExists</span><span class="p">(</span><span class="s">L"</span><span class="se">\\</span><span class="s">Driver"</span><span class="p">,</span> <span class="s">L"SbieDrv"</span><span class="p">);</span> <span class="c1">// sample values from the table below</span>


<span class="k">typedef</span> <span class="k">struct</span> <span class="n">_OBJECT_DIRECTORY_INFORMATION</span> <span class="p">{</span>
    <span class="n">UNICODE_STRING</span> <span class="n">Name</span><span class="p">;</span>
    <span class="n">UNICODE_STRING</span> <span class="n">TypeName</span><span class="p">;</span>
<span class="p">}</span> <span class="n">OBJECT_DIRECTORY_INFORMATION</span><span class="p">,</span> <span class="o">*</span><span class="n">POBJECT_DIRECTORY_INFORMATION</span><span class="p">;</span>

<span class="n">BOOL</span> <span class="nf">supIsObjectExists</span><span class="p">(</span>
    <span class="n">_In_</span> <span class="n">LPWSTR</span> <span class="n">RootDirectory</span><span class="p">,</span>
    <span class="n">_In_</span> <span class="n">LPWSTR</span> <span class="n">ObjectName</span><span class="p">)</span>
<span class="p">{</span>
    <span class="n">OBJSCANPARAM</span> <span class="n">Param</span><span class="p">;</span>
    <span class="k">if</span> <span class="p">(</span><span class="n">ObjectName</span> <span class="o">==</span> <span class="nb">NULL</span><span class="p">)</span> <span class="p">{</span>
        <span class="k">return</span> <span class="n">FALSE</span><span class="p">;</span>
    <span class="p">}</span>

    <span class="n">Param</span><span class="p">.</span><span class="n">Buffer</span> <span class="o">=</span> <span class="n">ObjectName</span><span class="p">;</span>
    <span class="n">Param</span><span class="p">.</span><span class="n">BufferSize</span> <span class="o">=</span> <span class="p">(</span><span class="n">ULONG</span><span class="p">)</span><span class="n">_strlen_w</span><span class="p">(</span><span class="n">ObjectName</span><span class="p">);</span>

    <span class="k">return</span> <span class="n">NT_SUCCESS</span><span class="p">(</span><span class="n">supEnumSystemObjects</span><span class="p">(</span><span class="n">RootDirectory</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">,</span> <span class="n">supDetectObjectCallback</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">Param</span><span class="p">));</span>
<span class="p">}</span>

<span class="n">NTSTATUS</span> <span class="n">NTAPI</span> <span class="nf">supDetectObjectCallback</span><span class="p">(</span>
    <span class="n">_In_</span> <span class="n">POBJECT_DIRECTORY_INFORMATION</span> <span class="n">Entry</span><span class="p">,</span>
    <span class="n">_In_</span> <span class="n">PVOID</span> <span class="n">CallbackParam</span><span class="p">)</span>
<span class="p">{</span>
    <span class="n">POBJSCANPARAM</span> <span class="n">Param</span> <span class="o">=</span> <span class="p">(</span><span class="n">POBJSCANPARAM</span><span class="p">)</span><span class="n">CallbackParam</span><span class="p">;</span>
    <span class="k">if</span> <span class="p">(</span><span class="n">Entry</span> <span class="o">==</span> <span class="nb">NULL</span><span class="p">)</span> <span class="p">{</span>
        <span class="k">return</span> <span class="n">STATUS_INVALID_PARAMETER_1</span><span class="p">;</span>
    <span class="p">}</span>
    <span class="k">if</span> <span class="p">(</span><span class="n">CallbackParam</span> <span class="o">==</span> <span class="nb">NULL</span><span class="p">)</span> <span class="p">{</span>
        <span class="k">return</span> <span class="n">STATUS_INVALID_PARAMETER_2</span><span class="p">;</span>
    <span class="p">}</span>
    <span class="k">if</span> <span class="p">(</span><span class="n">Param</span><span class="o">-&gt;</span><span class="n">Buffer</span> <span class="o">==</span> <span class="nb">NULL</span> <span class="o">||</span> <span class="n">Param</span><span class="o">-&gt;</span><span class="n">BufferSize</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
        <span class="k">return</span> <span class="n">STATUS_MEMORY_NOT_ALLOCATED</span><span class="p">;</span>
    <span class="p">}</span>
    <span class="k">if</span> <span class="p">(</span><span class="n">Entry</span><span class="o">-&gt;</span><span class="n">Name</span><span class="p">.</span><span class="n">Buffer</span><span class="p">)</span> <span class="p">{</span>
        <span class="k">if</span> <span class="p">(</span><span class="n">_strcmpi_w</span><span class="p">(</span><span class="n">Entry</span><span class="o">-&gt;</span><span class="n">Name</span><span class="p">.</span><span class="n">Buffer</span><span class="p">,</span> <span class="n">Param</span><span class="o">-&gt;</span><span class="n">Buffer</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
            <span class="k">return</span> <span class="n">STATUS_SUCCESS</span><span class="p">;</span>
        <span class="p">}</span>
    <span class="p">}</span>

    <span class="k">return</span> <span class="n">STATUS_UNSUCCESSFUL</span><span class="p">;</span>
<span class="p">}</span>

<span class="n">NTSTATUS</span> <span class="n">NTAPI</span> <span class="nf">supEnumSystemObjects</span><span class="p">(</span>
    <span class="n">_In_opt_</span> <span class="n">LPWSTR</span> <span class="n">pwszRootDirectory</span><span class="p">,</span>
    <span class="n">_In_opt_</span> <span class="n">HANDLE</span> <span class="n">hRootDirectory</span><span class="p">,</span>
    <span class="n">_In_</span> <span class="n">PENUMOBJECTSCALLBACK</span> <span class="n">CallbackProc</span><span class="p">,</span>
    <span class="n">_In_opt_</span> <span class="n">PVOID</span> <span class="n">CallbackParam</span><span class="p">)</span>
<span class="p">{</span>
    <span class="n">BOOL</span> <span class="n">cond</span> <span class="o">=</span> <span class="n">TRUE</span><span class="p">;</span>
    <span class="n">ULONG</span> <span class="n">ctx</span><span class="p">,</span> <span class="n">rlen</span><span class="p">;</span>
    <span class="n">HANDLE</span> <span class="n">hDirectory</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
    <span class="n">NTSTATUS</span> <span class="n">status</span><span class="p">;</span>
    <span class="n">NTSTATUS</span> <span class="n">CallbackStatus</span><span class="p">;</span>
    <span class="n">OBJECT_ATTRIBUTES</span> <span class="n">attr</span><span class="p">;</span>
    <span class="n">UNICODE_STRING</span> <span class="n">sname</span><span class="p">;</span>
    <span class="n">POBJECT_DIRECTORY_INFORMATION</span> <span class="n">objinf</span><span class="p">;</span>

    <span class="k">if</span> <span class="p">(</span><span class="n">CallbackProc</span> <span class="o">==</span> <span class="nb">NULL</span><span class="p">)</span> <span class="p">{</span>
        <span class="k">return</span> <span class="n">STATUS_INVALID_PARAMETER_4</span><span class="p">;</span>
    <span class="p">}</span>
    <span class="n">status</span> <span class="o">=</span> <span class="n">STATUS_UNSUCCESSFUL</span><span class="p">;</span>
    
    <span class="kr">__try</span> <span class="p">{</span>
        <span class="c1">// We can use root directory.</span>
        <span class="k">if</span> <span class="p">(</span><span class="n">pwszRootDirectory</span> <span class="o">!=</span> <span class="nb">NULL</span><span class="p">)</span> <span class="p">{</span>
            <span class="n">RtlSecureZeroMemory</span><span class="p">(</span><span class="o">&amp;</span><span class="n">sname</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">sname</span><span class="p">));</span>
            <span class="n">RtlInitUnicodeString</span><span class="p">(</span><span class="o">&amp;</span><span class="n">sname</span><span class="p">,</span> <span class="n">pwszRootDirectory</span><span class="p">);</span>
            <span class="n">InitializeObjectAttributes</span><span class="p">(</span><span class="o">&amp;</span><span class="n">attr</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">sname</span><span class="p">,</span> <span class="n">OBJ_CASE_INSENSITIVE</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">);</span>

            <span class="n">status</span> <span class="o">=</span> <span class="n">NtOpenDirectoryObject</span><span class="p">(</span><span class="o">&amp;</span><span class="n">hDirectory</span><span class="p">,</span> <span class="n">DIRECTORY_QUERY</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">attr</span><span class="p">);</span>
            <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">NT_SUCCESS</span><span class="p">(</span><span class="n">status</span><span class="p">))</span> <span class="p">{</span>
                <span class="k">return</span> <span class="n">status</span><span class="p">;</span>
            <span class="p">}</span>
        <span class="p">}</span>
        <span class="k">else</span> <span class="p">{</span>
            <span class="k">if</span> <span class="p">(</span><span class="n">hRootDirectory</span> <span class="o">==</span> <span class="nb">NULL</span><span class="p">)</span> <span class="p">{</span>
                <span class="k">return</span> <span class="n">STATUS_INVALID_PARAMETER_2</span><span class="p">;</span>
            <span class="p">}</span>
            <span class="n">hDirectory</span> <span class="o">=</span> <span class="n">hRootDirectory</span><span class="p">;</span>
        <span class="p">}</span>

        <span class="c1">// Enumerate objects in directory.</span>
        <span class="n">ctx</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
        <span class="k">do</span> <span class="p">{</span>
            <span class="n">rlen</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
            <span class="n">status</span> <span class="o">=</span> <span class="n">NtQueryDirectoryObject</span><span class="p">(</span><span class="n">hDirectory</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="n">TRUE</span><span class="p">,</span> <span class="n">FALSE</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">ctx</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">rlen</span><span class="p">);</span>
            <span class="k">if</span> <span class="p">(</span><span class="n">status</span> <span class="o">!=</span> <span class="n">STATUS_BUFFER_TOO_SMALL</span><span class="p">)</span>
                    <span class="k">break</span><span class="p">;</span>
            <span class="n">objinf</span> <span class="o">=</span> <span class="n">HeapAlloc</span><span class="p">(</span><span class="n">GetProcessHeap</span><span class="p">(),</span> <span class="n">HEAP_ZERO_MEMORY</span><span class="p">,</span> <span class="n">rlen</span><span class="p">);</span>
            <span class="k">if</span> <span class="p">(</span><span class="n">objinf</span> <span class="o">==</span> <span class="nb">NULL</span><span class="p">)</span>
                <span class="k">break</span><span class="p">;</span>
                
            <span class="n">status</span> <span class="o">=</span> <span class="n">NtQueryDirectoryObject</span><span class="p">(</span><span class="n">hDirectory</span><span class="p">,</span> <span class="n">objinf</span><span class="p">,</span> <span class="n">rlen</span><span class="p">,</span> <span class="n">TRUE</span><span class="p">,</span> <span class="n">FALSE</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">ctx</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">rlen</span><span class="p">);</span>
            <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">NT_SUCCESS</span><span class="p">(</span><span class="n">status</span><span class="p">))</span> <span class="p">{</span>
                <span class="n">HeapFree</span><span class="p">(</span><span class="n">GetProcessHeap</span><span class="p">(),</span> <span class="mi">0</span><span class="p">,</span> <span class="n">objinf</span><span class="p">);</span>
                <span class="k">break</span><span class="p">;</span>
            <span class="p">}</span>

            <span class="n">CallbackStatus</span> <span class="o">=</span> <span class="n">CallbackProc</span><span class="p">(</span><span class="n">objinf</span><span class="p">,</span> <span class="n">CallbackParam</span><span class="p">);</span>
            <span class="n">HeapFree</span><span class="p">(</span><span class="n">GetProcessHeap</span><span class="p">(),</span> <span class="mi">0</span><span class="p">,</span> <span class="n">objinf</span><span class="p">);</span>
            <span class="k">if</span> <span class="p">(</span><span class="n">NT_SUCCESS</span><span class="p">(</span><span class="n">CallbackStatus</span><span class="p">))</span> <span class="p">{</span>
                <span class="n">status</span> <span class="o">=</span> <span class="n">STATUS_SUCCESS</span><span class="p">;</span>
                <span class="k">break</span><span class="p">;</span>
            <span class="p">}</span>
        <span class="p">}</span> <span class="k">while</span> <span class="p">(</span><span class="n">cond</span><span class="p">);</span>

        <span class="k">if</span> <span class="p">(</span><span class="n">hDirectory</span> <span class="o">!=</span> <span class="nb">NULL</span><span class="p">)</span> <span class="p">{</span>
            <span class="n">NtClose</span><span class="p">(</span><span class="n">hDirectory</span><span class="p">);</span>
        <span class="p">}</span>
    <span class="p">}</span>
    <span class="kr">__except</span> <span class="p">(</span><span class="n">EXCEPTION_EXECUTE_HANDLER</span><span class="p">)</span> <span class="p">{</span>
        <span class="n">status</span> <span class="o">=</span> <span class="n">STATUS_ACCESS_VIOLATION</span><span class="p">;</span>
    <span class="p">}</span>

    <span class="k">return</span> <span class="n">status</span><span class="p">;</span>
<span class="p">}</span></code></pre></figure>

<p><i>Credits for this code sample: <a href="https://github.com/hfiref0x/VMDE">VMDE project</a> </i></p>

<hr class="space" />

<p><b>Detections table</b></p>

<table style="width:93%">
  <tr>
  	<td colspan="3">Check if the following global objects exist:</td>
  </tr>
  <tr>
  	<th style="text-align:center">Detect</th>
  	<th style="text-align:center">Path</th>
    <th style="text-align:center">Object</th>
  </tr>
  <tr>
  	<th rowspan="1">Hyper-V</th>
  	<td>VmGenerationCounter</td>
  	<td>\Device</td>
  </tr>
  <tr>
  	<th rowspan="3">Parallels</th>
  	<td>prl_pv</td>
  	<td>\Device</td>
  </tr>
  <tr>
  	<td>prl_tg</td>
  	<td>\Device</td>
  </tr>
  <tr>
  	<td>prl_time</td>
  	<td>\Device</td>
  </tr>
  <tr>
  	<th rowspan="3">Sandboxie</th>
  	<td>SandboxieDriverApi</td>
  	<td>\Device</td>
  </tr>
  <tr>
  	<td>SbieDrv</td>
  	<td>\Driver</td>
  </tr>
  <tr>
  	<td>SbieSvcPort</td>
  	<td>\RPC Control</td>
  </tr>
  <tr>
  	<th rowspan="4">VirtualBox</th>
  	<td>VBoxGuest</td>
  	<td>\Device</td>
  </tr>
  <tr>
  	<td>VBoxMiniRdr</td>
  	<td>\Device</td>
  </tr>
  <tr>
  	<td>VBoxVideo</td>
  	<td>\Driver</td>
  </tr>
  <tr>
  	<td>VBoxMouse</td>
  	<td>\Driver</td>
  </tr>
  <tr>
  	<th rowspan="2">VirtualPC</th>
  	<td>VirtualMachineServices</td>
  	<td>\Device</td>
  </tr>
  <tr>
  	<td>1-driver-vmsrvc</td>
  	<td>\Driver</td>
  </tr>
  <tr>
  	<th rowspan="1">VMware</th>
  	<td>vmmemctl</td>
  	<td>\Device</td>
  </tr>
</table>

<p><br /></p>
<h3><a class="a-dummy" name="check-if-object-directory-present">5. Check for object directory (Sandboxie only)</a></h3>

<p>This method checks for particular object directory which is present in Sandboxie virtual environment but not in usual host systems.</p>

<p>Function used:</p>
<ul>
<li><tt>GetFileAttributes</tt></li> 
</ul>

<hr class="space" />

<p><b>Code sample</b></p>
<p></p>

<figure class="highlight"><pre><code class="language-c" data-lang="c"><span class="cp">#define DIRECTORY_QUERY (0x0001)
#define OBJ_CASE_INSENSITIVE 0x00000040L
#define DIRECTORY_SANDBOXIE L"\\Sandbox"
</span>
<span class="kt">int</span> <span class="nf">check_if_obj_dir_present</span><span class="p">()</span> <span class="p">{</span>
    <span class="n">OBJECT_ATTRIBUTES</span> <span class="n">attr</span><span class="p">;</span>
    <span class="n">UNICODE_STRING</span> <span class="n">ustrName</span><span class="p">;</span>
    <span class="n">HANDLE</span> <span class="n">hObject</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>

    <span class="n">RtlSecureZeroMemory</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ustrName</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">ustrName</span><span class="p">));</span>
    <span class="n">RtlInitUnicodeString</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ustrName</span><span class="p">,</span> <span class="n">DIRECTORY_SANDBOXIE</span><span class="p">);</span>
    <span class="n">InitializeObjectAttributes</span><span class="p">(</span><span class="o">&amp;</span><span class="n">attr</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">ustrName</span><span class="p">,</span> <span class="n">OBJ_CASE_INSENSITIVE</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">);</span>

    <span class="k">if</span> <span class="p">(</span><span class="n">NT_SUCCESS</span><span class="p">(</span><span class="n">NtOpenDirectoryObject</span><span class="p">(</span><span class="o">&amp;</span><span class="n">hObject</span><span class="p">,</span> <span class="n">DIRECTORY_QUERY</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">attr</span><span class="p">)))</span> <span class="p">{</span>
        <span class="n">NtClose</span><span class="p">(</span><span class="n">hObject</span><span class="p">);</span>
        <span class="k">return</span> <span class="n">TRUE</span><span class="p">;</span>
    <span class="p">}</span>
    
    <span class="k">return</span> <span class="n">FALSE</span><span class="p">;</span>
<span class="p">}</span></code></pre></figure>

<p><i>Credits for this code sample: <a href="https://github.com/hfiref0x/VMDE">VMDE project</a> </i></p>

<hr class="space" />

<p><b>Signature recommendations</b></p>
<p></p>
<p>If the following function contains 3rd argument with its field <font face="Courier New">"ObjectName-&gt;Buffer"</font> from the table column <font face="Courier New">`Name`</font>:</p>
<p></p>
<ul>
<li><tt>NtOpenDirectoryObject(..., ..., attr, ...)</tt></li> 
</ul>
<p>then it’s an indication of application trying to use the evasion technique.</p>

<p><br />
3rd argument is of the following type:</p>

<figure class="highlight"><pre><code class="language-c" data-lang="c"><span class="k">typedef</span> <span class="k">struct</span> <span class="n">_OBJECT_ATTRIBUTES</span> <span class="p">{</span>
    <span class="n">ULONG</span> <span class="n">Length</span><span class="p">;</span>
    <span class="n">HANDLE</span> <span class="n">RootDirectory</span><span class="p">;</span>
    <span class="n">PUNICODE_STRING</span> <span class="n">ObjectName</span><span class="p">;</span>
    <span class="n">ULONG</span> <span class="n">Attributes</span><span class="p">;</span>
    <span class="n">PVOID</span> <span class="n">SecurityDescriptor</span><span class="p">;</span>
    <span class="n">PVOID</span> <span class="n">SecurityQualityOfService</span><span class="p">;</span>
<span class="p">}</span> <span class="n">OBJECT_ATTRIBUTES</span><span class="p">;</span></code></pre></figure>

<hr class="space" />

<p><b>Detections table</b></p>

<table style="width:62%">
  <tr>
  	<td colspan="2">Check if the following object directory exists:</td>
  </tr>
  <tr>
  	<th style="text-align:center">Detect</th>
  	<th style="text-align:center">Path</th>
  </tr>
  <tr>
  	<th rowspan="1">Sandboxie</th>
  	<td>\Sandbox</td>
  </tr>
</table>

<p><br /></p>
<h3><a class="a-dummy" name="check-if-virtual-registry-present">6. Check if virtual registry is present in OS (Sandboxie only)</a></h3>

<p>This method checks for virtual registry which is present in Sandboxie virtual environment but not in usual host systems.</p>

<p>Application opens registry key <font face="Courier New">\REGISTRY\USER</font>. It uses the following function in order to check real object name:</p>

<figure class="highlight"><pre><code class="language-c" data-lang="c"><span class="n">NtQueryObject</span><span class="p">(</span>
    <span class="n">hUserKey</span><span class="p">,</span>
    <span class="n">ObjectNameInformation</span><span class="p">,</span>
    <span class="n">oni</span><span class="p">,</span> <span class="c1">// OBJECT_NAME_INFORMATION object</span>
    <span class="n">Size</span><span class="p">,</span>
    <span class="nb">NULL</span><span class="p">);</span></code></pre></figure>

<p>If received <font face="Courier New">OBJECT_NAME_INFORMATION</font> object name does not equal to the <font face="Courier New">"\REGISTRY\USER"</font>, then application assumes that it runs inside Sandboxie environment.</p>

<hr class="space" />

<p><b>Signature recommendations</b></p>
<p></p>
<p>If the following function is used for opening <font face="Courier New">\REGISTRY\USER</font>:</p>
<p></p>
<ul>
<li><tt>NtOpenKey</tt></li> 
</ul>
<p>and is followed by the call of the following function with its 1st argument being the handle of <font face="Courier New">\REGISTRY\USER</font> key:</p>
<ul>
<li><tt>NtQueryObject(hUserKey, ...)</tt></li> 
</ul>
<p>then it’s an indication of application trying to use the evasion technique.</p>

<p><br /></p>
<h3><a class="a-dummy" name="countermeasures">Countermeasures</a></h3>

<p>Hook target functions and return appropriate results if indicators (objects from tables) are triggered. In some cases stopping appropriate device may help — but it’s not a universal counter-action: not all global objects are devices.</p>

<p><br /></p>
<h3><a class="a-dummy" name="credits">Credits</a></h3>

<p>Credits go to open-source project from where code samples were taken:</p>
<ul>
<li>VMDE project on <a href="https://github.com/hfiref0x/VMDE">github</a></li>
</ul>

<p>Though Check Point tool InviZzzible has them all implemented, due to modular structure of the code it would require more space to show a code sample from this tool for the same purposes. That’s why we’ve decided to use other great open-source projects for examples throughout the encyclopedia.</p>


    <br>
    <div style="text-align: left">
        <a href="..">Go back</a>
    </div>
    <br>
    <div class="sharebuttons" style="text-align: center">
        <hr />
        <ul>
          <li>
            <p class="sharetitle"> Share this: </p>
          </li>
          <li class="reddit">
            <a href="http://www.reddit.com/submit?url=https://evasions.checkpoint.com/src/Evasions/techniques/global-os-objects.html&title=Evasions:%20Global%20OS%20Objects - Evasion Techniques" target="_blank">
                <svg xmlns="http://www.w3.org/2000/svg"
                aria-label="Reddit" role="img"
                viewBox="0 0 512 512"><rect
                width="512" height="512"
                rx="15%"
                fill="#f40"/><g fill="#fff"><ellipse cx="256" cy="307" rx="166" ry="117"/><circle cx="106" cy="256" r="42"/><circle cx="407" cy="256" r="42"/><circle cx="375" cy="114" r="32"/></g><g stroke-linecap="round" stroke-linejoin="round" fill="none"><path d="m256 196 23-101 73 15" stroke="#fff" stroke-width="16"/><path d="m191 359c33 25 97 26 130 0" stroke="#f40" stroke-width="13"/></g><g fill="#f40"><circle cx="191" cy="287" r="31"/><circle cx="321" cy="287" r="31"/></g></svg>
                
            </a>
          </li>
          <li class="hn">
            <a href="http://news.ycombinator.com/submitlink?u=https://evasions.checkpoint.com/src/Evasions/techniques/global-os-objects.html&t=Evasions:%20Global%20OS%20Objects - Evasion Techniques" target="_blank">
                <svg xmlns="http://www.w3.org/2000/svg"
                aria-label="Hacker News" role="img"
                viewBox="0 0 512 512"><rect
                width="512" height="512"
                rx="15%"
                fill="#f60"/><path fill="#fff" d="M124 91h51l81 162 81-164h51L276 293v136h-40V293z"/></svg>
            </a>
          </li>
          <li class="twitter">
            <a href="https://twitter.com/intent/tweet?via=_CPResearch_&url=https://evasions.checkpoint.com/src/Evasions/techniques/global-os-objects.html&text=Evasions:%20Global%20OS%20Objects - Evasion Techniques" target="_blank">
                <svg viewBox="0 0 1792 1792" xmlns="http://www.w3.org/2000/svg"><path d="M1684 408q-67 98-162 167 1 14 1 42 0 130-38 259.5t-115.5 248.5-184.5 210.5-258 146-323 54.5q-271 0-496-145 35 4 78 4 225 0 401-138-105-2-188-64.5t-114-159.5q33 5 61 5 43 0 85-11-112-23-185.5-111.5t-73.5-205.5v-4q68 38 146 41-66-44-105-115t-39-154q0-88 44-163 121 149 294.5 238.5t371.5 99.5q-8-38-8-74 0-134 94.5-228.5t228.5-94.5q140 0 236 102 109-21 205-78-37 115-142 178 93-10 186-50z"/></svg>
            </a>
          </li>
          <li class="linkedin">
            <a href=https://www.linkedin.com/shareArticle?mini=true&url=https://evasions.checkpoint.com/src/Evasions/techniques/global-os-objects.html&title=Evasions:%20Global%20OS%20Objects - Evasion Techniques&source=LinkedIn" target="_blank">
                <svg viewBox="0 0 1792 1792" xmlns="http://www.w3.org/2000/svg"><path d="M477 625v991h-330v-991h330zm21-306q1 73-50.5 122t-135.5 49h-2q-82 0-132-49t-50-122q0-74 51.5-122.5t134.5-48.5 133 48.5 51 122.5zm1166 729v568h-329v-530q0-105-40.5-164.5t-126.5-59.5q-63 0-105.5 34.5t-63.5 85.5q-11 30-11 81v553h-329q2-399 2-647t-1-296l-1-48h329v144h-2q20-32 41-56t56.5-52 87-43.5 114.5-15.5q171 0 275 113.5t104 332.5z"/></svg>
            </a>
          </li>
        </ul>
      </div>
      
</article>


</section>

<nav class="navbar navbar-default navbar-fixed-bottom">
  <div class="container footer-content">

    Made with <font class="a-pink"><i class ="fa fa-heart"></i></font> to serve the community by Check Point Research    |    <a class="a-pink" href="https://research.checkpoint.com">Research blog</a>    |    <a class="a-pink" href="https://research.checkpoint.com/about-us/">About Us</a>    |    <a class="a-pink" href="https://github.com/CheckPointSW"><i class="fa fa-github fa-lg"></i></a> <a class="a-pink" href="https://twitter.com/_CPResearch_"><i class="fa fa-twitter fa-lg"></i></a>
    
    <br>
    
    © 1994-2024 Check Point Software Technologies LTD | All rights reserved | Property of CheckPoint.com


  </div>
</nav>

  </body>

</html>
<!DOCTYPE html>
<html>

  <head>
  <meta charset="utf-8">
  <meta http-equiv="X-UA-Compatible" content="IE=edge">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-194688-3"></script>
  <script>
   window.dataLayer = window.dataLayer || [];
   function gtag(){dataLayer.push(arguments);}
   gtag('js', new Date());
   gtag('config', 'UA-194688-3');
  </script>
  <meta content="Evasion techniques" property="og:site_name">

  <meta content="Evasions: Hardware" property="og:title">


  <meta name="twitter:title" content="Malware Evasion Encyclopedia" />
  <meta name="twitter:image" content="https://research.checkpoint.com/wp-content/uploads/2020/02/evasions.jpg" />


  <meta content="article" property="og:type">


  <meta content="Evasion techniques
" property="og:description">


  <meta content="https://evasions.checkpoint.com/src/Evasions/techniques/hardware.html" property="og:url">


  <meta content="2024-07-10T07:20:28+00:00" property="article:published_time">
  <meta content="https://evasions.checkpoint.com/about/" property="article:author">


  <meta property="og:image" content="">


  
  <meta content="evasions" property="article:section">
  


  
  <meta content="hardware" property="article:tag">
  

  <title>Evasions: Hardware</title>
  <meta name="description" content="Contents">
<script src="https://ajax.googleapis.com/ajax/libs/jquery/2.2.2/jquery.min.js"></script>
<script src="https://maxcdn.bootstrapcdn.com/bootstrap/3.3.6/js/bootstrap.min.js" integrity="sha384-0mSbJDEHialfmuBBQP6A4Qrprq5OVfW37PRR3j5ELqxss1yVqOtnepnHVP9aJ7xS" crossorigin="anonymous"></script>
  <link rel="stylesheet" href="https://evasions.checkpoint.com/assets/css/main.css">
<script src="https://maxcdn.bootstrapcdn.com/bootstrap/3.3.6/js/bootstrap.min.js" integrity="sha384-0mSbJDEHialfmuBBQP6A4Qrprq5OVfW37PRR3j5ELqxss1yVqOtnepnHVP9aJ7xS" crossorigin="anonymous"></script>

  <link href='https://fonts.googleapis.com/css?family=PT+Sans' rel='stylesheet' type='text/css'>
  <link href='https://fonts.googleapis.com/css?family=Fira+Mono' rel='stylesheet' type='text/css'>
  <link href='https://fonts.googleapis.com/css?family=Lato:400,700' rel='stylesheet' type='text/css'>
  <link href='https://fonts.googleapis.com/css?family=Source+Code+Pro:400,200,300,500,600,700,900' rel='stylesheet' type='text/css'>
  <link href='https://fonts.googleapis.com/css?family=Gentium+Basic:400,700' rel='stylesheet' type='text/css'>
  <link href='https://fonts.googleapis.com/css?family=Alegreya:400,400italic,700' rel='stylesheet' type='text/css'>
  <link href='https://fonts.googleapis.com/css?family=Lora:400,400italic,700' rel='stylesheet' type='text/css'>
  <link href='https://fonts.googleapis.com/css?family=Fira+Sans:400,300,500,700' rel='stylesheet' type='text/css'>
  <script src="https://ajax.googleapis.com/ajax/libs/jquery/2.2.0/jquery.min.js"></script>
  <link href='https://fonts.googleapis.com/css?family=Open+Sans:400,700' rel='stylesheet' type='text/css'>
  <link href="https://maxcdn.bootstrapcdn.com/bootstrap/3.3.6/css/bootstrap.min.css" rel="stylesheet" integrity="sha384-1q8mTJOASx8j1Au+a5WDVnPi2lkFfwwEAa8hDDdjZlpLegxhjVME1fgjWPGmkzs7" crossorigin="anonymous">
  <link href="https://maxcdn.bootstrapcdn.com/font-awesome/4.6.1/css/font-awesome.min.css" rel="stylesheet" integrity="sha384-hQpvDQiCJaD2H465dQfA717v7lu5qHWtDbWNPvaTJ0ID5xnPUlVXnKzq7b8YUkbN" crossorigin="anonymous">
  <link rel="canonical" href="https://evasions.checkpoint.com/src/Evasions/techniques/hardware.html">
  <link rel="alternate" type="application/rss+xml" title="Evasion techniques" href="https://evasions.checkpoint.com/feed.xml">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/tinysort/2.3.6/tinysort.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/tinysort/2.3.6/tinysort.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/tinysort/2.3.6/tinysort.charorder.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/tinysort/2.3.6/tinysort.charorder.min.js"></script>
  <script type="text/javascript" async src="//platform.twitter.com/widgets.js"></script>




</head>


  <body>
<section>
<article class="post" itemscope itemtype="http://schema.org/BlogPosting">
  <div class="jumbotron">
    <div class="container">
      <h1 class="post-title-main" itemprop="name headline">Evasions: Hardware</h1>
    </div>
</div>

  <div class="post-content container" itemprop="articleBody">
    <div style="text-align: left">
        <a href="..">Go back</a>
        <br>
        <br>
    </div>
    <h1>Contents</h1>

<p><a href="#hardware-detection-methods">Hardware info detection methods</a>
<br />
  <a href="#check-if-hdd-has-specific-name">1. Check if HDD has specific name</a>
<br />
  <a href="#check-if-hdd-vendor-id-has-specific-value">2. Check if HDD Vendor ID has specific value</a>
<br />
  <a href="#check-if-audio-device-is-absent">3. Check if audio device is absent</a>
<br />
  <a href="#check-if-cpu-temperature-information-is-available">4. Check if CPU temperature information if available</a>
<br />
  <a href="#check-directx-adapter">5. Check physical display adapter for IDirect3D9 interface</a>
<br />
  <a href="#signature-recommendations">Signature recommendations</a>
<br />
  <a href="#countermeasures-sandboxie">Countermeasures</a>
<br />
<br /></p>

<hr class="space" />

<h2><a class="a-dummy" name="hardware-detection-methods">Hardware info detection methods</a></h2>
<p>Virtual environments emulate hardware devices and leave specific traces in their descriptions - which may be queried and the conclusion about non-host OS made.</p>

<p><br /></p>
<h3><a class="a-dummy" name="check-if-hdd-has-specific-name">1. Check if HDD has specific name</a></h3>

<p>Functions used:</p>
<ul>
  <li><tt>SetupDiGetClassDevs</tt></li> 
  <li><tt>SetupDiEnumDeviceInfo</tt></li> 
  <li><tt>SetupDiGetDeviceRegistryProperty</tt></li> 
</ul>

<hr class="space" />

<p><b>Code sample</b></p>
<p></p>

<figure class="highlight"><pre><code class="language-c" data-lang="c"><span class="n">hDevs</span> <span class="o">=</span> <span class="n">SetupDiGetClassDevs</span><span class="p">(</span>
    <span class="o">&amp;</span><span class="n">guid</span><span class="p">,</span>  <span class="c1">// GUID_DEVCLASS(DEVINTERFACE)_DISKDRIVE</span>
    <span class="nb">NULL</span><span class="p">,</span>
    <span class="nb">NULL</span><span class="p">,</span>
    <span class="n">DIGCF_PRESENT</span><span class="p">);</span>

<span class="n">SetupDiEnumDeviceInfo</span><span class="p">(</span>
    <span class="n">hDevsInfo</span><span class="p">,</span>
    <span class="mi">0</span><span class="p">,</span>
    <span class="o">&amp;</span><span class="n">devinfo</span><span class="p">);</span>  <span class="c1">// PSP_DEVINFO_DATA</span>

<span class="n">SetupDiGetDeviceRegistryProperty</span><span class="p">(</span>
    <span class="n">hDevs</span><span class="p">,</span>
    <span class="o">&amp;</span><span class="n">devinfo</span><span class="p">,</span>
    <span class="n">SPDRP_FRIENDLYNAME</span><span class="p">,</span>
    <span class="o">&amp;</span><span class="n">dword_1</span><span class="p">,</span>
    <span class="n">szFriendlyName</span><span class="p">,</span>  <span class="c1">// HDD name will be here</span>
    <span class="n">dFriendlyNameSize</span><span class="p">,</span>
    <span class="o">&amp;</span><span class="n">dword_2</span><span class="p">);</span></code></pre></figure>

<hr class="space" />

<p><b>Detections table</b></p>

<table style="width:60%">
  <tr>
    <td colspan="2">Check if hard disk drive has one of the following names:</td>
  </tr>
  <tr>
    <th style="text-align:center">Detect</th>
    <th style="text-align:center">Name</th>
  </tr>
  <tr>
    <th>QEMU</th>
    <td>QEMU</td>
  </tr>
  <tr>
    <th>VirtualBox</th>
    <td>VBOX</td>
  </tr>
  <tr>
    <th>VirtualPC</th>
    <td>VIRTUAL HD</td>
  </tr>
  <tr>
    <th>VMware</th>
    <td>VMware</td>
  </tr>
</table>

<p><br /></p>
<h3><a class="a-dummy" name="check-if-hdd-vendor-id-has-specific-value">2. Check if HDD Vendor ID has specific value</a></h3>

<p>The following function is used:</p>
<ul>
  <li><tt>DeviceIoControl(..., IOCTL_STORAGE_QUERY_PROPERTY, ...)</tt></li> 
</ul>

<hr class="space" />

<p><b>Code sample</b></p>
<p></p>

<figure class="highlight"><pre><code class="language-c" data-lang="c"><span class="n">bool</span> <span class="nf">GetHDDVendorId</span><span class="p">(</span><span class="n">std</span><span class="o">::</span><span class="n">string</span><span class="o">&amp;</span> <span class="n">outVendorId</span><span class="p">)</span> <span class="p">{</span>
    <span class="n">HANDLE</span> <span class="n">hDevice</span> <span class="o">=</span> <span class="n">CreateFileA</span><span class="p">(</span><span class="n">_T</span><span class="p">(</span><span class="s">"</span><span class="se">\\\\</span><span class="s">.</span><span class="se">\\</span><span class="s">PhysicalDrive0"</span><span class="p">),</span> 
                                 <span class="mi">0</span><span class="p">,</span> 
                                 <span class="n">FILE_SHARE_READ</span> <span class="o">|</span> <span class="n">FILE_SHARE_WRITE</span><span class="p">,</span> 
                                 <span class="mi">0</span><span class="p">,</span> 
                                 <span class="n">OPEN_EXISTING</span><span class="p">,</span> 
                                 <span class="mi">0</span><span class="p">,</span> 
                                 <span class="mi">0</span><span class="p">);</span>
    <span class="k">if</span> <span class="p">(</span><span class="n">hDevice</span> <span class="o">==</span> <span class="n">INVALID_HANDLE_VALUE</span><span class="p">)</span>
        <span class="k">return</span> <span class="nb">false</span><span class="p">;</span>
    
    <span class="n">STORAGE_PROPERTY_QUERY</span> <span class="n">storage_property_query</span> <span class="o">=</span> <span class="p">{};</span>
    <span class="n">storage_property_query</span><span class="p">.</span><span class="n">PropertyId</span> <span class="o">=</span> <span class="n">StorageDeviceProperty</span><span class="p">;</span>
    <span class="n">storage_property_query</span><span class="p">.</span><span class="n">QueryType</span> <span class="o">=</span> <span class="n">PropertyStandardQuery</span><span class="p">;</span>
    <span class="n">STORAGE_DESCRIPTOR_HEADER</span> <span class="n">storage_descriptor_header</span> <span class="o">=</span> <span class="p">{};</span>
    <span class="n">DWORD</span> <span class="n">BytesReturned</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
  
    <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">DeviceIoControl</span><span class="p">(</span><span class="n">hDevice</span><span class="p">,</span> <span class="n">IOCTL_STORAGE_QUERY_PROPERTY</span><span class="p">,</span> 
                         <span class="o">&amp;</span><span class="n">storage_property_query</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">storage_property_query</span><span class="p">),</span> 
                         <span class="o">&amp;</span><span class="n">storage_descriptor_header</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">storage_descriptor_header</span><span class="p">),</span> 
                         <span class="o">&amp;</span><span class="n">BytesReturned</span><span class="p">,</span> <span class="p">))</span> <span class="p">{</span>
        <span class="n">printf</span><span class="p">(</span><span class="s">"DeviceIoControl() for size query failed</span><span class="se">\n</span><span class="s">"</span><span class="p">);</span>
        <span class="n">CloseHandle</span><span class="p">(</span><span class="n">hDevice</span><span class="p">);</span>
        <span class="k">return</span> <span class="nb">false</span><span class="p">;</span>
    <span class="p">}</span>
    <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">BytesReturned</span><span class="p">)</span> <span class="p">{</span>
        <span class="n">CloseHandle</span><span class="p">(</span><span class="n">hDevice</span><span class="p">);</span>
        <span class="k">return</span> <span class="nb">false</span><span class="p">;</span>
    <span class="p">}</span>
  
    <span class="n">std</span><span class="o">::</span><span class="n">vector</span><span class="o">&lt;</span><span class="kt">char</span><span class="o">&gt;</span> <span class="n">buff</span><span class="p">(</span><span class="n">storage_descriptor_header</span><span class="p">.</span><span class="n">Size</span><span class="p">);</span> <span class="c1">//_STORAGE_DEVICE_DESCRIPTOR</span>
    <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">DeviceIoControl</span><span class="p">(</span><span class="n">hDevice</span><span class="p">,</span> <span class="n">IOCTL_STORAGE_QUERY_PROPERTY</span><span class="p">,</span> 
                         <span class="o">&amp;</span><span class="n">storage_property_query</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">storage_property_query</span><span class="p">),</span> 
                         <span class="n">buff</span><span class="p">.</span><span class="n">data</span><span class="p">(),</span> <span class="n">buff</span><span class="p">.</span><span class="n">size</span><span class="p">(),</span> <span class="mi">0</span><span class="p">))</span> <span class="p">{</span>
        <span class="n">CloseHandle</span><span class="p">(</span><span class="n">hDevice</span><span class="p">);</span>
        <span class="k">return</span> <span class="nb">false</span><span class="p">;</span>
    <span class="p">}</span>
  
    <span class="n">CloseHandle</span><span class="p">(</span><span class="n">hDevice</span><span class="p">);</span>
  
    <span class="k">if</span> <span class="p">(</span><span class="n">BytesReturned</span><span class="p">)</span> <span class="p">{</span>
        <span class="n">STORAGE_DEVICE_DESCRIPTOR</span><span class="o">*</span> <span class="n">device_descriptor</span> <span class="o">=</span> <span class="p">(</span><span class="n">STORAGE_DEVICE_DESCRIPTOR</span><span class="o">*</span><span class="p">)</span><span class="n">buff</span><span class="p">.</span><span class="n">data</span><span class="p">();</span>
        <span class="k">if</span> <span class="p">(</span><span class="n">device_descriptor</span><span class="o">-&gt;</span><span class="n">VendorIdOffset</span><span class="p">)</span>
            <span class="n">outVendorId</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">buff</span><span class="p">[</span><span class="n">device_descriptor</span><span class="o">-&gt;</span><span class="n">VendorIdOffset</span><span class="p">];</span>
  
        <span class="k">return</span> <span class="nb">true</span><span class="p">;</span>
    <span class="p">}</span>
    
    <span class="k">return</span> <span class="nb">false</span><span class="p">;</span>
<span class="p">}</span></code></pre></figure>

<hr class="space" />

<p><b>Detections table</b></p>

<table style="width:60%">
  <tr>
    <td colspan="2">Check if HDD Vendor ID is one of the following:</td>
  </tr>
  <tr>
    <th style="text-align:center">Detect</th>
    <th style="text-align:center">Name</th>
  </tr>
  <tr>
    <th>VirtualBox</th>
    <td>VBOX</td>
  </tr>
  <tr>
    <th>VMware</th>
    <td>vmware</td>
  </tr>
</table>

<p><br /></p>
<h3><a class="a-dummy" name="check-if-audio-device-is-absent">3. Check if audio device is absent</a></h3>

<p>This technique was extracted from TeslaCrypt malware sample and was described <a href="https://www.joesecurity.org/blog/6933341622592617830">in this Joe Security blog post</a>.</p>

<hr class="space" />

<p><b>Code sample</b></p>
<p></p>

<figure class="highlight"><pre><code class="language-c" data-lang="c"><span class="kt">void</span> <span class="nf">AudioEvasion</span><span class="p">()</span> <span class="p">{</span>
  <span class="n">PCWSTR</span> <span class="n">wszfilterName</span> <span class="o">=</span> <span class="s">L"audio_device_random_name"</span><span class="p">;</span>

  <span class="k">if</span> <span class="p">(</span><span class="n">FAILED</span><span class="p">(</span><span class="n">CoInitialize</span><span class="p">(</span><span class="nb">NULL</span><span class="p">)))</span>
    <span class="k">return</span><span class="p">;</span>

  <span class="n">IGraphBuilder</span> <span class="o">*</span><span class="n">pGraph</span> <span class="o">=</span> <span class="n">nullptr</span><span class="p">;</span>
  <span class="k">if</span> <span class="p">(</span><span class="n">FAILED</span><span class="p">(</span><span class="n">CoCreateInstance</span><span class="p">(</span><span class="n">CLSID_FilterGraph</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">,</span> <span class="n">CLSCTX_INPROC_SERVER</span><span class="p">,</span> <span class="n">IID_IGraphBuilder</span><span class="p">,</span> <span class="p">(</span><span class="kt">void</span><span class="o">**</span><span class="p">)</span><span class="o">&amp;</span><span class="n">pGraph</span><span class="p">)))</span>
    <span class="k">return</span><span class="p">;</span>

  <span class="k">if</span> <span class="p">(</span><span class="n">E_POINTER</span> <span class="o">!=</span> <span class="n">pGraph</span><span class="o">-&gt;</span><span class="n">AddFilter</span><span class="p">(</span><span class="nb">NULL</span><span class="p">,</span> <span class="n">wszfilterName</span><span class="p">))</span>
    <span class="n">ExitProcess</span><span class="p">(</span><span class="o">-</span><span class="mi">1</span><span class="p">);</span>

  <span class="n">IBaseFilter</span> <span class="o">*</span><span class="n">pBaseFilter</span> <span class="o">=</span> <span class="n">nullptr</span><span class="p">;</span>
  <span class="n">CoCreateInstance</span><span class="p">(</span><span class="n">CLSID_AudioRender</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">,</span> <span class="n">CLSCTX_INPROC_SERVER</span><span class="p">,</span> <span class="n">IID_IBaseFilter</span><span class="p">,</span> <span class="p">(</span><span class="kt">void</span><span class="o">**</span><span class="p">)</span><span class="o">&amp;</span><span class="n">pBaseFilter</span><span class="p">);</span>
  
  <span class="n">pGraph</span><span class="o">-&gt;</span><span class="n">AddFilter</span><span class="p">(</span><span class="n">pBaseFilter</span><span class="p">,</span> <span class="n">wszfilterName</span><span class="p">);</span>

  <span class="n">IBaseFilter</span> <span class="o">*</span><span class="n">pBaseFilter2</span> <span class="o">=</span> <span class="n">nullptr</span><span class="p">;</span>
  <span class="n">pGraph</span><span class="o">-&gt;</span><span class="n">FindFilterByName</span><span class="p">(</span><span class="n">wszfilterName</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">pBaseFilter2</span><span class="p">);</span>
  <span class="k">if</span> <span class="p">(</span><span class="n">nullptr</span> <span class="o">==</span> <span class="n">pBaseFilter2</span><span class="p">)</span>
    <span class="n">ExitProcess</span><span class="p">(</span><span class="mi">1</span><span class="p">);</span>

  <span class="n">FILTER_INFO</span> <span class="n">info</span> <span class="o">=</span> <span class="p">{</span> <span class="mi">0</span> <span class="p">};</span>
  <span class="n">pBaseFilter2</span><span class="o">-&gt;</span><span class="n">QueryFilterInfo</span><span class="p">(</span><span class="o">&amp;</span><span class="n">info</span><span class="p">);</span>
  <span class="k">if</span> <span class="p">(</span><span class="mi">0</span> <span class="o">!=</span> <span class="n">wcscmp</span><span class="p">(</span><span class="n">info</span><span class="p">.</span><span class="n">achName</span><span class="p">,</span> <span class="n">wszfilterName</span><span class="p">))</span>
    <span class="k">return</span><span class="p">;</span>

  <span class="n">IReferenceClock</span> <span class="o">*</span><span class="n">pClock</span> <span class="o">=</span> <span class="n">nullptr</span><span class="p">;</span>
  <span class="k">if</span> <span class="p">(</span><span class="mi">0</span> <span class="o">!=</span> <span class="n">pBaseFilter2</span><span class="o">-&gt;</span><span class="n">GetSyncSource</span><span class="p">(</span><span class="o">&amp;</span><span class="n">pClock</span><span class="p">))</span>
    <span class="k">return</span><span class="p">;</span>
  <span class="k">if</span> <span class="p">(</span><span class="mi">0</span> <span class="o">!=</span> <span class="n">pClock</span><span class="p">)</span>
    <span class="k">return</span><span class="p">;</span>

  <span class="n">CLSID</span> <span class="n">clsID</span> <span class="o">=</span> <span class="p">{</span> <span class="mi">0</span> <span class="p">};</span>
  <span class="n">pBaseFilter2</span><span class="o">-&gt;</span><span class="n">GetClassID</span><span class="p">(</span><span class="o">&amp;</span><span class="n">clsID</span><span class="p">);</span>
  <span class="k">if</span> <span class="p">(</span><span class="n">clsID</span><span class="p">.</span><span class="n">Data1</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span>
    <span class="n">ExitProcess</span><span class="p">(</span><span class="mi">1</span><span class="p">);</span>

  <span class="k">if</span> <span class="p">(</span><span class="n">nullptr</span> <span class="o">==</span> <span class="n">pBaseFilter2</span><span class="p">)</span>
    <span class="n">ExitProcess</span><span class="p">(</span><span class="o">-</span><span class="mi">1</span><span class="p">);</span>

  <span class="n">IEnumPins</span> <span class="o">*</span><span class="n">pEnum</span> <span class="o">=</span> <span class="n">nullptr</span><span class="p">;</span>
  <span class="k">if</span> <span class="p">(</span><span class="mi">0</span> <span class="o">!=</span> <span class="n">pBaseFilter2</span><span class="o">-&gt;</span><span class="n">EnumPins</span><span class="p">(</span><span class="o">&amp;</span><span class="n">pEnum</span><span class="p">))</span>
    <span class="n">ExitProcess</span><span class="p">(</span><span class="o">-</span><span class="mi">1</span><span class="p">);</span>

  <span class="k">if</span> <span class="p">(</span><span class="mi">0</span> <span class="o">==</span> <span class="n">pBaseFilter2</span><span class="o">-&gt;</span><span class="n">AddRef</span><span class="p">())</span>
    <span class="n">ExitProcess</span><span class="p">(</span><span class="o">-</span><span class="mi">1</span><span class="p">);</span>
<span class="p">}</span></code></pre></figure>

<p><br /></p>
<h3><a class="a-dummy" name="check-if-cpu-temperature-information-is-available">4. Check if CPU temperature information is available</a></h3>

<p>This technique was extracted from GravityRAT malware and is described <a href="https://blog.talosintelligence.com/2018/04/gravityrat-two-year-evolution-of-apt.html">by this link</a>.</p>

<hr class="space" />

<p><b>Code sample (Windows cmd command)</b></p>
<p></p>

<figure class="highlight"><pre><code class="language-cm" data-lang="cm">wmic /namespace:\\root\WMI path MSAcpi_ThermalZoneTemperature get CurrentTemperature</code></pre></figure>

<p><br /></p>
<h3><a class="a-dummy" name="check-directx-adapter">5. Check physical display adapter for IDirect3D9 interface</a></h3>

<p>This method checks physical display adapters present in the system when the IDirect3D9 interface was instantiated. It works on all Windows versions starting from Windows XP.</p>

<p>Functions used:</p>
<ul>
<li><tt>Direct3DCreate9</tt> - called from <font face="Courier New">`d3d9.dll`</font> library</li>
<li><tt>GetAdapterIdentifier</tt> - called via <font face="Courier New">IDirect3D9</font> interface</li> 
</ul>

<hr class="space" />

<p><b>Code sample</b></p>
<p></p>

<figure class="highlight"><pre><code class="language-c" data-lang="c"><span class="cp">#include</span> <span class="cpf">&lt;d3d9.h&gt;</span><span class="cp">
</span>
<span class="c1">// https://github.com/qt/qtbase/blob/dev/src/plugins/platforms/windows/qwindowsopengltester.cpp#L124</span>

<span class="kt">void</span> <span class="nf">detect</span><span class="p">()</span> <span class="p">{</span>
    <span class="k">typedef</span> <span class="n">IDirect3D9</span><span class="o">*</span> <span class="p">(</span><span class="n">WINAPI</span><span class="o">*</span> <span class="n">PtrDirect3DCreate9</span><span class="p">)(</span><span class="n">UINT</span><span class="p">);</span>

    <span class="n">HMODULE</span> <span class="n">d3d9lib</span> <span class="o">=</span> <span class="o">::</span><span class="n">LoadLibraryA</span><span class="p">(</span><span class="s">"d3d9"</span><span class="p">);</span>
    <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">d3d9lib</span><span class="p">)</span>
        <span class="k">return</span><span class="p">;</span>

    <span class="n">PtrDirect3DCreate9</span> <span class="n">direct3DCreate9</span> <span class="o">=</span> <span class="p">(</span><span class="n">PtrDirect3DCreate9</span><span class="p">)</span><span class="n">GetProcAddress</span><span class="p">(</span><span class="n">d3d9lib</span><span class="p">,</span> <span class="s">"Direct3DCreate9"</span><span class="p">);</span>
    <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">direct3DCreate9</span><span class="p">)</span>
        <span class="k">return</span><span class="p">;</span>

    <span class="n">IDirect3D9</span><span class="o">*</span> <span class="n">direct3D9</span> <span class="o">=</span> <span class="n">direct3DCreate9</span><span class="p">(</span><span class="n">D3D_SDK_VERSION</span><span class="p">);</span>
    <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">direct3D9</span><span class="p">)</span>
        <span class="k">return</span><span class="p">;</span>

    <span class="n">D3DADAPTER_IDENTIFIER9</span> <span class="n">adapterIdentifier</span><span class="p">;</span>
    <span class="k">const</span> <span class="n">HRESULT</span> <span class="n">hr</span> <span class="o">=</span> <span class="n">direct3D9</span><span class="o">-&gt;</span><span class="n">GetAdapterIdentifier</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">adapterIdentifier</span><span class="p">);</span>
    <span class="n">direct3D9</span><span class="o">-&gt;</span><span class="n">Release</span><span class="p">();</span>

    <span class="k">if</span> <span class="p">(</span><span class="n">SUCCEEDED</span><span class="p">(</span><span class="n">hr</span><span class="p">))</span> <span class="p">{</span>
        <span class="n">printf</span><span class="p">(</span><span class="s">"VendorId:    0x%x</span><span class="se">\n</span><span class="s">"</span><span class="p">,</span> <span class="n">adapterIdentifier</span><span class="p">.</span><span class="n">VendorId</span><span class="p">);</span>
        <span class="n">printf</span><span class="p">(</span><span class="s">"DeviceId:    0x%x</span><span class="se">\n</span><span class="s">"</span><span class="p">,</span> <span class="n">adapterIdentifier</span><span class="p">.</span><span class="n">DeviceId</span><span class="p">);</span>
        <span class="n">printf</span><span class="p">(</span><span class="s">"Driver:      %s</span><span class="se">\n</span><span class="s">"</span><span class="p">,</span> <span class="n">adapterIdentifier</span><span class="p">.</span><span class="n">Driver</span><span class="p">);</span>
        <span class="n">printf</span><span class="p">(</span><span class="s">"Description: %s</span><span class="se">\n</span><span class="s">"</span><span class="p">,</span> <span class="n">adapterIdentifier</span><span class="p">.</span><span class="n">Description</span><span class="p">);</span>
    <span class="p">}</span>
<span class="p">}</span></code></pre></figure>

<p><i>Credits for this code sample go to <a href="https://gist.github.com/elsamuko/d3049d52ca235112c99ac3ee30282846">elsamuko</a> who pointed it out</i>.</p>

<hr class="space" />

<p>Example of output on a usual host machine is provided below:</p>

<figure class="highlight"><pre><code class="language-cm" data-lang="cm">VendorId:    0x10de
DeviceId:    0x103c
Driver:      nvldumdx.dll
Description: NVIDIA Quadro K5200</code></pre></figure>

<p>And here is an example of output on a virtual machine (VMware):</p>

<figure class="highlight"><pre><code class="language-cm" data-lang="cm">VendorId:    0x15ad
DeviceId:    0x405
Driver:      vm3dum64_loader.dll
Description: VMware SVGA 3D</code></pre></figure>

<p>Examined fields are named after the corresponding fields of <font face="Courier New">D3DADAPTER_IDENTIFIER9</font> structure. Malware can compare values in these fields to the ones which are known to be present inside the virtual machine and if match is found, then it draws the conclusion that it’s run under virtual machine.</p>

<p><b>Detections table</b></p>

<table style="width:100%">
  <tr>
  	<td colspan="4">Check if the following values are present in the fields of D3DADAPTER_IDENTIFIER9 structure:</td>
  </tr>
  <tr>
  	<th style="text-align:center">Detect</th>
  	<th style="text-align:center">Structure field</th>
    <th style="text-align:center">Value</th>
    <th style="text-align:center">Comment</th>
  </tr>
  <tr>
  	<th rowspan="5">VMware</th>
  	<td>VendorId</td>
    <td>0x15AD</td>
    <td></td>
  </tr>
  <tr>
  	<td>DeviceId</td>
    <td>0x405</td>
    <td>Only when used in combination with VendorId related to VMware (0x15AD)</td>
  </tr>
  <tr>
  	<td>Driver</td>
    <td>vm3dum.dll</td>
    <td></td>
  </tr>
  <tr>
    <td>Driver</td>
  	<td>vm3dum64_loader.dll</td>
    <td></td>
  </tr>
  <tr>
    <td>Description</td>
  	<td>VMware SVGA 3D</td>
    <td></td>
  </tr>
</table>

<p><br /></p>
<h3><a class="a-dummy" name="signature-recommendations">Signature recommendations</a></h3>

<p><i>Signature recommendations are general for each technique: hook the function used and track if it is called. It’s pretty hard to tell why application wants to get HDD name, for example. It doesn’t necessarily mean applying evasion technique. So the best what can be done in this situation is intercepting target functions and tracking their calls.</i></p>

<p><br /></p>
<h3><a class="a-dummy" name="countermeasures-sandboxie">Countermeasures</a></h3>

<ul>
<li><tt>versus HDD checks:</tt> rename HDD so that it's not detected by specific strings;</li> 
<li><tt>versus audio device check:</tt> add audio device;</li> 
<li><tt>versus CPU temperature check:</tt> add stub to hypervisor to output some meaningful information;</li>
<li><tt>versus physical display adapter check:</tt> set up hook on a function <font face="Courier New">GetAdapterIdentifier</font> from <font face="Courier New">d3d9.dll</font>, check if the queried adapter is related to DirectX and replace return values.</li> 
</ul>


    <br>
    <div style="text-align: left">
        <a href="..">Go back</a>
    </div>
    <br>
    <div class="sharebuttons" style="text-align: center">
        <hr />
        <ul>
          <li>
            <p class="sharetitle"> Share this: </p>
          </li>
          <li class="reddit">
            <a href="http://www.reddit.com/submit?url=https://evasions.checkpoint.com/src/Evasions/techniques/hardware.html&title=Evasions:%20Hardware - Evasion Techniques" target="_blank">
                <svg xmlns="http://www.w3.org/2000/svg"
                aria-label="Reddit" role="img"
                viewBox="0 0 512 512"><rect
                width="512" height="512"
                rx="15%"
                fill="#f40"/><g fill="#fff"><ellipse cx="256" cy="307" rx="166" ry="117"/><circle cx="106" cy="256" r="42"/><circle cx="407" cy="256" r="42"/><circle cx="375" cy="114" r="32"/></g><g stroke-linecap="round" stroke-linejoin="round" fill="none"><path d="m256 196 23-101 73 15" stroke="#fff" stroke-width="16"/><path d="m191 359c33 25 97 26 130 0" stroke="#f40" stroke-width="13"/></g><g fill="#f40"><circle cx="191" cy="287" r="31"/><circle cx="321" cy="287" r="31"/></g></svg>
                
            </a>
          </li>
          <li class="hn">
            <a href="http://news.ycombinator.com/submitlink?u=https://evasions.checkpoint.com/src/Evasions/techniques/hardware.html&t=Evasions:%20Hardware - Evasion Techniques" target="_blank">
                <svg xmlns="http://www.w3.org/2000/svg"
                aria-label="Hacker News" role="img"
                viewBox="0 0 512 512"><rect
                width="512" height="512"
                rx="15%"
                fill="#f60"/><path fill="#fff" d="M124 91h51l81 162 81-164h51L276 293v136h-40V293z"/></svg>
            </a>
          </li>
          <li class="twitter">
            <a href="https://twitter.com/intent/tweet?via=_CPResearch_&url=https://evasions.checkpoint.com/src/Evasions/techniques/hardware.html&text=Evasions:%20Hardware - Evasion Techniques" target="_blank">
                <svg viewBox="0 0 1792 1792" xmlns="http://www.w3.org/2000/svg"><path d="M1684 408q-67 98-162 167 1 14 1 42 0 130-38 259.5t-115.5 248.5-184.5 210.5-258 146-323 54.5q-271 0-496-145 35 4 78 4 225 0 401-138-105-2-188-64.5t-114-159.5q33 5 61 5 43 0 85-11-112-23-185.5-111.5t-73.5-205.5v-4q68 38 146 41-66-44-105-115t-39-154q0-88 44-163 121 149 294.5 238.5t371.5 99.5q-8-38-8-74 0-134 94.5-228.5t228.5-94.5q140 0 236 102 109-21 205-78-37 115-142 178 93-10 186-50z"/></svg>
            </a>
          </li>
          <li class="linkedin">
            <a href=https://www.linkedin.com/shareArticle?mini=true&url=https://evasions.checkpoint.com/src/Evasions/techniques/hardware.html&title=Evasions:%20Hardware - Evasion Techniques&source=LinkedIn" target="_blank">
                <svg viewBox="0 0 1792 1792" xmlns="http://www.w3.org/2000/svg"><path d="M477 625v991h-330v-991h330zm21-306q1 73-50.5 122t-135.5 49h-2q-82 0-132-49t-50-122q0-74 51.5-122.5t134.5-48.5 133 48.5 51 122.5zm1166 729v568h-329v-530q0-105-40.5-164.5t-126.5-59.5q-63 0-105.5 34.5t-63.5 85.5q-11 30-11 81v553h-329q2-399 2-647t-1-296l-1-48h329v144h-2q20-32 41-56t56.5-52 87-43.5 114.5-15.5q171 0 275 113.5t104 332.5z"/></svg>
            </a>
          </li>
        </ul>
      </div>
      
</article>


</section>

<nav class="navbar navbar-default navbar-fixed-bottom">
  <div class="container footer-content">

    Made with <font class="a-pink"><i class ="fa fa-heart"></i></font> to serve the community by Check Point Research    |    <a class="a-pink" href="https://research.checkpoint.com">Research blog</a>    |    <a class="a-pink" href="https://research.checkpoint.com/about-us/">About Us</a>    |    <a class="a-pink" href="https://github.com/CheckPointSW"><i class="fa fa-github fa-lg"></i></a> <a class="a-pink" href="https://twitter.com/_CPResearch_"><i class="fa fa-twitter fa-lg"></i></a>
    
    <br>
    
    © 1994-2024 Check Point Software Technologies LTD | All rights reserved | Property of CheckPoint.com


  </div>
</nav>

  </body>

</html>
<!DOCTYPE html>
<html>

  <head>
  <meta charset="utf-8">
  <meta http-equiv="X-UA-Compatible" content="IE=edge">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-194688-3"></script>
  <script>
   window.dataLayer = window.dataLayer || [];
   function gtag(){dataLayer.push(arguments);}
   gtag('js', new Date());
   gtag('config', 'UA-194688-3');
  </script>
  <meta content="Evasion techniques" property="og:site_name">

  <meta content="Evasions: Hooks" property="og:title">


  <meta name="twitter:title" content="Malware Evasion Encyclopedia" />
  <meta name="twitter:image" content="https://research.checkpoint.com/wp-content/uploads/2020/02/evasions.jpg" />


  <meta content="article" property="og:type">


  <meta content="Evasion techniques
" property="og:description">


  <meta content="https://evasions.checkpoint.com/src/Evasions/techniques/hooks.html" property="og:url">


  <meta content="2024-07-10T07:20:28+00:00" property="article:published_time">
  <meta content="https://evasions.checkpoint.com/about/" property="article:author">


  <meta property="og:image" content="">


  
  <meta content="evasions" property="article:section">
  


  
  <meta content="hooks" property="article:tag">
  

  <title>Evasions: Hooks</title>
  <meta name="description" content="Contents">
<script src="https://ajax.googleapis.com/ajax/libs/jquery/2.2.2/jquery.min.js"></script>
<script src="https://maxcdn.bootstrapcdn.com/bootstrap/3.3.6/js/bootstrap.min.js" integrity="sha384-0mSbJDEHialfmuBBQP6A4Qrprq5OVfW37PRR3j5ELqxss1yVqOtnepnHVP9aJ7xS" crossorigin="anonymous"></script>
  <link rel="stylesheet" href="https://evasions.checkpoint.com/assets/css/main.css">
<script src="https://maxcdn.bootstrapcdn.com/bootstrap/3.3.6/js/bootstrap.min.js" integrity="sha384-0mSbJDEHialfmuBBQP6A4Qrprq5OVfW37PRR3j5ELqxss1yVqOtnepnHVP9aJ7xS" crossorigin="anonymous"></script>

  <link href='https://fonts.googleapis.com/css?family=PT+Sans' rel='stylesheet' type='text/css'>
  <link href='https://fonts.googleapis.com/css?family=Fira+Mono' rel='stylesheet' type='text/css'>
  <link href='https://fonts.googleapis.com/css?family=Lato:400,700' rel='stylesheet' type='text/css'>
  <link href='https://fonts.googleapis.com/css?family=Source+Code+Pro:400,200,300,500,600,700,900' rel='stylesheet' type='text/css'>
  <link href='https://fonts.googleapis.com/css?family=Gentium+Basic:400,700' rel='stylesheet' type='text/css'>
  <link href='https://fonts.googleapis.com/css?family=Alegreya:400,400italic,700' rel='stylesheet' type='text/css'>
  <link href='https://fonts.googleapis.com/css?family=Lora:400,400italic,700' rel='stylesheet' type='text/css'>
  <link href='https://fonts.googleapis.com/css?family=Fira+Sans:400,300,500,700' rel='stylesheet' type='text/css'>
  <script src="https://ajax.googleapis.com/ajax/libs/jquery/2.2.0/jquery.min.js"></script>
  <link href='https://fonts.googleapis.com/css?family=Open+Sans:400,700' rel='stylesheet' type='text/css'>
  <link href="https://maxcdn.bootstrapcdn.com/bootstrap/3.3.6/css/bootstrap.min.css" rel="stylesheet" integrity="sha384-1q8mTJOASx8j1Au+a5WDVnPi2lkFfwwEAa8hDDdjZlpLegxhjVME1fgjWPGmkzs7" crossorigin="anonymous">
  <link href="https://maxcdn.bootstrapcdn.com/font-awesome/4.6.1/css/font-awesome.min.css" rel="stylesheet" integrity="sha384-hQpvDQiCJaD2H465dQfA717v7lu5qHWtDbWNPvaTJ0ID5xnPUlVXnKzq7b8YUkbN" crossorigin="anonymous">
  <link rel="canonical" href="https://evasions.checkpoint.com/src/Evasions/techniques/hooks.html">
  <link rel="alternate" type="application/rss+xml" title="Evasion techniques" href="https://evasions.checkpoint.com/feed.xml">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/tinysort/2.3.6/tinysort.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/tinysort/2.3.6/tinysort.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/tinysort/2.3.6/tinysort.charorder.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/tinysort/2.3.6/tinysort.charorder.min.js"></script>
  <script type="text/javascript" async src="//platform.twitter.com/widgets.js"></script>




</head>


  <body>
<section>
<article class="post" itemscope itemtype="http://schema.org/BlogPosting">
  <div class="jumbotron">
    <div class="container">
      <h1 class="post-title-main" itemprop="name headline">Evasions: Hooks</h1>
    </div>
</div>

  <div class="post-content container" itemprop="articleBody">
    <div style="text-align: left">
        <a href="..">Go back</a>
        <br>
        <br>
    </div>
    <h1>Contents</h1>

<p><a href="#hooks-detection-methods">Hooks detection methods</a>
<br />
  <a href="#check-whether-hooks-are-set-within-system-functions">1. Check whether hooks are set within system functions</a>
<br />
  <a href="#check-user-clicks-via-mouse-hooks">2. Check user clicks via mouse hooks</a>
<br />
  <a href="#check-incorrectly-hooked-functions">3. Check for incorrectly hooked functions</a>
<br />
  <a href="#signature-recommendations">Signature recommendations</a>
<br />
  <a href="#countermeasures">Countermeasures</a>
<br />
  <a href="#credits">Credits</a>
<br />
<br /></p>

<hr class="space" />

<h2><a class="a-dummy" name="hooks-detection-methods">Hooks detection methods</a></h2>
<p>Techniques described here make use of hooks either to detect user presence or as means to be checked whether some unusual-for-host-OS hooks installed.</p>

<p><br /></p>
<h3><a class="a-dummy" name="check-whether-hooks-are-set-within-system-functions">1. Check whether hooks are set within system functions</a></h3>
<p>Malware reads memory at specific addresses to check if Windows API functions are hooked.
<br />
This method is based on the fact, that emulation environments are most likely to hook these functions to be able to gather data and statistics during an emulation.</p>

<hr class="space" />

<p>Popular functions to be checked:</p>
<p></p>
<ul>
<li><tt>ReadFile</tt></li>
<li><tt>DeleteFile</tt></li>
<li><tt>CreateProcessA/W</tt></li>
</ul>

<hr class="space" />

<p>Reading memory is accomplished via the following functions:</p>
<p></p>
<ul>
<li><tt>ReadProcessMemory</tt></li>
<li><tt>NtReadVirtualMemory</tt></li>
</ul>

<hr class="space" />

<p>Then different algorithms may be used for checking:</p>
<p></p>
<ul>
<li>Comparing first two bytes with <tt>\x8B\xFF (mov edi, edi)</tt> — typical prologue start for <tt>kernel32</tt> functions.</li>
<li>Comparing first N bytes with <tt>\xCC</tt> - software breakpoint (<tt>int 3</tt>), not connected with hooks directly but still a suspicious behavior.</li>
<li>Comparing first N bytes with <tt>\xE9</tt> (<tt>call</tt>) or with <tt>\xEB</tt> (<tt>jmp</tt> instruction) — typical instructions for redirecting execution.</li>
<li>Checking for <tt>push/ret</tt> combo for execution redirection.</li>
</ul>
<p>and so on.</p>

<hr class="space" />

<p>It’s pretty tricky to count for every possible comparison so general indication of something unusual in application’s behavior is reading memory where OS libraries reside. If to be more precise: reading memory where “interesting” functions are situated.</p>

<hr class="space" />

<p><a href="https://0x00sec.org/t/defeating-userland-hooks-ft-bitdefender/12496">This atricle</a> explains how to detect user-mode hooks and remove them. The following code samples are taken from the article.</p>

<hr class="space" />

<p><b>Example of hook detection</b></p>
<p></p>

<figure class="highlight"><pre><code class="language-c" data-lang="c"><span class="n">HOOK_TYPE</span> <span class="nf">IsHooked</span><span class="p">(</span><span class="n">LPCVOID</span> <span class="n">lpFuncAddress</span><span class="p">,</span> <span class="n">DWORD_PTR</span> <span class="o">*</span><span class="n">dwAddressOffset</span><span class="p">)</span> <span class="p">{</span>
    <span class="n">LPCBYTE</span> <span class="n">lpBytePtr</span> <span class="o">=</span> <span class="p">(</span><span class="n">LPCBYTE</span><span class="p">)</span><span class="n">lpFuncAddress</span><span class="p">;</span>

    <span class="k">if</span> <span class="p">(</span><span class="n">lpBytePtr</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">==</span> <span class="mh">0xE9</span><span class="p">)</span> <span class="p">{</span>
        <span class="o">*</span><span class="n">dwAddressOffset</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
        <span class="k">return</span> <span class="n">HOOK_RELATIVE</span><span class="p">;</span>    <span class="c1">// E9 jmp is relative.</span>
    <span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">lpBytePtr</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">==</span> <span class="mh">0x68</span> <span class="o">&amp;&amp;</span>  <span class="n">lpBytePtr</span><span class="p">[</span><span class="mi">5</span><span class="p">]</span> <span class="o">==</span> <span class="mh">0xC3</span><span class="p">)</span> <span class="p">{</span>
        <span class="o">*</span><span class="n">dwAddressOffset</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
        <span class="k">return</span> <span class="n">HOOK_ABOLSUTE</span><span class="p">;</span>    <span class="c1">// push/ret is absolute.</span>
    <span class="p">}</span>

    <span class="k">return</span> <span class="n">HOOK_NONE</span><span class="p">;</span>            <span class="c1">// No hook.</span>
<span class="p">}</span>

<span class="n">LPVOID</span> <span class="n">lpFunction</span> <span class="o">=</span> <span class="p">...;</span>
<span class="n">DWORD_PTR</span> <span class="n">dwOffset</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
<span class="n">LPVOID</span> <span class="n">dwHookAddress</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

<span class="n">HOOK_TYPE</span> <span class="n">ht</span> <span class="o">=</span> <span class="n">IsHooked</span><span class="p">(</span><span class="n">lpFunction</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">dwOffset</span><span class="p">);</span>
<span class="k">if</span> <span class="p">(</span><span class="n">ht</span> <span class="o">==</span> <span class="n">HOOK_ABSOLUTE</span><span class="p">)</span> <span class="p">{</span>
    <span class="c1">// 1. Get the pointer to the address (lpFunction + dwOffset)</span>
    <span class="c1">// 2. Cast it to a DWORD pointer</span>
    <span class="c1">// 3. Dereference it to get the DWORD value</span>
    <span class="c1">// 4. Cast it to a pointer</span>
    <span class="n">dwHookAddress</span> <span class="o">=</span> <span class="p">(</span><span class="n">LPVOID</span><span class="p">)(</span><span class="o">*</span><span class="p">(</span><span class="n">LPDWORD</span><span class="p">)((</span><span class="n">LPBYTE</span><span class="p">)</span><span class="n">lpFunction</span> <span class="o">+</span> <span class="n">dwOffset</span><span class="p">));</span>
<span class="p">}</span> <span class="k">else</span> <span class="nf">if</span> <span class="p">(</span><span class="n">ht</span> <span class="o">==</span> <span class="n">HOOK_RELATIVE</span><span class="p">)</span> <span class="p">{</span>
    <span class="c1">// 1. Get the pointer to the address (lpFunction + dwOffset)</span>
    <span class="c1">// 2. Cast it to an INT pointer</span>
    <span class="c1">// 3. Dereference it to get the INT value (this can be negative)</span>
    <span class="n">INT</span> <span class="n">nJumpSize</span> <span class="o">=</span> <span class="p">(</span><span class="o">*</span><span class="p">(</span><span class="n">PINT</span><span class="p">)((</span><span class="n">LPBYTE</span><span class="p">)</span><span class="n">lpFunction</span>  <span class="o">+</span> <span class="n">dwOffset</span><span class="p">);</span>
    <span class="c1">// 4. E9 jmp starts from the address AFTER the jmp instruction</span>
    <span class="n">DWORD_PTR</span> <span class="n">dwRelativeAddress</span> <span class="o">=</span> <span class="p">(</span><span class="n">DWORD_PTR</span><span class="p">)((</span><span class="n">LPBYTE</span><span class="p">)</span><span class="n">lpFunction</span> <span class="o">+</span> <span class="n">dwOffset</span> <span class="o">+</span> <span class="mi">4</span><span class="p">));</span>
    <span class="c1">// 5. Add the relative address and jump size</span>
    <span class="n">dwHookAddress</span> <span class="o">=</span> <span class="p">(</span><span class="n">LPVOID</span><span class="p">)(</span><span class="n">dwRelativeAddress</span> <span class="o">+</span> <span class="n">nJumpSize</span><span class="p">);</span>
<span class="p">}</span></code></pre></figure>

<hr class="space" />

<p><b>Example of unhooking functions</b></p>
<p></p>

<figure class="highlight"><pre><code class="language-c" data-lang="c"><span class="c1">// Parse the PE headers.</span>
<span class="n">PIMAGE_DOS_HEADER</span> <span class="n">pidh</span> <span class="o">=</span> <span class="p">(</span><span class="n">PIMAGE_DOS_HEADER</span><span class="p">)</span><span class="n">lpMapping</span><span class="p">;</span>
<span class="n">PIMAGE_NT_HEADERS</span> <span class="n">pinh</span> <span class="o">=</span> <span class="p">(</span><span class="n">PIMAGE_NT_HEADERS</span><span class="p">)((</span><span class="n">DWORD_PTR</span><span class="p">)</span><span class="n">lpMapping</span> <span class="o">+</span> <span class="n">pidh</span><span class="o">-&gt;</span><span class="n">e_lfanew</span><span class="p">);</span>

<span class="c1">// Walk the section headers and find the .text section.</span>
<span class="k">for</span> <span class="p">(</span><span class="n">WORD</span> <span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">pinh</span><span class="o">-&gt;</span><span class="n">FileHeader</span><span class="p">.</span><span class="n">NumberOfSections</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
    <span class="n">PIMAGE_SECTION_HEADER</span> <span class="n">pish</span> <span class="o">=</span> <span class="p">(</span><span class="n">PIMAGE_SECTION_HEADER</span><span class="p">)((</span><span class="n">DWORD_PTR</span><span class="p">)</span><span class="n">IMAGE_FIRST_SECTION</span><span class="p">(</span><span class="n">pinh</span><span class="p">)</span> <span class="o">+</span> 
                                 <span class="p">((</span><span class="n">DWORD_PTR</span><span class="p">)</span><span class="n">IMAGE_SIZEOF_SECTION_HEADER</span> <span class="o">*</span> <span class="n">i</span><span class="p">));</span>
    <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">strcmp</span><span class="p">(</span><span class="n">pish</span><span class="o">-&gt;</span><span class="n">Name</span><span class="p">,</span> <span class="s">".text"</span><span class="p">))</span> <span class="p">{</span>
        <span class="c1">// Deprotect the module's memory region for write permissions.</span>
        <span class="n">DWORD</span> <span class="n">flProtect</span> <span class="o">=</span> <span class="n">ProtectMemory</span><span class="p">(</span>
            <span class="p">(</span><span class="n">LPVOID</span><span class="p">)((</span><span class="n">DWORD_PTR</span><span class="p">)</span><span class="n">hModule</span> <span class="o">+</span> <span class="p">(</span><span class="n">DWORD_PTR</span><span class="p">)</span><span class="n">pish</span><span class="o">-&gt;</span><span class="n">VirtualAddress</span><span class="p">),</span>    <span class="c1">// Address to protect.</span>
            <span class="n">pish</span><span class="o">-&gt;</span><span class="n">Misc</span><span class="p">.</span><span class="n">VirtualSize</span><span class="p">,</span>                        <span class="c1">// Size to protect.</span>
            <span class="n">PAGE_EXECUTE_READWRITE</span>                         <span class="c1">// Desired protection.</span>
        <span class="p">);</span>

        <span class="c1">// Replace the hooked module's .text section with the newly mapped module's.</span>
        <span class="n">memcpy</span><span class="p">(</span>
            <span class="p">(</span><span class="n">LPVOID</span><span class="p">)((</span><span class="n">DWORD_PTR</span><span class="p">)</span><span class="n">hModule</span> <span class="o">+</span> <span class="p">(</span><span class="n">DWORD_PTR</span><span class="p">)</span><span class="n">pish</span><span class="o">-&gt;</span><span class="n">VirtualAddress</span><span class="p">),</span>
            <span class="p">(</span><span class="n">LPVOID</span><span class="p">)((</span><span class="n">DWORD_PTR</span><span class="p">)</span><span class="n">lpMapping</span> <span class="o">+</span> <span class="p">(</span><span class="n">DWORD_PTR</span><span class="p">)</span><span class="n">pish</span><span class="o">-&gt;</span><span class="n">VirtualAddress</span><span class="p">),</span>
            <span class="n">pish</span><span class="o">-&gt;</span><span class="n">Misc</span><span class="p">.</span><span class="n">VirtualSize</span>
        <span class="p">);</span>

        <span class="c1">// Reprotect the module's memory region.</span>
        <span class="n">flProtect</span> <span class="o">=</span> <span class="n">ProtectMemory</span><span class="p">(</span>
            <span class="p">(</span><span class="n">LPVOID</span><span class="p">)((</span><span class="n">DWORD_PTR</span><span class="p">)</span><span class="n">hModule</span> <span class="o">+</span> <span class="p">(</span><span class="n">DWORD_PTR</span><span class="p">)</span><span class="n">pish</span><span class="o">-&gt;</span><span class="n">VirtualAddress</span><span class="p">),</span>    <span class="c1">// Address to protect.</span>
            <span class="n">pish</span><span class="o">-&gt;</span><span class="n">Misc</span><span class="p">.</span><span class="n">VirtualSize</span><span class="p">,</span>                        <span class="c1">// Size to protect.</span>
            <span class="n">flProtect</span>                                      <span class="c1">// Revert to old protection.</span>
        <span class="p">);</span>
    <span class="p">}</span>
<span class="p">}</span></code></pre></figure>

<hr class="space" />

<p><br /></p>
<h3><a class="a-dummy" name="check-user-clicks-via-mouse-hooks">2. Check user clicks via mouse hooks</a></h3>
<p>This technique is described <a href="https://www.fireeye.com/content/dam/fireeye-www/current-threats/pdfs/pf/file/fireeye-hot-knives-through-butter.pdf">by this link</a> (p.4, p.7).</p>

<hr class="space" />

<p>Malware sets mouse hook to detect a click (or more) if it occurs. If it’s the case malware treats the host a usual one, i.e., with end user behind the screen - not a virtual environment. If no mouse click is detected then it’s very likely a virtual environment.</p>

<hr class="space" />

<p>Functions used:</p>
<p></p>
<ul>
<li><tt>SetWindowsHookExA/W (WH_MOUSE_LL, ...)</tt></li>
<li><tt>GetAsyncKeyState</tt></li>
</ul>

<hr class="space" />

<p><b>Code sample (<tt>SetWindowsHookExA</tt>)</b></p>
<p></p>

<figure class="highlight"><pre><code class="language-c" data-lang="c"><span class="n">HHOOK</span> <span class="n">g_hhkMouseHook</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>

<span class="n">LRESULT</span> <span class="n">CALLBACK</span> <span class="nf">mouseHookProc</span><span class="p">(</span><span class="kt">int</span> <span class="n">nCode</span><span class="p">,</span> <span class="n">WPARAM</span> <span class="n">wParam</span><span class="p">,</span> <span class="n">LPARAM</span> <span class="n">lParam</span><span class="p">)</span>
<span class="p">{</span>
  <span class="k">switch</span> <span class="p">(</span><span class="n">wParam</span><span class="p">)</span>
  <span class="p">{</span>
  <span class="k">case</span> <span class="n">WM_MOUSEMOVE</span><span class="p">:</span>
    <span class="c1">// ...</span>
    <span class="k">break</span><span class="p">;</span>
  <span class="k">case</span> <span class="n">WM_NCLBUTTONDOWN</span><span class="p">:</span>
    <span class="c1">// ...</span>
    <span class="k">break</span><span class="p">;</span>
  <span class="k">case</span> <span class="n">WM_LBUTTONUP</span><span class="p">:</span>
    <span class="n">UnhookWindowsHookEx</span><span class="p">(</span><span class="n">g_hhkMouseHook</span><span class="p">);</span>
    <span class="n">CallMaliciousCode</span><span class="p">();</span>
    <span class="n">ExitProcess</span><span class="p">(</span><span class="mi">0</span><span class="p">);</span>
  <span class="p">}</span>
  <span class="k">return</span> <span class="n">CallNextHookEx</span><span class="p">(</span><span class="n">g_hhkMouseHook</span><span class="p">,</span> <span class="n">nCode</span><span class="p">,</span> <span class="n">wParam</span><span class="p">,</span> <span class="n">lParam</span><span class="p">);</span>
<span class="p">}</span>

<span class="n">g_hhkMouseHook</span> <span class="o">=</span> <span class="n">SetWindowsHookEx</span><span class="p">(</span><span class="n">WH_MOUSE_LL</span><span class="p">,</span> <span class="n">mouseHookProc</span><span class="p">,</span> <span class="n">GetModuleHandleA</span><span class="p">(</span><span class="nb">NULL</span><span class="p">),</span> <span class="nb">NULL</span><span class="p">);</span></code></pre></figure>

<hr class="space" />

<p><b>Code sample (<tt>GetAsyncKeyState</tt>)</b></p>
<p></p>

<figure class="highlight"><pre><code class="language-c" data-lang="c"><span class="n">std</span><span class="o">::</span><span class="kr">thread</span> <span class="nf">t</span><span class="p">([]()</span>
<span class="p">{</span>
  <span class="kt">int</span> <span class="n">count</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
  <span class="k">while</span> <span class="p">(</span><span class="nb">true</span><span class="p">)</span>
  <span class="p">{</span>
    <span class="k">if</span> <span class="p">(</span><span class="n">GetAsyncKeyState</span><span class="p">(</span><span class="n">VK_LBUTTON</span><span class="p">)</span> <span class="o">||</span> <span class="n">GetAsyncKeyState</span><span class="p">(</span><span class="n">VK_RBUTTON</span><span class="p">)</span> <span class="o">||</span> <span class="n">GetAsyncKeyState</span><span class="p">(</span><span class="n">VK_MBUTTON</span><span class="p">))</span>
    <span class="p">{</span>
      <span class="k">if</span> <span class="p">(</span><span class="o">++</span><span class="n">count</span> <span class="o">==</span> <span class="mi">2</span><span class="p">)</span>
        <span class="k">break</span><span class="p">;</span>
    <span class="p">}</span>
    <span class="n">Sleep</span><span class="p">(</span><span class="mi">100</span><span class="p">);</span>
  <span class="p">}</span>
  <span class="n">CallMaliciousCode</span><span class="p">();</span>
<span class="p">});</span>
<span class="n">t</span><span class="p">.</span><span class="n">join</span><span class="p">();</span></code></pre></figure>

<p><br /></p>
<h3><a class="a-dummy" name="check-incorrectly-hooked-functions">3. Check for incorrectly hooked functions</a></h3>
<p>There are more than 400 Native API functions (or Nt-functions) in <tt>ntdll.dll</tt> that are usually hooked in sandboxes. 
In such a large list, there is enough space for different kinds of mistakes. We checked the hooked Nt-functions in popular sandboxes 
and found several issues. On of them is a lack of necessary checks for arguments in a hooked function. This case is
described our article “<a href="timing.html#call-hooked-function-with-invalid-arguments">Timing: Call a potentially hooked delay function with invalid arguments evasions</a>”
<br />
Another issue we found is a discrepancy in the number of arguments in a hooked and an original function. 
If a function is hooked incorrectly, in kernel mode this may lead an operating system to crash. Incorrect user-mode 
hooks are not as critical. However, they may lead an analyzed application to crash or can be easily detected.
For example, let’s look at the <tt>NtLoadKeyEx</tt> function. It was first introduced in Windows Server 2003 and had 
only 4 arguments. Starting from Windows Vista up to the latest version of Windows 10, it has 8 arguments:</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>; Exported entry 318. NtLoadKeyEx
; Exported entry 1450. ZwLoadKeyEx
; __stdcall NtLoadKeyEx(x, x, x, x, x, x, x, x)
public _NtLoadKeyEx@32
</code></pre></div></div>

<p>However, in the Cuckoo monitor, the <tt>NtLoadKeyEx</tt> declaration still has only 
<a href="https://github.com/cuckoosandbox/monitor/blob/8c419e6216f379e01ea0caa3a71142543e10fc04/sigs/registry_native.rst#ntloadkeyex">4 arguments</a>:</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>*  POBJECT_ATTRIBUTES TargetKey
*  POBJECT_ATTRIBUTES SourceFile
** ULONG Flags flags
** HANDLE TrustClassKey trust_class_key
</code></pre></div></div>

<p>We found this legacy prototype used in other sources as well. For example, 
<a href="https://github.com/kevoreilly/capemon/blob/a3fe72ad9d3f9cd45aa2f5d503a5328ab1f9e442/hooks.h#L710">CAPE monitor</a>
has the same issue:</p>

<figure class="highlight"><pre><code class="language-c" data-lang="c"><span class="k">extern</span> <span class="nf">HOOKDEF</span><span class="p">(</span><span class="n">NTSTATUS</span><span class="p">,</span> <span class="n">WINAPI</span><span class="p">,</span> <span class="n">NtLoadKeyEx</span><span class="p">,</span>
    <span class="n">__in</span>      <span class="n">POBJECT_ATTRIBUTES</span> <span class="n">TargetKey</span><span class="p">,</span>
    <span class="n">__in</span>      <span class="n">POBJECT_ATTRIBUTES</span> <span class="n">SourceFile</span><span class="p">,</span>
    <span class="n">__in</span>      <span class="n">ULONG</span> <span class="n">Flags</span><span class="p">,</span>
    <span class="n">__in_opt</span>  <span class="n">HANDLE</span> <span class="n">TrustClassKey</span>
<span class="p">);</span></code></pre></figure>

<p>Therefore, if a sandbox uses any recent Windows OS, this function is hooked incorrectly. After the call to the 
incorrectly hooked function, the stack pointer value becomes invalid. Therefore, a totally “legitimate” call to the 
<tt>RegLoadAppKeyW</tt> function, which calls <tt>NtLoadKeyEx</tt>, leads to an exception. This fact can be used to 
evade Cuckoo and CAPE sandbox with just a single call to the <tt>RegLoadAppKeyW</tt> function.</p>

<p><b>Code sample</b></p>
<p></p>

<figure class="highlight"><pre><code class="language-c" data-lang="c"><span class="n">RegLoadAppKeyW</span><span class="p">(</span><span class="s">L"storage.dat"</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">hKey</span><span class="p">,</span> <span class="n">KEY_ALL_ACCESS</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
<span class="c1">// If the application is running in a sandbox an exception will occur</span>
<span class="c1">// and the code below will not be executed.</span>

<span class="c1">// Some legitimate code that works with hKey to distract attention goes here</span>
<span class="c1">// ...</span>
<span class="n">RegCloseKey</span><span class="p">(</span><span class="n">hKey</span><span class="p">);</span>
<span class="c1">// Malicious code goes here</span>
<span class="c1">// ...</span></code></pre></figure>

<p>Instead of using <tt>RegLoadAppKeyW</tt>, we can call the <tt>NtLoadKeyEx</tt> function directly and check the ESP 
value after the call.</p>

<p><b>Code sample</b></p>
<p></p>

<figure class="highlight"><pre><code class="language-c" data-lang="c"><span class="kr">__try</span>
<span class="p">{</span>
    <span class="n">_asm</span> <span class="n">mov</span> <span class="n">old_esp</span><span class="p">,</span> <span class="n">esp</span>
    <span class="n">NtLoadKeyEx</span><span class="p">(</span><span class="o">&amp;</span><span class="n">TargetKey</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">SourceFile</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="n">KEY_ALL_ACCESS</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">hKey</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">ioStatus</span><span class="p">);</span>
    <span class="n">_asm</span> <span class="n">mov</span> <span class="n">new_esp</span><span class="p">,</span> <span class="n">esp</span>
    <span class="n">_asm</span> <span class="n">mov</span> <span class="n">esp</span><span class="p">,</span> <span class="n">old_esp</span>
    <span class="k">if</span> <span class="p">(</span><span class="n">old_esp</span> <span class="o">!=</span> <span class="n">new_esp</span><span class="p">)</span>
        <span class="n">printf</span><span class="p">(</span><span class="s">"Sandbox detected!"</span><span class="p">);</span>
<span class="p">}</span>
<span class="kr">__except</span> <span class="p">(</span><span class="n">EXCEPTION_EXECUTE_HANDLER</span><span class="p">)</span>
<span class="p">{</span>
    <span class="n">printf</span><span class="p">(</span><span class="s">"Sandbox detected!"</span><span class="p">);</span>
<span class="p">}</span></code></pre></figure>

<p><br /></p>
<h3><a class="a-dummy" name="signature-recommendations">Signature recommendations</a></h3>
<p><i>No signature recommendations are provided for this evasion group as it’s hard to make a difference between the code which aims for some evasion technique and the one which is “legally used”.</i></p>

<p><br /></p>
<h3><a class="a-dummy" name="countermeasures">Countermeasures</a></h3>

<ul>
<li><tt>versus function hook checks:</tt> set kernel mode hooks; second solution is to use stack routing to implement function hooking;</li>
<li><tt>versus mouse click checks via hooks:</tt> use mouse movement emulation module.</li>
<li><tt>versus incorrect function hooks:</tt> ensure all the hooked function have the same number of arguments as the original functions</li> 
</ul>

<p><br /></p>
<h3><a class="a-dummy" name="credits">Credits</a></h3>

<p>Credits go to user <tt>dtm</tt> from  <a href="https://0x00sec.org/">0x00sec.org</a> forum.</p>

<p>Due to modular code structure of the Check Point’s tool called InviZzzible it would require more space to show a code sample from this tool for the same purposes. That’s why we’ve decided to use other great open-source projects for examples throughout the encyclopedia.</p>

    <br>
    <div style="text-align: left">
        <a href="..">Go back</a>
    </div>
    <br>
    <div class="sharebuttons" style="text-align: center">
        <hr />
        <ul>
          <li>
            <p class="sharetitle"> Share this: </p>
          </li>
          <li class="reddit">
            <a href="http://www.reddit.com/submit?url=https://evasions.checkpoint.com/src/Evasions/techniques/hooks.html&title=Evasions:%20Hooks - Evasion Techniques" target="_blank">
                <svg xmlns="http://www.w3.org/2000/svg"
                aria-label="Reddit" role="img"
                viewBox="0 0 512 512"><rect
                width="512" height="512"
                rx="15%"
                fill="#f40"/><g fill="#fff"><ellipse cx="256" cy="307" rx="166" ry="117"/><circle cx="106" cy="256" r="42"/><circle cx="407" cy="256" r="42"/><circle cx="375" cy="114" r="32"/></g><g stroke-linecap="round" stroke-linejoin="round" fill="none"><path d="m256 196 23-101 73 15" stroke="#fff" stroke-width="16"/><path d="m191 359c33 25 97 26 130 0" stroke="#f40" stroke-width="13"/></g><g fill="#f40"><circle cx="191" cy="287" r="31"/><circle cx="321" cy="287" r="31"/></g></svg>
                
            </a>
          </li>
          <li class="hn">
            <a href="http://news.ycombinator.com/submitlink?u=https://evasions.checkpoint.com/src/Evasions/techniques/hooks.html&t=Evasions:%20Hooks - Evasion Techniques" target="_blank">
                <svg xmlns="http://www.w3.org/2000/svg"
                aria-label="Hacker News" role="img"
                viewBox="0 0 512 512"><rect
                width="512" height="512"
                rx="15%"
                fill="#f60"/><path fill="#fff" d="M124 91h51l81 162 81-164h51L276 293v136h-40V293z"/></svg>
            </a>
          </li>
          <li class="twitter">
            <a href="https://twitter.com/intent/tweet?via=_CPResearch_&url=https://evasions.checkpoint.com/src/Evasions/techniques/hooks.html&text=Evasions:%20Hooks - Evasion Techniques" target="_blank">
                <svg viewBox="0 0 1792 1792" xmlns="http://www.w3.org/2000/svg"><path d="M1684 408q-67 98-162 167 1 14 1 42 0 130-38 259.5t-115.5 248.5-184.5 210.5-258 146-323 54.5q-271 0-496-145 35 4 78 4 225 0 401-138-105-2-188-64.5t-114-159.5q33 5 61 5 43 0 85-11-112-23-185.5-111.5t-73.5-205.5v-4q68 38 146 41-66-44-105-115t-39-154q0-88 44-163 121 149 294.5 238.5t371.5 99.5q-8-38-8-74 0-134 94.5-228.5t228.5-94.5q140 0 236 102 109-21 205-78-37 115-142 178 93-10 186-50z"/></svg>
            </a>
          </li>
          <li class="linkedin">
            <a href=https://www.linkedin.com/shareArticle?mini=true&url=https://evasions.checkpoint.com/src/Evasions/techniques/hooks.html&title=Evasions:%20Hooks - Evasion Techniques&source=LinkedIn" target="_blank">
                <svg viewBox="0 0 1792 1792" xmlns="http://www.w3.org/2000/svg"><path d="M477 625v991h-330v-991h330zm21-306q1 73-50.5 122t-135.5 49h-2q-82 0-132-49t-50-122q0-74 51.5-122.5t134.5-48.5 133 48.5 51 122.5zm1166 729v568h-329v-530q0-105-40.5-164.5t-126.5-59.5q-63 0-105.5 34.5t-63.5 85.5q-11 30-11 81v553h-329q2-399 2-647t-1-296l-1-48h329v144h-2q20-32 41-56t56.5-52 87-43.5 114.5-15.5q171 0 275 113.5t104 332.5z"/></svg>
            </a>
          </li>
        </ul>
      </div>
      
</article>


</section>

<nav class="navbar navbar-default navbar-fixed-bottom">
  <div class="container footer-content">

    Made with <font class="a-pink"><i class ="fa fa-heart"></i></font> to serve the community by Check Point Research    |    <a class="a-pink" href="https://research.checkpoint.com">Research blog</a>    |    <a class="a-pink" href="https://research.checkpoint.com/about-us/">About Us</a>    |    <a class="a-pink" href="https://github.com/CheckPointSW"><i class="fa fa-github fa-lg"></i></a> <a class="a-pink" href="https://twitter.com/_CPResearch_"><i class="fa fa-twitter fa-lg"></i></a>
    
    <br>
    
    © 1994-2024 Check Point Software Technologies LTD | All rights reserved | Property of CheckPoint.com


  </div>
</nav>

  </body>

</html>
<!DOCTYPE html>
<html>

  <head>
  <meta charset="utf-8">
  <meta http-equiv="X-UA-Compatible" content="IE=edge">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-194688-3"></script>
  <script>
   window.dataLayer = window.dataLayer || [];
   function gtag(){dataLayer.push(arguments);}
   gtag('js', new Date());
   gtag('config', 'UA-194688-3');
  </script>
  <meta content="Evasion techniques" property="og:site_name">

  <meta content="Evasions: Human-like behavior" property="og:title">


  <meta name="twitter:title" content="Malware Evasion Encyclopedia" />
  <meta name="twitter:image" content="https://research.checkpoint.com/wp-content/uploads/2020/02/evasions.jpg" />


  <meta content="article" property="og:type">


  <meta content="Evasion techniques
" property="og:description">


  <meta content="https://evasions.checkpoint.com/src/Evasions/techniques/human-like-behavior.html" property="og:url">


  <meta content="2024-07-10T07:20:28+00:00" property="article:published_time">
  <meta content="https://evasions.checkpoint.com/about/" property="article:author">


  <meta property="og:image" content="">


  
  <meta content="evasions" property="article:section">
  


  
  <meta content="human-like-behavior" property="article:tag">
  

  <title>Evasions: Human-like behavior</title>
  <meta name="description" content="Contents">
<script src="https://ajax.googleapis.com/ajax/libs/jquery/2.2.2/jquery.min.js"></script>
<script src="https://maxcdn.bootstrapcdn.com/bootstrap/3.3.6/js/bootstrap.min.js" integrity="sha384-0mSbJDEHialfmuBBQP6A4Qrprq5OVfW37PRR3j5ELqxss1yVqOtnepnHVP9aJ7xS" crossorigin="anonymous"></script>
  <link rel="stylesheet" href="https://evasions.checkpoint.com/assets/css/main.css">
<script src="https://maxcdn.bootstrapcdn.com/bootstrap/3.3.6/js/bootstrap.min.js" integrity="sha384-0mSbJDEHialfmuBBQP6A4Qrprq5OVfW37PRR3j5ELqxss1yVqOtnepnHVP9aJ7xS" crossorigin="anonymous"></script>

  <link href='https://fonts.googleapis.com/css?family=PT+Sans' rel='stylesheet' type='text/css'>
  <link href='https://fonts.googleapis.com/css?family=Fira+Mono' rel='stylesheet' type='text/css'>
  <link href='https://fonts.googleapis.com/css?family=Lato:400,700' rel='stylesheet' type='text/css'>
  <link href='https://fonts.googleapis.com/css?family=Source+Code+Pro:400,200,300,500,600,700,900' rel='stylesheet' type='text/css'>
  <link href='https://fonts.googleapis.com/css?family=Gentium+Basic:400,700' rel='stylesheet' type='text/css'>
  <link href='https://fonts.googleapis.com/css?family=Alegreya:400,400italic,700' rel='stylesheet' type='text/css'>
  <link href='https://fonts.googleapis.com/css?family=Lora:400,400italic,700' rel='stylesheet' type='text/css'>
  <link href='https://fonts.googleapis.com/css?family=Fira+Sans:400,300,500,700' rel='stylesheet' type='text/css'>
  <script src="https://ajax.googleapis.com/ajax/libs/jquery/2.2.0/jquery.min.js"></script>
  <link href='https://fonts.googleapis.com/css?family=Open+Sans:400,700' rel='stylesheet' type='text/css'>
  <link href="https://maxcdn.bootstrapcdn.com/bootstrap/3.3.6/css/bootstrap.min.css" rel="stylesheet" integrity="sha384-1q8mTJOASx8j1Au+a5WDVnPi2lkFfwwEAa8hDDdjZlpLegxhjVME1fgjWPGmkzs7" crossorigin="anonymous">
  <link href="https://maxcdn.bootstrapcdn.com/font-awesome/4.6.1/css/font-awesome.min.css" rel="stylesheet" integrity="sha384-hQpvDQiCJaD2H465dQfA717v7lu5qHWtDbWNPvaTJ0ID5xnPUlVXnKzq7b8YUkbN" crossorigin="anonymous">
  <link rel="canonical" href="https://evasions.checkpoint.com/src/Evasions/techniques/human-like-behavior.html">
  <link rel="alternate" type="application/rss+xml" title="Evasion techniques" href="https://evasions.checkpoint.com/feed.xml">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/tinysort/2.3.6/tinysort.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/tinysort/2.3.6/tinysort.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/tinysort/2.3.6/tinysort.charorder.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/tinysort/2.3.6/tinysort.charorder.min.js"></script>
  <script type="text/javascript" async src="//platform.twitter.com/widgets.js"></script>




</head>


  <body>
<section>
<article class="post" itemscope itemtype="http://schema.org/BlogPosting">
  <div class="jumbotron">
    <div class="container">
      <h1 class="post-title-main" itemprop="name headline">Evasions: Human-like behavior</h1>
    </div>
</div>

  <div class="post-content container" itemprop="articleBody">
    <div style="text-align: left">
        <a href="..">Go back</a>
        <br>
        <br>
    </div>
    <h1>Contents</h1>

<p><a href="#human-like-behavior-detection-methods">Human-like behavior detection methods</a>
<br />
  <a href="#general-detection-methods-via-registry">1. General detection methods via registry</a>
<br />
  <a href="#check-number-of-recently-opened-documents">1.1. Check the number of recently opened documents</a>
<br />
  <a href="#check-if-browser-history-contains-at-least-10-urls">1.2. Check if the browser history contains at least 10 URLs</a>
<br />
  <a href="#check-if-certain-software-package-were-installed">1.3. Check if certain software packages were installed</a>
<br />
  <a href="#general-detection-methods-via-registry-countermeasures">1.4. Countermeasures</a>
<br />
  <a href="#check-user-presence-at-the-moment-of-executing">2. Check for user presence at the moment of executing a process</a>
<br />
  <a href="#check-mouse-movement">2.1. Check the mouse movement</a>
<br />
  <a href="#check-via-request-for-user-interaction">2.2. Check via a request for user interaction</a>
<br />
  <a href="#evasion-technique-for-cuckoo-human-interaction-module">2.3. Evasion technique for the Cuckoo human-interaction module</a>
<br />
  <a href="#no-suspicious-actions-until-a-document-is-scrolled-down">2.4. No suspicious actions until a document is scrolled down</a>
<br />
  <a href="#check-user-activity-via-getlastinputinfo">2.5. Check user activity via GetLastInputInfo</a>
<br />
  <a href="#countermeasures">Countermeasures</a>
<br />
  <a href="#signature-recommendations">Signature recommendations</a>
<br />
  <a href="#credits">Credits</a>
<br />
<br /></p>

<hr class="space" />

<h2><a class="a-dummy" name="human-like-behavior-detection-methods">Human-like behavior detection methods</a></h2>
<p>All the techniques described in this group make use of the fact that certain actions are performed differently by a user and by a virtual environment.</p>

<p><br /></p>
<h3><a class="a-dummy" name="general-detection-methods-via-registry">1. General detection methods via registry</a></h3>
<p>The registry is a storage for different pieces of information. For example, recently opened URLs and documents, and software installation notes are stored here. All of these may be used to determine if the machine is operated by a human user and is not a sandbox.</p>

<p><br /></p>
<h4><a class="a-dummy" name="check-number-of-recently-opened-documents">1.1. Check the number of recently opened documents</a></h4>
<p>It’s hard to imagine a typical host system where the user does not open any documents. Therefore, the lack of recently opened documents indicates this is likely a virtual environment.</p>

<hr class="space" />

<p><b>Code sample (VB)</b></p>
<p></p>

<figure class="highlight"><pre><code class="language-vb" data-lang="vb"><span class="k">Public</span> <span class="k">Function</span> <span class="nf">DKTxHE</span><span class="p">()</span> <span class="ow">As</span> <span class="kt">Boolean</span>
<span class="n">DKTxHE</span> <span class="o">=</span> <span class="n">RecentFiles</span><span class="p">.</span><span class="n">Count</span> <span class="o">&lt;</span> <span class="mi">3</span>
<span class="k">End</span> <span class="k">Function</span></code></pre></figure>

<p><i>This code sample was taken from <a href="https://www.sentinelone.com/blog/anti-vm-tricks/">SentinelOne article</a> </i></p>

<p><br /></p>
<h4><a class="a-dummy" name="check-if-browser-history-contains-at-least-10-urls">1.2. Check if the browser history contains at least 10 URLs</a></h4>
<p>It’s hard to imagine a typical host system where the user does not browse the Internet. Therefore, if there are fewer than 10 URLs in the browser history, this is likely a sandbox or VM.</p>

<hr class="space" />

<p><b>Code sample (for Chrome)</b></p>
<p></p>

<!-- Firefox history: http://www.rohitab.com/discuss/topic/40903-clear-browser-history-with-c/ -->
<!-- Firefox passwords: https://github.com/wekillpeople/browser-dumpwd/blob/master/firefox.c -->

<figure class="highlight"><pre><code class="language-c" data-lang="c"><span class="n">bool</span> <span class="nf">chrome_history_evasion</span><span class="p">(</span><span class="kt">int</span> <span class="n">min_websites_visited</span> <span class="o">=</span> <span class="mi">10</span><span class="p">)</span>
<span class="p">{</span>
  <span class="n">sqlite3</span> <span class="o">*</span><span class="n">db</span><span class="p">;</span>
  <span class="kt">int</span> <span class="n">rc</span><span class="p">;</span>
  <span class="n">bool</span> <span class="n">vm_found</span> <span class="o">=</span> <span class="nb">false</span><span class="p">;</span>

  <span class="n">rc</span> <span class="o">=</span> <span class="n">sqlite3_open</span><span class="p">(</span><span class="s">"C:</span><span class="se">\\</span><span class="s">Users</span><span class="se">\\</span><span class="s">&lt;USER_NAME&gt;</span><span class="se">\\</span><span class="s">AppData</span><span class="se">\\</span><span class="s">Local</span><span class="se">\\</span><span class="s">Google</span><span class="se">\\</span><span class="s">Chrome</span><span class="se">\\</span><span class="s">User Data</span><span class="se">\\</span><span class="s">Default</span><span class="se">\\</span><span class="s">History"</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">db</span><span class="p">);</span>
  <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">rc</span><span class="p">)</span>
  <span class="p">{</span>
    <span class="kt">char</span> <span class="o">**</span><span class="n">results</span> <span class="o">=</span> <span class="n">nullptr</span><span class="p">;</span>
    <span class="kt">char</span> <span class="o">*</span><span class="n">error</span> <span class="o">=</span> <span class="n">nullptr</span><span class="p">;</span>
    <span class="kt">int</span> <span class="n">rows</span><span class="p">,</span> <span class="n">columns</span><span class="p">;</span>

    <span class="n">rc</span> <span class="o">=</span> <span class="n">sqlite3_get_table</span><span class="p">(</span><span class="n">db</span><span class="p">,</span> <span class="s">"SELECT DISTINCT title FROM urls;"</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">results</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">rows</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">columns</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">error</span><span class="p">);</span>
    <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">rc</span><span class="p">)</span>
      <span class="n">vm_found</span> <span class="o">=</span> <span class="n">rows</span> <span class="o">&lt;</span> <span class="n">min_websites_visited</span><span class="p">;</span>
    <span class="n">sqlite3_free_table</span><span class="p">(</span><span class="n">results</span><span class="p">);</span>
  <span class="p">}</span>

  <span class="n">sqlite3_close</span><span class="p">(</span><span class="n">db</span><span class="p">);</span>
  <span class="k">return</span> <span class="n">vm_found</span><span class="p">;</span>
<span class="p">}</span></code></pre></figure>

<p><br /></p>
<h4><a class="a-dummy" name="check-if-certain-software-package-were-installed">1.3. Check if certain software packages were installed</a></h4>
<p>If the system is only used for simulation purposes then it is likely to have many fewer installed software packages than a usual user’s work machine. The installed packages may be specific to emulation purposes, not the ones that are usually used by human operators. Therefore, the list of installed packages may be compared to the list of commonly used applications to determine if it’s a sandbox.</p>

<hr class="space" />

<p><b>Code sample (PowerShell)</b></p>
<p></p>

<figure class="highlight"><pre><code class="language-batch" data-lang="batch"><span class="kd">Get</span><span class="na">-ItemProperty </span><span class="kd">HKLM</span>:\Software\Microsoft\Windows\CurrentVersion\Uninstall\<span class="o">*</span> <span class="o">|</span> <span class="kd">Format</span><span class="na">-Table -AutoSize </span><span class="o">|</span> <span class="kd">Measure</span><span class="na">-Object -Line</span></code></pre></figure>

<p><br /></p>
<h4><a class="a-dummy" name="general-detection-methods-via-registry-countermeasures">1.4. Countermeasures</a></h4>
<p>Countermeasures are simple:</p>
<ul>
<li>open few documents to update the recent history</li>
<li>open few internet URLs to create a browsing history</li>
<li>install some lightweight software (like Notepad++)</li>
</ul>

<p><br /></p>
<h3><a class="a-dummy" name="check-user-presence-at-the-moment-of-executing">2. Check for user presence at the moment of executing a process</a></h3>
<p>The following sub-group leverages the differences between a user’s interaction with the machine and the actions of a virtual environment.</p>

<p><br /></p>
<h4><a class="a-dummy" name="check-mouse-movement">2.1. Check the mouse movement</a></h4>
<p>This method relies on the fact that a user frequently moves the mouse during actual work.</p>

<hr class="space" />

<p>Some sandboxes and antivirus virtual machines have a static cursor position because they do not emulate any user activity while automatically running the files.</p>

<hr class="space" />

<p><b>Code sample</b></p>
<p></p>

<figure class="highlight"><pre><code class="language-c" data-lang="c"><span class="kt">int</span> <span class="nf">gensandbox_mouse_act</span><span class="p">()</span> <span class="p">{</span>
    <span class="n">POINT</span> <span class="n">position1</span><span class="p">,</span> <span class="n">position2</span><span class="p">;</span>

    <span class="n">GetCursorPos</span><span class="p">(</span><span class="o">&amp;</span><span class="n">position1</span><span class="p">);</span>
    <span class="n">Sleep</span><span class="p">(</span><span class="mi">2000</span><span class="p">);</span>
    <span class="n">GetCursorPos</span><span class="p">(</span><span class="o">&amp;</span><span class="n">position2</span><span class="p">);</span>

    <span class="k">if</span> <span class="p">((</span><span class="n">position1</span><span class="p">.</span><span class="n">x</span> <span class="o">==</span> <span class="n">position2</span><span class="p">.</span><span class="n">x</span><span class="p">)</span> <span class="o">&amp;&amp;</span> <span class="p">(</span><span class="n">position1</span><span class="p">.</span><span class="n">y</span> <span class="o">==</span> <span class="n">position2</span><span class="p">.</span><span class="n">y</span><span class="p">))</span>
        <span class="c1">// No mouse activity during the sleep.</span>
        <span class="k">return</span> <span class="n">TRUE</span><span class="p">;</span>
    <span class="k">else</span>
        <span class="k">return</span> <span class="n">FALSE</span><span class="p">;</span>
<span class="p">}</span></code></pre></figure>

<p><i>This code sample was taken from <a href="https://github.com/a0rtega/pafish">pafish project</a> </i></p>

<p>Such a short delay of only 2 seconds implies that the user should be active at the moment of infection.</p>

<hr class="space" />

<p>More sophisticated checks rely on detection of not only the mouse movement per se but the pattern of such movement. The following example is taken from the research of <a href="https://outpost24.com/blog/lummac2-anti-sandbox-technique-trigonometry-human-detection/">LummaC2 Stealer</a> conducted by Outpost24.</p>

<p>First, malware captures mouse movements with the delay of 50 msec between them.</p>

<div style="text-align: center; margin: auto">
  <img src="../assets/images/trigonometry_mouse_check_1.webp" /><br />
</div>

<hr class="space" />

<p>Second, the vectors are drawn out of paired captured positions.</p>

<div style="text-align: center; margin: auto">
  <img src="../assets/images/trigonometry_mouse_check_2.webp" /><br />
</div>

<hr class="space" />

<p>Next, the angles are calculated between the corresponding vectors.</p>

<div style="text-align: center; margin: auto">
  <img src="../assets/images/trigonometry_mouse_check_3.webp" /><br />
</div>

<hr class="space" />

<p>Finally, the angles are compared with the 45.0º threshold value, and if any of the angles is bigger than this hardcoded value, malware treats the result as being suspicious and does not execute the malicious code.</p>

<hr class="space" />

<p><b>Countermeasures</b></p>
<p></p>

<p>Implement the module for mouse movement during a sample emulation. Make sure to come up with a more delicate way of interacting with the mouse cursor rather than just random movements all around the screen, so that it resembles the behavior of a human being.</p>

<p><br /></p>
<h4><a class="a-dummy" name="check-via-request-for-user-interaction">2.2. Check via a request for user interaction</a></h4>
<p>Some malware samples contain a GUI installer which requires user interaction. For example, the user must click the “Install” or “Next” buttons. Therefore, the malware may take no action unless the button is clicked. Standard sandboxes like Cuckoo have a module which simulates user activity. It searches for and clicks buttons with the captions mentioned above.</p>

<hr class="space" />

<p>To prevent auto-clicking, a malware sample may create buttons with a class name that differs from “Button” or with a different caption (not “Install” or “Next”). This way the sandbox can’t detect and click the button.</p>

<hr class="space" />

<p><b>Code sample</b></p>
<p></p>

<figure class="highlight"><pre><code class="language-c" data-lang="c">   <span class="c1">// we use extended style flags to make a static look like a button</span>
   <span class="n">HWND</span> <span class="n">hButton</span> <span class="o">=</span> <span class="n">CreateWindowExW</span><span class="p">(</span>
       <span class="n">WS_EX_DLGMODALFRAME</span> <span class="o">|</span> <span class="n">WS_EX_WINDOWEDGE</span><span class="p">,</span>  <span class="c1">// extended style flags</span>
       <span class="n">TEXT</span><span class="p">(</span><span class="s">"static"</span><span class="p">),</span>         <span class="c1">// class "static" instead of "button"</span>
       <span class="n">TEXT</span><span class="p">(</span><span class="s">"Real next"</span><span class="p">),</span>      <span class="c1">// caption different from “Install” or “Next”</span>
       <span class="n">WS_VISIBLE</span> <span class="o">|</span> <span class="n">WS_CHILD</span> <span class="o">|</span> <span class="n">WS_GROUP</span> <span class="o">|</span> <span class="n">SS_CENTER</span><span class="p">,</span>  <span class="c1">// usual style flags</span>
       <span class="mi">10</span><span class="p">,</span> <span class="mi">10</span><span class="p">,</span> <span class="mi">80</span><span class="p">,</span> <span class="mi">25</span><span class="p">,</span>         <span class="c1">// arbitrary position and size, may be any</span>
       <span class="n">hWnd</span><span class="p">,</span>                   <span class="c1">// parent window</span>
       <span class="nb">NULL</span><span class="p">,</span>                   <span class="c1">// no menu</span>
       <span class="nb">NULL</span><span class="p">,</span>                   <span class="c1">// a handle to the instance of the module to be associated with the window</span>
       <span class="nb">NULL</span><span class="p">);</span>                  <span class="c1">// pointer to custom value is not required</span></code></pre></figure>

<hr class="space" />

<p><b>Countermeasures</b></p>
<p></p>

<p>Check for controls other than the buttons and examine their properties. For example, if the “Install” text is linked with the “static” control (not with “button”), this may indicate that the evasion technique is applied. Therefore, such a static control may be clicked.</p>

<p><br /></p>
<h4><a class="a-dummy" name="evasion-technique-for-cuckoo-human-interaction-module">2.3. Evasion technique for the Cuckoo human-interaction module</a></h4>
<p>Suppose that the malware installer window has a button with the “Install” caption or something similar. It can be found by the human-interaction module of a sandbox but it’s invisible to an actual user (one-pixel size, hidden, etc.).</p>

<hr class="space" />

<p>The real installation button has an empty or fake caption and the window class “Static”, so it can’t be detected by the auto-clicking module. In addition, the malware may take some mock action if the invisible button is clicked.</p>

<hr class="space" />

<p><b>Code sample</b></p>
<p></p>

<figure class="highlight"><pre><code class="language-c" data-lang="c">    <span class="n">HWND</span> <span class="n">hWnd</span> <span class="o">=</span> <span class="n">CreateWindow</span><span class="p">(</span>
        <span class="n">TEXT</span><span class="p">(</span><span class="s">"Button"</span><span class="p">),</span>         <span class="c1">// class "button"</span>
        <span class="n">TEXT</span><span class="p">(</span><span class="s">"Next"</span><span class="p">),</span>           <span class="c1">// caption is “Install” or “Next”</span>
        <span class="nb">NULL</span><span class="p">,</span>                   <span class="c1">// style flags are not required, the control is invisible</span>
        <span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span>             <span class="c1">// the control is created of 1x1 pixel size</span>
        <span class="n">hParentWnd</span><span class="p">,</span>             <span class="c1">// parent window</span>
        <span class="nb">NULL</span><span class="p">,</span>                   <span class="c1">// no menu</span>
        <span class="nb">NULL</span><span class="p">,</span>                   <span class="c1">// a handle to the instance of the module to be associated with the window</span>
        <span class="nb">NULL</span><span class="p">);</span>                  <span class="c1">// pointer to custom value is not required</span></code></pre></figure>

<hr class="space" />

<p><b>Countermeasures</b></p>
<p></p>

<p>Check for controls other than buttons and examine their properties. If there is a button of 1x1 pixel size or the button is invisible, this may be an indication of evasion technique applied. Therefore, such a control should not be clicked.</p>

<p><br /></p>
<h4><a class="a-dummy" name="no-suspicious-actions-until-a-document-is-scrolled-down">2.4. No suspicious actions until a document is scrolled down</a></h4>
<p>Malware payloads which reside in Office documents (namely, *.docm *.docx) don’t do anything until the document is scrolled to a certain page (second, third, etc.). A human user usually scrolls through the document while a virtual environment will likely not perform this step.</p>

<hr class="space" />

<p><b>Example from <a href="https://www.fireeye.com/content/dam/fireeye-www/current-threats/pdfs/pf/file/fireeye-hot-knives-through-butter.pdf">FireEye report</a> (p. 6-7):</b></p>
<p></p>

<p>RTF documents consist of normal text, control words, and groups. Microsoft’s RTF specification includes a shape-drawing function, which in turn includes a series of properties using the following syntax:<br />
<tt style="color:green">{\sp{\sn propertyName}{\sv propertyValueInformation}}</tt></p>

<p>In this code, <tt>\sp</tt> is the control word for the drawing property, <tt>\sn</tt> is the property name, and <tt>\sv</tt> contains information about the property value. The code snippet in the image below exploits a <a href="https://cve.mitre.org/cgi-bin/cvename.cgi?name=CVE-2010-3333">CVE-2010-3333 vulnerability</a> that occurs when using an invalid <tt>\sv</tt> value for the pFragments shape property:</p>

<div style="text-align: center; margin: auto">
  <img src="../assets/images/rtf_exploit.png" /><br />
</div>

<p><br />
A closer look at the exploit code, as shown in the next image, reveals a series of paragraph marks (<tt>./par</tt>) that appears before the exploit code:</p>

<div style="text-align: center; margin: auto">
  <img src="../assets/images/rtf_stub.png" /><br />
</div>

<p><br />
The repeated paragraph marks push the exploit code to the second page of the RTF document. Therefore, the malicious code does not execute unless the document scrolls down to bring the exploit code up into the active window — more likely to be a deliberate act by a human user than simulated movement in a virtual machine.<br /></p>

<p>When the RTF is scrolled down to the second page, only then is the exploit code triggered and the payload is downloaded.<br /></p>

<p>In a sandbox, where any mouse activity is random or preprogrammed, the RTF document’s second page never appears. Therefore, the malicious code never executes, and nothing seems amiss in the sandbox analysis.</p>

<hr class="space" />

<p><b>Countermeasures</b></p>
<p></p>
<p>Find a window with the document and send the WM_VSCROLL message there. Alternatively, send the WM_MOUSEWHEEL message as <a href="https://stackoverflow.com/questions/60203135/set-delta-in-a-wm-mousewheel-message-to-send-with-postmessage">described here</a>.</p>

<p><br /></p>
<h4><a class="a-dummy" name="check-user-activity-via-getlastinputinfo">2.5. Check user activity via GetLastInputInfo</a></h4>

<p>User activity can be checked with the call to the <code class="language-plaintext highlighter-rouge">GetLastInputInfo</code> function</p>

<p>Although Agent Tesla v3 performs this check, it does so incorrectly. Compare the code of Agent Tesla v3 with the correct technique implementation below.</p>

<div style="text-align: center; margin: auto">
  <img src="../assets/images/agent_tesla_v3_technique.png" /><br />
</div>
<div style="text-align: center; margin: auto">
  <i>Evasion technique as implemented in Agent Tesla v3. This function is called after a delay of 30 seconds.</i>
</div>

<hr class="space" />

<p>As measured time values are in milliseconds, the difference between them cannot be larger than 30000 (30 seconds). This means that with division by 1000.0, the resulting value cannot be larger than 30. In turn, this indicates that a comparison with 600 always leads to a result in which the sandbox is undetected.</p>

<p>The correct implementation is provided below.</p>

<hr class="space" />

<p><b>Code sample</b></p>
<p></p>

<figure class="highlight"><pre><code class="language-c" data-lang="c">    <span class="n">bool</span> <span class="n">sandbox_detected</span> <span class="o">=</span> <span class="nb">false</span><span class="p">;</span>
    
    <span class="n">Sleep</span><span class="p">(</span><span class="mi">30000</span><span class="p">);</span>

    <span class="n">DWORD</span> <span class="n">ticks</span> <span class="o">=</span> <span class="n">GetTickCount</span><span class="p">();</span>

    <span class="n">LASTINPUTINFO</span> <span class="n">li</span><span class="p">;</span>
    <span class="n">li</span><span class="p">.</span><span class="n">cbSize</span> <span class="o">=</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">LASTINPUTINFO</span><span class="p">);</span>
    <span class="n">BOOL</span> <span class="n">res</span> <span class="o">=</span> <span class="n">GetLastInputInfo</span><span class="p">(</span><span class="o">&amp;</span><span class="n">li</span><span class="p">);</span>

    <span class="k">if</span> <span class="p">(</span><span class="n">ticks</span> <span class="o">-</span> <span class="n">li</span><span class="p">.</span><span class="n">dwTime</span> <span class="o">&gt;</span> <span class="mi">6000</span><span class="p">)</span>
    <span class="p">{</span>
        <span class="n">sandbox_detected</span> <span class="o">=</span> <span class="nb">true</span><span class="p">;</span>
    <span class="p">}</span></code></pre></figure>

<hr class="space" />

<p><b>Countermeasures</b></p>
<p></p>

<p>Implement the module for mouse movement during a sample emulation.</p>

<p><br /></p>
<h3><a class="a-dummy" name="countermeasures"> Countermeasures</a></h3>
<p>Countermeasures for chapter 1 are given in the corresponding <a href="#general-detection-methods-via-registry-countermeasures">section</a>.
Countermeasures for chapter 2 are given in place in the appropriate sections.</p>

<p><br /></p>
<h3><a class="a-dummy" name="signature-recommendations">Signature recommendations</a></h3>
<p><i>Signature recommendations are not provided for this class of techniques as the methods described in this chapter do not imply their usage for evasion purposes. It is hard to differentiate between the code meant for evasion and code designed for non-evasion purposes.</i></p>

<p><br /></p>
<h3><a class="a-dummy" name="credits">Credits</a></h3>

<p>Open-source project from where code samples were taken:</p>
<ul>
<li>pafish project on <a href="https://github.com/a0rtega/pafish">Github</a></li>
</ul>

<p>Companies from where certain examples were taken:</p>
<ul>
<li><a href="https://www.fireeye.com">FireEye</a></li>
<li><a href="https://www.sentinelone.com/">SentinelOne</a></li>
</ul>

    <br>
    <div style="text-align: left">
        <a href="..">Go back</a>
    </div>
    <br>
    <div class="sharebuttons" style="text-align: center">
        <hr />
        <ul>
          <li>
            <p class="sharetitle"> Share this: </p>
          </li>
          <li class="reddit">
            <a href="http://www.reddit.com/submit?url=https://evasions.checkpoint.com/src/Evasions/techniques/human-like-behavior.html&title=Evasions:%20Human-like%20behavior - Evasion Techniques" target="_blank">
                <svg xmlns="http://www.w3.org/2000/svg"
                aria-label="Reddit" role="img"
                viewBox="0 0 512 512"><rect
                width="512" height="512"
                rx="15%"
                fill="#f40"/><g fill="#fff"><ellipse cx="256" cy="307" rx="166" ry="117"/><circle cx="106" cy="256" r="42"/><circle cx="407" cy="256" r="42"/><circle cx="375" cy="114" r="32"/></g><g stroke-linecap="round" stroke-linejoin="round" fill="none"><path d="m256 196 23-101 73 15" stroke="#fff" stroke-width="16"/><path d="m191 359c33 25 97 26 130 0" stroke="#f40" stroke-width="13"/></g><g fill="#f40"><circle cx="191" cy="287" r="31"/><circle cx="321" cy="287" r="31"/></g></svg>
                
            </a>
          </li>
          <li class="hn">
            <a href="http://news.ycombinator.com/submitlink?u=https://evasions.checkpoint.com/src/Evasions/techniques/human-like-behavior.html&t=Evasions:%20Human-like%20behavior - Evasion Techniques" target="_blank">
                <svg xmlns="http://www.w3.org/2000/svg"
                aria-label="Hacker News" role="img"
                viewBox="0 0 512 512"><rect
                width="512" height="512"
                rx="15%"
                fill="#f60"/><path fill="#fff" d="M124 91h51l81 162 81-164h51L276 293v136h-40V293z"/></svg>
            </a>
          </li>
          <li class="twitter">
            <a href="https://twitter.com/intent/tweet?via=_CPResearch_&url=https://evasions.checkpoint.com/src/Evasions/techniques/human-like-behavior.html&text=Evasions:%20Human-like%20behavior - Evasion Techniques" target="_blank">
                <svg viewBox="0 0 1792 1792" xmlns="http://www.w3.org/2000/svg"><path d="M1684 408q-67 98-162 167 1 14 1 42 0 130-38 259.5t-115.5 248.5-184.5 210.5-258 146-323 54.5q-271 0-496-145 35 4 78 4 225 0 401-138-105-2-188-64.5t-114-159.5q33 5 61 5 43 0 85-11-112-23-185.5-111.5t-73.5-205.5v-4q68 38 146 41-66-44-105-115t-39-154q0-88 44-163 121 149 294.5 238.5t371.5 99.5q-8-38-8-74 0-134 94.5-228.5t228.5-94.5q140 0 236 102 109-21 205-78-37 115-142 178 93-10 186-50z"/></svg>
            </a>
          </li>
          <li class="linkedin">
            <a href=https://www.linkedin.com/shareArticle?mini=true&url=https://evasions.checkpoint.com/src/Evasions/techniques/human-like-behavior.html&title=Evasions:%20Human-like%20behavior - Evasion Techniques&source=LinkedIn" target="_blank">
                <svg viewBox="0 0 1792 1792" xmlns="http://www.w3.org/2000/svg"><path d="M477 625v991h-330v-991h330zm21-306q1 73-50.5 122t-135.5 49h-2q-82 0-132-49t-50-122q0-74 51.5-122.5t134.5-48.5 133 48.5 51 122.5zm1166 729v568h-329v-530q0-105-40.5-164.5t-126.5-59.5q-63 0-105.5 34.5t-63.5 85.5q-11 30-11 81v553h-329q2-399 2-647t-1-296l-1-48h329v144h-2q20-32 41-56t56.5-52 87-43.5 114.5-15.5q171 0 275 113.5t104 332.5z"/></svg>
            </a>
          </li>
        </ul>
      </div>
      
</article>


</section>

<nav class="navbar navbar-default navbar-fixed-bottom">
  <div class="container footer-content">

    Made with <font class="a-pink"><i class ="fa fa-heart"></i></font> to serve the community by Check Point Research    |    <a class="a-pink" href="https://research.checkpoint.com">Research blog</a>    |    <a class="a-pink" href="https://research.checkpoint.com/about-us/">About Us</a>    |    <a class="a-pink" href="https://github.com/CheckPointSW"><i class="fa fa-github fa-lg"></i></a> <a class="a-pink" href="https://twitter.com/_CPResearch_"><i class="fa fa-twitter fa-lg"></i></a>
    
    <br>
    
    © 1994-2024 Check Point Software Technologies LTD | All rights reserved | Property of CheckPoint.com


  </div>
</nav>

  </body>

</html>
<!DOCTYPE html>
<html>

  <head>
  <meta charset="utf-8">
  <meta http-equiv="X-UA-Compatible" content="IE=edge">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-194688-3"></script>
  <script>
   window.dataLayer = window.dataLayer || [];
   function gtag(){dataLayer.push(arguments);}
   gtag('js', new Date());
   gtag('config', 'UA-194688-3');
  </script>
  <meta content="Evasion techniques" property="og:site_name">

  <meta content="Evasions: Network" property="og:title">


  <meta name="twitter:title" content="Malware Evasion Encyclopedia" />
  <meta name="twitter:image" content="https://research.checkpoint.com/wp-content/uploads/2020/02/evasions.jpg" />


  <meta content="article" property="og:type">


  <meta content="Evasion techniques
" property="og:description">


  <meta content="https://evasions.checkpoint.com/src/Evasions/techniques/network.html" property="og:url">


  <meta content="2024-07-10T07:20:28+00:00" property="article:published_time">
  <meta content="https://evasions.checkpoint.com/about/" property="article:author">


  <meta property="og:image" content="">


  
  <meta content="evasions" property="article:section">
  


  
  <meta content="network" property="article:tag">
  

  <title>Evasions: Network</title>
  <meta name="description" content="Contents">
<script src="https://ajax.googleapis.com/ajax/libs/jquery/2.2.2/jquery.min.js"></script>
<script src="https://maxcdn.bootstrapcdn.com/bootstrap/3.3.6/js/bootstrap.min.js" integrity="sha384-0mSbJDEHialfmuBBQP6A4Qrprq5OVfW37PRR3j5ELqxss1yVqOtnepnHVP9aJ7xS" crossorigin="anonymous"></script>
  <link rel="stylesheet" href="https://evasions.checkpoint.com/assets/css/main.css">
<script src="https://maxcdn.bootstrapcdn.com/bootstrap/3.3.6/js/bootstrap.min.js" integrity="sha384-0mSbJDEHialfmuBBQP6A4Qrprq5OVfW37PRR3j5ELqxss1yVqOtnepnHVP9aJ7xS" crossorigin="anonymous"></script>

  <link href='https://fonts.googleapis.com/css?family=PT+Sans' rel='stylesheet' type='text/css'>
  <link href='https://fonts.googleapis.com/css?family=Fira+Mono' rel='stylesheet' type='text/css'>
  <link href='https://fonts.googleapis.com/css?family=Lato:400,700' rel='stylesheet' type='text/css'>
  <link href='https://fonts.googleapis.com/css?family=Source+Code+Pro:400,200,300,500,600,700,900' rel='stylesheet' type='text/css'>
  <link href='https://fonts.googleapis.com/css?family=Gentium+Basic:400,700' rel='stylesheet' type='text/css'>
  <link href='https://fonts.googleapis.com/css?family=Alegreya:400,400italic,700' rel='stylesheet' type='text/css'>
  <link href='https://fonts.googleapis.com/css?family=Lora:400,400italic,700' rel='stylesheet' type='text/css'>
  <link href='https://fonts.googleapis.com/css?family=Fira+Sans:400,300,500,700' rel='stylesheet' type='text/css'>
  <script src="https://ajax.googleapis.com/ajax/libs/jquery/2.2.0/jquery.min.js"></script>
  <link href='https://fonts.googleapis.com/css?family=Open+Sans:400,700' rel='stylesheet' type='text/css'>
  <link href="https://maxcdn.bootstrapcdn.com/bootstrap/3.3.6/css/bootstrap.min.css" rel="stylesheet" integrity="sha384-1q8mTJOASx8j1Au+a5WDVnPi2lkFfwwEAa8hDDdjZlpLegxhjVME1fgjWPGmkzs7" crossorigin="anonymous">
  <link href="https://maxcdn.bootstrapcdn.com/font-awesome/4.6.1/css/font-awesome.min.css" rel="stylesheet" integrity="sha384-hQpvDQiCJaD2H465dQfA717v7lu5qHWtDbWNPvaTJ0ID5xnPUlVXnKzq7b8YUkbN" crossorigin="anonymous">
  <link rel="canonical" href="https://evasions.checkpoint.com/src/Evasions/techniques/network.html">
  <link rel="alternate" type="application/rss+xml" title="Evasion techniques" href="https://evasions.checkpoint.com/feed.xml">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/tinysort/2.3.6/tinysort.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/tinysort/2.3.6/tinysort.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/tinysort/2.3.6/tinysort.charorder.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/tinysort/2.3.6/tinysort.charorder.min.js"></script>
  <script type="text/javascript" async src="//platform.twitter.com/widgets.js"></script>




</head>


  <body>
<section>
<article class="post" itemscope itemtype="http://schema.org/BlogPosting">
  <div class="jumbotron">
    <div class="container">
      <h1 class="post-title-main" itemprop="name headline">Evasions: Network</h1>
    </div>
</div>

  <div class="post-content container" itemprop="articleBody">
    <div style="text-align: left">
        <a href="..">Go back</a>
        <br>
        <br>
    </div>
    <h1>Contents</h1>

<p><a href="#network-detection-methods">Network detection methods used</a>
<br />
  <a href="#check-specific-network-properties">1. Specific network properties</a>
<br />
  <a href="#check-if-mac-address-is-specific">1.1. Check if MAC address is specific</a>
<br />
  <a href="#check-if-adapter-name-is-specific">1.2. Check if adapter name is specific</a>
<br />
  <a href="#check-if-provider-name-for-network-shares-is-specific">1.3. Check if provider’s name for network shares is specific</a>
<br />
  <a href="#check-if-network-belongs-to-security-perimeter">2. Check if network belongs to security perimeter</a>
<br />
  <a href="#netvalidatename-result-based-anti-emulation-technique">3. <tt>NetValidateName</tt> result based anti-emulation technique</a>
<br />
  <a href="#cuckoo-resultserver-connection-based-anti-emulation-technique">4. Cuckoo ResultServer connection based anti-emulation technique</a>
<br />
  <a href="#signature-recommendations">Signature recommendations</a>
<br />
  <a href="#countermeasures-sandboxie">Countermeasures</a>
<br />
  <a href="#credits">Credits</a>
<br />
<br /></p>

<hr class="space" />

<h2><a class="a-dummy" name="network-detection-methods">Network detection methods</a></h2>
<p>Evasion techniques in this group are related to network in this or that sense. Either network-related functions are used or network parameters are checked — if they are different from that of usual host OS then virtual environment is likely detected.</p>

<p><br /></p>
<h3><a class="a-dummy" name="check-specific-network-properties">1. Specific network properties</a></h3>
<p>Vendors of different virtual environments hard-code some values (MAC address) and names (network adapter) for their products — due to this fact such 
environments may be detected via checking properties of appropriate objects.</p>

<p><br /></p>
<h4><a class="a-dummy" name="check-if-mac-address-is-specific">1.1. Check if MAC address is specific</a></h4>

<p>Functions used:</p>
<ul>
  <li><tt>GetAdaptersAddresses(AF_UNSPEC, ...)</tt></li> 
  <li><tt>GetAdaptersInfo</tt></li> 
</ul>

<hr class="space" />

<p><b>Code sample (function <tt>GetAdaptersAddresses</tt>)</b></p>
<p></p>

<figure class="highlight"><pre><code class="language-c" data-lang="c"><span class="kt">int</span> <span class="nf">pafish_check_mac_vendor</span><span class="p">(</span><span class="kt">char</span> <span class="o">*</span> <span class="n">mac_vendor</span><span class="p">)</span> <span class="p">{</span>
    <span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">alist_size</span> <span class="o">=</span> <span class="mi">0</span><span class="p">,</span> <span class="n">ret</span><span class="p">;</span>
    <span class="n">ret</span> <span class="o">=</span> <span class="n">GetAdaptersAddresses</span><span class="p">(</span><span class="n">AF_UNSPEC</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">alist_size</span><span class="p">);</span>

    <span class="k">if</span> <span class="p">(</span><span class="n">ret</span> <span class="o">==</span> <span class="n">ERROR_BUFFER_OVERFLOW</span><span class="p">)</span> <span class="p">{</span>
        <span class="n">IP_ADAPTER_ADDRESSES</span><span class="o">*</span> <span class="n">palist</span> <span class="o">=</span> <span class="p">(</span><span class="n">IP_ADAPTER_ADDRESSES</span><span class="o">*</span><span class="p">)</span><span class="n">LocalAlloc</span><span class="p">(</span><span class="n">LMEM_ZEROINIT</span><span class="p">,</span><span class="n">alist_size</span><span class="p">);</span>
        <span class="kt">void</span> <span class="o">*</span> <span class="n">palist_free</span> <span class="o">=</span> <span class="n">palist</span><span class="p">;</span>

        <span class="k">if</span> <span class="p">(</span><span class="n">palist</span><span class="p">)</span> <span class="p">{</span>
            <span class="n">GetAdaptersAddresses</span><span class="p">(</span><span class="n">AF_UNSPEC</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="n">palist</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">alist_size</span><span class="p">);</span>
            <span class="kt">char</span> <span class="n">mac</span><span class="p">[</span><span class="mi">6</span><span class="p">]</span><span class="o">=</span><span class="p">{</span><span class="mi">0</span><span class="p">};</span>
            <span class="k">while</span> <span class="p">(</span><span class="n">palist</span><span class="p">){</span>
                <span class="k">if</span> <span class="p">(</span><span class="n">palist</span><span class="o">-&gt;</span><span class="n">PhysicalAddressLength</span> <span class="o">==</span> <span class="mh">0x6</span><span class="p">)</span> <span class="p">{</span>
                    <span class="n">memcpy</span><span class="p">(</span><span class="n">mac</span><span class="p">,</span> <span class="n">palist</span><span class="o">-&gt;</span><span class="n">PhysicalAddress</span><span class="p">,</span> <span class="mh">0x6</span><span class="p">);</span>
                    <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">memcmp</span><span class="p">(</span><span class="n">mac_vendor</span><span class="p">,</span> <span class="n">mac</span><span class="p">,</span> <span class="mi">3</span><span class="p">))</span> <span class="p">{</span>  <span class="cm">/* First 3 bytes are the same */</span>
                        <span class="n">LocalFree</span><span class="p">(</span><span class="n">palist_free</span><span class="p">);</span>
                        <span class="k">return</span> <span class="n">TRUE</span><span class="p">;</span>
                    <span class="p">}</span>
                <span class="p">}</span>
                <span class="n">palist</span> <span class="o">=</span> <span class="n">palist</span><span class="o">-&gt;</span><span class="n">Next</span><span class="p">;</span>
            <span class="p">}</span>
            <span class="n">LocalFree</span><span class="p">(</span><span class="n">palist_free</span><span class="p">);</span>
        <span class="p">}</span>
    <span class="p">}</span>

    <span class="k">return</span> <span class="n">FALSE</span><span class="p">;</span>
<span class="p">}</span></code></pre></figure>

<p><i>Credits for this code sample: <a href="https://github.com/a0rtega/pafish">pafish project</a> </i></p>

<hr class="space" />

<p><b>Code sample (function <tt>GetAdaptersInfo</tt>)</b></p>
<p></p>

<figure class="highlight"><pre><code class="language-c" data-lang="c"><span class="n">BOOL</span> <span class="nf">check_mac_addr</span><span class="p">(</span><span class="n">TCHAR</span><span class="o">*</span> <span class="n">szMac</span><span class="p">)</span>
<span class="p">{</span>
    <span class="n">BOOL</span> <span class="n">bResult</span> <span class="o">=</span> <span class="n">FALSE</span><span class="p">;</span>
    <span class="n">PIP_ADAPTER_INFO</span> <span class="n">pAdapterInfo</span><span class="p">;</span>
    <span class="n">ULONG</span> <span class="n">ulOutBufLen</span> <span class="o">=</span> <span class="k">sizeof</span> <span class="p">(</span><span class="n">IP_ADAPTER_INFO</span><span class="p">);</span> 
    <span class="n">pAdapterInfo</span> <span class="o">=</span> <span class="p">(</span><span class="n">PIP_ADAPTER_INFO</span><span class="p">)</span> <span class="n">MALLOC</span><span class="p">(</span><span class="k">sizeof</span><span class="p">(</span><span class="n">IP_ADAPTER_INFO</span><span class="p">));</span>

    <span class="k">if</span> <span class="p">(</span><span class="n">pAdapterInfo</span> <span class="o">==</span> <span class="nb">NULL</span><span class="p">)</span>
    <span class="p">{</span>
        <span class="n">_tprintf</span><span class="p">(</span><span class="n">_T</span><span class="p">(</span><span class="s">"Error allocating memory needed to call GetAdaptersinfo.</span><span class="se">\n</span><span class="s">"</span><span class="p">));</span>
        <span class="k">return</span> <span class="o">-</span><span class="mi">1</span><span class="p">;</span>
    <span class="p">}</span>

    <span class="c1">// Make an initial call to GetAdaptersInfo to get the necessary size into the ulOutBufLen variable</span>
    <span class="k">if</span> <span class="p">(</span><span class="n">GetAdaptersInfo</span><span class="p">(</span><span class="n">pAdapterInfo</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">ulOutBufLen</span><span class="p">)</span> <span class="o">==</span> <span class="n">ERROR_BUFFER_OVERFLOW</span><span class="p">)</span> 
    <span class="p">{</span>
        <span class="n">FREE</span><span class="p">(</span><span class="n">pAdapterInfo</span><span class="p">);</span>
        <span class="n">pAdapterInfo</span> <span class="o">=</span> <span class="p">(</span><span class="n">PIP_ADAPTER_INFO</span><span class="p">)</span> <span class="n">MALLOC</span><span class="p">(</span><span class="n">ulOutBufLen</span><span class="p">);</span>
        <span class="k">if</span> <span class="p">(</span><span class="n">pAdapterInfo</span> <span class="o">==</span> <span class="nb">NULL</span><span class="p">)</span> <span class="p">{</span>
            <span class="n">printf</span><span class="p">(</span><span class="s">"Error allocating memory needed to call GetAdaptersinfo</span><span class="se">\n</span><span class="s">"</span><span class="p">);</span>
            <span class="k">return</span> <span class="mi">1</span><span class="p">;</span>
        <span class="p">}</span>
    <span class="p">}</span>

    <span class="c1">// Now, we can call GetAdaptersInfo</span>
    <span class="k">if</span> <span class="p">(</span><span class="n">GetAdaptersInfo</span><span class="p">(</span><span class="n">pAdapterInfo</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">ulOutBufLen</span><span class="p">)</span> <span class="o">==</span> <span class="n">ERROR_SUCCESS</span><span class="p">)</span>
    <span class="p">{</span>
        <span class="c1">// Convert the given mac address to an array of multibyte chars so we can compare.</span>
        <span class="n">CHAR</span> <span class="n">szMacMultiBytes</span> <span class="p">[</span><span class="mi">4</span><span class="p">];</span>
        <span class="k">for</span> <span class="p">(</span><span class="kt">int</span> <span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="mi">4</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
            <span class="n">szMacMultiBytes</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span><span class="n">CHAR</span><span class="p">)</span><span class="n">szMac</span><span class="p">[</span><span class="n">i</span><span class="p">];</span>
        <span class="p">}</span>
        <span class="k">while</span><span class="p">(</span><span class="n">pAdapterInfo</span><span class="p">)</span>
        <span class="p">{</span>
            <span class="k">if</span> <span class="p">(</span><span class="n">pAdapterInfo</span><span class="o">-&gt;</span><span class="n">AddressLength</span> <span class="o">==</span> <span class="mi">6</span> <span class="o">&amp;&amp;</span> <span class="o">!</span><span class="n">memcmp</span><span class="p">(</span><span class="n">szMacMultiBytes</span><span class="p">,</span> <span class="n">pAdapterInfo</span><span class="o">-&gt;</span><span class="n">Address</span><span class="p">,</span> <span class="mi">3</span><span class="p">))</span>
            <span class="p">{</span>
                <span class="n">bResult</span> <span class="o">=</span> <span class="n">TRUE</span><span class="p">;</span>
                <span class="k">break</span><span class="p">;</span>
            <span class="p">}</span>
            <span class="n">pAdapterInfo</span> <span class="o">=</span> <span class="n">pAdapterInfo</span><span class="o">-&gt;</span><span class="n">Next</span><span class="p">;</span>
        <span class="p">}</span>
    <span class="p">}</span>

    <span class="k">return</span> <span class="n">bResult</span><span class="p">;</span>
<span class="p">}</span></code></pre></figure>

<p><i>Credits for this code sample: <a href="https://github.com/LordNoteworthy/al-khaser">al-khaser project</a></i></p>

<hr class="space" />

<p><b>Detections table</b></p>

<table style="width:60%">
  <tr>
    <td colspan="3">Check if MAC address starts from one of the following values:</td>
  </tr>
  <tr>
    <th style="text-align:center">Detect</th>
    <th style="text-align:center">MAC address starts with</th>
    <th style="text-align:center">Bytes</th>
  </tr>
  <tr>
    <th>Parallels</th>
    <td>00:1C:42</td>
    <td>\x00\x1C\x42</td>
  </tr>
  <tr>
    <th>VirtualBox</th>
    <td>08:00:27</td>
    <td>\x08\x00\x27</td>
  </tr>
  <tr>
    <th rowspan="4">VMware</th>
    <td>00:05:69</td>
    <td>\x00\x05\x69</td>
  </tr>
  <tr>
    <td>00:0C:29</td>
    <td>\x00\x0C\x29</td>
  </tr>
  <tr>
    <td>00:1C:14</td>
    <td>\x00\x1C\x14</td>
  </tr>
  <tr>
    <td>00:50:56</td>
    <td>\x00\x50\x56</td>
  </tr>
  <tr>
    <th>Xen</th>
    <td>00:16:E3</td>
    <td>\x00\x16\xE3</td>
  </tr>
</table>

<p><br /></p>
<h4><a class="a-dummy" name="check-if-adapter-name-is-specific">1.2. Check if adapter name is specific</a></h4>

<p>Functions used:</p>
<ul>
  <li><tt>GetAdaptersAddresses(AF_UNSPEC, ...)</tt></li> 
  <li><tt>GetAdaptersInfo</tt></li> 
</ul>

<hr class="space" />

<p><b>Code sample (function <tt>GetAdaptersAddresses</tt>)</b></p>
<p></p>

<figure class="highlight"><pre><code class="language-c" data-lang="c"><span class="kt">int</span> <span class="nf">pafish_check_adapter_name</span><span class="p">(</span><span class="kt">char</span> <span class="o">*</span> <span class="n">name</span><span class="p">)</span> <span class="p">{</span>
    <span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">alist_size</span> <span class="o">=</span> <span class="mi">0</span><span class="p">,</span> <span class="n">ret</span><span class="p">;</span>
    <span class="kt">wchar_t</span> <span class="n">aux</span><span class="p">[</span><span class="mi">1024</span><span class="p">];</span>

    <span class="n">mbstowcs</span><span class="p">(</span><span class="n">aux</span><span class="p">,</span> <span class="n">name</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">aux</span><span class="p">)</span><span class="o">-</span><span class="k">sizeof</span><span class="p">(</span><span class="n">aux</span><span class="p">[</span><span class="mi">0</span><span class="p">]));</span>
    <span class="n">ret</span> <span class="o">=</span> <span class="n">GetAdaptersAddresses</span><span class="p">(</span><span class="n">AF_UNSPEC</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">alist_size</span><span class="p">);</span>

    <span class="k">if</span> <span class="p">(</span><span class="n">ret</span> <span class="o">==</span> <span class="n">ERROR_BUFFER_OVERFLOW</span><span class="p">)</span> <span class="p">{</span>
        <span class="n">IP_ADAPTER_ADDRESSES</span> <span class="o">*</span><span class="n">palist</span> <span class="o">=</span> <span class="p">(</span><span class="n">IP_ADAPTER_ADDRESSES</span> <span class="o">*</span><span class="p">)</span><span class="n">LocalAlloc</span><span class="p">(</span><span class="n">LMEM_ZEROINIT</span><span class="p">,</span> <span class="n">alist_size</span><span class="p">);</span>
        <span class="kt">void</span> <span class="o">*</span> <span class="n">palist_free</span> <span class="o">=</span> <span class="n">palist</span><span class="p">;</span>
        <span class="k">if</span> <span class="p">(</span><span class="n">palist</span><span class="p">)</span> <span class="p">{</span>
            <span class="k">if</span> <span class="p">(</span><span class="n">GetAdaptersAddresses</span><span class="p">(</span><span class="n">AF_UNSPEC</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="n">palist</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">alist_size</span><span class="p">)</span> <span class="o">==</span> <span class="n">ERROR_SUCCESS</span><span class="p">)</span> <span class="p">{</span>
                <span class="k">while</span> <span class="p">(</span><span class="n">palist</span><span class="p">)</span> <span class="p">{</span>
                    <span class="k">if</span> <span class="p">(</span><span class="n">wcsstr</span><span class="p">(</span><span class="n">palist</span><span class="o">-&gt;</span><span class="n">Description</span><span class="p">,</span> <span class="n">aux</span><span class="p">))</span> <span class="p">{</span>
                        <span class="n">LocalFree</span><span class="p">(</span><span class="n">palist_free</span><span class="p">);</span>
                        <span class="k">return</span> <span class="n">TRUE</span><span class="p">;</span>
                    <span class="p">}</span>
                    <span class="n">palist</span> <span class="o">=</span> <span class="n">palist</span><span class="o">-&gt;</span><span class="n">Next</span><span class="p">;</span>
                <span class="p">}</span>
            <span class="p">}</span>
            <span class="n">LocalFree</span><span class="p">(</span><span class="n">palist_free</span><span class="p">);</span>
        <span class="p">}</span>
    <span class="p">}</span>

    <span class="k">return</span> <span class="n">FALSE</span><span class="p">;</span>
<span class="p">}</span></code></pre></figure>

<p><i>Credits for this code sample: <a href="https://github.com/a0rtega/pafish">pafish project</a> </i></p>

<hr class="space" />

<p><b>Code sample (function <tt>GetAdaptersInfo</tt>)</b></p>
<p></p>

<figure class="highlight"><pre><code class="language-c" data-lang="c"><span class="n">BOOL</span> <span class="nf">check_adapter_name</span><span class="p">(</span><span class="n">TCHAR</span><span class="o">*</span> <span class="n">szName</span><span class="p">)</span>
<span class="p">{</span>
    <span class="n">BOOL</span> <span class="n">bResult</span> <span class="o">=</span> <span class="n">FALSE</span><span class="p">;</span>
    <span class="n">PIP_ADAPTER_INFO</span> <span class="n">pAdapterInfo</span><span class="p">;</span>
    <span class="n">ULONG</span> <span class="n">ulOutBufLen</span> <span class="o">=</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">IP_ADAPTER_INFO</span><span class="p">);</span>
    <span class="n">pAdapterInfo</span> <span class="o">=</span> <span class="p">(</span><span class="n">PIP_ADAPTER_INFO</span><span class="p">)</span><span class="n">MALLOC</span><span class="p">(</span><span class="k">sizeof</span><span class="p">(</span><span class="n">IP_ADAPTER_INFO</span><span class="p">));</span>

    <span class="k">if</span> <span class="p">(</span><span class="n">pAdapterInfo</span> <span class="o">==</span> <span class="nb">NULL</span><span class="p">)</span>
    <span class="p">{</span>
        <span class="n">_tprintf</span><span class="p">(</span><span class="n">_T</span><span class="p">(</span><span class="s">"Error allocating memory needed to call GetAdaptersinfo.</span><span class="se">\n</span><span class="s">"</span><span class="p">));</span>
        <span class="k">return</span> <span class="o">-</span><span class="mi">1</span><span class="p">;</span>
    <span class="p">}</span>

    <span class="c1">// Make an initial call to GetAdaptersInfo to get the necessary size into the ulOutBufLen variable</span>
    <span class="k">if</span> <span class="p">(</span><span class="n">GetAdaptersInfo</span><span class="p">(</span><span class="n">pAdapterInfo</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">ulOutBufLen</span><span class="p">)</span> <span class="o">==</span> <span class="n">ERROR_BUFFER_OVERFLOW</span><span class="p">)</span>
    <span class="p">{</span>
        <span class="n">FREE</span><span class="p">(</span><span class="n">pAdapterInfo</span><span class="p">);</span>
        <span class="n">pAdapterInfo</span> <span class="o">=</span> <span class="p">(</span><span class="n">PIP_ADAPTER_INFO</span><span class="p">)</span><span class="n">MALLOC</span><span class="p">(</span><span class="n">ulOutBufLen</span><span class="p">);</span>
        <span class="k">if</span> <span class="p">(</span><span class="n">pAdapterInfo</span> <span class="o">==</span> <span class="nb">NULL</span><span class="p">)</span> <span class="p">{</span>
            <span class="n">printf</span><span class="p">(</span><span class="s">"Error allocating memory needed to call GetAdaptersinfo</span><span class="se">\n</span><span class="s">"</span><span class="p">);</span>
            <span class="k">return</span> <span class="mi">1</span><span class="p">;</span>
        <span class="p">}</span>
    <span class="p">}</span>

    <span class="k">if</span> <span class="p">(</span><span class="n">GetAdaptersInfo</span><span class="p">(</span><span class="n">pAdapterInfo</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">ulOutBufLen</span><span class="p">)</span> <span class="o">==</span> <span class="n">ERROR_SUCCESS</span><span class="p">)</span>
    <span class="p">{</span>
        <span class="k">while</span> <span class="p">(</span><span class="n">pAdapterInfo</span><span class="p">)</span>
        <span class="p">{</span>
            <span class="k">if</span> <span class="p">(</span><span class="n">StrCmpI</span><span class="p">(</span><span class="n">ascii_to_wide_str</span><span class="p">(</span><span class="n">pAdapterInfo</span><span class="o">-&gt;</span><span class="n">Description</span><span class="p">),</span> <span class="n">szName</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span>
            <span class="p">{</span>
                <span class="n">bResult</span> <span class="o">=</span> <span class="n">TRUE</span><span class="p">;</span>
                <span class="k">break</span><span class="p">;</span>
            <span class="p">}</span>
            <span class="n">pAdapterInfo</span> <span class="o">=</span> <span class="n">pAdapterInfo</span><span class="o">-&gt;</span><span class="n">Next</span><span class="p">;</span>
        <span class="p">}</span>
    <span class="p">}</span>

    <span class="k">return</span> <span class="n">bResult</span><span class="p">;</span>
<span class="p">}</span></code></pre></figure>

<p><i>Credits for this code sample: <a href="https://github.com/LordNoteworthy/al-khaser">al-khaser project</a></i></p>

<hr class="space" />

<p><b>Detections table</b></p>

<table style="width:60%">
  <tr>
    <td colspan="2">Check adapter name to be the following:</td>
  </tr>
  <tr>
    <th style="text-align:center">Detect</th>
    <th style="text-align:center">Name</th>
  </tr>
  <tr>
    <th>VMware</th>
    <td>Vmware</td>
  </tr>
</table>

<p><br /></p>
<h4><a class="a-dummy" name="check-if-provider-name-for-network-shares-is-specific">1.3. Check if provider's name for network shares is specific</a></h4>

<p>Functions used (see note about native functions):</p>
<ul>
  <li><tt>WNetGetProviderName(WNNC_NET_RDR2SAMPLE, ...)</tt></li> 
</ul>

<hr class="space" />

<p><b>Code sample</b></p>
<p></p>

<figure class="highlight"><pre><code class="language-c" data-lang="c"><span class="kt">int</span> <span class="nf">vbox_network_share</span><span class="p">()</span> <span class="p">{</span>
    <span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">pnsize</span> <span class="o">=</span> <span class="mh">0x1000</span><span class="p">;</span>
    <span class="kt">char</span> <span class="n">provider</span><span class="p">[</span><span class="n">pnsize</span><span class="p">];</span>

    <span class="kt">int</span> <span class="n">retv</span> <span class="o">=</span> <span class="n">WNetGetProviderName</span><span class="p">(</span><span class="n">WNNC_NET_RDR2SAMPLE</span><span class="p">,</span> <span class="n">provider</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">pnsize</span><span class="p">);</span>
    <span class="k">if</span> <span class="p">(</span><span class="n">retv</span> <span class="o">==</span> <span class="n">NO_ERROR</span><span class="p">)</span> <span class="p">{</span>
        <span class="k">if</span> <span class="p">(</span><span class="n">lstrcmpi</span><span class="p">(</span><span class="n">provider</span><span class="p">,</span> <span class="s">"VirtualBox Shared Folders"</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span>
            <span class="k">return</span> <span class="n">TRUE</span><span class="p">;</span>
        <span class="k">else</span>
            <span class="k">return</span> <span class="n">FALSE</span><span class="p">;</span>
    <span class="p">}</span>

    <span class="k">return</span> <span class="n">FALSE</span><span class="p">;</span>
<span class="p">}</span></code></pre></figure>

<p><i>Credits for this code sample: <a href="https://github.com/a0rtega/pafish">pafish project</a> </i></p>

<hr class="space" />

<p><b>Detections table</b></p>

<table style="width:60%">
  <tr>
    <td colspan="2">Check provider's name for network shares to be the following:</td>
  </tr>
  <tr>
    <th style="text-align:center">Detect</th>
    <th style="text-align:center">Name</th>
  </tr>
  <tr>
    <th>VirtualBox</th>
    <td>VirtualBox Shared Folders</td>
  </tr>
</table>

<p><br /></p>
<h3><a class="a-dummy" name="check-if-network-belongs-to-security-perimeter">2. Check if network belongs to security perimeter</a></h3>

<p>Malware makes a request to <ins><tt>https[:]//www.maxmind.com/geoip/v2.1/city/me</tt></ins> which normally requires some kind of authentication or API key. To get around this requirement, the malware makes the request look as if it’s coming from the site itself by setting the HTTP Referrer to <ins><tt>https[:]//www.maxmind.com/en/locate-my-ip-address</tt></ins> and User-Agent to <em><tt>Mozilla/5.0 (compatible; MSIE 10.0; Windows NT 6.1; Trident/6.0)</tt></em>. This trick allows the sample to retrieve the information about IP address of the machine it’s running on.
<br />
<br />
The response is returned in JSON format and contains information about the country, city, and, most importantly, the organization associated with the IP address. If some “bad” strings are found in the response, malware knows that it’s launched inside some kind of a security perimeter/organization.</p>

<p><br /></p>

<p><b>Examples</b></p>
<ul>
  <li><a href="https://www.sentinelone.com/blog/anti-vm-tricks/">anti VM tricks</a></li> 
  <li>malicious macros add sandbox evasion techniques to distribute <a href="https://www.proofpoint.com/us/threat-insight/post/malicious-macros-add-to-sandbox-evasion-techniques-to-distribute-new-dridex">new Dridex</a></li> 
  <li>malicious <a href="https://www.zscaler.com/blogs/research/malicious-documents-leveraging-new-anti-vm-anti-sandbox-techniques">documents with macros</a> evading automated analysis systems</li> 
</ul>

<hr class="space" />

<p><b>“Bad strings” from malware sample (fixed capitalization):</b></p>
<p></p>

<figure class="highlight"><pre><code class="language-c" data-lang="c"><span class="n">Amazon</span>
<span class="n">anonymous</span>
<span class="n">BitDefender</span>
<span class="n">BlackOakComputers</span>
<span class="n">Blue</span> <span class="n">Coat</span>
<span class="n">BlueCoat</span>
<span class="n">Cisco</span>
<span class="n">cloud</span>
<span class="n">Data</span> <span class="n">Center</span>
<span class="n">DataCenter</span>
<span class="n">DataCentre</span>
<span class="n">dedicated</span>
<span class="n">ESET</span><span class="p">,</span> <span class="n">Spol</span>
<span class="n">FireEye</span>
<span class="n">ForcePoint</span>
<span class="n">Fortinet</span>
<span class="n">Hetzner</span>
<span class="n">hispeed</span><span class="p">.</span><span class="n">ch</span>
<span class="n">hosted</span>
<span class="n">Hosting</span>
<span class="n">Iron</span> <span class="n">Port</span>
<span class="n">IronPort</span>
<span class="n">LeaseWeb</span>
<span class="n">MessageLabs</span>
<span class="n">Microsoft</span>
<span class="n">MimeCast</span>
<span class="n">NForce</span>
<span class="n">Ovh</span> <span class="n">Sas</span>
<span class="n">Palo</span> <span class="n">Alto</span>
<span class="n">ProofPoint</span>
<span class="n">Rackspace</span>
<span class="n">security</span>
<span class="n">Server</span>
<span class="n">Strong</span> <span class="n">Technologies</span>
<span class="n">Trend</span> <span class="n">Micro</span>
<span class="n">TrendMicro</span>
<span class="n">TrustWave</span>
<span class="n">VMVault</span>
<span class="n">Zscaler</span></code></pre></figure>

<p><br /></p>
<h3><a class="a-dummy" name="netvalidatename-result-based-anti-emulation-technique">3. <tt>NetValidateName</tt> result based anti-emulation technique</a></h3>

<p><i>Initially this technique was designed for bypassing AV detection. It’s not an evasion technique itself — instead it abuses interesting side-effects after the function is called.</i>
<br />
<br />
The main idea is to use the determined result of <tt>NetValidateName</tt> API function call with invalid argument as Server name (for example “123”) for calculating jump address dynamically. This jump usually points into the middle of some instruction to bypass heuristic analysis of AV software. But this technique also has (at least) one side-effect.
<br />
<br />
If default NetBIOS settings are set in the operating system (NetBIOS over TCP/IP is enabled) the return code is always equal to <tt>ERROR_BAD_NETPATH (0x35)</tt>.
<br />
If NetBIOS over TCP/IP is switched off then return code is <tt>ERROR_NETWORK_UNREACHABLE (0x4CF)</tt>.
<br />
<br />
Thus jump address will be calculated incorrectly and it will lead the sample to crash. Therefore, this technique can be used to break emulation in sandboxes where NetBIOS over TCP/IP is switched off for preventing junk traffic generation by the OS.
<br />
<br />
<i>Note: NetBIOS over TCP/IP is switched off not to generate additional network requests when resolving server IP via DNS. Switching this option off cancels 
lookup requests in local network.</i></p>

<hr class="space" />

<p><b>Code sample (function <tt>GetAdaptersAddresses</tt>)</b></p>
<p></p>

<figure class="highlight"><pre><code class="language-c" data-lang="c"><span class="kt">void</span> <span class="nf">EntryPoint</span><span class="p">(</span><span class="kt">void</span><span class="p">)</span>
<span class="p">{</span>
    <span class="n">HANDLE</span> <span class="n">NetApi32</span> <span class="o">=</span> <span class="n">LoadLibraryW</span><span class="p">(</span><span class="s">L"netapi32.dll"</span><span class="p">);</span>
    <span class="n">TD_NetValidateName</span> <span class="n">NetValidateName</span> <span class="o">=</span> <span class="p">(</span><span class="n">TD_NetValidateName</span><span class="p">)</span><span class="n">GetProcAddress</span><span class="p">(</span><span class="n">NetApi32</span><span class="p">,</span> <span class="s">"NetValidateName"</span><span class="p">);</span>
    <span class="n">DWORD</span> <span class="n">Result</span> <span class="o">=</span> <span class="n">NetValidateName</span><span class="p">(</span><span class="s">L"123"</span><span class="p">,</span> <span class="s">L""</span><span class="p">,</span> <span class="s">L""</span><span class="p">,</span> <span class="s">L""</span><span class="p">,</span> <span class="mi">1</span><span class="p">);</span>

    <span class="kr">__asm</span>
    <span class="p">{</span>
        <span class="n">call</span> <span class="n">dword</span> <span class="n">ptr</span> <span class="n">ds</span><span class="o">:</span><span class="p">[</span><span class="n">GetLastError</span><span class="p">]</span>
        <span class="n">add</span> <span class="n">eax</span><span class="p">,</span> <span class="n">offset</span> <span class="n">TrueEntryPoint</span>
        <span class="n">sub</span> <span class="n">eax</span><span class="p">,</span> <span class="mh">0xCB</span>  <span class="c1">// ERROR_ENVVAR_NOT_FOUND</span>
        <span class="n">call</span> <span class="n">eax</span>
    <span class="p">}</span>
<span class="p">}</span></code></pre></figure>

<p><br /></p>
<h3><a class="a-dummy" name="cuckoo-resultserver-connection-based-anti-emulation-technique">4. Cuckoo ResultServer connection based anti-emulation technique</a></h3>

<p>This technique can be used for detecting Cuckoo Sandbox virtual environment. Malware enumerates all established outgoing TCP connections and checks 
if there is a connection to a specific TCP port (2042) that is used by the Cuckoo ResultServer.</p>

<p><br /></p>
<h3><a class="a-dummy" name="signature-recommendations">Signature recommendations</a></h3>

<p><i>Signature recommendations are general for each technique: hook the function used and track if it is called. It’s pretty hard to tell why application wants to get adapter name, for example. It doesn’t necessarily mean applying evasion technique. So the best what can be done in this situation is intercepting target functions and tracking their calls.
</i></p>

<p><br /></p>
<h3><a class="a-dummy" name="countermeasures-sandboxie">Countermeasures</a></h3>

<ul>
<li><tt>versus checking network parameters:</tt> change them for virtual environment;</li> 
<li><tt>versus checking security perimeter:</tt> emulate network responses in an appropriate manner;</li> 
<li><tt>versus NetValidateName result based technique:</tt> turn on NetBIOS over TCP/IP;</li> 
<li><tt>versus Cuckoo ResultServer connection based technique:</tt> change ResultServer port in the Cuckoo configuration.</li> 
</ul>

<p><br /></p>
<h3><a class="a-dummy" name="credits">Credits</a></h3>

<p>Credits go to open-source project from where code samples were taken:</p>
<ul>
<li>pafish project on <a href="https://github.com/a0rtega/pafish">github</a></li>
<li>al-khaser project on <a href="https://github.com/LordNoteworthy/al-khaser">github</a></li>
</ul>

<p>Though Check Point tool InviZzzible has them all implemented, due to modular structure of the code it would require more space to show a code sample from this tool for the same purposes. That’s why we’ve decided to use other great open-source projects for examples throughout the encyclopedia.</p>


    <br>
    <div style="text-align: left">
        <a href="..">Go back</a>
    </div>
    <br>
    <div class="sharebuttons" style="text-align: center">
        <hr />
        <ul>
          <li>
            <p class="sharetitle"> Share this: </p>
          </li>
          <li class="reddit">
            <a href="http://www.reddit.com/submit?url=https://evasions.checkpoint.com/src/Evasions/techniques/network.html&title=Evasions:%20Network - Evasion Techniques" target="_blank">
                <svg xmlns="http://www.w3.org/2000/svg"
                aria-label="Reddit" role="img"
                viewBox="0 0 512 512"><rect
                width="512" height="512"
                rx="15%"
                fill="#f40"/><g fill="#fff"><ellipse cx="256" cy="307" rx="166" ry="117"/><circle cx="106" cy="256" r="42"/><circle cx="407" cy="256" r="42"/><circle cx="375" cy="114" r="32"/></g><g stroke-linecap="round" stroke-linejoin="round" fill="none"><path d="m256 196 23-101 73 15" stroke="#fff" stroke-width="16"/><path d="m191 359c33 25 97 26 130 0" stroke="#f40" stroke-width="13"/></g><g fill="#f40"><circle cx="191" cy="287" r="31"/><circle cx="321" cy="287" r="31"/></g></svg>
                
            </a>
          </li>
          <li class="hn">
            <a href="http://news.ycombinator.com/submitlink?u=https://evasions.checkpoint.com/src/Evasions/techniques/network.html&t=Evasions:%20Network - Evasion Techniques" target="_blank">
                <svg xmlns="http://www.w3.org/2000/svg"
                aria-label="Hacker News" role="img"
                viewBox="0 0 512 512"><rect
                width="512" height="512"
                rx="15%"
                fill="#f60"/><path fill="#fff" d="M124 91h51l81 162 81-164h51L276 293v136h-40V293z"/></svg>
            </a>
          </li>
          <li class="twitter">
            <a href="https://twitter.com/intent/tweet?via=_CPResearch_&url=https://evasions.checkpoint.com/src/Evasions/techniques/network.html&text=Evasions:%20Network - Evasion Techniques" target="_blank">
                <svg viewBox="0 0 1792 1792" xmlns="http://www.w3.org/2000/svg"><path d="M1684 408q-67 98-162 167 1 14 1 42 0 130-38 259.5t-115.5 248.5-184.5 210.5-258 146-323 54.5q-271 0-496-145 35 4 78 4 225 0 401-138-105-2-188-64.5t-114-159.5q33 5 61 5 43 0 85-11-112-23-185.5-111.5t-73.5-205.5v-4q68 38 146 41-66-44-105-115t-39-154q0-88 44-163 121 149 294.5 238.5t371.5 99.5q-8-38-8-74 0-134 94.5-228.5t228.5-94.5q140 0 236 102 109-21 205-78-37 115-142 178 93-10 186-50z"/></svg>
            </a>
          </li>
          <li class="linkedin">
            <a href=https://www.linkedin.com/shareArticle?mini=true&url=https://evasions.checkpoint.com/src/Evasions/techniques/network.html&title=Evasions:%20Network - Evasion Techniques&source=LinkedIn" target="_blank">
                <svg viewBox="0 0 1792 1792" xmlns="http://www.w3.org/2000/svg"><path d="M477 625v991h-330v-991h330zm21-306q1 73-50.5 122t-135.5 49h-2q-82 0-132-49t-50-122q0-74 51.5-122.5t134.5-48.5 133 48.5 51 122.5zm1166 729v568h-329v-530q0-105-40.5-164.5t-126.5-59.5q-63 0-105.5 34.5t-63.5 85.5q-11 30-11 81v553h-329q2-399 2-647t-1-296l-1-48h329v144h-2q20-32 41-56t56.5-52 87-43.5 114.5-15.5q171 0 275 113.5t104 332.5z"/></svg>
            </a>
          </li>
        </ul>
      </div>
      
</article>


</section>

<nav class="navbar navbar-default navbar-fixed-bottom">
  <div class="container footer-content">

    Made with <font class="a-pink"><i class ="fa fa-heart"></i></font> to serve the community by Check Point Research    |    <a class="a-pink" href="https://research.checkpoint.com">Research blog</a>    |    <a class="a-pink" href="https://research.checkpoint.com/about-us/">About Us</a>    |    <a class="a-pink" href="https://github.com/CheckPointSW"><i class="fa fa-github fa-lg"></i></a> <a class="a-pink" href="https://twitter.com/_CPResearch_"><i class="fa fa-twitter fa-lg"></i></a>
    
    <br>
    
    © 1994-2024 Check Point Software Technologies LTD | All rights reserved | Property of CheckPoint.com


  </div>
</nav>

  </body>

</html>
<!DOCTYPE html>
<html>

  <head>
  <meta charset="utf-8">
  <meta http-equiv="X-UA-Compatible" content="IE=edge">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-194688-3"></script>
  <script>
   window.dataLayer = window.dataLayer || [];
   function gtag(){dataLayer.push(arguments);}
   gtag('js', new Date());
   gtag('config', 'UA-194688-3');
  </script>
  <meta content="Evasion techniques" property="og:site_name">

  <meta content="Evasions: OS features" property="og:title">


  <meta name="twitter:title" content="Malware Evasion Encyclopedia" />
  <meta name="twitter:image" content="https://research.checkpoint.com/wp-content/uploads/2020/02/evasions.jpg" />


  <meta content="article" property="og:type">


  <meta content="Evasion techniques
" property="og:description">


  <meta content="https://evasions.checkpoint.com/src/Evasions/techniques/os-features.html" property="og:url">


  <meta content="2024-07-10T07:20:28+00:00" property="article:published_time">
  <meta content="https://evasions.checkpoint.com/about/" property="article:author">


  <meta property="og:image" content="">


  
  <meta content="evasions" property="article:section">
  


  
  <meta content="os-features" property="article:tag">
  

  <title>Evasions: OS features</title>
  <meta name="description" content="Contents">
<script src="https://ajax.googleapis.com/ajax/libs/jquery/2.2.2/jquery.min.js"></script>
<script src="https://maxcdn.bootstrapcdn.com/bootstrap/3.3.6/js/bootstrap.min.js" integrity="sha384-0mSbJDEHialfmuBBQP6A4Qrprq5OVfW37PRR3j5ELqxss1yVqOtnepnHVP9aJ7xS" crossorigin="anonymous"></script>
  <link rel="stylesheet" href="https://evasions.checkpoint.com/assets/css/main.css">
<script src="https://maxcdn.bootstrapcdn.com/bootstrap/3.3.6/js/bootstrap.min.js" integrity="sha384-0mSbJDEHialfmuBBQP6A4Qrprq5OVfW37PRR3j5ELqxss1yVqOtnepnHVP9aJ7xS" crossorigin="anonymous"></script>

  <link href='https://fonts.googleapis.com/css?family=PT+Sans' rel='stylesheet' type='text/css'>
  <link href='https://fonts.googleapis.com/css?family=Fira+Mono' rel='stylesheet' type='text/css'>
  <link href='https://fonts.googleapis.com/css?family=Lato:400,700' rel='stylesheet' type='text/css'>
  <link href='https://fonts.googleapis.com/css?family=Source+Code+Pro:400,200,300,500,600,700,900' rel='stylesheet' type='text/css'>
  <link href='https://fonts.googleapis.com/css?family=Gentium+Basic:400,700' rel='stylesheet' type='text/css'>
  <link href='https://fonts.googleapis.com/css?family=Alegreya:400,400italic,700' rel='stylesheet' type='text/css'>
  <link href='https://fonts.googleapis.com/css?family=Lora:400,400italic,700' rel='stylesheet' type='text/css'>
  <link href='https://fonts.googleapis.com/css?family=Fira+Sans:400,300,500,700' rel='stylesheet' type='text/css'>
  <script src="https://ajax.googleapis.com/ajax/libs/jquery/2.2.0/jquery.min.js"></script>
  <link href='https://fonts.googleapis.com/css?family=Open+Sans:400,700' rel='stylesheet' type='text/css'>
  <link href="https://maxcdn.bootstrapcdn.com/bootstrap/3.3.6/css/bootstrap.min.css" rel="stylesheet" integrity="sha384-1q8mTJOASx8j1Au+a5WDVnPi2lkFfwwEAa8hDDdjZlpLegxhjVME1fgjWPGmkzs7" crossorigin="anonymous">
  <link href="https://maxcdn.bootstrapcdn.com/font-awesome/4.6.1/css/font-awesome.min.css" rel="stylesheet" integrity="sha384-hQpvDQiCJaD2H465dQfA717v7lu5qHWtDbWNPvaTJ0ID5xnPUlVXnKzq7b8YUkbN" crossorigin="anonymous">
  <link rel="canonical" href="https://evasions.checkpoint.com/src/Evasions/techniques/os-features.html">
  <link rel="alternate" type="application/rss+xml" title="Evasion techniques" href="https://evasions.checkpoint.com/feed.xml">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/tinysort/2.3.6/tinysort.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/tinysort/2.3.6/tinysort.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/tinysort/2.3.6/tinysort.charorder.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/tinysort/2.3.6/tinysort.charorder.min.js"></script>
  <script type="text/javascript" async src="//platform.twitter.com/widgets.js"></script>




</head>


  <body>
<section>
<article class="post" itemscope itemtype="http://schema.org/BlogPosting">
  <div class="jumbotron">
    <div class="container">
      <h1 class="post-title-main" itemprop="name headline">Evasions: OS features</h1>
    </div>
</div>

  <div class="post-content container" itemprop="articleBody">
    <div style="text-align: left">
        <a href="..">Go back</a>
        <br>
        <br>
    </div>
    <h1>Contents</h1>

<p><a href="#os-features-detection-methods">OS features detection methods</a>
<br />
  <a href="#checking-debug-privileges">1. Checking debug privileges</a>
<br />
  <a href="#using-unbalanced-stack">2. Using unbalanced stack</a>
<br />
  <a href="#detect-wine">3. Detect Wine</a>
<br />
  <a href="#countermeasures">Countermeasures</a>
<br />
  <a href="#credits">Credits</a>
<br />
<br /></p>

<hr class="space" />

<h2><a class="a-dummy" name="os-features-detection-methods">OS features detection methods</a></h2>
<p>Evasions in this group use peculiarities of how OS work.</p>

<p><br /></p>
<h3><a class="a-dummy" name="checking-debug-privileges">1. Checking debug privileges</a></h3>
<p>If the malware is running under debugger or in a sandbox like Cuckoo its process token will have a debug privilege in the enabled state. It happens because this privilege is enabled in the parent process and inherited by the malware process.</p>

<hr class="space" />

<p>The malware tries to open crucial system processes like <tt>csrss.exe</tt>, <tt>smss.exe</tt>, <tt>lsass.exe</tt> with <tt>PROCESS_ALL_ACCESS</tt> access right and then tries to terminate them. This will fail in a normal case when the malware is executed from the explorer or command line because even an Administrator user can’t terminate those processes. But this will succeed if the process token has the debug privilege in the enabled state. Termination of crucial system process leads OS to crash into BSOD with an error <tt>0x000000F4</tt> so the emulation process will be aborted.</p>

<hr class="space" />

<p>Functions to get snapshot of running processes:</p>
<ul>
  <li><tt>CreateToolhelp32Snapshot</tt></li> 
  <li><tt>psapi.EnumProcesses (WinXP, Vista)</tt></li> 
  <li><tt>kernel32.EnumProcesses (Win7+)</tt></li> 
</ul>

<hr class="space" />

<p>Function used to open the process:</p>
<ul>
  <li><tt>OpenProcess(PROCESS_ALL_ACCESS, ..., pid)  // track for PIDs of 'csrss.exe', 'smss.exe', 'lsass.exe'</tt></li> 
</ul>

<hr class="space" />

<p><b>Code sample</b></p>
<p></p>

<figure class="highlight"><pre><code class="language-c" data-lang="c"><span class="cm">/*
If we're being debugged and the process has SeDebugPrivileges 
privileges then OpenProcess call will be successful.
This requires administrator privilege!
In Windows XP, Vista and 7, calling OpenProcess with 
PROCESS_ALL_ACCESS will fait even with SeDebugPrivilege enabled,
That's why I used PROCESS_QUERY_LIMITED_INFORMATION
*/</span>

<span class="n">DWORD</span> <span class="nf">GetCsrssProcessId</span><span class="p">()</span>
<span class="p">{</span>
  <span class="k">if</span> <span class="p">(</span><span class="n">API</span><span class="o">::</span><span class="n">IsAvailable</span><span class="p">(</span><span class="n">API_IDENTIFIER</span><span class="o">::</span><span class="n">API_CsrGetProcessId</span><span class="p">))</span>
  <span class="p">{</span>
    <span class="k">auto</span> <span class="n">CsrGetProcessId</span> <span class="o">=</span> <span class="n">static_cast</span><span class="o">&lt;</span><span class="n">pCsrGetId</span><span class="o">&gt;</span><span class="p">(</span><span class="n">API</span><span class="o">::</span><span class="n">GetAPI</span><span class="p">(</span><span class="n">API_IDENTIFIER</span><span class="o">::</span><span class="n">API_CsrGetProcessId</span><span class="p">));</span>

    <span class="k">return</span> <span class="n">CsrGetProcessId</span><span class="p">();</span>
  <span class="p">}</span>
  <span class="k">else</span>
    <span class="k">return</span> <span class="n">GetProcessIdFromName</span><span class="p">(</span><span class="n">_T</span><span class="p">(</span><span class="s">"csrss.exe"</span><span class="p">));</span>
<span class="p">}</span>


<span class="n">BOOL</span> <span class="nf">CanOpenCsrss</span><span class="p">()</span>
<span class="p">{</span>
   <span class="n">HANDLE</span> <span class="n">hCsrss</span> <span class="o">=</span> <span class="n">OpenProcess</span><span class="p">(</span><span class="n">PROCESS_QUERY_LIMITED_INFORMATION</span><span class="p">,</span> <span class="n">FALSE</span><span class="p">,</span> <span class="n">GetCsrssProcessId</span><span class="p">());</span>
   <span class="k">if</span> <span class="p">(</span><span class="n">hCsrss</span> <span class="o">!=</span> <span class="nb">NULL</span><span class="p">)</span>
  <span class="p">{</span>
    <span class="n">CloseHandle</span><span class="p">(</span><span class="n">hCsrss</span><span class="p">);</span>
    <span class="k">return</span> <span class="n">TRUE</span><span class="p">;</span>
  <span class="p">}</span>
  <span class="k">else</span>
    <span class="k">return</span> <span class="n">FALSE</span><span class="p">;</span>
<span class="p">}</span></code></pre></figure>

<p><i>Credits for this code sample: <a href="https://github.com/LordNoteworthy/al-khaser">al-khaser project</a></i></p>

<hr class="space" />

<p><b>Signature recommendations</b></p>
<p></p>
<p>If <tt>OpenProcess</tt> requests all the possible rights when opening one of the critical system processes — it’s a strong indicator of malware trying to apply this evasion technique.</p>

<p><br /></p>
<h3><a class="a-dummy" name="using-unbalanced-stack">2. Using unbalanced stack</a></h3>
<p>This technique was presented at Virus Bulletin 2016 by Check Point Malware Reverse Engineering Team. It is described <a href="https://www.virusbulletin.com/uploads/pdf/magazine/2016/VB2016-Chailytko-Skuratovich.pdf">by this link</a>.</p>

<hr class="space" />

<p>To track process behaviour, the CuckooMon/Cuckoo Monitor module hooks relevant functions. In this type of architecture, the hook is called before the original function. A hooked function may use some space on the stack in addition to that used by the original function. Therefore, the total space on the stack used by the hooked function may be larger than the space used only by the original function.</p>

<hr class="space" />

<p><b>Problem:</b> The malware has information about how much space the called function uses on the stack. It can therefore move the stack pointer towards lower addresses at an offset that is sufficient to store the function arguments, local variables and return address to reserve space for them. The malware fills the space below the stack pointer with some relevant data. It then moves the stack pointer to the original location and calls the library function. If the function is not hooked, the malware fills in the reserved space before the relevant data (see Figure 1). If the function is hooked, the malware overlaps relevant data, because the space that was reserved for the original function’s local variables is smaller than the space occupied by the hook and the original function’s local variables combined. The relevant data is therefore corrupted (see Figure 2). If it stores pointers to some functions that are used later during the execution process, the malware jumps to arbitrary code, occasionally crashing the application.</p>

<hr class="space" />

<div style="text-align: center; margin: auto">
  <img src="../assets/images/unbalanced_stack_unhook.png" height="300px" />
  <img src="../assets/images/unbalanced_stack_hook.png" height="300px" /><br />
  <i>Stack on non-hooked and on hooked function call.</i>
</div>

<hr class="space" />

<p><b>Solution:</b> To avoid this behaviour, the Cuckoo Monitor/CuckooMon module can use a two-stage hooking process. In the fi rst stage, instead of the hook’s code execution, it can move the stack pointer towards lower addresses of a specifi c size that will be enough for the malware’s relevant data. Then, the function’s arguments are copied under the new stack pointer. Only after these preparatory operations have been completed is the second stage hook (which performs the real hooking) called. Relevant data fi lled in by the malware resides on upper stack addresses, thus it is not affected in any way by the called function.</p>

<hr class="space" />

<p><b>Code sample</b></p>
<p></p>

<figure class="highlight"><pre><code class="language-c" data-lang="c"><span class="n">bool</span> <span class="n">Cuckoo</span><span class="o">::</span><span class="n">CheckUnbalancedStack</span><span class="p">()</span> <span class="k">const</span> <span class="p">{</span>
  <span class="n">usf_t</span> <span class="n">f</span> <span class="o">=</span> <span class="p">{</span>
    <span class="p">{</span> <span class="n">lib_name_t</span><span class="p">(</span><span class="s">L"ntdll"</span><span class="p">),</span> <span class="p">{</span> 
      <span class="p">{</span><span class="k">sizeof</span><span class="p">(</span><span class="kt">void</span> <span class="o">*</span><span class="p">),</span> <span class="nb">NULL</span><span class="p">,</span> <span class="s">"ZwDelayExecution"</span><span class="p">,</span> <span class="n">ARG_ITEM</span><span class="p">(</span><span class="n">kZwDelayExecutionArgs</span><span class="p">)</span> <span class="p">}</span>
    <span class="p">}</span> <span class="p">}</span>
  <span class="p">};</span>
  <span class="k">const</span> <span class="kt">uint8_t</span> <span class="n">canary</span><span class="p">[</span><span class="mi">8</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span> <span class="mh">0xDE</span><span class="p">,</span> <span class="mh">0xAD</span><span class="p">,</span> <span class="mh">0xBE</span><span class="p">,</span> <span class="mh">0xEF</span><span class="p">,</span> <span class="mh">0xDE</span><span class="p">,</span> <span class="mh">0xAD</span><span class="p">,</span> <span class="mh">0xBE</span><span class="p">,</span> <span class="mh">0xEF</span> <span class="p">};</span>

  <span class="kt">uint32_t</span> <span class="n">args_size</span><span class="p">;</span>
  <span class="k">const</span> <span class="kt">void</span> <span class="o">*</span><span class="n">args_buff</span><span class="p">;</span>
  <span class="kt">uint32_t</span> <span class="n">reserved_size</span><span class="p">;</span>
  <span class="kt">uint32_t</span> <span class="n">reserved_size_after_call</span><span class="p">;</span>
  <span class="kt">uint32_t</span> <span class="n">canary_size</span><span class="p">;</span>
  <span class="n">FARPROC</span> <span class="n">func</span><span class="p">;</span>
  <span class="n">bool</span> <span class="n">us_detected</span><span class="p">;</span>
  <span class="kt">void</span> <span class="o">*</span><span class="n">canary_addr</span> <span class="o">=</span> <span class="p">(</span><span class="kt">void</span> <span class="o">*</span><span class="p">)</span><span class="o">&amp;</span><span class="n">canary</span><span class="p">[</span><span class="mi">0</span><span class="p">];</span>
  
  <span class="n">static_assert</span><span class="p">((</span><span class="k">sizeof</span><span class="p">(</span><span class="n">canary</span><span class="p">)</span> <span class="o">%</span> <span class="k">sizeof</span><span class="p">(</span><span class="kt">void</span> <span class="o">*</span><span class="p">))</span> <span class="o">==</span> <span class="mi">0</span><span class="p">,</span> <span class="s">"Invalid canary alignement"</span><span class="p">);</span>
  
  <span class="k">for</span> <span class="p">(</span><span class="k">auto</span> <span class="n">it</span> <span class="o">=</span> <span class="n">f</span><span class="p">.</span><span class="n">begin</span><span class="p">(),</span> <span class="n">end</span> <span class="o">=</span> <span class="n">f</span><span class="p">.</span><span class="n">end</span><span class="p">();</span> <span class="n">it</span> <span class="o">!=</span> <span class="n">end</span><span class="p">;</span> <span class="o">++</span><span class="n">it</span><span class="p">)</span> <span class="p">{</span>
    <span class="k">for</span> <span class="p">(</span><span class="k">auto</span> <span class="o">&amp;</span><span class="n">vi</span> <span class="o">:</span> <span class="n">it</span><span class="o">-&gt;</span><span class="n">second</span><span class="p">)</span> <span class="p">{</span>
      <span class="n">vi</span><span class="p">.</span><span class="n">func_addr</span> <span class="o">=</span> <span class="n">GetProcAddress</span><span class="p">(</span><span class="n">GetModuleHandleW</span><span class="p">(</span><span class="n">it</span><span class="o">-&gt;</span><span class="n">first</span><span class="p">.</span><span class="n">c_str</span><span class="p">()),</span> <span class="n">vi</span><span class="p">.</span><span class="n">func_name</span><span class="p">.</span><span class="n">c_str</span><span class="p">());</span>

      <span class="c1">// call to Unbalanced Stack</span>
      <span class="n">args_size</span> <span class="o">=</span> <span class="n">vi</span><span class="p">.</span><span class="n">args_size</span><span class="p">;</span>
      <span class="n">args_buff</span> <span class="o">=</span> <span class="n">vi</span><span class="p">.</span><span class="n">args_buff</span><span class="p">;</span>
      <span class="n">canary_size</span> <span class="o">=</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">canary</span><span class="p">);</span>
      <span class="n">reserved_size</span> <span class="o">=</span> <span class="k">sizeof</span><span class="p">(</span><span class="kt">void</span> <span class="o">*</span><span class="p">)</span> <span class="o">+</span> <span class="n">vi</span><span class="p">.</span><span class="n">local_vars_size</span> <span class="o">+</span> <span class="n">canary_size</span><span class="p">;</span>
      <span class="n">reserved_size_after_call</span> <span class="o">=</span> <span class="n">reserved_size</span> <span class="o">+</span> <span class="n">args_size</span><span class="p">;</span>
      <span class="n">func</span> <span class="o">=</span> <span class="n">vi</span><span class="p">.</span><span class="n">func_addr</span><span class="p">;</span>
      <span class="n">us_detected</span> <span class="o">=</span> <span class="nb">false</span><span class="p">;</span>

      <span class="kr">__asm</span> <span class="p">{</span>
        <span class="n">pusha</span>
        <span class="n">mov</span> <span class="n">ecx</span><span class="p">,</span> <span class="n">args_size</span>
        <span class="n">sub</span> <span class="n">esp</span><span class="p">,</span> <span class="n">ecx</span>
        <span class="n">mov</span> <span class="n">esi</span><span class="p">,</span> <span class="n">args_buff</span>
        <span class="n">mov</span> <span class="n">edi</span><span class="p">,</span> <span class="n">esp</span>
        <span class="n">cld</span>
        <span class="n">rep</span> <span class="n">movsb</span>
        <span class="n">sub</span> <span class="n">esp</span><span class="p">,</span> <span class="n">reserved_size</span>
        <span class="n">mov</span> <span class="n">ecx</span><span class="p">,</span> <span class="n">canary_size</span>
        <span class="n">mov</span> <span class="n">esi</span><span class="p">,</span> <span class="n">canary_addr</span>
        <span class="n">mov</span> <span class="n">edi</span><span class="p">,</span> <span class="n">esp</span>
        <span class="n">rep</span> <span class="n">movsb</span>
        <span class="n">add</span> <span class="n">esp</span><span class="p">,</span> <span class="n">reserved_size</span>
        <span class="n">mov</span> <span class="n">eax</span><span class="p">,</span> <span class="n">func</span>
        <span class="n">call</span> <span class="n">eax</span>
        <span class="n">sub</span> <span class="n">esp</span><span class="p">,</span> <span class="n">reserved_size_after_call</span>
        <span class="n">mov</span> <span class="n">ecx</span><span class="p">,</span> <span class="n">canary_size</span>
        <span class="n">mov</span> <span class="n">esi</span><span class="p">,</span> <span class="n">canary_addr</span>
        <span class="n">mov</span> <span class="n">edi</span><span class="p">,</span> <span class="n">esp</span>
        <span class="n">repz</span> <span class="n">cmpsb</span>
        <span class="n">cmp</span> <span class="n">ecx</span><span class="p">,</span> <span class="mi">0</span>
        <span class="n">setnz</span> <span class="n">us_detected</span>
        <span class="n">add</span> <span class="n">esp</span><span class="p">,</span> <span class="n">reserved_size_after_call</span>
        <span class="n">popa</span>
      <span class="p">}</span>

      <span class="k">if</span> <span class="p">(</span><span class="n">us_detected</span><span class="p">)</span>
        <span class="k">return</span> <span class="nb">true</span><span class="p">;</span>
    <span class="p">}</span>
  <span class="p">}</span>

  <span class="k">return</span> <span class="nb">false</span><span class="p">;</span>  
<span class="p">}</span></code></pre></figure>

<hr class="space" />

<p><b>Signature recommendations</b></p>
<p></p>
<p>Signature recommendations are not provided as it’s pretty tricky to track such a behavior on malware side.</p>

<p><br /></p>

<h3><a class="a-dummy" name="detect-wine">3. Detect Wine</a></h3>

<hr class="space" />

<p>The <tt>MulDiv</tt> <a href="https://learn.microsoft.com/en-us/windows/win32/api/winbase/nf-winbase-muldiv">API</a> is being called with specific arguments (<tt><code class="language-plaintext highlighter-rouge">MulDiv(1, 0x80000000, 0x80000000)</code></tt>) which should logically return 1 - however, due to a bug with the ancient implementation on Windows, it returns 2.</p>

<p>There are more known evasion methods to detect Wine like the good old check of searching for the existence of one of Wine’s exclusive APIs such as <tt><code class="language-plaintext highlighter-rouge">kernel32.dll!wine_get_unix_file_name</code></tt> or <tt><code class="language-plaintext highlighter-rouge">ntdll.dll!wine_get_host_version</code></tt>) as also mentioned in <a href="https://evasions.checkpoint.com/src/Evasions/techniques/processes.html#check-if-specific-functions-are-present-in-specific-libraries ">Processes evasion techniques</a>.</p>

<p><b>Code sample</b></p>
<p></p>

<hr class="space" />

<figure class="highlight"><pre><code class="language-c" data-lang="c"><span class="kt">int</span> <span class="nf">Check_MulDiv_1</span><span class="p">()</span> <span class="p">{</span>
    <span class="c1">// Call MulDiv with specific arguments</span>
    <span class="kt">int</span> <span class="n">result</span> <span class="o">=</span> <span class="n">MulDiv</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="mh">0x80000000</span><span class="p">,</span> <span class="mh">0x80000000</span><span class="p">);</span>

    <span class="c1">// Check if the result matches the expected value</span>
    <span class="k">if</span> <span class="p">(</span><span class="n">result</span> <span class="o">!=</span> <span class="mi">2</span><span class="p">)</span> <span class="p">{</span>
        <span class="n">std</span><span class="o">::</span><span class="n">cout</span> <span class="o">&lt;&lt;</span> <span class="s">"MulDiv evasion method detected: Wine environment."</span> <span class="o">&lt;&lt;</span> <span class="n">std</span><span class="o">::</span><span class="n">endl</span><span class="p">;</span>
    <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
        <span class="n">std</span><span class="o">::</span><span class="n">cout</span> <span class="o">&lt;&lt;</span> <span class="s">"MulDiv evasion method not detected."</span> <span class="o">&lt;&lt;</span> <span class="n">std</span><span class="o">::</span><span class="n">endl</span><span class="p">;</span>
    <span class="p">}</span>
	
    <span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="kt">int</span> <span class="nf">Check_MulDiv_2</span><span class="p">()</span> <span class="p">{</span>
    <span class="c1">// Check for the existence of Wine's exclusive APIs</span>
    <span class="n">HMODULE</span> <span class="n">hKernel32</span> <span class="o">=</span> <span class="n">GetModuleHandle</span><span class="p">(</span><span class="s">"kernel32.dll"</span><span class="p">);</span>
    <span class="n">FARPROC</span> <span class="n">wineGetUnixFileName</span> <span class="o">=</span> <span class="n">GetProcAddress</span><span class="p">(</span><span class="n">hKernel32</span><span class="p">,</span> <span class="s">"wine_get_unix_file_name"</span><span class="p">);</span>
    <span class="n">HMODULE</span> <span class="n">hNtdll</span> <span class="o">=</span> <span class="n">GetModuleHandle</span><span class="p">(</span><span class="s">"ntdll.dll"</span><span class="p">);</span>
    <span class="n">FARPROC</span> <span class="n">wineGetHostVersion</span> <span class="o">=</span> <span class="n">GetProcAddress</span><span class="p">(</span><span class="n">hNtdll</span><span class="p">,</span> <span class="s">"wine_get_host_version"</span><span class="p">);</span>

    <span class="k">if</span> <span class="p">(</span><span class="n">wineGetUnixFileName</span> <span class="o">||</span> <span class="n">wineGetHostVersion</span><span class="p">)</span> <span class="p">{</span>
        <span class="n">std</span><span class="o">::</span><span class="n">cout</span> <span class="o">&lt;&lt;</span> <span class="s">"Wine's exclusive APIs detected: Wine environment."</span> <span class="o">&lt;&lt;</span> <span class="n">std</span><span class="o">::</span><span class="n">endl</span><span class="p">;</span>
    <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
        <span class="n">std</span><span class="o">::</span><span class="n">cout</span> <span class="o">&lt;&lt;</span> <span class="s">"Wine's exclusive APIs not detected."</span> <span class="o">&lt;&lt;</span> <span class="n">std</span><span class="o">::</span><span class="n">endl</span><span class="p">;</span>
    <span class="p">}</span>

    <span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span></code></pre></figure>

<hr class="space" />

<p><b>Signature recommendations</b></p>
<p></p>
<p>Check if <tt><code class="language-plaintext highlighter-rouge">MulDiv(1, 0x80000000, 0x80000000)</code></tt> is being called.</p>

<p><br /></p>
<h3><a class="a-dummy" name="countermeasures">Countermeasures</a></h3>

<ul>
<li><tt>versus checking debug privileges:</tt> hook <tt>OpenProcess</tt> and track for critical system processes PIDs — then return an error.</li> 
<li><tt>versus using unbalanced stack:</tt> 1) stack adjusting before function call; 2) kernel-mode hooking.</li> 
<li><tt>versus Detect Wine:</tt> If Using Wine, hook MulDiv to return 2 or modify the implementation as it works in Windows. </li> 
</ul>

<p><br /></p>
<h3><a class="a-dummy" name="credits">Credits</a></h3>

<p>Credits go to open-source project from where code samples were taken:</p>
<ul>
<li>al-khaser project on <a href="https://github.com/LordNoteworthy/al-khaser">github</a></li>
</ul>

<p>Though Check Point tool InviZzzible has them all implemented, due to modular structure of the code it would require more space to show a code sample from this tool for the same purposes. That’s why we’ve decided to use other great open-source projects for examples throughout the encyclopedia.</p>

    <br>
    <div style="text-align: left">
        <a href="..">Go back</a>
    </div>
    <br>
    <div class="sharebuttons" style="text-align: center">
        <hr />
        <ul>
          <li>
            <p class="sharetitle"> Share this: </p>
          </li>
          <li class="reddit">
            <a href="http://www.reddit.com/submit?url=https://evasions.checkpoint.com/src/Evasions/techniques/os-features.html&title=Evasions:%20OS%20features - Evasion Techniques" target="_blank">
                <svg xmlns="http://www.w3.org/2000/svg"
                aria-label="Reddit" role="img"
                viewBox="0 0 512 512"><rect
                width="512" height="512"
                rx="15%"
                fill="#f40"/><g fill="#fff"><ellipse cx="256" cy="307" rx="166" ry="117"/><circle cx="106" cy="256" r="42"/><circle cx="407" cy="256" r="42"/><circle cx="375" cy="114" r="32"/></g><g stroke-linecap="round" stroke-linejoin="round" fill="none"><path d="m256 196 23-101 73 15" stroke="#fff" stroke-width="16"/><path d="m191 359c33 25 97 26 130 0" stroke="#f40" stroke-width="13"/></g><g fill="#f40"><circle cx="191" cy="287" r="31"/><circle cx="321" cy="287" r="31"/></g></svg>
                
            </a>
          </li>
          <li class="hn">
            <a href="http://news.ycombinator.com/submitlink?u=https://evasions.checkpoint.com/src/Evasions/techniques/os-features.html&t=Evasions:%20OS%20features - Evasion Techniques" target="_blank">
                <svg xmlns="http://www.w3.org/2000/svg"
                aria-label="Hacker News" role="img"
                viewBox="0 0 512 512"><rect
                width="512" height="512"
                rx="15%"
                fill="#f60"/><path fill="#fff" d="M124 91h51l81 162 81-164h51L276 293v136h-40V293z"/></svg>
            </a>
          </li>
          <li class="twitter">
            <a href="https://twitter.com/intent/tweet?via=_CPResearch_&url=https://evasions.checkpoint.com/src/Evasions/techniques/os-features.html&text=Evasions:%20OS%20features - Evasion Techniques" target="_blank">
                <svg viewBox="0 0 1792 1792" xmlns="http://www.w3.org/2000/svg"><path d="M1684 408q-67 98-162 167 1 14 1 42 0 130-38 259.5t-115.5 248.5-184.5 210.5-258 146-323 54.5q-271 0-496-145 35 4 78 4 225 0 401-138-105-2-188-64.5t-114-159.5q33 5 61 5 43 0 85-11-112-23-185.5-111.5t-73.5-205.5v-4q68 38 146 41-66-44-105-115t-39-154q0-88 44-163 121 149 294.5 238.5t371.5 99.5q-8-38-8-74 0-134 94.5-228.5t228.5-94.5q140 0 236 102 109-21 205-78-37 115-142 178 93-10 186-50z"/></svg>
            </a>
          </li>
          <li class="linkedin">
            <a href=https://www.linkedin.com/shareArticle?mini=true&url=https://evasions.checkpoint.com/src/Evasions/techniques/os-features.html&title=Evasions:%20OS%20features - Evasion Techniques&source=LinkedIn" target="_blank">
                <svg viewBox="0 0 1792 1792" xmlns="http://www.w3.org/2000/svg"><path d="M477 625v991h-330v-991h330zm21-306q1 73-50.5 122t-135.5 49h-2q-82 0-132-49t-50-122q0-74 51.5-122.5t134.5-48.5 133 48.5 51 122.5zm1166 729v568h-329v-530q0-105-40.5-164.5t-126.5-59.5q-63 0-105.5 34.5t-63.5 85.5q-11 30-11 81v553h-329q2-399 2-647t-1-296l-1-48h329v144h-2q20-32 41-56t56.5-52 87-43.5 114.5-15.5q171 0 275 113.5t104 332.5z"/></svg>
            </a>
          </li>
        </ul>
      </div>
      
</article>


</section>

<nav class="navbar navbar-default navbar-fixed-bottom">
  <div class="container footer-content">

    Made with <font class="a-pink"><i class ="fa fa-heart"></i></font> to serve the community by Check Point Research    |    <a class="a-pink" href="https://research.checkpoint.com">Research blog</a>    |    <a class="a-pink" href="https://research.checkpoint.com/about-us/">About Us</a>    |    <a class="a-pink" href="https://github.com/CheckPointSW"><i class="fa fa-github fa-lg"></i></a> <a class="a-pink" href="https://twitter.com/_CPResearch_"><i class="fa fa-twitter fa-lg"></i></a>
    
    <br>
    
    © 1994-2024 Check Point Software Technologies LTD | All rights reserved | Property of CheckPoint.com


  </div>
</nav>

  </body>

</html>
<!DOCTYPE html>
<html>

  <head>
  <meta charset="utf-8">
  <meta http-equiv="X-UA-Compatible" content="IE=edge">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-194688-3"></script>
  <script>
   window.dataLayer = window.dataLayer || [];
   function gtag(){dataLayer.push(arguments);}
   gtag('js', new Date());
   gtag('config', 'UA-194688-3');
  </script>
  <meta content="Evasion techniques" property="og:site_name">

  <meta content="Evasions: Processes" property="og:title">


  <meta name="twitter:title" content="Malware Evasion Encyclopedia" />
  <meta name="twitter:image" content="https://research.checkpoint.com/wp-content/uploads/2020/02/evasions.jpg" />


  <meta content="article" property="og:type">


  <meta content="Evasion techniques
" property="og:description">


  <meta content="https://evasions.checkpoint.com/src/Evasions/techniques/processes.html" property="og:url">


  <meta content="2024-07-10T07:20:28+00:00" property="article:published_time">
  <meta content="https://evasions.checkpoint.com/about/" property="article:author">


  <meta property="og:image" content="">


  
  <meta content="evasions" property="article:section">
  


  
  <meta content="processes" property="article:tag">
  

  <title>Evasions: Processes</title>
  <meta name="description" content="Contents">
<script src="https://ajax.googleapis.com/ajax/libs/jquery/2.2.2/jquery.min.js"></script>
<script src="https://maxcdn.bootstrapcdn.com/bootstrap/3.3.6/js/bootstrap.min.js" integrity="sha384-0mSbJDEHialfmuBBQP6A4Qrprq5OVfW37PRR3j5ELqxss1yVqOtnepnHVP9aJ7xS" crossorigin="anonymous"></script>
  <link rel="stylesheet" href="https://evasions.checkpoint.com/assets/css/main.css">
<script src="https://maxcdn.bootstrapcdn.com/bootstrap/3.3.6/js/bootstrap.min.js" integrity="sha384-0mSbJDEHialfmuBBQP6A4Qrprq5OVfW37PRR3j5ELqxss1yVqOtnepnHVP9aJ7xS" crossorigin="anonymous"></script>

  <link href='https://fonts.googleapis.com/css?family=PT+Sans' rel='stylesheet' type='text/css'>
  <link href='https://fonts.googleapis.com/css?family=Fira+Mono' rel='stylesheet' type='text/css'>
  <link href='https://fonts.googleapis.com/css?family=Lato:400,700' rel='stylesheet' type='text/css'>
  <link href='https://fonts.googleapis.com/css?family=Source+Code+Pro:400,200,300,500,600,700,900' rel='stylesheet' type='text/css'>
  <link href='https://fonts.googleapis.com/css?family=Gentium+Basic:400,700' rel='stylesheet' type='text/css'>
  <link href='https://fonts.googleapis.com/css?family=Alegreya:400,400italic,700' rel='stylesheet' type='text/css'>
  <link href='https://fonts.googleapis.com/css?family=Lora:400,400italic,700' rel='stylesheet' type='text/css'>
  <link href='https://fonts.googleapis.com/css?family=Fira+Sans:400,300,500,700' rel='stylesheet' type='text/css'>
  <script src="https://ajax.googleapis.com/ajax/libs/jquery/2.2.0/jquery.min.js"></script>
  <link href='https://fonts.googleapis.com/css?family=Open+Sans:400,700' rel='stylesheet' type='text/css'>
  <link href="https://maxcdn.bootstrapcdn.com/bootstrap/3.3.6/css/bootstrap.min.css" rel="stylesheet" integrity="sha384-1q8mTJOASx8j1Au+a5WDVnPi2lkFfwwEAa8hDDdjZlpLegxhjVME1fgjWPGmkzs7" crossorigin="anonymous">
  <link href="https://maxcdn.bootstrapcdn.com/font-awesome/4.6.1/css/font-awesome.min.css" rel="stylesheet" integrity="sha384-hQpvDQiCJaD2H465dQfA717v7lu5qHWtDbWNPvaTJ0ID5xnPUlVXnKzq7b8YUkbN" crossorigin="anonymous">
  <link rel="canonical" href="https://evasions.checkpoint.com/src/Evasions/techniques/processes.html">
  <link rel="alternate" type="application/rss+xml" title="Evasion techniques" href="https://evasions.checkpoint.com/feed.xml">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/tinysort/2.3.6/tinysort.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/tinysort/2.3.6/tinysort.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/tinysort/2.3.6/tinysort.charorder.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/tinysort/2.3.6/tinysort.charorder.min.js"></script>
  <script type="text/javascript" async src="//platform.twitter.com/widgets.js"></script>




</head>


  <body>
<section>
<article class="post" itemscope itemtype="http://schema.org/BlogPosting">
  <div class="jumbotron">
    <div class="container">
      <h1 class="post-title-main" itemprop="name headline">Evasions: Processes</h1>
    </div>
</div>

  <div class="post-content container" itemprop="articleBody">
    <div style="text-align: left">
        <a href="..">Go back</a>
        <br>
        <br>
    </div>
    <h1>Contents</h1>

<p><a href="#process-detection-methods">Processes and libraries detection methods</a>
<br />
  <a href="#check-specific-running-processes-and-loaded-libraries">1. Check specific running processes and loaded libraries</a>
<br />
  <a href="#check-if-specific-processes-are-running">1.1. Check if specific processes are running</a>
<br />
  <a href="#check-if-specific-libraries-are-loaded">1.2. Check if specific libraries are loaded in the process address space</a>
<br />
  <a href="#check-if-specific-functions-are-present-in-specific-libraries">1.3. Check if specific functions are present in specific libraries</a>
<br />
  <a href="#check-if-certain-libraries-can-be-loaded-and-others-not">1.4. Check if certain libraries can be loaded and others not</a>
<br />
  <a href="#countermeasures">1.5. Countermeasures</a>
<br />
  <a href="#check-if-specific-artifacts-are-present-in-process">2. Check if specific artifacts are present in process address space (Sandboxie only)</a>
<br />
  <a href="#countermeasures-sandboxie">2.1. Countermeasures</a>
<br />
  <a href="#credits">Credits</a>
<br />
<br /></p>

<h2><a class="a-dummy" name="process-detection-methods">Processes and libraries detection methods</a></h2>
<p>Virtual environment launches some specific helper processes which are not being executed in usual host OS. There are also some specific modules which are loaded into processes address spaces.</p>

<p><br /></p>
<h3><a class="a-dummy" name="check-specific-running-processes-and-loaded-libraries">1. Check specific running processes and loaded libraries</a></h3>

<p><br /></p>
<h4><a class="a-dummy" name="check-if-specific-processes-are-running">1.1. Check if specific processes are running</a></h4>

<p>Functions used:</p>
<ul>
  <li><tt>CreateToolhelp32Snapshot</tt></li> 
  <li><tt>psapi.EnumProcesses <i>(WinXP, Vista)</i></tt></li> 
  <li><tt>kernel32.EnumProcesses <i>(Win7+)</i></tt></li> 
</ul>

<hr class="space" />

<p><b>Code sample</b></p>
<p></p>

<figure class="highlight"><pre><code class="language-c" data-lang="c"><span class="n">check_process_is_running</span><span class="p">(</span><span class="s">"vmtoolsd.exe"</span><span class="p">);</span>  <span class="c1">// sample value from the table</span>

<span class="n">bool</span> <span class="nf">check_process_is_running</span><span class="p">(</span><span class="k">const</span> <span class="n">std</span><span class="o">::</span><span class="n">string</span> <span class="o">&amp;</span><span class="n">proc_name</span><span class="p">)</span> <span class="p">{</span>
    <span class="n">HANDLE</span> <span class="n">hSnapshot</span><span class="p">;</span>
    <span class="n">PROCESSENTRY32</span> <span class="n">pe</span> <span class="o">=</span> <span class="p">{};</span>

    <span class="n">pe</span><span class="p">.</span><span class="n">dwSize</span> <span class="o">=</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">pe</span><span class="p">);</span>
    <span class="n">bool</span> <span class="n">present</span> <span class="o">=</span> <span class="nb">false</span><span class="p">;</span>
    <span class="n">hSnapshot</span> <span class="o">=</span> <span class="n">CreateToolhelp32Snapshot</span><span class="p">(</span><span class="n">TH32CS_SNAPPROCESS</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>

    <span class="k">if</span> <span class="p">(</span><span class="n">hSnapshot</span> <span class="o">==</span> <span class="n">INVALID_HANDLE_VALUE</span><span class="p">)</span>
        <span class="k">return</span> <span class="nb">false</span><span class="p">;</span>

    <span class="k">if</span> <span class="p">(</span><span class="n">Process32First</span><span class="p">(</span><span class="n">hSnapshot</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">pe</span><span class="p">))</span> <span class="p">{</span>
        <span class="k">do</span> <span class="p">{</span>
            <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">StrCmpI</span><span class="p">(</span><span class="n">pe</span><span class="p">.</span><span class="n">szExeFile</span><span class="p">,</span> <span class="n">proc_name</span><span class="p">.</span><span class="n">c_str</span><span class="p">()))</span> <span class="p">{</span>
                <span class="n">present</span> <span class="o">=</span> <span class="nb">true</span><span class="p">;</span>
                <span class="k">break</span><span class="p">;</span>
            <span class="p">}</span>
        <span class="p">}</span> <span class="k">while</span> <span class="p">(</span><span class="n">Process32Next</span><span class="p">(</span><span class="n">hSnapshot</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">pe</span><span class="p">));</span>
    <span class="p">}</span>
    <span class="n">CloseHandle</span><span class="p">(</span><span class="n">hSnapshot</span><span class="p">);</span>

    <span class="k">return</span> <span class="n">present</span><span class="p">;</span>
<span class="p">}</span></code></pre></figure>

<hr class="space" />

<p><b>Signature recommendations</b></p>
<p></p>
<p><i>Signature recommendations are not provided as it’s hard to say what exactly is queried in the processes’ snapshot.</i></p>

<hr class="space" />

<p><b>Detections table</b></p>

<table style="width:60%">
  <tr>
    <td colspan="2">Check if the following processes are running:</td>
  </tr>
  <tr>
    <th style="text-align:center">Detect</th>
    <th style="text-align:center">Process</th>
  </tr>
  <tr>
    <th rowspan="2">JoeBox</th>
    <td>joeboxserver.exe</td>
  </tr>
  <tr>
    <td>joeboxcontrol.exe</td>
  </tr>
  <tr>
    <th rowspan="2">Parallels</th>
    <td>prl_cc.exe</td>
  </tr>
  <tr>
    <td>prl_tools.exe</td>
  </tr>
  <tr>
    <th rowspan="2">VirtualBox</th>
    <td>vboxservice.exe</td>
  </tr>
  <tr>
    <td>vboxtray.exe</td>
  </tr>
  <tr>
    <th rowspan="2">VirtualPC</th>
    <td>vmsrvc.exe</td>
  </tr>
  <tr>
    <td>vmusrvc.exe</td>
  </tr>
  <tr>
    <th rowspan="7">VMware</th>
    <td>vmtoolsd.exe</td>
  </tr>
  <tr>
    <td>vmacthlp.exe</td>
  </tr>
  <tr>
    <td>vmwaretray.exe</td>
  </tr>
  <tr>
    <td>vmwareuser.exe</td>
  </tr>
  <tr>
    <td>vmware.exe</td>
  </tr>
  <tr>
    <td>vmount2.exe</td>
  </tr>
  <tr>
    <td>vmwareservice.exe</td>
  </tr>
  <tr>
    <th rowspan="2">Xen</th>
    <td>xenservice.exe</td>
  </tr>
  <tr>
    <td>xsvc_depriv.exe</td>
  </tr>
  <tr>
    <th>QEMU</th>
    <td>qemu-ga.exe</td>
  </tr>
  <tr>
    <th>WPE Pro</th>
    <td>WPE Pro.exe</td>
  </tr>
  <tr>
    <th>KsDumper</th>
    <td>ksdumperclient.exe</td>
  </tr>
</table>

<p><br />
<i>Notes:</i></p>
<ul>
  <li><tt><i>WPE Pro is a sniffer, not a VM or a sandbox, however it is used along with VM detects.</i></tt></li>
  <li><tt><i>KsDumper is a kernel-mode process dumper, not a VM or a sandbox, however it is used along with VM detects in Styx Stealer.</i></tt></li>
</ul>

<p><br /></p>
<h4><a class="a-dummy" name="check-if-specific-libraries-are-loaded">1.2. Check if specific libraries are loaded in the process address space</a></h4>

<p>Functions used:</p>
<ul>
  <li><tt>GetModuleHandle</tt></li> 
</ul>

<hr class="space" />

<p><b>Code sample</b></p>
<p></p>

<figure class="highlight"><pre><code class="language-c" data-lang="c"><span class="n">VOID</span> <span class="nf">loaded_dlls</span><span class="p">()</span>
<span class="p">{</span>
    <span class="cm">/* Some vars */</span>
    <span class="n">HMODULE</span> <span class="n">hDll</span><span class="p">;</span>

    <span class="cm">/* Array of strings of blacklisted dlls */</span>
    <span class="n">TCHAR</span><span class="o">*</span> <span class="n">szDlls</span><span class="p">[]</span> <span class="o">=</span> <span class="p">{</span>
        <span class="n">_T</span><span class="p">(</span><span class="s">"sbiedll.dll"</span><span class="p">),</span>
        <span class="n">_T</span><span class="p">(</span><span class="s">"dbghelp.dll"</span><span class="p">),</span>
        <span class="n">_T</span><span class="p">(</span><span class="s">"api_log.dll"</span><span class="p">),</span>
        <span class="n">_T</span><span class="p">(</span><span class="s">"dir_watch.dll"</span><span class="p">),</span>
        <span class="n">_T</span><span class="p">(</span><span class="s">"pstorec.dll"</span><span class="p">),</span>
        <span class="n">_T</span><span class="p">(</span><span class="s">"vmcheck.dll"</span><span class="p">),</span>
        <span class="n">_T</span><span class="p">(</span><span class="s">"wpespy.dll"</span><span class="p">),</span>
    <span class="p">};</span>

    <span class="n">WORD</span> <span class="n">dwlength</span> <span class="o">=</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">szDlls</span><span class="p">)</span> <span class="o">/</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">szDlls</span><span class="p">[</span><span class="mi">0</span><span class="p">]);</span>
    <span class="k">for</span> <span class="p">(</span><span class="kt">int</span> <span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">dwlength</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span>
    <span class="p">{</span>
        <span class="n">TCHAR</span> <span class="n">msg</span><span class="p">[</span><span class="mi">256</span><span class="p">]</span> <span class="o">=</span> <span class="n">_T</span><span class="p">(</span><span class="s">""</span><span class="p">);</span>
        <span class="n">_stprintf_s</span><span class="p">(</span><span class="n">msg</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">msg</span><span class="p">)</span> <span class="o">/</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">TCHAR</span><span class="p">),</span> <span class="n">_T</span><span class="p">(</span><span class="s">"Checking if process loaded modules contains: %s "</span><span class="p">),</span> 
                    <span class="n">szDlls</span><span class="p">[</span><span class="n">i</span><span class="p">]);</span>

        <span class="cm">/* Check if process loaded modules contains the blacklisted dll */</span>
        <span class="n">hDll</span> <span class="o">=</span> <span class="n">GetModuleHandle</span><span class="p">(</span><span class="n">szDlls</span><span class="p">[</span><span class="n">i</span><span class="p">]);</span>
        <span class="k">if</span> <span class="p">(</span><span class="n">hDll</span> <span class="o">==</span> <span class="nb">NULL</span><span class="p">)</span>
            <span class="n">print_results</span><span class="p">(</span><span class="n">FALSE</span><span class="p">,</span> <span class="n">msg</span><span class="p">);</span>
        <span class="k">else</span>
            <span class="n">print_results</span><span class="p">(</span><span class="n">TRUE</span><span class="p">,</span> <span class="n">msg</span><span class="p">);</span>
    <span class="p">}</span>
<span class="p">}</span></code></pre></figure>

<p><i>Credits for this code sample: <a href="https://github.com/LordNoteworthy/al-khaser">al-khaser project</a></i></p>

<hr class="space" />

<p><b>Signature recommendations</b></p>
<p></p>
<p>If the following function contains its only argument from the table column <font face="Courier New">`Library`</font>:</p>
<p></p>
<ul>
<li><tt>GetModuleHandle(module_name)</tt></li> 
</ul>
<p>then it’s an indication of application trying to use this evasion technique.</p>

<hr class="space" />

<p><b>Detections table</b></p>

<table style="width:60%">
  <tr>
    <td colspan="2">Check if the following libraries are loaded in the process address space:</td>
  </tr>
  <tr>
    <th style="text-align:center">Detect</th>
    <th style="text-align:center">Library</th>
  </tr>
  <tr>
    <th rowspan="3">CWSandbox</th>
    <td>api_log.dll</td>
  </tr>
  <tr>
    <td>dir_watch.dll</td>
  </tr>
  <tr>
    <td>pstorec.dll</td>
  </tr>
  <tr>
    <th>Sandboxie</th>
    <td>sbiedll.dll</td>
  </tr>
  <tr>
    <th>ThreatExpert</th>
    <td>dbghelp.dll</td>
  </tr>
  <tr>
    <th>VirtualPC</th>
    <td>vmcheck.dll</td>
  </tr>
  <tr>
    <th>WPE Pro</th>
    <td>wpespy.dll</td>
  </tr>
</table>

<p><br />
<i>Note: WPE Pro is a sniffer, not VM, however it is used along with VM detects.</i></p>

<p><br /></p>
<h4><a class="a-dummy" name="check-if-specific-functions-are-present-in-specific-libraries">1.3. Check if specific functions are present in specific libraries</a></h4>

<p>Functions used (see note about native functions):</p>
<ul>
  <li><tt>kernel32.GetProcAddress</tt></li> 
  <li><tt>kernel32.LdrGetProcedureAddress <i>(called internally)</i></tt></li> 
  <li><tt>ntdll.LdrGetProcedureAddress</tt></li> 
  <li><tt>ntdll.LdrpGetProcedureAddress <i>(called internally)</i></tt></li> 
</ul>

<hr class="space" />

<p><b>Code sample</b></p>
<p></p>

<figure class="highlight"><pre><code class="language-c" data-lang="c"><span class="n">BOOL</span> <span class="nf">wine_exports</span><span class="p">()</span>
<span class="p">{</span>
    <span class="cm">/* Some vars */</span>
    <span class="n">HMODULE</span> <span class="n">hKernel32</span><span class="p">;</span>

    <span class="cm">/* Get kernel32 module handle */</span>
    <span class="n">hKernel32</span> <span class="o">=</span> <span class="n">GetModuleHandle</span><span class="p">(</span><span class="n">_T</span><span class="p">(</span><span class="s">"kernel32.dll"</span><span class="p">));</span>
    <span class="k">if</span> <span class="p">(</span><span class="n">hKernel32</span> <span class="o">==</span> <span class="nb">NULL</span><span class="p">)</span> <span class="p">{</span>
        <span class="n">print_last_error</span><span class="p">(</span><span class="n">_T</span><span class="p">(</span><span class="s">"GetModuleHandle"</span><span class="p">));</span>
        <span class="k">return</span> <span class="n">FALSE</span><span class="p">;</span>
    <span class="p">}</span>

    <span class="cm">/* Check if wine_get_unix_file_name is exported by this dll */</span>
    <span class="k">if</span> <span class="p">(</span><span class="n">GetProcAddress</span><span class="p">(</span><span class="n">hKernel32</span><span class="p">,</span> <span class="s">"wine_get_unix_file_name"</span><span class="p">)</span> <span class="o">==</span> <span class="nb">NULL</span><span class="p">)</span>  <span class="c1">// sample value from the table</span>
        <span class="k">return</span> <span class="n">FALSE</span><span class="p">;</span>
    <span class="k">else</span>
        <span class="k">return</span> <span class="n">TRUE</span><span class="p">;</span>
<span class="p">}</span></code></pre></figure>

<p><i>Credits for this code sample: <a href="https://github.com/LordNoteworthy/al-khaser">al-khaser project</a></i></p>

<hr class="space" />

<p><b>Signature recommendations</b></p>
<p></p>
<p>If the following functions contain 2nd argument from the table column “Function” and the 1st argument is the 
address of matching “Library” name from the table:</p>
<p></p>
<ul>
<li><tt>kernel32.GetProcAddress(lib_handle, func_name)</tt></li> 
<li><tt>kernel32.LdrGetProcedureAddress(lib_handle, func_name)</tt></li> 
<li><tt>ntdll.LdrGetProcedureAddress(lib_handle, func_name)</tt></li> 
<li><tt>ntdll.LdrpGetProcedureAddress(lib_handle, func_name)</tt></li> 
</ul>
<p>then it’s an indication of application trying to use this evasion technique.</p>

<hr class="space" />

<p><b>Detections table</b></p>

<table style="width:60%">
  <tr>
    <td colspan="3">Check if the following functions are present in the following libraries:</td>
  </tr>
  <tr>
    <th style="text-align:center">Detect</th>
    <th style="text-align:center">Library</th>
    <th style="text-align:center">Function</th>
  </tr>
  <tr>
    <th rowspan="3">Wine</th>
    <td>kernel32.dll</td>
    <td>wine_get_unix_file_name</td>
  </tr>
  <tr>
    <td rowspan="2">ntdll.dll</td>
    <td>wine_get_version</td>
  </tr>
  <tr>
    <td>wine_get_host_version</td>
  </tr>
</table>

<p><br /></p>
<h4><a class="a-dummy" name="check-if-certain-libraries-can-be-loaded-and-others-not">1.4. Check if certain libraries can be loaded and others</a></h4>

<p>Function used:</p>
<ul>
  <li><tt>LoadLibraryA/W</tt></li> 
</ul>

<hr class="space" />

<p>This technique relies on the assumption that there are some common system libraries in the usual system that can be loaded – and there are also some fake ones, that should not be really present in a usual system. However, in a sandbox, when trying to load some fake libraries, they may be reported as loaded - which is different from how it should be on a usual host.</p>

<p>In other words, if a system library that is usually present (but not so widely used) in non-emulated machines is not loaded, then the application is likely in a sandbox. And if a fake DLL is reported to be loaded, then it is likely a sandbox, as such DLL will not be loaded in a usual machine.</p>

<p><b>Code sample</b></p>
<p></p>

<figure class="highlight"><pre><code class="language-c" data-lang="c"><span class="n">bool</span> <span class="n">Generic</span><span class="o">::</span><span class="n">CheckLoadedDLLs</span><span class="p">()</span> <span class="k">const</span> <span class="p">{</span>
    <span class="n">std</span><span class="o">::</span><span class="n">vector</span><span class="o">&lt;</span><span class="n">std</span><span class="o">::</span><span class="n">string</span><span class="o">&gt;</span> <span class="n">real_dlls</span> <span class="o">=</span> <span class="p">{</span>
        <span class="s">"kernel32.dll"</span><span class="p">,</span>
        <span class="s">"networkexplorer.dll"</span><span class="p">,</span>
        <span class="s">"NlsData0000.dll"</span>
    <span class="p">};</span>
    <span class="n">std</span><span class="o">::</span><span class="n">vector</span><span class="o">&lt;</span><span class="n">std</span><span class="o">::</span><span class="n">string</span><span class="o">&gt;</span> <span class="n">false_dlls</span> <span class="o">=</span> <span class="p">{</span>
        <span class="s">"NetProjW.dll"</span><span class="p">,</span>
        <span class="s">"Ghofr.dll"</span><span class="p">,</span>
        <span class="s">"fg122.dll"</span>
    <span class="p">};</span>
    <span class="n">HMODULE</span> <span class="n">lib_inst</span><span class="p">;</span>

    <span class="k">for</span> <span class="p">(</span><span class="k">auto</span> <span class="o">&amp;</span><span class="n">dll</span> <span class="o">:</span> <span class="n">real_dlls</span><span class="p">)</span> <span class="p">{</span>
        <span class="n">lib_inst</span> <span class="o">=</span> <span class="n">LoadLibraryA</span><span class="p">(</span><span class="n">dll</span><span class="p">.</span><span class="n">c_str</span><span class="p">());</span>
        <span class="k">if</span> <span class="p">(</span><span class="n">lib_inst</span> <span class="o">==</span> <span class="n">nullptr</span><span class="p">)</span> <span class="p">{</span>
            <span class="k">return</span> <span class="nb">true</span><span class="p">;</span>
        <span class="p">}</span>
        <span class="n">FreeLibrary</span><span class="p">(</span><span class="n">lib_inst</span><span class="p">);</span>
    <span class="p">}</span>

    <span class="k">for</span> <span class="p">(</span><span class="k">auto</span> <span class="o">&amp;</span><span class="n">dll</span> <span class="o">:</span> <span class="n">false_dlls</span><span class="p">)</span> <span class="p">{</span>
        <span class="n">lib_inst</span> <span class="o">=</span> <span class="n">LoadLibraryA</span><span class="p">(</span><span class="n">dll</span><span class="p">.</span><span class="n">c_str</span><span class="p">());</span>
        <span class="k">if</span> <span class="p">(</span><span class="n">lib_inst</span> <span class="o">!=</span> <span class="n">nullptr</span><span class="p">)</span> <span class="p">{</span>
            <span class="k">return</span> <span class="nb">true</span><span class="p">;</span>
        <span class="p">}</span>
    <span class="p">}</span>

    <span class="k">return</span> <span class="nb">false</span><span class="p">;</span>
<span class="p">}</span></code></pre></figure>

<hr class="space" />

<p><b>Signature recommendations</b></p>
<p></p>
<p><i>Signature recommendations are not provided as it’s hard to say that evasion tehnique is being applied when libraries are just loaded.</i></p>

<hr class="space" />

<p><br /></p>
<h4><a class="a-dummy" name="countermeasures">1.5. Countermeasures</a></h4>

<ul>
<li><tt>for processes:</tt> exclude target processes from enumeration or terminate them;</li> 
<li><tt>for libraries:</tt> exclude them from <a href="http://www.codereversing.com/blog/archives/265">enumeration lists in PEB</a>;</li> 
<li><tt>for functions in libraries:</tt> hook appropriate functions and compare their arguments against target ones;</li>
<li><tt>for libraries that must and must not be loaded:</tt> store a list of exclusions for libraries that should not be reported as loaded.</li> 
</ul>

<hr class="space" />

<p><br /></p>
<h3><a class="a-dummy" name="check-if-specific-artifacts-are-present-in-process">2. Check if specific artifacts are present in process address space (Sandboxie only)</a></h3>

<p>Functions used:</p>
<ul>
  <li><tt>NtQueryVirtualMemory</tt></li> 
</ul>

<hr class="space" />

<p><b>Code sample</b></p>
<p></p>

<figure class="highlight"><pre><code class="language-c" data-lang="c"><span class="n">BOOL</span> <span class="nf">AmISandboxied</span><span class="p">(</span><span class="n">LPVOID</span> <span class="n">lpMinimumApplicationAddress</span><span class="p">,</span> <span class="n">LPVOID</span> <span class="n">lpMaximumApplicationAddress</span><span class="p">)</span>
<span class="p">{</span>
  <span class="n">BOOL</span> <span class="n">IsSB</span> <span class="o">=</span> <span class="n">FALSE</span><span class="p">;</span>
  <span class="n">MEMORY_BASIC_INFORMATION</span> <span class="n">RegionInfo</span><span class="p">;</span>
  <span class="n">ULONG_PTR</span> <span class="n">i</span><span class="p">,</span> <span class="n">k</span><span class="p">;</span>
  <span class="n">SIZE_T</span> <span class="n">Length</span> <span class="o">=</span> <span class="mi">0L</span><span class="p">;</span>

  <span class="n">i</span> <span class="o">=</span> <span class="p">(</span><span class="n">ULONG_PTR</span><span class="p">)</span><span class="n">lpMinimumApplicationAddress</span><span class="p">;</span>
  <span class="k">do</span> <span class="p">{</span>

    <span class="n">NTSTATUS</span> <span class="n">Status</span> <span class="o">=</span> <span class="n">NtQueryVirtualMemory</span><span class="p">(</span><span class="n">GetCurrentProcess</span><span class="p">(),</span> 
                                           <span class="p">(</span><span class="n">PVOID</span><span class="p">)</span><span class="n">i</span><span class="p">,</span> 
                                           <span class="n">MemoryBasicInformation</span><span class="p">,</span>
                                           <span class="o">&amp;</span><span class="n">RegionInfo</span><span class="p">,</span> 
                                           <span class="k">sizeof</span><span class="p">(</span><span class="n">MEMORY_BASIC_INFORMATION</span><span class="p">),</span> 
                                           <span class="o">&amp;</span><span class="n">Length</span><span class="p">);</span>
    <span class="k">if</span> <span class="p">(</span><span class="n">NT_SUCCESS</span><span class="p">(</span><span class="n">Status</span><span class="p">))</span> <span class="p">{</span>

      <span class="c1">// Check if executable code</span>
      <span class="k">if</span> <span class="p">(((</span><span class="n">RegionInfo</span><span class="p">.</span><span class="n">AllocationProtect</span> <span class="o">&amp;</span> <span class="n">PAGE_EXECUTE_READWRITE</span><span class="p">)</span> <span class="o">==</span> <span class="n">PAGE_EXECUTE_READWRITE</span><span class="p">)</span> <span class="o">&amp;&amp;</span>
          <span class="p">((</span><span class="n">RegionInfo</span><span class="p">.</span><span class="n">State</span> <span class="o">&amp;</span> <span class="n">MEM_COMMIT</span><span class="p">)</span> <span class="o">==</span> <span class="n">MEM_COMMIT</span><span class="p">))</span> <span class="p">{</span>

        <span class="k">for</span> <span class="p">(</span><span class="n">k</span> <span class="o">=</span> <span class="n">i</span><span class="p">;</span> <span class="n">k</span> <span class="o">&lt;</span> <span class="n">i</span> <span class="o">+</span> <span class="n">RegionInfo</span><span class="p">.</span><span class="n">RegionSize</span><span class="p">;</span> <span class="n">k</span> <span class="o">+=</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">DWORD</span><span class="p">))</span> <span class="p">{</span>
          <span class="k">if</span> <span class="p">(</span>
            <span class="p">(</span><span class="o">*</span><span class="p">(</span><span class="n">PDWORD</span><span class="p">)</span><span class="n">k</span> <span class="o">==</span> <span class="err">'</span><span class="n">kuzt</span><span class="err">'</span><span class="p">)</span> <span class="o">||</span>
            <span class="p">(</span><span class="o">*</span><span class="p">(</span><span class="n">PDWORD</span><span class="p">)</span><span class="n">k</span> <span class="o">==</span> <span class="err">'</span><span class="n">xobs</span><span class="err">'</span><span class="p">)</span>
            <span class="p">)</span>
          <span class="p">{</span>
            <span class="n">IsSB</span> <span class="o">=</span> <span class="n">TRUE</span><span class="p">;</span>
            <span class="k">break</span><span class="p">;</span>
          <span class="p">}</span>
        <span class="p">}</span>
      <span class="p">}</span>
      <span class="n">i</span> <span class="o">+=</span> <span class="n">RegionInfo</span><span class="p">.</span><span class="n">RegionSize</span><span class="p">;</span>
    <span class="p">}</span>
    <span class="k">else</span> <span class="p">{</span>
      <span class="n">i</span> <span class="o">+=</span> <span class="mh">0x1000</span><span class="p">;</span>
    <span class="p">}</span>
  <span class="p">}</span> <span class="k">while</span> <span class="p">(</span><span class="n">i</span> <span class="o">&lt;</span> <span class="p">(</span><span class="n">ULONG_PTR</span><span class="p">)</span><span class="n">lpMaximumApplicationAddress</span><span class="p">);</span>

  <span class="k">return</span> <span class="n">IsSB</span><span class="p">;</span>
<span class="p">}</span></code></pre></figure>

<p><i>Take a look at <a href="https://github.com/hfiref0x/VMDE/blob/c1f439fbe58eaa83a09aa5804c4dd45de967337e/src/vmde/detect.c#L676">VMDE project sources</a>.</i></p>

<hr class="space" />

<p><b>Signature recommendations</b></p>
<p></p>
<p><i>Signature recommendations are not provided as it’s hard to say what exactly is queried when memory buffer is being examined.</i></p>

<p><br /></p>
<h4><a class="a-dummy" name="countermeasures-sandboxie">2.1. Countermeasures</a></h4>

<p>Erase present artifacts from memory.</p>

<p><br /></p>
<h3><a class="a-dummy" name="credits">Credits</a></h3>

<p>Credits go to open-source project from where code samples were taken:</p>
<ul>
<li>al-khaser project on <a href="https://github.com/LordNoteworthy/al-khaser">github</a></li>
<li>VMDE project on <a href="https://github.com/hfiref0x/VMDE">github</a></li>
</ul>

<p>Though Check Point tool InviZzzible has them all implemented, due to modular structure of the code it would require more space to show a code sample from this tool for the same purposes. That’s why we’ve decided to use other great open-source projects for examples throughout the encyclopedia.</p>


    <br>
    <div style="text-align: left">
        <a href="..">Go back</a>
    </div>
    <br>
    <div class="sharebuttons" style="text-align: center">
        <hr />
        <ul>
          <li>
            <p class="sharetitle"> Share this: </p>
          </li>
          <li class="reddit">
            <a href="http://www.reddit.com/submit?url=https://evasions.checkpoint.com/src/Evasions/techniques/processes.html&title=Evasions:%20Processes - Evasion Techniques" target="_blank">
                <svg xmlns="http://www.w3.org/2000/svg"
                aria-label="Reddit" role="img"
                viewBox="0 0 512 512"><rect
                width="512" height="512"
                rx="15%"
                fill="#f40"/><g fill="#fff"><ellipse cx="256" cy="307" rx="166" ry="117"/><circle cx="106" cy="256" r="42"/><circle cx="407" cy="256" r="42"/><circle cx="375" cy="114" r="32"/></g><g stroke-linecap="round" stroke-linejoin="round" fill="none"><path d="m256 196 23-101 73 15" stroke="#fff" stroke-width="16"/><path d="m191 359c33 25 97 26 130 0" stroke="#f40" stroke-width="13"/></g><g fill="#f40"><circle cx="191" cy="287" r="31"/><circle cx="321" cy="287" r="31"/></g></svg>
                
            </a>
          </li>
          <li class="hn">
            <a href="http://news.ycombinator.com/submitlink?u=https://evasions.checkpoint.com/src/Evasions/techniques/processes.html&t=Evasions:%20Processes - Evasion Techniques" target="_blank">
                <svg xmlns="http://www.w3.org/2000/svg"
                aria-label="Hacker News" role="img"
                viewBox="0 0 512 512"><rect
                width="512" height="512"
                rx="15%"
                fill="#f60"/><path fill="#fff" d="M124 91h51l81 162 81-164h51L276 293v136h-40V293z"/></svg>
            </a>
          </li>
          <li class="twitter">
            <a href="https://twitter.com/intent/tweet?via=_CPResearch_&url=https://evasions.checkpoint.com/src/Evasions/techniques/processes.html&text=Evasions:%20Processes - Evasion Techniques" target="_blank">
                <svg viewBox="0 0 1792 1792" xmlns="http://www.w3.org/2000/svg"><path d="M1684 408q-67 98-162 167 1 14 1 42 0 130-38 259.5t-115.5 248.5-184.5 210.5-258 146-323 54.5q-271 0-496-145 35 4 78 4 225 0 401-138-105-2-188-64.5t-114-159.5q33 5 61 5 43 0 85-11-112-23-185.5-111.5t-73.5-205.5v-4q68 38 146 41-66-44-105-115t-39-154q0-88 44-163 121 149 294.5 238.5t371.5 99.5q-8-38-8-74 0-134 94.5-228.5t228.5-94.5q140 0 236 102 109-21 205-78-37 115-142 178 93-10 186-50z"/></svg>
            </a>
          </li>
          <li class="linkedin">
            <a href=https://www.linkedin.com/shareArticle?mini=true&url=https://evasions.checkpoint.com/src/Evasions/techniques/processes.html&title=Evasions:%20Processes - Evasion Techniques&source=LinkedIn" target="_blank">
                <svg viewBox="0 0 1792 1792" xmlns="http://www.w3.org/2000/svg"><path d="M477 625v991h-330v-991h330zm21-306q1 73-50.5 122t-135.5 49h-2q-82 0-132-49t-50-122q0-74 51.5-122.5t134.5-48.5 133 48.5 51 122.5zm1166 729v568h-329v-530q0-105-40.5-164.5t-126.5-59.5q-63 0-105.5 34.5t-63.5 85.5q-11 30-11 81v553h-329q2-399 2-647t-1-296l-1-48h329v144h-2q20-32 41-56t56.5-52 87-43.5 114.5-15.5q171 0 275 113.5t104 332.5z"/></svg>
            </a>
          </li>
        </ul>
      </div>
      
</article>


</section>

<nav class="navbar navbar-default navbar-fixed-bottom">
  <div class="container footer-content">

    Made with <font class="a-pink"><i class ="fa fa-heart"></i></font> to serve the community by Check Point Research    |    <a class="a-pink" href="https://research.checkpoint.com">Research blog</a>    |    <a class="a-pink" href="https://research.checkpoint.com/about-us/">About Us</a>    |    <a class="a-pink" href="https://github.com/CheckPointSW"><i class="fa fa-github fa-lg"></i></a> <a class="a-pink" href="https://twitter.com/_CPResearch_"><i class="fa fa-twitter fa-lg"></i></a>
    
    <br>
    
    © 1994-2024 Check Point Software Technologies LTD | All rights reserved | Property of CheckPoint.com


  </div>
</nav>

  </body>

</html>
<!DOCTYPE html>
<html>

  <head>
  <meta charset="utf-8">
  <meta http-equiv="X-UA-Compatible" content="IE=edge">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-194688-3"></script>
  <script>
   window.dataLayer = window.dataLayer || [];
   function gtag(){dataLayer.push(arguments);}
   gtag('js', new Date());
   gtag('config', 'UA-194688-3');
  </script>
  <meta content="Evasion techniques" property="og:site_name">

  <meta content="Evasions: Registry" property="og:title">


  <meta name="twitter:title" content="Malware Evasion Encyclopedia" />
  <meta name="twitter:image" content="https://research.checkpoint.com/wp-content/uploads/2020/02/evasions.jpg" />


  <meta content="article" property="og:type">


  <meta content="Evasion techniques
" property="og:description">


  <meta content="https://evasions.checkpoint.com/src/Evasions/techniques/registry.html" property="og:url">


  <meta content="2024-07-10T07:20:28+00:00" property="article:published_time">
  <meta content="https://evasions.checkpoint.com/about/" property="article:author">


  <meta property="og:image" content="">


  
  <meta content="evasions" property="article:section">
  


  
  <meta content="registry" property="article:tag">
  

  <title>Evasions: Registry</title>
  <meta name="description" content="Contents">
<script src="https://ajax.googleapis.com/ajax/libs/jquery/2.2.2/jquery.min.js"></script>
<script src="https://maxcdn.bootstrapcdn.com/bootstrap/3.3.6/js/bootstrap.min.js" integrity="sha384-0mSbJDEHialfmuBBQP6A4Qrprq5OVfW37PRR3j5ELqxss1yVqOtnepnHVP9aJ7xS" crossorigin="anonymous"></script>
  <link rel="stylesheet" href="https://evasions.checkpoint.com/assets/css/main.css">
<script src="https://maxcdn.bootstrapcdn.com/bootstrap/3.3.6/js/bootstrap.min.js" integrity="sha384-0mSbJDEHialfmuBBQP6A4Qrprq5OVfW37PRR3j5ELqxss1yVqOtnepnHVP9aJ7xS" crossorigin="anonymous"></script>

  <link href='https://fonts.googleapis.com/css?family=PT+Sans' rel='stylesheet' type='text/css'>
  <link href='https://fonts.googleapis.com/css?family=Fira+Mono' rel='stylesheet' type='text/css'>
  <link href='https://fonts.googleapis.com/css?family=Lato:400,700' rel='stylesheet' type='text/css'>
  <link href='https://fonts.googleapis.com/css?family=Source+Code+Pro:400,200,300,500,600,700,900' rel='stylesheet' type='text/css'>
  <link href='https://fonts.googleapis.com/css?family=Gentium+Basic:400,700' rel='stylesheet' type='text/css'>
  <link href='https://fonts.googleapis.com/css?family=Alegreya:400,400italic,700' rel='stylesheet' type='text/css'>
  <link href='https://fonts.googleapis.com/css?family=Lora:400,400italic,700' rel='stylesheet' type='text/css'>
  <link href='https://fonts.googleapis.com/css?family=Fira+Sans:400,300,500,700' rel='stylesheet' type='text/css'>
  <script src="https://ajax.googleapis.com/ajax/libs/jquery/2.2.0/jquery.min.js"></script>
  <link href='https://fonts.googleapis.com/css?family=Open+Sans:400,700' rel='stylesheet' type='text/css'>
  <link href="https://maxcdn.bootstrapcdn.com/bootstrap/3.3.6/css/bootstrap.min.css" rel="stylesheet" integrity="sha384-1q8mTJOASx8j1Au+a5WDVnPi2lkFfwwEAa8hDDdjZlpLegxhjVME1fgjWPGmkzs7" crossorigin="anonymous">
  <link href="https://maxcdn.bootstrapcdn.com/font-awesome/4.6.1/css/font-awesome.min.css" rel="stylesheet" integrity="sha384-hQpvDQiCJaD2H465dQfA717v7lu5qHWtDbWNPvaTJ0ID5xnPUlVXnKzq7b8YUkbN" crossorigin="anonymous">
  <link rel="canonical" href="https://evasions.checkpoint.com/src/Evasions/techniques/registry.html">
  <link rel="alternate" type="application/rss+xml" title="Evasion techniques" href="https://evasions.checkpoint.com/feed.xml">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/tinysort/2.3.6/tinysort.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/tinysort/2.3.6/tinysort.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/tinysort/2.3.6/tinysort.charorder.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/tinysort/2.3.6/tinysort.charorder.min.js"></script>
  <script type="text/javascript" async src="//platform.twitter.com/widgets.js"></script>




</head>


  <body>
<section>
<article class="post" itemscope itemtype="http://schema.org/BlogPosting">
  <div class="jumbotron">
    <div class="container">
      <h1 class="post-title-main" itemprop="name headline">Evasions: Registry</h1>
    </div>
</div>

  <div class="post-content container" itemprop="articleBody">
    <div style="text-align: left">
        <a href="..">Go back</a>
        <br>
        <br>
    </div>
    <h1>Contents</h1>

<p><a href="#registry-detection-methods">Registry detection methods</a>
<br />
  <a href="#check-if-particular-registry-paths-exist">1. Check if particular registry paths exist</a>
<br />
  <a href="#check-if-keys-contain-strings">2. Check if particular registry keys contain specified strings</a>
<br />
  <a href="#check-if-vbawarning-enabled">3. Check if VBAWarnings enabled</a>
<br />
<a href="#countermeasures">Countermeasures</a>
<br />
<a href="#credits">Credits</a>
<br />
<br /></p>

<h2><a class="a-dummy" name="registry-detection-methods">Registry detection methods</a></h2>
<p>The principle of all the registry detection methods is the following: there are no such registry keys and values in usual host. However they exist in particular virtual environments.</p>

<p>Sometimes usual system may cause false positives when these checks are applied because it has some virtual machines installed and thus some VM artifacts are present in the system. Though in all other aspects such a system is treated clean in comparison with virtual environments.</p>

<p>Registry keys may be queries via WinAPI calls.</p>

<p>Functions used in <font face="Courier New">kernel32.dll</font>:</p>
<ul>
  <li><tt>RegOpenKey</tt></li> 
  <li><tt>RegOpenKeyEx</tt></li> 
  <li><tt>RegQueryValue</tt></li> 
  <li><tt>RegQueryValueEx</tt></li> 
  <li><tt>RegCloseKey</tt></li> 
  <li><tt>RegEnumKeyEx</tt></li> 
</ul>

<p>Functions above are wrappers on top of the following <font face="Courier New">ntdll.dll</font> functions:</p>
<ul>
  <li><tt>NtOpenKey</tt></li> 
  <li><tt>NtEnumerateKey</tt></li> 
  <li><tt>NtQueryValueKey</tt></li> 
  <li><tt>NtClose</tt></li> 
</ul>

<p><br /></p>
<h3><a class="a-dummy" name="check-if-particular-registry-paths-exist">1. Check if particular registry paths exist</a></h3>

<p>Take a look at <a href="#registry-detection-methods">title section</a> to get the list of used functions.</p>

<hr class="space" />

<p><b>Code sample</b></p>
<p></p>

<figure class="highlight"><pre><code class="language-c" data-lang="c"><span class="cm">/* sample of usage: see detection of VirtualBox in the table below to check registry path */</span>
<span class="kt">int</span> <span class="nf">vbox_reg_key7</span><span class="p">()</span> <span class="p">{</span>
    <span class="k">return</span> <span class="n">pafish_exists_regkey</span><span class="p">(</span><span class="n">HKEY_LOCAL_MACHINE</span><span class="p">,</span> <span class="s">"HARDWARE</span><span class="se">\\</span><span class="s">ACPI</span><span class="se">\\</span><span class="s">FADT</span><span class="se">\\</span><span class="s">VBOX__"</span><span class="p">);</span>
<span class="p">}</span>

<span class="cm">/* code is taken from "pafish" project, see references on the parent page */</span>
<span class="kt">int</span> <span class="nf">pafish_exists_regkey</span><span class="p">(</span><span class="n">HKEY</span> <span class="n">hKey</span><span class="p">,</span> <span class="kt">char</span> <span class="o">*</span> <span class="n">regkey_s</span><span class="p">)</span> <span class="p">{</span>
    <span class="n">HKEY</span> <span class="n">regkey</span><span class="p">;</span>
    <span class="n">LONG</span> <span class="n">ret</span><span class="p">;</span>

    <span class="cm">/* regkey_s == "HARDWARE\\ACPI\\FADT\\VBOX__"; */</span>
    <span class="k">if</span> <span class="p">(</span><span class="n">pafish_iswow64</span><span class="p">())</span> <span class="p">{</span>
        <span class="n">ret</span> <span class="o">=</span> <span class="n">RegOpenKeyEx</span><span class="p">(</span><span class="n">hKey</span><span class="p">,</span> <span class="n">regkey_s</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="n">KEY_READ</span> <span class="o">|</span> <span class="n">KEY_WOW64_64KEY</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">regkey</span><span class="p">);</span>
    <span class="p">}</span>
    <span class="k">else</span> <span class="p">{</span>
        <span class="n">ret</span> <span class="o">=</span> <span class="n">RegOpenKeyEx</span><span class="p">(</span><span class="n">hKey</span><span class="p">,</span> <span class="n">regkey_s</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="n">KEY_READ</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">regkey</span><span class="p">);</span>
    <span class="p">}</span>

    <span class="k">if</span> <span class="p">(</span><span class="n">ret</span> <span class="o">==</span> <span class="n">ERROR_SUCCESS</span><span class="p">)</span> <span class="p">{</span>
        <span class="n">RegCloseKey</span><span class="p">(</span><span class="n">regkey</span><span class="p">);</span>
        <span class="k">return</span> <span class="n">TRUE</span><span class="p">;</span>
    <span class="p">}</span>
    <span class="k">else</span>
        <span class="k">return</span> <span class="n">FALSE</span><span class="p">;</span>
<span class="p">}</span></code></pre></figure>

<p><i>Credits for this code sample: <a href="https://github.com/a0rtega/pafish">pafish project</a> </i></p>

<hr class="space" />

<p><b>Signature recommendations</b></p>
<p></p>
<p>If the following function contains 2nd argument from the table column <font face="Courier New">`Registry path`</font>:</p>
<p></p>
<ul>
<li><tt>NtOpenKey(..., registry_path, ...)</tt></li> 
</ul>
<p>then it’s an indication of application trying to use the evasion technique.</p>

<hr class="space" />

<p><b>Detections table</b></p>

<table style="width:100%">
  <tr>
  	<td colspan="3">Check if the following registry paths exist:</td>
  </tr>
  <tr>
  	<th style="text-align:center">Detect</th>
  	<th style="text-align:center">Registry path</th>
  	<th style="text-align:center">Details (if any)</th>
  </tr>
  <tr>
  	<th>[general]</th>
  	<td>HKLM\Software\Classes\Folder\shell\sandbox</td>
  	<td />
  </tr>
  <tr>
  	<th rowspan="7">Hyper-V</th>
  	<td>HKLM\SOFTWARE\Microsoft\Hyper-V</td>
  	<td />
  </tr>
  <tr>
  	<td>HKLM\SOFTWARE\Microsoft\VirtualMachine</td>
  	<td />
  </tr>
  <tr>
  	<td>HKLM\SOFTWARE\Microsoft\Virtual Machine\Guest\Parameters</td>
  	<td>Usually "HostName" and "VirtualMachineName" values are read under this path</td>
  </tr>
  <tr>
  	<td>HKLM\SYSTEM\ControlSet001\Services\vmicheartbeat</td>
  	<td />
  </tr>
  <tr>
  	<td>HKLM\SYSTEM\ControlSet001\Services\vmicvss</td>
  	<td />
  </tr>
  <tr>
  	<td>HKLM\SYSTEM\ControlSet001\Services\vmicshutdown</td>
  	<td />
  </tr>
  <tr>
  	<td>HKLM\SYSTEM\ControlSet001\Services\vmicexchange</td>
  	<td />
  </tr>
  <tr>
  	<th rowspan="1">Parallels</th>
  	<td>HKLM\SYSTEM\CurrentControlSet\Enum\PCI\VEN_1AB8*</td>
  	<td>Subkey has the following structure: VEN_XXXX&amp;DEV_YYYY&amp;SUBSYS_ZZZZ&amp;REV_WW</td>
  </tr>
  <tr>
  	<th rowspan="2">Sandboxie</th>
  	<td>HKLM\SYSTEM\CurrentControlSet\Services\SbieDrv</td>
  	<td />
  </tr>
  <tr>
  	<td>HKLM\SOFTWARE\Microsoft\Windows\CurrentVersion\Uninstall\Sandboxie</td>
  	<td />
  </tr>
  <tr>
  	<th rowspan="10">VirtualBox</th>
  	<td>HKLM\SYSTEM\CurrentControlSet\Enum\PCI\VEN_80EE*</td>
  	<td>Subkey has the following structure: VEN_XXXX&amp;DEV_YYYY&amp;SUBSYS_ZZZZ&amp;REV_WW</td>
  </tr>
  <tr>
  	<td>HKLM\HARDWARE\ACPI\DSDT\VBOX__</td>
  	<td />
  </tr>
  <tr>
  	<td>HKLM\HARDWARE\ACPI\FADT\VBOX__</td>
  	<td />
  </tr>
  <tr>
  	<td>HKLM\HARDWARE\ACPI\RSDT\VBOX__</td>
  	<td />
  </tr>
  <tr>
  	<td>HKLM\SOFTWARE\Oracle\VirtualBox Guest Additions</td>
  	<td />
  </tr>
  <tr>
  	<td>HKLM\SYSTEM\ControlSet001\Services\VBoxGuest</td>
  	<td />
  </tr>
  <tr>
  	<td>HKLM\SYSTEM\ControlSet001\Services\VBoxMouse</td>
  	<td />
  </tr>
  <tr>
  	<td>HKLM\SYSTEM\ControlSet001\Services\VBoxService</td>
  	<td />
  </tr>
  <tr>
  	<td>HKLM\SYSTEM\ControlSet001\Services\VBoxSF</td>
  	<td />
  </tr>
  <tr>
  	<td>HKLM\SYSTEM\ControlSet001\Services\VBoxVideo</td>
  	<td />
  </tr>
  <tr>
  	<th rowspan="5">VirtualPC</th>
  	<td>HKLM\SYSTEM\CurrentControlSet\Enum\PCI\VEN_5333*</td>
  	<td>Subkey has the following structure: VEN_XXXX&amp;DEV_YYYY&amp;SUBSYS_ZZZZ&amp;REV_WW</td>
  </tr>
  <tr>
  	<td>HKLM\SYSTEM\ControlSet001\Services\vpcbus</td>
  	<td />
  </tr>
  <tr>
  	<td>HKLM\SYSTEM\ControlSet001\Services\vpc-s3</td>
  	<td />
  </tr>
  <tr>
  	<td>HKLM\SYSTEM\ControlSet001\Services\vpcuhub</td>
  	<td />
  </tr>
  <tr>
  	<td>HKLM\SYSTEM\ControlSet001\Services\msvmmouf</td>
  	<td></td>
  </tr>
  <tr>
  	<th rowspan="14">VMware</th>
  	<td>HKLM\SYSTEM\CurrentControlSet\Enum\PCI\VEN_15AD*</td>
  	<td>Subkey has the following structure: VEN_XXXX&amp;DEV_YYYY&amp;SUBSYS_ZZZZ&amp;REV_WW</td>
  </tr>
  <tr>
  	<td>HKCU\SOFTWARE\VMware, Inc.\VMware Tools</td>
  	<td></td>
  </tr>
  <tr>
  	<td>HKLM\SOFTWARE\VMware, Inc.\VMware Tools</td>
  	<td></td>
  </tr>
  <tr>
  	<td>HKLM\SYSTEM\ControlSet001\Services\vmdebug</td>
  	<td></td>
  </tr>
  <tr>
  	<td>HKLM\SYSTEM\ControlSet001\Services\vmmouse</td>
  	<td></td>
  </tr>
  <tr>
  	<td>HKLM\SYSTEM\ControlSet001\Services\VMTools</td>
  	<td></td>
  </tr>
  <tr>
  	<td>HKLM\SYSTEM\ControlSet001\Services\VMMEMCTL</td>
  	<td></td>
  </tr>
  <tr>
  	<td>HKLM\SYSTEM\ControlSet001\Services\vmware</td>
  	<td></td>
  </tr>
  <tr>
  	<td>HKLM\SYSTEM\ControlSet001\Services\vmci</td>
  	<td></td>
  </tr>
  <tr>
  	<td>HKLM\SYSTEM\ControlSet001\Services\vmx86</td>
  	<td></td>
  </tr>
  <tr>
  	<td>HKLM\SYSTEM\CurrentControlSet\Enum\IDE\CdRomNECVMWar_VMware_IDE_CD*</td>
  	<td></td>
  </tr>
  <tr>
  	<td>HKLM\SYSTEM\CurrentControlSet\Enum\IDE\CdRomNECVMWar_VMware_SATA_CD*</td>
  	<td></td>
  </tr>
  <tr>
  	<td>HKLM\SYSTEM\CurrentControlSet\Enum\IDE\DiskVMware_Virtual_IDE_Hard_Drive*</td>
  	<td></td>
  </tr>
  <tr>
  	<td>HKLM\SYSTEM\CurrentControlSet\Enum\IDE\DiskVMware_Virtual_SATA_Hard_Drive*</td>
  	<td></td>
  </tr>
  <tr>
  	<th rowspan="2">Wine</th>
  	<td>HKCU\SOFTWARE\Wine</td>
  	<td></td>
  </tr>
  <tr>
  	<td>HKLM\SOFTWARE\Wine</td>
  	<td></td>
  </tr>
  <tr>
  	<th rowspan="8">Xen</th>
  	<td>HKLM\HARDWARE\ACPI\DSDT\xen</td>
  	<td></td>
  </tr>
  <tr>
  	<td>HKLM\HARDWARE\ACPI\FADT\xen</td>
  	<td></td>
  </tr>
  <tr>
  	<td>HKLM\HARDWARE\ACPI\RSDT\xen</td>
  	<td></td>
  </tr>
  <tr>
  	<td>HKLM\SYSTEM\ControlSet001\Services\xenevtchn</td>
  	<td></td>
  </tr>
  <tr>
  	<td>HKLM\SYSTEM\ControlSet001\Services\xennet</td>
  	<td></td>
  </tr>
  <tr>
  	<td>HKLM\SYSTEM\ControlSet001\Services\xennet6</td>
  	<td></td>
  </tr>
  <tr>
  	<td>HKLM\SYSTEM\ControlSet001\Services\xensvc</td>
  	<td></td>
  </tr>
  <tr>
  	<td>HKLM\SYSTEM\ControlSet001\Services\xenvdb</td>
  	<td></td>
  </tr>
</table>

<p><br />
In particular cases malware may enumerate sub-keys and check if a name of the sub-key contain some string instead of checking if the specified key exists.</p>

<p></p>
<p>For example: enumerate sub-keys of <font face="Courier New">"HKLM\SYSTEM\ControlSet001\Services\"</font> and search for <font face="Courier New">"VBox"</font> string.</p>

<p><br /></p>
<h3><a class="a-dummy" name="check-if-keys-contain-strings">2. Check if particular registry keys contain specified strings</a></h3>

<p>Take a look at <a href="#registry-detection-methods">title section</a> to get the list of used functions. Please note that case is irrelevant for these checks: it may be either upper or lower.</p>

<hr class="space" />

<p><b>Code sample</b></p>
<p></p>

<figure class="highlight"><pre><code class="language-c" data-lang="c"><span class="cm">/* sample of usage: see detection of VirtualBox in the table below to check registry path and key values */</span>
<span class="kt">int</span> <span class="nf">vbox_reg_key2</span><span class="p">()</span> <span class="p">{</span>
    <span class="k">return</span> <span class="n">pafish_exists_regkey_value_str</span><span class="p">(</span><span class="n">HKEY_LOCAL_MACHINE</span><span class="p">,</span> <span class="s">"HARDWARE</span><span class="se">\\</span><span class="s">Description</span><span class="se">\\</span><span class="s">System"</span><span class="p">,</span> <span class="s">"SystemBiosVersion"</span><span class="p">,</span> <span class="s">"VBOX"</span><span class="p">);</span>
<span class="p">}</span>

<span class="cm">/* code is taken from "pafish" project, see references on the parent page */</span>
<span class="kt">int</span> <span class="nf">pafish_exists_regkey_value_str</span><span class="p">(</span><span class="n">HKEY</span> <span class="n">hKey</span><span class="p">,</span> <span class="kt">char</span> <span class="o">*</span> <span class="n">regkey_s</span><span class="p">,</span> <span class="kt">char</span> <span class="o">*</span> <span class="n">value_s</span><span class="p">,</span> <span class="kt">char</span> <span class="o">*</span> <span class="n">lookup</span><span class="p">)</span> <span class="p">{</span>
    <span class="cm">/*
        regkey_s == "HARDWARE\\Description\\System";
        value_s == "SystemBiosVersion";
        lookup == "VBOX";
    */</span>

    <span class="n">HKEY</span> <span class="n">regkey</span><span class="p">;</span>
    <span class="n">LONG</span> <span class="n">ret</span><span class="p">;</span>
    <span class="n">DWORD</span> <span class="n">size</span><span class="p">;</span>
    <span class="kt">char</span> <span class="n">value</span><span class="p">[</span><span class="mi">1024</span><span class="p">],</span> <span class="o">*</span> <span class="n">lookup_str</span><span class="p">;</span>
    <span class="kt">size_t</span> <span class="n">lookup_size</span><span class="p">;</span>

    <span class="n">lookup_size</span> <span class="o">=</span> <span class="n">strlen</span><span class="p">(</span><span class="n">lookup</span><span class="p">);</span>
    <span class="n">lookup_str</span> <span class="o">=</span> <span class="n">malloc</span><span class="p">(</span><span class="n">lookup_size</span><span class="o">+</span><span class="k">sizeof</span><span class="p">(</span><span class="kt">char</span><span class="p">));</span>
    <span class="n">strncpy</span><span class="p">(</span><span class="n">lookup_str</span><span class="p">,</span> <span class="n">lookup</span><span class="p">,</span> <span class="n">lookup_size</span><span class="o">+</span><span class="k">sizeof</span><span class="p">(</span><span class="kt">char</span><span class="p">));</span>
    <span class="n">size</span> <span class="o">=</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">value</span><span class="p">);</span>

    <span class="cm">/* regkey_s == "HARDWARE\\Description\\System"; */</span>
    <span class="k">if</span> <span class="p">(</span><span class="n">pafish_iswow64</span><span class="p">())</span> <span class="p">{</span>
        <span class="n">ret</span> <span class="o">=</span> <span class="n">RegOpenKeyEx</span><span class="p">(</span><span class="n">hKey</span><span class="p">,</span> <span class="n">regkey_s</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="n">KEY_READ</span> <span class="o">|</span> <span class="n">KEY_WOW64_64KEY</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">regkey</span><span class="p">);</span>
    <span class="p">}</span>
    <span class="k">else</span> <span class="p">{</span>
        <span class="n">ret</span> <span class="o">=</span> <span class="n">RegOpenKeyEx</span><span class="p">(</span><span class="n">hKey</span><span class="p">,</span> <span class="n">regkey_s</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="n">KEY_READ</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">regkey</span><span class="p">);</span>
    <span class="p">}</span>

    <span class="k">if</span> <span class="p">(</span><span class="n">ret</span> <span class="o">==</span> <span class="n">ERROR_SUCCESS</span><span class="p">)</span> <span class="p">{</span>
        <span class="cm">/* value_s == "SystemBiosVersion"; */</span>
        <span class="n">ret</span> <span class="o">=</span> <span class="n">RegQueryValueEx</span><span class="p">(</span><span class="n">regkey</span><span class="p">,</span> <span class="n">value_s</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">,</span> <span class="p">(</span><span class="n">BYTE</span><span class="o">*</span><span class="p">)</span><span class="n">value</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">size</span><span class="p">);</span>
        <span class="n">RegCloseKey</span><span class="p">(</span><span class="n">regkey</span><span class="p">);</span>

        <span class="k">if</span> <span class="p">(</span><span class="n">ret</span> <span class="o">==</span> <span class="n">ERROR_SUCCESS</span><span class="p">)</span> <span class="p">{</span>
            <span class="kt">size_t</span> <span class="n">i</span><span class="p">;</span>
            <span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">strlen</span><span class="p">(</span><span class="n">value</span><span class="p">);</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span> <span class="cm">/* case-insensitive */</span>
                <span class="n">value</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="n">toupper</span><span class="p">(</span><span class="n">value</span><span class="p">[</span><span class="n">i</span><span class="p">]);</span>
            <span class="p">}</span>
            <span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">lookup_size</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span> <span class="cm">/* case-insensitive */</span>
                <span class="n">lookup_str</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="n">toupper</span><span class="p">(</span><span class="n">lookup_str</span><span class="p">[</span><span class="n">i</span><span class="p">]);</span>
            <span class="p">}</span>
            <span class="k">if</span> <span class="p">(</span><span class="n">strstr</span><span class="p">(</span><span class="n">value</span><span class="p">,</span> <span class="n">lookup_str</span><span class="p">)</span> <span class="o">!=</span> <span class="nb">NULL</span><span class="p">)</span> <span class="p">{</span>
                <span class="n">free</span><span class="p">(</span><span class="n">lookup_str</span><span class="p">);</span>
                <span class="k">return</span> <span class="n">TRUE</span><span class="p">;</span>
            <span class="p">}</span>
        <span class="p">}</span>
    <span class="p">}</span>

    <span class="n">free</span><span class="p">(</span><span class="n">lookup_str</span><span class="p">);</span>
    <span class="k">return</span> <span class="n">FALSE</span><span class="p">;</span>
<span class="p">}</span></code></pre></figure>

<p><i>Credits for this code sample: <a href="https://github.com/a0rtega/pafish">pafish project</a> </i></p>

<hr class="space" />

<p><b>Signature recommendations</b></p>
<p></p>
<p>If the following function contains 2nd argument from the table column <font face="Courier New">`Registry path`</font>:</p>
<p></p>
<ul>
<li><tt>NtOpenKey(..., registry_path, ...)</tt></li> 
</ul>
<p>and is followed by the call to the following function with 2nd argument from the table column <font face="Courier New">`Registry key`</font>:</p>
<ul>
<li><tt>NtQueryValueKey(..., registry_item, ...)</tt></li> 
</ul>
<p>then it’s an indication of application trying to use the evasion technique.</p>

<hr class="space" />

<p><b>Detections table</b></p>

<table style="width:100%">
  <tr>
  	<td colspan="4">Check if the following registry values contain the following strings (case insensitive):</td>
  </tr>
  <tr>
  	<th style="text-align:center">Detect</th>
  	<th style="text-align:center">Registry path</th>
  	<th style="text-align:center">Registry key</th>
  	<th style="text-align:center">String</th>
  </tr>
  <tr>
  	<th rowspan="2">[general]</th>
  	<td>HKLM\HARDWARE\Description\System</td>
  	<td>SystemBiosDate</td>
  	<td>06/23/99</td>
  </tr>
  <tr>
  	<td>HKLM\HARDWARE\Description\System\BIOS</td>
  	<td>SystemProductName</td>
  	<td>A M I</td>
  </tr>
  <tr>
  	<th rowspan="2">BOCHS</th>
  	<td>HKLM\HARDWARE\Description\System</td>
  	<td>SystemBiosVersion</td>
  	<td>BOCHS</td>
  </tr>
  <tr>
  	<td>HKLM\HARDWARE\Description\System</td>
  	<td>VideoBiosVersion</td>
  	<td>BOCHS</td>
  </tr>
  <tr>
  	<th rowspan="2">Anubis</th>
  	<td>HKLM\SOFTWARE\Microsoft\Windows\CurrentVersion</td>
  	<td>ProductID</td>
  	<td>76487-337-8429955-22614</td>
  </tr>
  <tr>
  	<td>HKLM\SOFTWARE\Microsoft\Windows NT\CurrentVersion</td>
  	<td>ProductID</td>
  	<td>76487-337-8429955-22614</td>
  </tr>
  <tr>
  	<th rowspan="2">CwSandbox</th>
  	<td>HKLM\SOFTWARE\Microsoft\Windows\CurrentVersion</td>
  	<td>ProductID</td>
  	<td>76487-644-3177037-23510</td>
  </tr>
  <tr>
  	<td>HKLM\SOFTWARE\Microsoft\Windows NT\CurrentVersion</td>
  	<td>ProductID</td>
  	<td>76487-644-3177037-23510</td>
  </tr>
  <tr>
  	<th rowspan="2">JoeBox</th>
  	<td>HKLM\SOFTWARE\Microsoft\Windows\CurrentVersion</td>
  	<td>ProductID</td>
  	<td>55274-640-2673064-23950</td>
  </tr>
  <tr>
  	<td>HKLM\SOFTWARE\Microsoft\Windows NT\CurrentVersion</td>
  	<td>ProductID</td>
  	<td>55274-640-2673064-23950</td>
  </tr>
  <tr>
  	<th rowspan="2">Parallels</th>
  	<td>HKLM\HARDWARE\Description\System</td>
  	<td>SystemBiosVersion</td>
  	<td>PARALLELS</td>
  </tr>
  <tr>
  	<td>HKLM\HARDWARE\Description\System</td>
  	<td>VideoBiosVersion</td>
  	<td>PARALLELS</td>
  </tr>
  <tr>
  	<th rowspan="4">QEMU</th>
  	<td>HKLM\HARDWARE\DEVICEMAP\Scsi\Scsi Port 0\Scsi Bus 0\Target Id 0\Logical Unit Id 0</td>
  	<td>Identifier</td>
  	<td>QEMU</td>
  </tr>
  <tr>
  	<td>HKLM\HARDWARE\Description\System</td>
  	<td>SystemBiosVersion</td>
  	<td>QEMU</td>
  </tr>
  <tr>
  	<td>HKLM\HARDWARE\Description\System</td>
  	<td>VideoBiosVersion</td>
  	<td>QEMU</td>
  </tr>
  <tr>
  	<td>HKLM\HARDWARE\Description\System\BIOS</td>
  	<td>SystemManufacturer</td>
  	<td>QEMU</td>
  </tr>
  <tr>
  	<th rowspan="14">VirtualBox</th>
  	<td>HKLM\HARDWARE\DEVICEMAP\Scsi\Scsi Port 0\Scsi Bus 0\Target Id 0\Logical Unit Id 0</td>
  	<td>Identifier</td>
  	<td>VBOX</td>
  </tr>
  <tr>
  	<td>HKLM\HARDWARE\DEVICEMAP\Scsi\Scsi Port 1\Scsi Bus 0\Target Id 0\Logical Unit Id 0</td>
  	<td>Identifier</td>
  	<td>VBOX</td>
  </tr>
  <tr>
  	<td>HKLM\HARDWARE\DEVICEMAP\Scsi\Scsi Port 2\Scsi Bus 0\Target Id 0\Logical Unit Id 0</td>
  	<td>Identifier</td>
  	<td>VBOX</td>
  </tr>
  <tr>
  	<td>HKLM\HARDWARE\Description\System</td>
  	<td>SystemBiosVersion</td>
  	<td>VBOX</td>
  </tr>
  <tr>
  	<td>HKLM\HARDWARE\Description\System</td>
  	<td>VideoBiosVersion</td>
  	<td>VIRTUALBOX</td>
  </tr>
  <tr>
  	<td>HKLM\HARDWARE\Description\System\BIOS</td>
  	<td>SystemProductName</td>
  	<td>VIRTUAL</td>
  </tr>
  <tr>
  	<td>HKLM\SYSTEM\ControlSet001\Services\Disk\Enum</td>
  	<td>DeviceDesc</td>
  	<td>VBOX</td>
  </tr>
  <tr>
  	<td>HKLM\SYSTEM\ControlSet001\Services\Disk\Enum</td>
  	<td>FriendlyName</td>
  	<td>VBOX</td>
  </tr>
  <tr>
  	<td>HKLM\SYSTEM\ControlSet002\Services\Disk\Enum</td>
  	<td>DeviceDesc</td>
  	<td>VBOX</td>
  </tr>
  <tr>
  	<td>HKLM\SYSTEM\ControlSet002\Services\Disk\Enum</td>
  	<td>FriendlyName</td>
  	<td>VBOX</td>
  </tr>
  <tr>
  	<td>HKLM\SYSTEM\ControlSet003\Services\Disk\Enum</td>
  	<td>DeviceDesc</td>
  	<td>VBOX</td>
  </tr>
  <tr>
  	<td>HKLM\SYSTEM\ControlSet003\Services\Disk\Enum</td>
  	<td>FriendlyName</td>
  	<td>VBOX</td>
  </tr>
  <tr>
  	<td>HKLM\SYSTEM\CurrentControlSet\Control\SystemInformation</td>
  	<td>SystemProductName</td>
  	<td>VIRTUAL</td>
  </tr>
  <tr>
  	<td>HKLM\SYSTEM\CurrentControlSet\Control\SystemInformation</td>
  	<td>SystemProductName</td>
  	<td>VIRTUALBOX</td>
  </tr>
  <tr>
  	<th rowspan="28">VMware</th>
  	<td>HKLM\HARDWARE\DEVICEMAP\Scsi\Scsi Port 0\Scsi Bus 0\Target Id 0\Logical Unit Id 0</td>
  	<td>Identifier</td>
  	<td>VMWARE</td>
  </tr>
  <tr>
  	<td>HKLM\HARDWARE\DEVICEMAP\Scsi\Scsi Port 1\Scsi Bus 0\Target Id 0\Logical Unit Id 0</td>
  	<td>Identifier</td>
  	<td>VMWARE</td>
  </tr>
  <tr>
  	<td>HKLM\HARDWARE\DEVICEMAP\Scsi\Scsi Port 2\Scsi Bus 0\Target Id 0\Logical Unit Id 0</td>
  	<td>Identifier</td>
  	<td>VMWARE</td>
  </tr>
  <tr>
  	<td>HKLM\HARDWARE\Description\System</td>
  	<td>SystemBiosVersion</td>
  	<td>VMWARE</td>
  </tr>
  <tr>
  	<td>HKLM\HARDWARE\Description\System</td>
  	<td>SystemBiosVersion</td>
  	<td>INTEL - 6040000</td>
  </tr>
  <tr>
  	<td>HKLM\HARDWARE\Description\System</td>
  	<td>VideoBiosVersion</td>
  	<td>VMWARE</td>
  </tr>
  <tr>
  	<td>HKLM\HARDWARE\Description\System\BIOS</td>
  	<td>SystemProductName</td>
  	<td>VMware</td>
  </tr>
  <tr>
  	<td>HKLM\SYSTEM\ControlSet001\Services\Disk\Enum</td>
  	<td>0</td>
  	<td>VMware</td>
  </tr>
  <tr>
  	<td>HKLM\SYSTEM\ControlSet001\Services\Disk\Enum</td>
  	<td>1</td>
  	<td>VMware</td>
  </tr>
  <tr>
  	<td>HKLM\SYSTEM\ControlSet001\Services\Disk\Enum</td>
  	<td>DeviceDesc</td>
  	<td>VMware</td>
  </tr>
  <tr>
  	<td>HKLM\SYSTEM\ControlSet001\Services\Disk\Enum</td>
  	<td>FriendlyName</td>
  	<td>VMware</td>
  </tr>
  <tr>
  	<td>HKLM\SYSTEM\ControlSet002\Services\Disk\Enum</td>
  	<td>DeviceDesc</td>
  	<td>VMware</td>
  </tr>
  <tr>
  	<td>HKLM\SYSTEM\ControlSet002\Services\Disk\Enum</td>
  	<td>FriendlyName</td>
  	<td>VMware</td>
  </tr>
  <tr>
  	<td>HKLM\SYSTEM\ControlSet003\Services\Disk\Enum</td>
  	<td>DeviceDesc</td>
  	<td>VMware</td>
  </tr>
  <tr>
  	<td>HKLM\SYSTEM\ControlSet003\Services\Disk\Enum</td>
  	<td>FriendlyName</td>
  	<td>VMware</td>
  </tr>
  <tr>
  	<td>HKCR\Installer\Products</td>
  	<td>ProductName</td>
  	<td>vmware tools</td>
  </tr>
  <tr>
  	<td>HKCU\SOFTWARE\Microsoft\Windows\CurrentVersion\Uninstall</td>
  	<td>DisplayName</td>
  	<td>vmware tools</td>
  </tr>
  <tr>
  	<td>HKLM\SOFTWARE\Microsoft\Windows\CurrentVersion\Uninstall</td>
  	<td>DisplayName</td>
  	<td>vmware tools</td>
  </tr>
  <tr>
  	<td>HKLM\SOFTWARE\Microsoft\Windows\CurrentVersion\Uninstall</td>
  	<td>DisplayName</td>
  	<td>vmware tools</td>
  </tr>
  <tr>
  	<td>HKLM\SYSTEM\ControlSet001\Control\Class\{4D36E968-E325-11CE-BFC1-08002BE10318}\0000</td>
  	<td>CoInstallers32</td>
  	<td>*vmx*</td>
  </tr>
  <tr>
  	<td>HKLM\SYSTEM\ControlSet001\Control\Class\{4D36E968-E325-11CE-BFC1-08002BE10318}\0000</td>
  	<td>DriverDesc</td>
  	<td>VMware*</td>
  </tr>
  <tr>
  	<td>HKLM\SYSTEM\ControlSet001\Control\Class\{4D36E968-E325-11CE-BFC1-08002BE10318}\0000</td>
  	<td>InfSection</td>
  	<td>vmx*</td>
  </tr>
  <tr>
  	<td>HKLM\SYSTEM\ControlSet001\Control\Class\{4D36E968-E325-11CE-BFC1-08002BE10318}\0000</td>
  	<td>ProviderName</td>
  	<td>VMware*</td>
  </tr>
  <tr>
  	<td>HKLM\SYSTEM\ControlSet001\Control\Class\{4D36E968-E325-11CE-BFC1-08002BE10318}\0000\Settings</td>
  	<td>Device Description</td>
  	<td>VMware*</td>
  </tr>
  <tr>
  	<td>HKLM\SYSTEM\CurrentControlSet\Control\SystemInformation</td>
  	<td>SystemProductName</td>
  	<td>VMWARE</td>
  </tr>
  <tr>
  	<td>HKLM\SYSTEM\CurrentControlSet\Control\Video\{GUID}\Video</td>
  	<td>Service</td>
  	<td>vm3dmp</td>
  </tr>
  <tr>
  	<td>HKLM\SYSTEM\CurrentControlSet\Control\Video\{GUID}\Video</td>
  	<td>Service</td>
  	<td>vmx_svga</td>
  </tr>
  <tr>
  	<td>HKLM\SYSTEM\CurrentControlSet\Control\Video\{GUID}\0000</td>
  	<td>Device Description</td>
  	<td>VMware SVGA*</td>
  </tr>
  <tr>
  	<th rowspan="1">Xen</th>
  	<td>HKLM\HARDWARE\Description\System\BIOS</td>
  	<td>SystemProductName</td>
  	<td>Xen</td>
  </tr>
</table>

<hr class="space" />

<p><br /></p>
<h3><a class="a-dummy" name="check-if-vbawarning-enabled">3. Check if VBAWarnings enabled</a></h3>

<p>“Enable all macros” prompt in Office documents means the macros can be executed without any user interaction. This behavior is common for sandboxes.
A malware can use that in order to check if it is running on a sandbox checking the flag in the registry keys  <tt>SOFTWARE\Microsoft\Office&lt;version&gt;\Word\Security\VBAWarnings</tt> while the version is between 12.0 to 19.0.</p>

<hr class="space" />

<p><b>Code sample</b></p>
<p></p>

<figure class="highlight"><pre><code class="language-c" data-lang="c"><span class="c1">// Function to check if VBScript warnings are enabled in Office</span>
<span class="n">bool</span> <span class="nf">IsVBScriptWarningEnabled</span><span class="p">()</span> <span class="p">{</span>
    <span class="n">HKEY</span> <span class="n">hKey</span><span class="p">;</span>
    <span class="n">LPCWSTR</span> <span class="n">keyPath</span> <span class="o">=</span> <span class="s">L"SOFTWARE</span><span class="se">\\</span><span class="s">Microsoft</span><span class="se">\\</span><span class="s">Office</span><span class="se">\\</span><span class="s">&lt;Office_Version&gt;</span><span class="se">\\</span><span class="s">Common</span><span class="se">\\</span><span class="s">Security"</span><span class="p">;</span>
    <span class="n">LPCWSTR</span> <span class="n">valueName</span> <span class="o">=</span> <span class="s">L"VBAScriptWarnings"</span><span class="p">;</span>

    <span class="c1">// Open the registry key</span>
    <span class="n">LONG</span> <span class="n">result</span> <span class="o">=</span> <span class="n">RegOpenKeyEx</span><span class="p">(</span><span class="n">HKEY_CURRENT_USER</span><span class="p">,</span> <span class="n">keyPath</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="n">KEY_READ</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">hKey</span><span class="p">);</span>
    <span class="k">if</span> <span class="p">(</span><span class="n">result</span> <span class="o">==</span> <span class="n">ERROR_SUCCESS</span><span class="p">)</span> <span class="p">{</span>
        <span class="n">DWORD</span> <span class="n">dwType</span><span class="p">;</span>
        <span class="n">DWORD</span> <span class="n">dwValue</span><span class="p">;</span>
        <span class="n">DWORD</span> <span class="n">dwSize</span> <span class="o">=</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">DWORD</span><span class="p">);</span>

        <span class="c1">// Query the value of VBAScriptWarnings</span>
        <span class="n">result</span> <span class="o">=</span> <span class="n">RegQueryValueEx</span><span class="p">(</span><span class="n">hKey</span><span class="p">,</span> <span class="n">valueName</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">dwType</span><span class="p">,</span> <span class="n">reinterpret_cast</span><span class="o">&lt;</span><span class="n">LPBYTE</span><span class="o">&gt;</span><span class="p">(</span><span class="o">&amp;</span><span class="n">dwValue</span><span class="p">),</span> <span class="o">&amp;</span><span class="n">dwSize</span><span class="p">);</span>
        <span class="k">if</span> <span class="p">(</span><span class="n">result</span> <span class="o">==</span> <span class="n">ERROR_SUCCESS</span> <span class="o">&amp;&amp;</span> <span class="n">dwType</span> <span class="o">==</span> <span class="n">REG_DWORD</span> <span class="o">&amp;&amp;</span> <span class="n">dwValue</span> <span class="o">==</span> <span class="mi">1</span><span class="p">)</span> <span class="p">{</span>
            <span class="c1">// VBScript warnings are enabled</span>
            <span class="n">RegCloseKey</span><span class="p">(</span><span class="n">hKey</span><span class="p">);</span>
            <span class="k">return</span> <span class="nb">true</span><span class="p">;</span>
        <span class="p">}</span>
        <span class="n">RegCloseKey</span><span class="p">(</span><span class="n">hKey</span><span class="p">);</span>
    <span class="p">}</span>
    <span class="k">return</span> <span class="nb">false</span><span class="p">;</span>
<span class="p">}</span>

<span class="kt">int</span> <span class="nf">main</span><span class="p">()</span> <span class="p">{</span>
    <span class="k">if</span> <span class="p">(</span><span class="n">IsVBScriptWarningEnabled</span><span class="p">())</span> <span class="p">{</span>
        <span class="n">std</span><span class="o">::</span><span class="n">cout</span> <span class="o">&lt;&lt;</span> <span class="s">"VBScript warnings are enabled in Office."</span> <span class="o">&lt;&lt;</span> <span class="n">std</span><span class="o">::</span><span class="n">endl</span><span class="p">;</span>
    <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
        <span class="n">std</span><span class="o">::</span><span class="n">cout</span> <span class="o">&lt;&lt;</span> <span class="s">"VBScript warnings are not enabled in Office."</span> <span class="o">&lt;&lt;</span> <span class="n">std</span><span class="o">::</span><span class="n">endl</span><span class="p">;</span>
    <span class="p">}</span>

    <span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span></code></pre></figure>

<p><br /></p>
<h3><a class="a-dummy" name="countermeasures">Countermeasures</a></h3>

<p>Hook target functions and return appropriate results if indicators (registry strings from tables) are checked.</p>

<p><br /></p>
<h3><a class="a-dummy" name="credits">Credits</a></h3>

<p>Credits go to open-source project from where code samples were taken:</p>
<ul>
<li>pafish project on <a href="https://github.com/a0rtega/pafish">github</a></li>
</ul>

<p>Though Check Point tool InviZzzible has them all implemented, due to modular structure of the code it would require more space to show a code sample from this tool for the same purposes. That’s why we’ve decided to use other great open-source projects for examples throughout the encyclopedia.</p>


    <br>
    <div style="text-align: left">
        <a href="..">Go back</a>
    </div>
    <br>
    <div class="sharebuttons" style="text-align: center">
        <hr />
        <ul>
          <li>
            <p class="sharetitle"> Share this: </p>
          </li>
          <li class="reddit">
            <a href="http://www.reddit.com/submit?url=https://evasions.checkpoint.com/src/Evasions/techniques/registry.html&title=Evasions:%20Registry - Evasion Techniques" target="_blank">
                <svg xmlns="http://www.w3.org/2000/svg"
                aria-label="Reddit" role="img"
                viewBox="0 0 512 512"><rect
                width="512" height="512"
                rx="15%"
                fill="#f40"/><g fill="#fff"><ellipse cx="256" cy="307" rx="166" ry="117"/><circle cx="106" cy="256" r="42"/><circle cx="407" cy="256" r="42"/><circle cx="375" cy="114" r="32"/></g><g stroke-linecap="round" stroke-linejoin="round" fill="none"><path d="m256 196 23-101 73 15" stroke="#fff" stroke-width="16"/><path d="m191 359c33 25 97 26 130 0" stroke="#f40" stroke-width="13"/></g><g fill="#f40"><circle cx="191" cy="287" r="31"/><circle cx="321" cy="287" r="31"/></g></svg>
                
            </a>
          </li>
          <li class="hn">
            <a href="http://news.ycombinator.com/submitlink?u=https://evasions.checkpoint.com/src/Evasions/techniques/registry.html&t=Evasions:%20Registry - Evasion Techniques" target="_blank">
                <svg xmlns="http://www.w3.org/2000/svg"
                aria-label="Hacker News" role="img"
                viewBox="0 0 512 512"><rect
                width="512" height="512"
                rx="15%"
                fill="#f60"/><path fill="#fff" d="M124 91h51l81 162 81-164h51L276 293v136h-40V293z"/></svg>
            </a>
          </li>
          <li class="twitter">
            <a href="https://twitter.com/intent/tweet?via=_CPResearch_&url=https://evasions.checkpoint.com/src/Evasions/techniques/registry.html&text=Evasions:%20Registry - Evasion Techniques" target="_blank">
                <svg viewBox="0 0 1792 1792" xmlns="http://www.w3.org/2000/svg"><path d="M1684 408q-67 98-162 167 1 14 1 42 0 130-38 259.5t-115.5 248.5-184.5 210.5-258 146-323 54.5q-271 0-496-145 35 4 78 4 225 0 401-138-105-2-188-64.5t-114-159.5q33 5 61 5 43 0 85-11-112-23-185.5-111.5t-73.5-205.5v-4q68 38 146 41-66-44-105-115t-39-154q0-88 44-163 121 149 294.5 238.5t371.5 99.5q-8-38-8-74 0-134 94.5-228.5t228.5-94.5q140 0 236 102 109-21 205-78-37 115-142 178 93-10 186-50z"/></svg>
            </a>
          </li>
          <li class="linkedin">
            <a href=https://www.linkedin.com/shareArticle?mini=true&url=https://evasions.checkpoint.com/src/Evasions/techniques/registry.html&title=Evasions:%20Registry - Evasion Techniques&source=LinkedIn" target="_blank">
                <svg viewBox="0 0 1792 1792" xmlns="http://www.w3.org/2000/svg"><path d="M477 625v991h-330v-991h330zm21-306q1 73-50.5 122t-135.5 49h-2q-82 0-132-49t-50-122q0-74 51.5-122.5t134.5-48.5 133 48.5 51 122.5zm1166 729v568h-329v-530q0-105-40.5-164.5t-126.5-59.5q-63 0-105.5 34.5t-63.5 85.5q-11 30-11 81v553h-329q2-399 2-647t-1-296l-1-48h329v144h-2q20-32 41-56t56.5-52 87-43.5 114.5-15.5q171 0 275 113.5t104 332.5z"/></svg>
            </a>
          </li>
        </ul>
      </div>
      
</article>


</section>

<nav class="navbar navbar-default navbar-fixed-bottom">
  <div class="container footer-content">

    Made with <font class="a-pink"><i class ="fa fa-heart"></i></font> to serve the community by Check Point Research    |    <a class="a-pink" href="https://research.checkpoint.com">Research blog</a>    |    <a class="a-pink" href="https://research.checkpoint.com/about-us/">About Us</a>    |    <a class="a-pink" href="https://github.com/CheckPointSW"><i class="fa fa-github fa-lg"></i></a> <a class="a-pink" href="https://twitter.com/_CPResearch_"><i class="fa fa-twitter fa-lg"></i></a>
    
    <br>
    
    © 1994-2024 Check Point Software Technologies LTD | All rights reserved | Property of CheckPoint.com


  </div>
</nav>

  </body>

</html>
<!DOCTYPE html>
<html>

  <head>
  <meta charset="utf-8">
  <meta http-equiv="X-UA-Compatible" content="IE=edge">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-194688-3"></script>
  <script>
   window.dataLayer = window.dataLayer || [];
   function gtag(){dataLayer.push(arguments);}
   gtag('js', new Date());
   gtag('config', 'UA-194688-3');
  </script>
  <meta content="Evasion techniques" property="og:site_name">

  <meta content="Evasions: Timing" property="og:title">


  <meta name="twitter:title" content="Malware Evasion Encyclopedia" />
  <meta name="twitter:image" content="https://research.checkpoint.com/wp-content/uploads/2020/02/evasions.jpg" />


  <meta content="article" property="og:type">


  <meta content="Evasion techniques
" property="og:description">


  <meta content="https://evasions.checkpoint.com/src/Evasions/techniques/timing.html" property="og:url">


  <meta content="2024-07-10T07:20:28+00:00" property="article:published_time">
  <meta content="https://evasions.checkpoint.com/about/" property="article:author">


  <meta property="og:image" content="">


  
  <meta content="evasions" property="article:section">
  


  
  <meta content="timing" property="article:tag">
  

  <title>Evasions: Timing</title>
  <meta name="description" content="Contents">
<script src="https://ajax.googleapis.com/ajax/libs/jquery/2.2.2/jquery.min.js"></script>
<script src="https://maxcdn.bootstrapcdn.com/bootstrap/3.3.6/js/bootstrap.min.js" integrity="sha384-0mSbJDEHialfmuBBQP6A4Qrprq5OVfW37PRR3j5ELqxss1yVqOtnepnHVP9aJ7xS" crossorigin="anonymous"></script>
  <link rel="stylesheet" href="https://evasions.checkpoint.com/assets/css/main.css">
<script src="https://maxcdn.bootstrapcdn.com/bootstrap/3.3.6/js/bootstrap.min.js" integrity="sha384-0mSbJDEHialfmuBBQP6A4Qrprq5OVfW37PRR3j5ELqxss1yVqOtnepnHVP9aJ7xS" crossorigin="anonymous"></script>

  <link href='https://fonts.googleapis.com/css?family=PT+Sans' rel='stylesheet' type='text/css'>
  <link href='https://fonts.googleapis.com/css?family=Fira+Mono' rel='stylesheet' type='text/css'>
  <link href='https://fonts.googleapis.com/css?family=Lato:400,700' rel='stylesheet' type='text/css'>
  <link href='https://fonts.googleapis.com/css?family=Source+Code+Pro:400,200,300,500,600,700,900' rel='stylesheet' type='text/css'>
  <link href='https://fonts.googleapis.com/css?family=Gentium+Basic:400,700' rel='stylesheet' type='text/css'>
  <link href='https://fonts.googleapis.com/css?family=Alegreya:400,400italic,700' rel='stylesheet' type='text/css'>
  <link href='https://fonts.googleapis.com/css?family=Lora:400,400italic,700' rel='stylesheet' type='text/css'>
  <link href='https://fonts.googleapis.com/css?family=Fira+Sans:400,300,500,700' rel='stylesheet' type='text/css'>
  <script src="https://ajax.googleapis.com/ajax/libs/jquery/2.2.0/jquery.min.js"></script>
  <link href='https://fonts.googleapis.com/css?family=Open+Sans:400,700' rel='stylesheet' type='text/css'>
  <link href="https://maxcdn.bootstrapcdn.com/bootstrap/3.3.6/css/bootstrap.min.css" rel="stylesheet" integrity="sha384-1q8mTJOASx8j1Au+a5WDVnPi2lkFfwwEAa8hDDdjZlpLegxhjVME1fgjWPGmkzs7" crossorigin="anonymous">
  <link href="https://maxcdn.bootstrapcdn.com/font-awesome/4.6.1/css/font-awesome.min.css" rel="stylesheet" integrity="sha384-hQpvDQiCJaD2H465dQfA717v7lu5qHWtDbWNPvaTJ0ID5xnPUlVXnKzq7b8YUkbN" crossorigin="anonymous">
  <link rel="canonical" href="https://evasions.checkpoint.com/src/Evasions/techniques/timing.html">
  <link rel="alternate" type="application/rss+xml" title="Evasion techniques" href="https://evasions.checkpoint.com/feed.xml">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/tinysort/2.3.6/tinysort.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/tinysort/2.3.6/tinysort.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/tinysort/2.3.6/tinysort.charorder.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/tinysort/2.3.6/tinysort.charorder.min.js"></script>
  <script type="text/javascript" async src="//platform.twitter.com/widgets.js"></script>




</head>


  <body>
<section>
<article class="post" itemscope itemtype="http://schema.org/BlogPosting">
  <div class="jumbotron">
    <div class="container">
      <h1 class="post-title-main" itemprop="name headline">Evasions: Timing</h1>
    </div>
</div>

  <div class="post-content container" itemprop="articleBody">
    <div style="text-align: left">
        <a href="..">Go back</a>
        <br>
        <br>
    </div>
    <h1>Contents</h1>

<p><a href="#time-based-sandbox-evasion-techniques">Time-based sandbox evasion techniques</a>
<br />
  <a href="#delayed-execution">1. Delayed execution</a>
<br />
  <a href="#simple-delaying-operation">1.1. Simple delaying operation</a>
<br />
  <a href="#deferred-execution-using-task-scheduler">1.2. Deferred execution using Task Scheduler</a>
<br />
  <a href="#no-suspicious-actions-until-reboot">1.3. No suspicious actions until reboot</a>
<br />
  <a href="#running-only-on-certain-dates">1.4. Running only on certain dates</a>
<br />
  <a href="#sleep-skipping-detection">2. Sleep skipping detection</a>
<br />
  <a href="#parallel-delays">2.1. Parallel delays using different methods</a>
<br />
  <a href="#measure-time-intervals">2.2. Measure time intervals using different methods</a>
<br />
  <a href="#get-system-time">2.3. Get system time using different methods</a>
<br />
  <a href="#delay-value-changed">2.4. Check if the delay value changes after calling a delay function</a>
<br />
  <a href="#absolute-timeout">2.5. Use absolute timeout</a>
<br />
  <a href="#get-time-another-process">2.6. Get time from another process</a>
<br />
  <a href="#get-time-ntp">3. Get the current date and time from an external source (NTP, HTTP)</a>
<br />
  <a href="#difference-vm-hosts">4. Difference in time measurement in VM and hosts</a>
<br />
  <a href="#rdtsc">4.1. RDTSC (with CPUID to force a VM Exit)</a>
<br />
  <a href="#rdtsc-locky">4.2. RDTSC (Locky version with GetProcessHeap and CloseHandle)</a>
<br />
  <a href="#check-system-boot-time">5. Check the system last boot time using different methods</a>
<br />
  <a href="#call-hooked-function-with-invalid-arguments">6. Call a potentially hooked delay function with invalid arguments</a>
<br />
  <a href="#countermeasures">Countermeasures</a>
<br />
<a href="#credits">Credits</a>
<br />
<br /></p>

<hr class="space" />

<h2><a class="a-dummy" name="time-based-sandbox-evasion-techniques">Time-based sandbox evasion techniques</a></h2>
<p>Sandbox emulation usually lasts a short time because sandboxes are heavy loaded with thousands of samples. Emulation
time rarely exceeds 3-5 minutes. Therefore, malware can use this fact to avoid detection: it may perform
long delays before starting any malicious activity.<br />
To counteract this, sandboxes may implement features which manipulate time and execution delays. For example, the Cuckoo 
sandbox has a sleep skipping feature that replaces delays with a very short value. This should force the malware to start 
its malicious activity before an analysis timeout.</p>

<div style="text-align: center">
  <img src="../assets/images/sleep_skipping.png" />
</div>
<p><br />
However, this can also be used to detect a sandbox.<br />
There are also some differences in the time of execution of some instructions and API functions that
can be used to detect a virtual environment.</p>
<p>
<i>Signature recommendations are not provided for this class of techniques as executing functions described in this 
chapter does not imply their usage for evasion purposes. It is hard to differentiate between the code which aims to 
perform an evasion code and the one which uses the same functions with non-evasion intentions. </i>
</p>

<p><br /></p>
<h3><a class="a-dummy" name="delayed-execution">1. Delayed execution</a></h3>
<p>Execution delays are used to avoid detection of malicious activity during the emulation time.
<br /></p>
<h4><a class="a-dummy" name="simple-delaying-operation">1.1. Simple delaying operation</a></h4>
<p>Functions used:</p>
<ul>
<li><tt>Sleep, SleepEx, NtDelayExecution</tt></li>
<li><tt>WaitForSingleObject, WaitForSingleObjectEx, NtWaitForSingleObject</tt></li>
<li><tt>WaitForMultipleObjects, WaitForMultipleObjectsEx, NtWaitForMultipleObjects</tt></li>
<li><tt>SetTimer, SetWaitableTimer, CreateTimerQueueTimer</tt></li>
<li><tt>timeSetEvent</tt> (multimedia timers)</li>
<li><tt>IcmpSendEcho</tt></li>
<li><tt>select</tt> (Windows sockets)</li>
</ul>
<p>While the use of most of these functions is obvious, we show examples of using the <tt>timeSetEvent</tt> function
from Multimedia API and the <tt>select</tt> function from the Windows sockets API.<br />
<br />
<b>Code sample (delay using the “select” function)</b></p>

<figure class="highlight"><pre><code class="language-c" data-lang="c"><span class="kt">int</span> <span class="n">iResult</span><span class="p">;</span>
<span class="n">DWORD</span> <span class="n">timeout</span> <span class="o">=</span> <span class="n">delay</span><span class="p">;</span> <span class="c1">// delay in milliseconds</span>
<span class="n">DWORD</span> <span class="n">OK</span> <span class="o">=</span> <span class="n">TRUE</span><span class="p">;</span>

<span class="n">SOCKADDR_IN</span> <span class="n">sa</span> <span class="o">=</span> <span class="p">{</span> <span class="mi">0</span> <span class="p">};</span>
<span class="n">SOCKET</span> <span class="n">sock</span> <span class="o">=</span> <span class="n">INVALID_SOCKET</span><span class="p">;</span>

<span class="c1">// this code snippet should take around Timeout milliseconds</span>
<span class="k">do</span> <span class="p">{</span>
    <span class="n">memset</span><span class="p">(</span><span class="o">&amp;</span><span class="n">sa</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">sa</span><span class="p">));</span>
    <span class="n">sa</span><span class="p">.</span><span class="n">sin_family</span> <span class="o">=</span> <span class="n">AF_INET</span><span class="p">;</span>
    <span class="n">sa</span><span class="p">.</span><span class="n">sin_addr</span><span class="p">.</span><span class="n">s_addr</span> <span class="o">=</span> <span class="n">inet_addr</span><span class="p">(</span><span class="s">"8.8.8.8"</span><span class="p">);</span>    <span class="c1">// we should have a route to this IP address</span>
    <span class="n">sa</span><span class="p">.</span><span class="n">sin_port</span> <span class="o">=</span> <span class="n">htons</span><span class="p">(</span><span class="mi">80</span><span class="p">);</span> <span class="c1">// we should not be able to connect to this port</span>

    <span class="n">sock</span> <span class="o">=</span> <span class="n">socket</span><span class="p">(</span><span class="n">AF_INET</span><span class="p">,</span> <span class="n">SOCK_STREAM</span><span class="p">,</span> <span class="n">IPPROTO_TCP</span><span class="p">);</span>
    <span class="k">if</span> <span class="p">(</span><span class="n">sock</span> <span class="o">==</span> <span class="n">INVALID_SOCKET</span><span class="p">)</span> <span class="p">{</span>
        <span class="n">OK</span> <span class="o">=</span> <span class="n">FALSE</span><span class="p">;</span>
        <span class="k">break</span><span class="p">;</span>
    <span class="p">}</span>

    <span class="c1">// setting socket timeout</span>
    <span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">iMode</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
    <span class="n">iResult</span> <span class="o">=</span> <span class="n">ioctlsocket</span><span class="p">(</span><span class="n">sock</span><span class="p">,</span> <span class="n">FIONBIO</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">iMode</span><span class="p">);</span>

    <span class="n">iResult</span> <span class="o">=</span> <span class="n">connect</span><span class="p">(</span><span class="n">sock</span><span class="p">,</span> <span class="p">(</span><span class="n">SOCKADDR</span><span class="o">*</span><span class="p">)</span><span class="o">&amp;</span><span class="n">sa</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">sa</span><span class="p">));</span>
    <span class="k">if</span> <span class="p">(</span><span class="n">iResult</span> <span class="o">==</span> <span class="nb">false</span><span class="p">)</span> <span class="p">{</span>
        <span class="n">OK</span> <span class="o">=</span> <span class="n">FALSE</span><span class="p">;</span>
        <span class="k">break</span><span class="p">;</span>
    <span class="p">}</span>

    <span class="n">iMode</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
    <span class="n">iResult</span> <span class="o">=</span> <span class="n">ioctlsocket</span><span class="p">(</span><span class="n">sock</span><span class="p">,</span> <span class="n">FIONBIO</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">iMode</span><span class="p">);</span>
    <span class="k">if</span> <span class="p">(</span><span class="n">iResult</span> <span class="o">!=</span> <span class="n">NO_ERROR</span><span class="p">)</span> <span class="p">{</span>
        <span class="n">OK</span> <span class="o">=</span> <span class="n">FALSE</span><span class="p">;</span>
        <span class="k">break</span><span class="p">;</span>
    <span class="p">}</span>

    <span class="c1">// fd set data</span>
    <span class="n">fd_set</span> <span class="n">Write</span><span class="p">,</span> <span class="n">Err</span><span class="p">;</span>
    <span class="n">FD_ZERO</span><span class="p">(</span><span class="o">&amp;</span><span class="n">Write</span><span class="p">);</span>
    <span class="n">FD_ZERO</span><span class="p">(</span><span class="o">&amp;</span><span class="n">Err</span><span class="p">);</span>
    <span class="n">FD_SET</span><span class="p">(</span><span class="n">sock</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">Write</span><span class="p">);</span>
    <span class="n">FD_SET</span><span class="p">(</span><span class="n">sock</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">Err</span><span class="p">);</span>
    <span class="n">timeval</span> <span class="n">tv</span> <span class="o">=</span> <span class="p">{</span> <span class="mi">0</span> <span class="p">};</span>
    <span class="n">tv</span><span class="p">.</span><span class="n">tv_usec</span> <span class="o">=</span> <span class="n">timeout</span> <span class="o">*</span> <span class="mi">1000</span><span class="p">;</span>

    <span class="c1">// check if the socket is ready, this call should take Timeout milliseconds</span>
    <span class="n">select</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">Write</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">Err</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">tv</span><span class="p">);</span>
    
    <span class="k">if</span> <span class="p">(</span><span class="n">FD_ISSET</span><span class="p">(</span><span class="n">sock</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">Err</span><span class="p">))</span> <span class="p">{</span>
        <span class="n">OK</span> <span class="o">=</span> <span class="n">FALSE</span><span class="p">;</span>
        <span class="k">break</span><span class="p">;</span>
    <span class="p">}</span>

<span class="p">}</span> <span class="k">while</span> <span class="p">(</span><span class="nb">false</span><span class="p">);</span>

<span class="k">if</span> <span class="p">(</span><span class="n">sock</span> <span class="o">!=</span> <span class="n">INVALID_SOCKET</span><span class="p">)</span>
    <span class="n">closesocket</span><span class="p">(</span><span class="n">sock</span><span class="p">);</span></code></pre></figure>

<p><br />
<b>Code sample (delay using the “timeSetEvent” function)</b></p>

<figure class="highlight"><pre><code class="language-c" data-lang="c"><span class="n">VOID</span> <span class="n">CALLBACK</span> <span class="nf">TimerFunction</span><span class="p">(</span><span class="n">UINT</span> <span class="n">uTimerID</span><span class="p">,</span> <span class="n">UINT</span> <span class="n">uMsg</span><span class="p">,</span> <span class="n">DWORD_PTR</span> <span class="n">dwUser</span><span class="p">,</span> <span class="n">DWORD_PTR</span> <span class="n">dw1</span><span class="p">,</span> <span class="n">DWORD_PTR</span> <span class="n">dw2</span><span class="p">)</span>
<span class="p">{</span>
    <span class="n">bProcessed</span> <span class="o">=</span> <span class="n">TRUE</span><span class="p">;</span>
<span class="p">}</span>

<span class="n">VOID</span> <span class="nf">timing_timeSetEvent</span><span class="p">(</span><span class="n">UINT</span> <span class="n">delayInSeconds</span><span class="p">)</span>
<span class="p">{</span>
    <span class="c1">// Some vars</span>
    <span class="n">UINT</span> <span class="n">uResolution</span><span class="p">;</span>
    <span class="n">TIMECAPS</span> <span class="n">tc</span><span class="p">;</span>
    <span class="n">MMRESULT</span> <span class="n">idEvent</span><span class="p">;</span>

    <span class="c1">// We can obtain this minimum value by calling</span>
    <span class="n">timeGetDevCaps</span><span class="p">(</span><span class="o">&amp;</span><span class="n">tc</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">TIMECAPS</span><span class="p">));</span>
    <span class="n">uResolution</span> <span class="o">=</span> <span class="n">min</span><span class="p">(</span><span class="n">max</span><span class="p">(</span><span class="n">tc</span><span class="p">.</span><span class="n">wPeriodMin</span><span class="p">,</span> <span class="mi">0</span><span class="p">),</span> <span class="n">tc</span><span class="p">.</span><span class="n">wPeriodMax</span><span class="p">);</span>

    <span class="c1">// Create the timer</span>
    <span class="n">idEvent</span> <span class="o">=</span> <span class="n">timeSetEvent</span><span class="p">(</span>
        <span class="n">delayInSeconds</span><span class="p">,</span>
        <span class="n">uResolution</span><span class="p">,</span>
        <span class="n">TimerFunction</span><span class="p">,</span>
        <span class="mi">0</span><span class="p">,</span>
        <span class="n">TIME_ONESHOT</span><span class="p">);</span>

    <span class="k">while</span> <span class="p">(</span><span class="o">!</span><span class="n">bProcessed</span><span class="p">){</span>
        <span class="c1">// wait until our function finishes</span>
        <span class="n">Sleep</span><span class="p">(</span><span class="mi">0</span><span class="p">);</span>
    <span class="p">}</span>

    <span class="c1">// destroy the timer</span>
    <span class="n">timeKillEvent</span><span class="p">(</span><span class="n">idEvent</span><span class="p">);</span>

    <span class="c1">// reset the timer</span>
    <span class="n">timeEndPeriod</span><span class="p">(</span><span class="n">uResolution</span><span class="p">);</span>
<span class="p">}</span></code></pre></figure>

<p><i>Credits for this code sample: <a href="https://github.com/LordNoteworthy/al-khaser">al-khaser project</a></i></p>
<p><br /></p>
<h4><a class="a-dummy" name="deferred-execution-using-task-scheduler">1.2. Deferred execution using Task Scheduler</a></h4>
<p>This method can be used both for delaying execution and evading sandbox tracking.
<br /><br />
<b>Code sample (PowerShell)</b></p>

<figure class="highlight"><pre><code class="language-powershell" data-lang="powershell"><span class="w">    </span><span class="nv">$tm</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">(</span><span class="n">get-date</span><span class="p">)</span><span class="o">.</span><span class="nf">AddMinutes</span><span class="p">(</span><span class="nx">10</span><span class="p">)</span><span class="o">.</span><span class="nf">ToString</span><span class="p">(</span><span class="s2">"HH:mm"</span><span class="p">)</span><span class="w">
    </span><span class="nv">$action</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">New-ScheduledTaskAction</span><span class="w"> </span><span class="nt">-Execute</span><span class="w"> </span><span class="s2">"some_malicious_app.exe"</span><span class="w">
    </span><span class="nv">$trigger</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">New-ScheduledTaskTrigger</span><span class="w"> </span><span class="nt">-Once</span><span class="w"> </span><span class="nt">-At</span><span class="w"> </span><span class="nv">$tm</span><span class="w">
    </span><span class="n">Register-ScheduledTask</span><span class="w"> </span><span class="nx">TaskName</span><span class="w"> </span><span class="nt">-Action</span><span class="w"> </span><span class="nv">$action</span><span class="w"> </span><span class="nt">-Trigger</span><span class="w"> </span><span class="nv">$trigger</span></code></pre></figure>

<p><br /></p>
<h4><a class="a-dummy" name="no-suspicious-actions-until-reboot">1.3. No suspicious actions until reboot</a></h4>
<p>The idea behind this technique is that a sandbox doesn’t reboot a virtual machine during the emulation of a
malicious sample. The malware may just set up persistence using any of available methods and silently exit.
Malicious actions are performed only after the system is rebooted.</p>

<h4><a class="a-dummy" name="running-only-on-certain-dates">1.4. Running only on certain dates</a></h4>
<p>Malware samples may check the current date and perform malicious actions only on certain dates. For example,
this technique was used in the <a href="https://www.cyphort.com/sazoora-dissecting-bundle-evasion-stealth/">Sazoora malware</a>, 
which checks the current date and verifies if the day is either the 16th, 17th or 18th 
of a given month.</p>
<p><b>Example:</b></p>
<div style="text-align: center">
  <img src="../assets/images/date_anti_sb.png" />
</div>
<p><br /></p>

<p><b>Countermeasures</b></p>
<p></p>
<p>Countermeasures for this class of evasion techniques should be comprehensive and include all described attack vectors.
The implementation cannot be simple and its description deserves a separate article. Therefore, we only provide general
recommendations here:</p>
<ul>
<li>Implement sleep skipping.</li>
<li>System-wide dynamic time flow speed manipulation.</li>
<li>Run emulation multiple times on different dates.</li>
</ul>
<p>Although sleep skipping is already implemented in the Cuckoo sandbox, it is very easy to deceive it. 
Sleep skipping is disabled after a new thread or process is created to avoid sleep skipping detection.
However, it can still be easily detected as shown below.</p>

<h3><a class="a-dummy" name="sleep-skipping-detection">2. Sleep skipping detection</a></h3>
<p>Techniques of this type are generally aimed at the Cuckoo monitor sleep skipping feature and other time-manipulation
techniques that can be used in sandboxes to skip long delays performed by the malware.</p>
<h4><a class="a-dummy" name="parallel-delays">2.1. Parallel delays using different methods</a></h4>
<p>The idea behind the techniques is to perform different types of delays in parallel and to measure the elapsed time.
<br /><br />
<b>Code sample</b></p>

<figure class="highlight"><pre><code class="language-c" data-lang="c"><span class="n">DWORD</span> <span class="n">StartingTick</span><span class="p">,</span> <span class="n">TimeElapsedMs</span><span class="p">;</span>
<span class="n">LARGE_INTEGER</span> <span class="n">DueTime</span><span class="p">;</span>
<span class="n">HANDLE</span> <span class="n">hTimer</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
<span class="n">TIMER_BASIC_INFORMATION</span> <span class="n">TimerInformation</span><span class="p">;</span>
<span class="n">ULONG</span> <span class="n">ReturnLength</span><span class="p">;</span>

<span class="n">hTimer</span> <span class="o">=</span> <span class="n">CreateWaitableTimer</span><span class="p">(</span><span class="nb">NULL</span><span class="p">,</span> <span class="n">TRUE</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">);</span>
<span class="n">DueTime</span><span class="p">.</span><span class="n">QuadPart</span> <span class="o">=</span> <span class="n">Timeout</span> <span class="o">*</span> <span class="p">(</span><span class="o">-</span><span class="mi">10000LL</span><span class="p">);</span>

<span class="n">StartingTick</span> <span class="o">=</span> <span class="n">GetTickCount</span><span class="p">();</span>
<span class="n">SetWaitableTimer</span><span class="p">(</span><span class="n">hTimer</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">DueTime</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
<span class="k">do</span>
<span class="p">{</span>
    <span class="n">Sleep</span><span class="p">(</span><span class="n">Timeout</span><span class="o">/</span><span class="mi">10</span><span class="p">);</span>
    <span class="n">NtQueryTimer</span><span class="p">(</span><span class="n">hTimer</span><span class="p">,</span> <span class="n">TimerBasicInformation</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">TimerInformation</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">TIMER_BASIC_INFORMATION</span><span class="p">),</span> <span class="o">&amp;</span><span class="n">ReturnLength</span><span class="p">);</span>
<span class="p">}</span> <span class="k">while</span> <span class="p">(</span><span class="o">!</span><span class="n">TimerInformation</span><span class="p">.</span><span class="n">TimerState</span><span class="p">);</span>

<span class="n">CloseHandle</span><span class="p">(</span><span class="n">hTimer</span><span class="p">);</span>

<span class="n">TimeElapsedMs</span> <span class="o">=</span> <span class="n">GetTickCount</span><span class="p">()</span> <span class="o">-</span> <span class="n">StartingTick</span><span class="p">;</span>
<span class="n">printf</span><span class="p">(</span><span class="s">"Requested delay: %d, elapsed time: %d</span><span class="se">\n</span><span class="s">"</span><span class="p">,</span> <span class="n">Timeout</span><span class="p">,</span> <span class="n">TimeElapsedMs</span><span class="p">);</span>

<span class="k">if</span> <span class="p">(</span><span class="n">abs</span><span class="p">((</span><span class="n">LONG</span><span class="p">)(</span><span class="n">TimeElapsedMs</span> <span class="o">-</span> <span class="n">Timeout</span><span class="p">))</span> <span class="o">&gt;</span> <span class="n">Timeout</span> <span class="o">/</span> <span class="mi">2</span><span class="p">)</span>
    <span class="n">printf</span><span class="p">(</span><span class="s">"Sleep-skipping DETECTED!</span><span class="se">\n</span><span class="s">"</span><span class="p">);</span></code></pre></figure>

<p><br />
In the code sample above, the delay timeout is set using the <tt>SetWaitableTimer()</tt> timer function. 
The <tt>Sleep()</tt> function is called in a loop until the timer timeout. In the Cuckoo sandbox, delays that are performed 
by the <tt>Sleep()</tt> function are skipped (replaced with a very short timeout) and the virtually elapsed 
time will be much higher than the requested timeout:</p>

<figure class="highlight"><pre><code class="language-plaintex" data-lang="plaintex">    Requested delay: 60000, elapsed time: 1906975
    Sleep-skipping DETECTED!</code></pre></figure>

<p><br /></p>
<h4><a class="a-dummy" name="measure-time-intervals">2.2. Measure time intervals using different methods</a></h4>
<p>We need to perform a delay that will be skipped in a sandbox and to measure elapsed time using different methods.
While the Cuckoo monitor hooks the <tt>GetTickCount()</tt>, <tt>GetLocalTime()</tt>, <tt>GetSystemTime()</tt> and
makes them return the skipped time, we still can find methods to measure time that are not handled by the Cuckoo 
monitor.</p>

<p>Functions used:</p>
<ul>
  <li><tt>GetTickCount64</tt></li>
  <li><tt>QueryPerformanceFrequency, QueryPerformanceCounter</tt></li> 
  <li><tt>NtQuerySystemInformation</tt></li>
</ul>

<p><br /><br />
<b>Code sample (using “QueryPerformanceCounter” to measure elapsed time)</b></p>

<figure class="highlight"><pre><code class="language-c" data-lang="c"><span class="n">LARGE_INTEGER</span> <span class="n">StartingTime</span><span class="p">,</span> <span class="n">EndingTime</span><span class="p">;</span>
<span class="n">LARGE_INTEGER</span> <span class="n">Frequency</span><span class="p">;</span>
<span class="n">DWORD</span> <span class="n">TimeElapsedMs</span><span class="p">;</span>

<span class="n">QueryPerformanceFrequency</span><span class="p">(</span><span class="o">&amp;</span><span class="n">Frequency</span><span class="p">);</span>
<span class="n">QueryPerformanceCounter</span><span class="p">(</span><span class="o">&amp;</span><span class="n">StartingTime</span><span class="p">);</span>

<span class="n">Sleep</span><span class="p">(</span><span class="n">Timeout</span><span class="p">);</span>

<span class="n">QueryPerformanceCounter</span><span class="p">(</span><span class="o">&amp;</span><span class="n">EndingTime</span><span class="p">);</span>
<span class="n">TimeElapsedMs</span> <span class="o">=</span> <span class="p">(</span><span class="n">DWORD</span><span class="p">)(</span><span class="mi">1000ll</span> <span class="o">*</span> <span class="p">(</span><span class="n">EndingTime</span><span class="p">.</span><span class="n">QuadPart</span> <span class="o">-</span> <span class="n">StartingTime</span><span class="p">.</span><span class="n">QuadPart</span><span class="p">)</span> <span class="o">/</span> <span class="n">Frequency</span><span class="p">.</span><span class="n">QuadPart</span><span class="p">);</span>

<span class="n">printf</span><span class="p">(</span><span class="s">"Requested delay: %d, elapsed time: %d</span><span class="se">\n</span><span class="s">"</span><span class="p">,</span> <span class="n">Timeout</span><span class="p">,</span> <span class="n">TimeElapsedMs</span><span class="p">);</span>

<span class="k">if</span> <span class="p">(</span><span class="n">abs</span><span class="p">((</span><span class="n">LONG</span><span class="p">)(</span><span class="n">TimeElapsedMs</span> <span class="o">-</span> <span class="n">Timeout</span><span class="p">))</span> <span class="o">&gt;</span> <span class="n">Timeout</span> <span class="o">/</span> <span class="mi">2</span><span class="p">)</span>
    <span class="n">printf</span><span class="p">(</span><span class="s">"Sleep-skipping DETECTED!</span><span class="se">\n</span><span class="s">"</span><span class="p">);</span></code></pre></figure>

<p><br /><br />
<b>Code sample (using “GetTickCount64” to measure elapsed time)</b></p>

<figure class="highlight"><pre><code class="language-c" data-lang="c"><span class="n">ULONGLONG</span> <span class="n">tick</span><span class="p">;</span>
<span class="n">DWORD</span> <span class="n">TimeElapsedMs</span><span class="p">;</span>

<span class="n">tick</span> <span class="o">=</span> <span class="n">GetTickCount64</span><span class="p">();</span>
<span class="n">Sleep</span><span class="p">(</span><span class="n">Timeout</span><span class="p">);</span>
<span class="n">TimeElapsedMs</span> <span class="o">=</span> <span class="n">GetTickCount64</span><span class="p">()</span> <span class="o">-</span> <span class="n">tick</span><span class="p">;</span>

<span class="n">printf</span><span class="p">(</span><span class="s">"Requested delay: %d, elapsed time: %d</span><span class="se">\n</span><span class="s">"</span><span class="p">,</span> <span class="n">Timeout</span><span class="p">,</span> <span class="n">TimeElapsedMs</span><span class="p">);</span>

<span class="k">if</span> <span class="p">(</span><span class="n">abs</span><span class="p">((</span><span class="n">LONG</span><span class="p">)(</span><span class="n">TimeElapsedMs</span> <span class="o">-</span> <span class="n">Timeout</span><span class="p">))</span> <span class="o">&gt;</span> <span class="n">Timeout</span> <span class="o">/</span> <span class="mi">2</span><span class="p">)</span>
    <span class="n">printf</span><span class="p">(</span><span class="s">"Sleep-skipping DETECTED!</span><span class="se">\n</span><span class="s">"</span><span class="p">);</span></code></pre></figure>

<p>We can also use our own implementation of <tt>GetTickCount</tt> to detect sleep skipping.
In the next code sample, we acquire the tick count directly from the <tt>KUSER_SHARED_DATA</tt> structure. 
This way we can get the original tick count value even if the <tt>GetTickCount()</tt> function was hooked.
<br /><br />
<b>Code sample (getting the tick count from the KUSER_SHARED_DATA structure)</b></p>

<figure class="highlight"><pre><code class="language-c" data-lang="c"><span class="cp">#define KI_USER_SHARED_DATA         0x7FFE0000
#define SharedUserData  ((KUSER_SHARED_DATA * const) KI_USER_SHARED_DATA)
#define MyGetTickCount() ((DWORD)((SharedUserData-&gt;TickCountMultiplier * (ULONGLONG)SharedUserData-&gt;TickCount.LowPart) &gt;&gt; 24))
</span>
<span class="c1">// ...</span>
<span class="n">StartingTick</span> <span class="o">=</span> <span class="n">MyGetTickCount</span><span class="p">();</span>
<span class="n">Sleep</span><span class="p">(</span><span class="n">Timeout</span><span class="p">);</span>
<span class="n">TimeElapsedMs</span> <span class="o">=</span> <span class="n">MyGetTickCount</span><span class="p">()</span> <span class="o">-</span> <span class="n">StartingTick</span><span class="p">;</span>

<span class="n">printf</span><span class="p">(</span><span class="s">"Requested delay: %d, elapsed time: %d</span><span class="se">\n</span><span class="s">"</span><span class="p">,</span> <span class="n">Timeout</span><span class="p">,</span> <span class="n">TimeElapsedMs</span><span class="p">);</span>

<span class="k">if</span> <span class="p">(</span><span class="n">abs</span><span class="p">((</span><span class="n">LONG</span><span class="p">)(</span><span class="n">TimeElapsedMs</span> <span class="o">-</span> <span class="n">Timeout</span><span class="p">))</span> <span class="o">&gt;</span> <span class="n">Timeout</span> <span class="o">/</span> <span class="mi">2</span><span class="p">)</span>
    <span class="n">printf</span><span class="p">(</span><span class="s">"Sleep-skipping DETECTED!</span><span class="se">\n</span><span class="s">"</span><span class="p">);</span></code></pre></figure>

<p><br /></p>

<h4><a class="a-dummy" name="get-system-time">2.3. Get system time using different methods</a></h4>
<p>This method is similar to the previous one. Instead of measuring intervals we try to obtain the current system
time using different methods.
<br /><br />
<b>Code sample</b></p>

<figure class="highlight"><pre><code class="language-c" data-lang="c"><span class="n">SYSTEM_TIME_OF_DAY_INFORMATION</span>  <span class="n">SysTimeInfo</span><span class="p">;</span>
<span class="n">ULONGLONG</span> <span class="n">time</span><span class="p">;</span>
<span class="n">LONGLONG</span> <span class="n">diff</span><span class="p">;</span>

<span class="n">Sleep</span><span class="p">(</span><span class="mi">60000</span><span class="p">);</span> <span class="c1">// should trigger sleep skipping</span>
<span class="n">GetSystemTimeAsFileTime</span><span class="p">((</span><span class="n">LPFILETIME</span><span class="p">)</span><span class="o">&amp;</span><span class="n">time</span><span class="p">);</span>

<span class="n">NtQuerySystemInformation</span><span class="p">(</span><span class="n">SystemTimeOfDayInformation</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">SysTimeInfo</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">SysTimeInfo</span><span class="p">),</span> <span class="mi">0</span><span class="p">);</span>
<span class="n">diff</span> <span class="o">=</span> <span class="n">time</span> <span class="o">-</span> <span class="n">SysTimeInfo</span><span class="p">.</span><span class="n">CurrentTime</span><span class="p">.</span><span class="n">QuadPart</span><span class="p">;</span>
<span class="k">if</span> <span class="p">(</span><span class="n">abs</span><span class="p">(</span><span class="n">diff</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">10000000</span><span class="p">)</span> <span class="c1">// differ in more than 1 second</span>
    <span class="n">printf</span><span class="p">(</span><span class="s">"Sleep-skipping DETECTED!</span><span class="se">\n</span><span class="s">);</span></code></pre></figure>

<p><br /></p>
<h4><a class="a-dummy" name="delay-value-changed">2.4. Check if the delay value changes after calling a delay function</a></h4>
<p>Sleep-skipping is usually implemented as a replacement of the delay value with a smaller interval. 
Let’s look at the <tt>NtDelayExecution</tt> function. The delay value is passed to this function using a pointer:
<br /></p>

<figure class="highlight"><pre><code class="language-c" data-lang="c"><span class="n">NTSYSAPI</span> <span class="n">NTSTATUS</span> <span class="n">NTAPI</span>
<span class="nf">NtDelayExecution</span><span class="p">(</span>
    <span class="n">IN</span> <span class="n">BOOLEAN</span>              <span class="n">Alertable</span><span class="p">,</span>
    <span class="n">IN</span> <span class="n">PLARGE_INTEGER</span>       <span class="n">DelayInterval</span> <span class="p">);</span></code></pre></figure>

<p><br />
Therefore, we can check if the value of <tt>DelayInterval</tt> changes after the function execution.
If the value differs from the initial value, the delay was skipped.
<br /><br />
<b>Code sample</b></p>

<figure class="highlight"><pre><code class="language-c" data-lang="c"><span class="n">LONGLONG</span> <span class="n">SavedTimeout</span> <span class="o">=</span> <span class="n">Timeout</span> <span class="o">*</span> <span class="p">(</span><span class="o">-</span><span class="mi">10000LL</span><span class="p">);</span>
<span class="n">DelayInterval</span><span class="o">-&gt;</span><span class="n">QuadPart</span> <span class="o">=</span> <span class="n">SavedTimeout</span><span class="p">;</span>
<span class="n">status</span> <span class="o">=</span> <span class="n">NtDelayExecution</span><span class="p">(</span><span class="n">TRUE</span><span class="p">,</span> <span class="n">DelayInterval</span><span class="p">);</span>
<span class="k">if</span> <span class="p">(</span><span class="n">DelayInterval</span><span class="o">-&gt;</span><span class="n">QuadPart</span> <span class="o">!=</span> <span class="n">SavedTimeout</span><span class="p">)</span>
    <span class="n">printf</span><span class="p">(</span><span class="s">"Sleep-skipping DETECTED!</span><span class="se">\n</span><span class="s">"</span><span class="p">);</span></code></pre></figure>

<p><br /></p>

<h4><a class="a-dummy" name="absolute-timeout">2.5. Use absolute timeout</a></h4>
<p>For Nt-functions that perform delays we can use either a relative delay interval or an absolute time for timeout.
A negative value for the delay interval means a relative timeout, and a positive value means an absolute timeout.
High-level API functions such as <tt>WaitForSingleObject()</tt> or <tt>Sleep()</tt> operate with relative intervals.
Therefore sandbox developers may not care about absolute timeouts and handle them incorrectly.
In the Cuckoo sandbox such delays are skipped, but skipped time and ticks are counted incorrectly. This can be used
to detect sleep skipping.
<br /><br />
<b>Code sample</b></p>

<figure class="highlight"><pre><code class="language-c" data-lang="c"><span class="kt">void</span> <span class="nf">SleepAbs</span><span class="p">(</span><span class="n">DWORD</span> <span class="n">ms</span><span class="p">)</span>
<span class="p">{</span>
    <span class="n">LARGE_INTEGER</span> <span class="n">SleepUntil</span><span class="p">;</span>

    <span class="n">GetSystemTimeAsFileTime</span><span class="p">((</span><span class="n">LPFILETIME</span><span class="p">)</span><span class="o">&amp;</span><span class="n">SleepUntil</span><span class="p">);</span>
    <span class="n">SleepTo</span><span class="p">.</span><span class="n">QuadPart</span> <span class="o">+=</span> <span class="p">(</span><span class="n">ms</span> <span class="o">*</span> <span class="mi">10000</span><span class="p">);</span>
    <span class="n">NtDelayExecution</span><span class="p">(</span><span class="n">TRUE</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">SleepTo</span><span class="p">);</span>
<span class="p">}</span></code></pre></figure>

<p><br /></p>
<h4><a class="a-dummy" name="get-time-another-process">2.6. Get time from another process</a></h4>
<p>Sleep skipping in the Cuckoo sandbox is not system-wide. Therefore, if there are performing delays, time moves
with different speeds in the different processes. After a delay we should synchronize the processes and compare 
the current time in the two processes. A big difference in measured time values indicates sleep skipping was performed.</p>

<div style="text-align: center">
  <img src="../assets/images/sleep_skipping_detection.png" />
</div>

<p>The current version of the Cuckoo monitor disables sleep skipping after creating new threads or processes.
Therefore, we should use a process creation method that is not tracked by the Cuckoo monitor, for example,
using a scheduled task.</p>

<p><br /></p>
<h3><a class="a-dummy" name="get-time-ntp">3. Get the current date and time from an external source (NTP, HTTP)</a></h3>
<p>A sandbox may set different dates to check how the behavior of analyzed samples is changed depending on the date.
The malware can use an external date and time source to prevent time manipulation attempts inside the VM.
This method can also be used to measure time intervals, perform delays, and detect sleep skipping attempts.
NTP servers, and the HTTP header “Date” can be used as an external source for the date and time.
For example, the malware may connect to <tt>google.com</tt> to check the current date and use it as a DGA seed.</p>

<p><b>Countermeasures</b></p>
<p></p>

<p>Implement fake web infrastructure or spoof NTP data and HTTP headers returned by real servers. 
The returned/spoofed date and time should be synchronized with the date and time in a virtual machine.</p>

<p><br /></p>
<h3><a class="a-dummy" name="difference-vm-hosts">4. Difference in time measurement in VM and hosts</a></h3>
<p>The execution of some API functions and instructions may take different amounts of time in a VM and in the usual 
host systems. These peculiarities can be used to detect a virtual environment.</p>

<h4><a class="a-dummy" name="rdtsc">4.1. RDTSC (with CPUID to force a VM Exit)</a></h4>
<p><b>Code sample</b></p>

<figure class="highlight"><pre><code class="language-c" data-lang="c"><span class="n">BOOL</span> <span class="nf">rdtsc_diff_vmexit</span><span class="p">()</span>
<span class="p">{</span>
    <span class="n">ULONGLONG</span> <span class="n">tsc1</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
    <span class="n">ULONGLONG</span> <span class="n">tsc2</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
    <span class="n">ULONGLONG</span> <span class="n">avg</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
    <span class="n">INT</span> <span class="n">cpuInfo</span><span class="p">[</span><span class="mi">4</span><span class="p">]</span> <span class="o">=</span> <span class="p">{};</span>

    <span class="c1">// Try this 10 times in case of small fluctuations</span>
    <span class="k">for</span> <span class="p">(</span><span class="n">INT</span> <span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="mi">10</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span>
    <span class="p">{</span>
        <span class="n">tsc1</span> <span class="o">=</span> <span class="n">__rdtsc</span><span class="p">();</span>
        <span class="n">__cpuid</span><span class="p">(</span><span class="n">cpuInfo</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
        <span class="n">tsc2</span> <span class="o">=</span> <span class="n">__rdtsc</span><span class="p">();</span>

        <span class="c1">// Get the delta of the two RDTSC</span>
        <span class="n">avg</span> <span class="o">+=</span> <span class="p">(</span><span class="n">tsc2</span> <span class="o">-</span> <span class="n">tsc1</span><span class="p">);</span>
    <span class="p">}</span>

    <span class="c1">// We repeated the process 10 times so we make sure our check is as much reliable as we can</span>
    <span class="n">avg</span> <span class="o">=</span> <span class="n">avg</span> <span class="o">/</span> <span class="mi">10</span><span class="p">;</span>
    <span class="k">return</span> <span class="p">(</span><span class="n">avg</span> <span class="o">&lt;</span> <span class="mi">1000</span> <span class="o">&amp;&amp;</span> <span class="n">avg</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">)</span> <span class="o">?</span> <span class="n">FALSE</span> <span class="o">:</span> <span class="n">TRUE</span><span class="p">;</span>
<span class="p">}</span></code></pre></figure>

<p><i>Credits for this code sample: <a href="https://github.com/LordNoteworthy/al-khaser">al-khaser project</a></i></p>
<p><br /></p>
<h4><a class="a-dummy" name="rdtsc-locky">4.2. RDTSC (Locky version with GetProcessHeap and CloseHandle)</a></h4>
<p><b>Code sample</b></p>

<figure class="highlight"><pre><code class="language-c" data-lang="c"><span class="cp">#define LODWORD(_qw)    ((DWORD)(_qw))
</span><span class="n">BOOL</span> <span class="nf">rdtsc_diff_locky</span><span class="p">()</span>
<span class="p">{</span>
    <span class="n">ULONGLONG</span> <span class="n">tsc1</span><span class="p">;</span>
    <span class="n">ULONGLONG</span> <span class="n">tsc2</span><span class="p">;</span>
    <span class="n">ULONGLONG</span> <span class="n">tsc3</span><span class="p">;</span>
    <span class="n">DWORD</span> <span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

    <span class="c1">// Try this 10 times in case of small fluctuations</span>
    <span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="mi">10</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span>
    <span class="p">{</span>
        <span class="n">tsc1</span> <span class="o">=</span> <span class="n">__rdtsc</span><span class="p">();</span>

        <span class="c1">// Waste some cycles - should be faster than CloseHandle on bare metal</span>
        <span class="n">GetProcessHeap</span><span class="p">();</span>

        <span class="n">tsc2</span> <span class="o">=</span> <span class="n">__rdtsc</span><span class="p">();</span>

        <span class="c1">// Waste some cycles - slightly longer than GetProcessHeap() on bare metal</span>
        <span class="n">CloseHandle</span><span class="p">(</span><span class="mi">0</span><span class="p">);</span>

        <span class="n">tsc3</span> <span class="o">=</span> <span class="n">__rdtsc</span><span class="p">();</span>

        <span class="c1">// Did it take at least 10 times more CPU cycles to perform CloseHandle than it took to perform GetProcessHeap()?</span>
        <span class="k">if</span> <span class="p">((</span><span class="n">LODWORD</span><span class="p">(</span><span class="n">tsc3</span><span class="p">)</span> <span class="o">-</span> <span class="n">LODWORD</span><span class="p">(</span><span class="n">tsc2</span><span class="p">))</span> <span class="o">/</span> <span class="p">(</span><span class="n">LODWORD</span><span class="p">(</span><span class="n">tsc2</span><span class="p">)</span> <span class="o">-</span> <span class="n">LODWORD</span><span class="p">(</span><span class="n">tsc1</span><span class="p">))</span> <span class="o">&gt;=</span> <span class="mi">10</span><span class="p">)</span>
            <span class="k">return</span> <span class="n">FALSE</span><span class="p">;</span>
    <span class="p">}</span>

    <span class="c1">// We consistently saw a small ratio of difference between GetProcessHeap and CloseHandle execution times</span>
    <span class="c1">// so we're probably in a VM!</span>
    <span class="k">return</span> <span class="n">TRUE</span><span class="p">;</span>
<span class="p">}</span></code></pre></figure>

<p><i>Credits for this code sample: <a href="https://github.com/LordNoteworthy/al-khaser">al-khaser project</a></i></p>
<p><b>Countermeasures</b></p>
<p></p>

<p>Implement <tt>RDTSC</tt> instruction “hooking.” It is possible to make RDTSC a privileged instruction that 
can be called in kernel-mode only. Calling the “hooked” RDTSC in user-mode leads to an execution of our handler 
that can return any desired value.</p>

<p><br /></p>
<h3><a class="a-dummy" name="check-system-boot-time">5. Check the system last boot time using different methods</a></h3>
<p>This technique is a combination of techniques described in 
<a href="generic-os-queries.html#check-if-system-uptime">Generic OS queries: Check if the system uptime is small</a> 
and <a href="wmi.html#check-last-boot-time">WMI: Check the last boot time</a> sections. 
Depending on a method used for getting system last boot time, the measured sandbox OS uptime can be too 
small (several minutes), or conversely, too big (months or even years), because the system is usually restored 
from a snapshot after the analysis starts.
<br />
We can detect a sandbox by comparing the two values for the last boot time, acquired through WMI and through 
<tt>NtQuerySystemInformation(SystemTimeOfDayInformation)</tt>.
<br /><br /></p>

<p><b>Code sample</b></p>
<p></p>

<figure class="highlight"><pre><code class="language-c" data-lang="c"><span class="n">bool</span> <span class="nf">check_last_boot_time</span><span class="p">()</span>
<span class="p">{</span>
    <span class="n">SYSTEM_TIME_OF_DAY_INFORMATION</span>  <span class="n">SysTimeInfo</span><span class="p">;</span>
    <span class="n">LARGE_INTEGER</span> <span class="n">LastBootTime</span><span class="p">;</span>
    
    <span class="n">NtQuerySystemInformation</span><span class="p">(</span><span class="n">SystemTimeOfDayInformation</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">SysTimeInfo</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">SysTimeInfo</span><span class="p">),</span> <span class="mi">0</span><span class="p">);</span>
    <span class="n">LastBootTime</span> <span class="o">=</span> <span class="n">wmi_Get_LastBootTime</span><span class="p">();</span>
    <span class="k">return</span> <span class="p">(</span><span class="n">wmi_LastBootTime</span><span class="p">.</span><span class="n">QuadPart</span> <span class="o">-</span> <span class="n">SysTimeInfo</span><span class="p">.</span><span class="n">BootTime</span><span class="p">.</span><span class="n">QuadPart</span><span class="p">)</span> <span class="o">/</span> <span class="mi">10000000</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">;</span> <span class="c1">// 0 seconds</span>
<span class="p">}</span></code></pre></figure>

<p><b>Countermeasures</b></p>
<p></p>
<ul>
<li>Adjust the <tt>KeBootTime</tt> value</li>
<li>Reset the WMI repository or restart the <tt>"winmgmt"</tt> service after the <tt>KeBootTime</tt> adjustment</li>
</ul>

<p><br /></p>
<h3><a class="a-dummy" name="call-hooked-function-with-invalid-arguments">6. Call a potentially hooked delay function with invalid arguments</a></h3>
<p>The second argument of the <tt>NtDelayExecution</tt> function is a pointer to the delay interval value. In the kernel-mode, 
the <tt>NtDelayExecution</tt> function validates this pointer and can also return the following values:</p>
<ul>
<li><tt>STATUS_ACCESS_VIOLATION</tt> - If the value is not a valid user-mode address</li>
<li><tt>STATUS_DATATYPE_MISALIGNMENT</tt> - If the address is not aligned (DelayInterval &amp; 3 != 0)</li>
</ul>
<p>In a sandbox, the input arguments for <tt>NtDelayExecution</tt> and similar functions might not be handled correctly. 
If we call <tt>NtDelayExecution</tt> with an unaligned pointer for DelayInterval, normally it returns the 
<tt>STATUS_DATATYPE_MISALIGNMENT</tt>. However, in a sandbox, the value for DelayInterval may be copied to a new variable 
without the appropriate checks. In this case, a delay is performed and the returned value will be <tt>STATUS_SUCCESS</tt>. 
This can be used to detect a sandbox.
<br /><br />
<b>Code sample</b></p>

<figure class="highlight"><pre><code class="language-c" data-lang="c"><span class="kr">__declspec</span><span class="p">(</span><span class="n">align</span><span class="p">(</span><span class="mi">4</span><span class="p">))</span> <span class="n">BYTE</span> <span class="n">aligned_bytes</span><span class="p">[</span><span class="k">sizeof</span><span class="p">(</span><span class="n">LARGE_INTEGER</span><span class="p">)</span> <span class="o">*</span> <span class="mi">2</span><span class="p">];</span>
<span class="n">DWORD</span> <span class="n">tick_start</span><span class="p">,</span> <span class="n">time_elapsed_ms</span><span class="p">;</span>
<span class="n">DWORD</span> <span class="n">Timeout</span> <span class="o">=</span> <span class="mi">10000</span><span class="p">;</span> <span class="c1">//10 seconds</span>
<span class="n">PLARGE_INTEGER</span> <span class="n">DelayInterval</span> <span class="o">=</span> <span class="p">(</span><span class="n">PLARGE_INTEGER</span><span class="p">)(</span><span class="n">aligned_bytes</span> <span class="o">+</span> <span class="mi">1</span><span class="p">);</span> <span class="c1">//unaligned</span>
<span class="n">NTSTATUS</span> <span class="n">status</span><span class="p">;</span>

<span class="n">DelayInterval</span><span class="o">-&gt;</span><span class="n">QuadPart</span> <span class="o">=</span> <span class="n">Timeout</span> <span class="o">*</span> <span class="p">(</span><span class="o">-</span><span class="mi">10000LL</span><span class="p">);</span>
<span class="n">tick_start</span> <span class="o">=</span> <span class="n">GetTickCount</span><span class="p">();</span>
<span class="n">status</span> <span class="o">=</span> <span class="n">NtDelayExecution</span><span class="p">(</span><span class="n">FALSE</span><span class="p">,</span> <span class="n">DelayInterval</span><span class="p">);</span>
<span class="n">time_elapsed_ms</span> <span class="o">=</span> <span class="n">GetTickCount</span><span class="p">()</span> <span class="o">-</span> <span class="n">tick_start</span><span class="p">;</span>
<span class="c1">// If the pointer is not aligned the delay should not be performed</span>
<span class="k">if</span> <span class="p">(</span><span class="n">time_elapsed_ms</span> <span class="o">&gt;</span> <span class="mi">500</span> <span class="o">||</span> <span class="n">status</span> <span class="o">!=</span> <span class="n">STATUS_DATATYPE_MISALIGNMENT</span> <span class="p">)</span>
    <span class="n">printf</span><span class="p">(</span><span class="s">"Sandbox detected</span><span class="se">\n</span><span class="s">"</span><span class="p">);</span></code></pre></figure>

<p>On the other hand, if an inaccessible address is set for DelayInterval, the return code should be 
<tt>STATUS_ACCESS_VIOLATION</tt>. This can be used to detect a sandbox as well.
<br /><br />
<b>Code sample</b></p>

<figure class="highlight"><pre><code class="language-c" data-lang="c"><span class="k">if</span> <span class="p">(</span><span class="n">NtDelayExecution</span><span class="p">(</span><span class="n">FALSE</span><span class="p">,</span> <span class="p">(</span><span class="n">PLARGE_INTEGER</span><span class="p">)</span><span class="mi">0</span><span class="p">)</span> <span class="o">!=</span> <span class="n">STATUS_ACCESS_VIOLATION</span><span class="p">)</span>
    <span class="n">printf</span><span class="p">(</span><span class="s">"Sandbox detected"</span><span class="p">);</span></code></pre></figure>

<p>If the <tt>DelayInterval</tt> argument is not verified before it is accessed, this may lead to an exception in the case of 
using an invalid pointer. For example, the next code leads the Cuckoo monitor to crash.
<br /><br />
<b>Code sample</b></p>

<figure class="highlight"><pre><code class="language-c" data-lang="c"><span class="n">NtDelayExecution</span><span class="p">(</span><span class="n">FALSE</span><span class="p">,</span> <span class="p">(</span><span class="n">PLARGE_INTEGER</span><span class="p">)</span><span class="mh">0xFFDF0000</span><span class="p">);</span></code></pre></figure>

<p>As stated earlier, normally this call should return <tt>STATUS_ACCESS_VIOLATION</tt> without causing an exception.</p>

<p><b>Countermeasures</b></p>
<p></p>

<p>Hooked functions should check arguments and return appropriate error codes if arguments are invalid.</p>

<p><br /></p>
<h3><a class="a-dummy" name="countermeasures">Countermeasures</a></h3>

<p>Countermeasures are present in the appropriate sub-sections above.</p>

<p><br /></p>
<h3><a class="a-dummy" name="credits">Credits</a></h3>

<p>Credits go to open-source projects from where code samples were taken:</p>
<ul>
<li>al-khaser project on <a href="https://github.com/LordNoteworthy/al-khaser">GitHub</a></li>
</ul>

    <br>
    <div style="text-align: left">
        <a href="..">Go back</a>
    </div>
    <br>
    <div class="sharebuttons" style="text-align: center">
        <hr />
        <ul>
          <li>
            <p class="sharetitle"> Share this: </p>
          </li>
          <li class="reddit">
            <a href="http://www.reddit.com/submit?url=https://evasions.checkpoint.com/src/Evasions/techniques/timing.html&title=Evasions:%20Timing - Evasion Techniques" target="_blank">
                <svg xmlns="http://www.w3.org/2000/svg"
                aria-label="Reddit" role="img"
                viewBox="0 0 512 512"><rect
                width="512" height="512"
                rx="15%"
                fill="#f40"/><g fill="#fff"><ellipse cx="256" cy="307" rx="166" ry="117"/><circle cx="106" cy="256" r="42"/><circle cx="407" cy="256" r="42"/><circle cx="375" cy="114" r="32"/></g><g stroke-linecap="round" stroke-linejoin="round" fill="none"><path d="m256 196 23-101 73 15" stroke="#fff" stroke-width="16"/><path d="m191 359c33 25 97 26 130 0" stroke="#f40" stroke-width="13"/></g><g fill="#f40"><circle cx="191" cy="287" r="31"/><circle cx="321" cy="287" r="31"/></g></svg>
                
            </a>
          </li>
          <li class="hn">
            <a href="http://news.ycombinator.com/submitlink?u=https://evasions.checkpoint.com/src/Evasions/techniques/timing.html&t=Evasions:%20Timing - Evasion Techniques" target="_blank">
                <svg xmlns="http://www.w3.org/2000/svg"
                aria-label="Hacker News" role="img"
                viewBox="0 0 512 512"><rect
                width="512" height="512"
                rx="15%"
                fill="#f60"/><path fill="#fff" d="M124 91h51l81 162 81-164h51L276 293v136h-40V293z"/></svg>
            </a>
          </li>
          <li class="twitter">
            <a href="https://twitter.com/intent/tweet?via=_CPResearch_&url=https://evasions.checkpoint.com/src/Evasions/techniques/timing.html&text=Evasions:%20Timing - Evasion Techniques" target="_blank">
                <svg viewBox="0 0 1792 1792" xmlns="http://www.w3.org/2000/svg"><path d="M1684 408q-67 98-162 167 1 14 1 42 0 130-38 259.5t-115.5 248.5-184.5 210.5-258 146-323 54.5q-271 0-496-145 35 4 78 4 225 0 401-138-105-2-188-64.5t-114-159.5q33 5 61 5 43 0 85-11-112-23-185.5-111.5t-73.5-205.5v-4q68 38 146 41-66-44-105-115t-39-154q0-88 44-163 121 149 294.5 238.5t371.5 99.5q-8-38-8-74 0-134 94.5-228.5t228.5-94.5q140 0 236 102 109-21 205-78-37 115-142 178 93-10 186-50z"/></svg>
            </a>
          </li>
          <li class="linkedin">
            <a href=https://www.linkedin.com/shareArticle?mini=true&url=https://evasions.checkpoint.com/src/Evasions/techniques/timing.html&title=Evasions:%20Timing - Evasion Techniques&source=LinkedIn" target="_blank">
                <svg viewBox="0 0 1792 1792" xmlns="http://www.w3.org/2000/svg"><path d="M477 625v991h-330v-991h330zm21-306q1 73-50.5 122t-135.5 49h-2q-82 0-132-49t-50-122q0-74 51.5-122.5t134.5-48.5 133 48.5 51 122.5zm1166 729v568h-329v-530q0-105-40.5-164.5t-126.5-59.5q-63 0-105.5 34.5t-63.5 85.5q-11 30-11 81v553h-329q2-399 2-647t-1-296l-1-48h329v144h-2q20-32 41-56t56.5-52 87-43.5 114.5-15.5q171 0 275 113.5t104 332.5z"/></svg>
            </a>
          </li>
        </ul>
      </div>
      
</article>


</section>

<nav class="navbar navbar-default navbar-fixed-bottom">
  <div class="container footer-content">

    Made with <font class="a-pink"><i class ="fa fa-heart"></i></font> to serve the community by Check Point Research    |    <a class="a-pink" href="https://research.checkpoint.com">Research blog</a>    |    <a class="a-pink" href="https://research.checkpoint.com/about-us/">About Us</a>    |    <a class="a-pink" href="https://github.com/CheckPointSW"><i class="fa fa-github fa-lg"></i></a> <a class="a-pink" href="https://twitter.com/_CPResearch_"><i class="fa fa-twitter fa-lg"></i></a>
    
    <br>
    
    © 1994-2024 Check Point Software Technologies LTD | All rights reserved | Property of CheckPoint.com


  </div>
</nav>

  </body>

</html>
<!DOCTYPE html>
<html>

  <head>
  <meta charset="utf-8">
  <meta http-equiv="X-UA-Compatible" content="IE=edge">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-194688-3"></script>
  <script>
   window.dataLayer = window.dataLayer || [];
   function gtag(){dataLayer.push(arguments);}
   gtag('js', new Date());
   gtag('config', 'UA-194688-3');
  </script>
  <meta content="Evasion techniques" property="og:site_name">

  <meta content="Evasions: UI artifacts" property="og:title">


  <meta name="twitter:title" content="Malware Evasion Encyclopedia" />
  <meta name="twitter:image" content="https://research.checkpoint.com/wp-content/uploads/2020/02/evasions.jpg" />


  <meta content="article" property="og:type">


  <meta content="Evasion techniques
" property="og:description">


  <meta content="https://evasions.checkpoint.com/src/Evasions/techniques/ui-artifacts.html" property="og:url">


  <meta content="2024-07-10T07:20:28+00:00" property="article:published_time">
  <meta content="https://evasions.checkpoint.com/about/" property="article:author">


  <meta property="og:image" content="">


  
  <meta content="evasions" property="article:section">
  


  
  <meta content="ui-artifacts" property="article:tag">
  

  <title>Evasions: UI artifacts</title>
  <meta name="description" content="Contents">
<script src="https://ajax.googleapis.com/ajax/libs/jquery/2.2.2/jquery.min.js"></script>
<script src="https://maxcdn.bootstrapcdn.com/bootstrap/3.3.6/js/bootstrap.min.js" integrity="sha384-0mSbJDEHialfmuBBQP6A4Qrprq5OVfW37PRR3j5ELqxss1yVqOtnepnHVP9aJ7xS" crossorigin="anonymous"></script>
  <link rel="stylesheet" href="https://evasions.checkpoint.com/assets/css/main.css">
<script src="https://maxcdn.bootstrapcdn.com/bootstrap/3.3.6/js/bootstrap.min.js" integrity="sha384-0mSbJDEHialfmuBBQP6A4Qrprq5OVfW37PRR3j5ELqxss1yVqOtnepnHVP9aJ7xS" crossorigin="anonymous"></script>

  <link href='https://fonts.googleapis.com/css?family=PT+Sans' rel='stylesheet' type='text/css'>
  <link href='https://fonts.googleapis.com/css?family=Fira+Mono' rel='stylesheet' type='text/css'>
  <link href='https://fonts.googleapis.com/css?family=Lato:400,700' rel='stylesheet' type='text/css'>
  <link href='https://fonts.googleapis.com/css?family=Source+Code+Pro:400,200,300,500,600,700,900' rel='stylesheet' type='text/css'>
  <link href='https://fonts.googleapis.com/css?family=Gentium+Basic:400,700' rel='stylesheet' type='text/css'>
  <link href='https://fonts.googleapis.com/css?family=Alegreya:400,400italic,700' rel='stylesheet' type='text/css'>
  <link href='https://fonts.googleapis.com/css?family=Lora:400,400italic,700' rel='stylesheet' type='text/css'>
  <link href='https://fonts.googleapis.com/css?family=Fira+Sans:400,300,500,700' rel='stylesheet' type='text/css'>
  <script src="https://ajax.googleapis.com/ajax/libs/jquery/2.2.0/jquery.min.js"></script>
  <link href='https://fonts.googleapis.com/css?family=Open+Sans:400,700' rel='stylesheet' type='text/css'>
  <link href="https://maxcdn.bootstrapcdn.com/bootstrap/3.3.6/css/bootstrap.min.css" rel="stylesheet" integrity="sha384-1q8mTJOASx8j1Au+a5WDVnPi2lkFfwwEAa8hDDdjZlpLegxhjVME1fgjWPGmkzs7" crossorigin="anonymous">
  <link href="https://maxcdn.bootstrapcdn.com/font-awesome/4.6.1/css/font-awesome.min.css" rel="stylesheet" integrity="sha384-hQpvDQiCJaD2H465dQfA717v7lu5qHWtDbWNPvaTJ0ID5xnPUlVXnKzq7b8YUkbN" crossorigin="anonymous">
  <link rel="canonical" href="https://evasions.checkpoint.com/src/Evasions/techniques/ui-artifacts.html">
  <link rel="alternate" type="application/rss+xml" title="Evasion techniques" href="https://evasions.checkpoint.com/feed.xml">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/tinysort/2.3.6/tinysort.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/tinysort/2.3.6/tinysort.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/tinysort/2.3.6/tinysort.charorder.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/tinysort/2.3.6/tinysort.charorder.min.js"></script>
  <script type="text/javascript" async src="//platform.twitter.com/widgets.js"></script>




</head>


  <body>
<section>
<article class="post" itemscope itemtype="http://schema.org/BlogPosting">
  <div class="jumbotron">
    <div class="container">
      <h1 class="post-title-main" itemprop="name headline">Evasions: UI artifacts</h1>
    </div>
</div>

  <div class="post-content container" itemprop="articleBody">
    <div style="text-align: left">
        <a href="..">Go back</a>
        <br>
        <br>
    </div>
    <h1>Contents</h1>

<p><a href="#ui-artifacts-detection-methods">UI artifacts detection methods</a>
<br />
  <a href="#check-windows-with-certain-class">1. Check if windows with certain class names are present in the OS</a>
<br />
  <a href="#check-number-of-top-level-windows">2. Check if top level windows’ number is too small</a>
<br />
  <a href="#signature-recommendations">Signature recommendations</a>
<br />
  <a href="#countermeasures">Countermeasures</a>
<br />
  <a href="#credits">Credits</a>
<br />
<br /></p>

<hr class="space" />

<h2><a class="a-dummy" name="ui-artifacts-detection-methods">UI artifacts detection methods</a></h2>
<p>Techniques described in this group abuse the fact that some windows’ names are only present in virtual environment and not is usual host OS. Even more, host OS contains a lot of windows while VM and sandboxes prefer keeping opened windows at the minimum. Their quantity is checked and the conclusion is drawn whether it is a VM or not.</p>

<p><br /></p>
<h3><a class="a-dummy" name="check-windows-with-certain-class">1. Check if windows with certain class names are present in the OS</a></h3>

<p><b>Detections table</b></p>

<table style="width:60%">
  <tr>
    <td colspan="2">Check if windows with the following class names are present in the OS:</td>
  </tr>
  <tr>
    <th style="text-align:center">Detect</th>
    <th style="text-align:center">Class name</th>
  </tr>
  <tr>
    <th rowspan="2">VirtualBox</th>
    <th>VBoxTrayToolWndClass</th>
  </tr>
  <tr>
    <td>VBoxTrayToolWnd</td>
  </tr>
</table>

<hr class="space" />

<p><b>Code sample</b></p>
<p></p>

<figure class="highlight"><pre><code class="language-c" data-lang="c"><span class="n">BOOL</span> <span class="nf">vbox_window_class</span><span class="p">()</span>
<span class="p">{</span>
  <span class="n">HWND</span> <span class="n">hClass</span> <span class="o">=</span> <span class="n">FindWindow</span><span class="p">(</span><span class="n">_T</span><span class="p">(</span><span class="s">"VBoxTrayToolWndClass"</span><span class="p">),</span> <span class="nb">NULL</span><span class="p">);</span>
  <span class="n">HWND</span> <span class="n">hWindow</span> <span class="o">=</span> <span class="n">FindWindow</span><span class="p">(</span><span class="nb">NULL</span><span class="p">,</span> <span class="n">_T</span><span class="p">(</span><span class="s">"VBoxTrayToolWnd"</span><span class="p">));</span>

  <span class="k">if</span> <span class="p">(</span><span class="n">hClass</span> <span class="o">||</span> <span class="n">hWindow</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">TRUE</span><span class="p">;</span>
  <span class="k">else</span>
    <span class="k">return</span> <span class="n">FALSE</span><span class="p">;</span>
<span class="p">}</span></code></pre></figure>

<p><i>Credits for this code sample: <a href="https://github.com/LordNoteworthy/al-khaser">al-khaser project</a></i></p>

<p><br /></p>
<h3><a class="a-dummy" name="check-number-of-top-level-windows">2. Check if top level windows' number is too small</a></h3>
<p>As it was stated above, host OS contains a lot of windows while VMs and sandboxes strive to keep opened windows at possible minimum. Windows count is measured and the conclusion is drawn on whether it’s a VM or not.
<br />
In case there are too few windows in the OS, it could be an indication of virtual environment. Typical hosts have a lot (&gt;10) top level windows.</p>

<hr class="space" />

<p><b>Code sample</b></p>
<p></p>

<figure class="highlight"><pre><code class="language-c" data-lang="c"><span class="n">BOOL</span> <span class="n">CALLBACK</span> <span class="nf">enumProc</span><span class="p">(</span><span class="n">HWND</span><span class="p">,</span> <span class="n">LPARAM</span> <span class="n">lParam</span><span class="p">)</span>
<span class="p">{</span>
    <span class="k">if</span> <span class="p">(</span><span class="n">LPDWORD</span> <span class="n">pCnt</span> <span class="o">=</span> <span class="n">reinterpret_cast</span><span class="o">&lt;</span><span class="n">LPDWORD</span><span class="o">&gt;</span><span class="p">(</span><span class="n">lParam</span><span class="p">))</span>
        <span class="o">*</span><span class="n">pCnt</span><span class="o">++</span><span class="p">;</span>
    <span class="k">return</span> <span class="n">TRUE</span><span class="p">;</span>
<span class="p">}</span>

<span class="n">bool</span> <span class="nf">enumWindowsCheck</span><span class="p">(</span><span class="n">bool</span><span class="o">&amp;</span> <span class="n">detected</span><span class="p">)</span>
<span class="p">{</span>
    <span class="n">DWORD</span> <span class="n">winCnt</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

    <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">EnumWindows</span><span class="p">(</span><span class="n">enumProc</span><span class="p">,</span><span class="n">LPARAM</span><span class="p">(</span><span class="o">&amp;</span><span class="n">winCnt</span><span class="p">)))</span> <span class="p">{</span>
        <span class="n">std</span><span class="o">::</span><span class="n">cerr</span> <span class="o">&lt;&lt;</span> <span class="s">"EnumWindows() failed</span><span class="se">\n</span><span class="s">"</span><span class="p">;</span>
        <span class="k">return</span> <span class="nb">false</span><span class="p">;</span>
    <span class="p">}</span>

    <span class="k">return</span> <span class="n">winCnt</span> <span class="o">&lt;</span> <span class="mi">10</span><span class="p">;</span>
<span class="p">}</span></code></pre></figure>

<p><br /></p>
<h3><a class="a-dummy" name="signature-recommendations">Signature recommendations</a></h3>
<p><i>No signature recommendations are provided for this evasion group as it’s hard to tell that code aims to perform some evasion technique and not “legal” action.</i></p>

<p><br /></p>
<h3><a class="a-dummy" name="countermeasures">Countermeasures</a></h3>

<ul>
<li><tt>versus windows with certain class names:</tt> Exclude windows with particular names from enumeration or modify these names.</li> 
<li><tt>versus checking top level windows' number:</tt> Create fake windows in the system so that their number will not be small or equal to the predefined numbers.</li> 
</ul>

<p><br /></p>
<h3><a class="a-dummy" name="credits">Credits</a></h3>

<p>Credits go to open-source project from where code samples were taken:</p>
<ul>
<li>al-khaser project on <a href="https://github.com/LordNoteworthy/al-khaser">github</a></li>
</ul>

<p>Though Check Point tool InviZzzible has them all implemented, due to modular structure of the code it would require more space to show a code sample from this tool for the same purposes. That’s why we’ve decided to use other great open-source projects for examples throughout the encyclopedia.</p>


    <br>
    <div style="text-align: left">
        <a href="..">Go back</a>
    </div>
    <br>
    <div class="sharebuttons" style="text-align: center">
        <hr />
        <ul>
          <li>
            <p class="sharetitle"> Share this: </p>
          </li>
          <li class="reddit">
            <a href="http://www.reddit.com/submit?url=https://evasions.checkpoint.com/src/Evasions/techniques/ui-artifacts.html&title=Evasions:%20UI%20artifacts - Evasion Techniques" target="_blank">
                <svg xmlns="http://www.w3.org/2000/svg"
                aria-label="Reddit" role="img"
                viewBox="0 0 512 512"><rect
                width="512" height="512"
                rx="15%"
                fill="#f40"/><g fill="#fff"><ellipse cx="256" cy="307" rx="166" ry="117"/><circle cx="106" cy="256" r="42"/><circle cx="407" cy="256" r="42"/><circle cx="375" cy="114" r="32"/></g><g stroke-linecap="round" stroke-linejoin="round" fill="none"><path d="m256 196 23-101 73 15" stroke="#fff" stroke-width="16"/><path d="m191 359c33 25 97 26 130 0" stroke="#f40" stroke-width="13"/></g><g fill="#f40"><circle cx="191" cy="287" r="31"/><circle cx="321" cy="287" r="31"/></g></svg>
                
            </a>
          </li>
          <li class="hn">
            <a href="http://news.ycombinator.com/submitlink?u=https://evasions.checkpoint.com/src/Evasions/techniques/ui-artifacts.html&t=Evasions:%20UI%20artifacts - Evasion Techniques" target="_blank">
                <svg xmlns="http://www.w3.org/2000/svg"
                aria-label="Hacker News" role="img"
                viewBox="0 0 512 512"><rect
                width="512" height="512"
                rx="15%"
                fill="#f60"/><path fill="#fff" d="M124 91h51l81 162 81-164h51L276 293v136h-40V293z"/></svg>
            </a>
          </li>
          <li class="twitter">
            <a href="https://twitter.com/intent/tweet?via=_CPResearch_&url=https://evasions.checkpoint.com/src/Evasions/techniques/ui-artifacts.html&text=Evasions:%20UI%20artifacts - Evasion Techniques" target="_blank">
                <svg viewBox="0 0 1792 1792" xmlns="http://www.w3.org/2000/svg"><path d="M1684 408q-67 98-162 167 1 14 1 42 0 130-38 259.5t-115.5 248.5-184.5 210.5-258 146-323 54.5q-271 0-496-145 35 4 78 4 225 0 401-138-105-2-188-64.5t-114-159.5q33 5 61 5 43 0 85-11-112-23-185.5-111.5t-73.5-205.5v-4q68 38 146 41-66-44-105-115t-39-154q0-88 44-163 121 149 294.5 238.5t371.5 99.5q-8-38-8-74 0-134 94.5-228.5t228.5-94.5q140 0 236 102 109-21 205-78-37 115-142 178 93-10 186-50z"/></svg>
            </a>
          </li>
          <li class="linkedin">
            <a href=https://www.linkedin.com/shareArticle?mini=true&url=https://evasions.checkpoint.com/src/Evasions/techniques/ui-artifacts.html&title=Evasions:%20UI%20artifacts - Evasion Techniques&source=LinkedIn" target="_blank">
                <svg viewBox="0 0 1792 1792" xmlns="http://www.w3.org/2000/svg"><path d="M477 625v991h-330v-991h330zm21-306q1 73-50.5 122t-135.5 49h-2q-82 0-132-49t-50-122q0-74 51.5-122.5t134.5-48.5 133 48.5 51 122.5zm1166 729v568h-329v-530q0-105-40.5-164.5t-126.5-59.5q-63 0-105.5 34.5t-63.5 85.5q-11 30-11 81v553h-329q2-399 2-647t-1-296l-1-48h329v144h-2q20-32 41-56t56.5-52 87-43.5 114.5-15.5q171 0 275 113.5t104 332.5z"/></svg>
            </a>
          </li>
        </ul>
      </div>
      
</article>


</section>

<nav class="navbar navbar-default navbar-fixed-bottom">
  <div class="container footer-content">

    Made with <font class="a-pink"><i class ="fa fa-heart"></i></font> to serve the community by Check Point Research    |    <a class="a-pink" href="https://research.checkpoint.com">Research blog</a>    |    <a class="a-pink" href="https://research.checkpoint.com/about-us/">About Us</a>    |    <a class="a-pink" href="https://github.com/CheckPointSW"><i class="fa fa-github fa-lg"></i></a> <a class="a-pink" href="https://twitter.com/_CPResearch_"><i class="fa fa-twitter fa-lg"></i></a>
    
    <br>
    
    © 1994-2024 Check Point Software Technologies LTD | All rights reserved | Property of CheckPoint.com


  </div>
</nav>

  </body>

</html>
<!DOCTYPE html>
<html>

  <head>
  <meta charset="utf-8">
  <meta http-equiv="X-UA-Compatible" content="IE=edge">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-194688-3"></script>
  <script>
   window.dataLayer = window.dataLayer || [];
   function gtag(){dataLayer.push(arguments);}
   gtag('js', new Date());
   gtag('config', 'UA-194688-3');
  </script>
  <meta content="Evasion techniques" property="og:site_name">

  <meta content="Evasions: WMI" property="og:title">


  <meta name="twitter:title" content="Malware Evasion Encyclopedia" />
  <meta name="twitter:image" content="https://research.checkpoint.com/wp-content/uploads/2020/02/evasions.jpg" />


  <meta content="article" property="og:type">


  <meta content="Evasion techniques
" property="og:description">


  <meta content="https://evasions.checkpoint.com/src/Evasions/techniques/wmi.html" property="og:url">


  <meta content="2024-07-10T07:20:28+00:00" property="article:published_time">
  <meta content="https://evasions.checkpoint.com/about/" property="article:author">


  <meta property="og:image" content="">


  
  <meta content="evasions" property="article:section">
  


  
  <meta content="wmi" property="article:tag">
  

  <title>Evasions: WMI</title>
  <meta name="description" content="Contents">
<script src="https://ajax.googleapis.com/ajax/libs/jquery/2.2.2/jquery.min.js"></script>
<script src="https://maxcdn.bootstrapcdn.com/bootstrap/3.3.6/js/bootstrap.min.js" integrity="sha384-0mSbJDEHialfmuBBQP6A4Qrprq5OVfW37PRR3j5ELqxss1yVqOtnepnHVP9aJ7xS" crossorigin="anonymous"></script>
  <link rel="stylesheet" href="https://evasions.checkpoint.com/assets/css/main.css">
<script src="https://maxcdn.bootstrapcdn.com/bootstrap/3.3.6/js/bootstrap.min.js" integrity="sha384-0mSbJDEHialfmuBBQP6A4Qrprq5OVfW37PRR3j5ELqxss1yVqOtnepnHVP9aJ7xS" crossorigin="anonymous"></script>

  <link href='https://fonts.googleapis.com/css?family=PT+Sans' rel='stylesheet' type='text/css'>
  <link href='https://fonts.googleapis.com/css?family=Fira+Mono' rel='stylesheet' type='text/css'>
  <link href='https://fonts.googleapis.com/css?family=Lato:400,700' rel='stylesheet' type='text/css'>
  <link href='https://fonts.googleapis.com/css?family=Source+Code+Pro:400,200,300,500,600,700,900' rel='stylesheet' type='text/css'>
  <link href='https://fonts.googleapis.com/css?family=Gentium+Basic:400,700' rel='stylesheet' type='text/css'>
  <link href='https://fonts.googleapis.com/css?family=Alegreya:400,400italic,700' rel='stylesheet' type='text/css'>
  <link href='https://fonts.googleapis.com/css?family=Lora:400,400italic,700' rel='stylesheet' type='text/css'>
  <link href='https://fonts.googleapis.com/css?family=Fira+Sans:400,300,500,700' rel='stylesheet' type='text/css'>
  <script src="https://ajax.googleapis.com/ajax/libs/jquery/2.2.0/jquery.min.js"></script>
  <link href='https://fonts.googleapis.com/css?family=Open+Sans:400,700' rel='stylesheet' type='text/css'>
  <link href="https://maxcdn.bootstrapcdn.com/bootstrap/3.3.6/css/bootstrap.min.css" rel="stylesheet" integrity="sha384-1q8mTJOASx8j1Au+a5WDVnPi2lkFfwwEAa8hDDdjZlpLegxhjVME1fgjWPGmkzs7" crossorigin="anonymous">
  <link href="https://maxcdn.bootstrapcdn.com/font-awesome/4.6.1/css/font-awesome.min.css" rel="stylesheet" integrity="sha384-hQpvDQiCJaD2H465dQfA717v7lu5qHWtDbWNPvaTJ0ID5xnPUlVXnKzq7b8YUkbN" crossorigin="anonymous">
  <link rel="canonical" href="https://evasions.checkpoint.com/src/Evasions/techniques/wmi.html">
  <link rel="alternate" type="application/rss+xml" title="Evasion techniques" href="https://evasions.checkpoint.com/feed.xml">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/tinysort/2.3.6/tinysort.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/tinysort/2.3.6/tinysort.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/tinysort/2.3.6/tinysort.charorder.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/tinysort/2.3.6/tinysort.charorder.min.js"></script>
  <script type="text/javascript" async src="//platform.twitter.com/widgets.js"></script>




</head>


  <body>
<section>
<article class="post" itemscope itemtype="http://schema.org/BlogPosting">
  <div class="jumbotron">
    <div class="container">
      <h1 class="post-title-main" itemprop="name headline">Evasions: WMI</h1>
    </div>
</div>

  <div class="post-content container" itemprop="articleBody">
    <div style="text-align: left">
        <a href="..">Go back</a>
        <br>
        <br>
    </div>
    <h1>Contents</h1>

<p><a href="#wmi-detection-methods">WMI detection methods</a>
<br />
<a href="#background">Background</a>
<br />
  <a href="#generic-wmi-queries">1. Generic WMI queries</a>
<br />
  <a href="#escape-from-tracking">2. Escape from tracking using WMI</a>
<br />
  <a href="#wmi-process">2.1. Start process using WMI</a>
<br />
  <a href="#wmi-tsched">2.2. Start process using Task Scheduler via WMI</a>
<br />
  <a href="#check-last-boot-time">3. Check the last boot time</a>
<br />
  <a href="#check-network-adapter-reset-time">4. Check the network adapter last reset time</a>
<br />
  <a href="#signature-recommendations">Signature recommendations</a>
<br />
  <a href="#countermeasures">Countermeasures</a>
<br />
  <a href="#credits">Credits</a>
<br />
<br /></p>

<hr class="space" />

<h2><a class="a-dummy" name="wmi-detection-methods">WMI detection methods</a></h2>
<p>Windows Management Interface (WMI) queries are another way to get OS and hardware information. WMI uses COM interfaces and their methods.</p>

<hr class="space" />

<h2><a class="a-dummy" name="background">Background</a></h2>

<p>Standard COM functions are used to process queries. They are called in the sequence described below and can be split into 6 steps.</p>

<p>1. COM initialization:</p>
<ul>
<li><tt>CoInitialize/CoInitializeEx</tt></li> 
</ul>

<hr class="space" />

<p>2. Create the required interface instance:</p>
<ul>
<li><tt>CoCreateInstance/CoCreateInstanceEx</tt></li> 
</ul>

<hr class="space" />

<p>3. Connect to the particular services via the interface instance with the following function:</p>
<ul>
<li><tt>ConnectServer</tt></li> 
</ul>

<hr class="space" />

<p>4. Get methods of the services and set their arguments with these functions:</p>
<ul>
<li><tt>Method</tt> (to get methods)</li> 
<li><tt>Put</tt> (to set arguments)</li> 
</ul>

<hr class="space" />

<p>5. Retrieve information from the services and execute the methods of the services with the functions below. The functions on the left are proxies for the functions on the right - which are called internally:</p>
<ul>
<li><tt>ExecQuery -&gt; IWbemServices_ExecQuery</tt> (retrieve information)</li>
<li><tt>ExecMethod -&gt; IWbemServices_ExecMethod</tt> (execute method)</li>
<li><tt>ExecMethodAsync -&gt; IWbemServices_ExecMethodAsync</tt> (execute method)</li>
</ul>

<hr class="space" />

<p>6. Examine the result of the query with the following functions:</p>
<ul>
<li><tt>[enumerator]-&gt;Next</tt></li> 
<li><tt>[object]-&gt;Get</tt></li> 
</ul>

<hr class="space" />

<p>To see how the described theory is applied to practice, please check the examples below.</p>

<p><br /></p>
<h3><a class="a-dummy" name="generic-wmi-queries">1. Generic WMI queries</a></h3>
<p>As WMI provides another way to collect system information, it can be used to perform evasion techniques described in other articles, for example:</p>
<ul>
<li><a href="generic-os-queries.html#check-if-number-of-processors">Check if the number of processors is low</a></li>
<li><a href="generic-os-queries.html#check-if-hard-disk">Check if the hard disk size is small</a></li>
<li><a href="network.html#check-if-mac-address-is-specific">Check if the MAC address is specific</a></li>
<li><a href="hardware.html#check-if-cpu-temperature-information-is-available">Check if the CPU temperature information is available</a></li>
</ul>

<p><b>Code sample</b></p>
<p></p>

<figure class="highlight"><pre><code class="language-c" data-lang="c"><span class="cm">/*
Check number of cores using WMI
*/</span>
<span class="n">BOOL</span> <span class="nf">number_cores_wmi</span><span class="p">()</span>
<span class="p">{</span>
  <span class="n">IWbemServices</span> <span class="o">*</span><span class="n">pSvc</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
  <span class="n">IWbemLocator</span> <span class="o">*</span><span class="n">pLoc</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
  <span class="n">IEnumWbemClassObject</span> <span class="o">*</span><span class="n">pEnumerator</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
  <span class="n">BOOL</span> <span class="n">bStatus</span> <span class="o">=</span> <span class="n">FALSE</span><span class="p">;</span>
  <span class="n">HRESULT</span> <span class="n">hRes</span><span class="p">;</span>
  <span class="n">BOOL</span> <span class="n">bFound</span> <span class="o">=</span> <span class="n">FALSE</span><span class="p">;</span>

  <span class="c1">// Init WMI</span>
  <span class="n">bStatus</span> <span class="o">=</span> <span class="n">InitWMI</span><span class="p">(</span><span class="o">&amp;</span><span class="n">pSvc</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">pLoc</span><span class="p">);</span>
  <span class="k">if</span> <span class="p">(</span><span class="n">bStatus</span><span class="p">)</span>
  <span class="p">{</span>
    <span class="c1">// If success, execute the desired query</span>
    <span class="n">bStatus</span> <span class="o">=</span> <span class="n">ExecWMIQuery</span><span class="p">(</span><span class="o">&amp;</span><span class="n">pSvc</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">pLoc</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">pEnumerator</span><span class="p">,</span> <span class="n">_T</span><span class="p">(</span><span class="s">"SELECT * FROM Win32_Processor"</span><span class="p">));</span>
    <span class="k">if</span> <span class="p">(</span><span class="n">bStatus</span><span class="p">)</span>
    <span class="p">{</span>
      <span class="c1">// Get the data from the query</span>
      <span class="n">IWbemClassObject</span> <span class="o">*</span><span class="n">pclsObj</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
      <span class="n">ULONG</span> <span class="n">uReturn</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
      <span class="n">VARIANT</span> <span class="n">vtProp</span><span class="p">;</span>

      <span class="c1">// Iterate over our enumator</span>
      <span class="k">while</span> <span class="p">(</span><span class="n">pEnumerator</span><span class="p">)</span>
      <span class="p">{</span>
        <span class="n">hRes</span> <span class="o">=</span> <span class="n">pEnumerator</span><span class="o">-&gt;</span><span class="n">Next</span><span class="p">(</span><span class="n">WBEM_INFINITE</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">pclsObj</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">uReturn</span><span class="p">);</span>
        <span class="k">if</span> <span class="p">(</span><span class="mi">0</span> <span class="o">==</span> <span class="n">uReturn</span><span class="p">)</span>
          <span class="k">break</span><span class="p">;</span>

        <span class="c1">// Get the value of the Name property</span>
        <span class="n">hRes</span> <span class="o">=</span> <span class="n">pclsObj</span><span class="o">-&gt;</span><span class="n">Get</span><span class="p">(</span><span class="n">_T</span><span class="p">(</span><span class="s">"NumberOfCores"</span><span class="p">),</span> <span class="mi">0</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">vtProp</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
        <span class="k">if</span> <span class="p">(</span><span class="n">V_VT</span><span class="p">(</span><span class="o">&amp;</span><span class="n">vtProp</span><span class="p">)</span> <span class="o">!=</span> <span class="n">VT_NULL</span><span class="p">)</span> <span class="p">{</span>

          <span class="c1">// Do our comparaison</span>
          <span class="k">if</span> <span class="p">(</span><span class="n">vtProp</span><span class="p">.</span><span class="n">uintVal</span> <span class="o">&lt;</span> <span class="mi">2</span><span class="p">)</span> <span class="p">{</span>
            <span class="n">bFound</span> <span class="o">=</span> <span class="n">TRUE</span><span class="p">;</span> <span class="k">break</span><span class="p">;</span>
          <span class="p">}</span>

          <span class="c1">// release the current result object</span>
          <span class="n">VariantClear</span><span class="p">(</span><span class="o">&amp;</span><span class="n">vtProp</span><span class="p">);</span>
          <span class="n">pclsObj</span><span class="o">-&gt;</span><span class="n">Release</span><span class="p">();</span>
        <span class="p">}</span>
      <span class="p">}</span>

      <span class="c1">// Cleanup</span>
      <span class="n">pEnumerator</span><span class="o">-&gt;</span><span class="n">Release</span><span class="p">();</span>
      <span class="n">pSvc</span><span class="o">-&gt;</span><span class="n">Release</span><span class="p">();</span>
      <span class="n">pLoc</span><span class="o">-&gt;</span><span class="n">Release</span><span class="p">();</span>
      <span class="n">CoUninitialize</span><span class="p">();</span>
    <span class="p">}</span>
  <span class="p">}</span>

  <span class="k">return</span> <span class="n">bFound</span><span class="p">;</span>
<span class="p">}</span>


<span class="cm">/*
Check hard disk size using WMI
*/</span>
<span class="n">BOOL</span> <span class="nf">disk_size_wmi</span><span class="p">()</span>
<span class="p">{</span>
  <span class="n">IWbemServices</span> <span class="o">*</span><span class="n">pSvc</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
  <span class="n">IWbemLocator</span> <span class="o">*</span><span class="n">pLoc</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
  <span class="n">IEnumWbemClassObject</span> <span class="o">*</span><span class="n">pEnumerator</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
  <span class="n">BOOL</span> <span class="n">bStatus</span> <span class="o">=</span> <span class="n">FALSE</span><span class="p">;</span>
  <span class="n">HRESULT</span> <span class="n">hRes</span><span class="p">;</span>
  <span class="n">BOOL</span> <span class="n">bFound</span> <span class="o">=</span> <span class="n">FALSE</span><span class="p">;</span>
  <span class="n">INT64</span> <span class="n">minHardDiskSize</span> <span class="o">=</span> <span class="p">(</span><span class="mi">80LL</span> <span class="o">*</span> <span class="p">(</span><span class="mi">1024LL</span> <span class="o">*</span> <span class="p">(</span><span class="mi">1024LL</span> <span class="o">*</span> <span class="p">(</span><span class="mi">1024LL</span><span class="p">))));</span>

  <span class="c1">// Init WMI</span>
  <span class="n">bStatus</span> <span class="o">=</span> <span class="n">InitWMI</span><span class="p">(</span><span class="o">&amp;</span><span class="n">pSvc</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">pLoc</span><span class="p">);</span>
  <span class="k">if</span> <span class="p">(</span><span class="n">bStatus</span><span class="p">)</span>
  <span class="p">{</span>
    <span class="c1">// If success, execute the desired query</span>
    <span class="n">bStatus</span> <span class="o">=</span> <span class="n">ExecWMIQuery</span><span class="p">(</span><span class="o">&amp;</span><span class="n">pSvc</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">pLoc</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">pEnumerator</span><span class="p">,</span> <span class="n">_T</span><span class="p">(</span><span class="s">"SELECT * FROM Win32_LogicalDisk"</span><span class="p">));</span>
    <span class="k">if</span> <span class="p">(</span><span class="n">bStatus</span><span class="p">)</span>
    <span class="p">{</span>
      <span class="c1">// Get the data from the query</span>
      <span class="n">IWbemClassObject</span> <span class="o">*</span><span class="n">pclsObj</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
      <span class="n">ULONG</span> <span class="n">uReturn</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
      <span class="n">VARIANT</span> <span class="n">vtProp</span><span class="p">;</span>

      <span class="c1">// Iterate over our enumator</span>
      <span class="k">while</span> <span class="p">(</span><span class="n">pEnumerator</span><span class="p">)</span>
      <span class="p">{</span>
        <span class="n">hRes</span> <span class="o">=</span> <span class="n">pEnumerator</span><span class="o">-&gt;</span><span class="n">Next</span><span class="p">(</span><span class="n">WBEM_INFINITE</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">pclsObj</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">uReturn</span><span class="p">);</span>
        <span class="k">if</span> <span class="p">(</span><span class="mi">0</span> <span class="o">==</span> <span class="n">uReturn</span><span class="p">)</span>
          <span class="k">break</span><span class="p">;</span>

        <span class="c1">// Get the value of the Name property</span>
        <span class="n">hRes</span> <span class="o">=</span> <span class="n">pclsObj</span><span class="o">-&gt;</span><span class="n">Get</span><span class="p">(</span><span class="n">_T</span><span class="p">(</span><span class="s">"Size"</span><span class="p">),</span> <span class="mi">0</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">vtProp</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
        <span class="k">if</span> <span class="p">(</span><span class="n">V_VT</span><span class="p">(</span><span class="o">&amp;</span><span class="n">vtProp</span><span class="p">)</span> <span class="o">!=</span> <span class="n">VT_NULL</span><span class="p">)</span> <span class="p">{</span>

          <span class="c1">// Do our comparaison</span>
          <span class="k">if</span> <span class="p">(</span><span class="n">vtProp</span><span class="p">.</span><span class="n">llVal</span> <span class="o">&lt;</span> <span class="n">minHardDiskSize</span><span class="p">)</span> <span class="p">{</span> <span class="c1">// Less than 80GB</span>
            <span class="n">bFound</span> <span class="o">=</span> <span class="n">TRUE</span><span class="p">;</span> <span class="k">break</span><span class="p">;</span>
          <span class="p">}</span>

          <span class="c1">// release the current result object</span>
          <span class="n">VariantClear</span><span class="p">(</span><span class="o">&amp;</span><span class="n">vtProp</span><span class="p">);</span>
          <span class="n">pclsObj</span><span class="o">-&gt;</span><span class="n">Release</span><span class="p">();</span>
        <span class="p">}</span>
      <span class="p">}</span>

      <span class="c1">// Cleanup</span>
      <span class="n">pEnumerator</span><span class="o">-&gt;</span><span class="n">Release</span><span class="p">();</span>
      <span class="n">pSvc</span><span class="o">-&gt;</span><span class="n">Release</span><span class="p">();</span>
      <span class="n">pLoc</span><span class="o">-&gt;</span><span class="n">Release</span><span class="p">();</span>
      <span class="n">CoUninitialize</span><span class="p">();</span>
    <span class="p">}</span>
  <span class="p">}</span>

  <span class="k">return</span> <span class="n">bFound</span><span class="p">;</span>
<span class="p">}</span></code></pre></figure>

<p><i>Credits for this code sample: <a href="https://github.com/LordNoteworthy/al-khaser">al-khaser project</a></i></p>

<hr class="space" />

<p><b>Code sample (PowerShell)</b></p>

<figure class="highlight"><pre><code class="language-powershell" data-lang="powershell"><span class="p">(</span><span class="n">Get-CimInstance</span><span class="w"> </span><span class="nt">-ClassName</span><span class="w"> </span><span class="nx">Win32_BIOS</span><span class="w"> </span><span class="nt">-Property</span><span class="w"> </span><span class="nx">SerialNumber</span><span class="p">)</span><span class="o">.</span><span class="nf">SerialNumber</span></code></pre></figure>

<hr class="space" />

<p><b>Signature recommendations</b></p>
<p></p>
<p>If the following function contains a 3rd argument from the table column <font face="Courier New">"Query"</font>:</p>
<p></p>
<ul>
<li><tt>IWbemServices_ExecQuery(..., query, ...)</tt></li> 
</ul>
<p>then it’s an indicator of the application trying to use the evasion technique.</p>

<hr class="space" />

<p><b>Detections table</b></p>

<table>
  <tr>
    <td colspan="5">The following WMI queries may be used to detect virtual environment:</td>
  </tr>
  <tr>
    <th style="text-align:center">Query</th>
    <th style="text-align:center">Field</th>
    <th style="text-align:center">Value</th>
    <th style="text-align:center">Detect</th>
    <th style="text-align:center">Comments</th>
  </tr>
  <tr>
    <td rowspan="2">SELECT * FROM Win32_Processor</td>
    <td>NumberOfCores</td>
    <td>&lt; 2</td>
    <th rowspan="6">[general]</th>
    <td></td>
  </tr>
  <tr>
    <td>ProcessorId</td>
    <td>[empty]</td>
    <td></td>
  </tr>
  <tr>
    <td>SELECT * FROM Win32_LogicalDisk</td>
    <td>Size</td>
    <td>&lt; 60GB</td>
    <td></td>
  </tr>
  <tr>
    <td rowspan="2">SELECT * FROM Win32_BaseBoard</td>
    <td>SerialNumber</td>
    <td>None</td>
    <td></td>
  </tr>
  <tr>
    <td>Version</td>
    <td>None</td>
    <td></td>
  </tr>
  <tr>
    <td>SELECT * FROM MSAcpi_ThermalZoneTemperature</td>
    <td>CurrentTemperature</td>
    <td>"Not supported"</td>
    <td></td>
  </tr>
  <tr>
    <td rowspan="5">SELECT * FROM Win32_PnPEntity</td>
    <td rowspan="5">DeviceId</td>
    <td>PCI\VEN_80EE&amp;DEV_CAFE</td>
    <th rowspan="3">VirtualBox</th>
    <td></td>
  </tr>
  <tr>
    <td>IDE\CDROOMVBOX</td>
    <td></td>
  </tr>
  <tr>
    <td>IDE\DISKVBOX*</td>
    <td></td>
  </tr>
  <tr>
    <td>VEN_VMWARE</td>
    <th rowspan="2">VMware</th>
    <td></td>
  </tr>
  <tr>
    <td>PROD_VMWARE_VIRTUAL</td>
    <td></td>
  </tr>
  <tr>
    <td rowspan="7">SELECT * FROM Win32_NetworkAdapterConfiguration</td>
    <td rowspan="7">MACAddress</td>
    <td>08:00:27</td>
    <th>VirtualBox</th>
    <td>See <a href="network.html#check-if-mac-address-is-specific">"Check if MAC address is specific"</a> section in "Network" chapter</td>
  </tr>
  <tr>
    <td>00:1C:42</td>
    <th>Parallels</th>
    <td></td>
  </tr>
  <tr>
    <td>00:05:69</td>
    <th rowspan="4">VMware</th>
    <td></td>
  </tr>
  <tr>
    <td>00:0C:29</td>
    <td></td>
  </tr>
  <tr>
    <td>00:1C:14</td>
    <td></td>
  </tr>
  <tr>
    <td>00:50:56</td>
    <td></td>
  </tr>
  <tr>
    <td>00:16:E3</td>
    <th>XEN</th>
    <td></td>
  </tr>
  <tr>
    <td rowspan="7">SELECT * FROM Win32_Bios</td>
    <td rowspan="2">Serial Number</td>
    <td>VMware-</td>
    <th>VMware</th>
    <td></td>
  </tr>
  <tr>
    <td>0</td>
    <th>VirtualBox</th>
    <td></td>
  </tr>
  <tr>
    <td rowspan="5">Version</td>
    <td>INTEL - 6040000</td>
    <th>VMware</th>
    <td>See "SystemBiosVersion" in <a href="registry.html#check-if-keys-contain-strings">"Check if particular registry keys contain specified strings"</a> section in "Registry" chapter</td>
  </tr>
  <tr>
    <td>BOCHS</td>
    <th>BOCHS</th>
    <td></td>
  </tr>
  <tr>
    <td>PARALLELS</td>
    <th>Parallels</th>
    <td></td>
  </tr>
  <tr>
    <td>QEMU</td>
    <th>QEMU</th>
    <td></td>
  </tr>
  <tr>
    <td>VBOX</td>
    <th>VirtualBox</th>
    <td></td>
  </tr>
  <tr>
    <td rowspan="4">SELECT * FROM Win32_ComputerSystem</td>
    <td rowspan="2">Model</td>
    <td>VMware</td>
    <th>VMware</th>
    <td></td>
  </tr>
  <tr>
    <td>VirtualBox</td>
    <th>VirtualBox</th>
    <td></td>
  </tr>
  <tr>
    <td rowspan="2">Manufacturer</td>
    <td>VMware</td>
    <th>VMware</th>
    <td></td>
  </tr>
  <tr>
    <td>innotek GmbH</td>
    <th>VirtualBox</th>
    <td></td>
  </tr>
  <tr>
    <td rowspan="8">SELECT * FROM Win32_VideoController</td>
    <td rowspan="2">AdapterCompatibility</td>
    <td>VMware</td>
    <th>VMware</th>
    <td></td>
  </tr>
  <tr>
    <td>Oracle Corporation</td>
    <th>VirtualBox</th>
    <td></td>
  </tr>
  <tr>
    <td rowspan="2">Caption</td>
    <td>VMware</td>
    <th>VMware</th>
    <td></td>
  </tr>
  <tr>
    <td>VirtualBox</td>
    <th>VirtualBox</th>
    <td></td>
  </tr>
  <tr>
    <td rowspan="2">Description</td>
    <td>VMware</td>
    <th>VMware</th>
    <td></td>
  </tr>
  <tr>
    <td>VirtualBox</td>
    <th>VirtualBox</th>
    <td></td>
  </tr>
  <tr>
    <td rowspan="2">Name</td>
    <td>VMware</td>
    <th>VMware</th>
    <td></td>
  </tr>
  <tr>
    <td>VirtualBox</td>
    <th>VirtualBox</th>
    <td></td>
  </tr>
  <tr>
    <td>SELECT * FROM Win32_PointingDevice</td>
    <td>Description</td>
    <td>VMware</td>
    <th>VMware</th>
    <td></td>
  </tr>
</table>

<hr class="space" />

<p><i>Queries listed in the table are not the only ones possible, and are presented to give an idea of how they work and what information can be retrieved with these calls.</i></p>

<p></p>
<p><b>Countermeasures</b></p>
<p></p>
<p>Countermeasures depend on the particular checks implemented via the WMI method and they are the same as for the corresponding methods described in the relevant articles. Additionally, you must restart the “<tt>winmgmt</tt>” service.</p>

<hr class="space" />

<p><br /></p>
<h3><a class="a-dummy" name="escape-from-tracking">2. Escape from tracking using WMI</a></h3>
<p>WMI provides a way to create new processes and to schedule tasks. Sandboxes usually use the <tt>CreateProcessInternalW</tt> function hooking to track child processes. However, when you create the process using WMI the function <tt>CreateProcessInternalW</tt> is not called in the parent process. Therefore, the processes created using WMI may not be tracked by a sandbox and their behavior will not be recorded.
<br /></p>
<h4><a class="a-dummy" name="wmi-process">2.1. Start process using WMI</a></h4>
<p>You can create a new process with WMI using the “<tt>Win32_Process</tt>” class with the method “<tt>Create</tt>”.</p>

<p><b>Code sample</b></p>
<p></p>

<figure class="highlight"><pre><code class="language-c" data-lang="c"><span class="c1">// Initialize COM</span>
<span class="n">CoInitializeEx</span><span class="p">(</span><span class="nb">NULL</span><span class="p">,</span> <span class="n">COINIT_MULTITHREADED</span><span class="p">);</span>

<span class="c1">//  Set general COM security levels</span>
<span class="n">hres</span> <span class="o">=</span> <span class="n">CoInitializeSecurity</span><span class="p">(</span><span class="nb">NULL</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">,</span> <span class="n">RPC_C_AUTHN_LEVEL_DEFAULT</span><span class="p">,</span> <span class="n">RPC_C_IMP_LEVEL_IMPERSONATE</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">);</span>
<span class="k">if</span> <span class="p">(</span><span class="n">FAILED</span><span class="p">(</span><span class="n">hres</span><span class="p">)</span> <span class="o">&amp;&amp;</span> <span class="n">hres</span> <span class="o">!=</span> <span class="n">RPC_E_TOO_LATE</span><span class="p">)</span>
    <span class="k">break</span><span class="p">;</span>

<span class="c1">// create an instance of WbemLocator</span>
<span class="n">CoCreateInstance</span><span class="p">(</span><span class="n">CLSID_WbemLocator</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">,</span> <span class="n">CLSCTX_INPROC_SERVER</span><span class="p">,</span> <span class="n">IID_IWbemLocator</span><span class="p">,</span> <span class="p">(</span><span class="n">LPVOID</span><span class="o">*</span><span class="p">)</span><span class="o">&amp;</span><span class="n">wbemLocator</span><span class="p">);</span>
<span class="n">wbemLocator</span><span class="o">-&gt;</span><span class="n">ConnectServer</span><span class="p">(</span><span class="n">CComBSTR</span><span class="p">(</span><span class="s">"ROOT</span><span class="se">\\</span><span class="s">CIMV2"</span><span class="p">),</span> <span class="nb">NULL</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">wbemServices</span><span class="p">);</span>

<span class="c1">// get Win32_Process object</span>
<span class="n">wbemServices</span><span class="o">-&gt;</span><span class="n">GetObject</span><span class="p">(</span><span class="n">CComBSTR</span><span class="p">(</span><span class="s">"Win32_Process"</span><span class="p">),</span> <span class="mi">0</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">oWin32Process</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">callResult</span><span class="p">);</span>
<span class="n">wbemServices</span><span class="o">-&gt;</span><span class="n">GetObject</span><span class="p">(</span><span class="n">CComBSTR</span><span class="p">(</span><span class="s">"Win32_ProcessStartup"</span><span class="p">),</span> <span class="mi">0</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">oWin32ProcessStartup</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">callResult</span><span class="p">);</span>
<span class="n">oWin32Process</span><span class="o">-&gt;</span><span class="n">GetMethod</span><span class="p">(</span><span class="n">CComBSTR</span><span class="p">(</span><span class="s">"Create"</span><span class="p">),</span> <span class="mi">0</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">oMethCreate</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">oMethCreateSignature</span><span class="p">);</span>
<span class="n">oMethCreate</span><span class="o">-&gt;</span><span class="n">SpawnInstance</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">instWin32Process</span><span class="p">);</span>
<span class="n">oWin32ProcessStartup</span><span class="o">-&gt;</span><span class="n">SpawnInstance</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">instWin32ProcessStartup</span><span class="p">);</span>
<span class="c1">// set startup information for process</span>
<span class="n">instWin32ProcessStartup</span><span class="o">-&gt;</span><span class="n">Put</span><span class="p">(</span><span class="n">CComBSTR</span><span class="p">(</span><span class="s">"CreateFlags"</span><span class="p">),</span> <span class="mi">0</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">varCreateFlags</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
<span class="n">instWin32Process</span><span class="o">-&gt;</span><span class="n">Put</span><span class="p">(</span><span class="n">CComBSTR</span><span class="p">(</span><span class="s">"CommandLine"</span><span class="p">),</span> <span class="mi">0</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">varCmdLine</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
<span class="n">instWin32Process</span><span class="o">-&gt;</span><span class="n">Put</span><span class="p">(</span><span class="n">CComBSTR</span><span class="p">(</span><span class="s">"CurrentDirectory"</span><span class="p">),</span> <span class="mi">0</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">varCurDir</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
<span class="n">CComVariant</span> <span class="nf">varStartupInfo</span><span class="p">(</span><span class="n">instWin32ProcessStartup</span><span class="p">);</span>
<span class="n">instWin32Process</span><span class="o">-&gt;</span><span class="n">Put</span><span class="p">(</span><span class="n">CComBSTR</span><span class="p">(</span><span class="s">"ProcessStartupInformation"</span><span class="p">),</span> <span class="mi">0</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">varStartupInfo</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
<span class="n">wbemServices</span><span class="o">-&gt;</span><span class="n">ExecMethod</span><span class="p">(</span><span class="n">CComBSTR</span><span class="p">(</span><span class="s">"Win32_Process"</span><span class="p">),</span> <span class="n">CComBSTR</span><span class="p">(</span><span class="s">"Create"</span><span class="p">),</span> <span class="mi">0</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">,</span> <span class="n">instWin32Process</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">pOutParams</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">callResult</span><span class="p">);</span></code></pre></figure>

<p><i>Code sample is taken from <a href="https://github.com/CheckPointSW/InviZzzible">InviZzzible tool</a> </i></p>

<hr class="space" />

<p><b>Signature recommendations</b></p>
<p></p>
<p>If one of the following functions is called with the 2nd argument “<tt>Win32_Process</tt>” and the 3rd argument “<tt>Create</tt>”:</p>
<p></p>
<ul>
<li><tt>IWbemServices_ExecMethod(..., BSTR("Win32_Process"), BSTR("Create"), ...)</tt></li>
<li><tt>IWbemServices_ExecMethodAsync(..., BSTR("Win32_Process"), BSTR("Create"), ...)</tt></li> 
</ul>
<p>then it’s an indicator of the application trying to use the evasion technique.</p>
<p></p>
<p><b>Countermeasures</b></p>
<p></p>
<p>If you use a kernel-mode monitor, hook target functions or register callback on the process creation with <tt>PsSetCreateProcessNotifyRoutineEx</tt>.</p>

<hr class="space" />

<h4><a class="a-dummy" name="wmi-tsched">2.2. Start process using Task Scheduler via WMI (Windows 7)</a></h4>
<p>The technique is essentially the same as described in the <a href="timing.html#deferred-execution-using-task-scheduler">“Deferred execution using Task Scheduler”</a> section in the “Timing” chapter. WMI just provides another way to schedule a task.</p>

<p>You can create a new task with WMI using the “<tt>Win32_ScheduledJob</tt>” class with the method “<tt>Create</tt>”.</p>

<p>However, the “<tt>Win32_ScheduledJob</tt>” WMI class was designed to work with the AT command, which is deprecated since Windows 8.</p>

<p>In Windows 8 and higher, you can only create scheduled jobs with WMI if the registry key “<tt>HKEY_LOCAL_MACHINE\SOFTWARE\Microsoft\Windows NT\CurrentVersion\Schedule\Configuration</tt>” has a value “<tt>EnableAt</tt>”=”1” of type <tt>REG_DWORD</tt>. Therefore, this technique is unlikely to be found in the wild.</p>

<p><b>Code sample (VB)</b></p>
<p></p>

<figure class="highlight"><pre><code class="language-vb" data-lang="vb"><span class="n">strComputer</span> <span class="o">=</span> <span class="s">"."</span>
<span class="k">Set</span> <span class="n">objWMIService</span> <span class="o">=</span> <span class="n">GetObject</span><span class="p">(</span><span class="s">"winmgmts:"</span> <span class="o">&amp;</span> <span class="s">"{impersonationLevel=Impersonate}!\\"</span> <span class="o">&amp;</span> <span class="n">strComputer</span> <span class="o">&amp;</span> <span class="s">"\root\cimv2"</span><span class="p">)</span> 
<span class="k">Set</span> <span class="n">objSWbemDateTime</span> <span class="o">=</span> <span class="n">CreateObject</span><span class="p">(</span><span class="s">"WbemScripting.SWbemDateTime"</span><span class="p">)</span>
<span class="n">objSWbemDateTime</span><span class="p">.</span><span class="n">SetVarDate</span><span class="p">(</span><span class="n">DateAdd</span><span class="p">(</span><span class="s">"n"</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="n">Now</span><span class="p">()))</span>
<span class="k">Set</span> <span class="n">objNewJob</span> <span class="o">=</span> <span class="n">objWMIService</span><span class="p">.</span><span class="n">Get</span><span class="p">(</span><span class="s">"Win32_ScheduledJob"</span><span class="p">)</span>
<span class="n">errJobCreate</span> <span class="o">=</span> <span class="n">objNewJob</span><span class="p">.</span><span class="n">Create</span><span class="p">(</span><span class="s">"malware.exe"</span><span class="p">,</span> <span class="n">objSWbemDateTime</span><span class="p">.</span><span class="n">Value</span><span class="p">,</span> <span class="k">False</span><span class="p">,</span> <span class="p">,</span> <span class="p">,</span> <span class="k">True</span><span class="p">,</span> <span class="s">"MaliciousJob"</span><span class="p">)</span> </code></pre></figure>

<hr class="space" />

<p><b>Signature recommendations</b></p>
<p></p>
<p>If one of the following functions is called with the 2nd argument “Win32_ScheduledJob” and the 3rd argument “Create”:</p>
<p></p>
<ul>
<li><tt>IWbemServices_ExecMethod(..., BSTR("Win32_ScheduledJob"), BSTR("Create"), ...)</tt></li>
<li><tt>IWbemServices_ExecMethodAsync(..., BSTR("Win32_ScheduledJob"), BSTR("Create"), ...)</tt></li> 
</ul>
<p>then it’s an indicator of the application trying to use the evasion technique.</p>
<p></p>
<p><b>Countermeasures</b></p>
<p></p>
<p>Use a kernel-mode monitor, and register callback on the process creation with PsSetCreateProcessNotifyRoutineEx.</p>
<p></p>

<hr class="space" />

<p><br /></p>
<h3><a class="a-dummy" name="check-last-boot-time">3. Check the last boot time</a></h3>
<p>If the last boot time is queried immediately after restoring a VM from a snapshot, the WMI database may contain the value saved at the moment the VM snapshot was created. If the snapshot was created a year ago, the calculated system uptime will be a year as well even if a sandbox updates the last boot time.</p>

<p>This fact can be used to detect a virtual machine restored from a snapshot. Also, any anomalies in the last boot time can be used as sandbox indicators:</p>
<ul>
<li>The system uptime is too big (months or even years)</li>
<li>The system uptime is to small (less than several minutes)</li>
<li>The last boot time obtained using <a href="timing.html#get-system-time">other methods</a> differs from the last boot time obtained using WMI</li>
</ul>

<p><b>Code sample (VB)</b></p>
<p></p>

<figure class="highlight"><pre><code class="language-vb" data-lang="vb"><span class="n">strComputer</span> <span class="o">=</span> <span class="s">"."</span>
<span class="k">Set</span> <span class="n">objWMIService</span> <span class="o">=</span> <span class="n">GetObject</span><span class="p">(</span><span class="s">"winmgmts:"</span> <span class="o">&amp;</span> <span class="s">"{impersonationLevel=impersonate}!\\"</span> <span class="o">&amp;</span> <span class="n">strComputer</span> <span class="o">&amp;</span> <span class="s">"\root\cimv2"</span><span class="p">)</span>
<span class="k">Set</span> <span class="n">colOperatingSystems</span> <span class="o">=</span> <span class="n">objWMIService</span><span class="p">.</span><span class="n">ExecQuery</span> <span class="p">(</span><span class="s">"Select * from Win32_OperatingSystem"</span><span class="p">)</span>
 
<span class="k">For</span> <span class="k">Each</span> <span class="n">objOS</span> <span class="n">in</span> <span class="n">colOperatingSystems</span>
    <span class="n">dtmBootup</span> <span class="o">=</span> <span class="n">objOS</span><span class="p">.</span><span class="n">LastBootUpTime</span>
    <span class="n">dtmLastBootUpTime</span> <span class="o">=</span> <span class="n">WMIDateStringToDate</span><span class="p">(</span><span class="n">dtmBootup</span><span class="p">)</span>
    <span class="n">dtmSystemUptime</span> <span class="o">=</span> <span class="n">DateDiff</span><span class="p">(</span><span class="s">"n"</span><span class="p">,</span> <span class="n">dtmLastBootUpTime</span><span class="p">,</span> <span class="n">Now</span><span class="p">)</span>
    <span class="n">Wscript</span><span class="p">.</span><span class="n">Echo</span> <span class="s">"System uptime minutes: "</span> <span class="o">&amp;</span> <span class="n">dtmSystemUptime</span> 
<span class="k">Next</span>
 
<span class="k">Function</span> <span class="nf">WMIDateStringToDate</span><span class="p">(</span><span class="n">dtm</span><span class="p">)</span>
    <span class="n">WMIDateStringToDate</span> <span class="o">=</span>  <span class="k">CDate</span><span class="p">(</span><span class="n">Mid</span><span class="p">(</span><span class="n">dtm</span><span class="p">,</span> <span class="mi">5</span><span class="p">,</span> <span class="mi">2</span><span class="p">)</span> <span class="o">&amp;</span> <span class="s">"/"</span> <span class="o">&amp;</span> <span class="n">_</span>
        <span class="n">Mid</span><span class="p">(</span><span class="n">dtm</span><span class="p">,</span> <span class="mi">7</span><span class="p">,</span> <span class="mi">2</span><span class="p">)</span> <span class="o">&amp;</span> <span class="s">"/"</span> <span class="o">&amp;</span> <span class="n">Left</span><span class="p">(</span><span class="n">dtm</span><span class="p">,</span> <span class="mi">4</span><span class="p">)</span> <span class="o">&amp;</span> <span class="s">" "</span> <span class="o">&amp;</span> <span class="n">Mid</span> <span class="p">(</span><span class="n">dtm</span><span class="p">,</span> <span class="mi">9</span><span class="p">,</span> <span class="mi">2</span><span class="p">)</span> <span class="o">&amp;</span> <span class="s">":"</span> <span class="o">&amp;</span> <span class="n">_</span>
        <span class="n">Mid</span><span class="p">(</span><span class="n">dtm</span><span class="p">,</span> <span class="mi">11</span><span class="p">,</span> <span class="mi">2</span><span class="p">)</span> <span class="o">&amp;</span> <span class="s">":"</span> <span class="o">&amp;</span> <span class="n">Mid</span><span class="p">(</span><span class="n">dtm</span><span class="p">,</span> <span class="mi">13</span><span class="p">,</span> <span class="mi">2</span><span class="p">))</span>
<span class="k">End</span> <span class="k">Function</span></code></pre></figure>

<p><i>Code sample is taken from <a href="https://docs.microsoft.com/en-us/windows/win32/wmisdk/wmi-tasks--desktop-management">Microsoft Docs</a> </i></p>

<hr class="space" />

<p><b>Signature recommendations</b></p>
<p></p>
<p>If the following function is called with the 3rd argument BSTR(“Win32_OperatingSystem”):</p>
<p></p>
<ul>
<li><tt>IWbemServices_ExecQuery(..., BSTR("Win32_OperatingSystem"), ...)</tt></li>
</ul>
<p>then it’s a possible indicator of the application trying to use the evasion technique.</p>

<p></p>
<p><b>Countermeasures</b></p>
<p></p>
<ul>
<li>Adjust the <tt>KeBootTime</tt> value</li>
<li>Reset the WMI repository or restart the "<tt>winmgmt</tt>" service after you adjust the <tt>KeBootTime</tt> value</li>
</ul>

<hr class="space" />

<p><br /></p>
<h3><a class="a-dummy" name="check-network-adapter-reset-time">4. Check the network adapters last reset time</a></h3>
<p>We need to check if there are any adapters that were last reset a long time ago. This may indicate the application is running in a virtual machine restored from a snapshot.</p>

<p><b>Code sample (VB)</b></p>
<p></p>

<figure class="highlight"><pre><code class="language-vb" data-lang="vb"><span class="n">strComputer</span> <span class="o">=</span> <span class="s">"."</span>
<span class="k">Set</span> <span class="n">objWMIService</span> <span class="o">=</span> <span class="n">GetObject</span><span class="p">(</span><span class="s">"winmgmts:"</span> <span class="o">&amp;</span> <span class="s">"{impersonationLevel=impersonate}!\\"</span> <span class="o">&amp;</span> <span class="n">strComputer</span> <span class="o">&amp;</span> <span class="s">"\root\cimv2"</span><span class="p">)</span>
<span class="k">Set</span> <span class="n">colOperatingSystems</span> <span class="o">=</span> <span class="n">objWMIService</span><span class="p">.</span><span class="n">ExecQuery</span> <span class="p">(</span><span class="s">"Select * from Win32_NetworkAdapter"</span><span class="p">)</span>
 
<span class="k">For</span> <span class="k">Each</span> <span class="n">objOS</span> <span class="n">in</span> <span class="n">colNetworkAdapters</span>
    <span class="n">dtmLastReset</span> <span class="o">=</span> <span class="n">objOS</span><span class="p">.</span><span class="n">TimeOfLastReset</span>
    <span class="n">dtmLastResetTime</span> <span class="o">=</span> <span class="n">WMIDateStringToDate</span><span class="p">(</span><span class="n">dtmLastReset</span><span class="p">)</span>  <span class="c1">'WMIDateStringToDate function from the previous example</span>
    <span class="n">dtmAdapterUptime</span> <span class="o">=</span> <span class="n">DateDiff</span><span class="p">(</span><span class="s">"n"</span><span class="p">,</span> <span class="n">dtmLastResetTime</span><span class="p">,</span> <span class="n">Now</span><span class="p">)</span>
    <span class="n">Wscript</span><span class="p">.</span><span class="n">Echo</span> <span class="s">"Adapter uptime minutes: "</span> <span class="o">&amp;</span> <span class="n">dtmAdapterUptime</span> 
<span class="k">Next</span></code></pre></figure>

<p><b>Signature recommendations</b></p>
<p></p>
<p>If the following function is called with the 3rd argument BSTR(“Win32_OperatingSystem”):</p>
<p></p>
<ul>
<li><tt>IWbemServices_ExecQuery(..., BSTR("Win32_NetworkAdapter"), ...)</tt></li>
</ul>
<p>then it’s a possible indicator of the application trying to use the evasion technique.</p>

<p></p>
<p><b>Countermeasures</b></p>
<p></p>
<ul>
<li>Ensure an adequate last reset time for the network adapters</li>
<li>Reset the WMI repository or restart the "<tt>winmgmt</tt>" service </li>
</ul>

<p><br /></p>
<h3><a class="a-dummy" name="countermeasures">Countermeasures</a></h3>
<p>Countermeasures are presented in the appropriate sub-sections above.</p>

<p><br /></p>
<h3><a class="a-dummy" name="credits">Credits</a></h3>

<ul>
<li>al-khaser project on <a href="https://github.com/LordNoteworthy/al-khaser">GitHub</a></li>
<li>Microsoft Docs - <a href="https://docs.microsoft.com/en-us/windows/win32/wmisdk/">WMI Tasks: Desktop Management</a></li>
</ul>

    <br>
    <div style="text-align: left">
        <a href="..">Go back</a>
    </div>
    <br>
    <div class="sharebuttons" style="text-align: center">
        <hr />
        <ul>
          <li>
            <p class="sharetitle"> Share this: </p>
          </li>
          <li class="reddit">
            <a href="http://www.reddit.com/submit?url=https://evasions.checkpoint.com/src/Evasions/techniques/wmi.html&title=Evasions:%20WMI - Evasion Techniques" target="_blank">
                <svg xmlns="http://www.w3.org/2000/svg"
                aria-label="Reddit" role="img"
                viewBox="0 0 512 512"><rect
                width="512" height="512"
                rx="15%"
                fill="#f40"/><g fill="#fff"><ellipse cx="256" cy="307" rx="166" ry="117"/><circle cx="106" cy="256" r="42"/><circle cx="407" cy="256" r="42"/><circle cx="375" cy="114" r="32"/></g><g stroke-linecap="round" stroke-linejoin="round" fill="none"><path d="m256 196 23-101 73 15" stroke="#fff" stroke-width="16"/><path d="m191 359c33 25 97 26 130 0" stroke="#f40" stroke-width="13"/></g><g fill="#f40"><circle cx="191" cy="287" r="31"/><circle cx="321" cy="287" r="31"/></g></svg>
                
            </a>
          </li>
          <li class="hn">
            <a href="http://news.ycombinator.com/submitlink?u=https://evasions.checkpoint.com/src/Evasions/techniques/wmi.html&t=Evasions:%20WMI - Evasion Techniques" target="_blank">
                <svg xmlns="http://www.w3.org/2000/svg"
                aria-label="Hacker News" role="img"
                viewBox="0 0 512 512"><rect
                width="512" height="512"
                rx="15%"
                fill="#f60"/><path fill="#fff" d="M124 91h51l81 162 81-164h51L276 293v136h-40V293z"/></svg>
            </a>
          </li>
          <li class="twitter">
            <a href="https://twitter.com/intent/tweet?via=_CPResearch_&url=https://evasions.checkpoint.com/src/Evasions/techniques/wmi.html&text=Evasions:%20WMI - Evasion Techniques" target="_blank">
                <svg viewBox="0 0 1792 1792" xmlns="http://www.w3.org/2000/svg"><path d="M1684 408q-67 98-162 167 1 14 1 42 0 130-38 259.5t-115.5 248.5-184.5 210.5-258 146-323 54.5q-271 0-496-145 35 4 78 4 225 0 401-138-105-2-188-64.5t-114-159.5q33 5 61 5 43 0 85-11-112-23-185.5-111.5t-73.5-205.5v-4q68 38 146 41-66-44-105-115t-39-154q0-88 44-163 121 149 294.5 238.5t371.5 99.5q-8-38-8-74 0-134 94.5-228.5t228.5-94.5q140 0 236 102 109-21 205-78-37 115-142 178 93-10 186-50z"/></svg>
            </a>
          </li>
          <li class="linkedin">
            <a href=https://www.linkedin.com/shareArticle?mini=true&url=https://evasions.checkpoint.com/src/Evasions/techniques/wmi.html&title=Evasions:%20WMI - Evasion Techniques&source=LinkedIn" target="_blank">
                <svg viewBox="0 0 1792 1792" xmlns="http://www.w3.org/2000/svg"><path d="M477 625v991h-330v-991h330zm21-306q1 73-50.5 122t-135.5 49h-2q-82 0-132-49t-50-122q0-74 51.5-122.5t134.5-48.5 133 48.5 51 122.5zm1166 729v568h-329v-530q0-105-40.5-164.5t-126.5-59.5q-63 0-105.5 34.5t-63.5 85.5q-11 30-11 81v553h-329q2-399 2-647t-1-296l-1-48h329v144h-2q20-32 41-56t56.5-52 87-43.5 114.5-15.5q171 0 275 113.5t104 332.5z"/></svg>
            </a>
          </li>
        </ul>
      </div>
      
</article>


</section>

<nav class="navbar navbar-default navbar-fixed-bottom">
  <div class="container footer-content">

    Made with <font class="a-pink"><i class ="fa fa-heart"></i></font> to serve the community by Check Point Research    |    <a class="a-pink" href="https://research.checkpoint.com">Research blog</a>    |    <a class="a-pink" href="https://research.checkpoint.com/about-us/">About Us</a>    |    <a class="a-pink" href="https://github.com/CheckPointSW"><i class="fa fa-github fa-lg"></i></a> <a class="a-pink" href="https://twitter.com/_CPResearch_"><i class="fa fa-twitter fa-lg"></i></a>
    
    <br>
    
    © 1994-2024 Check Point Software Technologies LTD | All rights reserved | Property of CheckPoint.com


  </div>
</nav>

  </body>

</html>
