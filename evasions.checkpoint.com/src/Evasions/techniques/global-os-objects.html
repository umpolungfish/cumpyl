<!DOCTYPE html>
<html>

  <head>
  <meta charset="utf-8">
  <meta http-equiv="X-UA-Compatible" content="IE=edge">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-194688-3"></script>
  <script>
   window.dataLayer = window.dataLayer || [];
   function gtag(){dataLayer.push(arguments);}
   gtag('js', new Date());
   gtag('config', 'UA-194688-3');
  </script>
  <meta content="Evasion techniques" property="og:site_name">

  <meta content="Evasions: Global OS Objects" property="og:title">


  <meta name="twitter:title" content="Malware Evasion Encyclopedia" />
  <meta name="twitter:image" content="https://research.checkpoint.com/wp-content/uploads/2020/02/evasions.jpg" />


  <meta content="article" property="og:type">


  <meta content="Evasion techniques
" property="og:description">


  <meta content="https://evasions.checkpoint.com/src/Evasions/techniques/global-os-objects.html" property="og:url">


  <meta content="2024-07-10T07:20:28+00:00" property="article:published_time">
  <meta content="https://evasions.checkpoint.com/about/" property="article:author">


  <meta property="og:image" content="">


  
  <meta content="evasions" property="article:section">
  


  
  <meta content="filesystem" property="article:tag">
  
  <meta content="vmware" property="article:tag">
  
  <meta content="virtualbox" property="article:tag">
  

  <title>Evasions: Global OS Objects</title>
  <meta name="description" content="Contents">
<script src="https://ajax.googleapis.com/ajax/libs/jquery/2.2.2/jquery.min.js"></script>
<script src="https://maxcdn.bootstrapcdn.com/bootstrap/3.3.6/js/bootstrap.min.js" integrity="sha384-0mSbJDEHialfmuBBQP6A4Qrprq5OVfW37PRR3j5ELqxss1yVqOtnepnHVP9aJ7xS" crossorigin="anonymous"></script>
  <link rel="stylesheet" href="https://evasions.checkpoint.com/assets/css/main.css">
<script src="https://maxcdn.bootstrapcdn.com/bootstrap/3.3.6/js/bootstrap.min.js" integrity="sha384-0mSbJDEHialfmuBBQP6A4Qrprq5OVfW37PRR3j5ELqxss1yVqOtnepnHVP9aJ7xS" crossorigin="anonymous"></script>

  <link href='https://fonts.googleapis.com/css?family=PT+Sans' rel='stylesheet' type='text/css'>
  <link href='https://fonts.googleapis.com/css?family=Fira+Mono' rel='stylesheet' type='text/css'>
  <link href='https://fonts.googleapis.com/css?family=Lato:400,700' rel='stylesheet' type='text/css'>
  <link href='https://fonts.googleapis.com/css?family=Source+Code+Pro:400,200,300,500,600,700,900' rel='stylesheet' type='text/css'>
  <link href='https://fonts.googleapis.com/css?family=Gentium+Basic:400,700' rel='stylesheet' type='text/css'>
  <link href='https://fonts.googleapis.com/css?family=Alegreya:400,400italic,700' rel='stylesheet' type='text/css'>
  <link href='https://fonts.googleapis.com/css?family=Lora:400,400italic,700' rel='stylesheet' type='text/css'>
  <link href='https://fonts.googleapis.com/css?family=Fira+Sans:400,300,500,700' rel='stylesheet' type='text/css'>
  <script src="https://ajax.googleapis.com/ajax/libs/jquery/2.2.0/jquery.min.js"></script>
  <link href='https://fonts.googleapis.com/css?family=Open+Sans:400,700' rel='stylesheet' type='text/css'>
  <link href="https://maxcdn.bootstrapcdn.com/bootstrap/3.3.6/css/bootstrap.min.css" rel="stylesheet" integrity="sha384-1q8mTJOASx8j1Au+a5WDVnPi2lkFfwwEAa8hDDdjZlpLegxhjVME1fgjWPGmkzs7" crossorigin="anonymous">
  <link href="https://maxcdn.bootstrapcdn.com/font-awesome/4.6.1/css/font-awesome.min.css" rel="stylesheet" integrity="sha384-hQpvDQiCJaD2H465dQfA717v7lu5qHWtDbWNPvaTJ0ID5xnPUlVXnKzq7b8YUkbN" crossorigin="anonymous">
  <link rel="canonical" href="https://evasions.checkpoint.com/src/Evasions/techniques/global-os-objects.html">
  <link rel="alternate" type="application/rss+xml" title="Evasion techniques" href="https://evasions.checkpoint.com/feed.xml">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/tinysort/2.3.6/tinysort.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/tinysort/2.3.6/tinysort.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/tinysort/2.3.6/tinysort.charorder.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/tinysort/2.3.6/tinysort.charorder.min.js"></script>
  <script type="text/javascript" async src="//platform.twitter.com/widgets.js"></script>




</head>


  <body>
<section>
<article class="post" itemscope itemtype="http://schema.org/BlogPosting">
  <div class="jumbotron">
    <div class="container">
      <h1 class="post-title-main" itemprop="name headline">Evasions: Global OS Objects</h1>
    </div>
</div>

  <div class="post-content container" itemprop="articleBody">
    <div style="text-align: left">
        <a href="..">Go back</a>
        <br>
        <br>
    </div>
    <h1>Contents</h1>

<p><a href="#global-objects-detection-methods">Global objects detection methods</a>
<br />
  <a href="#check-if-specific-mutexes-present">1. Check for specific global mutexes</a>
<br />
  <a href="#check-if-specific-virtual-devices-present">2. Check for specific virtual devices</a>
<br />
  <a href="#check-if-pipes-present">3. Check for specific global pipes</a>
<br />
  <a href="#check-if-objects-present">4. Check for specific global objects</a>
<br />
  <a href="#check-if-object-directory-present">5. Check for specific object directory (Sandboxie only)</a>
<br />
  <a href="#check-if-virtual-registry-present">6. Check if virtual registry is present in system (Sandboxie only)</a>
<br />
<a href="#countermeasures">Countermeasures</a>
<br />
<a href="#credits">Credits</a>
<br />
<br /></p>

<h2><a class="a-dummy" name="global-objects-detection-methods">Global objects detection methods</a></h2>
<p>The principle of all the global objects detection methods is the following: there are no such objects in usual host; however they exist in particular virtual environments and sandboxes. Virtual environment may be detected if such an artifact is present.</p>

<p><br /></p>
<h3><a class="a-dummy" name="check-if-specific-mutexes-present">1. Check for specific global mutexes</a></h3>

<p>This method checks for particular mutexes which are present in virtual environments but not in usual host systems.</p>

<p>Functions used:</p>
<ul>
<li><tt>CreateMutexA/W</tt></li> 
<li><tt>OpenMutexA/W</tt></li> 
</ul>

<hr class="space" />

<p><b>Code sample</b></p>
<p></p>

<figure class="highlight"><pre><code class="language-c" data-lang="c"><span class="c1">// usage sample:</span>
<span class="n">supMutexExist</span><span class="p">(</span><span class="s">L"Sandboxie_SingleInstanceMutex_Control"</span><span class="p">);</span> <span class="c1">// sample value from the table below</span>


<span class="n">BOOL</span> <span class="nf">supMutexExist</span><span class="p">(</span><span class="n">_In_</span> <span class="n">LPWSTR</span> <span class="n">lpMutexName</span><span class="p">)</span>
<span class="p">{</span>
    <span class="n">DWORD</span> <span class="n">dwError</span><span class="p">;</span>
    <span class="n">HANDLE</span> <span class="n">hObject</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
    <span class="k">if</span> <span class="p">(</span><span class="n">lpMutexName</span> <span class="o">==</span> <span class="nb">NULL</span><span class="p">)</span> <span class="p">{</span>
        <span class="k">return</span> <span class="n">FALSE</span><span class="p">;</span>
    <span class="p">}</span>

    <span class="n">SetLastError</span><span class="p">(</span><span class="mi">0</span><span class="p">);</span>
    <span class="n">hObject</span> <span class="o">=</span> <span class="n">CreateMutex</span><span class="p">(</span><span class="nb">NULL</span><span class="p">,</span> <span class="n">FALSE</span><span class="p">,</span> <span class="n">lpMutexName</span><span class="p">);</span> <span class="c1">// define around A or W function version</span>
    <span class="n">dwError</span> <span class="o">=</span> <span class="n">GetLastError</span><span class="p">();</span>

    <span class="k">if</span> <span class="p">(</span><span class="n">hObject</span><span class="p">)</span> <span class="p">{</span>
        <span class="n">CloseHandle</span><span class="p">(</span><span class="n">hObject</span><span class="p">);</span>
    <span class="p">}</span>

    <span class="k">return</span> <span class="p">(</span><span class="n">dwError</span> <span class="o">==</span> <span class="n">ERROR_ALREADY_EXISTS</span><span class="p">);</span>
<span class="p">}</span></code></pre></figure>

<p><i>Credits for this code sample: <a href="https://github.com/hfiref0x/VMDE">VMDE project</a> </i></p>

<hr class="space" />

<p><b>Signature recommendations</b></p>
<p></p>
<p>If the following function contains 3rd argument from the table column <font face="Courier New">`Name`</font>:</p>
<p></p>
<ul>
<li><tt>CreateMutexA/W(..., ..., registry_path)</tt></li> 
<li><tt>OpenMutexA/W(..., ..., registry_path)</tt></li> 
</ul>
<p>then itâ€™s an indication of application trying to use the evasion technique.</p>

<hr class="space" />

<p><b>Detections table</b></p>

<table style="width:62%">
  <tr>
  	<td colspan="2">Check if the following global mutexes exist:</td>
  </tr>
  <tr>
  	<th style="text-align:center">Detect</th>
  	<th style="text-align:center">Name</th>
  </tr>
  <tr>
  	<th rowspan="1">DeepFreeze</th>
  	<td>Frz_State</td>
  </tr>
  <tr>
  	<th rowspan="2">Sandboxie</th>
  	<td>Sandboxie_SingleInstanceMutex_Control</td>
  </tr>
  <tr>
  	<td>SBIE_BOXED_ServiceInitComplete_Mutex1</td>
  </tr>
  <tr>
  	<th rowspan="1">VirtualPC</th>
  	<td>MicrosoftVirtualPC7UserServiceMakeSureWe'reTheOnlyOneMutex</td>
  </tr>
</table>

<p><br />
Note: DeepFreeze is an application restoring the system on each reboot.</p>

<p><br /></p>
<h3><a class="a-dummy" name="check-if-specific-virtual-devices-present">2. Check for specific virtual devices</a></h3>

<p>This method checks for particular virtual devices which are present in virtual environments but not in usual host systems.</p>

<p>Function used:</p>
<ul>
<li><tt>NtCreateFile</tt></li> 
</ul>

<hr class="space" />

<p><b>Code sample</b></p>
<p></p>

<figure class="highlight"><pre><code class="language-c" data-lang="c"><span class="c1">// usage sample:</span>
<span class="n">HANDLE</span> <span class="n">hDummy</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
<span class="n">supOpenDevice</span><span class="p">(</span><span class="s">L"</span><span class="se">\\</span><span class="s">Device</span><span class="se">\\</span><span class="s">Null"</span><span class="p">,</span> <span class="n">GENERIC_READ</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">hDummy</span><span class="p">);</span> <span class="c1">// sample values from the table below</span>


<span class="n">BOOL</span> <span class="nf">supOpenDevice</span><span class="p">(</span>
    <span class="n">_In_</span> <span class="n">LPWSTR</span> <span class="n">lpDeviceName</span><span class="p">,</span>
    <span class="n">_In_</span> <span class="n">ACCESS_MASK</span> <span class="n">DesiredAccess</span><span class="p">,</span>
    <span class="n">_Out_opt_</span> <span class="n">PHANDLE</span> <span class="n">phDevice</span><span class="p">)</span>
<span class="p">{</span>
    <span class="n">OBJECT_ATTRIBUTES</span> <span class="n">attr</span><span class="p">;</span>
    <span class="n">IO_STATUS_BLOCK</span> <span class="n">iost</span><span class="p">;</span>
    <span class="n">UNICODE_STRING</span> <span class="n">uDevName</span><span class="p">;</span>
    <span class="n">HANDLE</span> <span class="n">hDevice</span><span class="p">;</span>
    <span class="n">NTSTATUS</span> <span class="n">Status</span><span class="p">;</span>

    <span class="k">if</span> <span class="p">(</span><span class="n">phDevice</span><span class="p">)</span> <span class="p">{</span>
        <span class="o">*</span><span class="n">phDevice</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
    <span class="p">}</span>
    <span class="k">if</span> <span class="p">(</span><span class="n">lpDeviceName</span> <span class="o">==</span> <span class="nb">NULL</span><span class="p">)</span> <span class="p">{</span>
        <span class="k">return</span> <span class="n">FALSE</span><span class="p">;</span>
    <span class="p">}</span>

    <span class="n">hDevice</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
    <span class="n">RtlSecureZeroMemory</span><span class="p">(</span><span class="o">&amp;</span><span class="n">uDevName</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">uDevName</span><span class="p">));</span>
    <span class="n">RtlInitUnicodeString</span><span class="p">(</span><span class="o">&amp;</span><span class="n">uDevName</span><span class="p">,</span> <span class="n">lpDeviceName</span><span class="p">);</span>
    <span class="n">InitializeObjectAttributes</span><span class="p">(</span><span class="o">&amp;</span><span class="n">attr</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">uDevName</span><span class="p">,</span> <span class="n">OBJ_CASE_INSENSITIVE</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">);</span>

    <span class="n">Status</span> <span class="o">=</span> <span class="n">NtCreateFile</span><span class="p">(</span><span class="o">&amp;</span><span class="n">hDevice</span><span class="p">,</span> <span class="n">DesiredAccess</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">attr</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">iost</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span>
        <span class="mi">0</span><span class="p">,</span> <span class="n">FILE_OPEN</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
    <span class="k">if</span> <span class="p">(</span><span class="n">NT_SUCCESS</span><span class="p">(</span><span class="n">Status</span><span class="p">))</span> <span class="p">{</span>
        <span class="k">if</span> <span class="p">(</span><span class="n">phDevice</span> <span class="o">!=</span> <span class="nb">NULL</span><span class="p">)</span> <span class="p">{</span>
            <span class="o">*</span><span class="n">phDevice</span> <span class="o">=</span> <span class="n">hDevice</span><span class="p">;</span>
        <span class="p">}</span>
    <span class="p">}</span>

    <span class="k">return</span> <span class="n">NT_SUCCESS</span><span class="p">(</span><span class="n">Status</span><span class="p">);</span>
<span class="p">}</span></code></pre></figure>

<p><i>Credits for this code sample: <a href="https://github.com/hfiref0x/VMDE">VMDE project</a> </i></p>

<hr class="space" />

<p><b>Signature recommendations</b></p>
<p></p>
<p>If the following function contains 3rd argument with its field <font face="Courier New">`ObjectName-&gt;Buffer`</font> from the table column <font face="Courier New">`Name`</font>:</p>
<p></p>
<ul>
<li><tt>NtCreateFile(..., ..., attr, ...)</tt></li>
</ul>
<p>then itâ€™s an indication of application trying to use the evasion technique.</p>

<p><br />
3rd argument is of the following type:</p>

<figure class="highlight"><pre><code class="language-c" data-lang="c"><span class="k">typedef</span> <span class="k">struct</span> <span class="n">_OBJECT_ATTRIBUTES</span> <span class="p">{</span>
    <span class="n">ULONG</span> <span class="n">Length</span><span class="p">;</span>
    <span class="n">HANDLE</span> <span class="n">RootDirectory</span><span class="p">;</span>
    <span class="n">PUNICODE_STRING</span> <span class="n">ObjectName</span><span class="p">;</span>
    <span class="n">ULONG</span> <span class="n">Attributes</span><span class="p">;</span>
    <span class="n">PVOID</span> <span class="n">SecurityDescriptor</span><span class="p">;</span>
    <span class="n">PVOID</span> <span class="n">SecurityQualityOfService</span><span class="p">;</span>
<span class="p">}</span> <span class="n">OBJECT_ATTRIBUTES</span><span class="p">;</span></code></pre></figure>

<hr class="space" />

<p><b>Detections table</b></p>

<table style="width:62%">
  <tr>
  	<td colspan="3">Check if the following virtual devices exist:</td>
  </tr>
  <tr>
  	<th style="text-align:center">Detect</th>
  	<th style="text-align:center">Path</th>
  </tr>
  <tr>
  	<th rowspan="6">VirtualBox</th>
  	<td>\\.\VBoxMiniRdDN</td>
  </tr>
  <tr>
  	<td>\\.\VBoxMiniRdrDN</td>
  </tr>
  <tr>
  	<td>\\.\VBoxGuest</td>
  </tr>
  <tr>
  	<td>\\.\VBoxTrayIPC</td>
  </tr>
  <tr>
  	<td>\\.\VBoxMouse</td>
  </tr>
  <tr>
  	<td>\\.\VBoxVideo</td>
  </tr>
  <tr>
  	<th rowspan="2">VMware</th>
  	<td>\\.\HGFS</td>
  </tr>
  <tr>
  	<td>\\.\vmci</td>
  </tr>
</table>

<p><br /></p>
<h3><a class="a-dummy" name="check-if-pipes-present">3. Check for specific global pipes</a></h3>

<p>Pipes are just a particular case of virtual devices, please refer to the <a href="#check-if-specific-virtual-devices-present">previous section</a> for code sample and signature recommendations.</p>

<hr class="space" />

<p><b>Detections table</b></p>

<table style="width:62%">
  <tr>
  	<td colspan="2">Check if the following global pipes exist:</td>
  </tr>
  <tr>
  	<th style="text-align:center">Detect</th>
  	<th style="text-align:center">String</th>
  </tr>
  <tr>
  	<th rowspan="2">VirtualBox</th>
  	<td>\\.\pipe\VBoxMiniRdDN</td>
  </tr>
  <tr>
  	<td>\\.\pipe\VBoxTrayIPC</td>
  </tr>
</table>

<p><br /></p>
<h3><a class="a-dummy" name="check-if-objects-present">4. Check for global objects</a></h3>

<p>This method checks for particular global objects which are present in virtual environments but not in usual host systems.</p>

<p>Functions used:</p>
<ul>
<li><tt>NtOpenDirectoryObject</tt></li> 
<li><tt>NtQueryDirectoryObject</tt></li> 
</ul>

<hr class="space" />

<p><b>Code sample</b></p>
<p></p>

<figure class="highlight"><pre><code class="language-c" data-lang="c"><span class="c1">// usage sample:</span>
<span class="n">supIsObjectExists</span><span class="p">(</span><span class="s">L"</span><span class="se">\\</span><span class="s">Driver"</span><span class="p">,</span> <span class="s">L"SbieDrv"</span><span class="p">);</span> <span class="c1">// sample values from the table below</span>


<span class="k">typedef</span> <span class="k">struct</span> <span class="n">_OBJECT_DIRECTORY_INFORMATION</span> <span class="p">{</span>
    <span class="n">UNICODE_STRING</span> <span class="n">Name</span><span class="p">;</span>
    <span class="n">UNICODE_STRING</span> <span class="n">TypeName</span><span class="p">;</span>
<span class="p">}</span> <span class="n">OBJECT_DIRECTORY_INFORMATION</span><span class="p">,</span> <span class="o">*</span><span class="n">POBJECT_DIRECTORY_INFORMATION</span><span class="p">;</span>

<span class="n">BOOL</span> <span class="nf">supIsObjectExists</span><span class="p">(</span>
    <span class="n">_In_</span> <span class="n">LPWSTR</span> <span class="n">RootDirectory</span><span class="p">,</span>
    <span class="n">_In_</span> <span class="n">LPWSTR</span> <span class="n">ObjectName</span><span class="p">)</span>
<span class="p">{</span>
    <span class="n">OBJSCANPARAM</span> <span class="n">Param</span><span class="p">;</span>
    <span class="k">if</span> <span class="p">(</span><span class="n">ObjectName</span> <span class="o">==</span> <span class="nb">NULL</span><span class="p">)</span> <span class="p">{</span>
        <span class="k">return</span> <span class="n">FALSE</span><span class="p">;</span>
    <span class="p">}</span>

    <span class="n">Param</span><span class="p">.</span><span class="n">Buffer</span> <span class="o">=</span> <span class="n">ObjectName</span><span class="p">;</span>
    <span class="n">Param</span><span class="p">.</span><span class="n">BufferSize</span> <span class="o">=</span> <span class="p">(</span><span class="n">ULONG</span><span class="p">)</span><span class="n">_strlen_w</span><span class="p">(</span><span class="n">ObjectName</span><span class="p">);</span>

    <span class="k">return</span> <span class="n">NT_SUCCESS</span><span class="p">(</span><span class="n">supEnumSystemObjects</span><span class="p">(</span><span class="n">RootDirectory</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">,</span> <span class="n">supDetectObjectCallback</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">Param</span><span class="p">));</span>
<span class="p">}</span>

<span class="n">NTSTATUS</span> <span class="n">NTAPI</span> <span class="nf">supDetectObjectCallback</span><span class="p">(</span>
    <span class="n">_In_</span> <span class="n">POBJECT_DIRECTORY_INFORMATION</span> <span class="n">Entry</span><span class="p">,</span>
    <span class="n">_In_</span> <span class="n">PVOID</span> <span class="n">CallbackParam</span><span class="p">)</span>
<span class="p">{</span>
    <span class="n">POBJSCANPARAM</span> <span class="n">Param</span> <span class="o">=</span> <span class="p">(</span><span class="n">POBJSCANPARAM</span><span class="p">)</span><span class="n">CallbackParam</span><span class="p">;</span>
    <span class="k">if</span> <span class="p">(</span><span class="n">Entry</span> <span class="o">==</span> <span class="nb">NULL</span><span class="p">)</span> <span class="p">{</span>
        <span class="k">return</span> <span class="n">STATUS_INVALID_PARAMETER_1</span><span class="p">;</span>
    <span class="p">}</span>
    <span class="k">if</span> <span class="p">(</span><span class="n">CallbackParam</span> <span class="o">==</span> <span class="nb">NULL</span><span class="p">)</span> <span class="p">{</span>
        <span class="k">return</span> <span class="n">STATUS_INVALID_PARAMETER_2</span><span class="p">;</span>
    <span class="p">}</span>
    <span class="k">if</span> <span class="p">(</span><span class="n">Param</span><span class="o">-&gt;</span><span class="n">Buffer</span> <span class="o">==</span> <span class="nb">NULL</span> <span class="o">||</span> <span class="n">Param</span><span class="o">-&gt;</span><span class="n">BufferSize</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
        <span class="k">return</span> <span class="n">STATUS_MEMORY_NOT_ALLOCATED</span><span class="p">;</span>
    <span class="p">}</span>
    <span class="k">if</span> <span class="p">(</span><span class="n">Entry</span><span class="o">-&gt;</span><span class="n">Name</span><span class="p">.</span><span class="n">Buffer</span><span class="p">)</span> <span class="p">{</span>
        <span class="k">if</span> <span class="p">(</span><span class="n">_strcmpi_w</span><span class="p">(</span><span class="n">Entry</span><span class="o">-&gt;</span><span class="n">Name</span><span class="p">.</span><span class="n">Buffer</span><span class="p">,</span> <span class="n">Param</span><span class="o">-&gt;</span><span class="n">Buffer</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
            <span class="k">return</span> <span class="n">STATUS_SUCCESS</span><span class="p">;</span>
        <span class="p">}</span>
    <span class="p">}</span>

    <span class="k">return</span> <span class="n">STATUS_UNSUCCESSFUL</span><span class="p">;</span>
<span class="p">}</span>

<span class="n">NTSTATUS</span> <span class="n">NTAPI</span> <span class="nf">supEnumSystemObjects</span><span class="p">(</span>
    <span class="n">_In_opt_</span> <span class="n">LPWSTR</span> <span class="n">pwszRootDirectory</span><span class="p">,</span>
    <span class="n">_In_opt_</span> <span class="n">HANDLE</span> <span class="n">hRootDirectory</span><span class="p">,</span>
    <span class="n">_In_</span> <span class="n">PENUMOBJECTSCALLBACK</span> <span class="n">CallbackProc</span><span class="p">,</span>
    <span class="n">_In_opt_</span> <span class="n">PVOID</span> <span class="n">CallbackParam</span><span class="p">)</span>
<span class="p">{</span>
    <span class="n">BOOL</span> <span class="n">cond</span> <span class="o">=</span> <span class="n">TRUE</span><span class="p">;</span>
    <span class="n">ULONG</span> <span class="n">ctx</span><span class="p">,</span> <span class="n">rlen</span><span class="p">;</span>
    <span class="n">HANDLE</span> <span class="n">hDirectory</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
    <span class="n">NTSTATUS</span> <span class="n">status</span><span class="p">;</span>
    <span class="n">NTSTATUS</span> <span class="n">CallbackStatus</span><span class="p">;</span>
    <span class="n">OBJECT_ATTRIBUTES</span> <span class="n">attr</span><span class="p">;</span>
    <span class="n">UNICODE_STRING</span> <span class="n">sname</span><span class="p">;</span>
    <span class="n">POBJECT_DIRECTORY_INFORMATION</span> <span class="n">objinf</span><span class="p">;</span>

    <span class="k">if</span> <span class="p">(</span><span class="n">CallbackProc</span> <span class="o">==</span> <span class="nb">NULL</span><span class="p">)</span> <span class="p">{</span>
        <span class="k">return</span> <span class="n">STATUS_INVALID_PARAMETER_4</span><span class="p">;</span>
    <span class="p">}</span>
    <span class="n">status</span> <span class="o">=</span> <span class="n">STATUS_UNSUCCESSFUL</span><span class="p">;</span>
    
    <span class="kr">__try</span> <span class="p">{</span>
        <span class="c1">// We can use root directory.</span>
        <span class="k">if</span> <span class="p">(</span><span class="n">pwszRootDirectory</span> <span class="o">!=</span> <span class="nb">NULL</span><span class="p">)</span> <span class="p">{</span>
            <span class="n">RtlSecureZeroMemory</span><span class="p">(</span><span class="o">&amp;</span><span class="n">sname</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">sname</span><span class="p">));</span>
            <span class="n">RtlInitUnicodeString</span><span class="p">(</span><span class="o">&amp;</span><span class="n">sname</span><span class="p">,</span> <span class="n">pwszRootDirectory</span><span class="p">);</span>
            <span class="n">InitializeObjectAttributes</span><span class="p">(</span><span class="o">&amp;</span><span class="n">attr</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">sname</span><span class="p">,</span> <span class="n">OBJ_CASE_INSENSITIVE</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">);</span>

            <span class="n">status</span> <span class="o">=</span> <span class="n">NtOpenDirectoryObject</span><span class="p">(</span><span class="o">&amp;</span><span class="n">hDirectory</span><span class="p">,</span> <span class="n">DIRECTORY_QUERY</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">attr</span><span class="p">);</span>
            <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">NT_SUCCESS</span><span class="p">(</span><span class="n">status</span><span class="p">))</span> <span class="p">{</span>
                <span class="k">return</span> <span class="n">status</span><span class="p">;</span>
            <span class="p">}</span>
        <span class="p">}</span>
        <span class="k">else</span> <span class="p">{</span>
            <span class="k">if</span> <span class="p">(</span><span class="n">hRootDirectory</span> <span class="o">==</span> <span class="nb">NULL</span><span class="p">)</span> <span class="p">{</span>
                <span class="k">return</span> <span class="n">STATUS_INVALID_PARAMETER_2</span><span class="p">;</span>
            <span class="p">}</span>
            <span class="n">hDirectory</span> <span class="o">=</span> <span class="n">hRootDirectory</span><span class="p">;</span>
        <span class="p">}</span>

        <span class="c1">// Enumerate objects in directory.</span>
        <span class="n">ctx</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
        <span class="k">do</span> <span class="p">{</span>
            <span class="n">rlen</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
            <span class="n">status</span> <span class="o">=</span> <span class="n">NtQueryDirectoryObject</span><span class="p">(</span><span class="n">hDirectory</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="n">TRUE</span><span class="p">,</span> <span class="n">FALSE</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">ctx</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">rlen</span><span class="p">);</span>
            <span class="k">if</span> <span class="p">(</span><span class="n">status</span> <span class="o">!=</span> <span class="n">STATUS_BUFFER_TOO_SMALL</span><span class="p">)</span>
                    <span class="k">break</span><span class="p">;</span>
            <span class="n">objinf</span> <span class="o">=</span> <span class="n">HeapAlloc</span><span class="p">(</span><span class="n">GetProcessHeap</span><span class="p">(),</span> <span class="n">HEAP_ZERO_MEMORY</span><span class="p">,</span> <span class="n">rlen</span><span class="p">);</span>
            <span class="k">if</span> <span class="p">(</span><span class="n">objinf</span> <span class="o">==</span> <span class="nb">NULL</span><span class="p">)</span>
                <span class="k">break</span><span class="p">;</span>
                
            <span class="n">status</span> <span class="o">=</span> <span class="n">NtQueryDirectoryObject</span><span class="p">(</span><span class="n">hDirectory</span><span class="p">,</span> <span class="n">objinf</span><span class="p">,</span> <span class="n">rlen</span><span class="p">,</span> <span class="n">TRUE</span><span class="p">,</span> <span class="n">FALSE</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">ctx</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">rlen</span><span class="p">);</span>
            <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">NT_SUCCESS</span><span class="p">(</span><span class="n">status</span><span class="p">))</span> <span class="p">{</span>
                <span class="n">HeapFree</span><span class="p">(</span><span class="n">GetProcessHeap</span><span class="p">(),</span> <span class="mi">0</span><span class="p">,</span> <span class="n">objinf</span><span class="p">);</span>
                <span class="k">break</span><span class="p">;</span>
            <span class="p">}</span>

            <span class="n">CallbackStatus</span> <span class="o">=</span> <span class="n">CallbackProc</span><span class="p">(</span><span class="n">objinf</span><span class="p">,</span> <span class="n">CallbackParam</span><span class="p">);</span>
            <span class="n">HeapFree</span><span class="p">(</span><span class="n">GetProcessHeap</span><span class="p">(),</span> <span class="mi">0</span><span class="p">,</span> <span class="n">objinf</span><span class="p">);</span>
            <span class="k">if</span> <span class="p">(</span><span class="n">NT_SUCCESS</span><span class="p">(</span><span class="n">CallbackStatus</span><span class="p">))</span> <span class="p">{</span>
                <span class="n">status</span> <span class="o">=</span> <span class="n">STATUS_SUCCESS</span><span class="p">;</span>
                <span class="k">break</span><span class="p">;</span>
            <span class="p">}</span>
        <span class="p">}</span> <span class="k">while</span> <span class="p">(</span><span class="n">cond</span><span class="p">);</span>

        <span class="k">if</span> <span class="p">(</span><span class="n">hDirectory</span> <span class="o">!=</span> <span class="nb">NULL</span><span class="p">)</span> <span class="p">{</span>
            <span class="n">NtClose</span><span class="p">(</span><span class="n">hDirectory</span><span class="p">);</span>
        <span class="p">}</span>
    <span class="p">}</span>
    <span class="kr">__except</span> <span class="p">(</span><span class="n">EXCEPTION_EXECUTE_HANDLER</span><span class="p">)</span> <span class="p">{</span>
        <span class="n">status</span> <span class="o">=</span> <span class="n">STATUS_ACCESS_VIOLATION</span><span class="p">;</span>
    <span class="p">}</span>

    <span class="k">return</span> <span class="n">status</span><span class="p">;</span>
<span class="p">}</span></code></pre></figure>

<p><i>Credits for this code sample: <a href="https://github.com/hfiref0x/VMDE">VMDE project</a> </i></p>

<hr class="space" />

<p><b>Detections table</b></p>

<table style="width:93%">
  <tr>
  	<td colspan="3">Check if the following global objects exist:</td>
  </tr>
  <tr>
  	<th style="text-align:center">Detect</th>
  	<th style="text-align:center">Path</th>
    <th style="text-align:center">Object</th>
  </tr>
  <tr>
  	<th rowspan="1">Hyper-V</th>
  	<td>VmGenerationCounter</td>
  	<td>\Device</td>
  </tr>
  <tr>
  	<th rowspan="3">Parallels</th>
  	<td>prl_pv</td>
  	<td>\Device</td>
  </tr>
  <tr>
  	<td>prl_tg</td>
  	<td>\Device</td>
  </tr>
  <tr>
  	<td>prl_time</td>
  	<td>\Device</td>
  </tr>
  <tr>
  	<th rowspan="3">Sandboxie</th>
  	<td>SandboxieDriverApi</td>
  	<td>\Device</td>
  </tr>
  <tr>
  	<td>SbieDrv</td>
  	<td>\Driver</td>
  </tr>
  <tr>
  	<td>SbieSvcPort</td>
  	<td>\RPC Control</td>
  </tr>
  <tr>
  	<th rowspan="4">VirtualBox</th>
  	<td>VBoxGuest</td>
  	<td>\Device</td>
  </tr>
  <tr>
  	<td>VBoxMiniRdr</td>
  	<td>\Device</td>
  </tr>
  <tr>
  	<td>VBoxVideo</td>
  	<td>\Driver</td>
  </tr>
  <tr>
  	<td>VBoxMouse</td>
  	<td>\Driver</td>
  </tr>
  <tr>
  	<th rowspan="2">VirtualPC</th>
  	<td>VirtualMachineServices</td>
  	<td>\Device</td>
  </tr>
  <tr>
  	<td>1-driver-vmsrvc</td>
  	<td>\Driver</td>
  </tr>
  <tr>
  	<th rowspan="1">VMware</th>
  	<td>vmmemctl</td>
  	<td>\Device</td>
  </tr>
</table>

<p><br /></p>
<h3><a class="a-dummy" name="check-if-object-directory-present">5. Check for object directory (Sandboxie only)</a></h3>

<p>This method checks for particular object directory which is present in Sandboxie virtual environment but not in usual host systems.</p>

<p>Function used:</p>
<ul>
<li><tt>GetFileAttributes</tt></li> 
</ul>

<hr class="space" />

<p><b>Code sample</b></p>
<p></p>

<figure class="highlight"><pre><code class="language-c" data-lang="c"><span class="cp">#define DIRECTORY_QUERY (0x0001)
#define OBJ_CASE_INSENSITIVE 0x00000040L
#define DIRECTORY_SANDBOXIE L"\\Sandbox"
</span>
<span class="kt">int</span> <span class="nf">check_if_obj_dir_present</span><span class="p">()</span> <span class="p">{</span>
    <span class="n">OBJECT_ATTRIBUTES</span> <span class="n">attr</span><span class="p">;</span>
    <span class="n">UNICODE_STRING</span> <span class="n">ustrName</span><span class="p">;</span>
    <span class="n">HANDLE</span> <span class="n">hObject</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>

    <span class="n">RtlSecureZeroMemory</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ustrName</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">ustrName</span><span class="p">));</span>
    <span class="n">RtlInitUnicodeString</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ustrName</span><span class="p">,</span> <span class="n">DIRECTORY_SANDBOXIE</span><span class="p">);</span>
    <span class="n">InitializeObjectAttributes</span><span class="p">(</span><span class="o">&amp;</span><span class="n">attr</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">ustrName</span><span class="p">,</span> <span class="n">OBJ_CASE_INSENSITIVE</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">);</span>

    <span class="k">if</span> <span class="p">(</span><span class="n">NT_SUCCESS</span><span class="p">(</span><span class="n">NtOpenDirectoryObject</span><span class="p">(</span><span class="o">&amp;</span><span class="n">hObject</span><span class="p">,</span> <span class="n">DIRECTORY_QUERY</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">attr</span><span class="p">)))</span> <span class="p">{</span>
        <span class="n">NtClose</span><span class="p">(</span><span class="n">hObject</span><span class="p">);</span>
        <span class="k">return</span> <span class="n">TRUE</span><span class="p">;</span>
    <span class="p">}</span>
    
    <span class="k">return</span> <span class="n">FALSE</span><span class="p">;</span>
<span class="p">}</span></code></pre></figure>

<p><i>Credits for this code sample: <a href="https://github.com/hfiref0x/VMDE">VMDE project</a> </i></p>

<hr class="space" />

<p><b>Signature recommendations</b></p>
<p></p>
<p>If the following function contains 3rd argument with its field <font face="Courier New">"ObjectName-&gt;Buffer"</font> from the table column <font face="Courier New">`Name`</font>:</p>
<p></p>
<ul>
<li><tt>NtOpenDirectoryObject(..., ..., attr, ...)</tt></li> 
</ul>
<p>then itâ€™s an indication of application trying to use the evasion technique.</p>

<p><br />
3rd argument is of the following type:</p>

<figure class="highlight"><pre><code class="language-c" data-lang="c"><span class="k">typedef</span> <span class="k">struct</span> <span class="n">_OBJECT_ATTRIBUTES</span> <span class="p">{</span>
    <span class="n">ULONG</span> <span class="n">Length</span><span class="p">;</span>
    <span class="n">HANDLE</span> <span class="n">RootDirectory</span><span class="p">;</span>
    <span class="n">PUNICODE_STRING</span> <span class="n">ObjectName</span><span class="p">;</span>
    <span class="n">ULONG</span> <span class="n">Attributes</span><span class="p">;</span>
    <span class="n">PVOID</span> <span class="n">SecurityDescriptor</span><span class="p">;</span>
    <span class="n">PVOID</span> <span class="n">SecurityQualityOfService</span><span class="p">;</span>
<span class="p">}</span> <span class="n">OBJECT_ATTRIBUTES</span><span class="p">;</span></code></pre></figure>

<hr class="space" />

<p><b>Detections table</b></p>

<table style="width:62%">
  <tr>
  	<td colspan="2">Check if the following object directory exists:</td>
  </tr>
  <tr>
  	<th style="text-align:center">Detect</th>
  	<th style="text-align:center">Path</th>
  </tr>
  <tr>
  	<th rowspan="1">Sandboxie</th>
  	<td>\Sandbox</td>
  </tr>
</table>

<p><br /></p>
<h3><a class="a-dummy" name="check-if-virtual-registry-present">6. Check if virtual registry is present in OS (Sandboxie only)</a></h3>

<p>This method checks for virtual registry which is present in Sandboxie virtual environment but not in usual host systems.</p>

<p>Application opens registry key <font face="Courier New">\REGISTRY\USER</font>. It uses the following function in order to check real object name:</p>

<figure class="highlight"><pre><code class="language-c" data-lang="c"><span class="n">NtQueryObject</span><span class="p">(</span>
    <span class="n">hUserKey</span><span class="p">,</span>
    <span class="n">ObjectNameInformation</span><span class="p">,</span>
    <span class="n">oni</span><span class="p">,</span> <span class="c1">// OBJECT_NAME_INFORMATION object</span>
    <span class="n">Size</span><span class="p">,</span>
    <span class="nb">NULL</span><span class="p">);</span></code></pre></figure>

<p>If received <font face="Courier New">OBJECT_NAME_INFORMATION</font> object name does not equal to the <font face="Courier New">"\REGISTRY\USER"</font>, then application assumes that it runs inside Sandboxie environment.</p>

<hr class="space" />

<p><b>Signature recommendations</b></p>
<p></p>
<p>If the following function is used for opening <font face="Courier New">\REGISTRY\USER</font>:</p>
<p></p>
<ul>
<li><tt>NtOpenKey</tt></li> 
</ul>
<p>and is followed by the call of the following function with its 1st argument being the handle of <font face="Courier New">\REGISTRY\USER</font> key:</p>
<ul>
<li><tt>NtQueryObject(hUserKey, ...)</tt></li> 
</ul>
<p>then itâ€™s an indication of application trying to use the evasion technique.</p>

<p><br /></p>
<h3><a class="a-dummy" name="countermeasures">Countermeasures</a></h3>

<p>Hook target functions and return appropriate results if indicators (objects from tables) are triggered. In some cases stopping appropriate device may help â€” but itâ€™s not a universal counter-action: not all global objects are devices.</p>

<p><br /></p>
<h3><a class="a-dummy" name="credits">Credits</a></h3>

<p>Credits go to open-source project from where code samples were taken:</p>
<ul>
<li>VMDE project on <a href="https://github.com/hfiref0x/VMDE">github</a></li>
</ul>

<p>Though Check Point tool InviZzzible has them all implemented, due to modular structure of the code it would require more space to show a code sample from this tool for the same purposes. Thatâ€™s why weâ€™ve decided to use other great open-source projects for examples throughout the encyclopedia.</p>


    <br>
    <div style="text-align: left">
        <a href="..">Go back</a>
    </div>
    <br>
    <div class="sharebuttons" style="text-align: center">
        <hr />
        <ul>
          <li>
            <p class="sharetitle"> Share this: </p>
          </li>
          <li class="reddit">
            <a href="http://www.reddit.com/submit?url=https://evasions.checkpoint.com/src/Evasions/techniques/global-os-objects.html&title=Evasions:%20Global%20OS%20Objects - Evasion Techniques" target="_blank">
                <svg xmlns="http://www.w3.org/2000/svg"
                aria-label="Reddit" role="img"
                viewBox="0 0 512 512"><rect
                width="512" height="512"
                rx="15%"
                fill="#f40"/><g fill="#fff"><ellipse cx="256" cy="307" rx="166" ry="117"/><circle cx="106" cy="256" r="42"/><circle cx="407" cy="256" r="42"/><circle cx="375" cy="114" r="32"/></g><g stroke-linecap="round" stroke-linejoin="round" fill="none"><path d="m256 196 23-101 73 15" stroke="#fff" stroke-width="16"/><path d="m191 359c33 25 97 26 130 0" stroke="#f40" stroke-width="13"/></g><g fill="#f40"><circle cx="191" cy="287" r="31"/><circle cx="321" cy="287" r="31"/></g></svg>
                
            </a>
          </li>
          <li class="hn">
            <a href="http://news.ycombinator.com/submitlink?u=https://evasions.checkpoint.com/src/Evasions/techniques/global-os-objects.html&t=Evasions:%20Global%20OS%20Objects - Evasion Techniques" target="_blank">
                <svg xmlns="http://www.w3.org/2000/svg"
                aria-label="Hacker News" role="img"
                viewBox="0 0 512 512"><rect
                width="512" height="512"
                rx="15%"
                fill="#f60"/><path fill="#fff" d="M124 91h51l81 162 81-164h51L276 293v136h-40V293z"/></svg>
            </a>
          </li>
          <li class="twitter">
            <a href="https://twitter.com/intent/tweet?via=_CPResearch_&url=https://evasions.checkpoint.com/src/Evasions/techniques/global-os-objects.html&text=Evasions:%20Global%20OS%20Objects - Evasion Techniques" target="_blank">
                <svg viewBox="0 0 1792 1792" xmlns="http://www.w3.org/2000/svg"><path d="M1684 408q-67 98-162 167 1 14 1 42 0 130-38 259.5t-115.5 248.5-184.5 210.5-258 146-323 54.5q-271 0-496-145 35 4 78 4 225 0 401-138-105-2-188-64.5t-114-159.5q33 5 61 5 43 0 85-11-112-23-185.5-111.5t-73.5-205.5v-4q68 38 146 41-66-44-105-115t-39-154q0-88 44-163 121 149 294.5 238.5t371.5 99.5q-8-38-8-74 0-134 94.5-228.5t228.5-94.5q140 0 236 102 109-21 205-78-37 115-142 178 93-10 186-50z"/></svg>
            </a>
          </li>
          <li class="linkedin">
            <a href=https://www.linkedin.com/shareArticle?mini=true&url=https://evasions.checkpoint.com/src/Evasions/techniques/global-os-objects.html&title=Evasions:%20Global%20OS%20Objects - Evasion Techniques&source=LinkedIn" target="_blank">
                <svg viewBox="0 0 1792 1792" xmlns="http://www.w3.org/2000/svg"><path d="M477 625v991h-330v-991h330zm21-306q1 73-50.5 122t-135.5 49h-2q-82 0-132-49t-50-122q0-74 51.5-122.5t134.5-48.5 133 48.5 51 122.5zm1166 729v568h-329v-530q0-105-40.5-164.5t-126.5-59.5q-63 0-105.5 34.5t-63.5 85.5q-11 30-11 81v553h-329q2-399 2-647t-1-296l-1-48h329v144h-2q20-32 41-56t56.5-52 87-43.5 114.5-15.5q171 0 275 113.5t104 332.5z"/></svg>
            </a>
          </li>
        </ul>
      </div>
      
</article>


</section>

<nav class="navbar navbar-default navbar-fixed-bottom">
  <div class="container footer-content">

    Made with <font class="a-pink"><i class ="fa fa-heart"></i></font> to serve the community by Check Point Research    |    <a class="a-pink" href="https://research.checkpoint.com">Research blog</a>    |    <a class="a-pink" href="https://research.checkpoint.com/about-us/">About Us</a>    |    <a class="a-pink" href="https://github.com/CheckPointSW"><i class="fa fa-github fa-lg"></i></a> <a class="a-pink" href="https://twitter.com/_CPResearch_"><i class="fa fa-twitter fa-lg"></i></a>
    
    <br>
    
    Â© 1994-2024 Check Point Software Technologies LTD | All rights reserved | Property of CheckPoint.com


  </div>
</nav>

  </body>

</html>
