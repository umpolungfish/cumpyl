<!DOCTYPE html>
<html>

  <head>
  <meta charset="utf-8">
  <meta http-equiv="X-UA-Compatible" content="IE=edge">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-194688-3"></script>
  <script>
   window.dataLayer = window.dataLayer || [];
   function gtag(){dataLayer.push(arguments);}
   gtag('js', new Date());
   gtag('config', 'UA-194688-3');
  </script>
  <meta content="Evasion techniques" property="og:site_name">

  <meta content="Evasions: Timing" property="og:title">


  <meta name="twitter:title" content="Malware Evasion Encyclopedia" />
  <meta name="twitter:image" content="https://research.checkpoint.com/wp-content/uploads/2020/02/evasions.jpg" />


  <meta content="article" property="og:type">


  <meta content="Evasion techniques
" property="og:description">


  <meta content="https://evasions.checkpoint.com/src/Evasions/techniques/timing.html" property="og:url">


  <meta content="2024-07-10T07:20:28+00:00" property="article:published_time">
  <meta content="https://evasions.checkpoint.com/about/" property="article:author">


  <meta property="og:image" content="">


  
  <meta content="evasions" property="article:section">
  


  
  <meta content="timing" property="article:tag">
  

  <title>Evasions: Timing</title>
  <meta name="description" content="Contents">
<script src="https://ajax.googleapis.com/ajax/libs/jquery/2.2.2/jquery.min.js"></script>
<script src="https://maxcdn.bootstrapcdn.com/bootstrap/3.3.6/js/bootstrap.min.js" integrity="sha384-0mSbJDEHialfmuBBQP6A4Qrprq5OVfW37PRR3j5ELqxss1yVqOtnepnHVP9aJ7xS" crossorigin="anonymous"></script>
  <link rel="stylesheet" href="https://evasions.checkpoint.com/assets/css/main.css">
<script src="https://maxcdn.bootstrapcdn.com/bootstrap/3.3.6/js/bootstrap.min.js" integrity="sha384-0mSbJDEHialfmuBBQP6A4Qrprq5OVfW37PRR3j5ELqxss1yVqOtnepnHVP9aJ7xS" crossorigin="anonymous"></script>

  <link href='https://fonts.googleapis.com/css?family=PT+Sans' rel='stylesheet' type='text/css'>
  <link href='https://fonts.googleapis.com/css?family=Fira+Mono' rel='stylesheet' type='text/css'>
  <link href='https://fonts.googleapis.com/css?family=Lato:400,700' rel='stylesheet' type='text/css'>
  <link href='https://fonts.googleapis.com/css?family=Source+Code+Pro:400,200,300,500,600,700,900' rel='stylesheet' type='text/css'>
  <link href='https://fonts.googleapis.com/css?family=Gentium+Basic:400,700' rel='stylesheet' type='text/css'>
  <link href='https://fonts.googleapis.com/css?family=Alegreya:400,400italic,700' rel='stylesheet' type='text/css'>
  <link href='https://fonts.googleapis.com/css?family=Lora:400,400italic,700' rel='stylesheet' type='text/css'>
  <link href='https://fonts.googleapis.com/css?family=Fira+Sans:400,300,500,700' rel='stylesheet' type='text/css'>
  <script src="https://ajax.googleapis.com/ajax/libs/jquery/2.2.0/jquery.min.js"></script>
  <link href='https://fonts.googleapis.com/css?family=Open+Sans:400,700' rel='stylesheet' type='text/css'>
  <link href="https://maxcdn.bootstrapcdn.com/bootstrap/3.3.6/css/bootstrap.min.css" rel="stylesheet" integrity="sha384-1q8mTJOASx8j1Au+a5WDVnPi2lkFfwwEAa8hDDdjZlpLegxhjVME1fgjWPGmkzs7" crossorigin="anonymous">
  <link href="https://maxcdn.bootstrapcdn.com/font-awesome/4.6.1/css/font-awesome.min.css" rel="stylesheet" integrity="sha384-hQpvDQiCJaD2H465dQfA717v7lu5qHWtDbWNPvaTJ0ID5xnPUlVXnKzq7b8YUkbN" crossorigin="anonymous">
  <link rel="canonical" href="https://evasions.checkpoint.com/src/Evasions/techniques/timing.html">
  <link rel="alternate" type="application/rss+xml" title="Evasion techniques" href="https://evasions.checkpoint.com/feed.xml">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/tinysort/2.3.6/tinysort.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/tinysort/2.3.6/tinysort.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/tinysort/2.3.6/tinysort.charorder.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/tinysort/2.3.6/tinysort.charorder.min.js"></script>
  <script type="text/javascript" async src="//platform.twitter.com/widgets.js"></script>




</head>


  <body>
<section>
<article class="post" itemscope itemtype="http://schema.org/BlogPosting">
  <div class="jumbotron">
    <div class="container">
      <h1 class="post-title-main" itemprop="name headline">Evasions: Timing</h1>
    </div>
</div>

  <div class="post-content container" itemprop="articleBody">
    <div style="text-align: left">
        <a href="..">Go back</a>
        <br>
        <br>
    </div>
    <h1>Contents</h1>

<p><a href="#time-based-sandbox-evasion-techniques">Time-based sandbox evasion techniques</a>
<br />
  <a href="#delayed-execution">1. Delayed execution</a>
<br />
  <a href="#simple-delaying-operation">1.1. Simple delaying operation</a>
<br />
  <a href="#deferred-execution-using-task-scheduler">1.2. Deferred execution using Task Scheduler</a>
<br />
  <a href="#no-suspicious-actions-until-reboot">1.3. No suspicious actions until reboot</a>
<br />
  <a href="#running-only-on-certain-dates">1.4. Running only on certain dates</a>
<br />
  <a href="#sleep-skipping-detection">2. Sleep skipping detection</a>
<br />
  <a href="#parallel-delays">2.1. Parallel delays using different methods</a>
<br />
  <a href="#measure-time-intervals">2.2. Measure time intervals using different methods</a>
<br />
  <a href="#get-system-time">2.3. Get system time using different methods</a>
<br />
  <a href="#delay-value-changed">2.4. Check if the delay value changes after calling a delay function</a>
<br />
  <a href="#absolute-timeout">2.5. Use absolute timeout</a>
<br />
  <a href="#get-time-another-process">2.6. Get time from another process</a>
<br />
  <a href="#get-time-ntp">3. Get the current date and time from an external source (NTP, HTTP)</a>
<br />
  <a href="#difference-vm-hosts">4. Difference in time measurement in VM and hosts</a>
<br />
  <a href="#rdtsc">4.1. RDTSC (with CPUID to force a VM Exit)</a>
<br />
  <a href="#rdtsc-locky">4.2. RDTSC (Locky version with GetProcessHeap and CloseHandle)</a>
<br />
  <a href="#check-system-boot-time">5. Check the system last boot time using different methods</a>
<br />
  <a href="#call-hooked-function-with-invalid-arguments">6. Call a potentially hooked delay function with invalid arguments</a>
<br />
  <a href="#countermeasures">Countermeasures</a>
<br />
<a href="#credits">Credits</a>
<br />
<br /></p>

<hr class="space" />

<h2><a class="a-dummy" name="time-based-sandbox-evasion-techniques">Time-based sandbox evasion techniques</a></h2>
<p>Sandbox emulation usually lasts a short time because sandboxes are heavy loaded with thousands of samples. Emulation
time rarely exceeds 3-5 minutes. Therefore, malware can use this fact to avoid detection: it may perform
long delays before starting any malicious activity.<br />
To counteract this, sandboxes may implement features which manipulate time and execution delays. For example, the Cuckoo 
sandbox has a sleep skipping feature that replaces delays with a very short value. This should force the malware to start 
its malicious activity before an analysis timeout.</p>

<div style="text-align: center">
  <img src="../assets/images/sleep_skipping.png" />
</div>
<p><br />
However, this can also be used to detect a sandbox.<br />
There are also some differences in the time of execution of some instructions and API functions that
can be used to detect a virtual environment.</p>
<p>
<i>Signature recommendations are not provided for this class of techniques as executing functions described in this 
chapter does not imply their usage for evasion purposes. It is hard to differentiate between the code which aims to 
perform an evasion code and the one which uses the same functions with non-evasion intentions. </i>
</p>

<p><br /></p>
<h3><a class="a-dummy" name="delayed-execution">1. Delayed execution</a></h3>
<p>Execution delays are used to avoid detection of malicious activity during the emulation time.
<br /></p>
<h4><a class="a-dummy" name="simple-delaying-operation">1.1. Simple delaying operation</a></h4>
<p>Functions used:</p>
<ul>
<li><tt>Sleep, SleepEx, NtDelayExecution</tt></li>
<li><tt>WaitForSingleObject, WaitForSingleObjectEx, NtWaitForSingleObject</tt></li>
<li><tt>WaitForMultipleObjects, WaitForMultipleObjectsEx, NtWaitForMultipleObjects</tt></li>
<li><tt>SetTimer, SetWaitableTimer, CreateTimerQueueTimer</tt></li>
<li><tt>timeSetEvent</tt> (multimedia timers)</li>
<li><tt>IcmpSendEcho</tt></li>
<li><tt>select</tt> (Windows sockets)</li>
</ul>
<p>While the use of most of these functions is obvious, we show examples of using the <tt>timeSetEvent</tt> function
from Multimedia API and the <tt>select</tt> function from the Windows sockets API.<br />
<br />
<b>Code sample (delay using the “select” function)</b></p>

<figure class="highlight"><pre><code class="language-c" data-lang="c"><span class="kt">int</span> <span class="n">iResult</span><span class="p">;</span>
<span class="n">DWORD</span> <span class="n">timeout</span> <span class="o">=</span> <span class="n">delay</span><span class="p">;</span> <span class="c1">// delay in milliseconds</span>
<span class="n">DWORD</span> <span class="n">OK</span> <span class="o">=</span> <span class="n">TRUE</span><span class="p">;</span>

<span class="n">SOCKADDR_IN</span> <span class="n">sa</span> <span class="o">=</span> <span class="p">{</span> <span class="mi">0</span> <span class="p">};</span>
<span class="n">SOCKET</span> <span class="n">sock</span> <span class="o">=</span> <span class="n">INVALID_SOCKET</span><span class="p">;</span>

<span class="c1">// this code snippet should take around Timeout milliseconds</span>
<span class="k">do</span> <span class="p">{</span>
    <span class="n">memset</span><span class="p">(</span><span class="o">&amp;</span><span class="n">sa</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">sa</span><span class="p">));</span>
    <span class="n">sa</span><span class="p">.</span><span class="n">sin_family</span> <span class="o">=</span> <span class="n">AF_INET</span><span class="p">;</span>
    <span class="n">sa</span><span class="p">.</span><span class="n">sin_addr</span><span class="p">.</span><span class="n">s_addr</span> <span class="o">=</span> <span class="n">inet_addr</span><span class="p">(</span><span class="s">"8.8.8.8"</span><span class="p">);</span>    <span class="c1">// we should have a route to this IP address</span>
    <span class="n">sa</span><span class="p">.</span><span class="n">sin_port</span> <span class="o">=</span> <span class="n">htons</span><span class="p">(</span><span class="mi">80</span><span class="p">);</span> <span class="c1">// we should not be able to connect to this port</span>

    <span class="n">sock</span> <span class="o">=</span> <span class="n">socket</span><span class="p">(</span><span class="n">AF_INET</span><span class="p">,</span> <span class="n">SOCK_STREAM</span><span class="p">,</span> <span class="n">IPPROTO_TCP</span><span class="p">);</span>
    <span class="k">if</span> <span class="p">(</span><span class="n">sock</span> <span class="o">==</span> <span class="n">INVALID_SOCKET</span><span class="p">)</span> <span class="p">{</span>
        <span class="n">OK</span> <span class="o">=</span> <span class="n">FALSE</span><span class="p">;</span>
        <span class="k">break</span><span class="p">;</span>
    <span class="p">}</span>

    <span class="c1">// setting socket timeout</span>
    <span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">iMode</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
    <span class="n">iResult</span> <span class="o">=</span> <span class="n">ioctlsocket</span><span class="p">(</span><span class="n">sock</span><span class="p">,</span> <span class="n">FIONBIO</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">iMode</span><span class="p">);</span>

    <span class="n">iResult</span> <span class="o">=</span> <span class="n">connect</span><span class="p">(</span><span class="n">sock</span><span class="p">,</span> <span class="p">(</span><span class="n">SOCKADDR</span><span class="o">*</span><span class="p">)</span><span class="o">&amp;</span><span class="n">sa</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">sa</span><span class="p">));</span>
    <span class="k">if</span> <span class="p">(</span><span class="n">iResult</span> <span class="o">==</span> <span class="nb">false</span><span class="p">)</span> <span class="p">{</span>
        <span class="n">OK</span> <span class="o">=</span> <span class="n">FALSE</span><span class="p">;</span>
        <span class="k">break</span><span class="p">;</span>
    <span class="p">}</span>

    <span class="n">iMode</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
    <span class="n">iResult</span> <span class="o">=</span> <span class="n">ioctlsocket</span><span class="p">(</span><span class="n">sock</span><span class="p">,</span> <span class="n">FIONBIO</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">iMode</span><span class="p">);</span>
    <span class="k">if</span> <span class="p">(</span><span class="n">iResult</span> <span class="o">!=</span> <span class="n">NO_ERROR</span><span class="p">)</span> <span class="p">{</span>
        <span class="n">OK</span> <span class="o">=</span> <span class="n">FALSE</span><span class="p">;</span>
        <span class="k">break</span><span class="p">;</span>
    <span class="p">}</span>

    <span class="c1">// fd set data</span>
    <span class="n">fd_set</span> <span class="n">Write</span><span class="p">,</span> <span class="n">Err</span><span class="p">;</span>
    <span class="n">FD_ZERO</span><span class="p">(</span><span class="o">&amp;</span><span class="n">Write</span><span class="p">);</span>
    <span class="n">FD_ZERO</span><span class="p">(</span><span class="o">&amp;</span><span class="n">Err</span><span class="p">);</span>
    <span class="n">FD_SET</span><span class="p">(</span><span class="n">sock</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">Write</span><span class="p">);</span>
    <span class="n">FD_SET</span><span class="p">(</span><span class="n">sock</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">Err</span><span class="p">);</span>
    <span class="n">timeval</span> <span class="n">tv</span> <span class="o">=</span> <span class="p">{</span> <span class="mi">0</span> <span class="p">};</span>
    <span class="n">tv</span><span class="p">.</span><span class="n">tv_usec</span> <span class="o">=</span> <span class="n">timeout</span> <span class="o">*</span> <span class="mi">1000</span><span class="p">;</span>

    <span class="c1">// check if the socket is ready, this call should take Timeout milliseconds</span>
    <span class="n">select</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">Write</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">Err</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">tv</span><span class="p">);</span>
    
    <span class="k">if</span> <span class="p">(</span><span class="n">FD_ISSET</span><span class="p">(</span><span class="n">sock</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">Err</span><span class="p">))</span> <span class="p">{</span>
        <span class="n">OK</span> <span class="o">=</span> <span class="n">FALSE</span><span class="p">;</span>
        <span class="k">break</span><span class="p">;</span>
    <span class="p">}</span>

<span class="p">}</span> <span class="k">while</span> <span class="p">(</span><span class="nb">false</span><span class="p">);</span>

<span class="k">if</span> <span class="p">(</span><span class="n">sock</span> <span class="o">!=</span> <span class="n">INVALID_SOCKET</span><span class="p">)</span>
    <span class="n">closesocket</span><span class="p">(</span><span class="n">sock</span><span class="p">);</span></code></pre></figure>

<p><br />
<b>Code sample (delay using the “timeSetEvent” function)</b></p>

<figure class="highlight"><pre><code class="language-c" data-lang="c"><span class="n">VOID</span> <span class="n">CALLBACK</span> <span class="nf">TimerFunction</span><span class="p">(</span><span class="n">UINT</span> <span class="n">uTimerID</span><span class="p">,</span> <span class="n">UINT</span> <span class="n">uMsg</span><span class="p">,</span> <span class="n">DWORD_PTR</span> <span class="n">dwUser</span><span class="p">,</span> <span class="n">DWORD_PTR</span> <span class="n">dw1</span><span class="p">,</span> <span class="n">DWORD_PTR</span> <span class="n">dw2</span><span class="p">)</span>
<span class="p">{</span>
    <span class="n">bProcessed</span> <span class="o">=</span> <span class="n">TRUE</span><span class="p">;</span>
<span class="p">}</span>

<span class="n">VOID</span> <span class="nf">timing_timeSetEvent</span><span class="p">(</span><span class="n">UINT</span> <span class="n">delayInSeconds</span><span class="p">)</span>
<span class="p">{</span>
    <span class="c1">// Some vars</span>
    <span class="n">UINT</span> <span class="n">uResolution</span><span class="p">;</span>
    <span class="n">TIMECAPS</span> <span class="n">tc</span><span class="p">;</span>
    <span class="n">MMRESULT</span> <span class="n">idEvent</span><span class="p">;</span>

    <span class="c1">// We can obtain this minimum value by calling</span>
    <span class="n">timeGetDevCaps</span><span class="p">(</span><span class="o">&amp;</span><span class="n">tc</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">TIMECAPS</span><span class="p">));</span>
    <span class="n">uResolution</span> <span class="o">=</span> <span class="n">min</span><span class="p">(</span><span class="n">max</span><span class="p">(</span><span class="n">tc</span><span class="p">.</span><span class="n">wPeriodMin</span><span class="p">,</span> <span class="mi">0</span><span class="p">),</span> <span class="n">tc</span><span class="p">.</span><span class="n">wPeriodMax</span><span class="p">);</span>

    <span class="c1">// Create the timer</span>
    <span class="n">idEvent</span> <span class="o">=</span> <span class="n">timeSetEvent</span><span class="p">(</span>
        <span class="n">delayInSeconds</span><span class="p">,</span>
        <span class="n">uResolution</span><span class="p">,</span>
        <span class="n">TimerFunction</span><span class="p">,</span>
        <span class="mi">0</span><span class="p">,</span>
        <span class="n">TIME_ONESHOT</span><span class="p">);</span>

    <span class="k">while</span> <span class="p">(</span><span class="o">!</span><span class="n">bProcessed</span><span class="p">){</span>
        <span class="c1">// wait until our function finishes</span>
        <span class="n">Sleep</span><span class="p">(</span><span class="mi">0</span><span class="p">);</span>
    <span class="p">}</span>

    <span class="c1">// destroy the timer</span>
    <span class="n">timeKillEvent</span><span class="p">(</span><span class="n">idEvent</span><span class="p">);</span>

    <span class="c1">// reset the timer</span>
    <span class="n">timeEndPeriod</span><span class="p">(</span><span class="n">uResolution</span><span class="p">);</span>
<span class="p">}</span></code></pre></figure>

<p><i>Credits for this code sample: <a href="https://github.com/LordNoteworthy/al-khaser">al-khaser project</a></i></p>
<p><br /></p>
<h4><a class="a-dummy" name="deferred-execution-using-task-scheduler">1.2. Deferred execution using Task Scheduler</a></h4>
<p>This method can be used both for delaying execution and evading sandbox tracking.
<br /><br />
<b>Code sample (PowerShell)</b></p>

<figure class="highlight"><pre><code class="language-powershell" data-lang="powershell"><span class="w">    </span><span class="nv">$tm</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">(</span><span class="n">get-date</span><span class="p">)</span><span class="o">.</span><span class="nf">AddMinutes</span><span class="p">(</span><span class="nx">10</span><span class="p">)</span><span class="o">.</span><span class="nf">ToString</span><span class="p">(</span><span class="s2">"HH:mm"</span><span class="p">)</span><span class="w">
    </span><span class="nv">$action</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">New-ScheduledTaskAction</span><span class="w"> </span><span class="nt">-Execute</span><span class="w"> </span><span class="s2">"some_malicious_app.exe"</span><span class="w">
    </span><span class="nv">$trigger</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">New-ScheduledTaskTrigger</span><span class="w"> </span><span class="nt">-Once</span><span class="w"> </span><span class="nt">-At</span><span class="w"> </span><span class="nv">$tm</span><span class="w">
    </span><span class="n">Register-ScheduledTask</span><span class="w"> </span><span class="nx">TaskName</span><span class="w"> </span><span class="nt">-Action</span><span class="w"> </span><span class="nv">$action</span><span class="w"> </span><span class="nt">-Trigger</span><span class="w"> </span><span class="nv">$trigger</span></code></pre></figure>

<p><br /></p>
<h4><a class="a-dummy" name="no-suspicious-actions-until-reboot">1.3. No suspicious actions until reboot</a></h4>
<p>The idea behind this technique is that a sandbox doesn’t reboot a virtual machine during the emulation of a
malicious sample. The malware may just set up persistence using any of available methods and silently exit.
Malicious actions are performed only after the system is rebooted.</p>

<h4><a class="a-dummy" name="running-only-on-certain-dates">1.4. Running only on certain dates</a></h4>
<p>Malware samples may check the current date and perform malicious actions only on certain dates. For example,
this technique was used in the <a href="https://www.cyphort.com/sazoora-dissecting-bundle-evasion-stealth/">Sazoora malware</a>, 
which checks the current date and verifies if the day is either the 16th, 17th or 18th 
of a given month.</p>
<p><b>Example:</b></p>
<div style="text-align: center">
  <img src="../assets/images/date_anti_sb.png" />
</div>
<p><br /></p>

<p><b>Countermeasures</b></p>
<p></p>
<p>Countermeasures for this class of evasion techniques should be comprehensive and include all described attack vectors.
The implementation cannot be simple and its description deserves a separate article. Therefore, we only provide general
recommendations here:</p>
<ul>
<li>Implement sleep skipping.</li>
<li>System-wide dynamic time flow speed manipulation.</li>
<li>Run emulation multiple times on different dates.</li>
</ul>
<p>Although sleep skipping is already implemented in the Cuckoo sandbox, it is very easy to deceive it. 
Sleep skipping is disabled after a new thread or process is created to avoid sleep skipping detection.
However, it can still be easily detected as shown below.</p>

<h3><a class="a-dummy" name="sleep-skipping-detection">2. Sleep skipping detection</a></h3>
<p>Techniques of this type are generally aimed at the Cuckoo monitor sleep skipping feature and other time-manipulation
techniques that can be used in sandboxes to skip long delays performed by the malware.</p>
<h4><a class="a-dummy" name="parallel-delays">2.1. Parallel delays using different methods</a></h4>
<p>The idea behind the techniques is to perform different types of delays in parallel and to measure the elapsed time.
<br /><br />
<b>Code sample</b></p>

<figure class="highlight"><pre><code class="language-c" data-lang="c"><span class="n">DWORD</span> <span class="n">StartingTick</span><span class="p">,</span> <span class="n">TimeElapsedMs</span><span class="p">;</span>
<span class="n">LARGE_INTEGER</span> <span class="n">DueTime</span><span class="p">;</span>
<span class="n">HANDLE</span> <span class="n">hTimer</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
<span class="n">TIMER_BASIC_INFORMATION</span> <span class="n">TimerInformation</span><span class="p">;</span>
<span class="n">ULONG</span> <span class="n">ReturnLength</span><span class="p">;</span>

<span class="n">hTimer</span> <span class="o">=</span> <span class="n">CreateWaitableTimer</span><span class="p">(</span><span class="nb">NULL</span><span class="p">,</span> <span class="n">TRUE</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">);</span>
<span class="n">DueTime</span><span class="p">.</span><span class="n">QuadPart</span> <span class="o">=</span> <span class="n">Timeout</span> <span class="o">*</span> <span class="p">(</span><span class="o">-</span><span class="mi">10000LL</span><span class="p">);</span>

<span class="n">StartingTick</span> <span class="o">=</span> <span class="n">GetTickCount</span><span class="p">();</span>
<span class="n">SetWaitableTimer</span><span class="p">(</span><span class="n">hTimer</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">DueTime</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
<span class="k">do</span>
<span class="p">{</span>
    <span class="n">Sleep</span><span class="p">(</span><span class="n">Timeout</span><span class="o">/</span><span class="mi">10</span><span class="p">);</span>
    <span class="n">NtQueryTimer</span><span class="p">(</span><span class="n">hTimer</span><span class="p">,</span> <span class="n">TimerBasicInformation</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">TimerInformation</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">TIMER_BASIC_INFORMATION</span><span class="p">),</span> <span class="o">&amp;</span><span class="n">ReturnLength</span><span class="p">);</span>
<span class="p">}</span> <span class="k">while</span> <span class="p">(</span><span class="o">!</span><span class="n">TimerInformation</span><span class="p">.</span><span class="n">TimerState</span><span class="p">);</span>

<span class="n">CloseHandle</span><span class="p">(</span><span class="n">hTimer</span><span class="p">);</span>

<span class="n">TimeElapsedMs</span> <span class="o">=</span> <span class="n">GetTickCount</span><span class="p">()</span> <span class="o">-</span> <span class="n">StartingTick</span><span class="p">;</span>
<span class="n">printf</span><span class="p">(</span><span class="s">"Requested delay: %d, elapsed time: %d</span><span class="se">\n</span><span class="s">"</span><span class="p">,</span> <span class="n">Timeout</span><span class="p">,</span> <span class="n">TimeElapsedMs</span><span class="p">);</span>

<span class="k">if</span> <span class="p">(</span><span class="n">abs</span><span class="p">((</span><span class="n">LONG</span><span class="p">)(</span><span class="n">TimeElapsedMs</span> <span class="o">-</span> <span class="n">Timeout</span><span class="p">))</span> <span class="o">&gt;</span> <span class="n">Timeout</span> <span class="o">/</span> <span class="mi">2</span><span class="p">)</span>
    <span class="n">printf</span><span class="p">(</span><span class="s">"Sleep-skipping DETECTED!</span><span class="se">\n</span><span class="s">"</span><span class="p">);</span></code></pre></figure>

<p><br />
In the code sample above, the delay timeout is set using the <tt>SetWaitableTimer()</tt> timer function. 
The <tt>Sleep()</tt> function is called in a loop until the timer timeout. In the Cuckoo sandbox, delays that are performed 
by the <tt>Sleep()</tt> function are skipped (replaced with a very short timeout) and the virtually elapsed 
time will be much higher than the requested timeout:</p>

<figure class="highlight"><pre><code class="language-plaintex" data-lang="plaintex">    Requested delay: 60000, elapsed time: 1906975
    Sleep-skipping DETECTED!</code></pre></figure>

<p><br /></p>
<h4><a class="a-dummy" name="measure-time-intervals">2.2. Measure time intervals using different methods</a></h4>
<p>We need to perform a delay that will be skipped in a sandbox and to measure elapsed time using different methods.
While the Cuckoo monitor hooks the <tt>GetTickCount()</tt>, <tt>GetLocalTime()</tt>, <tt>GetSystemTime()</tt> and
makes them return the skipped time, we still can find methods to measure time that are not handled by the Cuckoo 
monitor.</p>

<p>Functions used:</p>
<ul>
  <li><tt>GetTickCount64</tt></li>
  <li><tt>QueryPerformanceFrequency, QueryPerformanceCounter</tt></li> 
  <li><tt>NtQuerySystemInformation</tt></li>
</ul>

<p><br /><br />
<b>Code sample (using “QueryPerformanceCounter” to measure elapsed time)</b></p>

<figure class="highlight"><pre><code class="language-c" data-lang="c"><span class="n">LARGE_INTEGER</span> <span class="n">StartingTime</span><span class="p">,</span> <span class="n">EndingTime</span><span class="p">;</span>
<span class="n">LARGE_INTEGER</span> <span class="n">Frequency</span><span class="p">;</span>
<span class="n">DWORD</span> <span class="n">TimeElapsedMs</span><span class="p">;</span>

<span class="n">QueryPerformanceFrequency</span><span class="p">(</span><span class="o">&amp;</span><span class="n">Frequency</span><span class="p">);</span>
<span class="n">QueryPerformanceCounter</span><span class="p">(</span><span class="o">&amp;</span><span class="n">StartingTime</span><span class="p">);</span>

<span class="n">Sleep</span><span class="p">(</span><span class="n">Timeout</span><span class="p">);</span>

<span class="n">QueryPerformanceCounter</span><span class="p">(</span><span class="o">&amp;</span><span class="n">EndingTime</span><span class="p">);</span>
<span class="n">TimeElapsedMs</span> <span class="o">=</span> <span class="p">(</span><span class="n">DWORD</span><span class="p">)(</span><span class="mi">1000ll</span> <span class="o">*</span> <span class="p">(</span><span class="n">EndingTime</span><span class="p">.</span><span class="n">QuadPart</span> <span class="o">-</span> <span class="n">StartingTime</span><span class="p">.</span><span class="n">QuadPart</span><span class="p">)</span> <span class="o">/</span> <span class="n">Frequency</span><span class="p">.</span><span class="n">QuadPart</span><span class="p">);</span>

<span class="n">printf</span><span class="p">(</span><span class="s">"Requested delay: %d, elapsed time: %d</span><span class="se">\n</span><span class="s">"</span><span class="p">,</span> <span class="n">Timeout</span><span class="p">,</span> <span class="n">TimeElapsedMs</span><span class="p">);</span>

<span class="k">if</span> <span class="p">(</span><span class="n">abs</span><span class="p">((</span><span class="n">LONG</span><span class="p">)(</span><span class="n">TimeElapsedMs</span> <span class="o">-</span> <span class="n">Timeout</span><span class="p">))</span> <span class="o">&gt;</span> <span class="n">Timeout</span> <span class="o">/</span> <span class="mi">2</span><span class="p">)</span>
    <span class="n">printf</span><span class="p">(</span><span class="s">"Sleep-skipping DETECTED!</span><span class="se">\n</span><span class="s">"</span><span class="p">);</span></code></pre></figure>

<p><br /><br />
<b>Code sample (using “GetTickCount64” to measure elapsed time)</b></p>

<figure class="highlight"><pre><code class="language-c" data-lang="c"><span class="n">ULONGLONG</span> <span class="n">tick</span><span class="p">;</span>
<span class="n">DWORD</span> <span class="n">TimeElapsedMs</span><span class="p">;</span>

<span class="n">tick</span> <span class="o">=</span> <span class="n">GetTickCount64</span><span class="p">();</span>
<span class="n">Sleep</span><span class="p">(</span><span class="n">Timeout</span><span class="p">);</span>
<span class="n">TimeElapsedMs</span> <span class="o">=</span> <span class="n">GetTickCount64</span><span class="p">()</span> <span class="o">-</span> <span class="n">tick</span><span class="p">;</span>

<span class="n">printf</span><span class="p">(</span><span class="s">"Requested delay: %d, elapsed time: %d</span><span class="se">\n</span><span class="s">"</span><span class="p">,</span> <span class="n">Timeout</span><span class="p">,</span> <span class="n">TimeElapsedMs</span><span class="p">);</span>

<span class="k">if</span> <span class="p">(</span><span class="n">abs</span><span class="p">((</span><span class="n">LONG</span><span class="p">)(</span><span class="n">TimeElapsedMs</span> <span class="o">-</span> <span class="n">Timeout</span><span class="p">))</span> <span class="o">&gt;</span> <span class="n">Timeout</span> <span class="o">/</span> <span class="mi">2</span><span class="p">)</span>
    <span class="n">printf</span><span class="p">(</span><span class="s">"Sleep-skipping DETECTED!</span><span class="se">\n</span><span class="s">"</span><span class="p">);</span></code></pre></figure>

<p>We can also use our own implementation of <tt>GetTickCount</tt> to detect sleep skipping.
In the next code sample, we acquire the tick count directly from the <tt>KUSER_SHARED_DATA</tt> structure. 
This way we can get the original tick count value even if the <tt>GetTickCount()</tt> function was hooked.
<br /><br />
<b>Code sample (getting the tick count from the KUSER_SHARED_DATA structure)</b></p>

<figure class="highlight"><pre><code class="language-c" data-lang="c"><span class="cp">#define KI_USER_SHARED_DATA         0x7FFE0000
#define SharedUserData  ((KUSER_SHARED_DATA * const) KI_USER_SHARED_DATA)
#define MyGetTickCount() ((DWORD)((SharedUserData-&gt;TickCountMultiplier * (ULONGLONG)SharedUserData-&gt;TickCount.LowPart) &gt;&gt; 24))
</span>
<span class="c1">// ...</span>
<span class="n">StartingTick</span> <span class="o">=</span> <span class="n">MyGetTickCount</span><span class="p">();</span>
<span class="n">Sleep</span><span class="p">(</span><span class="n">Timeout</span><span class="p">);</span>
<span class="n">TimeElapsedMs</span> <span class="o">=</span> <span class="n">MyGetTickCount</span><span class="p">()</span> <span class="o">-</span> <span class="n">StartingTick</span><span class="p">;</span>

<span class="n">printf</span><span class="p">(</span><span class="s">"Requested delay: %d, elapsed time: %d</span><span class="se">\n</span><span class="s">"</span><span class="p">,</span> <span class="n">Timeout</span><span class="p">,</span> <span class="n">TimeElapsedMs</span><span class="p">);</span>

<span class="k">if</span> <span class="p">(</span><span class="n">abs</span><span class="p">((</span><span class="n">LONG</span><span class="p">)(</span><span class="n">TimeElapsedMs</span> <span class="o">-</span> <span class="n">Timeout</span><span class="p">))</span> <span class="o">&gt;</span> <span class="n">Timeout</span> <span class="o">/</span> <span class="mi">2</span><span class="p">)</span>
    <span class="n">printf</span><span class="p">(</span><span class="s">"Sleep-skipping DETECTED!</span><span class="se">\n</span><span class="s">"</span><span class="p">);</span></code></pre></figure>

<p><br /></p>

<h4><a class="a-dummy" name="get-system-time">2.3. Get system time using different methods</a></h4>
<p>This method is similar to the previous one. Instead of measuring intervals we try to obtain the current system
time using different methods.
<br /><br />
<b>Code sample</b></p>

<figure class="highlight"><pre><code class="language-c" data-lang="c"><span class="n">SYSTEM_TIME_OF_DAY_INFORMATION</span>  <span class="n">SysTimeInfo</span><span class="p">;</span>
<span class="n">ULONGLONG</span> <span class="n">time</span><span class="p">;</span>
<span class="n">LONGLONG</span> <span class="n">diff</span><span class="p">;</span>

<span class="n">Sleep</span><span class="p">(</span><span class="mi">60000</span><span class="p">);</span> <span class="c1">// should trigger sleep skipping</span>
<span class="n">GetSystemTimeAsFileTime</span><span class="p">((</span><span class="n">LPFILETIME</span><span class="p">)</span><span class="o">&amp;</span><span class="n">time</span><span class="p">);</span>

<span class="n">NtQuerySystemInformation</span><span class="p">(</span><span class="n">SystemTimeOfDayInformation</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">SysTimeInfo</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">SysTimeInfo</span><span class="p">),</span> <span class="mi">0</span><span class="p">);</span>
<span class="n">diff</span> <span class="o">=</span> <span class="n">time</span> <span class="o">-</span> <span class="n">SysTimeInfo</span><span class="p">.</span><span class="n">CurrentTime</span><span class="p">.</span><span class="n">QuadPart</span><span class="p">;</span>
<span class="k">if</span> <span class="p">(</span><span class="n">abs</span><span class="p">(</span><span class="n">diff</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">10000000</span><span class="p">)</span> <span class="c1">// differ in more than 1 second</span>
    <span class="n">printf</span><span class="p">(</span><span class="s">"Sleep-skipping DETECTED!</span><span class="se">\n</span><span class="s">);</span></code></pre></figure>

<p><br /></p>
<h4><a class="a-dummy" name="delay-value-changed">2.4. Check if the delay value changes after calling a delay function</a></h4>
<p>Sleep-skipping is usually implemented as a replacement of the delay value with a smaller interval. 
Let’s look at the <tt>NtDelayExecution</tt> function. The delay value is passed to this function using a pointer:
<br /></p>

<figure class="highlight"><pre><code class="language-c" data-lang="c"><span class="n">NTSYSAPI</span> <span class="n">NTSTATUS</span> <span class="n">NTAPI</span>
<span class="nf">NtDelayExecution</span><span class="p">(</span>
    <span class="n">IN</span> <span class="n">BOOLEAN</span>              <span class="n">Alertable</span><span class="p">,</span>
    <span class="n">IN</span> <span class="n">PLARGE_INTEGER</span>       <span class="n">DelayInterval</span> <span class="p">);</span></code></pre></figure>

<p><br />
Therefore, we can check if the value of <tt>DelayInterval</tt> changes after the function execution.
If the value differs from the initial value, the delay was skipped.
<br /><br />
<b>Code sample</b></p>

<figure class="highlight"><pre><code class="language-c" data-lang="c"><span class="n">LONGLONG</span> <span class="n">SavedTimeout</span> <span class="o">=</span> <span class="n">Timeout</span> <span class="o">*</span> <span class="p">(</span><span class="o">-</span><span class="mi">10000LL</span><span class="p">);</span>
<span class="n">DelayInterval</span><span class="o">-&gt;</span><span class="n">QuadPart</span> <span class="o">=</span> <span class="n">SavedTimeout</span><span class="p">;</span>
<span class="n">status</span> <span class="o">=</span> <span class="n">NtDelayExecution</span><span class="p">(</span><span class="n">TRUE</span><span class="p">,</span> <span class="n">DelayInterval</span><span class="p">);</span>
<span class="k">if</span> <span class="p">(</span><span class="n">DelayInterval</span><span class="o">-&gt;</span><span class="n">QuadPart</span> <span class="o">!=</span> <span class="n">SavedTimeout</span><span class="p">)</span>
    <span class="n">printf</span><span class="p">(</span><span class="s">"Sleep-skipping DETECTED!</span><span class="se">\n</span><span class="s">"</span><span class="p">);</span></code></pre></figure>

<p><br /></p>

<h4><a class="a-dummy" name="absolute-timeout">2.5. Use absolute timeout</a></h4>
<p>For Nt-functions that perform delays we can use either a relative delay interval or an absolute time for timeout.
A negative value for the delay interval means a relative timeout, and a positive value means an absolute timeout.
High-level API functions such as <tt>WaitForSingleObject()</tt> or <tt>Sleep()</tt> operate with relative intervals.
Therefore sandbox developers may not care about absolute timeouts and handle them incorrectly.
In the Cuckoo sandbox such delays are skipped, but skipped time and ticks are counted incorrectly. This can be used
to detect sleep skipping.
<br /><br />
<b>Code sample</b></p>

<figure class="highlight"><pre><code class="language-c" data-lang="c"><span class="kt">void</span> <span class="nf">SleepAbs</span><span class="p">(</span><span class="n">DWORD</span> <span class="n">ms</span><span class="p">)</span>
<span class="p">{</span>
    <span class="n">LARGE_INTEGER</span> <span class="n">SleepUntil</span><span class="p">;</span>

    <span class="n">GetSystemTimeAsFileTime</span><span class="p">((</span><span class="n">LPFILETIME</span><span class="p">)</span><span class="o">&amp;</span><span class="n">SleepUntil</span><span class="p">);</span>
    <span class="n">SleepTo</span><span class="p">.</span><span class="n">QuadPart</span> <span class="o">+=</span> <span class="p">(</span><span class="n">ms</span> <span class="o">*</span> <span class="mi">10000</span><span class="p">);</span>
    <span class="n">NtDelayExecution</span><span class="p">(</span><span class="n">TRUE</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">SleepTo</span><span class="p">);</span>
<span class="p">}</span></code></pre></figure>

<p><br /></p>
<h4><a class="a-dummy" name="get-time-another-process">2.6. Get time from another process</a></h4>
<p>Sleep skipping in the Cuckoo sandbox is not system-wide. Therefore, if there are performing delays, time moves
with different speeds in the different processes. After a delay we should synchronize the processes and compare 
the current time in the two processes. A big difference in measured time values indicates sleep skipping was performed.</p>

<div style="text-align: center">
  <img src="../assets/images/sleep_skipping_detection.png" />
</div>

<p>The current version of the Cuckoo monitor disables sleep skipping after creating new threads or processes.
Therefore, we should use a process creation method that is not tracked by the Cuckoo monitor, for example,
using a scheduled task.</p>

<p><br /></p>
<h3><a class="a-dummy" name="get-time-ntp">3. Get the current date and time from an external source (NTP, HTTP)</a></h3>
<p>A sandbox may set different dates to check how the behavior of analyzed samples is changed depending on the date.
The malware can use an external date and time source to prevent time manipulation attempts inside the VM.
This method can also be used to measure time intervals, perform delays, and detect sleep skipping attempts.
NTP servers, and the HTTP header “Date” can be used as an external source for the date and time.
For example, the malware may connect to <tt>google.com</tt> to check the current date and use it as a DGA seed.</p>

<p><b>Countermeasures</b></p>
<p></p>

<p>Implement fake web infrastructure or spoof NTP data and HTTP headers returned by real servers. 
The returned/spoofed date and time should be synchronized with the date and time in a virtual machine.</p>

<p><br /></p>
<h3><a class="a-dummy" name="difference-vm-hosts">4. Difference in time measurement in VM and hosts</a></h3>
<p>The execution of some API functions and instructions may take different amounts of time in a VM and in the usual 
host systems. These peculiarities can be used to detect a virtual environment.</p>

<h4><a class="a-dummy" name="rdtsc">4.1. RDTSC (with CPUID to force a VM Exit)</a></h4>
<p><b>Code sample</b></p>

<figure class="highlight"><pre><code class="language-c" data-lang="c"><span class="n">BOOL</span> <span class="nf">rdtsc_diff_vmexit</span><span class="p">()</span>
<span class="p">{</span>
    <span class="n">ULONGLONG</span> <span class="n">tsc1</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
    <span class="n">ULONGLONG</span> <span class="n">tsc2</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
    <span class="n">ULONGLONG</span> <span class="n">avg</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
    <span class="n">INT</span> <span class="n">cpuInfo</span><span class="p">[</span><span class="mi">4</span><span class="p">]</span> <span class="o">=</span> <span class="p">{};</span>

    <span class="c1">// Try this 10 times in case of small fluctuations</span>
    <span class="k">for</span> <span class="p">(</span><span class="n">INT</span> <span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="mi">10</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span>
    <span class="p">{</span>
        <span class="n">tsc1</span> <span class="o">=</span> <span class="n">__rdtsc</span><span class="p">();</span>
        <span class="n">__cpuid</span><span class="p">(</span><span class="n">cpuInfo</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
        <span class="n">tsc2</span> <span class="o">=</span> <span class="n">__rdtsc</span><span class="p">();</span>

        <span class="c1">// Get the delta of the two RDTSC</span>
        <span class="n">avg</span> <span class="o">+=</span> <span class="p">(</span><span class="n">tsc2</span> <span class="o">-</span> <span class="n">tsc1</span><span class="p">);</span>
    <span class="p">}</span>

    <span class="c1">// We repeated the process 10 times so we make sure our check is as much reliable as we can</span>
    <span class="n">avg</span> <span class="o">=</span> <span class="n">avg</span> <span class="o">/</span> <span class="mi">10</span><span class="p">;</span>
    <span class="k">return</span> <span class="p">(</span><span class="n">avg</span> <span class="o">&lt;</span> <span class="mi">1000</span> <span class="o">&amp;&amp;</span> <span class="n">avg</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">)</span> <span class="o">?</span> <span class="n">FALSE</span> <span class="o">:</span> <span class="n">TRUE</span><span class="p">;</span>
<span class="p">}</span></code></pre></figure>

<p><i>Credits for this code sample: <a href="https://github.com/LordNoteworthy/al-khaser">al-khaser project</a></i></p>
<p><br /></p>
<h4><a class="a-dummy" name="rdtsc-locky">4.2. RDTSC (Locky version with GetProcessHeap and CloseHandle)</a></h4>
<p><b>Code sample</b></p>

<figure class="highlight"><pre><code class="language-c" data-lang="c"><span class="cp">#define LODWORD(_qw)    ((DWORD)(_qw))
</span><span class="n">BOOL</span> <span class="nf">rdtsc_diff_locky</span><span class="p">()</span>
<span class="p">{</span>
    <span class="n">ULONGLONG</span> <span class="n">tsc1</span><span class="p">;</span>
    <span class="n">ULONGLONG</span> <span class="n">tsc2</span><span class="p">;</span>
    <span class="n">ULONGLONG</span> <span class="n">tsc3</span><span class="p">;</span>
    <span class="n">DWORD</span> <span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

    <span class="c1">// Try this 10 times in case of small fluctuations</span>
    <span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="mi">10</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span>
    <span class="p">{</span>
        <span class="n">tsc1</span> <span class="o">=</span> <span class="n">__rdtsc</span><span class="p">();</span>

        <span class="c1">// Waste some cycles - should be faster than CloseHandle on bare metal</span>
        <span class="n">GetProcessHeap</span><span class="p">();</span>

        <span class="n">tsc2</span> <span class="o">=</span> <span class="n">__rdtsc</span><span class="p">();</span>

        <span class="c1">// Waste some cycles - slightly longer than GetProcessHeap() on bare metal</span>
        <span class="n">CloseHandle</span><span class="p">(</span><span class="mi">0</span><span class="p">);</span>

        <span class="n">tsc3</span> <span class="o">=</span> <span class="n">__rdtsc</span><span class="p">();</span>

        <span class="c1">// Did it take at least 10 times more CPU cycles to perform CloseHandle than it took to perform GetProcessHeap()?</span>
        <span class="k">if</span> <span class="p">((</span><span class="n">LODWORD</span><span class="p">(</span><span class="n">tsc3</span><span class="p">)</span> <span class="o">-</span> <span class="n">LODWORD</span><span class="p">(</span><span class="n">tsc2</span><span class="p">))</span> <span class="o">/</span> <span class="p">(</span><span class="n">LODWORD</span><span class="p">(</span><span class="n">tsc2</span><span class="p">)</span> <span class="o">-</span> <span class="n">LODWORD</span><span class="p">(</span><span class="n">tsc1</span><span class="p">))</span> <span class="o">&gt;=</span> <span class="mi">10</span><span class="p">)</span>
            <span class="k">return</span> <span class="n">FALSE</span><span class="p">;</span>
    <span class="p">}</span>

    <span class="c1">// We consistently saw a small ratio of difference between GetProcessHeap and CloseHandle execution times</span>
    <span class="c1">// so we're probably in a VM!</span>
    <span class="k">return</span> <span class="n">TRUE</span><span class="p">;</span>
<span class="p">}</span></code></pre></figure>

<p><i>Credits for this code sample: <a href="https://github.com/LordNoteworthy/al-khaser">al-khaser project</a></i></p>
<p><b>Countermeasures</b></p>
<p></p>

<p>Implement <tt>RDTSC</tt> instruction “hooking.” It is possible to make RDTSC a privileged instruction that 
can be called in kernel-mode only. Calling the “hooked” RDTSC in user-mode leads to an execution of our handler 
that can return any desired value.</p>

<p><br /></p>
<h3><a class="a-dummy" name="check-system-boot-time">5. Check the system last boot time using different methods</a></h3>
<p>This technique is a combination of techniques described in 
<a href="generic-os-queries.html#check-if-system-uptime">Generic OS queries: Check if the system uptime is small</a> 
and <a href="wmi.html#check-last-boot-time">WMI: Check the last boot time</a> sections. 
Depending on a method used for getting system last boot time, the measured sandbox OS uptime can be too 
small (several minutes), or conversely, too big (months or even years), because the system is usually restored 
from a snapshot after the analysis starts.
<br />
We can detect a sandbox by comparing the two values for the last boot time, acquired through WMI and through 
<tt>NtQuerySystemInformation(SystemTimeOfDayInformation)</tt>.
<br /><br /></p>

<p><b>Code sample</b></p>
<p></p>

<figure class="highlight"><pre><code class="language-c" data-lang="c"><span class="n">bool</span> <span class="nf">check_last_boot_time</span><span class="p">()</span>
<span class="p">{</span>
    <span class="n">SYSTEM_TIME_OF_DAY_INFORMATION</span>  <span class="n">SysTimeInfo</span><span class="p">;</span>
    <span class="n">LARGE_INTEGER</span> <span class="n">LastBootTime</span><span class="p">;</span>
    
    <span class="n">NtQuerySystemInformation</span><span class="p">(</span><span class="n">SystemTimeOfDayInformation</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">SysTimeInfo</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">SysTimeInfo</span><span class="p">),</span> <span class="mi">0</span><span class="p">);</span>
    <span class="n">LastBootTime</span> <span class="o">=</span> <span class="n">wmi_Get_LastBootTime</span><span class="p">();</span>
    <span class="k">return</span> <span class="p">(</span><span class="n">wmi_LastBootTime</span><span class="p">.</span><span class="n">QuadPart</span> <span class="o">-</span> <span class="n">SysTimeInfo</span><span class="p">.</span><span class="n">BootTime</span><span class="p">.</span><span class="n">QuadPart</span><span class="p">)</span> <span class="o">/</span> <span class="mi">10000000</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">;</span> <span class="c1">// 0 seconds</span>
<span class="p">}</span></code></pre></figure>

<p><b>Countermeasures</b></p>
<p></p>
<ul>
<li>Adjust the <tt>KeBootTime</tt> value</li>
<li>Reset the WMI repository or restart the <tt>"winmgmt"</tt> service after the <tt>KeBootTime</tt> adjustment</li>
</ul>

<p><br /></p>
<h3><a class="a-dummy" name="call-hooked-function-with-invalid-arguments">6. Call a potentially hooked delay function with invalid arguments</a></h3>
<p>The second argument of the <tt>NtDelayExecution</tt> function is a pointer to the delay interval value. In the kernel-mode, 
the <tt>NtDelayExecution</tt> function validates this pointer and can also return the following values:</p>
<ul>
<li><tt>STATUS_ACCESS_VIOLATION</tt> - If the value is not a valid user-mode address</li>
<li><tt>STATUS_DATATYPE_MISALIGNMENT</tt> - If the address is not aligned (DelayInterval &amp; 3 != 0)</li>
</ul>
<p>In a sandbox, the input arguments for <tt>NtDelayExecution</tt> and similar functions might not be handled correctly. 
If we call <tt>NtDelayExecution</tt> with an unaligned pointer for DelayInterval, normally it returns the 
<tt>STATUS_DATATYPE_MISALIGNMENT</tt>. However, in a sandbox, the value for DelayInterval may be copied to a new variable 
without the appropriate checks. In this case, a delay is performed and the returned value will be <tt>STATUS_SUCCESS</tt>. 
This can be used to detect a sandbox.
<br /><br />
<b>Code sample</b></p>

<figure class="highlight"><pre><code class="language-c" data-lang="c"><span class="kr">__declspec</span><span class="p">(</span><span class="n">align</span><span class="p">(</span><span class="mi">4</span><span class="p">))</span> <span class="n">BYTE</span> <span class="n">aligned_bytes</span><span class="p">[</span><span class="k">sizeof</span><span class="p">(</span><span class="n">LARGE_INTEGER</span><span class="p">)</span> <span class="o">*</span> <span class="mi">2</span><span class="p">];</span>
<span class="n">DWORD</span> <span class="n">tick_start</span><span class="p">,</span> <span class="n">time_elapsed_ms</span><span class="p">;</span>
<span class="n">DWORD</span> <span class="n">Timeout</span> <span class="o">=</span> <span class="mi">10000</span><span class="p">;</span> <span class="c1">//10 seconds</span>
<span class="n">PLARGE_INTEGER</span> <span class="n">DelayInterval</span> <span class="o">=</span> <span class="p">(</span><span class="n">PLARGE_INTEGER</span><span class="p">)(</span><span class="n">aligned_bytes</span> <span class="o">+</span> <span class="mi">1</span><span class="p">);</span> <span class="c1">//unaligned</span>
<span class="n">NTSTATUS</span> <span class="n">status</span><span class="p">;</span>

<span class="n">DelayInterval</span><span class="o">-&gt;</span><span class="n">QuadPart</span> <span class="o">=</span> <span class="n">Timeout</span> <span class="o">*</span> <span class="p">(</span><span class="o">-</span><span class="mi">10000LL</span><span class="p">);</span>
<span class="n">tick_start</span> <span class="o">=</span> <span class="n">GetTickCount</span><span class="p">();</span>
<span class="n">status</span> <span class="o">=</span> <span class="n">NtDelayExecution</span><span class="p">(</span><span class="n">FALSE</span><span class="p">,</span> <span class="n">DelayInterval</span><span class="p">);</span>
<span class="n">time_elapsed_ms</span> <span class="o">=</span> <span class="n">GetTickCount</span><span class="p">()</span> <span class="o">-</span> <span class="n">tick_start</span><span class="p">;</span>
<span class="c1">// If the pointer is not aligned the delay should not be performed</span>
<span class="k">if</span> <span class="p">(</span><span class="n">time_elapsed_ms</span> <span class="o">&gt;</span> <span class="mi">500</span> <span class="o">||</span> <span class="n">status</span> <span class="o">!=</span> <span class="n">STATUS_DATATYPE_MISALIGNMENT</span> <span class="p">)</span>
    <span class="n">printf</span><span class="p">(</span><span class="s">"Sandbox detected</span><span class="se">\n</span><span class="s">"</span><span class="p">);</span></code></pre></figure>

<p>On the other hand, if an inaccessible address is set for DelayInterval, the return code should be 
<tt>STATUS_ACCESS_VIOLATION</tt>. This can be used to detect a sandbox as well.
<br /><br />
<b>Code sample</b></p>

<figure class="highlight"><pre><code class="language-c" data-lang="c"><span class="k">if</span> <span class="p">(</span><span class="n">NtDelayExecution</span><span class="p">(</span><span class="n">FALSE</span><span class="p">,</span> <span class="p">(</span><span class="n">PLARGE_INTEGER</span><span class="p">)</span><span class="mi">0</span><span class="p">)</span> <span class="o">!=</span> <span class="n">STATUS_ACCESS_VIOLATION</span><span class="p">)</span>
    <span class="n">printf</span><span class="p">(</span><span class="s">"Sandbox detected"</span><span class="p">);</span></code></pre></figure>

<p>If the <tt>DelayInterval</tt> argument is not verified before it is accessed, this may lead to an exception in the case of 
using an invalid pointer. For example, the next code leads the Cuckoo monitor to crash.
<br /><br />
<b>Code sample</b></p>

<figure class="highlight"><pre><code class="language-c" data-lang="c"><span class="n">NtDelayExecution</span><span class="p">(</span><span class="n">FALSE</span><span class="p">,</span> <span class="p">(</span><span class="n">PLARGE_INTEGER</span><span class="p">)</span><span class="mh">0xFFDF0000</span><span class="p">);</span></code></pre></figure>

<p>As stated earlier, normally this call should return <tt>STATUS_ACCESS_VIOLATION</tt> without causing an exception.</p>

<p><b>Countermeasures</b></p>
<p></p>

<p>Hooked functions should check arguments and return appropriate error codes if arguments are invalid.</p>

<p><br /></p>
<h3><a class="a-dummy" name="countermeasures">Countermeasures</a></h3>

<p>Countermeasures are present in the appropriate sub-sections above.</p>

<p><br /></p>
<h3><a class="a-dummy" name="credits">Credits</a></h3>

<p>Credits go to open-source projects from where code samples were taken:</p>
<ul>
<li>al-khaser project on <a href="https://github.com/LordNoteworthy/al-khaser">GitHub</a></li>
</ul>

    <br>
    <div style="text-align: left">
        <a href="..">Go back</a>
    </div>
    <br>
    <div class="sharebuttons" style="text-align: center">
        <hr />
        <ul>
          <li>
            <p class="sharetitle"> Share this: </p>
          </li>
          <li class="reddit">
            <a href="http://www.reddit.com/submit?url=https://evasions.checkpoint.com/src/Evasions/techniques/timing.html&title=Evasions:%20Timing - Evasion Techniques" target="_blank">
                <svg xmlns="http://www.w3.org/2000/svg"
                aria-label="Reddit" role="img"
                viewBox="0 0 512 512"><rect
                width="512" height="512"
                rx="15%"
                fill="#f40"/><g fill="#fff"><ellipse cx="256" cy="307" rx="166" ry="117"/><circle cx="106" cy="256" r="42"/><circle cx="407" cy="256" r="42"/><circle cx="375" cy="114" r="32"/></g><g stroke-linecap="round" stroke-linejoin="round" fill="none"><path d="m256 196 23-101 73 15" stroke="#fff" stroke-width="16"/><path d="m191 359c33 25 97 26 130 0" stroke="#f40" stroke-width="13"/></g><g fill="#f40"><circle cx="191" cy="287" r="31"/><circle cx="321" cy="287" r="31"/></g></svg>
                
            </a>
          </li>
          <li class="hn">
            <a href="http://news.ycombinator.com/submitlink?u=https://evasions.checkpoint.com/src/Evasions/techniques/timing.html&t=Evasions:%20Timing - Evasion Techniques" target="_blank">
                <svg xmlns="http://www.w3.org/2000/svg"
                aria-label="Hacker News" role="img"
                viewBox="0 0 512 512"><rect
                width="512" height="512"
                rx="15%"
                fill="#f60"/><path fill="#fff" d="M124 91h51l81 162 81-164h51L276 293v136h-40V293z"/></svg>
            </a>
          </li>
          <li class="twitter">
            <a href="https://twitter.com/intent/tweet?via=_CPResearch_&url=https://evasions.checkpoint.com/src/Evasions/techniques/timing.html&text=Evasions:%20Timing - Evasion Techniques" target="_blank">
                <svg viewBox="0 0 1792 1792" xmlns="http://www.w3.org/2000/svg"><path d="M1684 408q-67 98-162 167 1 14 1 42 0 130-38 259.5t-115.5 248.5-184.5 210.5-258 146-323 54.5q-271 0-496-145 35 4 78 4 225 0 401-138-105-2-188-64.5t-114-159.5q33 5 61 5 43 0 85-11-112-23-185.5-111.5t-73.5-205.5v-4q68 38 146 41-66-44-105-115t-39-154q0-88 44-163 121 149 294.5 238.5t371.5 99.5q-8-38-8-74 0-134 94.5-228.5t228.5-94.5q140 0 236 102 109-21 205-78-37 115-142 178 93-10 186-50z"/></svg>
            </a>
          </li>
          <li class="linkedin">
            <a href=https://www.linkedin.com/shareArticle?mini=true&url=https://evasions.checkpoint.com/src/Evasions/techniques/timing.html&title=Evasions:%20Timing - Evasion Techniques&source=LinkedIn" target="_blank">
                <svg viewBox="0 0 1792 1792" xmlns="http://www.w3.org/2000/svg"><path d="M477 625v991h-330v-991h330zm21-306q1 73-50.5 122t-135.5 49h-2q-82 0-132-49t-50-122q0-74 51.5-122.5t134.5-48.5 133 48.5 51 122.5zm1166 729v568h-329v-530q0-105-40.5-164.5t-126.5-59.5q-63 0-105.5 34.5t-63.5 85.5q-11 30-11 81v553h-329q2-399 2-647t-1-296l-1-48h329v144h-2q20-32 41-56t56.5-52 87-43.5 114.5-15.5q171 0 275 113.5t104 332.5z"/></svg>
            </a>
          </li>
        </ul>
      </div>
      
</article>


</section>

<nav class="navbar navbar-default navbar-fixed-bottom">
  <div class="container footer-content">

    Made with <font class="a-pink"><i class ="fa fa-heart"></i></font> to serve the community by Check Point Research    |    <a class="a-pink" href="https://research.checkpoint.com">Research blog</a>    |    <a class="a-pink" href="https://research.checkpoint.com/about-us/">About Us</a>    |    <a class="a-pink" href="https://github.com/CheckPointSW"><i class="fa fa-github fa-lg"></i></a> <a class="a-pink" href="https://twitter.com/_CPResearch_"><i class="fa fa-twitter fa-lg"></i></a>
    
    <br>
    
    © 1994-2024 Check Point Software Technologies LTD | All rights reserved | Property of CheckPoint.com


  </div>
</nav>

  </body>

</html>
